Content-Length: 3122
{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":54248,"clientInfo":{"name":"vscode","version":"1.64.0"},"rootPath":"d:\\TOTVS 12\\Microsiga\\Protheus\\ProjetoVSCode","rootUri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode","capabilities":{"workspace":{"applyEdit":true,"workspaceEdit":{"documentChanges":true,"resourceOperations":["create","rename","delete"],"failureHandling":"textOnlyTransactional"},"didChangeConfiguration":{"dynamicRegistration":true},"didChangeWatchedFiles":{"dynamicRegistration":true},"symbol":{"dynamicRegistration":true,"symbolKind":{"valueSet":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]}},"executeCommand":{"dynamicRegistration":true},"configuration":true,"workspaceFolders":true},"textDocument":{"publishDiagnostics":{"relatedInformation":true,"versionSupport":false,"tagSupport":{"valueSet":[1,2]}},"synchronization":{"dynamicRegistration":true,"willSave":true,"willSaveWaitUntil":true,"didSave":true},"completion":{"dynamicRegistration":true,"contextSupport":true,"completionItem":{"snippetSupport":true,"commitCharactersSupport":true,"documentationFormat":["markdown","plaintext"],"deprecatedSupport":true,"preselectSupport":true,"tagSupport":{"valueSet":[1]}},"completionItemKind":{"valueSet":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25]}},"hover":{"dynamicRegistration":true,"contentFormat":["markdown","plaintext"]},"signatureHelp":{"dynamicRegistration":true,"signatureInformation":{"documentationFormat":["markdown","plaintext"],"parameterInformation":{"labelOffsetSupport":true}},"contextSupport":true},"definition":{"dynamicRegistration":true,"linkSupport":true},"references":{"dynamicRegistration":true},"documentHighlight":{"dynamicRegistration":true},"documentSymbol":{"dynamicRegistration":true,"symbolKind":{"valueSet":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]},"hierarchicalDocumentSymbolSupport":true},"codeAction":{"dynamicRegistration":true,"isPreferredSupport":true,"codeActionLiteralSupport":{"codeActionKind":{"valueSet":["","quickfix","refactor","refactor.extract","refactor.inline","refactor.rewrite","source","source.organizeImports"]}}},"codeLens":{"dynamicRegistration":true},"formatting":{"dynamicRegistration":true},"rangeFormatting":{"dynamicRegistration":true},"onTypeFormatting":{"dynamicRegistration":true},"rename":{"dynamicRegistration":true,"prepareSupport":true},"documentLink":{"dynamicRegistration":true,"tooltipSupport":true},"typeDefinition":{"dynamicRegistration":true,"linkSupport":true},"implementation":{"dynamicRegistration":true,"linkSupport":true},"colorProvider":{"dynamicRegistration":true},"foldingRange":{"dynamicRegistration":true,"rangeLimit":5000,"lineFoldingOnly":true},"declaration":{"dynamicRegistration":true,"linkSupport":true},"selectionRange":{"dynamicRegistration":true}},"window":{"workDoneProgress":true}},"initializationOptions":{"launchArgs":["--log-file=totvsls.log","--record=totvsls"]},"trace":"off","workspaceFolders":[{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode","name":"ProjetoVSCode"}]}}
Content-Length: 52
{"jsonrpc":"2.0","method":"initialized","params":{}}
Content-Length: 705
{"jsonrpc":"2.0","id":1,"method":"$totvsserver/reconnect","params":{"reconnectInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxNTg5MzowOjE6MQ==.j2uqRcEQ8jvYxmT+LRNH9aWeSPbq24/SB7AltRu3HyIdFDSzHHm2Ux4U9I7EbTUSLALirXfzVlWHmfRdxdrsAIiZQGjMyhbEd3/MaEdigppkb35vzF4phvEBCFZHS47QhOpLIkmdhA1U9sCfCr5uXmdafkj7I45spLcnTmAyDbKIWj1TRsjb5thtEbxMydCQuhib2rqJLEmrcniZU8ZzE0NFj7qwov0eLrJcvqFNg6GAuF2cKXQEQ/TGmzX9zUFr6XehOAqX+XDlW7tLZsRTN75xrin+zKSuTTgT5PTZfbIlao8avAL3z4lgGeZ/TrS6oMwIlnY5jBDrM8GMHCHgcg==","serverName":"SRV_DEVELOPER","connType":3}}}
Content-Length: 679
{"jsonrpc":"2.0","id":2,"method":"$totvsserver/serverPermissions","params":{"serverPermissionsInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw=="}}}
Content-Length: 183
{"jsonrpc":"2.0","id":3,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"includes","value":"D:\\TOTVS 12\\Microsiga\\Protheus\\include;"}}}
Content-Length: 148
{"jsonrpc":"2.0","id":4,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":5,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 153
{"jsonrpc":"2.0","id":6,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 145
{"jsonrpc":"2.0","id":7,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 148
{"jsonrpc":"2.0","id":8,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":9,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":10,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":11,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 76
{"jsonrpc":"2.0","method":"$/setTraceNotification","params":{"value":"off"}}
Content-Length: 149
{"jsonrpc":"2.0","id":12,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":13,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":14,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":15,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 149
{"jsonrpc":"2.0","id":16,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":17,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":18,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":19,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 76
{"jsonrpc":"2.0","method":"$/setTraceNotification","params":{"value":"off"}}
Content-Length: 149
{"jsonrpc":"2.0","id":20,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":21,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":22,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":23,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 149
{"jsonrpc":"2.0","id":24,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":25,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":26,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":27,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 76
{"jsonrpc":"2.0","method":"$/setTraceNotification","params":{"value":"off"}}
Content-Length: 9412
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MA103OPC.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"rwmake.ch\"\r\n#include \"protheus.ch\"  \r\n\r\n/* \r\nDesenvolvido para Itinga Minegaracao/Qualita\r\nBruno Lage\r\nData : 21/03/2019\r\n*/\r\n\r\n\r\nUser Function MA103OPC()\r\n**************************************************************************************\r\n*\t/**/\r\n*\r\n***\r\nLocal   aRet := {}\r\n  \r\n\t//Aadd(aRet ,{\"COMPLEMENTOS FISCAIS\"  ,\"a910Compl\"     , 0 , 4 ,0 ,NIL})\t\r\n\tAadd(aRet ,{\"PDF FINANCEIROS\"       ,\"u_MAddPDFTit()\", 0 , 4 ,0 ,NIL})\r\n\t\r\n\tAadd(aRet ,{\"Rateio Custo Serviço\"  ,\"U_GROA015\"     , 0 , 2 ,0 ,NIL})\r\n\t\r\n\t\r\n\tIf SubString(CNUMEMP,1,2) == \"01\"\r\n\t\tAadd(aRet ,{\"CONTROLE BX DIRETA\" ,\"u_CBXDIRETA()\" , 0 , 4 ,0 ,NIL})\r\n\tEndIf\r\n\t\r\n\tAadd(aRet ,{\"Estorna Classificação\"\t ,\"u_MVALIDEST()\" \t , 0 , 5, 0, nil})\r\n\r\n\r\nReturn(aRet)\r\n\r\nUser Function MVALIDEST()\r\n**************************************************************************************\r\n*\t/**/\r\n*\r\n***\r\nLocal lRet := .T.\r\nLocal aArea:= GetArea()\r\n\r\nIF dDatabase <> SF1->F1_DTDIGIT\r\n\tAlert(\"Você não pode excluir a NF fora da data de entrada original. Data digitada:\" + dToC(SF1->F1_DTDIGIT))\r\n\tlRet := .F.\r\nElse\r\n\tA140EstCla()\r\nEndIf\r\n\r\nRestArea(aArea)\r\n\r\nReturn(lRet)\r\n\r\n\r\nUser Function CBXDIRETA()\r\n***********************************************************************************************************\r\n*  // Controle de baixas Direas\r\n*\r\n***  \r\n\r\n// Variaveis Locais da Funcao\r\nPrivate cEdit1\t := Space(25)\r\nPrivate cEdit2\t := Space(25)\r\nPrivate cEdit3\t := Space(25)\r\nPrivate cEdit4\t := Space(30)\r\nPrivate cEdit5\t := Space(25)\r\nPrivate cEdit6\t := Space(25)\r\nPrivate cEdit7\t := Space(25)\r\nPrivate cMemo1\t := \"\"\r\n\r\nPrivate lCheckBox1\t := .T.\r\nPrivate oCheckBox1\r\n\r\nPrivate oEdit1\r\nPrivate oEdit2\r\nPrivate oEdit3\r\nPrivate oEdit4\r\nPrivate oEdit5\r\nPrivate oEdit6\r\nPrivate oEdit7\r\nPrivate oMemo1\r\n\r\n// Variaveis Private da Funcao\r\nPrivate _oDlg\t\t\t\t// Dialog Principal\r\nPrivate lChaveOk := .F.\r\n\r\ndbSelectArea(\"ZA1\")\r\ndbSetOrder(2)\r\nIf dbSeek(xFilial(\"ZA1\") + SF1->F1_FILIAL + SF1->F1_DOC + SF1->F1_SERIE + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_TIPO  )\r\n\tlChaveOk := .f.\t\r\n\t\r\n\tcEdit1\t    := ZA1->ZA1_USUAIN\r\n\tcEdit2\t    := ZA1->ZA1_DTINC\r\n\tcEdit3\t    := ZA1->ZA1_HORAIN\r\n\tlCheckBox1  := ZA1->ZA1_STATUS\r\n\tcEdit4\t    := ZA1->ZA1_INDEX\r\n\tcMemo1      := ZA1->ZA1_OBS\r\n\t\r\n\tcEdit5\t    := ZA1->ZA1_USUBX\r\n\tcEdit6\t    := ZA1->ZA1_DTBX\r\n\t//cEdit7\t := \r\n\t\r\nElse\r\n\tlChaveOk := .t.\r\n\t\r\n\tcEdit1\t := SUBSTR(CUSUARIO,7,15)\r\n\tcEdit2\t := dDataBase\r\n\tcEdit3\t := TRIM(TIME())\r\n\tlCheckBox1 := .T.\r\n\tcEdit4\t := SF1->F1_FILIAL + SF1->F1_DOC + SF1->F1_SERIE + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_TIPO\r\nEndIf     \r\n\r\n            \r\nDEFINE MSDIALOG _oDlg TITLE \"Controle de baixa direta\" FROM U_MGETTELA(526),U_MGETTELA(779) TO U_MGETTELA(855),U_MGETTELA(1312) PIXEL\r\n\r\n\t// Cria as Groups do Sistema\r\n\t@ U_MGETTELA(000),U_MGETTELA(004) TO U_MGETTELA(058),U_MGETTELA(262) LABEL \" Dados: \" PIXEL OF _oDlg\r\n\r\n\t\t// Cria Componentes Padroes do Sistema\r\n\t\t@ U_MGETTELA(009),U_MGETTELA(011) Say \" Usuário: \" Size U_MGETTELA(021),U_MGETTELA(008) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(008),U_MGETTELA(085) Say \" Data:    \" Size U_MGETTELA(015),U_MGETTELA(008) COLOR CLR_BLUE PIXEL OF _oDlg\t\t\r\n\t\t@ U_MGETTELA(009),U_MGETTELA(163) Say \" Hora:    \" Size U_MGETTELA(013),U_MGETTELA(008) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(019),U_MGETTELA(011) MsGet oEdit1 Var cEdit1 Size U_MGETTELA(060),U_MGETTELA(009) WHEN(.F.) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(019),U_MGETTELA(085) MsGet oEdit2 Var cEdit2 Size U_MGETTELA(060),U_MGETTELA(009) WHEN(.F.) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(019),U_MGETTELA(163) MsGet oEdit3 Var cEdit3 Size U_MGETTELA(034),U_MGETTELA(009) WHEN(.F.) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(019),U_MGETTELA(206) CheckBox oCheckBox1 Var lCheckBox1 Prompt \" Pendente? \" Size U_MGETTELA(048),U_MGETTELA(008) WHEN(.F.) PIXEL OF _oDlg\r\n\t\t\r\n\t\t@ U_MGETTELA(032),U_MGETTELA(011) Say \" Chave de pesquisa: \" Size U_MGETTELA(047),U_MGETTELA(008) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(042),U_MGETTELA(011) MsGet oEdit4 Var cEdit4 Size U_MGETTELA(240),U_MGETTELA(009) WHEN(.F.) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\r\n\t@ U_MGETTELA(060),U_MGETTELA(005) Say \" Observações: \" Size U_MGETTELA(035),U_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(068),U_MGETTELA(005) GET oMemo1 Var cMemo1 MEMO Size U_MGETTELA(256),U_MGETTELA(045) WHEN(lChaveOk) PIXEL OF _oDlg\r\n\r\n\t@ U_MGETTELA(117),U_MGETTELA(006) TO U_MGETTELA(157),U_MGETTELA(209) LABEL \" Confirmação das baixas: \" PIXEL OF _oDlg\t\r\n\t\t@ U_MGETTELA(133),U_MGETTELA(012) Say \" Usuário: \" Size U_MGETTELA(021),U_MGETTELA(008) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(134),U_MGETTELA(085) Say \" Data:    \" Size U_MGETTELA(015),U_MGETTELA(008) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t//@ U_MGETTELA(134),U_MGETTELA(164) Say \" Hora:    \" Size U_MGETTELA(015),U_MGETTELA(008) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(144),U_MGETTELA(011) MsGet oEdit5 Var cEdit5 Size U_MGETTELA(060),U_MGETTELA(009) WHEN(.F.) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(144),U_MGETTELA(085) MsGet oEdit6 Var cEdit6 Size U_MGETTELA(060),U_MGETTELA(009) WHEN(.F.) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t//@ U_MGETTELA(144),U_MGETTELA(163) MsGet oEdit7 Var cEdit7 Size U_MGETTELA(037),U_MGETTELA(009) WHEN(.F.) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\r\n\t@ U_MGETTELA(124),U_MGETTELA(223) Button \" Excluir \" Action(CBXDIRGRAVA(2,lChaveOk),_oDlg:End() ) Size U_MGETTELA(037),U_MGETTELA(012) PIXEL OF _oDlg\r\n\t@ U_MGETTELA(144),U_MGETTELA(223) Button \" Salvar  \" Action(CBXDIRGRAVA(1,lChaveOk),_oDlg:End() ) Size U_MGETTELA(037),U_MGETTELA(012) PIXEL OF _oDlg\r\n\r\nACTIVATE MSDIALOG _oDlg CENTERED \r\n\r\nReturn(.T.)\r\n\r\n\r\nStatic Function CBXDIRGRAVA(nTipo,lChaveOk)\r\n***********************************************************************************************************\r\n*  // Controle de baixas direas Grava\r\n*\r\n***  \r\n//Alert(nTipo)\r\n\r\nIf nTipo = 1\r\n\t RecLock( 'ZA1', .T. )\t\r\n\t  \tReplace ZA1->ZA1_FILIAL With xFilial(\"ZA1\")\r\n\t\tReplace ZA1->ZA1_STATUS With lCheckBox1 \r\n\t\tReplace ZA1->ZA1_USUAIN With AllTrim(cEdit1)\r\n\t\tReplace ZA1->ZA1_DTINC  With cEdit2\r\n\t\tReplace ZA1->ZA1_HORAIN With SubStr(cEdit3,1,5)\r\n\t\tReplace ZA1->ZA1_INDEX  With AllTrim(cEdit4)\r\n\t\tReplace ZA1->ZA1_OBS    With UPPER(AllTrim(cMemo1))\r\n\t MsUnLock()\r\n\t AVISO(\"Salvando...\", \"Dados salvo com sucesso!\" , { \"Fechar\" }, 1)\r\nEndIf\r\n\r\nIf nTipo = 2 .AND. lChaveOk == .F.\r\n\t RecLock( 'ZA1', .F. )\t\r\n\t \tDbDelete()\r\n\t MsUnLock()\r\n\t AVISO(\"Deletando...\", \"Dados excluídos com sucesso!\" , { \"Fechar\" }, 1)\r\nEndIf\r\n\r\nReturn(.T.)\r\n\r\n\r\nUser Function MAddPDFTit()\r\n**************************************************************************************\r\n*\t/**/\r\n*\r\n***\r\nLocal nCont  := 0\r\nLocal nContx := 0\r\nLocal cMsgAlert := \"\"\r\n\r\n\t/*\r\n\tContagem de quantos \r\n\ttitulos possuem a nota.\r\n\t*/\r\n\tdbSelectArea(\"SE2\")\r\n\tdbSetOrder(6) \r\n\tdbSeek( SF1->F1_FILIAL + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_SERIE + SF1->F1_DOC  )\r\n\r\n\tDo While ( SF1->F1_FILIAL + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_SERIE + SF1->F1_DOC  ) == ( SE2->E2_FILIAL + SE2->E2_FORNECE + SE2->E2_LOJA + SE2->E2_PREFIXO + SE2->E2_NUM)\r\n\t\tnCont := nCont + 1\r\n\t\tdbSelectArea(\"SE2\")\r\n\t\tdbSkip()\r\n\tEndDo\r\n\t\r\n\t/*\r\n\tMensagem para ser exibida durante a \r\n\tadição dos anexos\r\n\t*/\r\n\tdbSelectArea(\"SE2\")\r\n\tdbSetOrder(6) \r\n\tIf dbSeek( SF1->F1_FILIAL + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_SERIE + SF1->F1_DOC  )\t\r\n\t\tDo While ( SF1->F1_FILIAL + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_SERIE + SF1->F1_DOC  ) == ( SE2->E2_FILIAL + SE2->E2_FORNECE + SE2->E2_LOJA + SE2->E2_PREFIXO + SE2->E2_NUM)\r\n\t\r\n\t\t\t\tnContx := nContx + 1\r\n\t\t\t\tcMsgAlert := \"\"\r\n\t\t\t\tcMsgAlert += \"Foi encontrado 0\" + AllTrim(Str(nCont)) +\" parcela(s).[0\" + AllTrim(Str(nCont))+\"/0\"+  AllTrim(Str(nContx))+\"]\" + chr(13)+chr(10)   \r\n\t\t\t\tcMsgAlert += \"Adicione os arquivos PDF conforme seguência abaixo:\" + chr(13)+chr(10)   \r\n\t\t\t\tcMsgAlert += \"PDF da Nota fiscal na Primeira linha. NF: \" + SF1->F1_DOC + chr(13)+chr(10)\r\n\t\t\t\tIf nCont <> 1\r\n\t\t\t\t\tcMsgAlert += \"PDF do boleto Parcela [\" +SE2->E2_PARCELA + \"] no segundo anexo.\" + chr(13)+chr(10)\r\n\t\t\t\tElse\r\n\t\t\t\t\tcMsgAlert += \"PDF do boleto no segundo anexo.\" + chr(13)+chr(10)\r\n\t\t\t\tEndIf\r\n\t\t\t\tAVISO(\"Adicionando PDF,s\", cMsgAlert , { \"Fechar\" }, 1)\r\n\t\t\t\tMsDocument('SE2',SE2->(RecNo()), 4,)\r\n\t\t\r\n\t\t\tdbSelectArea(\"SE2\")\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\tElse\r\n\t\tAlert(\"Não foi encontrado títulos financeiros para anexar os PDF´s!\")\r\n\tEndIf\r\n\t\r\nReturn() \r\n"}}}
Content-Length: 167
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MA103OPC.prw"}}}
Content-Length: 1642
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/mXdtVal.prw","languageId":"advpl","version":1,"text":"#include 'protheus.ch'\n#include 'parmtype.ch'\n//VENCIMENTO FINANCEIRO\n//MV_UCONPGL\n\nUser Function mXdtVal(cProg)\n***********************************************************************************\n*//M->E2_VENCTO >= (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n*//IIF(RetCodUsr()$\"000003/000031/000028\" .OR. \"PA\"$M->E2_TIPO,.T.,M->E2_VENCTO >= (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)) \n***\nLocal lRet    := .T.\nLocal amXdtVal:= GetArea()\nLocal cULiberado := GetMV(\"MV_UCONPGL\")\n\n\tIf AllTrim(FunName()) $ \"MATA103/MATA116/U_GATI001\" \n\t\tIF (!RetCodUsr() $ cULiberado )\n\t\t\tIF cProg = \"MT103FIN\"\n\t\t\t\tIF aLocCols[1][2] < (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n\t\t\t\t\tlRet := .F.\n\t\t\t\tEndIf\n\t\t\tElse\n\t\t\t\tIF M->E2_VENCTO < (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n\t\t\t\t\tlRet := .F.\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tEndIf\n\n\tElseIf (AllTrim(FunName()) $ \"AUTPAG/IMPORT\") \n\t\tIF( !AllTrim(M->E2_TIPO) $ \"PA/GUI/FOL\")\n\t\t\tIF (!RetCodUsr() $ cULiberado )\n\t\t\t\tIF M->E2_VENCTO < (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n\t\t\t\t\tlRet := .F.\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tEndIf\n\tElse\n\n\t\tIF( AllTrim(M->E2_TIPO) <> \"PA\")\n\t\t\tIF (!RetCodUsr() $ cULiberado ) \n\t\t\t\tIF M->E2_VENCTO < (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n\t\t\t\t\tlRet := .F.\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tEndIf\n\n\tEndIF\n\t\n\tRestArea(amXdtVal)\n\nReturn(lRet)\n"}}}
Content-Length: 166
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/mXdtVal.prw"}}}
Content-Length: 765
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/03_CONEX%C3%83ONFE/MTA103MNU.PRW","languageId":"advpl","version":1,"text":"/* ####################################################################### *\\\r\n|| #           PONTO DE ENTRADA UTILIZADO PELO IMPORTADOR GATI           # ||\r\n|| #                                                                     # ||\r\n|| #    PONTO DE ENTRADA UTILIZADO PARA INSERIR NOVAS OPÇÕES NO ARRAY    # ||\r\n|| #                   AROTINA EM DOCUMENTO DE ENTRADA                   # ||\r\n\\* ####################################################################### */\r\n\r\nUser Function GMTA103MNU()\r\n\tU_GTPE010()\r\nReturn"}}}
Content-Length: 176
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/03_CONEX%C3%83ONFE/MTA103MNU.PRW"}}}
Content-Length: 763
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/01_SOMENTE_ITINGA/MTA103MNU.PRW","languageId":"advpl","version":1,"text":"/* ####################################################################### *\\\r\n|| #           PONTO DE ENTRADA UTILIZADO PELO IMPORTADOR GATI           # ||\r\n|| #                                                                     # ||\r\n|| #    PONTO DE ENTRADA UTILIZADO PARA INSERIR NOVAS OPÇÕES NO ARRAY    # ||\r\n|| #                   AROTINA EM DOCUMENTO DE ENTRADA                   # ||\r\n\\* ####################################################################### */\r\n\r\nUser Function MTA103MNU()\r\n\tU_GTPE010()\r\nReturn"}}}
Content-Length: 175
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/01_SOMENTE_ITINGA/MTA103MNU.PRW"}}}
Content-Length: 2362
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/01_SOMENTE_ITINGA/MT103FIM.PRW","languageId":"advpl","version":1,"text":"#INCLUDE \"RWMAKE.CH\"\r\n/* ####################################################################### *\\\r\n|| #           PONTO DE ENTRADA UTILIZADO PELO IMPORTADOR GATI           # ||\r\n|| #                                                                     # ||\r\n|| #  É EXECUTADO DEPOIS QUE A NOTA É EXCLUÍDA PARA FAZER O XML VOLTAR   # ||\r\n|| #                  PARA A TELA INICIAL DO IMPORTADOR                  # ||\r\n\\* ####################################################################### */\r\n\r\n/*\r\nSO funciona na qualita pois foi incapsulado o ponto original para o GrPlus\r\nNão pode usar o MT103FIM\r\nESTE E PARA ITINGA\r\n*/\r\n\r\nUser Function MT103FIM()\r\n\r\nLocal nOpcao    := PARAMIXB[1]   // Opção Escolhida pelo usuario no aRotina\r\nLocal nConfirma := PARAMIXB[2]   // Se o usuario confirmou a operação de gravação da NFE\r\nLocal Usuario   := \"\"\r\n\r\n\r\nU_GTPE002()\r\n\r\nConOut(\"*****************************\")\r\nConOut(\"MT103FIM() NÃO USAR NO GRPLUS Informativo dos parametros\")\r\nConOut(CNUMEMP)\r\nConOut(SUBSTR(CUSUARIO,7,15)+\" \"+TRIM(DTOC(DATE()))+\" \"+TRIM(TIME())+\" \"+TRIM(COMPUTERNAME()))\r\nConOut(nConfirma )\r\nConOut(nOpcao)\r\nConOut(\"*****************************\")\r\n\r\nUsuario := SUBSTR(CUSUARIO,7,15)+\" \"+TRIM(DTOC(DATE()))+\" \"+TRIM(TIME())+\" \"+TRIM(COMPUTERNAME())\r\n\r\nIF INCLUI  \r\n\tIf RecLock(\"SF1\",.F.) \r\n\t\tIf nConfirma == 1 .and. nOpcao == 3 \r\n\t\t   \r\n\t\t    ConOut(\"*****************************\")\r\n\t\t    ConOut(Usuario)   \r\n\t    \tConOut(\"GMT103FIM() Entrou\")\r\n\t    \tConOut(\"*****************************\")\r\n\t    \t\r\n\t    \t//Replace F1_INCUSER With cUserName     \r\n\t    \tReplace F1_INCUSER With Usuario \r\n\t\t\tReplace F1_ESPECI4 With SED->ED_CODIGO\r\n\t\t\t//Replace F1_NATUREZ With SED->ED_CODIGO\r\n\t\tElse\r\n\t\t\tConOut(\"*****************************\")\r\n\t\t    ConOut(Usuario)   \r\n\t    \tConOut(\"GMT103FIM() Nao entrou\")\r\n\t    \tConOut(\"*****************************\")\r\n\t    \t\r\n\t\t\r\n\t\tEndIf\r\n\t\r\n\t\tMsUnLock()\r\n\tEndIf\r\nENDIF\r\n\r\n\r\nReturn(.T.)\r\n"}}}
Content-Length: 209
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","languageId":"advpl","version":1,"text":""}}}
Content-Length: 219
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":3},"contentChanges":[{"text":"\r\n\r\n"}]}}
Content-Length: 243
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":4},"contentChanges":[{"text":"\r\n\r\nUser Function MT103FIM()"}]}}
Content-Length: 247
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":5},"contentChanges":[{"text":"\r\n\r\n\r\nUser Function MT103FIM()"}]}}
Content-Length: 269
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":6},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\nUser Function MT103FIM()"}]}}
Content-Length: 273
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":7},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103FIM()"}]}}
Content-Length: 281
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":9},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103FIM()\r\n\r\n"}]}}
Content-Length: 293
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":10},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103FIM()\r\n\r\nReturn(.T.)"}]}}
Content-Length: 307
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":11},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103FIM()\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 307
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":12},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 311
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":13},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 315
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":14},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\n\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 316
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":15},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nS\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":28,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":1},"context":{"triggerKind":1}}}
Content-Length: 319
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":17},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nSEÇ\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 316
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":19},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nS\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 317
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":20},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nSa\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":29,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":2},"context":{"triggerKind":1}}}
Content-Length: 318
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":21},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nSal\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 316
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":23},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nS\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":30,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":1},"context":{"triggerKind":1}}}
Content-Length: 316
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":25},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nA\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":31,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":1},"context":{"triggerKind":1}}}
Content-Length: 317
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":26},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAl\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 319
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":28},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAler\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 320
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":29},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAlert\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 322
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":31},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAlert()\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 326
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":32},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAlert(\"\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":33},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAlert(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 330
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":34},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nA(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":32,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":1},"context":{"triggerKind":1}}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":38},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":33,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":5},"context":{"triggerKind":1}}}
Content-Length: 337
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":39},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVIS.or.(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":42},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVIS.(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 333
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":43},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVIS(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":44},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISI(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":34,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":5},"context":{"triggerKind":1}}}
Content-Length: 333
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":45},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVIS(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":46},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":35,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":5},"context":{"triggerKind":1}}}
Content-Length: 335
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":47},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",)\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 339
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":48},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 339
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":49},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 340
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":50},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 341
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":51},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 342
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":52},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.O\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 342
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":54},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 343
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":55},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",)\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 345
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":56},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 345
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":57},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 346
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":58},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{O})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 242
{"jsonrpc":"2.0","id":36,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":25},"context":{"triggerKind":1}}}
Content-Length: 347
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":59},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{OK})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 345
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":61},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 349
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":62},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{\"\"})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 351
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":64},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{\"OK\"})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 356
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":65},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 357
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":66},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},)\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 358
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":67},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 1239
{"jsonrpc":"2.0","id":37,"method":"$totvsserver/compilation","params":{"compilationInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw==","environment":"compila_q","includeUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/include"],"fileUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"],"compileOptions":{"recompile":true,"debugAphInfo":true,"gradualSending":true,"generatePpoFile":false,"showPreCompiler":false,"priorVelocity":true,"returnPpo":false,"commitWithErrorOrWarning":false},"extensionsAllowed":[".PRW",".PRX",".PRG",".PPX",".PPP",".TLPP",".APW",".APH",".APL",".AHU",".TRES",".PNG",".BMP",".RES",".4GL",".PER",".JS",".RPTDESIGN"],"includeUrisRequired":true}}}
Content-Length: 362
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":68},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 179
{"jsonrpc":"2.0","method":"textDocument/didSave","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":68}}}
Content-Length: 1239
{"jsonrpc":"2.0","id":38,"method":"$totvsserver/compilation","params":{"compilationInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw==","environment":"compila_q","includeUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/include"],"fileUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"],"compileOptions":{"recompile":true,"debugAphInfo":true,"gradualSending":true,"generatePpoFile":false,"showPreCompiler":false,"priorVelocity":true,"returnPpo":false,"commitWithErrorOrWarning":false},"extensionsAllowed":[".PRW",".PRX",".PRG",".PPX",".PPP",".TLPP",".APW",".APH",".APL",".AHU",".TRES",".PNG",".BMP",".RES",".4GL",".PER",".JS",".RPTDESIGN"],"includeUrisRequired":true}}}
Content-Length: 1239
{"jsonrpc":"2.0","id":39,"method":"$totvsserver/compilation","params":{"compilationInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw==","environment":"compila_q","includeUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/include"],"fileUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"],"compileOptions":{"recompile":true,"debugAphInfo":true,"gradualSending":true,"generatePpoFile":false,"showPreCompiler":false,"priorVelocity":true,"returnPpo":false,"commitWithErrorOrWarning":false},"extensionsAllowed":[".PRW",".PRX",".PRG",".PPX",".PPP",".TLPP",".APW",".APH",".APL",".AHU",".TRES",".PNG",".BMP",".RES",".4GL",".PER",".JS",".RPTDESIGN"],"includeUrisRequired":true}}}
Content-Length: 364
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":70},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 356
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":72},"contentChanges":[{"text":"#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 1239
{"jsonrpc":"2.0","id":40,"method":"$totvsserver/compilation","params":{"compilationInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw==","environment":"compila_q","includeUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/include"],"fileUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"],"compileOptions":{"recompile":true,"debugAphInfo":true,"gradualSending":true,"generatePpoFile":false,"showPreCompiler":false,"priorVelocity":true,"returnPpo":false,"commitWithErrorOrWarning":false},"extensionsAllowed":[".PRW",".PRX",".PRG",".PPX",".PPP",".TLPP",".APW",".APH",".APL",".AHU",".TRES",".PNG",".BMP",".RES",".4GL",".PER",".JS",".RPTDESIGN"],"includeUrisRequired":true}}}
Content-Length: 179
{"jsonrpc":"2.0","method":"textDocument/didSave","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":72}}}
Content-Length: 174
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/01_SOMENTE_ITINGA/MT103FIM.PRW"}}}
Content-Length: 581327
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO/nfesefaz.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"PROTHEUS.CH\"   \r\n#INCLUDE \"COLORS.CH\"\r\n#INCLUDE \"TBICONN.CH\"\r\n\r\n/*\r\n****************************************************************\r\nDATA DO ARQUIVO: Quarta-feira, 18/06/2020, \r\nDATA DA IMPLEMENTAÇÃO: 16/09/2020\r\n****************************************************************\r\n*/\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³XmlNFeSef ³ Autor ³ Eduardo Riera         ³ Data ³13.02.2007³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Rdmake de- exemplo para geracao da Nota Fiscal Eletronica do ³±±\r\n±±³          ³SEFAZ - Versao T01.00 / 2.00                                ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³String da Nota Fiscal Eletronica                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ExpC1: Tipo da NF                                           ³±±\r\n±±³          ³       [0] Entrada                                          ³±±\r\n±±³          ³       [1] Saida                                            ³±±\r\n±±³          ³ExpC2: Serie da NF                                          ³±±\r\n±±³          ³ExpC3: Numero da nota fiscal                                ³±±\r\n±±³          ³ExpC4: Codigo do cliente ou fornecedor                      ³±±\r\n±±³          ³ExpC5: Loja do cliente ou fornecedor                        ³±± \r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nUser Function XmlNfeSef(cTipo,cSerie,cNota,cClieFor,cLoja,cNotaOri,cSerieOri)\r\n\r\n//Declaração de Arrays\r\nLocal aNota     \t:= {}\r\nLocal aDupl     \t:= {}\r\nLocal aDest     \t:= {}\r\nLocal aEntrega  \t:= {}\r\nLocal aProd     \t:= {}\r\nLocal aICMS     \t:= {}\r\nLocal aICMSST   \t:= {}\r\nLocal aICMSZFM\t\t:= {}\r\nLocal aIPI      \t:= {}\r\nLocal aPIS      \t:= {}                         \r\nLocal aCOFINS   \t:= {}\r\nLocal aPISST    \t:= {}\r\nLocal aCOFINSST \t:= {}\r\nLocal aISSQN   \t\t:= {}\r\nLocal aISS      \t:= {}\r\nLocal aCST      \t:= {}\r\nLocal aRetido   \t:= {}\r\nLocal aTransp   \t:= {}\r\nLocal aImp      \t:= {}\r\nLocal aVeiculo  \t:= {}\r\nLocal aDetPag\t\t:= {}  \r\nLocal aReboque  \t:= {}\r\nLocal aReboqu2  \t:= {}\r\nLocal aEspVol   \t:= {}\r\nLocal aNfVinc   \t:= {}\r\nLocal aPedido   \t:= {}\r\nLocal aOldReg   \t:= {}\r\nLocal aOldReg2  \t:= {}\r\nLocal aMed\t\t\t:= {}\r\nLocal aArma\t\t\t:= {}\r\nLocal aComb\t\t\t:= {}\r\nLocal aveicProd\t\t:= {}\r\nLocal aLote\t\t\t:= {}\r\nLocal aIEST\t\t\t:= {}\r\nLocal aDI\t\t\t:= {}\r\nLocal aAdi\t\t\t:= {}\r\nLocal aExp\t\t\t:= {}\r\nLocal aDados\t\t:= {}\r\nLocal aPisAlqZ\t\t:= {}\r\nLocal aCofAlqZ\t\t:= {}\r\nLocal aCsosn\t\t:= {}\r\nLocal aIPIDev\t\t:= {}\r\nLocal aIPIAux\t\t:= {}\r\nLocal aNotaServ \t:= {}\r\nLocal aAnfC\t   \t\t:= {}\r\nLocal aAnfI\t   \t\t:= {} \r\nLocal aPedCom   \t:= {} \r\nLocal aInfoItem\t\t:= {}\r\nLocal aNfVincRur\t:= {}\r\nLocal aRefECF\t\t:= {}\r\nLocal aAreaSD2  \t:= {}    \t\t\t// Area do SD2\r\nLocal aAreaSF2  \t:= {}    \t\t\t// Area do SF2\r\nLocal cNfeArea\t\t:= {}\r\nLocal aRetServ \t\t:= {}\r\nLocal aRetirada\t\t:= {}\r\nLocal aMotivoCont \t:= {}\r\nLocal aTotal    \t:= {0,0,0}\r\nLocal aFCI\t\t\t:= {}\r\nLocal aDocDat\t\t:= {}\r\nLocal aICMUFDest\t:= {}\r\nLocal aIPIDevol\t\t:= {}\r\nLocal aSb1\t\t\t:= {}\r\nLocal aAgrPis\t\t:= {}\t\t\t\t\t\t\t\t\t// Verifica se a TES utiliza agrega Pis para incluir o valor na Tag vOutros\r\nLocal aAgrCofins\t:= {}\t\t\t\t\t\t\t\t\t// Verifica se a TES utiliza agrega Cofins para incluir o valor na Tag vOutros\r\nLocal aItemCupRef\t:= {}\t\t\t\t\t\t\t\t\t// Array para itens dos cupons vinculados na nota sobre cupom\r\nLocal aCupRefLoj\t:= {}\t\t\t\t\t\t\t\t\t// Array para buscar cupons relacionados na nota sobre cupom(quando e utilizado a rotina de multiplos cupons na nota sobre cupom)\r\nLocal aItemVinc\t\t:= {}\t\t\t\t\t\t\t\t\t// Array para as notas vinculadas por item\r\nLocal cAmbiente\t\t:= {}\r\nLocal cVerAmb\t\t:= {}\r\nLocal aMensAux\t\t:= {}\r\nLocal aTelEmit\t\t:= {}\r\nLocal aCMPUSR\t\t:= {}\r\nLocal aFat\t\t\t:= {}\r\nLocal aValTotOpe\t:= {}\r\n\r\n//Declaração de Strings\r\nLocal cString    \t:= \"\"\r\nLocal cNatOper   \t:= \"\"\r\nLocal cModFrete  \t:= \"\"\r\nLocal cScan      \t:= \"\"\r\nLocal cEspecie   \t:= \"\"\r\nLocal cMensCli   \t:= \"\"\r\nLocal cMensONU\t\t:= \"\"\r\nLocal cMensFis   \t:= \"\"\r\nLocal cNFe       \t:= \"\"\r\nLocal cMVSUBTRIB \t:= \"\"\r\nLocal cLJTPNFE\t\t:= \"\"\r\nLocal cWhere\t\t:= \"\"\r\nLocal cMunISS\t\t:= \"\"\r\nLocal cCodIss\t\t:= \"\"\r\nLocal cValIPI    \t:= \"\"\r\nLocal cNCM\t     \t:= \"\" \r\nLocal cField\t\t:= \"\"\r\nLocal cRetISS   \t:= \"\"\r\nLocal cTipoNF   \t:= \"\"\r\nLocal cDocEnt  \t\t:= \"\"\r\nLocal cSerEnt  \t\t:= \"\"\r\nLocal cFornece  \t:= \"\"\r\nLocal cLojaEnt  \t:= \"\"\r\nLocal cTipoNFEnt\t:= \"\"\r\nLocal cPedido   \t:= \"\"\r\nLocal cItemPC   \t:= \"\"\r\nLocal cNFOri    \t:= \"\"\r\nLocal cSerOri   \t:= \"\"\r\nLocal cItemOri  \t:= \"\"\r\nLocal cProd     \t:= \"\"\r\nLocal cLote         := \"\"\r\nLocal cTribMun  \t:= \"\"\r\nLocal cModXML   \t:= \"\"\r\nLocal cItem\t\t\t:= \"\"\r\nLocal cAnfavea\t\t:= \"\"\r\nLocal cSerNfCup \t:= \"\"\t// Serie da NF sobre Cupom\r\nLocal cNumNfCup \t:= \"\"\t// Numero do Documento da NF sobre Cupom\r\nLocal cD2Cfop  \t\t:= \"\"  // CFOP da nota \r\nLocal cD2Tes  \t\t:= \"\"\t// TES do SD2\r\nLocal cSitTrib\t\t:= \"\"\r\nLocal cValST  \t\t:= \"\"\r\nLocal cBsST    \t\t:= \"\"\r\nLocal cChave \t\t:= \"\"\r\nLocal cItemOr\t\t:= \"\"\r\nLocal cCST      \t:= \"\"\r\nLocal cInfAdic\t\t:= \"\"\r\nLocal cUmDipi       := \"\"\r\nLocal nConvDip      := 0\r\nLocal cServ     \t:= \"\"\r\nLocal cMunPres  \t:= \"\"\r\nLocal cAliasSE1  \t:= \"SE1\"\r\nLocal cAliasSE2  \t:= \"SE2\"\r\nLocal cAliasSD1  \t:= \"SD1\"\r\nLocal cAliasSD2  \t:= \"SD2\" \r\nlocal cAliasSB5   \t:=\"SB5\"\r\nLocal cAnttRntrc\t:= iif(!Empty(SM0->M0_RNTRC),AllTrim(SM0->M0_RNTRC), AllTrim(SuperGetMV(\"MV_TMSANTT\",,\"\")))  //Parametro do TMS que informa o codigo ANTT do transpotador\r\nLocal cMVNFEMSA1\t:= AllTrim(GetNewPar(\"MV_NFEMSA1\",\"\"))\r\nLocal cMVNFEMSF4\t:= AllTrim(GetNewPar(\"MV_NFEMSF4\",\"\"))\r\nLocal cMVCFOPREM\t:= AllTrim(GetNewPar(\"MV_CFOPREM\",\"\"))     // Parâmetro que informa as CFOPs de Remessa para entrega Futura que terão tratamento para que o valor de IPI seja considerado como Outras Despesas Acessórias (tag vOutros).\r\n//Local cConjug   \t:= AllTrim(SuperGetMv(\"MV_NFECONJ\",,\"\"))\r\nLocal cMV_LJTPNFE\t:= SuperGetMV(\"MV_LJTPNFE\", ,\" \")\r\nLocal cValLiqB\t\t:= SuperGetMv(\"MV_BR10925\", ,\"2\")\r\nLocal cDescServ \t:= SuperGetMV(\"MV_NFESERV\", ,\"2\")\r\nlocal cMVREFNFE\t\t:= SuperGetMV(\"MV_REFNFE\", ,\" \") \t\t\t// Parametro para informe quais CFOPs são de simples Remessa para levar informação \r\nLocal cMVCfopTran\t:= SuperGetMV(\"MV_CFOPTRA\", ,\" \")   \t\t// Parametro que define as CFOP´s pra transferência de Crédito/Débito\r\nLocal cCliLoja\t\t:= \"\" \r\nLocal cCliNota\t\t:= \"\"\r\nLocal cInfAdPr\t\t:= SuperGetMV(\"MV_INFADPR\", .F.,\"2\")      // Parametro que define de onde sera impressa as informacoes adicionais do produto\r\nLocal cInfAdPed  \t:= \"\"\r\nLocal cCodProd\t\t:= \"\" \r\nLocal cDescProd\t\t:= \"\"\r\nLocal cMsSeek\t\t:= \"\"\r\nLocal cTpPessoa\t\t:= \"\"\r\nLocal cSeekD1\t\t:= \"\"  \r\nLocal cSeekAux\t\t:= \"\" \r\nLocal cIpiCst\t\t:= \"\"\r\nLocal cNfRefcup\t\t:= \"\"\r\nLocal cSerRefcup\t:= \"\"\r\nLocal cOrigem\t\t:= \"\"\r\nLocal cCSTrib\t\t:= \"\"\r\nLocal cMsgFci\t\t:= \"\"\r\nLocal cChaveD2\t\t:= \"\"\r\nLocal cChaveF2\t\t:= \"\"\r\nLocal cTpOper\t\t:= \"\" //Tipo de operação complemento\r\nLocal cChaveD1\t\t:= \"\" \r\nLocal cMVAEHC \t\t:= AllTrim(GetNewPar(\"MV_AEHC\",\"\"))     // Informar o código de classificação AEHC\r\nLocal cHoraNota\t\t:= \"\"\r\nLocal cIndPres\t\t:= \"\"\r\nLocal cIndIss\t\t:= \"\"\r\nLocal cFilDev\t\t:= \"\"\t\t//Guarda filial de devolução\r\nLocal cTpGar\t\t:= SuperGetMV(\"MV_LJTPGAR\",,\"GE\")\r\nLocal cFieldMsg\t\t:= \"\"\r\nLocal cSpecie\t\t:= \"\"\r\nLocal cChCupom\t\t:= \"\"\r\nLocal cDevMerc\t\t:= \"\" //Identifica devolução de mercadoria que não foi entregue ao destinatário em atendimento ao Artigo 453, I, do RICMS/2000 SP)\r\nLocal cEndEmit\t\t:= \"\"\r\nLocal cFoneEmit\t\t:= \"\"\r\nLocal cCodlan\t\t:= \"\"\r\nLocal cMunTransp\t:= \"\"\r\nLocal cMunDest \t\t:= \"\"\r\nLocal cIndEscala\t:= \"\"\r\nLocal cMensDifal\t:= \"\"\r\nlocal cEstado       := \"\"\r\nlocal cICMSZFM      := \"\"\r\nLocal cMensCpl\t\t:= \"\"\r\n//Declaração de numéricos\r\nLocal nA\t\t\t:= 0\r\nLocal nX         \t:= 0\r\nLocal nCon       \t:= 1  \r\nLocal nCstIpi \t\t:= 1\r\nLocal nLenaIpi\t\t:= 0\r\nLocal nPosI\t\t\t:= 0\r\nLocal nPosF\t\t\t:= 0\r\nLocal nBaseIrrf  \t:= 0\r\nLocal nValIrrf   \t:= 0\r\nLocal nValIPI    \t:= 0\r\nLocal nValAux    \t:= 0\r\nLocal nValPisZF  \t:= 0\r\nLocal nValCofZF  \t:= 0\r\nLocal nPisRet   \t:= 0\r\nLocal nCofRet   \t:= 0\r\nLocal nInssRet  \t:= 0\r\nLocal nIrRet    \t:= 0\r\nLocal nCsllRet  \t:= 0\r\nLocal nDedu     \t:= 0\r\nLocal nIssRet   \t:= 0\r\nLocal nTotRet   \t:= 0\r\nLocal nRedBC    \t:= 0\r\nLocal nValST    \t:= 0\r\nLocal nValSTAux \t:= 0\r\nLocal nBsCalcST \t:= 0\r\nLocal nMargem\t\t:= 0\r\nLocal nDesconto \t:= 0   \t\t\t// Desconto no total da NF sobre cupom\r\nLocal nDescRed  \t:= 0   \t\t\t// Valores dos descontos dos itens referente ao Decreto nº 43.080/2002 RICMS-MG (SFT)\r\nLocal nDesTotal  \t:= 0   \t\t\t// Valor total dos descontos referente ao Decreto nº 43.080/2002 RICMS-MG\r\nLocal nDescIcm  \t:= 0   \t\t\t// Valor do desconto do ICMS-Quando TES configurada com AGREGA Valor = D\r\nLocal nDescZF\t  \t:= 0   \t\t\t// Valores dos descontos Zona Franca\r\nLocal nDescNfDup\t:= 0   \t\t\t// Valores dos descontos para deduzir os valores de ICMS diferido na NF e da Duplicata (opção: 6 – Diferido(Deduz NF e Duplicata)\t\r\nLocal nPercLeite\t:= 0\t  \t\t\t//Percentual da redução do Leite\t\r\nLocal nValLeite\t\t:= 0   \t\t\t//Valor da reduçao do Leite\r\nLocal nPrTotal\t\t:= 0   \r\nLocal nCont\t \t\t:= 0\r\nLocal nValBse\t\t:= 0\r\nLocal nValIss\t\t:= 0\r\nLocal nIcmsST\t\t:= 0\r\nLocal cNumitem\t\t:= 0\r\nLocal nOrderSF1\t\t:= 0\r\nLocal nRecnoSF1\t\t:= 0  \r\n//Local nValParImp\t\t:= 0\r\n//Local nContImp\t\t:= 0\r\nLocal nSF3Index\t\t:= 0\r\nLocal nSF3Recno\t\t:= 0\r\nlocal nValIPIDestac\t:= 0\r\nLocal nValIcmDev\t:= 0\r\nLocal nValIcmDif\t:= 0\r\nLocal nIPIConsig\t:= 0\r\nLocal nSTConsig\t\t:= 0\r\nLocal nValICMParc\t:= 0\r\nLocal nBasICMParc\t:= 0\r\nLocal nValSTParc \t:= 0\r\nLocal nBasSTParc \t:= 0\r\nLocal nVicmsDeson\t:= 0\r\nLocal nToTvBC\t\t:= 0\t\r\nLOcal nToTvICMS\t\t:= 0\r\nLocal nDeducao\t\t:= 0\r\nLocal nVIcmDif\t\t:= 0\r\nLocal nIcmsDif \t\t:= 0\r\nLocal nValISSRet\t:= 0\r\nLocal nValSimprem\t:= 0\r\nLocal nvFCPUFDest\t:= 0\r\nLocal nvICMSUFDest\t:= 0\r\nLocal nvICMSUFRemet\t:= 0\r\nLocal nvBCUFDest  \t:= 0 \r\nLocal npFCPUFDest \t:= 0 \r\nLocal npICMSUFDest\t:= 0 \r\nLocal npICMSInter \t:= 0 \r\nLocal npICMSIntP  \t:= 0 \r\nLocal nValTFecp\t    := 0\r\nLocal nValIFecp\t    := 0   \r\nLocal nTDescIt\t\t:= 0\r\nLocal nCount\t\t:= 0\r\nLocal nSD1Pos\t\t:= 0\r\nLocal nCountNF\t\t:= 0\r\nLocal nValIpiBene\t:= 0\r\nLocal nValtrib\t\t:= 0\r\nLocal nCountIT\t\t:= 0\r\nLocal nDesVrIcms\t:= 0\r\nLocal nValDifer\t\t:= 0\r\n//Declaração de Lógicos\r\nLocal lQuery    \t:= .F.\r\nLocal lCalSol\t\t:= .F.\r\nLocal lOk\t\t\t:= .T.\r\nLocal lBrinde\t\t:= .F.\t\t\t\t\t\t\t// Flag que define se é uma operação de Brinde\r\nLocal lContinua\t\t:= .T.\r\nLocal lCabAnf\t\t:= .T.\r\nLocal lConsig   \t:= .F.\t\t\t\t\t\t\t\t// Flag que diz se a operação é de consignação mercantil\r\nLocal lNfCup\t\t:= .F.\t\t\t\t\t\t\t\t// Define se eh Nf sobre cupom\r\nLocal lNFPTER\t\t:= GetNewPar(\"MV_NFPTER\",.T.)\t\t\t\t\t\r\nLocal lComplDev\t\t:= .F.\t\t   \t  \t\t\t\t\t         //Utilizado para identificar quando for uma nota de complemento de IPI de uma devulução.\r\n\r\nLocal lIpiOutr      := .F.\r\n\r\nLocal lIpiDev   \t:= GetNewPar(\"MV_IPIDEV\",.F.)   \t        //Apenas para devolução de compra de IPI (nota de saída). T-Séra gerado na tag vIPI e destacado no campo//VALOR IPI do cabeçalho do danfe. F-Será gerado na tag vIPIDevol e destacado nas informações complementares do danfe.\r\nLocal lIPIOutro \t:= GetNewPar(\"MV_IPIOUT\",.F.) .And. lIpiDev //Quando habilitado juntamente com o MV_IPIDEV, o valor do IPI será gerado na tag vOutro, destacado nas informações complementares e no campo OUTRAS DESPESAS ACESSORIAS.\r\n\r\nLocal lEipiDev   \t:= GetNewPar(\"MV_EIPIDEV\",.F.)\r\nLocal lEIPIOutro \t:= GetNewPar(\"MV_EIPIOUT\",.F.) .And. lEipiDev //Quando habilitado juntamente com o MV_EIPIDEV, o valor do IPI será gerado na tag vOutro, destacado nas informações complementares e no campo OUTRAS DESPESAS ACESSORIAS.\r\n\r\nLocal lIpiBenef\t\t:= GetNewPar(\"MV_IPIBENE\",.F.) \t\t\t\t   //Nota de saída de retorno com tipo = Beneficiamento. .T.- Será gerado na tag vOutro e destacado nas informações//complementares do danfe e no campo OUTRAS DESPESAS ACESSORIAS. .F. - Séra gerado na tag vIPI e destacado no campo//VALOR IPI do cabeçalho do danfe (procedimento padrão)\r\nLocal lIPIOutB \t    := GetNewPar(\"MV_IPIOUTB\",.F.) .And. lIpiBenef //Quando habilitado juntamente com o MV_IPIBENE, o valor do IPI será gerado na tag vOutro, destacado nas informações complementares e no campo OUTRAS DESPESAS ACESSORIAS.\r\n\r\nLocal lIcmSTDev \t:= GetNewPar(\"MV_ICSTDEV\",.T.)  //Indica se sera gravado no XML o valor e base de ICMS ST para nf de devolucao.(Padrao T - leva)\r\nLocal lIcmDevol\t\t:= GetNewPar(\"MV_ICMDEVO\",.T.)\t//Define se sera gravado no XML o valor e base de ICMS para nf de devolucao. (Padrao T - leva)\r\nLocal lIcmsPR\t\t:= .F.\t\t\t\t\t\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017)\r\nlocal lIcmSTDevOri\t:= lIcmSTDev\t\t\t\t\t// Arnazena o valor original pois é alterado para legislação ICMS/PR 2017\r\nlocal lIcmDevolOri\t:= lIcmDevol\t  \t\t\t\t// Arnazena o valor original pois é alterado para legislação ICMS/PR 2017\r\nLocal lNatOper   \t:= GetNewPar(\"MV_SPEDNAT\",.F.)\r\nLocal lInfAdZF   \t:= GetNewPar(\"MV_INFADZF\",.F.)\r\nLocal lEndFis \t\t:= GetNewPar(\"MV_SPEDEND\",.F.)\r\nLocal lEECFAT\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lMVCOMPET\t\t:= SuperGetMV(\"MV_COMBPET\", ,.F.)\r\nLocal lEasy\t\t\t:= SuperGetMV(\"MV_EASY\") == \"S\"\r\nLocal lSimpNac   \t:= SuperGetMV(\"MV_CODREG\")== \"1\" .or. SuperGetMV(\"MV_CODREG\")== \"2\"\r\nLocal lCD2PARTIC\t:= CD2->(FieldPos(\"CD2_PARTIC\")) > 0\r\nLocal lC6_CODINF\t:= SC6->(FieldPos(\"C6_CODINF\")) > 0 \r\nLocal lCpoAlqSB1 \t:= SB1->(FieldPos(\"B1_IMPNCM\")) > 0        \t// Verifica a existencia do campo de Aliq. de Imposto NCM/NBS\r\nLocal lCpoAlqSBZ\t:= SBZ->(FieldPos(\"BZ_IMPNCM\")) > 0     \t   \t// Verifica a existencia do campo de Aliq. de Imposto NCM/NBS na tabela SBZ\r\nLocal lCpoMsgLT\t\t:= SF4->(FieldPos(\"F4_MSGLT\")) > 0 \r\nLocal lCpoCusEnt\t:= SF4->(FieldPos(\"F4_CUSENTR\")) > 0 \t\t\t//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças\r\nLocal lCpoLoteFor\t:= SB8->(FieldPos(\"B8_LOTEFOR\")) > 0  \r\nLocal lValFecp\t\t:= SF3->(FieldPos(\"F3_VALFECP\")) >0 \r\nLocal lVfecpst\t\t:= SF3->(FieldPos(\"F3_VFECPST\")) >0 \r\nLocal lSb1CT\t\t:= SB1->(FieldPos(\"B1_X_CT\")) >0 \r\nLocal lHistTab\t    := existFunc(\"NotaVinc\") .And. SuperGetMv(\"MV_HISTTAB\",.F.,.F.) .And. AliasIndic('AIF') \r\n\r\n\r\nLocal lMvImpFecp\t:= GetNewPar(\"MV_IMPFECP\",.F.)\t                // Imprime FECP\r\nLocal lOrgaoPub\t\t:= GetNewPar(\"MV_NFORGPU\",.F.)\t\t\t\t//NF-e de remessa nas operações de aquisição de órgão público, com entrega em outro órgão público (RICMS SP)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//AJUSTE SINIEF 13, DE 26 DE JULHO DE 2013 \r\n\r\nLocal lUsaCliEnt\t:= GetNewPar(\"MV_NFEDEST\",.F.) \t\t\t\t//Quando habilitado considera o Cliente, Cli. Entrega e Cli. Retirada utilizados, para compor\r\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//respectivamente as tags \"dest\", \"entrega\" e \"retirada\" no XML\r\nLocal lVinc \t\t:= .F.\t// Se existe nota vinculada\r\nlocal lGrupCob\t\t:= SuperGetMV(\"MV_GRUPCOB\",.F.,.T.) \r\nLocal LRespTec  \t:= iif(findFunction(\"getRespTec\"),getRespTec(\"1\"),.T.) //0-Todos, 1-NFe, 2-MDFe\r\nLocal lNfCupZero\t:= .F.\r\nLocal lRural\t\t:= .F.\r\nLocal lSeekOk   \t:= .F.\r\nLocal lDifParc\t\t:= .F.\r\nLocal lNfCompl\t\t:= .F.\r\nLocal lFCI\t\t\t:= GetNewPar(\"MV_FCIDANF\",.F.) // Imprime ou não os dados da FCI no Xml/Danfe (De acordo com as configurações necessárias)\r\nLocal lGE\t\t\t:= FindFunction(\"LjUP104OK\") .AND. LjUP104OK() .AND. SuperGetMV(\"MV_LJIMPGF\",,.F.)\t// Indica se usa garantia\r\nLocal lLjDescIt\t\t:= .F.\t// Inicializa as variaveis que serao utilizadas para desconto \r\nLocal lFirstItem \t:= .T.\r\nLocal lF1Motivo\t\t:= SF1->(FieldPos(\"F1_MOTIVO\")) > 0\r\nLocal lNfCupNFCE\t:= .F.\r\nLocal lNfCupSAT\t\t:= .F.\r\nLocal lChave     \t:= .F.\r\nLocal lCNPJIgual\t:= .F.\r\nLocal lEIC0064\t\t:= GetNewPar(\"MV_EIC0064\",.F.)\r\nLocal lVeicNovo     := .F.\r\nLocal cD2TesNF\t\t:= \"\" // TES da NF Sobre Cupom (SD2)\r\nLocal cForma\t\t:= \"\"\r\nlocal cChvPag\t\t:= \"\"      \r\nLocal aSX560      \t:= {}\r\nLocal aSX513      \t:= {}\r\nLocal cFiltro\t\t:= \"\"\r\n//Parametro Logico - Define se sera impresso a 2a. Unidade de Medida para operacoes dentro do País - Opcoes: [.T.]-Não Imprime ou [.F.]-Imprime (Default)\r\nLocal lNoImp2UM\t\t:= GetNewPar(\"MV_NIMP2UM\",.F.)\r\n\r\n//Relacao de CFOP's vinculadas a exportacao - NT 2016.001\r\nLocal cCFOPExp \t\t:= \"1501-2501-5501-5502-5504-5505-6501-6502-6504-6505\"\r\n\r\nLocal lPe01Nfe\t\t:= ExistBlock(\"PE01NFESEFAZ\")\r\nLocal lIntegHtl \t:= SuperGetMv(\"MV_INTHTL\",, .F.) //Integracao via Mensagem Unica - Hotelaria\r\n//Alimentação da tag retTransp\r\nLocal nBCTot \t\t:= 0\r\nLocal nALIQTot\t\t:= 0\r\nLocal nVLTRIBTot\t:= 0\r\nLocal aObsCont\t\t:= {}\r\n\r\n//Alimentação do Grupo de Repasse\r\nLocal nBRICMSO \t\t:= 0\r\nLocal nICMRETO\t\t:= 0\r\nLocal nBRICMSD \t\t:= 0\r\nLocal nICMRETD\t\t:= 0\r\nLocal nAliqST\t\t:= 0\r\nLocal nCrdPres\t\t:= 0\r\nLocal nTotCrdP      := 0\r\n\r\nLocal aRetPgLoj \t:= {}\r\nLocal aProcRef\t\t:= {}\r\nLocal lVLojaDir \t:= .F. //Venda Direta ou Loja ou Nota Sobre Cupom\r\nLocal cIndPag\t\t:= \"\"\r\nLocal nValOutr\t\t:= 0\r\nLocal cTpOrig \t\t:= \"\"\r\nLocal lDescIss\t\t:= SuperGetMV(\"MV_DESCISS\",,.F.) //Informa ao sistema se o ISS devera ser descontado do valor do titulo financeiro caso o cliente for responsável pelo recolhimento.\r\nLocal lTpabiss\t\t:= SuperGetMV(\"MV_TPABISS\",,\"2\") == \"1\"//Se parâmetro igual a 1 indica se será efetuado um desconto na duplicata quando o cliente recolhe ISS se igual a 2 será gerado um titulo de abatimento.\r\nLocal lRuleDescISS  := lDescIss .And. lTpabiss\r\nLocal cSeekCDA\t\t:= \"\"\r\nlocal lCodLan\t\t:= .F.\r\nLocal nDescFis\t\t:= 0\r\nLocal cTpEspcBen\t:= \"\"\r\nlocal cStringUTF\t:= \"\"\r\nLocal lNCMOk\t\t:= .F.\r\n\r\nLocal aTotICMSST\t:= {}\r\n\r\nLocal aOrdSED\t\t:= {}\r\nLocal cNatFin\t\t:= \"\"\r\nLocal cED_DEDINSS\t:= \"\"\r\nLocal cED_RECFUN\t:= \"\"\r\nLocal cFilTit \t\t:= \"\"\r\nLocal cPrfTit \t\t:= \"\"\r\nLocal cNumTit \t\t:= \"\"\r\nLocal cNumDupl\t\t:= \"\"\r\nLocal cChaveSE1 \t:= \"\"\r\n\r\nlocal cRetForm\t\t:= \"\"\r\n\r\nlocal nPosCpoEsp\t:= 0\r\nlocal nPosCpoVol\t:= 0\r\nlocal nVolume\t\t:= 0\r\nlocal cMRCVLMSF1\t:= alltrim(SuperGetMV(\"MV_MRCVLM1\",,\"\"))\r\nlocal cMRCVLMSF2\t:= alltrim(SuperGetMV(\"MV_MRCVLM2\",,\"\"))\r\nlocal aCpoMarVol\t:= {}\r\nlocal cCpoMarca\t\t:= \"\"\r\nlocal cCpoNumer\t\t:= \"\"\r\nlocal nPosCpoMrc\t:= 0\r\nlocal nPosCpoNum\t:= 0\r\nlocal cMarca\t\t:= \"\"\r\nlocal cNumeracao\t:= \"\"\r\n\r\n//Declaração de Arrays\r\nPrivate aUF     \t:= {}\r\nPrivate aCSTIPI \t:= {}\r\n \r\n//Declaração de Strings\r\nPrivate cFntCtrb\t:= \"\"\r\nPrivate cMvMsgTrib\t:= SuperGetMV(\"MV_MSGTRIB\",,\"1\")\r\nPrivate cMvFntCtrb\t:= SuperGetMV(\"MV_FNTCTRB\",,\" \")\r\nPrivate cMvFisCTrb\t:= SuperGetMV(\"MV_FISCTRB\",,\"1\")\r\nPrivate cAutXml\t\t:= SuperGetMV(\"MV_AUTXML\",,\"\")\r\nPrivate cMVEstado\t:= SuperGetMV(\"MV_ESTADO\", ,\" \")\r\nPrivate cTpCliente\t:= \"\"\r\nPrivate cIdRecopi\t:= \"\"\r\nPrivate cNumRecopi\t:= \"\"\r\nPrivate cIdDest\t\t:= \"\"\r\nPrivate cIndFinal\t:= \"\"\r\nPrivate cIndIEDest \t:= \"\"\r\nPrivate cTPNota\t    := \"\"\t\r\n//Declaração de numéricos\r\nPrivate nTotNota\t:= 0\r\nPrivate nTotalCrg\t:= 0\r\nPrivate nTotFedCrg\t:= 0\t// Ente Tributante Federal\r\nPrivate nTotEstCrg\t:= 0\t// Ente Tributante Estadual\r\nPrivate nTotMunCrg\t:= 0\t// Ente Tributante Municipal\r\n\r\n//Declaração de Lógicos\r\nPrivate lMvEnteTrb\t:= SuperGetMV(\"MV_ENTETRB\",,.F.)\t// Valor dos tributos por Ente Tributante: Federal, Estadual e Municipal\r\nPrivate lMvNFLeiZF\t:= SuperGetMV(\"MV_NFLEIZF\",,.F.)\t// Tratamento para a lei da Portaria Suframa nº 275/2009 para Pis e Cofins do chamado TPIPVV\r\nPrivate lAnfavea\t:= If(AliasIndic(\"CDR\") .And. AliasIndic(\"CDS\"),.T.,.F.)\r\nPrivate lCustoEntr\t:= .F.\t//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças\r\nPrivate lDifal\t\t:= .F.\r\nPrivate lDifer\t\t:= .F.\r\nPrivate lTagProduc\t:= .F.\r\n\r\nIf FunName() == \"SPEDNFSE\"\r\n\tDEFAULT cTipo   := PARAMIXB[1]\r\n\tDEFAULT cSerie  := PARAMIXB[3]\r\n\tDEFAULT cNota   := PARAMIXB[4]\r\n\tDEFAULT cClieFor:= PARAMIXB[5]\r\n\tDEFAULT cLoja   := PARAMIXB[6]     \r\n\t\r\n\t\r\nElse\r\n\tDefault cTipo     := PARAMIXB[1,1] // PARAMIXB[1]\r\n\tDefault cSerie    := PARAMIXB[1,3] // PARAMIXB[3]\r\n\tDefault cNota     := PARAMIXB[1,4] // PARAMIXB[4]\r\n\tDefault cClieFor  := PARAMIXB[1,5] // PARAMIXB[5]\r\n\tDefault cLoja     := PARAMIXB[1,6] // PARAMIXB[6]    \r\n\taMotivoCont \t  := PARAMIXB[1,7]\r\n\tcVerAmb     \t  := PARAMIXB[2]\r\n\tcAmbiente\t\t  := PARAMIXB[3]                  \r\n\tDEFAULT cNotaOri  := PARAMIXB[4,1]                  \r\n\tDEFAULT cSerieOri := PARAMIXB[4,2]\r\n\tlTagProduc \t\t  := date() > CTOD(\"06/05/2019\") .or. cAmbiente == \"2\"\r\nEndif\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Preenchimento do Array de UF                                            ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\naadd(aUF,{\"RO\",\"11\"})\r\naadd(aUF,{\"AC\",\"12\"})\r\naadd(aUF,{\"AM\",\"13\"})\r\naadd(aUF,{\"RR\",\"14\"})\r\naadd(aUF,{\"PA\",\"15\"})\r\naadd(aUF,{\"AP\",\"16\"})\r\naadd(aUF,{\"TO\",\"17\"})\r\naadd(aUF,{\"MA\",\"21\"})\r\naadd(aUF,{\"PI\",\"22\"})\r\naadd(aUF,{\"CE\",\"23\"})\r\naadd(aUF,{\"RN\",\"24\"})\r\naadd(aUF,{\"PB\",\"25\"})\r\naadd(aUF,{\"PE\",\"26\"})\r\naadd(aUF,{\"AL\",\"27\"})\r\naadd(aUF,{\"MG\",\"31\"})\r\naadd(aUF,{\"ES\",\"32\"})\r\naadd(aUF,{\"RJ\",\"33\"})\r\naadd(aUF,{\"SP\",\"35\"})\r\naadd(aUF,{\"PR\",\"41\"})\r\naadd(aUF,{\"SC\",\"42\"})\r\naadd(aUF,{\"RS\",\"43\"})\r\naadd(aUF,{\"MS\",\"50\"})\r\naadd(aUF,{\"MT\",\"51\"})\r\naadd(aUF,{\"GO\",\"52\"})\r\naadd(aUF,{\"DF\",\"53\"})\r\naadd(aUF,{\"SE\",\"28\"})\r\naadd(aUF,{\"BA\",\"29\"})\r\naadd(aUF,{\"EX\",\"99\"})\r\n\r\nIf FindFunction(\"GETSUBTRIB\")\r\n\tcMVSUBTRIB := GetSubTrib()\r\nEndif\r\n\r\nIF GetNewPar(\"MV_CMPUSR\",\"\")  <>  \"\"\r\n\taCMPUSR\t:= StrTokArr( GetNewPar(\"MV_CMPUSR\",\"\"), \"|\" )\t\r\nEndif \r\n\r\nIf cTipo == \"1\"\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Verifica se existem mais de um cupom relacionado na nota sobre cupom    ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\r\n\t//Para usar a função do loja LjR30Sped ja tem que estar posicionado na SF2 \r\n\tIf FindFunction(\"LjR30Sped\")\r\n\t\tcNFeArea := SF2->(GetArea()) \r\n\t\tdbSelectArea(\"SF2\") \r\n\t\tdbSetOrder(1)\r\n\t\tIf MsSeek(xFilial(\"SF2\")+cNota+cSerie+cClieFor+cLoja)\r\n\t\t\taItemCupRef := LjR30Sped()\r\n\t\tEndif\r\n\t\tRestArea(cNfeArea)\r\n\tEndIf\r\n\r\n\taCupRefLoj := NfMultCup(aItemCupRef, cSerie, cNota, cClieFor, cLoja)\r\n\r\n\tFor nCountNF := 1 To Len(aCupRefLoj)\r\n\t\taNota\t\t:= {}\r\n\t\taEntrega\t:= {}\r\n\t\taDest\t\t:= {}\r\n\t\taTransp\t\t:= {}\r\n\t\taVeiculo\t:= {}\r\n\t\taReboque\t:= {}\r\n\t\taReboqu2\t:= {}\r\n\t\tlVLojaDir \t:= .F.\r\n\r\n\t\tcSerie\t\t:= aCupRefLoj[nCountNF][1]\r\n\t\tcNota\t\t:= aCupRefLoj[nCountNF][2]\r\n\t\tcClieFor\t:= aCupRefLoj[nCountNF][3]\r\n\t\tcLoja\t\t:= aCupRefLoj[nCountNF][4]\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Posiciona NF                                                            ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tdbSelectArea(\"SF2\")\r\n\t\tdbSetOrder(1)\r\n\t\tIf MsSeek(xFilial(\"SF2\")+cNota+cSerie+cClieFor+cLoja)\r\n\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Busca dados do ISS                                                      ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\tdbSetOrder(4)\r\n\t\t\tIf MsSeek(xFilial(\"SF3\")+cClieFor+cLoja+cNota+cSerie)\r\n\t\t\t\tWhile !SF3->(Eof()) .And. cClieFor+cLoja+cNota+cSerie == SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE\r\n\t\t\t\t\t\r\n\t\t\t\t\tnCont++\r\n\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t//FT_FILIAL+FT_TIPOMOV+FT_CLIEFOR+FT_LOJA+FT_SERIE+FT_NFISCAL+FT_IDENTF3\r\n\t\t\t\t\tMsSeek(xFilial(\"SFT\")+\"S\"+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_SERIE+SF3->F3_NFISCAL+SF3->F3_IDENTFT)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SFT->FT_NFISCAL+SFT->FT_SERIE+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_PRODUTO)\r\n\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SF4\")+SD2->D2_TES)\r\n\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\r\n\t\t\t\t\t\tIf SF3->F3_RECISS ==\"1\"\r\n\t\t\t\t\t\t\tcSitTrib := \"R\"\r\n\t\t\t\t\t\tElseif SF3->F3_RECISS ==\"2\" \r\n\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\tElseif SF4->F4_LFISS ==\"I\"\r\n\t\t\t\t\t\t\tcSitTrib:= \"I\"\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndif\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SB1\")+SD2->D2_COD)\r\n\t\t\t\t\tIf SB1->(FieldPos(\"B1_TRIBMUN\"))>0\r\n\t\t\t\t\t\tcTribMun:= SB1->B1_TRIBMUN\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\r\n\t\t\t\t\tcTpPessoa\t:= SA1->A1_TPESSOA\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tIf nCont == 1\r\n\t\t\t\t\t\tDo While !SD2->(Eof ()) .And. xFilial(\"SD2\") == (cAliasSD2)->D2_FILIAL .And.;\r\n\t\t\t\t\t\t\t\tSF2->F2_DOC == (cAliasSD2)->D2_DOC . And. SF2->F2_SERIE == (cAliasSD2)->D2_SERIE .And.;\r\n\t\t\t\t\t\t\t\tSF2->F2_CLIENTE == (cAliasSD2)->D2_CLIENTE .And. SF2->F2_LOJA == (cAliasSD2)->D2_LOJA .And.;\r\n\t\t\t\t\t\t\t\t( SF3->F3_TIPO == \"S\" .Or. lSimpNac )\r\n\t\t\t\t\t\t\t\tIf SF3->F3_TIPO == \"S\"\r\n\t\t\t\t\t\t\t\t\tnPrTotal += (cAliasSD2)->D2_PRCVEN\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t//------------------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\t// Retirado o uso do parametro MV_SIMPREM para que a mensagem sejá gerado de acordo com o CSOSN\r\n\t\t\t\t\t\t\t\t//------------------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+SD2->D2_TES)\r\n\t\t\t\t\t\t\t\tIf lSimpNac .And. (SF4->F4_CSOSN $ '101-201-900')\r\n\t\t\t\t\t\t\t\t\tnValSimprem += (cAliasSD2)->D2_VALICM\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tSD2->(DbSkip ())\r\n\t\t   \t\t\t\tEndDo\r\n\t\t   \t\t\t\t\r\n\t\t   \t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t   \t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t   \t\t\r\n\t\t   \t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf DbSeek(xFilial(\"CD2\")+\"S\"+SF2->F2_SERIE+SF2->F2_DOC+cClieFor+cLoja+PadR(SD2->D2_ITEM,4)+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\tDo While !CD2->(Eof ()) .And. CD2->CD2_DOC == (cAliasSD2)->D2_DOC  \r\n\t\t\t                    If Alltrim(CD2->CD2_IMP) == \"ISS\" \r\n\t\t\t                    \tnValIss\t+= CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCD2->(DbSkip ())\r\n\t\t\t\t\t\t\tEndDo \r\n\t\t\t\t\t\tEndIf \r\n\t\t   \t\t\tEndIf\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf FunName() == \"SPEDNFSE\" //.Or. FunName() == \"SPEDCTE\"\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\r\n\t\t\t\t\t\t\taadd(aISSQN,;\r\n\t\t\t\t\t\t\t\t\t\t{AllTrim(SF3->F3_CODISS),;\r\n\t\t\t\t\t\t\t\t\t\tnPrTotal+SF3->F3_VALOBSE,;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_CNAE,;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_ALIQICM,;\r\n\t\t\t\t\t\t\t\t\t\tIIf((SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\"),nValIss,SF3->F3_VALICM),;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_VALOBSE,;\r\n\t\t\t\t\t\t\t\t\t\tcTribMun,;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_BASEICM,;\r\n\t\t\t\t\t\t\t\t\t\tcSitTrib})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aISSQN,;\r\n\t\t\t\t\t\t\t\t\t\t{\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\"})\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tSF3->(dbSkip())\r\n\t\t\t\tEnd\r\n\t\t\t\t\r\n\t\t\tEndif\r\n\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Tratamento temporario do CTe                                            ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf FunName() == \"SPEDCTE\" .Or. AModNot(SF2->F2_ESPECIE)==\"57\"\r\n\t\t\t\tcNFe := \"CTe35080944990901000143570000000000200000168648\"\r\n\t\t\t\tcString := '<infNFe versao=\"T02.00\" modelo=\"57\" >'\r\n\t\t\t\tcString += '<CTe xmlns=\"http://www.portalfiscal.inf.br/cte\">'\r\n\t\t\t\tcString += '<infCte Id=\"CTe35080944990901000143570000000000200000168648\" versao=\"1.02\"><ide><cUF>35</cUF><cCT>000016864</cCT><CFOP>6353</CFOP>'\r\n\t\t\t\tcString += '<natOp>ENTREGA NORMAL</natOp><forPag>1</forPag><mod>57</mod><serie>0</serie><nCT>20</nCT><dhEmi>2008-09-12T10:49:00</dhEmi>'\r\n\t\t\t\tcString += '<tpImp>2</tpImp><tpEmis>2</tpEmis><cDV>8</cDV><tpAmb>2</tpAmb><tpCTe>0</tpCTe><procEmi>0</procEmi><verProc>1.12a</verProc>'\r\n\t\t\t\tcString += '<cMunEmi>3550308</cMunEmi><xMunEmi>Sao Paulo</xMunEmi><UFEmi>SP</UFEmi><modal>01</modal><tpServ>0</tpServ><cMunIni>3550308</cMunIni>'\r\n\t\t\t\tcString += '<xMunIni>Sao Paulo</xMunIni><UFIni>SP</UFIni><cMunFim>3550308</cMunFim><xMunFim>Sao Paulo</xMunFim><UFFim>SP</UFFim><retira>1</retira>'\r\n\t\t\t\tcString += '<xDetRetira>TESTE</xDetRetira><toma03><toma>0</toma></toma03></ide><emit><CNPJ>44990901000143</CNPJ><IE>00000000000</IE>'\r\n\t\t\t\tcString += '<xNome>FILIAL SAO PAULO</xNome><xFant>Teste</xFant><enderEmit><xLgr>Av. Teste, S/N</xLgr><nro>0</nro><xBairro>Teste</xBairro><cMun>3550308</cMun>'\r\n\t\t\t\tcString += '<xMun>Sao Paulo</xMun><CEP>00000000</CEP><UF>SP</UF></enderEmit></emit><rem><CNPJ>58506155000184</CNPJ><IE>115237740114</IE><xNome>CLIENTE SP</xNome>'\r\n\t\t\t\tcString += '<xFant>CLIENTE SP</xFant><enderReme><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun><xMun>SAO PAULO</xMun>'\r\n\t\t\t\tcString += '<CEP>77777777</CEP><UF>SP</UF></enderReme><infOutros><tpDoc>00</tpDoc><dEmi>2008-09-17</dEmi></infOutros></rem><dest><CNPJ></CNPJ><IE></IE>'\r\n\t\t\t\tcString += '<xNome>CLIENTE RJ</xNome><enderDest><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun><xMun>RIO DE JANEIRO</xMun>'\r\n\t\t\t\tcString += '<CEP>44444444</CEP><UF>RJ</UF></enderDest></dest><vPrest><vTPrest>1.93</vTPrest><vRec>1.93</vRec></vPrest><imp><ICMS><CST00><CST>00</CST><vBC>250.00</vBC>'\r\n\t\t\t\tcString += '<pICMS>18.00</pICMS><vICMS>450.00</vICMS></CST00></ICMS></imp><infCteComp><chave>35080944990901000143570000000000200000168648</chave><vPresComp>'\r\n\t\t\t\tcString += '<vTPrest>10.00</vTPrest></vPresComp><impComp><ICMSComp><CST00Comp><CST>00</CST><vBC>10.00</vBC><pICMS>10.00</pICMS><vICMS>10.00</vICMS></CST00Comp>'\r\n\t\t\t\tcString += '</ICMSComp></impComp></infCteComp></infCte></CTe>'\r\n\t\t\t\tcString += '</infNFe>'\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento Nota de Servico  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tElseIf FunName() == \"SPEDNFSE\"\r\n\t\t\t\t\r\n\t\t\t\t//Modelo do XML ISSNET ou BH\r\n\t\t\t\tcModXML:= mv_par04\r\n\t\t\t\t\r\n\t\t\t\taadd(aNotaServ,SF2->F2_SERIE)\r\n\t\t\t\taadd(aNotaServ,SF2->F2_DOC)\r\n\t\t\t\taadd(aNotaServ,SF2->F2_EMISSAO)\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Posiciona cliente  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\taadd(aDest,AllTrim(SA1->A1_CGC))\r\n\t\t\t\taadd(aDest,SA1->A1_NOME)\r\n\t\t\t\taadd(aDest,FisGetEnd(SA1->A1_END,SA1->A1_EST)[1])\r\n\t\t\t\tIf \"/\" $ FisGetEnd(SA1->A1_END,SA1->A1_EST)[3]\r\n\t\t\t\t\taadd(aDest,IIF(FisGetEnd(SA1->A1_END,SA1->A1_EST)[3]<>\"\",FisGetEnd(SA1->A1_END,SA1->A1_EST)[3],\"SN\"))\r\n\t\t\t\tElse\r\n\t \t\t\t\taadd(aDest,IIF(FisGetEnd(SA1->A1_END,SA1->A1_EST)[2]<>0,FisGetEnd(SA1->A1_END,SA1->A1_EST)[2],\"SN\"))\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\taadd(aDest,FisGetEnd(SA1->A1_END,SA1->A1_EST)[4])\r\n\t\t\t\taadd(aDest,SA1->A1_BAIRRO)\r\n\t\t\t\t\r\n\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aDest,\"99999\")\r\n\t\t\t\tEndIf\r\n\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\taadd(aDest,SA1->A1_CEP)\r\n\t\t\t\taadd(aDest,Alltrim(SA1->A1_DDD)+SA1->A1_TEL)\r\n\t\t\t\taadd(aDest,SA1->A1_INSCRM)\r\n\t\t\t\taadd(aDest,SA1->A1_EMAIL)\r\n\t\t\t\t\r\n\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\tSC6->(dbSetOrder(4))\r\n\t\t\t\t\tSC5->(dbSetOrder(1))\r\n\t\t\t\t\tIf (SC6->(MsSeek(xFilial(\"SC6\")+SF2->F2_DOC+SF2->F2_SERIE)))\r\n\t\t\t\t\t\tSC5->(MsSeek(xFilial(\"SC5\")+SC6->C6_NUM))\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf Empty (SC5->C5_FORNISS)\r\n\t\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tSA2->(dbSetOrder(1))\r\n\t\t\t\t\t\t\tSA2->(MsSeek(xFilial(\"SA2\")+SC5->C5_FORNISS+\"00\"))\r\n\t\t\t\t\t\t\taadd(aDest,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aDest,Upper(SA2->A2_EST))\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aDest,\"99999\")\r\n\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\tdbSetOrder(4)\r\n\t\t\t\tMsSeek(xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE)\r\n\t\t\t\t\r\n\t\t\t\tWhile !Eof() .And. xFilial(\"SF3\") == SF3->F3_FILIAL .And.;\r\n\t\t\t\t\tSF2->F2_SERIE == SF3->F3_SERIE .And.;\r\n\t\t\t\t\tSF2->F2_DOC == SF3->F3_NFISCAL .And. !Empty(SF3->F3_CODISS) .And. SF3->F3_TIPO==\"S\"\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Natureza da Operação\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSST\"))>0\r\n\t\t\t\t\t\tcNatOper:= SF3->F3_ISSST\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Tipo de RPS - O sistema de BH ainda não está recebendo Notas Conjugadas\r\n\t\t\t\t\t//If SF2->F2_ESPECIE $ cConjug\r\n\t\t\t\t\t//cTipoRps:=\"2\" //RPS - Conjugada (Mista)\r\n\t\t\t\t\tIf !Empty(SF2->F2_PDV)\r\n\t\t\t\t\t\tcTipoRps:=\"3\" //Cupom\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcTipoRps:=\"1\" //RPS\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Pega os impostos de retencao somente quando houver a retenção, ³\r\n\t\t\t\t\t//³ou seja, os titulos de retenção que existirem                  ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\t\t\tSE1->(dbSetOrder(2))\r\n\t\t\t\t\tIf SE1->(dbSeek(xFilial(\"SE1\")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_SERIE+SF3->F3_NFISCAL))\r\n\t\t\t\t\t\tWhile !SE1->(Eof()) .And. xFilial(\"SE1\") == SE1->E1_FILIAL .And.;\r\n\t\t\t\t\t\t\t\tSF3->F3_CLIEFOR == SE1->E1_CLIENTE .And. SF3->F3_LOJA == SE1->E1_LOJA .And.;\r\n\t\t\t\t\t\t\t\tSF3->F3_SERIE == SE1->E1_PREFIXO .And. SF3->F3_NFISCAL == SE1->E1_NUM\r\n\t\t\t\t\t\t\tIf 'NF' $ SE1->E1_TIPO\r\n\t\t\t\t\t\t\t\tnTotRet+=SumAbatRec(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,SE1->E1_MOEDA,\"V\",SE1->E1_BAIXA,,@nIrRet,@nCsllRet,@nPisRet,@nCofRet,@nInssRet)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tSE1->(DbSkip ())\r\n\t\t\t\t\t\tEndDo\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aRetServ,{nIrRet,nCsllRet,nPisRet,nCofRet,nInssRet,nTotRet})\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Pega as deduções ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSSUB\"))>0\r\n\t\t\t\t\t\tnDedu+= SF3->F3_ISSSUB\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSMAT\"))>0\r\n\t\t\t\t\t\tnDedu+= SF3->F3_ISSMAT\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Obtem os dados do Serviço ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\taSX560 \t := FwGetSX5(\"60\",SF3->F3_CODISS)\r\n\t\t\t\t\tIf len(aSX560) > 0\r\n\t\t\t\t\t\t//Verifico se a Descrição é composta do pedido de Venda ou SX5\r\n\t\t\t\t\t\tIf cDescServ$\"1\"\r\n\t\t\t\t\t\t\tSC6->(dbSetOrder(4))\r\n\t\t\t\t\t\t\tSC5->(dbSetOrder(1))\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SC6\")+SF3->F3_NFISCAL+SF3->F3_SERIE)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SC5\")+SC6->C6_NUM)\r\n\t\t\t\t\t\t\t\r\n\t\t\t           \tIF len(aCMPUSR) > 0  \r\n\t\t\t\t\t\t\t\t\tcFieldMsg := aCMPUSR[1]  \r\n\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf !Empty(cFieldMsg) .and. SC5->(FieldPos(cFieldMsg)) > 0 .and. !Empty(&(\"SC5->\"+cFieldMsg))\r\n\t\t\t\t\t\t\t\tcServ := &(\"SC5->\"+cFieldMsg) \r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcServ := SC5->C5_MENNOTA\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf Empty(cServ)\r\n\t\t\t\t\t\t\t\tcServ := aSX560[1][4]\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcServ := aSX560[1][4]\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Verifica se recolhe ISS Retido ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\tIf SF3->F3_RECISS $\"1|S\"\r\n\t\t\t\t\t\t\tcRetIss :=\"1\"\r\n\t\t\t\t\t\t\tnIssRet := SF3->F3_VALICM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcRetIss :=\"2\"\r\n\t\t\t\t\t\t\tnIssRet := 0\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tElseIf SA1->A1_RECISS $\"1|S\"\r\n\t\t\t\t\t\tcRetIss :=\"1\"\r\n\t\t\t\t\t\tnIssRet := SF3->F3_VALICM\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcRetIss :=\"2\"\r\n\t\t\t\t\t\tnIssRet := 0\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Verifica se municipio de prestação foi informado no pedido ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf SC5->(FieldPos(\"C5_MUNPRES\")) > 0 .And. !Empty(SC5->C5_MUNPRES)\r\n\t\t\t\t\t\tcMunPres  := SC5->C5_MUNPRES\r\n\t\t\t\t\t\tcMunPres:= ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[14]})][02]+cMunPres)\r\n\t\t\t\t\t\tcDescMunP := SC5->C5_DESCMUN\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMunPres:= aDest[13]\r\n\t\t\t\t\t\tcMunPres:= ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[14]})][02]+cMunPres)\r\n\t\t\t\t\t\tcDescMunP := aDest[08]\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SB1\")+SD2->D2_COD)\r\n\t\t\t\t\tIf SB1->(FieldPos(\"B1_TRIBMUN\"))>0\r\n\t\t\t\t\t\tcTribMun:= SB1->B1_TRIBMUN\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tcString := \"\"\r\n\t\t\t\t\tcString += NFSeIde(aNotaServ,cNatOper,cTipoRPS,cModXML)\r\n\t\t\t\t\tcString += NFSeServ(aISSQN[1],aRetServ[1],nDedu,nIssRet,cRetIss,cServ,cMunPres,cModXML,cTpPessoa)\r\n\t\t\t\t\tcString += NFSePrest(cModXML)\r\n\t\t\t\t\tcString += NFSeTom(aDest,cModXML,cMunPres)\r\n\t\t\t\t\t\r\n\t\t\t\t\tExit\r\n\t\t\t\tEndDo\r\n\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Para o caso de Nota sobre Cupom Fiscal, busca os dados da Nota  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t  \t\r\n\t\t\t  \tIf (\"CF\" $ SF2->F2_ESPECIE .OR. \"NFCE\" $ SF2->F2_ESPECIE .OR. \"SATCE\" $ SF2->F2_ESPECIE .OR. (LjAnalisaLeg(18)[1] .AND. \"ECF\" $ SF2->F2_ESPECIE .AND. (\"S\" $ SF2->F2_ECF) )) .AND. !Empty(SF2->F2_NFCUPOM) \r\n\t\t\t\t\tcSerNfCup \t:= SubStr(SF2->F2_NFCUPOM,1,TamSx3(\"F2_SERIE\")[1])\r\n\t\t\t\t\tcNumNfCup \t:= SubStr(SF2->F2_NFCUPOM,4,TamSx3(\"F2_DOC\")[1]) \r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(cNotaOri) .And. cNotaOri <> cNumNfCup\t\t\t\t                                                            \r\n\t\t\t\t\t\tcSerNfCup \t:= cSerieOri\r\n\t\t\t\t\t\tcNumNfCup \t:= cNotaOri\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Alltrim(SF2->F2_ESPECIE) == \"NFCE\"\r\n\t\t\t\t\t\tlNfCupNFCE := .T.\r\n\t\t\t\t\tElseIf Alltrim(SF2->F2_ESPECIE) == \"SATCE\"\r\n\t\t\t\t\t\tlNfCupSAT := .T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tDbSelectArea( \"SF2\" )\r\n\t\t\t\t\tDbSetOrder(1)  // F2_DOC + F2_SERIE + F2_CLIENTE + F2_LOJA\r\n\t\t\t\t\tIf DbSeek( xFilial(\"SF2\") + cNumNfCup + cSerNfCup)\r\n\t\t\t\t\t\taadd(aNota,SF2->F2_SERIE)\r\n\t\t\t\t\t\taadd(aNota,IIf(Len(SF2->F2_DOC)==6,\"000\",\"\")+SF2->F2_DOC)\r\n\t\t\t\t\t\taadd(aNota,SF2->F2_EMISSAO)\r\n\t\t\t\t\t\tlNfCup\t:= .T.\r\n\t\t\t\t\t\tcCliNota\t:= SF2->F2_CLIENTE\r\n\t\t\t\t\t\tcCliLoja\t:= SF2->F2_LOJA\r\n\t\t\t\t\t\tcHoraNota\t:= SF2->F2_HORA\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tRestArea(aAreaSF2)\r\n\t \t\t\tEndIf       \r\n\t            \r\n\t\t\t\tIf !lNfCup .OR. Len(aNota) == 0\r\n\t\t\t\t\taadd(aNota,SF2->F2_SERIE)\r\n\t\t\t\t\taadd(aNota,IIF(Len(SF2->F2_DOC)==6,\"000\",\"\")+SF2->F2_DOC)\r\n\t\t\t\t\taadd(aNota,SF2->F2_EMISSAO)\r\n\t\t\t\tEndIf    \r\n\t\t\t\t\r\n\t\t\t\taadd(aNota,cTipo)\r\n\t\t\t\taadd(aNota,SF2->F2_TIPO)\r\n\t\t\t\taadd(aNota,Iif(lNfCup,cHoraNota,SF2->F2_HORA))\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Posiciona cliente ou fornecedor                                         ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\t\t\t\tIf !SF2->F2_TIPO $ \"DB\" \r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tIf (SF2->(ColumnPos(\"F2_CLIRET\")) > 0 .And. SF2->(ColumnPos(\"F2_LOJARET\")) > 0) .And. !Empty(SF2->F2_CLIRET+SF2->F2_LOJARET) .And. SF2->F2_CLIRET+SF2->F2_LOJARET<>SF2->F2_CLIENTE+SF2->F2_LOJA\r\n\t\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf MsSeek(xFilial(\"SA1\")+SF2->F2_CLIRET+SF2->F2_LOJARET)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_CGC)\r\n\t\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,AllTrim(MyGetEnd(SA1->A1_COMPLEM,\"SA1\")[1]))\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_EMAIL))\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcChaveF2 := \"S\" + SF2->( F2_SERIE + F2_DOC + F2_CLIENTE + F2_LOJA )\r\n\r\n\t\t\t\t\tIf AliasIndic(\"CD9\")\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"CD9\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tif MsSeek(xFilial(\"CD9\") + cChaveF2 )\r\n\t\t\t\t\t\t\tcTpOper := CD9->CD9_TPOPER\r\n\t\t\t\t\t\tendif\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf (SF2->(FieldPos(\"F2_CLIENT\"))<>0 .And. !Empty(SF2->F2_CLIENT+SF2->F2_LOJENT) .And. (SF2->F2_CLIENT+SF2->F2_LOJENT<>SF2->F2_CLIENTE+SF2->F2_LOJA .OR. cTpOper == \"1\" )) .OR.;\r\n\t\t\t\t\t(SF2->(ColumnPos(\"F2_CLIREM\"))<>0 .And. SF2->(ColumnPos(\"F2_LOJAREM\"))<>0 .And. !Empty(SF2->F2_CLIREM + SF2->F2_LOJAREM) .And. (SF2->F2_CLIREM+SF2->F2_LOJAREM <> SF2->F2_CLIENT+SF2->F2_LOJENT .OR. cTpOper == \"1\" ))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tIf (SF2->(ColumnPos(\"F2_CLIREM\"))<>0 .AND. !Empty(SF2->F2_CLIREM + SF2->F2_LOJAREM))//verifica se existe cliente remessa preenchido\r\n\t\t\t\t\t\t\tcFiltro := xFilial(\"SA1\") + SF2->F2_CLIREM + SF2->F2_LOJAREM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcFiltro := xFilial(\"SA1\") + SF2->F2_CLIENT + SF2->F2_LOJENT\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t \r\n\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\r\n                        If MsSeek(cFiltro)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_CGC)\r\n\t\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\t\taadd(aEntrega,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\t\taadd(aEntrega,AllTrim(MyGetEnd(SA1->A1_COMPLEM,\"SA1\")[1]))\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_MUN)\r\n\t\t\t\t\t\t\taadd(aEntrega,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\t\taadd(aEntrega,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL)) \r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_EMAIL))\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t/* Se MV_NFEDEST estiver desabilitado (default .F.) permanece o legado:\r\n\t\t\t\t\ta) Para operações interestaduais (UF do emitente diferente da UF do Cliente de Entrega) e o CNPJ do Destinatario(Cliente - F2_CLIENTE)\r\n\t\t\t\t\t\tfor DIFERENTE do emitente, serão considerados os dados do CLIENTE DE ENTREGA.  \r\n\t\t\t\t\t\t- Os dados do Cliente de Entrega serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\tb) Para operações internas (UF do emitente igual a UF do Cliente de Entrega) e se o CNPJ do Destinatário(Cliente - F2_CLIENTE)\r\n\t\t\t\t\t\tfor IGUAL ao do emitente, serão considerado os dados do CLIENTE, mesmo que UFs sejam diferentes.\r\n\t\t\t\t\t\t- Os dados do Cliente serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf !lUsaCliEnt\r\n\t\t\t\t\t\tlCNPJIgual := AllTrim(SA1->A1_CGC) == Alltrim(SM0->M0_CGC)\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(AllTrim(SF2->F2_CLIENT)) .And. !Empty(AllTrim(SF2->F2_LOJENT))\t\t\t\r\n\t\t\t\t\t\t\tIf Len(aEntrega) > 0\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//Se a UF da entrega for diferente da UF do emitente (operação interestadual) e o CNPJ do destinatario for diferente do emitente, \r\n\t\t\t\t\t\t\t\t//tenho que buscar os dados do cliente de entrega para nao ocorrer \r\n\t\t\t\t\t\t\t\t//rejeicao 523 - CFOP não é de Operação Estadual e UF emitente igual à UF destinatário\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] <> IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .And. !lCNPJIgual //aEntrega[08] <> Upper(SA1->A1_EST)\r\n\t\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENT+SF2->F2_LOJENT))\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t//Se a UF de entrega for igual a UF do emitente (Operação interna) - busco os dados do cliente para montar como destinatario.\r\n\t\t\t\t\t\t\t\t//Se o CNPJ do emitente for igual ao do destinatário também levo os dados do cliente, mesmo que UFs forem diferente.\r\n\t\t\t\t\t\t\t\t//Se o cliente não for consumidor final e possuir IE, pode ocorrer a rejeição 773 - Operação Interna e UF de destino difere da UF do emitente\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] == IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .OR. lCNPJIgual\r\n\t\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tIf !Empty(cCliNota+cCliLoja)\r\n\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+cCliNota+cCliLoja))   //Busca os dados do cliente da Nota sobre Cupom para montar os dados do destinatário do XML\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t/* Se MV_NFEDEST estiver habilitado (.T.):\r\n\t\t\t\t\t\t\tA tag de destinatário - 'dest' será gerada com os dados do CLIENTE (F2_CLIENTE)\r\n\t\t\t\t\t\t\tCaso possua Cliente de Entrega (F2_CLIENT) a tag de entrega será gerada exatamente com os dados do Cliente de Entrega \r\n\t\t\t\t\t\t\tCaso possua Cliente de Retirada (F2_CLIRET) a tag de retirada será gerada exatamente com os dados do Cliente de Retirada (***FUTURA IMPLEMENTAÇÃO*** campo F2_CLIRET inexistente)\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tIf !Empty(cCliNota+cCliLoja)\r\n\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+cCliNota+cCliLoja))   //Busca os dados do cliente da Nota sobre Cupom para montar os dados do destinatário do XML\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\r\n\t\t\t\t\tIf !Empty(SA1->A1_MENSAGE)\r\n\t\t\t\t\t\tcRetForm := SA1->(Formula(A1_MENSAGE))\r\n\t\t\t\t\t\tif cRetForm <> Nil .and. !empty(cRetForm)\r\n\t\t\t\t\t\t\tIf cMVNFEMSA1==\"C\"\r\n\t\t\t\t\t\t\t\tcMensCli\t:=\tcRetForm\r\n\t\t\t\t\t\t\tElseIf cMVNFEMSA1==\"F\"\r\n\t\t\t\t\t\t\t\tcMensFis\t:=\tcRetForm\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_CGC))\r\n\t\t\t\t\taadd(aDest,SA1->A1_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t   \r\n\t\t\t\t\tIf MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0\r\n\t\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[3]) \r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(SA1->(FieldPos(\"A1_COMPLEM\")) > 0 .And. !Empty(SA1->A1_COMPLEM),AllTrim(SA1->A1_COMPLEM),MyGetEnd(SA1->A1_END,\"SA1\")[4]))\r\n\t\t\t\t\taadd(aDest,SA1->A1_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\taadd(aDest,SA1->A1_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_DDD)+SA1->A1_TEL)                                                 \t\t\t\t\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"                                                      \t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(SA1->A1_INSCRUR) .And. SA1->A1_PESSOA == \"F\" .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\"  .And. SA1->A1_EST == \"PR\"\r\n\t\t\t\t\t\t\taadd(aDest,SA1->A1_INSCRUR)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,VldIE(SA1->A1_INSCR))\r\n\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,SA1->A1_SUFRAMA)\r\n\t\t\t\t\taadd(aDest,SA1->A1_EMAIL)\r\n\t\t\t\t\taAdd(aDest,SA1->A1_CONTRIB) // Posição 17\r\n\t\t\t\t\taadd(aDest,Iif(SA1->(FieldPos(\"A1_IENCONT\")) > 0 ,SA1->A1_IENCONT,\"\"))\r\n\t\t\t\t\taadd(aDest,SA1->A1_INSCRM)\r\n\t\t\t\t\taadd(aDest,SA1->A1_TIPO)\r\n\t\t\t\t\taadd(aDest,SA1->A1_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\t//Fornecedor\r\n\t\t\t\t\tIf (SF2->(ColumnPos(\"F2_CLIRET\")) > 0 .And. SF2->(ColumnPos(\"F2_LOJARET\")) > 0) .And. !Empty(SF2->F2_CLIRET+SF2->F2_LOJARET) .And. SF2->F2_CLIRET+SF2->F2_LOJARET<>SF2->F2_CLIENTE+SF2->F2_LOJA .and. SF2->F2_TIPO == \"B\"\r\n\t\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf MsSeek(xFilial(\"SA1\")+SF2->F2_CLIRET+SF2->F2_LOJARET)\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_CGC)\r\n\t\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,AllTrim(MyGetEnd(SA1->A1_COMPLEM,\"SA1\")[1]))\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_EMAIL))\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t    dbSelectArea(\"SA2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t// Tratamento para quando existir um cliente de entrega, utilizá-lo ao invés do fornecedor (apenas por garantia)\r\n\t\t\t\t\tIf !Empty(AllTrim(SF2->F2_CLIENT)) .And. !Empty(AllTrim(SF2->F2_LOJENT))\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SF2->F2_CLIENT+SF2->F2_LOJENT)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taDest := {}\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_CGC))\r\n\t\t\t\t\taadd(aDest,SA2->A2_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t                \r\n\t\t\t\t\tIf !Empty(SA2->A2_NR_END) .Or. MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0 \r\n\t\t\t\t\t\taadd(aDest,iif(Empty(SA2->A2_NR_END),MyGetEnd(SA2->A2_END,\"SA2\")[3],SA2->A2_NR_END))\r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(SA2->(FieldPos(\"A2_COMPLEM\")) > 0 .And. !Empty(SA2->A2_COMPLEM),SA2->A2_COMPLEM,MyGetEnd(SA2->A2_END,\"SA2\")[4]))\t\t\t\t\r\n\t\t\t\t\taadd(aDest,SA2->A2_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(SA2->A2_EST))\r\n\t\t\t\t\taadd(aDest,SA2->A2_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\")))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_DDD)+SA2->A2_TEL)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\t\t\t\t\r\n\t\t\t\t\t\taadd(aDest,VldIE(SA2->A2_INSCR))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,\"\")//SA2->A2_SUFRAMA\r\n\t\t\t\t\taadd(aDest,SA2->A2_EMAIL)\t\t\t\t\t\r\n\t\t\t\t\tIf SA2->(FieldPos(\"A2_CONTRIB\"))>0\r\n\t\t\t\t\t\taAdd(aDest,SA2->A2_CONTRIB)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\r\n\t\t\t\t\tEndIf\t \r\n\t\t\t\t\taadd(aDest,\"\")// Posição 18 (referente a A1_IENCONT, sendo passado como vazio já que não existe A2_IENCONT)\r\n\t\t\t\t\taadd(aDest,SA2->A2_INSCRM)\r\n\t\t\t\t\taadd(aDest,\"\")//Posição 20\r\n\t\t\t\t\taadd(aDest,SA2->A2_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Posiciona transportador                                                 ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf !Empty(SF2->F2_TRANSP)\r\n\t\t\t\t\tdbSelectArea(\"SA4\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SA4\")+SF2->F2_TRANSP)\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aTransp,AllTrim(SA4->A4_CGC))\r\n\t\t\t\t\taadd(aTransp,SA4->A4_NOME)\r\n\t\t\t\t\tIf (SA4->A4_TPTRANS <> \"3\")\r\n\t\t\t\t\t//Conforme RICMS/MG, Anexo V Art. 2º, na emissão do documento fiscal em relação ao quadro transportador, \r\n\t\t\t\t\t//se o mesmo for o próprio remetente ou destinatário, deve-se informar a palavra Remetente ou Destinatário, \r\n\t\t\t\t\t//dispensado o preenchimento dos campos: condição de pagamento, CNPJ ou CPF do transportador, endereço, município, \r\n\t\t\t\t\t//unidade da Federação e a inscrição estadual do transportador (CHAMADO-TVMWZL).\r\n\t\t\t\t\t\tif (IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\") .and. Empty(SA4->A4_INSEST) .and. (ALLTRIM(Upper(SA4->A4_NOME)) =='REMETENTE' .OR. ALLTRIM(Upper(SA4->A4_NOME)) =='DESTINATARIO')\r\n\t\t\t\t\t\t\taadd(aTransp,VldIE(SA4->A4_INSEST,.F.))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aTransp,VldIE(SA4->A4_INSEST))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t                    aadd(aTransp,\"\")\t\t\t\t\r\n\t                EndIf    \r\n\t\t\t\t\taadd(aTransp,SA4->A4_END)\r\n\t\t\t\t\taadd(aTransp,SA4->A4_MUN)\r\n\t\t\t\t\taadd(aTransp,Upper(SA4->A4_EST)\t)\r\n\t\t\t\t\taadd(aTransp,SA4->A4_EMAIL\t)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(SF2->F2_VEICUL1)\r\n\t\t\t\t\t\tdbSelectArea(\"DA3\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"DA3\")+SF2->F2_VEICUL1)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\taadd(aVeiculo,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,iif(!Empty(cAnttRntrc),cAnttRntrc,\"\")))//RNTC\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(SF2->F2_VEICUL2)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"DA3\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"DA3\")+SF2->F2_VEICUL2)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aReboque,DA3->DA3_PLACA)\r\n\t\t\t\t\t\t\taadd(aReboque,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\t\taadd(aReboque,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,\"\")) //RNTC\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf !Empty(SF2->F2_VEICUL3)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"DA3\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"DA3\")+SF2->F2_VEICUL3)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taadd(aReboqu2,DA3->DA3_PLACA)\r\n\t\t\t\t\t\t\t\taadd(aReboqu2,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\t\t\taadd(aReboqu2,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,\"\")) //RNTC\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\tElseIf lNfCup   \r\n\t\t\t\t\t\tSL1->(dbSetOrder(2))\r\n\t\t\t\t\t\tSL1->(MsSeek(xFilial(\"SL1\")+SF2->F2_SERIE+SF2->F2_DOC))\r\n\t\t\t\t\r\n\t\t\t\t\t\taadd(aVeiculo,SL1->L1_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,SL1->L1_UFPLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,iif(!Empty(cAnttRntrc),cAnttRntrc,\"\"))  \r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf GetNewPar(\"MV_SUFRAMA\",.F.) .And. !empty(aDest[15])\r\n\t\t\t\t\tcMensFis += \"Código Suframa: \"+alltrim(aDest[15])+\".\" \r\n\t\t\t\tEndif\r\n\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t// Procura registro nos livros fiscais para tratamentos\r\n\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\r\n\t\t\t\tcChave:=\"\"\r\n\t\t\t\tIf !lNfCup\r\n\t\t\t\t\tcChave :=  xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE\r\n\t\t\t\tElse\r\n\t\t\t\t\tcChave :=  xFilial(\"SF3\")+cCliNota+cCliLoja+cNumNfCup+cSerNfCup\r\n\t\t\t\tEndif\r\n\r\n\t\t\t\tIf MsSeek(cChave)\r\n\t\t\t\t\r\n\t\t\t\t\t// Verifica se o CFOP é de venda por consignação mercantil (CFOP 5111 ou 6111)\r\n\t\t\t\t\tIf AllTrim(SF3->F3_CFO) == \"5111\" .Or. AllTrim(SF3->F3_CFO) == \"6111\" .or.  AllTrim(SF3->F3_CFO)  == '5918' .or.  AllTrim(SF3->F3_CFO)  == '6918'\r\n\t\t\t\t\t\tlConsig  := .T.\r\n\t\t\t\t\telseif ( AllTrim(SF3->F3_CFO) == \"5949\" .or. AllTrim(SF3->F3_CFO) == \"5910\" ) .and. SM0->M0_ESTENT == 'SP' /*termos do inciso II do art. 456 do RICMS/ SP  chamado THPXGS*/ \r\n\t\t\t\t\t\t//lBrinde := .T. //Retirado tratamento de brinde pois foi constatado pela consultoria tributária que nao e' possivel amarrar por CFOP.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Msg Simples Nacional\r\n\t\t\t\t\tIf lSimpNac\r\n\r\n\t\t\t\t\t\tcChave := xFilial(\"SD2\") + SFT->FT_NFISCAL + SFT->FT_SERIE + SFT->FT_CLIEFOR + SFT->FT_LOJA\r\n\r\n\t\t\t\t\t \tSD2->(MsSeek(cChave))\r\n\r\n\t\t\t\t\t\tDo While !SD2->(Eof ()) .And. cChave == SD2->(D2_FILIAL + D2_DOC + D2_SERIE + D2_CLIENTE + D2_LOJA)\r\n\t\t\t\t\t\t\tIf Empty(SD2->D2_PICM) .Or. SD2->D2_PICM == 0\r\n\t\t\t\t\t\t\t\tSD2->(DbSkip ())\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tExit\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndDo\r\n\r\n\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf SF2->F2_TIPO == \"D\"\r\n\t\t\t\t\t\t\tcMensFis += \"Documento emitido por ME ou EPP optante pelo Simples Nacional. \"\r\n\t\t\t\t\t\t\tcMensFis += \"Base de cálculo do ICMS: R$ \" + Str(SF2->F2_BASEICM, 14, 2) + \". \"\r\n\t\t\t\t\t\t\tcMensFis += \"Valor do ICMS: R$ \" + Str(SF2->F2_VALICM, 14, 2) + \". \"\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tIf SF2->F2_VALICM > 0 .And. nValSimprem > 0   // Novo Tratamento\r\n\t\t\t\t\t\t\t\tcMensFis += \"Documento emitido por ME ou EPP optante pelo Simples Nacional.\"\r\n\t\t\t\t\t\t\t\tcMensFis += \"Permite o aproveitamento do credito de ICMS no valor de R$ \" + IIf( Empty(nValSimprem),Str(SF2->F2_VALICM, 14, 2), Str(nValSimprem, 14, 2) ) + \" corresponde a aliquota de \"+str(SD2->D2_PICM,5,2)+ \"% , nos termos do art. 23 da LC 123/2006.\"\r\n\t\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\t\tcMensFis += \"Documento emitido por ME ou EPP optante pelo Simples Nacional. Nao gera direito a credito fiscal de IPI.\"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\t\t\r\n\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Volumes / Especie Nota de Saida                                         ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tcScan := \"1\"\r\n\t\t\t\tnPosCpoEsp := SF2->(ColumnPos(\"F2_ESPECI\"+cScan))\r\n\t\t\t\tnPosCpoVol := SF2->(ColumnPos(\"F2_VOLUME\"+cScan))\r\n\t\t\t\tnPosCpoMrc := 0\r\n\t\t\t\tnPosCpoNum := 0\r\n\t\t\t\tif !empty(cMRCVLMSF2)\r\n\t\t\t\t\taCpoMarVol := StrTokArr2(cMRCVLMSF2, \";\" ) \r\n\t\t\t\t\tif len(aCpoMarVol) == 2\r\n\t\t\t\t\t\tcCpoMarca := alltrim(aCpoMarVol[1])\r\n\t\t\t\t\t\tcCpoNumer := alltrim(aCpoMarVol[2])\r\n\t\t\t\t\t\tnPosCpoMrc := SF2->(ColumnPos(cCpoMarca + cScan)) \r\n\t\t\t\t\t\tnPosCpoNum := SF2->(ColumnPos(cCpoNumer + cScan))\r\n\t\t\t\t\tendif\r\n\t\t\t\tendif\r\n\r\n\t\t\t\tWhile ( !Empty(cScan) )\r\n\t\t\t\t\tcEspecie := \"\"\r\n\t\t\t\t\tnVolume := 0\r\n\t\t\t\t\tcMarca := \"\"\r\n\t\t\t\t\tcNumeracao := \"\"\r\n\r\n\t\t\t\t\tif nPosCpoEsp > 0\r\n\t\t\t\t\t\tcEspecie := upper(SF2->(FieldGet(nPosCpoEsp)))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\t\tIf !empty(cEspecie)\r\n\r\n\t\t\t\t\t\tif nPosCpoMrc > 0\r\n\t\t\t\t\t\t\tcMarca := alltrim(SF2->(FieldGet(nPosCpoMrc)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoNum > 0\r\n\t\t\t\t\t\t\tcNumeracao := alltrim(SF2->(FieldGet(nPosCpoNum)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoVol > 0\r\n\t\t\t\t\t\t\tnVolume := SF2->(FieldGet(nPosCpoVol))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tnScan := aScan(aEspVol,{|x| x[1] == cEspecie})\r\n\t\t\t\t\t\tIf ( nScan==0 .AND.cScan == \"1\" )\r\n\t\t\t\t\t\t\taadd(aEspVol,{ cEspecie, nVolume , SF2->F2_PLIQUI , SF2->F2_PBRUTO, cMarca, cNumeracao})\r\n\t\t\t\t\t\tElseIf ( nScan<>0 .AND.cScan == \"1\" )\r\n\t\t\t\t\t\t\taEspVol[nScan][2] += nVolume\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aEspVol,{ cEspecie, nVolume , 0 , 0, cMarca, cNumeracao})\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcScan := Soma1(cScan,1)\r\n\t\t\t\t\tnPosCpoEsp := SF2->(ColumnPos(\"F2_ESPECI\"+cScan))\r\n\t\t\t\t\tIf nPosCpoEsp == 0 \r\n\t\t\t\t\t\tcScan := \"\"\r\n\t\t\t\t\t\texit\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tnPosCpoVol := SF2->(ColumnPos(\"F2_VOLUME\"+cScan))\r\n\t\t\t\t\tif !empty(cCpoMarca) .and. !empty(cCpoNumer)\r\n\t\t\t\t\t\tnPosCpoMrc := SF2->(ColumnPos(cCpoMarca+cScan))\r\n\t\t\t\t\t\tnPosCpoNum := SF2->(ColumnPos(cCpoNumer+cScan))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\tEndDo\r\n\r\n\t\t\t\t//Verifica se é uma venda de origem do Venda Direta ou SIGALOJA\r\n\t\t\t\tdbSelectArea(\"SL1\")\r\n\t\t\t\tSL1->(DbSetOrder(2)) //L1_FILIAL+L1_SERIE+L1_DOC+L1_PDV\r\n\t\t\t\tlVLojaDir := SL1->(DbSeek(xFilial('SL1') + SF2->F2_SERIE + SF2->F2_DOC))\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Procura duplicatas                                                      ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf !Empty(SF2->F2_DUPL)\t.Or. lVLojaDir\r\n\t\t\t\t\t\r\n\t\t\t\t\tcFilTit := xFilial(\"SE1\")\r\n\r\n\t\t\t\t\tIf lVLojaDir\r\n\t\t\t\t\t\t//Verifica se é venda com Entrega ou Retira Posterior, pois pode ter ocorrido em outra filial.\r\n\t\t\t\t\t\tIf !Empty(SL1->L1_ORCRES)\r\n\t\t\t\t\t\t\tcFilTit := xFilial(\"SE1\",SL1->L1_FILRES)\r\n\t\t\t\t\t\t\tSL1->(DbSetOrder(1)) //L1_FILIAL + L1_NUM\r\n\t\t\t\t\t\t\t//Posiciona no Orçamento Pai\r\n\t\t\t\t\t\t\tSL1->(DbSeek(xFilial(\"SL1\",SL1->L1_FILRES)+SL1->L1_ORCRES))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tcPrfTit\t\t:= If(Empty(SL1->L1_SERIE),SL1->L1_SERPED,SL1->L1_SERIE)\r\n\t\t\t\t\t\tcNumTit \t:= LJ7NumTit()\r\n\t\t\t\t\t\tcNumDupl \t:= cNumTit\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcPrfTit \t:= SF2->F2_PREFIXO\r\n\t\t\t\t\t\tcNumTit \t:= SF2->F2_DOC\r\n\t\t\t\t\t\tcNumDupl \t:= SF2->F2_DUPL\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcChaveSE1 := cFilTit + cPrfTit + cNumTit\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SED\")\r\n\t\t\t\t\taOrdSED := SED->(getArea())\r\n\t\t\t\t\tSED->(dbSetOrder(1))\r\n\t\t\t\t\tcLJTPNFE := (StrTran(cMV_LJTPNFE,\",\",\" ','\"))+\" \"\r\n\t\t\t\t\tcWhere := cLJTPNFE\r\n\t\t\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\t\t\tSE1->(dbSetOrder(1))\r\n\t\t\t\t\t#IFDEF TOP\r\n\t\t\t\t\t\tlQuery  := .T.\r\n\t\t\t\t\t\tcAliasSE1 := GetNextAlias()\r\n\t\t\t\t\t\tBeginSql Alias cAliasSE1\r\n\t\t\t\t\t\t\tCOLUMN E1_VENCORI AS DATE\r\n\t\t\t\t\t\t\tSELECT E1_FILIAL,E1_PREFIXO,E1_NUM,E1_PARCELA,E1_TIPO,E1_VENCORI,E1_VALOR,E1_VLCRUZ,E1_ORIGEM,E1_PIS,E1_COFINS,E1_CSLL,E1_INSS,E1_VLRREAL,E1_IRRF,E1_ISS,E1_NATUREZ\r\n\t\t\t\t\t\t\tFROM %Table:SE1% SE1\r\n\t\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\tSE1.E1_FILIAL = %Exp:cFilTit% AND\r\n\t\t\t\t\t\t\tSE1.E1_PREFIXO = %Exp:cPrfTit% AND \r\n\t\t\t\t\t\t\tSE1.E1_NUM = %Exp:cNumDupl% AND \r\n\t\t\t\t\t\t\t((SE1.E1_TIPO = %Exp:MVNOTAFIS%) OR (SE1.E1_TIPO = 'DP ' ) OR\r\n\t\t\t\t\t\t\t ((SE1.E1_ORIGEM IN ('LOJA701','FATA701','LOJA010')) AND SE1.E1_TIPO IN (%Exp:cWhere%))) AND\r\n\t\t\t\t\t\t\tSE1.%NotDel%\r\n\t\t\t\t\t\t\tORDER BY %Order:SE1%\r\n\t\t\t\t\t\tEndSql\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t#ELSE\r\n\t\t\t\t\t\tcChaveSE1 := cFilTit + SF2->F2_PREFIXO + SF2->F2_DOC\r\n\t\t\t\t\t\tSE1->(MsSeek(cChaveSE1))\r\n\t\t\t\t\t#ENDIF\r\n\t\t\t\t\tWhile (cAliasSE1)->(!Eof()) .And. (cAliasSE1)->E1_FILIAL+(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM == cChaveSE1\r\n\t\t\t\t\t\t\tIf empty(cNatFin) .Or. !(cNatFin == (cAliasSE1)->E1_NATUREZ)\r\n\t\t\t\t\t\t\t\tcNatFin := (cAliasSE1)->E1_NATUREZ\r\n\t\t\t\t\t\t\t\tSED->(dbSeek( xfilial(\"SED\") + cNatFin))\r\n\t\t\t\t\t\t\t\tcED_DEDINSS := alltrim(SED->ED_DEDINSS)\r\n\t\t\t\t\t\t\t\tcED_RECFUN := alltrim(SED->ED_RECFUN)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf (cAliasSE1)->E1_TIPO = MVNOTAFIS .OR. (cAliasSE1)->E1_TIPO = 'DP' .OR. ((Alltrim((cAliasSE1)->E1_ORIGEM) $ 'LOJA701|FATA701|LOJA010') .AND. (cAliasSE1)->E1_TIPO $ cWhere)\r\n\t\t\t\t\t\t\t\t//Aletrado a busca do valor da Fatura do campo E1_VLCURZ para E1_VLRREAL, \r\n\t\t\t\t\t\t\t\t//devido a titulos com desconto da TAXA do Cartão de Créito que não devem\r\n\t\t\t\t\t\t\t\t//ser repassados para o XML e DANFE.                                                                                    \r\n\t\t\t\t\t\t\t\tnValDupl := IIF((cAliasSE1)->E1_VLRREAL > 0,(cAliasSE1)->E1_VLRREAL,(cAliasSE1)->E1_VLCRUZ)\r\n\t\t\t\t\t\t\t\tIf cValLiqB == \"2\" // 1 Baixa - 2 Emissao\r\n\t\t\t\t\t\t\t\t\tIf Alltrim(SM0->M0_PRODRUR) $ \"1|2|F|J\" .And.;\r\n\t\t\t\t\t\t\t\t\t\t(Alltrim(SM0->M0_PRODRUR) $ \"2|J\" .Or. ;\r\n\t\t\t\t\t\t\t\t\t\t(Alltrim(SM0->M0_PRODRUR) $ \"1|F\" .And. ( Alltrim(SA1->A1_PESSOA) == \"F\" .or. ( (cED_DEDINSS == \"2\" .and. cED_RECFUN == \"2\") .or. Alltrim(SA1->A1_RECINSS) == \"S\"))))\r\n\t\t\t\t\t\t\t\t\t\taadd(aDupl,{(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM+(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_VENCORI;\r\n\t\t\t\t\t\t\t\t\t\t,(nValDupl-(cAliasSE1)->E1_PIS-(cAliasSE1)->E1_COFINS-(cAliasSE1)->E1_CSLL)-(cAliasSE1)->E1_IRRF- IIF(!lRuleDescISS, (cAliasSE1)->E1_ISS, 0)})\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taadd(aDupl,{(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM+(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_VENCORI;\r\n\t\t\t\t\t\t\t\t\t\t,(nValDupl-(cAliasSE1)->E1_PIS-(cAliasSE1)->E1_COFINS-(cAliasSE1)->E1_CSLL-(cAliasSE1)->E1_INSS)-(cAliasSE1)->E1_IRRF- IIF(!lRuleDescISS, (cAliasSE1)->E1_ISS, 0)})\t\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t  \r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\taadd(aDupl,{(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM+(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_VENCORI,nValDupl})\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tdbSelectArea(cAliasSE1)\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t    EndDo\r\n\t\t\t\t    If lQuery\r\n\t\t\t\t    \tdbSelectArea(cAliasSE1)\r\n\t\t\t\t    \tdbCloseArea()\r\n\t\t\t\t    \tdbSelectArea(\"SE1\")\r\n\t\t\t\t    EndIf\r\n\t\t\t\t\tRestArea(aOrdSED)\r\n\t\t\t\tElse\r\n\t\t\t\t\taDupl := {}\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Analisa os impostos de retencao                                         ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t//Tratamento para notas sobre cupom(Incluir demais estados conforme conforme legislacao).\r\n\t\t\t\t//A Nota Fiscal  deve ser toda preenchida, sendo a sua escrituração feita com valores zerados, já que o débito será feito pelo cupom\r\n\t\t\t\t//Assim, no livro Registro de Saídas deve ser registrado para esta nota apenas a coluna \"Observações\", onde serão indicados o seu número e a sua série.\r\n\t\t\t\t//Fundamento: artigo 135, § 2º, do RICMS/2000.\t\t  \t\r\n\t\t\t\t//Fundamento: Decreto nº 29.907/2009 , art. 36 , §§ 9º e 10º; RICMS-CE/1997 , art. 731-E1\t\r\n\t\t\t\t//Fundamento: Portaria SEFP nº 799, de 30.12.1997 - DO DF de 31.12.1997\r\n\t\t\t\tIf lNfCup .And. SM0->M0_ESTCOB $ \"CE/DF\" \r\n\t\t\t\t\tlNfCupZero\t:= .T.\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\tDbSelectArea( \"SF2\" )\r\n\t\t\t\t\tDbSetOrder(1)  // F2_DOC + F2_SERIE + F2_CLIENTE + F2_LOJA\r\n\t\t\t\t\tDbSeek( xFilial(\"SF2\") + cNumNfCup + cSerNfCup)\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALPIS\"))<>0 .and. SF2->F2_VALPIS>0\r\n\t\t\t\t\taadd(aRetido,{\"PIS\",0,SF2->F2_VALPIS})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALCOFI\"))<>0 .and. SF2->F2_VALCOFI>0\r\n\t\t\t\t\taadd(aRetido,{\"COFINS\",0,SF2->F2_VALCOFI})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALCSLL\"))<>0 .and. SF2->F2_VALCSLL>0\r\n\t\t\t\t\taadd(aRetido,{\"CSLL\",0,SF2->F2_VALCSLL})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALIRRF\"))<>0 .and. SF2->F2_VALIRRF>0\r\n\t\t\t\t\taadd(aRetido,{\"IRRF\",SF2->F2_BASEIRR,SF2->F2_VALIRRF})\r\n\t\t\t\tEndIf\t\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALINSS\"))<>0 .and. SF2->F2_VALINSS>0\r\n\t\t\t\t\taadd(aRetido,{\"INSS\",SF2->F2_BASEINS,SF2->F2_VALINSS})\r\n\t\t\t\tEndIf  \r\n\t\t\t\t\r\n\t\t\t\t// Total Carga Tributária \r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTIMP\"))<>0 .and. SF2->F2_TOTIMP>0\r\n\t\t\t\t\tnTotalCrg := SF2->F2_TOTIMP\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//----------------------------------------------\r\n\t\t\t\t// Total Carga Tributária por Ente Tributante\r\n\t\t\t\t//----------------------------------------------\r\n\t\t\t\t\r\n\t\t\t\t// Ente Federal\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTFED\"))<>0 .and. SF2->F2_TOTFED>0\r\n\t\t\t\t\tnTotFedCrg := SF2->F2_TOTFED\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t// Ente Estadual\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTEST\"))<>0 .and. SF2->F2_TOTEST>0\r\n\t\t\t\t\tnTotEstCrg := SF2->F2_TOTEST\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t// Ente Municipal\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTMUN\"))<>0 .and. SF2->F2_TOTMUN>0\r\n\t\t\t\t\tnTotMunCrg := SF2->F2_TOTMUN\r\n\t\t\t\tEndIf\t\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//RECOPI\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_IDRECOP\")) > 0 .and. !Empty(SF2->F2_IDRECOP)\r\n\t\t\t\t\tcIdRecopi := SF2->F2_IDRECOP\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf !Empty(cIdRecopi)\r\n\t\t\t\t\tIf AliasIndic(\"CE3\")\r\n\t\t\t\t\t\tCE3->(DbSetOrder(1))\r\n\t\t\t\t\t\tIf CE3->(DbSeek(xFilial(\"CE3\")+Alltrim(cIdRecopi)))\r\n\t\t\t\t\t\t\tcNumRecopi:= IIf(CE3->(FieldPos(\"CE3_RECOPI\")) > 0, Alltrim(CE3->CE3_RECOPI), \"\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//////INCLUSAO DE CAMPOS NA QUERY////////////\r\n\t\t\t\t\r\n\t\t\t\tcField := \"%\"\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_DESCZFC\"))<>0 .AND. SD2->(FieldPos(\"D2_DESCZFP\"))<>0\r\n\t\t\t\t\tcField += \",D2_DESCZFC,D2_DESCZFP\" \t\t\t\t\t\t\r\n\t\t\t\tEndIf     \r\n\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_NFCUP\"))<>0\r\n\t\t\t\t   cField  +=\",D2_NFCUP\"\r\n\t\t\t\tEndIF   \r\n\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_DESCICM\"))<>0\r\n\t\t\t\t   cField  +=\",D2_DESCICM\"\t\t\t\t\t\t    \r\n\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_FCICOD\"))<>0\r\n\t\t\t\t   cField  +=\",D2_FCICOD\"\t\t\t\t\t\t    \r\n\t\t\t\tEndIF\r\n\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_VLIMPOR\"))<>0\r\n\t\t\t\t   cField  +=\",D2_VLIMPOR\"\t\t\t\t    \r\n\t\t\t\tEndIF\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTIMP\"))<>0\r\n\t\t\t\t   cField  +=\",D2_TOTIMP\"\t\t\t\t    \r\n\t\t\t\tEndIf\t\t\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTFED\"))<>0\t// Ente Tributante Federal\r\n\t\t\t\t   cField  +=\",D2_TOTFED\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTEST\"))<>0\t// Ente Tributante Estadual\r\n\t\t\t\t   cField  +=\",D2_TOTEST\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTMUN\"))<>0\t// Ente Tributante Municipal\r\n\t\t\t\t   cField  +=\",D2_TOTMUN\"\t\t\t\t    \r\n\t\t\t\tEndIf\t \r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_GRPCST\"))<>0 //Grupo de tributação de ipi\r\n\t\t\t\t   cField  +=\",D2_GRPCST\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_VRDICMS\"))<>0\r\n\t\t\t\t   cField  +=\",D2_VRDICMS\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tcField += \"%\"\r\n\t\t\t\t\r\n\t\t\t\t//////////////////////////////////////////////\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf lNfCupZero\r\n\t\t\t\t\tRestArea(aAreaSF2)\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Pesquisa itens de nota                                                  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t#IFDEF TOP\r\n\t\t\t\t\tlQuery  := .T.\r\n\t\t\t\t\tcAliasSD2 := GetNextAlias()\r\n\t\t\t\t\t//Verifica se existe Template DCL\r\n\t      \t\t\tIF cVerAmb >= \"4.00\" .And. (ExistTemplate(\"PROCMSG\")) //Tratativa para Grupo de Repasse de Combustiveis\r\n\t\t\t\t\t\tBeginSql Alias cAliasSD2\r\n\t\t\t\t\t\t\t\tSELECT D2_FILIAL,D2_SERIE,D2_DOC,D2_CLIENTE,D2_LOJA,D2_COD,D2_TES,D2_NFORI,D2_SERIORI,D2_ITEMORI,D2_TIPO,D2_ITEM,D2_CF,\r\n\t\t\t\t\t\t\t\tD2_QUANT,D2_TOTAL,D2_DESCON,D2_VALFRE,D2_SEGURO,D2_PEDIDO,D2_ITEMPV,D2_DESPESA,D2_VALBRUT,D2_VALISS,D2_PRUNIT,\r\n\t\t\t\t\t\t\t\tD2_CLASFIS,D2_PRCVEN,D2_IDENTB6,D2_CODISS,D2_DESCZFR,D2_PREEMB,D2_DESCZFC,D2_DESCZFP,D2_LOTECTL,D2_NUMLOTE,D2_ICMSRET,D2_VALPS3,\r\n\t\t\t\t\t\t\t\tD2_ORIGLAN,D2_VALCF3,D2_VALIPI,D2_VALACRS,D2_PICM,D2_PDV,D2_BRICMSO,D2_ICMRETO,D2_BRICMSD,D2_ICMRETD %Exp:cField% \r\n\t\t\t\t\t\t\t\tFROM %Table:SD2% SD2\r\n\t\t\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\t\tSD2.D2_FILIAL  = %xFilial:SD2% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_SERIE   = %Exp:SF2->F2_SERIE% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_DOC     = %Exp:SF2->F2_DOC% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_CLIENTE = %Exp:SF2->F2_CLIENTE% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_LOJA    = %Exp:SF2->F2_LOJA% AND\r\n\t\t\t\t\t\t\t\tSD2.%NotDel%\r\n\t\t\t\t\t\t\t\tORDER BY D2_FILIAL,D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA,D2_ITEM,D2_COD\r\n\t\t\t\t\t\tEndSql\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tBeginSql Alias cAliasSD2\r\n\t\t\t\t\t\t\tSELECT D2_FILIAL,D2_SERIE,D2_DOC,D2_CLIENTE,D2_LOJA,D2_COD,D2_TES,D2_NFORI,D2_SERIORI,D2_ITEMORI,D2_TIPO,D2_ITEM,D2_CF,\r\n\t\t\t\t\t\t\tD2_QUANT,D2_TOTAL,D2_DESCON,D2_VALFRE,D2_SEGURO,D2_PEDIDO,D2_ITEMPV,D2_DESPESA,D2_VALBRUT,D2_VALISS,D2_PRUNIT,\r\n\t\t\t\t\t\t\tD2_CLASFIS,D2_PRCVEN,D2_IDENTB6,D2_CODISS,D2_DESCZFR,D2_PREEMB,D2_DESCZFC,D2_DESCZFP,D2_LOTECTL,D2_NUMLOTE,D2_ICMSRET,D2_VALPS3,\r\n\t\t\t\t\t\t\tD2_ORIGLAN,D2_VALCF3,D2_VALIPI,D2_VALACRS,D2_PICM,D2_PDV %Exp:cField% \r\n\t\t\t\t\t\t\tFROM %Table:SD2% SD2\r\n\t\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\tSD2.D2_FILIAL  = %xFilial:SD2% AND\r\n\t\t\t\t\t\t\tSD2.D2_SERIE   = %Exp:SF2->F2_SERIE% AND\r\n\t\t\t\t\t\t\tSD2.D2_DOC     = %Exp:SF2->F2_DOC% AND\r\n\t\t\t\t\t\t\tSD2.D2_CLIENTE = %Exp:SF2->F2_CLIENTE% AND\r\n\t\t\t\t\t\t\tSD2.D2_LOJA    = %Exp:SF2->F2_LOJA% AND\r\n\t\t\t\t\t\t\tSD2.%NotDel%\r\n\t\t\t\t\t\t\tORDER BY D2_FILIAL,D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA,D2_ITEM,D2_COD\r\n\t\t\t\t\t\tEndSql\r\n\r\n\t\t\t\t\tEndIf\t\r\n\t\r\n\t\t\t\t#ELSE\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tlLjDescIt\t:= .F.\t// Inicializa as variaveis que serao utilizadas para desconto \r\n\t\t\t\tlFirstItem \t:= .T.\r\n\t\t\t\tnCount\t\t:= 0\r\n\t\t\t\tlVLojaDir\t:= .F. //Verifica se tem item de venda de origem Venda Direta, Sigaloja ou Nota Sobre Cupom\r\n\t\t\t\tnCountIT := 0\r\n\t\t\t\tWhile !Eof() .And. xFilial(\"SD2\") == (cAliasSD2)->D2_FILIAL .And.;\r\n\t\t\t\t\tSF2->F2_SERIE == (cAliasSD2)->D2_SERIE .And.;\r\n\t\t\t\t\tSF2->F2_DOC == (cAliasSD2)->D2_DOC\r\n\t\t\t\t\t\r\n\t\t\t\t\tlContinua := .T.\r\n\t\t\t\t\t\r\n\t\t\t\t\tnCount++\r\n\t\t\t\t\t//Se for nota sobre cupom, pega somente os itens do cupom que estão na nota sobre cupom.\t\t\t\t\r\n\t\t\t\t\tIf SD2->(FieldPos(\"D2_NFCUP\")) <> 0 .And. !Empty( (cAliasSD2)->D2_NFCUP )\r\n\t\t\t\t\t\tIf lNfCup .And. !( cSerNfCup + cNumNfCup  == SubStr((cAliasSD2)->D2_SERIORI,1,TamSx3(\"F2_SERIE\")[1]) + SubStr((cAliasSD2)->D2_NFCUP,1,TamSx3(\"F2_DOC\")[1]) )\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tlContinua := .F.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tendIf\r\n\t\t\t\t\tEndif\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf (cAliasSD2)->D2_TIPO == \"D\" .And. SM0->M0_ESTENT == \"PR\" .And. (cAliasSD2)->D2_ICMSRET > 0\r\n\t\t\t\t\t\t/* Tratamento para com base na legislação do Estado do Paraná Decreto n 6.080/2012 - DOE PR Suplemento  \r\n\t\t\t\t\t\te para atender a ICMS/PR 2017 (Decreto 7.871/2017) Art. 9, Seção I, Anexo IX \r\n\t\t\t\t\t\tque não prevê o destaque do ICMS no campo específico (tanto o da operação própria do substituto quanto do \r\n\t\t\t\t\t\tretido por substituição tributária) ISSUE DSERTSS1-5542. */\t\t\t\t\t\t\r\n\t\t\t\t\t\tlIcmSTDev\t:= .F.\r\n\t\t\t\t\t\tlIcmDevol\t:= .F.\t\t\t\t\t\t\r\n\t\t\t\t\t\tlIcmsPR\t:= .T.\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tlIcmSTDev\t:= lIcmSTDevOri\r\n\t\t\t\t\t\tlIcmDevol\t:= lIcmDevolOri\t\r\n\t\t\t\t\t\tlIcmsPR\t:= .F.\r\n\t\t\t\t\tendif\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf lGE .and. lNfCup \r\n\t\t\t\t\t\tDbSelectArea(\"SB1\")\r\n\t\t\t\t\t\taSb1 := SB1->(GetArea())\r\n\t\t\t\t\t\tDbSetOrder(1) // B1_FILIAL+B1_COD\r\n\t\t\t\t\t\tIf DbSeek(xFilial(\"SB1\")+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\tIf SB1->B1_TIPO == cTpGar \t\r\n\t\t\t\t\t\t\t\tlContinua := .F.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tRestArea(aSb1)\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf lContinua\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Verifica a natureza da operacao                                         ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf lNfCup\r\n\t\t\t\t\t\t\taAreaSD2  \t:= SD2->(GetArea())\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Pesquisa itens de nota                                                  ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\t\t\t\t\t\t\tIf Val((cAliasSD2)->D2_ITEMORI)== 0\r\n\t\t\t\t\t\t\t   cNumitem := (cAliasSD2)->D2_ITEM\r\n\t\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\t   cNumitem := (cAliasSD2)->D2_ITEMORI\r\n\t\t\t\t\t\t\tEnd\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t/*Ajuste para buscar a TES do cupom fiscal*/\r\n\t\t\t\t\t\t\tDbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\tDbSetOrder(3)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf Dbseek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\t\t\tcD2Tes\t:= SD2->D2_TES\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf DbSeek(xFilial(\"SD2\")+cNumNfCup+cSerNfCup+cCliNota+cCliLoja+(cAliasSD2)->D2_COD+cNumitem)\r\n\t\t\t\t\t\t\t\tcD2Cfop := SD2->D2_CF\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tlChave:=.T.\r\n\t\t\t\t\t\t\t\tcChCupom := \"S\"+cSerNfCup+cNumNfCup+cCliNota+cCliLoja+cNumitem\r\n\t\t\t\t\t\t\t\tcD2TesNF := SD2->D2_TES\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tRestArea(aAreaSD2)\r\n\t\t\t\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t\t    \t//|                                                             ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf Alltrim(SF2->F2_ESPECIE) == \"NFCE\" .OR. Alltrim(SF2->F2_ESPECIE) == \"SATCE\"\r\n\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF2->F2_EMISSAO, SF2->F2_SERIE, SF2->F2_DOC, SM0->M0_CGC, SM0->M0_ESTCOB, SF2->F2_ESPECIE, SF2->F2_CHVNFE,0,\"\",\"\",0,\"\",\"\" })\r\n\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aRefECF,{SD2->D2_DOC,SF2->F2_ESPECIE,SF2->F2_PDV})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Quando nao for cupom fiscal,\t\t\t\t\t\t\t³\r\n\t\t\t\t\t\t\t//³\to CFOP deve ser atualizado com o CFOP de cada ITEM, |\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t \r\n\t\t\t\t\t\t\tcD2Cfop := (cAliasSD2)->D2_CF\r\n\t\t\t\t\t\t\tcD2Tes\t:= (cAliasSD2)->D2_TES\r\n\t\t\t\t\t\t\tlChave:=.F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcChaveD2 := \"S\" + ( cAliasSD2 )->( D2_SERIE + D2_DOC + D2_CLIENTE + D2_LOJA + D2_ITEM )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+cD2Tes)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças\r\n\t\t\t\t\t\tIf lCpoCusEnt .And. cMVEstado == \"PE\" .And. SF4->F4_CUSENTR ==\"1\"\r\n\t\t\t\t\t\t\tlCustoEntr := .T.\r\n\t\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\t\tIf SF4->F4_AGRPIS = \"1\"\r\n\t\t\t\t\t\t\taAdd(aAgrPis,{.T.,0})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taAdd(aAgrPis,{.F.,0})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf SF4->F4_AGRCOF = \"1\"\r\n\t\t\t\t\t\t\taAdd(aAgrCofins,{.T.,0})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taAdd(aAgrCofins,{.F.,0})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcChave:=\"\"\r\n\t\t\t\t\t\tIf !lChave\r\n\t\t\t\t\t\t\tcChave :=  cChaveD2   \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcChave :=  cChCupom\r\n\t\t\t\t\t\tEndif\r\n\t\r\n\t          // Posiciono na TES do cupom fiscal para pegar a natureza de operação da nf sobre cupom\r\n\t\t\t\t\t\t/*Necessario para imprimir a natureza de operação do cupom fiscal emitido em ECF*/\r\n\t\t\t\t\t\tIf lNfCup .And. !Empty(cD2TesNF)\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+cD2TesNF)\r\n\t\t\t\t\t\tEndIf              \r\n\t                  \r\n\t\t\t\t\t\tSFT->( dbSetOrder( 1 ) )\r\n\t\t\t\t\t\t//utiliza a funcao SpedNatOper ( SPEDXFUN ) que possui o tratamento para a natureza da operacao/prestacao\r\n\t\t\t\t\t\tif FindFunction( \"SpedNatOper\" ) .And. SFT->( MsSeek( xFilial( \"SFT\" ) +cChave) )\r\n\t\t\t\t\t\t\tIf !Alltrim(SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ])$cNatOper\r\n\t\t\t\t\t\t  \t\tIf\tEmpty(cNatOper)\r\n\t\t\t\t\t\t     \t\tcNatOper := SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\t  \t\tElse\r\n\t\t\t\t\t\t      \t\tcNatOper := cNatOper + \"/ \" +SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\t  \t\tEndif\r\n\t\t\t\t\t\t   Endif\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tIf !lNatOper\r\n\t\t\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\t\t\tcNatOper := Alltrim(SF4->F4_TEXTO)\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tcNatOper += Iif(!Alltrim(SF4->F4_TEXTO)$cNatOper,\"/ \" + SF4->F4_TEXTO,\"\")\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\tElse\t\t\t\t   \t\r\n\t\t\t\t\t\t\t\taSX513 \t := FwGetSX5(\"13\",SF4->F4_CF)\r\n\t\t\t\t\t\t\t\tIf len(aSX513) > 0\r\n\t\t\t\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\t\t\t\tcNatOper := AllTrim(SubStr(aSX513[1][4],1,55))\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tcNatOper += Iif(!AllTrim(SubStr(aSX513[1][4],1,55)) $ cNatOper, \"/ \" + AllTrim(SubStr(aSX513[1][4],1,55)), \"\")\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t    \t\tEndIf\r\n\t\t\t\t    \tendif\r\n\t\t\t    \t\t\r\n\t\t\t    \t\t// Posiciono na TES da NF Sobre Cupom novamente\r\n\t\t\t\t\t\t/*Necessario para posicionar noo SF4 referente a nota sobre cupom*/\r\n\t\t\t\t\t\tIf lNfCup\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+cD2Tes)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t    \t\tIf SF4->(FieldPos(\"F4_BASEICM\"))>0\r\n\t\t\t    \t\t\tnRedBC := IiF(SF4->F4_BASEICM>0,IiF(SF4->F4_BASEICM == 100,SF4->F4_BASEICM,IiF(SF4->F4_BASEICM > 100,0,100-SF4->F4_BASEICM)),SF4->F4_BASEICM)\r\n\t\t\t    \t\t\tcCST   := SF4->F4_SITTRIB \r\n\t\t\t    \t\tEndif\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Verifica as notas vinculadas                                            ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_NFORI)\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_TIPO $ \"DBN\"\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tIf\t( MsSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD+PADL(alltrim((cAliasSD2)->D2_ITEMORI),TamSx3(\"D2_ITEMORI\")[1],\"0\")) ) .OR. ;\r\n\t\t\t\t\t\t\t\t\t( MsSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA) .And. Empty(cMVREFNFE) )  .Or. ;\r\n\t\t\t\t\t\t\t\t\tPosiTriang(cAliasSD2)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//Posiciona SD1 de acordo com o D1_NUMSEQ caso tenha referencia de poder de terceiro.\r\n\t\t\t\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_IDENTB6)    \t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tnSD1Pos := SD1->(Recno())\t\t\t\t\t\t\t\t\t\t\t\t\t    \t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_IDENTB6)\r\n\t\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\t\tSD1->(DbGoTo(nSD1Pos))\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_TIPO)\r\n\t\t\t\t\t\t\t\t\tIf SD1->D1_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Obtem os dados de nota fiscal de produtor rural referenciada                                  ³\r\n\t\t\t\t\t\t\t\t\t//³Temos duas situacoes:                                                                         ³\r\n\t\t\t\t\t\t\t\t\t//³A NF de saída é uma devolucao, onde a NF original pode ser ou nao uma devolução.              ³\r\n\t\t\t\t\t\t\t\t\t//³1) Quando a NF original for uma devolucao, devemos utilizar o remetente do documento fiscal,  ³\r\n\t\t\t\t\t\t\t\t\t//³    podendo ser o sigamat.emp no caso de formulario proprio ou o proprio SA1 no caso de nf de ³\r\n\t\t\t\t\t\t\t\t\t//³    entrada com formulario proprio igual a NAO.                                               ³\r\n\t\t\t\t\t\t\t\t\t//³2) Quando a NF original NAO for uma devolucao, neste caso tambem pode variar conforme o       ³\r\n\t\t\t\t\t\t\t\t\t//³    formulario proprio igual a SIM ou NAO. No caso do NAO, os dados a serem obtidos retornara ³\r\n\t\t\t\t\t\t\t\t\t//³    da tabela SA2.                                                                            ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf AllTrim(SF1->F1_ESPECIE)==\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t//para nota de entrada tipo devolucao o emitente eh o cliente ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\t\t\t\tIf SD1->D1_TIPO$\"DB\"\r\n\t\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA1->A1_CGC),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA1->A1_EST),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA1->A1_INSCR)})\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t//para nota de entrada normal o emitente eh o fornecedor ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA2->A2_CGC),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA2->A2_EST),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA2->A2_INSCR)})\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\t//Informacoes do cupom fiscal referenciado\r\n\t\t\t\t\t\t\t\t\tIf AllTrim(SF1->F1_ESPECIE)==\"CF\"\r\n\t\t\t\t\t\t\t\t\t\taadd(aRefECF,{SD1->D1_DOC,SF1->F1_ESPECIE,\"\"})\r\n\t\t\t\t\t\t\t\t\tEndif  \r\n\t\t\t\t\t\t\t\t\t//Outros documentos referenciados\r\n\t\t\t\t\t\t\t\t\tif AllTrim(SF1->F1_ESPECIE)<>\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t//Documento de Estorno - Tipo Devolucao e F4_AJUSTE=\"S\"\r\n\t\t\t\t\t\t\t\t\t\t//identifica que se trata de nf de estorno.\r\n\t\t\t\t\t\t\t\t\t\tIf ( ( cAliasSD2 )->D2_COD == SD1->D1_COD .AND. SF4->F4_AJUSTE == \"S\" )\t\r\n\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SD1->D1_EMISSAO, SD1->D1_SERIE , SD1->D1_DOC, iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ), SM0->M0_ESTCOB, SF1->F1_ESPECIE, SF1->F1_CHVNFE, SD1->D1_TOTAL-SD1->D1_DESC, \"\", SF1->F1_TIPO, iif(SD1->D1_TIPO $ \"DB\",1,2), SD1->D1_FORNECE, SD1->D1_LOJA })\r\n\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tnCountIT += 1\r\n\t\t\t\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF1->F1_CHVNFE, SF1->F1_VALBRUT})\r\n\r\n\t\t\t\t\t\t\t\t\t\tElseif cChave <> dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE;\r\n\t\t\t\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SD1->D1_EMISSAO, SD1->D1_SERIE, SD1->D1_DOC, iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ), SM0->M0_ESTCOB, SF1->F1_ESPECIE, SF1->F1_CHVNFE,SD1->D1_TOTAL-SD1->D1_DESC,\"\",SF1->F1_TIPO, iif(SD1->D1_TIPO $ \"DB\",1,2), SD1->D1_FORNECE, SD1->D1_LOJA })\r\n\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\tnCountIT += 1\r\n\t\t\t\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF1->F1_CHVNFE, SF1->F1_VALBRUT})\r\n\t\t\t\t\t\t\t\t\t\tendIf\t\r\n\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\r\n\t\t\t\t\t\t\t\t\tendIf\t\r\n\t\t\t\t\t\t\t\tElseIf (cAliasSD2)->D2_TIPO == \"N\"                                                     \t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t   \t\tdbSetOrder(4)     \r\n\t\t\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SFT\")+\"S\"+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_NFORI)\r\n\t\t\t\t\t\t\t\t\t\tIf SFT->FT_ESTADO == \"EX\" .or. ((SubStr(SM0->M0_CODMUN,1,2) == \"35\" .Or. SubStr(SM0->M0_CODMUN,1,2) == \"29\") .and. \"REMESSA POR CONTA E ORDEM DE TERCEIROS\" $ Upper(cNatOper) .and. lOrgaoPub )//(Venda para orgao publico - SP/BA/CFOP Remessa por conta e ordem de terceiros (cfop 5923/6923)- ch:TIDWCY   \r\n\t\t\t\t\t\t\t\t\t\t\t//Se venda para orgao publico, vincula NFe do tipo Normal de faturamento\r\n\t\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\t\t\t   \t\tdbSetOrder(4) \r\n\t\t\t\t\t\t\t\t\t   \t\tMsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE) \r\n\t\t\t\t\t\t\t\t\t\t\tif cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA1->A1_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tElseIf Alltrim(SFT->FT_CFOP) $ cMVREFNFE\r\n\t\t\t\t\t\t\t\t\t\t\t//Tratamento para que leve na TAG <refNFe> as notas referenciadas que contém o CFOP no parâmetro MV_REFNFE\r\n\t\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\t\t\t   \t\tdbSetOrder(4) \r\n\t\t\t\t\t\t\t\t\t   \t\tIf (MsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE))\r\n\t\t\t\t\t\t\t\t\t\t   \t\tIf cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA1->A1_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\t\t\t\t\t\t\t\t\t\t\t\r\n\t                                                lVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\r\n\t\t\t\t\t\t\t\t\t\t   \tEndif\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\t\t\t   \t\tdbSetOrder(4) \r\n\t\t\t\t\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE)\t\t\t\t\t\t\t\t\t\t   \t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t//Obtem os dados de nota fiscal de produtor rural referenciada\r\n\t\t\t\t\t\t\t\t\t\t\t\t//A NF de saída Para este tipo de nota, o emitente eh sempre o sigamat.emp\r\n\t\t\t\t\t\t\t\t\t\t\t\tIf AllTrim(SF3->F3_ESPECIE)==\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//para nota de saida normal o emitente eh o sigamat\r\n\t\t\t\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SF3->F3_EMISSAO,SF3->F3_SERIE,SF3->F3_NFISCAL,SF3->F3_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tSM0->M0_CGC,SM0->M0_ESTENT,SM0->M0_INSC})\r\n\t\t\t\t\t\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\t   \t\t\t\t\tIf cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t\t\t\t   \t\t\t\t\t\t.or. (cAliasSD2)->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t   \t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA1->A1_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE ,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tendIf \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taOldReg  := SD2->(GetArea())\r\n\t\t\t\t\t\t\t\taOldReg2 := SF2->(GetArea())\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\t\t\t//Alterado a chave de busca completa devido ao procedimento de complemento de notas de devolucao de compras. FNC -> 00000008125/2011.\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//If MsSeek(xFilial(\"SD2\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD+(cAliasSD2)->D2_ITEMORI)\r\n\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SD2\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI)//+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD+(cAliasSD2)->D2_ITEMORI)\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SF2\")+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\tIf !SD2->D2_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\t\tlComplDev := .T.\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t//Obtem os dados de nota fiscal de produtor rural referenciada\r\n\t\t\t\t\t\t\t\t\t//A NF de saída NAO EH uma devolucao, portanto eh uma nota de saida complementar. Para este tipo\r\n\t\t\t\t\t\t\t\t\t//de nota, o emitente eh sempre o sigamat.emp\r\n\t\t\t\t\t\t\t\t\tIf AllTrim(SF2->F2_ESPECIE)==\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t//para nota de saida normal o emitente eh o sigamat\r\n\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD2->D2_EMISSAO,SD2->D2_SERIE,SD2->D2_DOC,SF2->F2_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\tSM0->M0_CGC,SM0->M0_ESTENT,SM0->M0_INSC})\r\n\t\t\t\t\t\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Outros documentos referenciados³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf cChave <> Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\taadd(aNfVinc,{SF2->F2_EMISSAO,SD2->D2_SERIE,SD2->D2_DOC,SM0->M0_CGC,SM0->M0_ESTCOB,SF2->F2_ESPECIE,SF2->F2_CHVNFE,0,\"\",\"\",0,\"\",\"\"})\r\n\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\tcChave := Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tRestArea(aOldReg)\r\n\t\t\t\t\t\t\t\tRestArea(aOldReg2)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf lVinc .and. !Empty(aNfVinc)\r\n\t\t\t\t\t\t\taadd(aItemVinc,{ATail(aNfVinc)[1]})\r\n\t\t\t\t\t\tElse\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aItemVinc,{})\r\n\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Obtem os dados do produto\r\n\t\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SB1\")+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\r\n\t\t   \t\t\t\tdbSelectArea(\"SB5\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf MsSeek(xFilial(\"SB5\")+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\tIf SB5->(FieldPos(\"B5_DESCNFE\")) > 0 .And. !Empty(SB5->B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tcInfAdic := Alltrim(SB5->B5_DESCNFE)\r\n\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\tcInfAdic := \"\"\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\r\n                            cUmDipi  := SB5->B5_UMDIPI      \r\n                            nConvDip := SB5->B5_CONVDIP    \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcInfAdic := \"\"\t\t\r\n                            cUmDipi  := \"\"    \r\n                            nConvDip := 0      \r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t \t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"DY3\")\r\n\t\t\t\t   \t\tdbSetOrder(1)\r\n\t\t\t\t   \t\tIf MsSeek(xFilial(\"DY3\")+ (cAliasSB5)->B5_ONU)\r\n\t\t\t\t\t\t\tIf !Empty(DY3->DY3_DESCRI) .and. (DY3->DY3_INFCPL ==\"S\" .OR. DY3->DY3_INFCPL ==\"1\")\r\n\t\t\t\t\t\t\t\tIf !cMensONU $ DY3->DY3_ONU\r\n\t\t\t\t\t     \t   \t\tcMensONU\t:= cMensONU +'  ONU '+Alltrim(DY3->DY3_ONU)+' '+Alltrim(DY3->DY3_DESCRI)+'   '   \r\n\t\t\t\t\t    \t\tEndIF\r\n\t\t\t\t   \t\t\tEndIF  \t\t\r\n\t\t\t\t\t\tEndIF\r\n\r\n                        \r\n                        //Atualiza a Unid. Medida da DIPI(cUmDipi) e o Fator de Conv. da DIPI(nConvDip) com dados da SBZ caso os parâmetro recebidos estejam vazios\r\n                        RetInfoSBZ((cAliasSD2)->D2_COD, @cUmDipi, @nConvDip)\r\n                        \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//------------------------------------------------------------------------\r\n\t\t\t\t\t\t//Obtem dados adicionais ou do produto, ou do item do pedido de venda\r\n\t\t\t\t\t\t//------------------------------------------------------------------------\r\n\t\t\t\t\t\tIf lC6_CODINF .And. cInfAdPr <> \"2\" .And. !Empty(cInfAdPr)\r\n\t\t\t\t\t\t\tSC6->(dbSetOrder(2))\r\n\t\t\t\t\t\t\tIf SC6->(MsSeek(xFilial(\"SD2\")+(cAliasSD2)->(D2_COD+D2_PEDIDO+D2_ITEMPV))) \r\n\t\t\t\t\t\t\t\tcInfAdPed := Alltrim(MSMM(SC6->C6_CODINF,80))\r\n\t\t\t\t\t\t\t\tIf !Empty(cInfAdPed)\r\n\t\t\t\t\t\t\t\t\t//--Obtem informacoes do item do pedido de venda\r\n\t\t\t\t\t          \tIf cInfAdPr == \"1\"     \r\n\t\t\t\t\t           \t\tcInfAdic := cInfAdPed\r\n\t\t\t\t\t           \t//--Obtem informacoes do item do pedido de venda e do produto\r\n\t\t\t\t\t           \tElseIf cInfAdPr == \"3\" \r\n\t\t\t\t\t           \t   cInfAdPed := SubStr(AllTrim(cInfAdPed),1,250)\r\n\t\t\t\t\t           \t   cInfAdic  := SubStr(AllTrim(cInfAdic),1,249)\r\n\t\t\t\t\t           \t   cInfAdic  += \" \" + cInfAdPed\r\n\t\t\t\t\t           \tEndIf \r\n\t\t\t\t\t      \tEndIf\r\n\t\t\t\t\t\t\tEndIf                                                  \t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Veiculos Novos\r\n\t\t\t\t\t\tIf AliasIndic(\"CD9\")\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD9\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD9\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//Combustivel\r\n\t\t\t\t\t\tIf AliasIndic(\"CD6\")\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD6\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD6\")+\"S\"+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+Padr((cAliasSD2)->D2_ITEM,4)+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//Medicamentos\r\n\t\t\t\t\t\tIf AliasIndic(\"CD7\")\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD7\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD7\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t// Armas de Fogo\r\n\t\t\t\t\t\tIf AliasIndic(\"CD8\")\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD8\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD8\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Anfavea\r\n\t\t\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDR\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tDbSeek(xFilial(\"CDR\")+\"S\"+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDS\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tcItem := PADR((cAliasSD2)->D2_ITEM,TAMSX3(\"CDS_ITEM\")[1])\r\n\t\t\t\t\t\t\tDbSeek(xFilial(\"CDS\")+\"S\"+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+cItem+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\tEndIf  \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Rastreabilidade\r\n\t\t\t\t\t\tIf AliasIndic(\"F0A\")\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"F0A\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"F0A\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t \t\t                    \t\t\t\t\t\r\n\t\t\t\t\t\t//Desconto Zona Franca PIS e COFINS \r\n\t\t\t\t\t\tIf\tSD2->(FieldPos(\"D2_DESCZFC\"))<>0 .AND. SD2->(FieldPos(\"D2_DESCZFP\"))<>0\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_DESCZFC > 0\t\r\n\t\t\t\t\t\t\t\tnValCofZF += (cAliasSD2)->D2_DESCZFC\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_DESCZFP > 0\t\r\n\t\t\t\t\t\t\t\tnValPisZF += (cAliasSD2)->D2_DESCZFP\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"SC5\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SC5\")+(cAliasSD2)->D2_PEDIDO)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"SC6\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SC6\")+(cAliasSD2)->D2_PEDIDO+(cAliasSD2)->D2_ITEMPV+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcTpCliente:= Alltrim(SF2->F2_TIPOCLI)\r\n\t\t\t\t\t\t//Para nota sobre cupom deve ser \r\n\t\t\t\t\t\t//impresso os valores da lei da transparência.\t\t\t\t\t\r\n\t\t\t\t\t\tif lNfCup\r\n\t\t\t\t\t\t\tcTpCliente := \"F\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !AllTrim(SC5->C5_MENNOTA) $ cMensCli\r\n\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t***********************\r\n\t\t\t\t\t\t\t* BRUNO LAGE\r\n\t\t\t\t\t\t\t***********************\r\n\t\t\t\t\t\t\t*\r\n\t\t\t\t\t\t\t*    \r\n\r\n\t\t\t\t\t\t\tcMensCli += AllTrim(SC5->C5_MENNOTA) + AllTrim(SC5->C5_MSG2)\r\n\r\n\t\t\t\t\t\t\t//MENSAGEM 2 PARA NF <TLM>\r\n\t\t\t\t\t\t\tIf !AllTrim(SC5->C5_MSG2) $ cMensCli\r\n\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t//cMensCli += \" \"\r\n\t\t\t\t\t\t\t\t\tcMensCli += AllTrim(SC5->C5_MSG2)\r\n\t\t\t\t\t\t\t\tEndIf                 \r\n\t\t\t\t\t\t\t\t//cMensCli += AllTrim(SC5->C5_MSG2) \r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t*\r\n\t\t\t\t\t\t\t*********** \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//-- Tratamento para a integração entre WMS Logix X ERP Protheus \r\n\t\t\t\t\t\t\tIf SC5->( FieldPos(\"C5_ORIGEM\") ) > 0 .And. 'LOGIX' $ Upper(SC5->C5_ORIGEM) \r\n\t\t\t\t\t\t\t\tLgxMsgNfs()\r\n\t\t\t\t\t\t\tEndIf     \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF len(aCMPUSR) > 0  \r\n\t\t\t\t\t\t\t\tcFieldMsg := aCMPUSR[1]  \r\n\t\t\t\t\t\t\tEndIf    \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//BRUNO (VALIDAR POIS O CAMPO C5_MENNOTA É MEMO NA QUALITA)                       \r\n\t\t\t\t\t\t\tIf !Empty(cFieldMsg) .and. SC5->(FieldPos(cFieldMsg)) > 0 .and. !Empty(&(\"SC5->\"+cFieldMsg))\r\n\t\t\t\t\t\t\t\tcMensCli := alltrim(&(\"SC5->\"+cFieldMsg))\r\n\t\t\t\t\t\t\tElseIf !(IIF( SF2->(FieldPos(\"F2_MENNOTA\")) > 0, AllTrim(SF2->F2_MENNOTA),AllTrim(SC5->C5_MENNOTA)) $ cMensCli)\r\n\t\t\t\t\t\t\t\tcMensCli += IIF( SF2->(FieldPos(\"F2_MENNOTA\")) > 0, AllTrim(SF2->F2_MENNOTA),AllTrim(SC5->C5_MENNOTA))\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf !Empty(SC5->C5_MENPAD) \r\n\t\t\t\t\t\t\tcRetForm := FORMULA(SC5->C5_MENPAD)\r\n\t\t\t\t\t\t\tif cRetForm <> nil .and. !AllTrim(cRetForm) $ cMensFis\r\n\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensFis += AllTrim(cRetForm)\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf !Empty( cNumNfCup )\r\n\t\t\t\t\t\t\t//Tratamento para nota sobre Cupom \r\n\t\t\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\t\t\tIf Len(aItemCupRef) > 0\r\n\t\t\t\t\t\t\t\tcMsgCup := \" CF/SERIE: \" + AllTrim((cAliasSD2)->D2_DOC) + \" \" + Alltrim((cAliasSD2)->D2_SERIE) +\" ECF:\" + Alltrim((cAliasSD2)->D2_PDV)\r\n\t\t\t\t\t\t\t\tif !upper(Alltrim(cMsgCup)) $ upper(Alltrim(cMensCli))\r\n\t\t\t\t\t\t\t\t\tif \"CF/SERIE:\" $ upper(Alltrim(cMensCli))\r\n\t\t\t\t\t\t\t\t\t\tcMensCli +=\" / \"\r\n\t\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\t\tcMensCli +=\" CF/SERIE: \" + AllTrim((cAliasSD2)->D2_DOC) + \" \" + Alltrim((cAliasSD2)->D2_SERIE) +\" ECF:\" + Alltrim((cAliasSD2)->D2_PDV)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t    DbSetOrder(1)\r\n\t\t\t\t\t\t\t    If SFT->(DbSeek((xFilial(\"SD2\")+\"S\"+ cSerNfCup + cNumNfCup )))\r\n\t\t\t\t\t\t\t\t\tIF  AllTrim(SFT->FT_OBSERV) <> \" \" .AND.(cAliasSD2)->D2_ORIGLAN==\"LO\"\r\n\t\t\t\t\t\t\t\t\t\tIF !Alltrim(SFT->FT_OBSERV) $ Alltrim(cMensCli) \r\n\t\t\t\t\t\t\t\t\t\t\tif upper( \"F - simples faturamento\" ) $  upper( Alltrim(SFT->FT_OBSERV) )\r\n\t\t\t\t\t\t\t\t\t\t\t\tcMensCli +=\" CF/SERIE: \" + AllTrim((cAliasSD2)->D2_DOC) + \" \" + Alltrim((cAliasSD2)->D2_SERIE) +\" ECF:\" + Alltrim((cAliasSD2)->D2_PDV)\r\n\t\t\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\t\t\tIf \"DEVOLUCAO N.F.\" $ Upper(SFT->FT_OBSERV) \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcMensCli +=\" \" + StrTran(AllTrim(SFT->FT_OBSERV),\"N.F.\",\"C.F.\")\r\n\t\t\t\t\t\t\t\t\t\t\t\tElseIf !lNfCupNFCE .and. !lNfCupSAT\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcMensCli +=\" \" + AllTrim(SFT->FT_OBSERV)\r\n\t\t\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\tendif\t\t\r\n\t\t\t\t\t\t\t\t\t\tEndIf       \r\n\t\t\t\t\t           \t\tEndIf\r\n\t\t\t\t\t        \tEndIF\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tRestArea(aAreaSF2)\t        \t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tif !lIcmDevol .And. !(\"Nota fiscal emitida sem destaque do ICMS\" $ cMensCli)\r\n\t\t\t\t\t\t\tif Len( cMensCli ) > 0\r\n\t\t\t\t\t\t\t\tcMensCli += ' '\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\tif SM0->M0_ESTENT == \"PR\"\r\n\t\t\t\t\t\t\t\tcMensCli += \" Nota fiscal emitida sem destaque do ICMS conforme artigo 9. do Anexo IX do RICMS-PR/2017.\"\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tcMensCli += \" Nota fiscal emitida sem destaque do ICMS.\"\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tendif \t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Obtem os dados do veiculo informado no pedido de venda\r\n\t\t\t\t\t\tIf Empty(aVeiculo)\r\n\t\t\t\t\t\t\tDbSelectArea(\"DA3\")\r\n\t\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\tIf DbSeek(xFilial(\"DA3\")+Iif(SC5->(FieldPos(\"C5_VEICULO\")) > 0 ,SC5->C5_VEICULO,\"\"))\r\n\t\t\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_PLACA)\r\n\t\t\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\t\t\taadd(aVeiculo,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,iif(!Empty(cAnttRntrc),cAnttRntrc,\"\")))//RNTC\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//O campo F4_FORINFC é um substituto do F4_FORMULA, e através do parâmetro MV_NFEMSF4 se determina se o conteúdo da formula devera compor a mensagem do cliente (=\"C\") ou do fisco (=\"F\"). \t\t\t\t\r\n\t\t\t\t\t\tIf SF4->(ColumnPos(\"F4_FORINFC\") ) > 0  .And. !Empty(SF4->F4_FORINFC) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORINFC)\r\n\t\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4==\"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4==\"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tElseIf !Empty(SF4->F4_FORMULA) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORMULA)\r\n\t\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4==\"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4==\"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tIf lSb1CT\r\n\t\t\t\t\t\t\tIf lMvImpFecp  .And. SB1->B1_X_CT$cMVAEHC\r\n\t\t\t\t\t\t\t\tIf (lValFecp .Or. lVfecpst) \r\n\t\t\t\t\t\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t\t    DbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tIf SFT->(DbSeek((xFilial(\"SFT\") + cChaveD2 )))\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tIf SFT->FT_VFECPST > 0\r\n\t\t\t\t\t\t\t\t   \t\t\tcMensFis += \" Cod.Prod: \" + Alltrim((cAliasSD2)->D2_COD) + IIF(SB1->B1_X_CT$cMVAEHC,\" AEHC \",\"\") + \" BC R$: \" + Alltrim(Transform(SFT->FT_BASERET,\"@E 999,999,999.99\"))  + \" o adicional de \" + Alltrim(Str(SFT->FT_ALQFECP, 14, 2))+\"%\" + \" valor FECP R$ \" + Alltrim(Transform(SFT->FT_VFECPST,\"@E 999,999,999.99\")) \r\n\t\t\t\t\t\t\t\t\t    Endif\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\tEndif \r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tIf lMvImpFecp \r\n\t\t\t\t\t\t   If (lValFecp .Or. lVfecpst) \r\n\t\t\t\t\t\t   \t\tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\t\tIf SFT->(DbSeek((xFilial(\"SFT\") + cChaveD2 )))\t\r\n\t\t\t\t\t\t\t\t\t\tnValTFecp += SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\r\n\t\t\t\t\t\t\t\t\t\tnValIFecp := SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t   \r\n\t\t\t\t\t\t   Endif\t\t\t\t\t\r\n\t\t\t\t\t\tEndif\t\r\n\t\t\t\t\t\t//Verifica se existe Template DCL\r\n\t      \t\t\t\tIF (ExistTemplate(\"PROCMSG\"))\r\n\t      \t\t\t\t\taMens := ExecTemplate(\"PROCMSG\",.f.,.f.,{cAliasSD2})      \t\t\t\t\t\t\t\t\t\t \t\t      \t\t\t\t\t\r\n\t\t\t\t\t\t\t\tFor nA:=1 to len(aMens)\r\n\t\t\t\t\t\t\t\t    If aMens[nA][1] == \"V\" .Or. (aMens[nA][1] == \"T\" .And. Ascan(aMensAux,aMens[nA][2])==0)\r\n\t\t\t\t\t\t\t\t\t\tAADD(aMensAux,aMens[nA][2])\r\n\t\t\t\t\t\t\t\t\tEndif\t\r\n\t\t\t\t\t\t\t\tNext    \t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\tIf len(aMens) > 0\r\n\t\t\t\t\t\t\t\t\taAreaSD2  \t:= SD2->(GetArea())\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(3)\r\n\r\n\t\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SD2\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD )\r\n\t\t\t\t\t\t\t\t\t\tnBRICMSO \t:= SD2->D2_BRICMSO\r\n\t\t\t\t\t\t\t\t\t\tnICMRETO\t:= SD2->D2_ICMRETO\r\n\t\t\t\t\t\t\t\t\t\tnBRICMSD \t:= SD2->D2_BRICMSD\r\n\t\t\t\t\t\t\t\t\t\tnICMRETD\t:= SD2->D2_ICMRETD \r\n\t\t\t\t\t\t\t\t\t\tnAliqST\t\t:= SD2->D2_ALIQSOL\r\n\t\t\t\t\t\t\t\t\tEndif  \r\n\r\n\t\t\t\t\t\t\t\t\tRestArea(aAreaSD2) \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t     \t\t\t\tEndif \r\n\t     \t\t\t\t\r\n\t\t\t\t \t\tIf SF2->F2_TPFRETE == \"C\"\r\n\t\t\t\t\t\t\tcModFrete := \"0\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"F\"\r\n\t\t\t\t\t\t \tcModFrete := \"1\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"T\"\r\n\t\t\t\t\t\t \tcModFrete := \"2\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"R\"\r\n\t\t\t\t\t \t\tcModFrete := \"3\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"D\"\r\n\t\t\t\t\t \t\tcModFrete := \"4\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"S\"\r\n\t\t\t\t\t\t \tcModFrete := \"9\"\r\n\t\t\t\t\t \tElseIf Empty(cModFrete)\r\n\t\t\t\t\t \t\tIf SC5->C5_TPFRETE==\"C\"\r\n\t\t\t\t\t\t\t\tcModFrete := \"0\"\r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"F\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"1\"\r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"T\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"2\"\r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"S\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"9\" \r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"R\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"3\" \r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"D\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"4\" \r\n\t\t\t\t\t\t \tElse\r\n\t\t\t\t\t\t \t\tcModFrete := \"1\" \t\t\t \t \t\r\n\t\t\t\t\t\t\tEndIf   \t\t\t \r\n\t\t\t\t\t\tEndIf               \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf Empty(aPedido)\r\n\t\t\t\t\t\t\taPedido := {Iif(SC5->(FieldPos(\"C5_NTEMPEN\")) > 0,Alltrim(SC5->C5_NTEMPEN),\"\"),AllTrim(SC6->C6_PEDCLI),\"\"}\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Indicador de presença do comprador no estabelecimento comercial no momento da operação - VERSÃO 3.10\r\n\t\t\t\t\t\tIf SC5->(FieldPos(\"C5_INDPRES\")) > 0\r\n\t\t\t\t\t\t\t If lNfCup .Or. (cAliasSD2)->D2_ORIGLAN $ \"VD|LO\"\r\n\t\t\t\t\t\t\t \tcIndPres := \"1\" //1=Operação presencial\r\n\t\t\t\t\t\t\t Else\r\n\t\t\t\t\t\t\t \tcIndPres:= Alltrim(SC5->C5_INDPRES)\r\n\t\t\t\t\t\t\t EndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Verifica se municipio de prestação foi informado no pedido\r\n\t\t\t\t\t\tIf SC5->(FieldPos(\"C5_MUNPRES\")) > 0 .And. !Empty(SC5->C5_MUNPRES)\r\n\t\t\t\t\t\t\tif len(AllTrim(SC5->C5_MUNPRES)) == 7 \r\n\t\t\t\t\t\t\t\tcMunPres  := SC5->C5_MUNPRES\r\n\t\t\t\t\t\t\t\tcMunTransp := cMunPres\r\n\t\t\t\t\t\t\telseif SC5->(FieldPos(\"C5_ESTPRES\")) > 0 .and. !Empty(SC5->C5_ESTPRES)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tcMunPres  := ConvType(aUF[aScan(aUF,{|x| x[1] == SC5->C5_ESTPRES})][02]+SC5->C5_MUNPRES)\r\n\t\t\t\t\t\t\t\tcMunTransp := cMunPres\r\n\t\t\t\t\t\t\tendif  \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcMunPres := ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[09]})][02]+aDest[07])\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t// Tags xPed e nItemPed (controle de B2B) para nota de saída\r\n\t\t\t\t\t\tIf SC6->(FieldPos(\"C6_NUMPCOM\")) > 0 .And. SC6->(FieldPos(\"C6_ITEMPC\")) > 0\r\n\t\t\t\t\t\t\tIf !Empty(SC6->C6_NUMPCOM) .And. !Empty(SC6->C6_ITEMPC) \r\n\t\t\t\t\t\t\t\taadd(aPedCom,{SC6->C6_NUMPCOM,SC6->C6_ITEMPC})\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aPedCom,{})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aPedCom,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Conforme Decreto RICM, N 43.080/2002 valido somente em MG deduzir o\r\n\t\t\t\t\t\t//imposto dispensado na operação\r\n\t\t\t\t\t\tnDescRed := 0\r\n\t\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t//FT_FILIAL+FT_TIPOMOV+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM+FT_PRODUTO\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SFT\") + cChaveD2 + \"  \" + (cAliasSD2)->D2_COD)  \r\n\t\t\t\t\t\tIf SFT->(FieldPos(\"FT_DS43080\")) <> 0 .And. SFT->FT_DS43080 > 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\t\t\tnDescRed := SFT->FT_DS43080 \r\n\t\t\t\t\t\t\tnDesTotal+= nDescRed\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SFT->(ColumnPos(\"FT_DESCFIS\")) <> 0 .And. SFT->FT_DESCFIS > 0\r\n\t\t\t\t\t\t\tnDescFis := SFT->FT_DESCFIS\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf (SFT->(ColumnPos(\"FT_CRDPRES\")) <> 0 .And. SFT->FT_CRDPRES > 0) .and. ( SF4->F4_AGREGCP $\"1|S\")\r\n\t\t\t\t\t\t\tnCrdPres := SFT->FT_CRDPRES\r\n\t\t\t\t\t\t\tnTotCrdP += nCrdPres\r\n\t\t\t\t\t\tEndIf \r\n\r\n\t\t\t\t\t\t//Alteração realizada no campo F4_ICMSDIF, foi incluido a opção: 6 – Diferido(Deduz NF e Duplicata)\r\n\t\t\t\t\t\t//no combo para deduzir os valores de ICMS diferido na NF e da Duplicata\r\n\t\t\t\t\t\t//http://tdn.totvs.com/display/public/PROT/2892815+DSERFIS1-6266+DT+Diferimento+ICMS\r\n\t\t\t\t\t\tnDescNfDup :=0\r\n\t\t\t\t\t\tIf\tSF4->F4_ICMSDIF == \"6\"\r\n\t\t\t\t\t\t\tnDescNFDup := IIF(SF1->(F1_STATUS) == 'C', (cAliasSD1)->(D1_ICMSDIF),SFT->FT_ICMSDIF)\r\n\t\t\t\t\t\tEndIF \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Incluido o tratamento pelo fato do SIGALOJA e o VENDA DIRETA nao gravar\r\n\t\t\t\t\t\t//o campo D2_DESCON, quando e' dado desconto no total da venda.\r\n\t\t\t\t\t\tIf lNfCup .Or. (cAliasSD2)->D2_ORIGLAN $ \"VD|LO\"\r\n\r\n\t\t\t\t\t\t\tlVLojaDir := .T.\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnDesconto := 0\r\n\t\t\t\t\t\t\t//Caso possua desconto vai fazer essa logica abaixo para se adequar a mesma logica do faturamento , \r\n\t\t\t\t\t\t\t//Pq ao contrario do faturamento o LOJA nao grava o D2_DESCON quando o desconto eh no total \r\n\t\t\t\t\t\t\tIf SF2->F2_DESCONT > 0\r\n\t\t\t\t\t\t\t\tIf lFirstItem\t// Somente faz o looping nos itens na primeira vez\r\n\t\t\t\t\t\t\t\t\tnTDescIt := 0\r\n\r\n\t\t\t\t\t\t\t\t\t//Posicionando diretamente na SD2, para poder utilizar o Get/RestArea e atender TOP e DBF.\r\n\t\t\t\t\t\t\t\t\taAreaSD2  \t:= SD2->(GetArea())\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tWhile !SD2->(Eof()) .And. xFilial(\"SD2\") == SD2->D2_FILIAL .And.;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  SF2->F2_SERIE  == SD2->D2_SERIE  .And.;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  SF2->F2_DOC    == SD2->D2_DOC\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tnTDescIt += SD2->D2_DESCON \t// Soma de todos os descontos nos itens\r\n\t\t\t\t\t\t\t\t\t\tSD2->(DbSkip())\r\n\t\t\t\t\t\t\t\t\tEnd\r\n\t\t\t\t\t\t\t\t\tlFirstItem := .F.\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tRestArea(aAreaSD2)\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t/*Retirado tratamento pois não funciona para DBF\r\n\t\t\t\t\t\t\t\t\tnX := 1\r\n\t\t\t\t\t\t\t\t\t// Como nao temos RestArea para alias temp , da um gotop e depois certifica que esta no recno correto\r\n\t\t\t\t\t\t\t\t\tWhile nCount <> (cAliasSD2)->(Recno()) .AND. nX < 50 // Protecao para nao ficar loop infinito\r\n\t\t\t\t\t\t\t\t\t\t(cAliasSD2)->(DbSkip())\r\n\t\t\t\t\t\t\t\t\t\tnX++\r\n\t\t\t\t\t\t\t\t\tEnd\r\n\t\t\t\t\t\t\t\t\t */\r\n\t\t\t\t\t\t\t\t\t// Se o valor do desconto for igual significa que soemente teve desconto no item \r\n\t\t\t\t\t\t\t\t\t// Nesse caso pode seguir a mesma regra do faturamente e pegar direto do D2_DESCON\t\r\n\t\t\t\t\t\t\t\t\tIf nTDescIt = SF2->F2_DESCONT\r\n\t\t\t\t\t\t\t\t\t\tlLjDescIt\t:= .T.\t\t\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf lLjDescIt\t// Se so teve desconto no item pega direto do D2_DESCON\r\n\t\t\t\t\t\t\t\t\tnDesconto := (cAliasSD2)->D2_DESCON\r\n\t\t\t\t\t\t\t\tElse\t\t\t// Faz o rateio do desconto no total + o desconto no item\r\n\t\t\t\t\t\t\t\t\tnDesconto := ((((cAliasSD2)->D2_QUANT*(cAliasSD2)->D2_PRUNIT)/SF2->F2_VALMERC) * (SF2->F2_DESCONT- nTDescIt))+(cAliasSD2)->D2_DESCON \r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t            Else \r\n\t\t\t\t\t\t\tnDesconto := (cAliasSD2)->D2_DESCON            \t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf  (cAliasSD2)->D2_VRDICMS > 0  .and. nDesconto >= (cAliasSD2)->D2_VRDICMS \r\n\t\t\t\t\t\t\t\tnDesVrIcms := (cAliasSD2)->D2_VRDICMS\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf\tSD2->(FieldPos(\"D2_DESCICM\"))<>0\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tnDescIcm := ( IIF(SF4->F4_AGREG == \"D\",(cAliasSD2)->D2_DESCICM,0) )\r\n\t\r\n\t\t\t\t\t\t\t\tIf cVerAmb >= \"3.10\" .and. SF4->F4_AGREG == \"D\" .and.  (!Empty(SF4->F4_MOTICMS) .and. (AllTrim(SF4->F4_MOTICMS) $ \"3-8-9\" .or.  AllTrim(SF4->F4_MOTICMS) =='90')) .and. Empty(SF4->F4_CSOSN)\r\n\t\t\t\t\t\t\t\t\tnDescIcm:=0\r\n\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t            EndIf\r\n\t\t\t            \r\n\t\t\t\t\t\t//Tratamento para verificar se o produto e controlado por terceiros (IDENTB6)\r\n\t\t\t\t\t\t//e a partir do tipo do pedido (Cliente ou Fornecedor) verifica  se existe\r\n\t\t\t\t\t\t//amarracao entre Produto X Cliente(SA7) ou Produto X Fornecedor(SA5)\r\n\t\t\t\t\t\t//Caso haja a amarraca, o codigo e descricao do produto, assumem o conteudo da SA7 ou SA5\r\n\t\t\r\n\t\t\t\t\t\tcCodProd  := (cAliasSD2)->D2_COD\t            \r\n\t\t\t\t\t\tcDescProd := IIF(Empty(SC6->C6_DESCRI),SB1->B1_DESC,SC6->C6_DESCRI) \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t********************************************************************\r\n\t\t\t\t\t\t* BRUNO LAGE FERREIRA\r\n\t\t\t\t\t\t********************************************************************\r\n\t\t\t\t\t\t*  \r\n\t\t\t\t\t\t*\r\n\t\t\t\t\t\tIF(Alltrim((cAliasSD2)->D2_LOTECTL) == '')\r\n\t\t\t\t\t\t\tcDescProd := IIf(Empty(SC6->C6_LTREM) , cDescProd , Alltrim(cDescProd) + \" - NUM. \" + Alltrim(SC6->C6_LTREM))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcDescProd := IIf(Empty((cAliasSD2)->D2_LOTECTL) , cDescProd , Alltrim(cDescProd) + \" - NUM. \" + Alltrim((cAliasSD2)->D2_LOTECTL))\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t//Acrescentar comprimento, altura e largura bruta para Remessa p/ industrialização por conta ord.\r\n\t\t\t\t\t\tIf ( !Empty(SC6->C6_COMPBRU) .AND. !Empty(SC6->C6_ALTBRU ) .AND. !Empty(SC6->C6_LARGBRU) .AND. SC6->C6_TES == \"526\" )\r\n\r\n\t\t\t\t\t\t\tcDescProd += \" Bru.- \" + ALLTRIM(cValToChar(SC6->C6_COMPBRU)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_ALTBRU)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_LARGBRU)) + \" Liq.- \"\r\n\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf ( !Empty(SC6->C6_COMPLIQ) .AND. !Empty(SC6->C6_ALTLIQ) .AND. !Empty(SC6->C6_LARGLIQ) )\r\n\r\n\t\t\t\t\t\t\tcDescProd += \" \" + ALLTRIM(cValToChar(SC6->C6_COMPLIQ)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_ALTLIQ)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_LARGLIQ))\r\n\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t*\r\n\t\t\t\t\t\t*\r\n\t\t\t\t\t\t*******************************************************************\r\n\t\t\t\t\t\t \r\n\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_IDENTB6) .And. lNFPTER  \r\n\t\t\t\t         \tIf SC5->C5_TIPO == \"N\" \r\n\t\t\t\t\t\t         //--A7_FILIAL + A7_CLIENTE + A7_LOJA + A7_PRODUTO\r\n\t\t\t\t\t\t         SA7->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\t         If SA7->(MsSeek( xFilial(\"SA7\") + (cAliasSD2)->(D2_CLIENTE+D2_LOJA+D2_COD) )) .and. !empty(SA7->A7_CODCLI) .and. !empty(SA7->A7_DESCCLI) \r\n\t\t\t\t\t\t         \tcCodProd  := SA7->A7_CODCLI \r\n\t\t\t\t\t\t            cDescProd := SA7->A7_DESCCLI\t            \t\t\t\t\t\t\r\n\t\t\t\t\t\t         EndIf \r\n\t\t\t\t\t\t\tElseIf SC5->C5_TIPO == \"B\"\r\n\t\t\t\t\t\t      \t//--A5_FILIAL + A5_FORNECE + A5_LOJA + A5_PRODUTO\r\n\t\t\t\t\t\t         SA5->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\t         If SA5->(MsSeek( xFilial(\"SA5\") + (cAliasSD2)->(D2_CLIENTE+D2_LOJA+D2_COD) )) .and. !empty(SA5->A5_CODPRF) .and. !empty(SA5->A5_DESREF)\r\n\t\t\t\t\t\t         \tcCodProd  := SA5->A5_CODPRF \r\n\t\t\t\t\t\t            cDescProd := SA5->A5_DESREF \t            \r\n\t\t\t\t\t\t         EndIf \t\r\n\t\t\t\t\t      \tEndIf  \r\n\t\t\t         \tEndIf \r\n\t\t\t         \r\n\t\t\t            nDescZF := (cAliasSD2)->D2_DESCZFR \r\n\t\t\t            \r\n\t\t\t            // Faz o destaque do IPI nos dados complementares caso seja uma venda por consignação mercantil e possuir IPI\r\n\t\t\t\t\t\tIf (lConsig .Or. Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .And. (cAliasSD2)->D2_VALIPI > 0\r\n\t\t\t\t\t\t\tnIPIConsig += (cAliasSD2)->D2_VALIPI\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Faz o destaque do ICMS ST nos dados complementares caso seja uma venda por consignação mercantil e possuir ICMS ST\r\n\t\t\t\t\t\tIf Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM .And. (cAliasSD2)->D2_ICMSRET > 0 .And. lConsig    \r\n\t\t\t\t\t\t\tnSTConsig += (cAliasSD2)->D2_ICMSRET \r\n\t\t\t\t\t\tEndIf  \t\r\n\t\t\t            \r\n\t\t\t            //Tratamento para que o valor de ICMS ST venha a compor o valor da tag vOutros quando for uma nota de Devolução, impedindo que seja gerada a rejeição 610.\r\n\t\t\t            nIcmsST := 0\r\n\t\t\t            If (!lIcmSTDev .And. (cAliasSD2)->D2_TIPO == \"D\" .And. SubStr((cAliasSD2)->D2_CLASFIS,2,2) $ '00#10#30#70#90') .Or. (lConsig .And. Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .Or. (!lIcmSTDev .And. lComplDev .And. (cAliasSD2)->D2_TIPO == \"I\" )\r\n\t\t\t            \tnIcmsST := (cAliasSD2)->D2_ICMSRET\r\n\t\t\t            EndIf   \r\n\t\t\t            cOrigem:= IIF(!Empty((cAliasSD2)->D2_CLASFIS),SubStr((cAliasSD2)->D2_CLASFIS,1,1),'0')\r\n\t\t\t            cCSTrib:= IIF(!Empty((cAliasSD2)->D2_CLASFIS),SubStr((cAliasSD2)->D2_CLASFIS,2,2),'50')\r\n\t\t\t            \r\n\t\t\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//\t\t\tFCI - Ficha de Conteúdo de Importação\r\n\t\t\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//**Operação INTERNA:\r\n\t\t\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da importação      (Industrialização)\r\n\t\t\t\t\t\t//\r\n\t\t\t\t\t\t//**Operação INTERESTADUAL:\r\n\t\t\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da parcela importada do exterior, o número da FCI e o Conteúdo de\r\n\t\t\t\t\t\t//   Importação expresso percentualmente (Industrialização)\r\n\t\t\t\t\t\t//----------------------------------------------------------------------------------------- \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf (cOrigem $\"1-2-3-4-5-6-8\" .And. cCSTrib $ \"00-10-20-30-40-41-50-51-60-70-90\")\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->(FieldPos(\"D2_FCICOD\")) > 0 .And. !Empty((cAliasSD2)->D2_FCICOD)\r\n\t\t\t\t\t\t\t\taadd(aFCI,{(cAliasSD2)->D2_FCICOD}) \r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf lFCI\r\n\t\t\t\t\t\t\t\t\tcMsgFci\t:= \"Resolucao do Senado Federal nº 13/12\"\r\n\t\t\t\t\t\t\t\t\tcInfAdic  += cMsgFci + \", Numero da FCI \" + Alltrim((cAliasSD2)->D2_FCICOD) + \".\"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t// Retirada a validação devido a criação da tag nFCI (NT 2013/006)\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//Campo SD2->D2_FCICOD só é preenchido nos casos de Industrialização Interestadual\r\n\t\t\t\t\t\t//Executar UPDSIGAFIS para criação do campo na D2 e tabela CFD.\r\n\t\t\t\t\t\t//Obs.: O campo D2_FCICOD é alimentado com o conteúdo do campo CFD_FCICOD após\r\n\t\t\t\t\t\t//faturar os Documentos de Saída (MATA461).\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//If AliasIndic(\"CFD\")\r\n\t\t\t\t\t\t\t//CFD->(DbSetOrder(3))   //Tabela de Ficha de Conteudo de Importação\r\n\t\t\t\t\t\t\t//If CFD->(DbSeek(xFilial(\"CFD\")+(cAliasSD2)->D2_FCICOD))\r\n\t\t\t\t\t\t\t\t//-----------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\t//Obs.: Retirado o valor da parcela importada devido ao Convênio 38/2013  CH: THHDRV\r\n\t\t\t\t\t\t\t\t//nValParImp\t:= IIf(CFD->(FieldPos(\"CFD_VPARIM\")) > 0,CFD->CFD_VPARIM, 0)         \r\n\t\t\t\t\t\t\t\t//-----------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\t//nContImp\t:= IIf(CFD->(FieldPos(\"CFD_CONIMP\")) > 0,CFD->CFD_CONIMP, 0)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//cInfAdic  += cMsgFci + \", Valor da Parcela Importada R$ \"+ ConvType(nValParImp, 11,2)+ \", Conteudo de Importacao \" + ConvType(nContImp, 11,2) + \"% , Numero da FCI \" + Alltrim((cAliasSD2)->D2_FCICOD)\r\n\t\t\t\t\t\t\t\t//cInfAdic  += cMsgFci + \", Conteudo de Importacao \" + ConvType(nContImp, 11,2) + \"% , Numero da FCI \" + Alltrim((cAliasSD2)->D2_FCICOD)\r\n\t\t\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//Preencher o campo C6_VLIMPOR com o valor da Importação para popular o D2_VLIMPOR\r\n\t\t\t\t\t\t//Obs.: Somente preencher nos casos em que não utilize RASTRO, caso utilize será\r\n\t\t\t\t\t\t//      populado automaticamente.\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\t\r\n\t\t\t\t\t\t//ElseIf (cAliasSD2)->(FieldPos(\"D2_VLIMPOR\")) > 0 .And. !Empty((cAliasSD2)->D2_VLIMPOR)\r\n\t\t\t\t\t\t\t//cInfAdic  += cMsgFci + \", Valor da Importacao R$ \" + ConvType((cAliasSD2)->D2_VLIMPOR, 11,2)\r\n\t\t\t\t\t\t//EndIf\r\n\t\r\n\t\t\t\t\t\t//Adequação NT2013/003 - Verifica se o valor será composto da tabela SBZ ou SB1\r\n\t\t\t\t\t\tnAliqNcm := 0\r\n\t\t\t\t\t\tIf lCpoAlqSBZ .And. lCpoAlqSB1   \r\n\t\t\t\t\t\t\tnAliqNcm := RetFldProd(cCodProd,\"B1_IMPNCM\",\"SB1\")\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !empty(nAliqNcm) .and. nAliqNcm == 0 .And. lCpoAlqSB1   \t \r\n\t\t\t\t\t\t\tnAliqNcm:=  SB1->B1_IMPNCM\r\n\t\t\t\t\t\tEndIf\t\r\n\t\t\t            \t\t            \r\n\t\t\t            If lCpoMsgLT .And. lCpoLoteFor .And. SF4->F4_MSGLT $ \"1\" \r\n\t\t\t\t\t\t\tcNumLotForn := Alltrim(Posicione(\"SB8\",2,xFilial(\"SB8\")+(cAliasSD2)->D2_NUMLOTE+(cAliasSD2)->D2_LOTECTL+cCodProd,\"B8_LOTEFOR\"))\r\n\t\t\t\t\t\t\tif !Empty(cNumLotForn)\r\n\t\t\t\t\t\t\t\tcInfAdic := \"LOTE:\"+cNumLotForn+\" \"+cInfAdic\r\n\t\t\t\t\t\t\tEndIf\t\t\t            \t            \t\t             \r\n\t\t\t            endif  \r\n\t\t\t            \r\n\t\t\t            //Verifica fonte carga tributária\r\n\t\t\t            \t            \r\n\t\t\t            If cMvMsgTrib $ \"1-3\"\r\n\t\t\t            \tIf lIntegHtl //Integracao Hotelaria\r\n                                cFntCtrb := SF2->F2_LTRAN \r\n                            Else\r\n\t\t\t\t            \tIf cMvFisCTrb ==\"1\"\r\n\t\t\t\t\t            \tIf FindFunction(\"AlqLeiTran\")\t\t            \t\t\r\n\t\t\t\t\t            \t\tcFntCtrb := AlqLeiTran(\"SB1\",\"SBZ\" )[2]\t\t\t            \t\t\r\n\t\t\t\t\t            \tEndIf\r\n\t\t\t\t\t            \tIf Empty(cFntCtrb) .And. !Empty(cMvFntCtrb).And. !cFntCtrb $ \"IBPT\"\r\n\t\t\t\t\t\t             \tcFntCtrb := cMvFntCtrb\r\n\t\t\t\t\t\t            EndIf \r\n\t\t\t\t            \tElse\r\n\t\t\t\t            \t\tIf Empty(cFntCtrb) .And. !Empty(cMvFntCtrb)\r\n\t\t\t\t\t\t             \tcFntCtrb := cMvFntCtrb\r\n\t\t\t\t\t\t            EndIf \r\n\t\t\t\t            \tEndIf\r\n\t\t\t\t            EndIf\r\n\t\t\t            EndIf\r\n\t\t\t            \r\n\t\t\t            \r\n\t\t\t          \t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³  ³Código de Benefício Fiscal na UF aplicado ao item\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \r\n\t\t\t\t\t\tIf lNfCupNFCE\r\n\t\t\t\t\t\t\tcTpEspcBen := 'NFCE'\r\n\t\t\t\t\t\tElseIf lNfCupSAT\r\n\t\t\t\t\t\t\tcTpEspcBen := 'SATCE'\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcTpEspcBen := 'SPED'\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tlCodLan := .F.\r\n\t\t\t\t\t\tIf SM0->M0_ESTENT $ \"PR/RJ/RS/\" //TAG cBenef buscar o conteúdo da tabela 5.2 no sistema quando for do PR.\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDV\")\r\n\t\t\t\t\t\t\tdbSetOrder(4) //CDV_FILIAL+CDV_TPMOVI+CDV_ESPECI+CDV_FORMUL+CDV_DOC+CDV_SERIE+CDV_CLIFOR+CDV_LOJA+CDV_NUMITE+CDV_SEQ+CDV_CODAJU\r\n\t\t\t\t\t\t\tcCodlan := \"\"\r\n\t\t\t\t\t\t\tIf MsSeek(xFilial(\"CDV\") +'S'+PadR(cTpEspcBen,TamSX3(\"CDV_ESPECI\")[1])+'S'+(cAliasSD2)->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_ITEM))\r\n\t\t\t\t\t\t\t\t//Tratamento realizado enquanto o fiscal não realiza a criação do campo na CDV\r\n\t\t\t\t\t\t\t\tif CDV->(ColumnPos(\"CDV_NFE\")) > 0\r\n\t\t\t\t\t\t\t\t\tif CDV->CDV_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"CDY\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf CDV->(ColumnPos(\"CDV_CODAJU\")) > 0 .and. !Empty(CDV->CDV_CODAJU) .and. MsSeek( xFilial(\"CDY\") + CDV->CDV_CODAJU)\r\n\t\t\t\t\t\t\t\t\t\tIf CDY->CDY_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\tendif\t\r\n\r\n\t\t\t\t\t\t\t\tif lCodLan\r\n\t\t\t\t\t\t\t\t\tcCodlan:= CDV->CDV_CODAJU\r\n\t\t\t\t\t\t\t\tendif\t\r\n\t\t\t\t\t\t\telse \r\n\t\t\t\t\t\t\t\tcCodlan := getCodLan( alltrim(SM0->M0_ESTENT), SF4->F4_SITTRIB, cAmbiente )\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcCodlan := \"\"\t\r\n\t\t\t\t\t\t\tIf SM0->M0_ESTENT <> \"SP\" .and. CDA->(ColumnPos(\"CDA_CODLAN\")) > 0\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"CDA\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1) //CDA_FILIAL+CDA_TPMOVI+CDA_ESPECI+CDA_FORMUL+CDA_NUMERO+CDA_SERIE+CDA_CLIFOR+CDA_LOJA+CDA_NUMITE+CDA_SEQ+CDA_CODLAN+CDA_CALPRO\r\n\t\t\t\t\t\t\t\tcSeekCDA := xFilial(\"CDA\") + 'S' + PadR(cTpEspcBen,TamSX3(\"CDA_ESPECI\")[1]) + 'S' + (cAliasSD2)->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_ITEM)\r\n\t\t\t\t\t\t\t\tIf CDA->(MsSeek(cSeekCDA))\r\n\t\t\t\t\t\t\t\t\tWhile alltrim(cSeekCDA) == alltrim(CDA->(CDA_FILIAL + CDA_TPMOVI + CDA_ESPECI + CDA_FORMUL + CDA_NUMERO + CDA_SERIE + CDA_CLIFOR + CDA_LOJA + CDA_NUMITE))\r\n\t\t\t\t\t\t\t\t\t\tIf !Empty(CDA->CDA_CODLAN) .And. Len(AllTrim(CDA->CDA_CODLAN)) == 10\r\n\t\t\t\t\t\t\t\t\t\t\tcCodlan := CDA->CDA_CODLAN\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\tCDA->(dbSkip())\r\n\t\t\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t          \t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³  Indicador de Produção em escala relevante, conforme Cláusula 23 do Convenio ICMS 52/2017\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \t\t\t\t\t\t\r\n\t\t\t\t\t\tIf AliasIndic(\"D3E\")\r\n\t\t\t\t\t\t\tdbSelectArea(\"D3E\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tcIndEscala :=\"\"\r\n\t\t\t\t\t\t\tIf MsSeek(PADR(xFilial(\"D3E\"),TAMSX3(\"D3E_FILIAL\")[1]) +(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\t\tIf D3E->(ColumnPos(\"D3E_INDESC\")) > 0\r\n\t\t\t\t\t\t\t\t\tIf\t!Empty(D3E->D3E_INDESC)  .AND.  D3E->D3E_INDESC == \"1\"\r\n\t\t\t\t\t\t\t\t\t\tcIndEscala:= \"S\"\r\n\t\t\t\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cD2Cfop)\r\n\r\n\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO <> 'D') .Or. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM)\r\n\t\t\t\t\t\t\tlIPIOutro:=.F.\r\n\t\t\t\t\t\tEnd\r\n                        \r\n\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO <> 'B')\r\n\t\t\t\t\t\t\tlIPIOutB :=.F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t   \r\n\t\t\t\t\t\tnValOutr  := 0\r\n\t\t\t\t\t\t//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).E devolução com IPI. (Nota de compl.Ipi de uma devolução de compra(MV_IPIDEV=F) leva o IPI em voutros)\t\r\n\t\t\t\t\t\tIF((cAliasSD2)->D2_TIPO == \"D\" .And. (!lIpiDev .Or. lIPIOutro)) .Or. lConsig .Or. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM ) .or. ((cAliasSD2)->D2_TIPO == \"B\" .and. lIpiBenef) .or. ((cAliasSD2)->D2_TIPO==\"P\" .And. lComplDev .And. !lIpiDev)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO  == \"D\" .and.  lIPIOutro ) .or. ((cAliasSD2)->D2_TIPO  == \"B\" .and. lIPIOutB)\r\n\t\t\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n                            EndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\t\t\tnValOutr += 0\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tnValOutr +=(cAliasSD2)->D2_VALIPI\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\t\r\n\r\n\t\t\t\t\t\tnValOutr += (cAliasSD2)->D2_DESPESA + (cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3 + nIcmsST + nCrdPres\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcTpOrig  := IIF(nCountIT > 0 .And. Len(aNfVinc[nCountIT]) > 9, aNfVinc[nCountIT][10], \"\") //Pegar tipo da nota de origem\r\n\t\t\t\t\t\t\r\n\t\t\t           \t//BRUNO\r\n\t\t\t\t\t\tcF2Tipo\t:= IIF(!Empty(aNota[5]),aNota[5], \"N\")\r\n\t\t\t           \t\t            \t\t\r\n\t\t\t\t\t\taAdd(aInfoItem,{(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV,(cAliasSD2)->D2_TES,(cAliasSD2)->D2_ITEM})\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf aDest[09] == \"DF\"\r\n\t\t\t\t\t\t\tIf Substr(SB1->B1_POSIPI,1,4) $ \"2401|2402|2403|2203\" .Or. Substr(SB1->B1_POSIPI,1,6) $ \"210690|220290\"\r\n\t\t\t\t\t\t\t\tlNCMOk := .T.\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tBruno SigawiSe\r\n\t\t\t\t\t\tse for a itinga a chamada e orignal \r\n\t\t\t\t\t\tse for qualita muda a função U_RETPESOFAT\r\n\t\t\t\t\t\tAlert(SC5->C5_NUM)\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SubString(CNUMEMP,1,2) == \"05\" .OR. !SubString(AllTrim(SB1->B1_COD),1,2) $  'CH/AM' .OR. SC5->C5_YTIPO $ \"MI/TF\"\r\n\t\t\t\t\t\t\r\n\t\t\t\t   \t\t   aadd(aProd,\t{Len(aProd)+1,;\r\n\t\t\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\t\t\tSB1->B1_POSIPI,;//Retirada validação do parametro MV_CAPPROD, de acordo com a NT2014/004 não é mais possível informar o capítulo do NCM\r\n\t\t\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t\t\tcD2Cfop,;\r\n\t\t\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_QUANT,;\r\n\t\t\t\t\t\t\t\tIIF(!((cAliasSD2)->D2_TIPO$\"IP\" .Or. ((cAliasSD2)->D2_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,IIF(!(lMvNFLeiZF),(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR-nDesVrIcms,(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR - ((cAliasSD2)->D2_DESCZFP+(cAliasSD2)->D2_DESCZFC+nDesVrIcms)),IIF(((cAliasSD2)->D2_TIPO==\"I\" .And. SF4->F4_AJUSTE == \"S\" .And. \"RESSARCIMENTO\" $ Upper(cNatOper) .And. \"RESSARCIMENTO\" $ Upper(cDescProd)),(cAliasSD2)->D2_TOTAL,0)),;\r\n\t\t\t\t\t\t\t\tretUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\t\t\tretQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), nConvDip, (cAliasSD2)->D2_QUANT ),;    //retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_CONVDIP, (cAliasSD2)->D2_QUANT ),;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_VALFRE,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_SEGURO,;\r\n\t\t\t\t\t\t\t\t(nDesconto+nDescIcm+nDescRed+nDescNfDup+nDescFis),;\r\n\t\t\t\t\t\t\t\t0,;// O valor unitario sera obtido pela divisao do valor do produto pela quantidade comercial de acordo com o  Manual do Contribuinte 6.00 realizado na tag <vUnCom>(ConvType(aProd[10]/aProd[09],21,8)) \r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_NUMLOTE,;//Numero do Lote\r\n\t\t\t\t\t\t\t   \tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).E devolução com IPI. (Nota de compl.Ipi de uma devolução de compra(MV_IPIDEV=F) leva o IPI em voutros)\r\n\t\t\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\t\t\tIIF((SF4->F4_AGREG='N' .And. !AllTrim(SF4->F4_CF) $ cMVCfopTran) .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\"),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_TES,;\r\n\t\t\t\t\t\t\t\tIIF(SB5->(FieldPos(\"B5_PROTCON\"))<>0,SB5->B5_PROTCON,\"\"),; //Campo criado para informar protocolo ou convenio ICMS \r\n\t\t\t\t\t\t\t\tIIf(SubStr(SM0->M0_CODMUN,1,2) == \"35\" .And. cTpPessoa == \"EP\" .And. nDescIcm > 0, nDescIcm,0),;   \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTIMP\"))<>0,(cAliasSD2)->D2_TOTIMP,0),;   //aProd[30] - Total imposto carga tributária. \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFP,;\t\t\t//aProd[31] - Desconto Zona Franca PIS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFC,;\t\t\t//aProd[32] - Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PICM,;\t\t//aProd[33] - Percentual de ICMS\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;  //aProd[34]\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTFED\"))<>0,(cAliasSD2)->D2_TOTFED,0),;   //aProd[35] - Total carga tributária Federal\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTEST\"))<>0,(cAliasSD2)->D2_TOTEST,0),;   //aProd[36] - Total carga tributária Estadual\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTMUN\"))<>0,(cAliasSD2)->D2_TOTMUN,0),;   //aProd[37] - Total carga tributária Municipal\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PEDIDO,;\t //aProd[38] \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_ITEMPV,;\t //aProd[39] \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_GRPCST\")) > 0 .and. !Empty((cAliasSD2)->D2_GRPCST),(cAliasSD2)->D2_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //aProd[40]\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aProd[41] NT2015/003\r\n\t\t\t\t\t\t\t\t\"\",; //aprod[42] apenas na entrada é utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\t\t\tnValIFecp,; //aprod[43]  Valor do FECP.\r\n\t\t\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),;//aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),;  //aprod[46]\r\n\t\t\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\t\t\tSF4->F4_ART274,;  //aprod[48]\r\n\t\t\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aProd,\t{Len(aProd)+1,;\r\n\t\t\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\t\t\tSB1->B1_POSIPI,;//Retirada validação do parametro MV_CAPPROD, de acordo com a NT2014/004 não é mais possível informar o capítulo do NCM\r\n\t\t\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t\t\tcD2Cfop,;\r\n\t\t\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_QUANT,;\r\n\t\t\t\t\t\t\t\tIIF(!((cAliasSD2)->D2_TIPO$\"IP\" .Or. ((cAliasSD2)->D2_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,IIF(!(lMvNFLeiZF),(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR-nDesVrIcms,(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR - ((cAliasSD2)->D2_DESCZFP+(cAliasSD2)->D2_DESCZFC+nDesVrIcms)),IIF(((cAliasSD2)->D2_TIPO==\"I\" .And. SF4->F4_AJUSTE == \"S\" .And. \"RESSARCIMENTO\" $ Upper(cNatOper) .And. \"RESSARCIMENTO\" $ Upper(cDescProd)),(cAliasSD2)->D2_TOTAL,0)),;\r\n\t\t\t\t\t\t\t\tretUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\t\t\tIIf(cF2Tipo == \"B\",retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_CONVDIP, (cAliasSD2)->D2_QUANT ),U_RETPESOFAT((cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV)  ),; \t\t\t// BRUNO SIGAWISE retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_CONVDIP, (cAliasSD2)->D2_QUANT )\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_VALFRE,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_SEGURO,;\r\n\t\t\t\t\t\t\t\t(nDesconto+nDescIcm+nDescRed+nDescNfDup+nDescFis),;\r\n\t\t\t\t\t\t\t\t0,;// O valor unitario sera obtido pela divisao do valor do produto pela quantidade comercial de acordo com o  Manual do Contribuinte 6.00 realizado na tag <vUnCom>(ConvType(aProd[10]/aProd[09],21,8)) \r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_NUMLOTE,;//Numero do Lote\r\n\t\t\t\t\t\t\t   \tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).E devolução com IPI. (Nota de compl.Ipi de uma devolução de compra(MV_IPIDEV=F) leva o IPI em voutros)\r\n\t\t\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\t\t\tIIF((SF4->F4_AGREG='N' .And. !AllTrim(SF4->F4_CF) $ cMVCfopTran) .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\"),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_TES,;\r\n\t\t\t\t\t\t\t\tIIF(SB5->(FieldPos(\"B5_PROTCON\"))<>0,SB5->B5_PROTCON,\"\"),; //Campo criado para informar protocolo ou convenio ICMS \r\n\t\t\t\t\t\t\t\tIIf(SubStr(SM0->M0_CODMUN,1,2) == \"35\" .And. cTpPessoa == \"EP\" .And. nDescIcm > 0, nDescIcm,0),;   \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTIMP\"))<>0,(cAliasSD2)->D2_TOTIMP,0),;   //aProd[30] - Total imposto carga tributária. \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFP,;\t\t\t//aProd[31] - Desconto Zona Franca PIS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFC,;\t\t\t//aProd[32] - Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PICM,;\t\t//aProd[33] - Percentual de ICMS\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;  //aProd[34]\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTFED\"))<>0,(cAliasSD2)->D2_TOTFED,0),;   //aProd[35] - Total carga tributária Federal\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTEST\"))<>0,(cAliasSD2)->D2_TOTEST,0),;   //aProd[36] - Total carga tributária Estadual\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTMUN\"))<>0,(cAliasSD2)->D2_TOTMUN,0),;   //aProd[37] - Total carga tributária Municipal\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PEDIDO,;\t //aProd[38] \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_ITEMPV,;\t //aProd[39] \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_GRPCST\")) > 0 .and. !Empty((cAliasSD2)->D2_GRPCST),(cAliasSD2)->D2_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //aProd[40]\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aProd[41] NT2015/003\r\n\t\t\t\t\t\t\t\t\"\",; //aprod[42] apenas na entrada é utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\t\t\tnValIFecp,; //aprod[43]  Valor do FECP.\r\n\t\t\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),;//aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),;  //aprod[46]\r\n\t\t\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\t\t\tSF4->F4_ART274,;  //aprod[48]\r\n\t\t\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aCST,{cCSTrib,cOrigem})\r\n\t\t\t\t\t\taadd(aICMS,{})\r\n\t\t\t\t\t\taadd(aIPI,{})\r\n\t\t\t\t\t\taadd(aICMSST,{})\r\n\t\t\t\t\t\taadd(aPIS,{})\r\n\t\t\t\t\t\taadd(aPISST,{})\r\n\t\t\t\t\t\taadd(aCOFINS,{})\r\n\t\t\t\t\t\taadd(aCOFINSST,{})\r\n\t\t\t\t\t\taadd(aISSQN,{})\r\n\t\t\t\t\t\taadd(aAdi,{})\r\n\t\t\t\t\t\taadd(aDi,{})\r\n\t\t\t\t\t\taadd(aICMUFDest,{})\r\n\t\t\t\t\t\taadd(aIPIDevol,{})\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//aadd(aPedCom,{})\r\n\t\t\t\t\t\taadd(aPisAlqZ,{})\r\n\t\t\t\t\t\taadd(aCofAlqZ,{})\r\n\t\t\t\t\t\taadd(aCsosn,{})\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcNCM := SB1->B1_POSIPI\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para TAG Exportação quando existe a integração com a EEC     ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf lEECFAT\r\n\t\t\t\t\t\t\t/*Alterações TQXWO2\r\n\t\t\t\t\t\t\tNa chamada da função, foram criados dois novos parâmetros: \r\n\t\t\t\t\t\t\to 3º referente ao código do produto e o 4º referente ao número da nota fiscal + série (chave).\r\n\t\t\t\t\t\t\tGetNfeExp(pProcesso, pPedido, cProduto, cChave)\r\n\t\t\t\t\t\t\tNo retorno da função serão devolvidas as informações do legado, conforme leiaute anterior à versão 3.10 , \r\n\t\t\t\t\t\t\te as informações dos grupos “I03 - Produtos e Serviços / Grupo de Exportação” e “ZA - Informações de Comércio Exterior”, conforme estrutura da NT20013.005_v1.21.\r\n\t\t\t\t\t\t\tAs posições 1 e 2 mantém o retorno das informações ZA02 e ZA03, mantendo o legado para os cliente que utilizam versão 2.00\r\n\t\t\t\t\t\t\tNa posição 3 passa a ser enviado o agrupamento do ID I50, tendo como filhos os IDs I51 e I52.\r\n\t\t\t\t\t\t\tNa posição 4 passa a ser enviado o agrupamento do ZA01, tendo como filhos os IDs ZA02, ZA03 e ZA04.\r\n\t\t\t\t\t\t\tNa posição 5 passa a ser enviado informaçãoes para o grupo \"BA02 - Chaves Nfe referenciadas\" as chaves de notas fiscais de saída de lote de exportação associadas à nota de saída de exportação.\r\n\t\t\t\t\t\t\tO array de retorno será multimensional, trazendo na primeira posição o identificador (ID), \r\n\t\t\t\t\t\t\tna segunda posição a tag (o campo) e na terceira posição o conteúdo retornado do processo, \r\n\t\t\t\t\t\t\tpodendo ser um outro array com a mesma estrutura caso o ID possua abaixo de sua estrutura outros IDs. \t\t\t\t\t\t \t\t\t\t\r\n\t\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\t/*Alterações TUSHX4\r\n\t\t\t\t\t\t\tFoi incluido o parametro D2_LOTECTL para que a função localize as notas de entrada (produto com lote e endereçamento) amarradas no pedido de exportção e consiga\r\n\t\t\t\t\t\t\tretornar o array de exportind de acordo com a quantidade de cada item da SD2, para não ocorrer a rejeição \r\n\t\t\t\t\t\t\t346 Somatório das quantidades informadas na Exportação Indireta não correspondem a quantidade do item.*/\r\n\t\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_PREEMB)\r\n\t\t\t\t\t\t\t\taadd(aExp,(GETNFEEXP((cAliasSD2)->D2_PREEMB,,cCodProd,(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE,(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV,(cAliasSD2)->D2_LOTECTL)))\r\n\t\t\t\t\t\t\tElseIf !Empty(SC5->C5_PEDEXP)\r\n\t\t\t\t\t\t\t\taADD(aExp,(GETNFEEXP(,SC5->C5_PEDEXP,cCodProd,(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE,(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV,(cAliasSD2)->D2_LOTECTL)))\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElseiF AliasIndic(\"CDL\")\r\n\t\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\t\tDbSelectArea(\"CDL\")\r\n\t\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\tDbSeek(xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\t\t\t\t\t\tWhile !CDL->(Eof()) .And. CDL->CDL_FILIAL+CDL->CDL_DOC+CDL->CDL_SERIE+CDL->CDL_CLIENT+CDL->CDL_LOJA == xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA\r\n\t\t\t\t\t\t    \tIf CDL->(FieldPos(\"CDL_PRODNF\")) <> 0 .And. CDL->(FieldPos(\"CDL_ITEMNF\")) <> 0 .And. AllTrim(CDL->CDL_PRODNF)+AllTrim(CDL->CDL_ITEMNF) == AllTrim((cAliasSD2)->D2_COD)+AllTrim((cAliasSD2)->D2_ITEM)\r\n\t\t\t\t\t\t\t    \taDados := {}\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"ZA02\",\"ufEmbarq\"  , IIF(CDL->(FieldPos(\"CDL_UFEMB\"))<>0 , CDL->CDL_UFEMB  ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"ZA03\",\"xLocEmbarq\", IIF(CDL->(FieldPos(\"CDL_LOCEMB\"))<>0, CDL->CDL_LOCEMB ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I51\",\"nDraw\", IIF(CDL->(FieldPos(\"CDL_ACDRAW\"))<>0, CDL->CDL_ACDRAW ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I53\",\"nRE\", IIF(CDL->(FieldPos(\"CDL_NRREG\"))<>0, CDL->CDL_NRREG ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I54\",\"chNFe\", IIF(CDL->(FieldPos(\"CDL_CHVEXP\"))<>0, CDL->CDL_CHVEXP ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I55\",\"qExport\", IIF(CDL->(FieldPos(\"CDL_QTDEXP\"))<>0, CDL->CDL_QTDEXP ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"ZA04\",\"xLocDespacho\", IIF(CDL->(FieldPos(\"CDL_LOCDES\"))<>0, CDL->CDL_LOCDES ,\"\") })\r\n\t\t\t\t\t\t\t\t\taAdd(aDados,{\"NAT_EXP\",\"Natureza\", IIF(CDL->(FieldPos(\"CDL_NATEXP\"))<>0, CDL->CDL_NATEXP ,\"\") }) //Adicionado para utilizar na verificação da montagem das tags do grupo de exportação indireta (I52 - exportind) substituindo o I53 - nRE.\r\n\r\n\t\t\t\t\t\t\t    \taAdd(aExp[Len(aExp)],aDados)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\t\t    \tCDL->(DbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0  .And. CD6->(FieldPos(\"CD6_BCCIDE\")) > 0 .And. CD6->(FieldPos(\"CD6_VALIQ\")) > 0 .And. CD6->(FieldPos(\"CD6_VCIDE\")) > 0\r\n\t\t\t\t\t\t\taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_UFCONS,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_BCCIDE,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_VALIQ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_VCIDE,;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_MIXGN\")) > 0,CD6->CD6_MIXGN,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_BICO\")) > 0,CD6->CD6_BICO,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_BOMBA\")) > 0,CD6->CD6_BOMBA,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_TANQUE\")) > 0,CD6->CD6_TANQUE,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_ENCINI\")) > 0,CD6->CD6_ENCINI,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_ENCFIN\")) > 0,CD6->CD6_ENCFIN,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_DESANP\")) > 0,CD6->CD6_DESANP,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_PGLP\")) > 0,CD6->CD6_PGLP,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_PGNN\")) > 0,CD6->CD6_PGNN,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_PGNI\")) > 0,CD6->CD6_PGNI,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_VPART\")) > 0,CD6->CD6_VPART,\"\"),;\r\n\t\t\t\t\t\t\t\tnBRICMSO,;\r\n\t\t\t\t\t\t\t\tnICMRETO,;\r\n\t\t\t\t\t\t\t\tnBRICMSD,;\r\n\t\t\t\t\t\t\t\tnICMRETD,;\r\n\t\t\t\t\t\t\t\tnAliqST})\r\n\r\n\t\t\t\t\t    Elseif AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0 \r\n\t\t\t\t\t    \taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_UFCONS,; \r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\tnBRICMSO,;\r\n\t\t\t\t\t\t\t\tnICMRETO,; \r\n\t\t\t\t\t\t\t\tnBRICMSD,;\r\n\t\t\t\t\t\t\t\tnICMRETD,;\r\n\t\t\t\t\t\t\t\tnAliqST})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aComb,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf AliasIndic(\"CD7\")\r\n\t\t\t\t\t\t\taadd(aMed,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,CD7->CD7_PRECO,IIf(CD7->(ColumnPos(\"CD7_CODANV\")) > 0,CD7->CD7_CODANV,\"\"),IIf(CD7->(ColumnPos(\"CD7_MOTISE\")) > 0,CD7->CD7_MOTISE,\"\")})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aMed,{})\r\n\t\t\t   \t\t\tEndIf\r\n\t\t\t   \t\t\tIf AliasIndic(\"CD8\")\r\n\t\t\t\t\t\t\taadd(aArma,{CD8->CD8_TPARMA,CD8->CD8_NUMARM,CD8->CD8_DESCR})                       \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aArma,{})\r\n\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\tIf AliasIndic(\"CD9\")    \t\r\n\t\t\t\t\t\t\taadd(aveicProd,{IIF(CD9->CD9_TPOPER$\"03\",1,IIF(CD9->CD9_TPOPER$\"1\",2,IIF(CD9->CD9_TPOPER$\"2\",3,IIF(CD9->CD9_TPOPER$\"9\",0,\"\")))),;\r\n\t\t\t\t\t\t\t\t\t\t\tCD9->CD9_CHASSI,CD9->CD9_CODCOR,CD9->CD9_DSCCOR,CD9->CD9_POTENC,CD9->CD9_CM3POT,CD9->CD9_PESOLI,;\r\n\t\t\t\t\t\t\t                CD9->CD9_PESOBR,CD9->CD9_SERIAL,CD9->CD9_TPCOMB,CD9->CD9_NMOTOR,CD9->CD9_CMKG,CD9->CD9_DISTEI,CD9->CD9_RENAVA,;\r\n\t\t\t\t\t\t\t                CD9->CD9_ANOMOD,CD9->CD9_ANOFAB,CD9->CD9_TPPINT,CD9->CD9_TPVEIC,CD9->CD9_ESPVEI,CD9->CD9_CONVIN,CD9->CD9_CONVEI,;\r\n\t\t\t\t\t\t\t                CD9->CD9_CODMOD,;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CILIND\")>0,CD9_CILIND,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_TRACAO\")>0,CD9_TRACAO,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_LOTAC\")>0,CD9_LOTAC,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CORDE\")>0,CD9_CORDE,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_RESTR\")>0,CD9_RESTR,\"\"))})\r\n\t\t\t\t\t\t\tlVeicNovo:= (!empty(CD9->CD9_CHASSI))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t    aadd(aveicProd,{})\r\n\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para Rastreamento de Lote - Cabecalho e Itens   \r\n\t\t\t\t\t\t//Primeiro busca no compl. de rastreabilidade (F0A) e  depois compl.de medicamento (CD7)                ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\t\t\t\t\t\tIf AliasIndic(\"F0A\") .AND. F0A->(FieldPos(\"F0A_LOTE\")) > 0 .And. !Empty(F0A->F0A_LOTE)\r\n\t\t\t\t\t\t\taadd(aLote,{IIf(F0A->(FieldPos(\"F0A_LOTE\")) > 0,F0A->F0A_LOTE,\"\"),;\r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_QTDLOT\")) > 0,F0A->F0A_QTDLOT,\"\"),;\r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_FABRIC\")) > 0,F0A->F0A_FABRIC,\"\"),;\r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_VALID\")) > 0,F0A->F0A_VALID ,\"\"),;  \r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_CODAGR\")) > 0,F0A->F0A_CODAGR ,\"\")})  \r\n\t\t\t\t\t\tElseIf !Empty(aMed) .And. !Empty(aMed[1][1])\r\n\t\t\t\t\t\t\taadd(aLote,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,\"\"})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aLote,{})\r\n\t   \t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para Anfavea - Cabecalho e Itens                             ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\r\n\t\t\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t\t\t//Cabecalho\r\n\t\t\t\t\t\t\taAnfC := {}\r\n\t\t\t\t\t\t\taadd(aAnfC,{CDR->CDR_VERSAO,CDR->CDR_CDTRAN,CDR->CDR_NMTRAN,CDR->CDR_CDRECP,CDR->CDR_NMRECP,;\r\n\t\t\t\t\t\t\t\tAModNot(CDR->CDR_ESPEC),CDR->CDR_CDENT,CDR->CDR_DTENT,CDR->CDR_NUMINV}) \r\n\t\t\t\t\t\t\t//Itens\r\n\t\t\t\t\t\t\taadd(aAnfI,{CDS->CDS_PRODUT,CDS->CDS_PEDCOM,CDS->CDS_SGLPED,CDS->CDS_SEPPEN,CDS->CDS_TPFORN,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_UM,CDS->CDS_DTVALI,CDS->CDS_PEDREV,CDS->CDS_CDPAIS,CDS->CDS_PBRUTO,CDS->CDS_PLIQUI,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_TPCHAM,CDS->CDS_NUMCHA,CDS->CDS_DTCHAM,CDS->CDS_QTDEMB,CDS->CDS_QTDIT,CDS->CDS_LOCENT,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_PTUSO,CDS->CDS_TPTRAN,CDS->CDS_LOTE,CDS->CDS_CPI,CDS->CDS_NFEMB,CDS->CDS_SEREMB,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_CDEMB,CDS->CDS_AUTFAT,CDS->CDS_CDITEM})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aAnfC,{})\r\n\t\t\t\t\t\t\taadd(aAnfI,{})\r\n\t\t\t   \t\t\tEndIf\t\t\t\t\r\n\t\r\n\t\t\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t\t\tIf !Empty(aAnfC) .And. !Empty(aAnfC[01,01]) .And. lCabAnf\r\n\t\t\t\t\t\t\t\tlCabAnf := .F.\r\n\t\t\t\t\t\t\t\tcAnfavea := '<![CDATA[[' \r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,01])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' <versao>' + allTrim(aAnfC[01,01]) + '</versao>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tcAnfavea += \t'<transmissor'\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,02])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' codigo=\"' + allTrim(aAnfC[01,02]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,03])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' nome=\"' + allTrim(aAnfC[01,03]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t    cAnfavea += '/><receptor'\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,04])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' codigo=\"' + allTrim(aAnfC[01,04]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,05])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' nome=\"' + allTrim(aAnfC[01,05]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t    cAnfavea += '/>'\t\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,06])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<especieNF>' + allTrim(aAnfC[01,06]) + '</especieNF>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,07])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<fabEntrega>' + allTrim(aAnfC[01,07]) + '</fabEntrega>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,08])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<prevEntrega>' + allTrim(Dtos(aAnfC[01,08])) + '</prevEntrega>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,09])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<Invoice>' + allTrim(aAnfC[01,09]) + '</Invoice>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tcAnfavea +=\t']]>'\r\n\t\t\t\t\t\t\tEndif  \r\n\t\t\t\t\t\tEndif\r\n\t\r\n\t\t\t\t\t\tDbSelectArea(\"SF2\")\r\n\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SF2\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\t\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\t\tIf !(cAliasSD2)->D2_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tdbSetOrder(2)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t    \r\n\t\t\t\t\t    DbSelectArea(\"SFT\")\r\n\t\t\t\t\t    DbSetOrder(1)\r\n\t\t\t\t\t    If SFT->(DbSeek(xFilial(\"SFT\")+\"S\"+(cAliasSD2)->(D2_SERIE+D2_DOC+D2_CLIENTE+D2_LOJA+PadR(D2_ITEM,TamSx3(\"FT_ITEM\")[1])+D2_COD)))\r\n\t\t\t\t\t\t   If !Empty( SFT->FT_CTIPI )\r\n\t\t\t\t\t\t   \t\taadd(aCSTIPI,{SFT->FT_CTIPI})\r\n\t\t\t\t\t\t   EndIf\r\n\t\t\t\t\t\t   //TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t\t\t\t   //PEGA OS VALORES E PERCENTUAL DO INNCENTIVO NOS ITENS NA SFT.\r\n\t\t\t\t\t\t   If SFT->(FieldPos(\"FT_PRINCMG\")) > 0 .And. SFT->(FieldPos(\"FT_VLINCMG\")) > 0\r\n\t\t\t\t\t\t\t\tIf SFT->FT_VLINCMG > 0\r\n\t\t\t\t\t\t\t\t\tnValLeite += SFT->FT_VLINCMG\r\n\t\t\t\t\t\t\t\t\t aprod[Len(aProd)][49]:=  SFT->FT_VLINCMG\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tIf nPercLeite == 0 .And. SFT->FT_PRINCMG > 0 \r\n\t\t\t\t\t\t\t\t\tnPercLeite := SFT->FT_PRINCMG\r\n\t\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t     \r\n\t\t\t\t\t\tCD2->(dbSeek(xFilial(\"CD2\")+\"S\"+SF2->F2_SERIE+SF2->F2_DOC+SF2->F2_CLIENTE+SF2->F2_LOJA+PadR((cAliasSD2)->D2_ITEM,4)+(cAliasSD2)->D2_COD))\r\n\t\t\t\r\n\t\t\t\t\t\tWhile CD2->(!Eof()) .And. xFilial(\"CD2\") == CD2->CD2_FILIAL .And.;\r\n\t\t\t\t\t\t\t\"S\" == CD2->CD2_TPMOV .And.;\r\n\t\t\t\t\t\t\tSF2->F2_SERIE == CD2->CD2_SERIE .And.;\r\n\t\t\t\t\t\t\tSF2->F2_DOC == CD2->CD2_DOC .And.;\r\n\t\t\t\t\t\t\tSF2->F2_CLIENTE == IIF(!(cAliasSD2)->D2_TIPO $ \"DB\",CD2->CD2_CODCLI,CD2->CD2_CODFOR) .And.;\r\n\t\t\t\t\t\t\tSF2->F2_LOJA == IIF(!(cAliasSD2)->D2_TIPO $ \"DB\",CD2->CD2_LOJCLI,CD2->CD2_LOJFOR) .And.;\r\n\t\t\t\t\t\t\t(cAliasSD2)->D2_ITEM == SubStr(CD2->CD2_ITEM,1,Len((cAliasSD2)->D2_ITEM)) .And.;\r\n\t\t\t\t\t\t\tAlltrim((cAliasSD2)->D2_COD) == Alltrim(CD2->CD2_CODPRO)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t    nMargem :=  IiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC == 100,CD2->CD2_PREDBC,IF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC)),CD2->CD2_PREDBC)              \t\t \t\t\t\t\t\r\n\t\r\n\t\t\t\t\t\t\t/*DbSelectArea(\"SF7\")\t\t\t\t\r\n\t\t\t\t\t\t\tDbSetOrder(1)\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf DbSeek(xFilial(\"SF7\")+SB1->B1_GRTRIB+SA1->A1_GRPTRIB)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf SF7->F7_BASEICM > 0\r\n\t\t\t\t\t\t\t\t\t\tnMargem := SF7->F7_BASEICM\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf*/\t\t\r\n\t\t\t\t\t\t\tnValtrib:= CD2->CD2_VLTRIB\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//Alterado conteudo da variavel de CD2->CD2_VLTRIB para SFT->FT_VOPDIF - Para pegar valor de diferimento - Devido atualizacao do Fiscal\r\n\t\t\t\t\t\t\tIf SubStr((cAliasSD2)->D2_CLASFIS,2,2) $ '51' .and. !Empty(SFT->FT_ICMSDIF) .and. SFT->(ColumnPos(\"FT_VOPDIF\")) > 0  .and. !Empty(SFT->FT_VOPDIF)\r\n\t\t\t\t\t\t\t\tnValtrib:= Iif(cVerAmb == \"4.00\".and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','SFT','FT_VOPDIF'),SFT->FT_VOPDIF)\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tElseIf SFT->(FieldPos(\"FT_TRFICM\")) <> 0 .And. SFT->FT_TRFICM <> 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) $ \"RS/GO\"\r\n\t\t\t\t\t\t\t\tnValtrib:= Iif(cVerAmb == \"4.00\".and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','SFT','FT_TRFICM'),SFT->FT_TRFICM)\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tnValtrib:= Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'),CD2->CD2_VLTRIB)\t\r\n\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Verifica se existe percentual de reducao na SFT referête ao RICMS 43080/2002 MG.\r\n\t\t\t\t\t\t\tIf SFT->(FieldPos(\"FT_PR43080\")) <> 0 .And. SFT->FT_PR43080 <> 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\t\t\t\tnMargem := SFT->FT_PR43080\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tDo Case\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ICM\"\r\n\t\t\t\t\t\t\t\t\taTail(aICMS) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t   If(lNfCupZero,SF4->F4_SITTRIB,CD2->CD2_CST),;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t   CD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t                   If(lNfCupZero,0,nMargem),;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t   If(lNfCupZero .Or. lIcmsPR,0,CD2->CD2_BC),;\r\n\t\t\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), If(lNfCupZero,0,Iif(CD2->CD2_BC>0,xFisRetFCP('4.0','CD2','CD2_ALIQ'),0)), If(lNfCupZero,0,Iif(CD2->CD2_BC>0,CD2->CD2_ALIQ,0))),;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero .Or. lIcmsPR,0,nValtrib),;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\"),;\r\n\t\t\t\t\t\t\t\t\tSFT->FT_ICMSDIF,;\r\n\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\tSF4->F4_ICMSDIF,;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,xFisRetFCP('4.0','CD2','CD2_BFCP'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,xFisRetFCP('4.0','CD2','CD2_PFCP'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,xFisRetFCP('4.0','CD2','CD2_VFCP'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BSTANT\")) > 0,SFT->FT_BSTANT,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_VSTANT'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_PSTANT'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BFCANTS\")) > 0,SFT->FT_BFCANTS,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PFCANTS\")) > 0,SFT->FT_PFCANTS,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VFCANTS\")) > 0,SFT->FT_VFCANTS,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VICPRST\")) > 0,SFT->FT_VICPRST,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,0)}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\t\t\tnValICMParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\t\t\tnBasICMParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017) \r\n\t\t\t\t\t\t\t\t\tIf \tlIcmsPR \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tnToTvBC \t+= \tCD2->CD2_BC \t\t//aICMS[05]\t\r\n\t\t\t\t\t\t\t\t\t\tnToTvICMS\t+=\tCD2->CD2_VLTRIB\t//aICMS[07]   \r\n\t\t\t\t\t\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"SOL\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aICMSST) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero,SF4->F4_SITTRIB,CD2->CD2_CST),;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero,0,IiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC),CD2->CD2_PREDBC)),;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero,0,CD2->CD2_BC),;\r\n\t\t\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_ALIQ'), If(lNfCupZero,0,CD2->CD2_ALIQ)),; \r\n\t\t\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'), If(lNfCupZero,0,CD2->CD2_VLTRIB)),; \r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,CD2->CD2_BFCP,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,CD2->CD2_PFCP,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,CD2->CD2_VFCP,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\")}\r\n\r\n\t\t\t\t\t\t\t\t\tIf lConsig .And. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM)  .And. CD2->CD2_VLTRIB > 0\r\n\t\t\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\"))>0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\")}\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t\t\t\tlCalSol := .T.\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Tratamento CAT04 de 26/02/2010                       ³\r\n\t\t\t\t\t\t\t\t\t//³Verifica de deve ser garavado no xml o valor e base  ³\r\n\t\t\t\t\t\t\t\t\t//³de calculo do ICMS ST para notas fiscais de devolucao³\r\n\t\t\t\t\t\t\t\t\t//³Verifica o parametro MV_ICSTDEV                      ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tnValST \t:= Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'), CD2->CD2_VLTRIB)\r\n\t\t\t\t\t\t\t\t\t//para a 4.0 devera exibir a informação Valor do ICMS ST não majorado.\r\n\t\t\t\t\t\t\t\t\tIf cVerAmb == \"4.00\" .and. nValST > 0 .And. lConsig\r\n\t\t\t\t\t\t\t\t\t\tnSTConsig += nValST\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf !lIcmSTDev\r\n\t\t\t\t\t\t\t\t\t\tIf ( (cAliasSD2)->D2_TIPO==\"D\" .Or. ( (cAliasSD2)->D2_TIPO==\"I\" .And. lComplDev)) .And. !Empty(nValST) \r\n\t\t\t\t\t\t\t\t\t\t\tnValSTAux := nValSTAux + nValST\r\n\t\t\t\t\t\t\t\t\t\t\tnBsCalcST := nBsCalcST + CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\t\t\tnValST \t  := 0\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\"))>0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\")}\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\t\t\tnValSTParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\t\t\tnBasSTParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"IPI\"\r\n\t\t\t\t\t\t\t\t\t//If !lConsig\r\n\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,;\r\n\t\t\t\t\t\t\t\t\t\tSB1->B1_CLASSE,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),; //NT2015/002\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_BC,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_ALIQ,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_VLTRIB,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t\tIiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC),CD2->CD2_PREDBC)}\r\n\t\t\t\t\t\t\t\t\t\tnValIPI := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\t\t\tIf (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .And. !Empty(nValIPI) \r\n\t\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0  .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,0,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,0}\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\tIf (!lIpiDev .OR. lIPIOutro) .And. !(Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .OR. ((cAliasSD2)->D2_TIPO==\"B\" .And. (lIpiBenef .OR. lIPIOutB))  \r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tIf ( (cAliasSD2)->D2_TIPO==\"B\" .And. lIpiBenef .and. !Empty(nValIPI) )\r\n\t\t\t\t\t\t\t\t\t\t\t\tnValIpiBene += nValIPI  // Quando lIpiBenef = T leva IPI em vOutro e Inf. Adic.\r\n\t\t\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,0,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,0}\r\n\t\t\t\t\t\t\t\t\t\t\tElseIf ( (cAliasSD2)->D2_TIPO==\"D\" .And. !Empty(nValIPI) ).OR. ( (cAliasSD2)->D2_TIPO==\"P\" .And. lComplDev .And. !Empty(nValIPI) ) \r\n\t\t\t\t\t\t\t\t\t\t\t\taAdd(aIPIDev, {nValIPI,cNCM})\r\n\t\t\t\t\t\t\t\t\t\t\t\tnValIPI := 0\r\n\t\t\t\t\t\t\t\t\t\t\t\tcNCM\t:= \"\"\r\n\t\t\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,0,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,0}\r\n\t\t\t\t\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t\t\t/*Chamado TTVZJG - Grupo impostoDevol - informar o percentual e valor do IPI devolvido, em notas de devolução (finNFe =4)\r\n\t\t\t\t\t\t\t\tIncluida a verificação do campo F4_PODER3=D para os casos de retorno de beneficiamento*/\r\n\t\t\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO == \"D\" .or. SF4->F4_PODER3 == \"D\") .and. ((CD2->(FieldPos(\"CD2_PDEVOL\")) > 0 .and. !Empty(CD2->CD2_PDEVOL) .Or. (SF4->F4_QTDZERO == \"1\")) .And. cTPNota == \"4\")\r\n\t\t\t\t\t\t\t\t\tIf (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM ) \r\n\t\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\t\tElseIf cVerAmb >= \"4.00\" .and. (((cAliasSD2)->D2_TIPO == \"D\" .and. (lIpiDev .Or. lIPIOutro)) .or. ((cAliasSD2)->D2_TIPO == \"B\" .and. (!lIpiBenef .or. lIPIOutB))) \r\n\t\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,0}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS2\"\r\n\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\taTail(aPIS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tIf aAgrPis[Len(aAgrPis)][1]\r\n\t\t\t\t\t\t\t\t\t\t\taAgrPis[Len(aAgrPis)][2] := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aPIS) := {SF4->F4_CSTPIS,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF2\"\r\n\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\taTail(aCOFINS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tIf aAgrCofins[Len(aAgrCofins)][1]\r\n\t\t\t\t\t\t\t\t\t\t\taAgrCofins[Len(aAgrCofins)][2] := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aCOFINS) := {SF4->F4_CSTCOF,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS3\" .And. (cAliasSD2)->D2_VALISS==0\r\n\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\taTail(aPISST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aPISST) := {SF4->F4_CSTPIS,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\t\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF3\" .And. (cAliasSD2)->D2_VALISS==0\r\n\t\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\t\taTail(aCOFINSST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\taTail(aCOFINSST) := {SF4->F4_CSTCOF,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ISS\" \r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\taISS[01] += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_DESCON\r\n\t\t\t\t\t\t\t\t\taISS[02] += CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\taISS[03] += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\t\t\tcMunISS := ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[09]})][02]+aDest[07])\r\n\t\t\t\t\t\t\t\t\t/* (Inicio) Alterado em 04/04/2019 por Felipe Azevedo - Desenvolvimento TSS NFS-e\r\n\t\t\t\t\t\t\t\t\t//\r\n\t\t\t\t\t\t\t\t\t//Conjunto de Alterações 229221 - Aline Yumi Kokumai - 21/05/2014 18:27:45 - Inclusão do fonte para manter o histórico.\r\n\r\n\t\t\t\t\t\t\t\t\tA condição da validação do Codigo do ISS passou a ser Verdadeira (.T.) \r\n\t\t\t\t\t\t\t\t\tdevido as rotinas do REINF ter começado a popular a tabela CDN causando\r\n\t\t\t\t\t\t\t\t\terro em municipios especificos.\r\n\t\t\t\t\t\t\t\t\tPortanto será mantido o legado da tabela CDN, porém para emissão de NF-e\r\n\t\t\t\t\t\t\t\t\tconjugada será considerado o \"Código de serviço da Nota fiscal eletônica\" (SD2).\r\n\r\n\t\t\t\t\t\t\t\t\t[Antes]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t\tcCodIss := AllTrim((cAliasSD2)->D2_CODISS)\r\n\t\t\t\t\t\t\t\t\tIf AliasIndic(\"CDN\") .And. CDN->(dbSeek(xFilial(\"CDN\")+cCodIss))\r\n\t\t\t\t\t\t\t\t\t\tcCodIss := AllTrim(CDN->CDN_CODLST)\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t[Depois] */\r\n\t\t\t\t\t\t\t\t\tcCodIss := AllTrim((cAliasSD2)->D2_CODISS)\r\n\t\t\t\t\t\t\t\t\tIf AliasIndic(\"CDN\") .And. CDN->(dbSeek(xFilial(\"CDN\")+cCodIss))\r\n\t\t\t\t\t\t\t\t\t\tcCodIss := AllTrim(CDN->CDN_CODISS)\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t//\r\n\t\t\t\t\t\t\t\t\t// (Fim) Alterado em 04/04/2019 por Felipe Azevedo - Desenvolvimento TSS NFS-e\r\n\t\t\t\t\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t\t\tIf SF3->F3_RECISS ==\"1\" \r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib := \"R\"\r\n\t\t\t\t\t\t\t\t\t\tElseif SF3->F3_RECISS ==\"2\" //.and. ( !SF4->F4_LFISS == \"I\" .and. !SM0->M0_ESTENT == \"\" )\r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\t\t\tElseif SF4->F4_LFISS ==\"I\"\r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib:= \"I\"\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIF SF4->F4_ISSST == \"1\" .or. Empty(SF4->F4_ISSST)\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"1\" //1-Exigível;\r\n\t\t\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"2\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"2\"\t//2-Não incidência\r\n\t\t\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"3\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"3\" //3-Isenção\r\n\t\t\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"4\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"5\"\t //5-Imunidade\r\n\t\t\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"5\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"6\"\t //6-Exigibilidade Suspensa por Decisão Judicial\r\n\t\t\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"6\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"7\"\t //7-Exigibilidade Suspensa por Processo Administrativo\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"4\"//4-Exportação\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Pega as deduções ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSSUB\")) > 0\r\n\t\t\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSSUB\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSMAT\")) > 0\r\n\t\t\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSMAT\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Verifica se recolhe ISS Retido ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t\t\t\tIf SF3->F3_RECISS $\"1|S\"  \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tnValISSRet := SFT->FT_VALICM // Valor do ISSRET por item\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t/*If SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t\t\t\tIf SF3->F3_RECISS $\"1S\"       \r\n\t\t\t\t\t\t\t\t\t\t\tIf SF3->(dbSeek(xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE))\r\n\t\t\t\t\t\t\t\t\t\t\t\tWhile !SF3->(EOF()) .And. xFilial(\"SF3\")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE==SF2->F2_FILIAL+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tIf SF3->F3_TIPO==\"S\" //Serviço\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnValISSRet+= SF3->F3_VALICM\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tSF3->(dbSkip())\r\n\t\t\t\t\t\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t   \t\tEndif\r\n\t\t\t\t\t\t\t\t\tEndIf*/\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aISSQN) := {CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,cMunISS,cCodIss,cSitTrib,nDeducao,cIndIss,nValISSRet}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CMP\" //ICMSUFDEST\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aICMUFDest) := {IIf(CD2->CD2_BC > 0,CD2->CD2_BC, 0),; //[1]vBCUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PFCP\")) > 0 .and. CD2->CD2_PFCP > 0,CD2->CD2_PFCP,0),;  //[2]pFCPUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->CD2_ALIQ > 0,CD2->CD2_ALIQ,0),;//[3]pICMSUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_ADIF\")) > 0 .and. CD2->CD2_ADIF > 0,CD2->CD2_ADIF,0),;//[4]pICMSInter\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PDDES\")) > 0 .and. CD2->CD2_PDDES > 0,CD2->CD2_PDDES,0),;//[5]pICMSInterPart\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VFCP\")) > 0 .and. CD2->CD2_VFCP > 0,CD2->CD2_VFCP,0),;//[6]vFCPUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VDDES\")) > 0 .and. CD2->CD2_VDDES > 0,CD2->CD2_VDDES,0),;//[7]vICMSUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VLTRIB\")) > 0 .and. CD2->CD2_VLTRIB > 0,CD2->CD2_VLTRIB,0)}//[8]vICMSUFRemet\r\n\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"TST\" \r\n\r\n\t\t\t\t\t\t\t\t\tnBCTot += IIf(CD2->CD2_BC > 0,CD2->CD2_BC,0)\t\t\t\t//Total Base de Calculo\r\n\t\t\t\t\t\t\t\t\tnALIQTot += IIf(CD2->CD2_ALIQ > 0,CD2->CD2_ALIQ,0)\t\t\t//Total de aliquota\r\n\t\t\t\t\t\t\t\t\tnVLTRIBTot += IIf(CD2->CD2_VLTRIB > 0,CD2->CD2_VLTRIB,0)\t//Total do valor tributado\r\n\r\n\t\t\t\t\t\t\t\t\t//Preenchimento da Tag <retTransp>\r\n\t\t\t\t\t\t\t\t\taImp := {;\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SC5->C5_FRETAUT > 0,SC5->C5_FRETAUT,0),;\t\t//vServ - Valor do Serviço\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIf(SC5->(ColumnPos(\"C5_FRTCFOP\")) > 0 .And. !Empty(SC5->C5_FRTCFOP) ,SC5->C5_FRTCFOP,\"\"),; \t//CFOP\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIf(!Empty(cMunTransp),cMunTransp,0),;\t//cMunFG - Código do município de ocorrência do fato gerador do ICMS do transporte\r\n\t\t\t\t\t\t\t\t\t\t\t\t0,;\t\t\t//CST - Não utiliza no manual do contribuinte v6.00\r\n\t\t\t\t\t\t\t\t\t\t\t\t0,;\t\t\t//MODBC - Não utiliza no manual do contribuinte v6.00\r\n\t\t\t\t\t\t\t\t\t\t\t\t0,;\t\t\t//PREDBC - Não utiliza no manual do contribuinte v6.00\r\n\t\t\t\t\t\t\t\t\t\t\t\tnBCTot,;\t//vBCRet - BC da Retenção do ICMS \r\n\t\t\t\t\t\t\t\t\t\t\t\tnALIQTot,;\t//pICMSRet - Alíquota da Retenção\r\n\t\t\t\t\t\t\t\t\t\t\t\tnVLTRIBTot;\t//vICMSRet - Valor do ICMS Retido\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ZFM\"\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tcICMSZFM := If(CD2->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,\"\")\r\n\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\tEndCase\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tEndDo\r\n\r\n\t\t\t\t\t\tIf SFT->FT_DESCZFR>0  .OR. !Empty(cICMSZFM)\r\n\t\t\t\t\t\t\taadd(aICMSZFM,{If(SFT->(ColumnPos(\"FT_DESCZFR\")) > 0,SFT->FT_DESCZFR,\"\"),;\r\n\t\t\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\"),;\r\n\t\t\t\t\t\t\tcICMSZFM})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aICMSZFM,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Tratamento para que o valor de PIS ST e COFINS ST venha a compor o valor total da tag vOutros  (NT 2011/004). E devolução de compra com IPI não tributado\r\n\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO == \"D\" .and. (!lIpiDev .OR. lIPIOutro))  .Or. lConsig .Or. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM ) .OR. ((cAliasSD2)->D2_TIPO == \"B\" .and. (lIpiBenef .OR. lIPIOutB)) .OR. ((cAliasSD2)->D2_TIPO==\"P\" .And. lComplDev .And. !lIpiDev)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO  == \"D\" .and.  lIPIOutro ) .or. ((cAliasSD2)->D2_TIPO  == \"B\" .and.  lIPIOutB)\r\n\t\t\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n                            EndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\t\t\taTotal[01] += 0\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taTotal[01] += (cAliasSD2)->D2_VALIPI\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\taTotal[01] += (cAliasSD2)->D2_DESPESA + (cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3 + nIcmsST + nCrdPres\r\n\t\t\t\t\t   \r\n\t\t\t\t\t\tIf (cAliasSD2)->D2_TIPO == \"I\"\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_ICMSRET > 0\r\n\t\t\t\t\t\t\t\taTotal[02] += (cAliasSD2)->D2_VALBRUT\r\n\t\t\t\t\t\t\tElseIf  ( (SF4->F4_AGREG == \"S\" .And. SF4->F4_AJUSTE == \"S\") .And. (\"RESSARCIMENTO\" $ Upper(cNatOper) .And. \"RESSARCIMENTO\" $ Upper(cDescProd)))\r\n\t\t\t\t\t\t\t\taTotal[02] += (cAliasSD2)->D2_TOTAL\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taTotal[02] += 0\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tElseIf (cAliasSD2)->D2_TIPO == \"N\" .And. AllTrim(SF4->F4_CF) $ cMVCfopTran\r\n\t\t\t\t\t\t\taTotal[02] += (cAliasSD2)->D2_TOTAL\r\n\t\t\t\t\t\tElseIf SF4->F4_PSCFST == \"1\" .And. SF4->F4_APSCFST == \"1\"\r\n\t\t\t\t\t\t\taTotal[02] += ((cAliasSD2)->D2_VALBRUT - ((cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3))\r\n\t\t\t\t\t\tElse\r\n\t\t                    aTotal[02] += (cAliasSD2)->D2_VALBRUT\r\n\t\t              EndIf\t\t\r\n\t\t              //Tratamento para que o valor de PIS ST,COFINS ST venha a compor o valor total da nota.\r\n\t\t\t\t\t\taTotal[03]+= (cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3\t\r\n\t\t\t\t\t\tIf findfunction( 'ColumnPos' )\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF SF4->(ColumnPos(\"F4_DIFAL\")) > 0 .And. SF4->F4_DIFAL == \"1\"\r\n\t\t\t\t\t\t\t\tlDifal := .T.\r\n\t\t\t\t\t\t\tEndIF \t\t\t\t\t\r\n\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\tMsgInfo(\"É necessário a atualização do sistema para a expedição mais recente.\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf (lCalSol .OR.  lMVCOMPET .OR. lDifal )\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE)\r\n\t\t\t\t\t\t\t\tcEstado := IIf(lVeicNovo,SF3->F3_ESTADO,(iif(aDest[09]<> nil,aDest[09],\"\" )))\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf At (cEstado, cMVSUBTRIB)>0\r\n\t\t\t\t\t\t\t\t\tnPosI\t:=\tAt (cEstado, cMVSUBTRIB)+2\r\n\t\t\t\t\t\t\t\t\tnPosF\t:=\tAt (\"/\", SubStr (cMVSUBTRIB, nPosI))-1\r\n\t\t\t\t\t\t\t\t\tnPosF\t:=\tIIf(nPosF<=0,len(cMVSUBTRIB),nPosF)\r\n\t\t\t\t\t\t\t\t\taAdd (aIEST, SubStr (cMVSUBTRIB, nPosI, nPosF))\t//01 - IE_ST\r\n\t\t\t\t\t\t\t\t\taAdd (aIEST,iif(aDest[14]<> nil,aDest[14],\"\" ))\t//IE Dest.\r\n\t\t\t\t\t\t\t\tElseif  lDifal\r\n\t\t\t\t\t\t\t\t\tIf AliasInDic(\"F0L\")\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"F0L\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"F0L\")+cEstado)\t//F0L_FILIAL, F0L_UF, F0L_INSCR, R_E_C_N_O_, D_E_L_E_T_\r\n\t\t\t\t\t\t\t\t\t\t\taAdd (aIEST, F0L->F0L_INSCR)\t\t\t\t\t  \t//01 - IE_ST DIFAL\r\n\t\t\t\t\t\t\t\t\t\t\taAdd (aIEST,iif(aDest[14]<> nil,aDest[14],\"\" ))\t//IE Dest.\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t    Endif\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SFT->(FieldPos(\"FT_CSTPIS\")) > 0 .And. SFT->(FieldPos(\"FT_CSTCOF\")) > 0\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"SFT\") //Livro Fiscal Por Item da NF\r\n\t\t\t\t\t\t\tdbSetOrder(1) //FT_FILIAL+FT_TIPOMOV+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM+FT_PRODUTO\r\n\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SFT\")+\"S\"+SF2->F2_SERIE+SF2->F2_DOC+SF2->F2_CLIENTE+SF2->F2_LOJA+PadR((cAliasSD2)->D2_ITEM,4)+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SFT->FT_CSTPIS)\r\n\t\t\t\t\t\t\t\t\taTail(aPisAlqZ):= {SFT->FT_CSTPIS}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SFT->FT_CSTCOF)\r\n\t\t\t\t\t\t\t\t\taTail(aCofAlqZ) := {SFT->FT_CSTCOF}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SF4->F4_CSTPIS)\r\n\t\t\t\t\t\t\t\taTail(aPisAlqZ):= {SF4->F4_CSTPIS}\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SF4->F4_CSTCOF)\r\n\t\t\t\t\t\t\t\taTail(aCofAlqZ):= {SF4->F4_CSTCOF}\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !len(aCofAlqZ)>0 .or. !len(aPisAlqZ)>0\r\n\t\t\t\t\t\t\taadd(aCofAlqZ,{})  \r\n\t\t\t\t\t   \t\taadd(aPisAlqZ,{})\t\t\t\t\t\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tIf SF4->(FieldPos(\"F4_CSOSN\"))>0\r\n\t\t\t\t\t\t\taTail(aCsosn):= SF4->F4_CSOSN\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taTail(aCsosn):= \"\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t   \t\t\r\n\t\t\t\t\t\tIf !len(aCsosn)>0 \r\n\t\t\t\t\t\t\taadd(aCsosn,\"\")  \r\n\t\t\t\t\t   \tEndif\r\n\t\t\t\t\tendif\t\r\n\t\r\n\t\t\t\t\tdbSelectArea(cAliasSD2)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t    EndDo \r\n\t\r\n\t\t\t\t//Tratamento para incluir a mensagem em informacoes adicionais do Suframa\r\n\t\t\t\tIf !Empty(aDest[15])\r\n\t\t\t\t// Msg Zona Franca de Manaus / ALC\r\n\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\tdbSeek (xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE)\r\n\t\t\t\t\tDo While !SF3->(Eof()) .AND. xFilial(\"SF3\") == SF3->F3_FILIAL .And.;\r\n\t\t\t\t\t\tSF2->F2_CLIENTE == SF3->F3_CLIEFOR .And. SF2->F2_LOJA == SF3->F3_LOJA .And.;\r\n\t\t\t\t\t\tSF2->F2_DOC == SF3->F3_NFISCAL .And. SF2->F2_SERIE == SF3->F3_SERIE\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnValBse += SF3->F3_VALOBSE\r\n\t\t\t\t\t\t\tSF3->(DbSkip ())\r\n\t   \t\t\t\tEndDo\t\t\r\n\t\t\t\t\tIf !SF2->F2_DESCZFR == 0 .or. ( lInfAdZF .and. nValBse > 0 )//Desnecessario seek redundante na SF3 pois o campo F2_DESCZFR ja possui os valores de ZFR de toda a venda\r\n\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t   cMensFis += \" \"\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\t\tIf lInfAdZF .And. (nValPisZF > 0 .Or. nValCofZF > 0)\r\n\t\t\t\t\t\t\tcMensFis += \"Descontos Ref. a Zona Franca de Manaus / ALC. ICMS - R$ \"+str(nValBse-SF2->F2_DESCONT-nValPisZF-nValCofZF,13,2)+\", PIS - R$ \"+ str(nValPisZF,13,2) +\"e COFINS - R$ \" +str(nValCofZF,13,2) \t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElseIF !lInfAdZF .And. (nValPisZF > 0 .Or. nValCofZF > 0) \r\n\t\t\t\t\t\t\tcMensFis += \"Desconto Ref. ao ICMS - Zona Franca de Manaus / ALC. R$ \"+str(nValBse-SF2->F2_DESCONT-nValPisZF-nValCofZF,13,2)\r\n\t\t\t\t\t    Else\r\n\t\t\t\t\t    \tcMensFis += \"Total do desconto Ref. a Zona Franca de Manaus / ALC. R$ \"+str(nValBse-SF2->F2_DESCONT,13,2)\r\n\t\t\t\t\t    EndIF\r\n\t\t\t\t\tEndIf \t\r\n\t\t\t\tEndIF\r\n\t\r\n\t\t\t\t//TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t\t//INSERE MSG EM INFADFISCO E SOMA NO TOTAL DA NOTA.\r\n\t\t\t\tIf nValLeite > 0 .And. nPercLeite > 0\r\n\t\t\t\t\tcMensFis += Alltrim(Str(nPercLeite,10,2))+'% Incentivo à produção e à industrialização do leite = R$ '+ Alltrim(Str(nValLeite,10,2))\r\n\t\t\t\t\taTotal[02] += nValLeite\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf Len(aIPIDev)>0\r\n\t\t\t    \tnX := 1\r\n\t\t\t\t\tDo While lOk\r\n\t\t\r\n\t\t\t\t\t   nValAux := aIPIDev[nX][1]               \r\n\t\t\t\t\t   cNCMAux := aIPIDev[nX][2]\r\n\t\t\t\t\t   \r\n\t\t\t\t\t   npos := aScan( aIPIAux,{|x| x[2]==cNCMAux})\r\n\t\t\t\t\t   IF npos >0\t\t\t\r\n\t\t\t\t\t\t\taIPIAux[npos][1]+=nValAux\r\n\t\t\t\t       Else\r\n\t\t\t\t\t\t\tAaDd(aIPIAux,{nValAux,cNCMAux})\t\t       \r\n\t\t\t\t       EndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tnX += 1\r\n\t\t\t\t\t\tIf nX > Len(aIPIDev)\r\n\t\t\t\t\t\t\tlOk := .F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndDo\r\n\t\t\r\n\t\t\t\t\t\tFor nX := 1 To Len(aIPIAux)\r\n\t\t\t\t\t\t\tcValIPI  := AllTrim(Str(aIPIAux[nX][1],15,2))\r\n\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\tcMensCli += \"(Valor do IPI: R$ \"+cValIPI+\" - \"+\"Classificação fiscal: \"+aIPIAux[nX][2]+\") \"\r\n\t\t\t\t\t\t\tcValIPI  := \"\"\r\n\t\t\t\t\t\t\tcNCMAux  := \"\"\r\n\t\t\t\t\t\tNext nX\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf nValSTAux > 0 \r\n\t\t\t\t\tcValST  := AllTrim(Str(nValSTAux,15,2))\r\n\t\t\t\t\tcBsST   := AllTrim(Str(nBsCalcST,15,2))\r\n\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\tIf lComplDev .And.  nBsCalcST == 0\r\n\t\t\t\t\t\tcMensCli += \"(Valor do ICMS ST: R$ \"+cValST+\") \" \t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS ST: R$ \"+cBsST+ \" - \"+\"Valor do ICMS ST: R$ \"+cValST+\") \"\r\n\t\t\t\t\tEndIF\t\r\n\t\t\t\t\tcValST\t  := \"\"  \r\n\t\t\t\t\tcBsST \t  := \"\"   \r\n\t\t\t\t\tnBsCalcST := 0\r\n\t\t\t\t\tnValSTAux := 0\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017) \r\n\t\t\t\tIf \tnToTvBC > 0 .And. nToTvICMS > 0 \t\t\t\t\t\t\t\t   \r\n\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS : R$ \"+AllTrim(Str(nToTvBC,15,2))+\" - \"+\"Valor do ICMS : R$ \"+AllTrim(Str(nToTvICMS,15,2))+\") \"\r\n\t\t\t\tEndif\r\n\t\t\t\t//Tratamento legislacao do Rio Grande do Sul, quando existir intes com ICMS-ST e intens somente com ICMS  próprio\r\n\t\t\t\tIf SM0->M0_ESTCOB $ \"RS\" .And. Len(aICMS) > 0 .And. Len(aICMSSt) > 0 \r\n\t\t\t\t\tcMensCli += MsgCliRsIcm(aICMS,aICMSSt)\r\n\t\t\t\tEndif\r\n\t\t\t\t//Tratamento legislacao do DF, quando existir intes com ICMS-ST e intens somente com ICMS  próprio\r\n\t\t\t\tIf aDest[9] $ \"DF\" .And. Len(aICMS) > 0 .And. Len(aICMSSt) > 0 \r\n\t\t\t\t\tcMensCli += MsgCliDFIcm(aICMS,aICMSSt,lNCMOk)\r\n\t\t\t\tEndif\r\n\t\t\t    \r\n\t\t\t    //Mensagem para ICMS Particionado - Convênio ICMS Nº 51/00,\r\n\t\t\t    if nValICMParc > 0 .And. nBasICMParc > 0 .And. nValSTParc > 0 .And. nBasSTParc > 0\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t   cMensFis += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tcMensFis += \"Faturamento Direto ao Consumidor - Convenio ICMS Nº 51/00, de 15 de setembro de 2000. \"\r\n\t\t\t\t\tcMensFis += \"Base de calculo ICMS R$\"+ AllTrim(Str(nBasICMParc,15,2))+\" e \"\r\n\t\t\t\t\tcMensFis += \"Valor do ICMS R$\"+ AllTrim(Str(nValICMParc,15,2))+\". \"\r\n\t\t\t\t\tcMensFis += \"Base do ICMS-ST R$\"+ AllTrim(Str(nBasSTParc,15,2))+\" e \"\r\n\t\t\t\t\tcMensFis += \"Valor do ICMS-ST R$\"+ AllTrim(Str(nValSTParc,15,2))+\". \"\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(aEntrega) \r\n\t\t\t\t\t\tcMensFis += \"Concessionaria que ira entregar o veiculo ao adquirente \"+ConvType(aEntrega[09],115)+\". \"\r\n\t\t\t\t\t\tcMensFis += \"CNPJ: \"+AllTrim(aEntrega[01])+\" e IE: \"+AllTrim(aEntrega[10])+\". \"\r\n\t\t\t\t\t\tcMensFis += \"Endereço: \"+ConvType(aEntrega[02],125)+\", \"+ConvType(aEntrega[03],10)+\" \"+ConvType(aEntrega[04],60)+\". \" //Rua,Num,Complemento\r\n\t\t\t\t\t\tcMensFis += ConvType(aEntrega[05],60)+\" - \"+ ConvType(aEntrega[07],50) +\"-\"+ConvType(aEntrega[08],2)+\". \"//Bairro, Cidade, UF\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMensFis += \"Concessionaria que ira entregar o veiculo ao adquirente \"+ConvType(aDest[02],115)+\". \"\r\n\t\t\t\t\t\tcMensFis += \"CNPJ \"+AllTrim(aDest[01])+\" e IE: \"+AllTrim(aDest[14])+\". \"\r\n\t\t\t\t\t\tcMensFis += \"Endereço: \"+ConvType(aDest[03],125)+\" \"+ConvType(aDest[04],10)+\" \"+ConvType(aDest[05],60)+\", \" //Rua,Num,Complemento\r\n\t\t\t\t\t\tcMensFis += ConvType(aDest[06],60)+ \", \"+ ConvType(aDest[08],50) +\" - \"+ConvType(aDest[09],2)+\". \"//Bairro, Cidade, UF \r\n\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tendif\r\n\t\t\t\t\r\n\t\t\t\tIf ((SubStr(SM0->M0_CODMUN,1,2) == \"35\" ) .and. \"REMESSA POR CONTA E ORDEM DE TERCEIROS\" $ Upper(cNatOper) .and. lOrgaoPub )\r\n\t\t\t\t\tcMensFis += \"NF-e emitida nos termos do artigo 129-A do RICMS.\"\r\n\t\t\t\t\tcMensFis += \"(Redacao dada ao artigo pelo Decreto n60.060 , de 14.01.2014, DOE SP de 15.01.2014)\"\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t    \r\n\t\t\t    If lQuery\r\n\t\t\t    \tdbSelectArea(cAliasSD2)\r\n\t\t\t    \tdbCloseArea()\r\n\t\t\t    \tdbSelectArea(\"SD2\")\r\n\t\t\t    \r\n\t\t\t    \tdbSelectArea(\"SC5\")\r\n\t\t\t    \tdbCloseArea()\r\n\t\t\t    EndIf\r\n\t\t\t    /*Tratamento para buscar a Nota Original e a Data referente inciso II do art. 456 do RICMS / SP, chamado THPXGS*/\r\n\t\t\t    if lBrinde\r\n\t\t\t    \taDocDat := DocDatOrig(SD2->D2_NUMLOTE,SD2->D2_LOTECTL,SD2->D2_COD)\r\n\t\t\t    \tif len (cMensCli) > 0\r\n\t\t\t    \t\tcMensCli += ' '\r\n\t\t\t    \tendif\r\n\t\t\t    \tcMensCli += \"Nota Fiscal emitida nos termos do inciso II do art. 456 do RICMS - Nota Fiscal de Aquisição nº \"+aDocDat[2]+\", de \"+aDocDat[1]+\".\"\r\n\t\t\t    endif \r\n\t\t\t    //Tratamento para incluir a mensagem em informacoes adicionais do FECP -DF - MG - PR - RJ - RS.\r\n\t\t\t    If nValTFecp > 0\r\n\t\t\t\t\tIf cVerAmb >= \"4.00\"\t\t\t\t\r\n\t\t\t    \tcMensFis += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\t\t\tElse\r\n\t\t\t    \t\tcMensCli += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\t\t\tEndIf\r\n\t\t\t    EndIf\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext\r\nElse\r\n\tdbSelectArea(\"SF1\")\r\n\tdbSetOrder(1)\r\n\tIf MsSeek(xFilial(\"SF1\")+cNota+cSerie+cClieFor+cLoja)\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Tratamento temporario do CTe                                            ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\tIf FunName() == \"SPEDCTE\" .Or. AModNot(SF1->F1_ESPECIE)==\"57\"\r\n\t\t\tcNFe := \"CTe35080944990901000143570000000000200000168648\"\r\n\t\t\tcString := '<infNFe versao=\"T02.00\" modelo=\"57\" >'\r\n\t\t\tcString += '<CTe xmlns=\"http://www.portalfiscal.inf.br/cte\"><infCte Id=\"CTe35080944990901000143570000000000200000168648\" versao=\"1.02\"><ide><cUF>35</cUF>'\r\n\t\t\tcString += '<cCT>000016864</cCT><CFOP>6353</CFOP><natOp>ENTREGA NORMAL</natOp><forPag>1</forPag><mod>57</mod><serie>0</serie><nCT>20</nCT>'\r\n\t\t\tcString += '<dhEmi>2008-09-12T10:49:00</dhEmi><tpImp>2</tpImp><tpEmis>2</tpEmis><cDV>8</cDV><tpAmb>2</tpAmb><tpCTe>0</tpCTe><procEmi>0</procEmi>'\r\n\t\t\tcString += '<verProc>1.12a</verProc><cMunEmi>3550308</cMunEmi><xMunEmi>Sao Paulo</xMunEmi><UFEmi>SP</UFEmi><modal>01</modal><tpServ>0</tpServ>'\r\n\t\t\tcString += '<cMunIni>3550308</cMunIni><xMunIni>Sao Paulo</xMunIni><UFIni>SP</UFIni><cMunFim>3550308</cMunFim><xMunFim>Sao Paulo</xMunFim>'\r\n\t\t\tcString += '<UFFim>SP</UFFim><retira>1</retira><xDetRetira>TESTE</xDetRetira><toma03><toma>0</toma></toma03></ide><emit><CNPJ>44990901000143</CNPJ>'\r\n\t\t\tcString += '<IE>00000000000</IE><xNome>FILIAL SAO PAULO</xNome><xFant>Teste</xFant><enderEmit><xLgr>Av. Teste, S/N</xLgr><nro>0</nro><xBairro>Teste</xBairro>'\r\n\t\t\tcString += '<cMun>3550308</cMun><xMun>Sao Paulo</xMun><CEP>00000000</CEP><UF>SP</UF></enderEmit></emit><rem><CNPJ>58506155000184</CNPJ><IE>115237740114</IE>'\r\n\t\t\tcString += '<xNome>CLIENTE SP</xNome><xFant>CLIENTE SP</xFant><enderReme><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun>'\r\n\t\t\tcString += '<xMun>SAO PAULO</xMun><CEP>77777777</CEP><UF>SP</UF></enderReme><infOutros><tpDoc>00</tpDoc><dEmi>2008-09-17</dEmi></infOutros></rem><dest><CNPJ>'\r\n\t\t\tcString += '</CNPJ><IE></IE><xNome>CLIENTE RJ</xNome><enderDest><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun><xMun>RIO DE JANEIRO</xMun>'\r\n\t\t\tcString += '<CEP>44444444</CEP><UF>RJ</UF></enderDest></dest><vPrest><vTPrest>1.93</vTPrest><vRec>1.93</vRec></vPrest><imp><ICMS><CST00><CST>00</CST><vBC>250.00</vBC><pICMS>18.00</pICMS><vICMS>450.00</vICMS>'\r\n\t\t\tcString += '</CST00></ICMS></imp><infCteComp><chave>35080944990901000143570000000000200000168648</chave><vPresComp><vTPrest>10.00</vTPrest>'\r\n\t\t\tcString += '</vPresComp><impComp><ICMSComp><CST00Comp><CST>00</CST><vBC>10.00</vBC><pICMS>10.00</pICMS><vICMS>10.00</vICMS></CST00Comp></ICMSComp></impComp>'\r\n\t\t\tcString += '</infCteComp></infCte></CTe>'\r\n\t\t\tcString += '</infNFe>'\r\n\t\tElse\t\t\t\t\r\n\t\t\taadd(aNota,SF1->F1_SERIE)\r\n\t\t\taadd(aNota,IIF(Len(SF1->F1_DOC)==6,\"000\",\"\")+SF1->F1_DOC)\r\n\t\t\taadd(aNota,SF1->F1_EMISSAO)\r\n\t\t\taadd(aNota,cTipo)\r\n\t\t\taadd(aNota,SF1->F1_TIPO)\r\n\t\t\taadd(aNota,SF1->F1_HORA)\t\t\t\r\n\t\t\tIf SF1->F1_TIPO $ \"DB\" \r\n\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA1\")+cClieFor+cLoja)\r\n\r\n\t\t\t\tIf !Empty(SA1->A1_MENSAGE) \r\n\t\t\t\t\tcRetForm := SA1->(Formula(A1_MENSAGE))\r\n\t\t\t\t\tif cRetForm <> Nil .and. !empty(cRetForm)\r\n\t\t\t\t\t\tIf cMVNFEMSA1==\"C\"\r\n\t\t\t\t\t\t\tcMensCli\t:=\tcRetForm\r\n\t\t\t\t\t\tElseIf cMVNFEMSA1==\"F\"\r\n\t\t\t\t\t\t\tcMensFis\t:=\tcRetForm\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tendif\r\n\t\t\t\tEndIf\t\t\t\t\t\t\t\t\r\n\t\t\t\t/* Quando houver uma troca/devolução (LOJA720) de uma NFC-e no Estado do AM, a tag <infAdFisco> \r\n\t\t\t\tda NF-e de entrada deve conter o motivo de devolução, nome, endereço e cpf do cliente\r\n\t\t\t\tO campo F1_MOTIVO é preenchido na funcao LOJA720 do SIGALOJA */\r\n\t\t\t\tIf lF1Motivo .AND. AllTrim(SF1->F1_ORIGLAN) == \"LO\" .AND. LjAnalisaLeg(73)[1] .AND. !Empty(SF1->F1_MOTIVO)\r\n\t\t\t\t\tcMensFis += SF1->F1_MOTIVO\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_FORRET\"))<>0 .And. !Empty(SF1->F1_FORRET+SF1->F1_LOJARET) .And. SF1->F1_FORRET+SF1->F1_LOJARET <> SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIF MsSeek(xFilial(\"SA1\")+SF1->F1_FORRET+SF1->F1_LOJARET)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_CGC)\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[4])\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_EMAIL))\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_FORENT\")) <> 0 .And. !Empty(SF1->F1_FORENT+SF1->F1_LOJAENT) .And. SF1->F1_FORENT+SF1->F1_LOJAENT <> SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SA1\")+SF1->F1_FORENT+SF1->F1_LOJAENT)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_CGC)\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\taadd(aEntrega,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA1->A1_END,\"SA1\")[4])\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_NOME)\r\n\t\t\t\t\t\taadd(aEntrega,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL)) \r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_EMAIL))\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndIf\r\n\t\t\t\t/*MMAN-5156\r\n\t\t\t\tAtendimento ao processo de Recusa de mercadoria por parte do cliente,\r\n\t\t\t\tonde o Emitente deverá realizar a inclusão de recebimento da recusa utilizando\r\n\t\t\t\tCFOP 1.201/2.201 - devolução de venda de produção do estabelecimento; \r\n\t\t\t\te (ii) 1.410/2.410 - devolução de venda de produção do estabelecimento em operação \r\n\t\t\t\tcom produto sujeito ao regime de substituição tributária. \r\n\t\t\t\tBem como incluindo seus dados de Emitente como Destinatário.\r\n\t\t\t\tParecer da Consultoria de segmentos:\r\n\t\t\t\thttp://tdn.totvs.com/pages/releaseview.action?pageId=269448809\r\n\t\t\t\t\r\n\t\t\t\tFoi criado o campo na aba DANFE no Documento de Entrada (campo do materiais UPDCOM18)\r\n\t\t\t\tF1_DEVMERC (Identifica devolução de mercadoria que não foi entregue ao destinatário em\r\n\t\t\t\tatendimento ao Artigo 453, I, do RICMS/2000 SP) \r\n\t\t\t\tTipo Caracter (Combo S=Sim;N=Não) Tamanho 1\r\n\t\t\t\t\r\n\t\t\t\tAo preencher o campo como S=Sim, os dados do próprio estabelecimento (Emitente)\r\n\t\t\t\tserão utilizados como destinatário no XML e Danfe, ao invés do cliente padrão da nota.\t\t\r\n\t\t\t\t*/\r\n\t\t\t\tIf SF1->( ColumnPos( \"F1_DEVMERC\" ) ) > 0\r\n\t\t\t\t\tcDevMerc := Alltrim(SF1->F1_DEVMERC)\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf cDevMerc == \"S\"\r\n\t\t\t\t\r\n\t\t\t\t\taadd(aDest,AllTrim(SM0->M0_CGC)) // 1\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_NOMECOM))// 2\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[1]),ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1])))// 3\r\n\t\r\n\t\t\t\t\tIf !lEndFis\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcEndEmit :=  IIF(!lEndFis,Iif(!Empty(SM0->M0_COMPCOB),SM0->M0_COMPCOB,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[4]) ) ,;\r\n\t\t\t\t\t\t  \t\tIif(!Empty(SM0->M0_COMPENT),SM0->M0_COMPENT,ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[4]) ) )\r\n\t\t\t\t\taadd(aDest,cEndEmit)// 5\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_BAIRCOB),ConvType(SM0->M0_BAIRENT)))// 6\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_CODMUN))// 7\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CIDCOB),ConvType(SM0->M0_CIDENT)))// 8\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))))// 9\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CEPCOB),ConvType(SM0->M0_CEPENT)))// 10\r\n\t\t\t\t\taadd(aDest,\"1058\")// 11\r\n\t\t\t\t\taadd(aDest,\"BRASIL\")// 12\r\n\t\t\t\t\t\r\n\t\t\t\t\taTelEmit:= FisGetTel(SM0->M0_TEL)\r\n\t\t\t\t\tcFoneEmit := IIF(aTelEmit[1] > 0,ConvType(aTelEmit[1],3),\"\") // Código do Pais\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[2] > 0,ConvType(aTelEmit[2],3),\"\") // Código da Área\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[3] > 0,ConvType(aTelEmit[3],9),\"\") // Código do Telefone\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,cFoneEmit)// 13\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(VldIE(SM0->M0_INSC)))// 14\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_SUFRAMA*/)// 15\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_EMAIL*/)// 16\r\n\t\t\t\t\taAdd(aDest,\"1\" /*SA1->A1_CONTRIB*/) // 17\r\n\t\t\t\t\taadd(aDest,\"\") // 18\r\n\t\t\t\t\taadd(aDest,SM0->M0_INSCM) // 19\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_TIPO*/) // 20\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_PFISICA*/)//21\r\n\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t/* Se MV_NFEDEST estiver desabilitado (default .F.) permanece o legado:\r\n\t\t\t\t\ta) Para operações interestaduais (UF do emitente diferente da UF do Cliente de Entrega) e o CNPJ do Destinatario(Cliente - F1_FORNECE)\r\n\t\t\t\t\t\tfor DIFERENTE do emitente, serão considerados os dados do CLIENTE DE ENTREGA.  \r\n\t\t\t\t\t\t- Os dados do Cliente de Entrega serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\tb) Para operações internas (UF do emitente igual a UF do Cliente de Entrega) e se o CNPJ do Destinatário(Cliente - F1_FORNECE)\r\n\t\t\t\t\t\tfor IGUAL ao do emitente, serão considerado os dados do CLIENTE, mesmo que UFs sejam diferentes.\r\n\t\t\t\t\t\t- Os dados do Cliente serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf !lUsaCliEnt\r\n\t\t\t\t\t\tlCNPJIgual := AllTrim(SA1->A1_CGC) == Alltrim(SM0->M0_CGC)\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(AllTrim(SF1->F1_FORENT)) .And. !Empty(AllTrim(SF1->F1_LOJAENT))\t\t\t\r\n\t\t\t\t\t\t\tIf Len(aEntrega) > 0\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//Se a UF da entrega for diferente da UF do emitente (operação interestadual) e o CNPJ do destinatario for diferente do emitente, \r\n\t\t\t\t\t\t\t\t//tenho que buscar os dados do cliente de entrega para nao ocorrer \r\n\t\t\t\t\t\t\t\t//rejeicao 523 - CFOP não é de Operação Estadual e UF emitente igual à UF destinatário\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] <> IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .And. !lCNPJIgual //aEntrega[08] <> Upper(SA1->A1_EST)\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORENT+SF1->F1_LOJAENT)\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t//Se a UF de entrega for igual a UF do emitente (Operação interna) - busco os dados do cliente para montar como destinatario.\r\n\t\t\t\t\t\t\t\t//Se o CNPJ do emitente for igual ao do destinatário também levo os dados do cliente, mesmo que UFs forem diferente.\r\n\t\t\t\t\t\t\t\t//Se o cliente não for consumidor final e possuir IE, pode ocorrer a rejeição 773 - Operação Interna e UF de destino difere da UF do emitente\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] == IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .OR. lCNPJIgual\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t/* Se MV_NFEDEST estiver habilitado (.T.):\r\n\t\t\t\t\t\t\tA tag de destinatário - 'dest' será gerada com os dados do CLIENTE (F1_FORNECE)\r\n\t\t\t\t\t\t\tCaso possua Cliente de Entrega (F1_FORENT) a tag de entrega será gerada exatamente com os dados do Cliente de Entrega \r\n\t\t\t\t\t\t\tCaso possua Cliente de Retirada (F1_FORRET) a tag de retirada será gerada exatamente com os dados do Cliente de Retirada\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_CGC))\r\n\t\t\t\t\taadd(aDest,SA1->A1_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\r\n\t\t\t   \t\tIf MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0\r\n\t\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[3]) \r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(SA1->(FieldPos(\"A1_COMPLEM\")) > 0 .And. !Empty(SA1->A1_COMPLEM),SA1->A1_COMPLEM,MyGetEnd(SA1->A1_END,\"SA1\")[4]))\r\n\t\r\n\t\t\t\t\taadd(aDest,SA1->A1_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\taadd(aDest,SA1->A1_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_DDD)+SA1->A1_TEL)\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,VldIE(SA1->A1_INSCR))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,SA1->A1_SUFRAMA)\r\n\t\t\t\t\taadd(aDest,SA1->A1_EMAIL)\r\n\t\t\t\t\taAdd(aDest, SA1->A1_CONTRIB) // Posição 17\r\n\t\t\t\t\taadd(aDest,Iif(SA1->(FieldPos(\"A1_IENCONT\")) > 0 ,SA1->A1_IENCONT,\"\"))\r\n\t\t\t\t\taadd(aDest,SA1->A1_INSCRM)\r\n\t\t\t\t\taadd(aDest,SA1->A1_TIPO)\r\n\t\t\t\t\taadd(aDest,SA1->A1_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t   \tdbSelectArea(\"SA2\")\r\n\t\t\t\tdbSetOrder(1)  \t\t\t\t\r\n\t\t\t\tMsSeek(xFilial(\"SA2\")+cClieFor+cLoja)\r\n\t\t\t\tIf SF1->( ColumnPos( \"F1_DEVMERC\" ) ) > 0\r\n\t\t\t\t\tcDevMerc := Alltrim(SF1->F1_DEVMERC)\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t/*Atendimento ao processo de Recusa de mercadoria. Notas do Tipo D, B e N\r\n\t\t\t\tAo preencher o campo como S=Sim, os dados do próprio estabelecimento (Emitente)\r\n\t\t\t\tserão utilizados como destinatário no XML e Danfe, ao invés do fornecedor padrão da nota*/\r\n\t\t\t\t\r\n\t\t\t\tIf cDevMerc == \"S\"\r\n\t\t\t\t\taadd(aDest,AllTrim(SM0->M0_CGC)) // 1\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_NOMECOM))// 2\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[1]),ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1])))// 3\r\n\t\r\n\t\t\t\t\tIf !lEndFis\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcEndEmit :=  IIF(!lEndFis,Iif(!Empty(SM0->M0_COMPCOB),SM0->M0_COMPCOB,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[4]) ) ,;\r\n\t\t\t\t\t\t  \t\tIif(!Empty(SM0->M0_COMPENT),SM0->M0_COMPENT,ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[4]) ) )\r\n\t\t\t\t\taadd(aDest,cEndEmit)// 5\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_BAIRCOB),ConvType(SM0->M0_BAIRENT)))// 6\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_CODMUN))// 7\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CIDCOB),ConvType(SM0->M0_CIDENT)))// 8\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))))// 9\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CEPCOB),ConvType(SM0->M0_CEPENT)))// 10\r\n\t\t\t\t\taadd(aDest,\"1058\")// 11\r\n\t\t\t\t\taadd(aDest,\"BRASIL\")// 12\r\n\t\t\t\t\t\r\n\t\t\t\t\taTelEmit:= FisGetTel(SM0->M0_TEL)\r\n\t\t\t\t\tcFoneEmit := IIF(aTelEmit[1] > 0,ConvType(aTelEmit[1],3),\"\") // Código do Pais\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[2] > 0,ConvType(aTelEmit[2],3),\"\") // Código da Área\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[3] > 0,ConvType(aTelEmit[3],9),\"\") // Código do Telefone\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,cFoneEmit)// 13\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(VldIE(SM0->M0_INSC)))// 14\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,\"\")// 15\r\n\t\t\t\t\taadd(aDest,\"\")// 16\r\n\t\t\t\t\taAdd(aDest,\"1\") // 17\r\n\t\t\t\t\taadd(aDest,\"\") // 18\r\n\t\t\t\t\taadd(aDest,SM0->M0_INSCM) // 19\r\n\t\t\t\t\taadd(aDest,\"\") // 20\r\n\t\t\t\t\taadd(aDest,\"\")//21\r\n\t\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_CGC))\r\n\t\t\t\t\taadd(aDest,SA2->A2_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t\r\n\t\t\t\t\tIf MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0 .or. !Empty(SA2->A2_NR_END)\r\n\t\t\t\t\t\taadd(aDest,iif(!Empty(SA2->A2_NR_END),alltrim(SA2->A2_NR_END),MyGetEnd(SA2->A2_END,\"SA2\")[3])) \r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA2->A2_END,\"SA2\")[4])\r\n\t\t\t\t\taadd(aDest,SA2->A2_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(SA2->A2_EST))\r\n\t\t\t\t\taadd(aDest,SA2->A2_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\")))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_DDD)+SA2->A2_TEL)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\t\t\t\t\r\n\t\t\t\t\t\taadd(aDest,VldIE(SA2->A2_INSCR))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,\"\")//SA2->A2_SUFRAMA\r\n\t\t\t\t\taadd(aDest,SA2->A2_EMAIL)\r\n\t\t\t\t\tIf SA2->(FieldPos(\"A2_CONTRIB\"))>0\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_CONTRIB)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taAdd(aDest, \"\") \r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\taAdd(aDest, \"\")// Posição 18 (referente a A1_IENCONT, sendo passado como vazio já que não existe A2_IENCONT)\r\n\t\t\t\t\taadd(aDest,SA2->A2_INSCRM)\r\n\t\t\t\t\taadd(aDest,\"\")//Posição 20\r\n\t\t\t\t\taadd(aDest,SA2->A2_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\tEndIf\r\n\t\t       \r\n\t\t       If SF1->(FieldPos(\"F1_FORRET\"))<>0 .And. !Empty(SF1->F1_FORRET+SF1->F1_LOJARET) .And. SF1->F1_FORRET+SF1->F1_LOJARET<>SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SA2\")+SF1->F1_FORRET+SF1->F1_LOJARET)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_CGC)\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0,MyGetEnd(SA2->A2_END,\"SA2\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA2->A2_END,\"SA2\")[4])\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_BAIRRO)\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,Upper(SA2->A2_EST))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA2->A2_NOME))\r\n\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA2->A2_INSCR),VldIE(SA2->A2_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA2->A2_CEP))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA2->A2_DDD)+SA2->A2_TEL))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA2->A2_EMAIL))\t\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_FORENT\")) <> 0 .And. !Empty(SF1->F1_FORENT+SF1->F1_LOJAENT) .And. SF1->F1_FORENT+SF1->F1_LOJAENT <> SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SA2\")+SF1->F1_FORENT+SF1->F1_LOJAENT)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_CGC)\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t\t\t\t\t\taadd(aEntrega,ConvType(IIF(MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0,MyGetEnd(SA2->A2_END,\"SA2\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA2->A2_END,\"SA2\")[4])\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_BAIRRO)\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,Upper(SA2->A2_EST))\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_NOME)\r\n\t\t\t\t\t\taadd(aEntrega,Iif(!Empty(SA2->A2_INSCR),VldIE(SA2->A2_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA2->A2_CEP))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(AllTrim(SA2->A2_DDD)+SA2->A2_TEL)) \r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA2->A2_EMAIL))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\tIf SF1->F1_TIPO $ \"DB\" \r\n\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\t\r\n\t\t\tElse\r\n\t\t\t    dbSelectArea(\"SA2\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA2\")+SF1->F1_FORNECE+SF1->F1_LOJA)\t\r\n\t\t\tEndIf\r\n\r\n\t\t\t// Faz o destaque do IPI nos dados complementares caso seja uma venda que possuir IPI\r\n\t\t\tnSF3Recno:= SF3->(RECNO())\r\n\t\t\tnSF3Index:= SF3->(IndexOrd()) \t\t\t\r\n\t\t\tSF3->(dbSetOrder(5))\r\n\t\t\tif ( SF3->(dbSeek(xFilial(\"SF3\")+cSerie+cNota)) ) \r\n\r\n\t\t\t\t//Conforme consultoria tributaria \r\n\t\t\t\t//§ 1º do artigo 442, do RICMS CE, determina que todos os documentos recebidos pelo Estado\r\n\t\t\t\t// que acobertam operações interestaduais com este Estado deverão possuir a Inscrição Estadual de Substituto\r\n\t\t\t\tIf SF3->F3_ESTADO == \"CE\"\t\t\t\t\t\r\n\t\t\t\t\tIf At (SF3->F3_ESTADO, cMVSUBTRIB)>0\r\n\t\t\t\t\t\tnPosI\t:=\tAt (SF3->F3_ESTADO, cMVSUBTRIB)+2\r\n\t\t\t\t\t\tnPosF\t:=\tAt (\"/\", SubStr (cMVSUBTRIB, nPosI))-1\r\n\t\t\t\t\t\tnPosF\t:=\tIIf(nPosF<=0,len(cMVSUBTRIB),nPosF)\t\t\t\t\t\t\r\n\t\t\t\t\t\taAdd (aIEST, SubStr (cMVSUBTRIB, nPosI, nPosF))\t//01 - IE_ST\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\taAdd (aIEST,iif(aDest[14]<> nil,aDest[14],\"\" ))\t//IE Dest.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\twhile SF3->F3_SERIE == cSerie .and. SF3->F3_NFISCAL == cNota\r\n\t\t\t\t\tIf SF3->F3_VALIPI > 0 .And. SF3->F3_TIPO == \"D\"\r\n\t\t\t\t\t\tnValIPIDestac += SF3->F3_VALIPI\t\t\t\t\r\n\t\t\t\t\tElseIf SF3->F3_IPIOBS > 0 .And. SF3->F3_TIPO == \"D\"\r\n\t\t\t\t\t\tnValIPIDestac += SF3->F3_IPIOBS\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\tSF3->(dbSkip())\r\n\t\t\t\tend\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\tif nValIPIDestac > 0\r\n\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcMensFis += \"Valor do IPI: R$ \" + AllTrim(Transform(nValIPIDestac, \"@ze 9,999,999,999,999.99\")) + \" \"\r\n\t\t\t\tendif  \r\n\t\t\t\t\r\n\t\t\tEndIf\t\r\n\t\t\t\r\n\t  \r\n\t\t\tSF3->(DBSETORDER(nSF3Index))\r\n\t\t\tSF3->(DBGOTO(nSF3Recno))\r\n\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Verifica Duplicatas da nota de entrada                                  ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\r\n\t\t\tIf !Empty(SF1->F1_DUPL)\t\r\n\t\t\t\tdbSelectArea(\"SE2\")\r\n\t\t\t\tdbSetOrder(1)\t\r\n\t\t\t\t#IFDEF TOP\r\n\t\t\t\t\tlQuery  := .T.\r\n\t\t\t\t\tcAliasSE2 := GetNextAlias()\r\n\t\t\t\t\tBeginSql Alias cAliasSE2\r\n\t\t\t\t\t\tCOLUMN E2_VENCORI AS DATE\r\n\t\t\t\t\t\tSELECT E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA,E2_VENCORI,E2_VALOR,E2_VLCRUZ,E2_ORIGEM,E2_ISS\r\n\t\t\t\t\t\tFROM %Table:SE2% SE2\r\n\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\tSE2.E2_FILIAL = %xFilial:SE2% AND\r\n\t\t\t\t\t\tSE2.E2_PREFIXO = %Exp:SF1->F1_PREFIXO% AND\r\n\t\t\t\t\t\tSE2.E2_NUM = %Exp:SF1->F1_DUPL% AND\r\n\t\t\t\t\t\tSE2.E2_FORNECE = %Exp:SF1->F1_FORNECE% AND\r\n\t\t\t\t\t\tSE2.E2_LOJA = %Exp:SF1->F1_LOJA% AND\r\n\t\t\t\t\t\tSE2.E2_TIPO = %Exp:MVNOTAFIS% AND\r\n\t\t\t\t\t\tSE2.%NotDel%\r\n\t\t\t\t\t\tORDER BY %Order:SE2%\r\n\t\t\t\t\tEndSql\r\n\t\t\t\t\t\r\n\t\t\t\t#ELSE\r\n\t\t\t\t\tMsSeek(xFilial(\"SE2\")+SF1->F1_PREFIXO+SF1->F1_DOC)\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tWhile !Eof() .And. xFilial(\"SE2\") == (cAliasSE2)->E2_FILIAL .And.;\r\n\t\t\t\t\tSF1->F1_PREFIXO == (cAliasSE2)->E2_PREFIXO .And.;\r\n\t\t\t\t\tSF1->F1_DOC == (cAliasSE2)->E2_NUM\r\n\t\t\t\t\tIf \t(cAliasSE2)->E2_TIPO==MVNOTAFIS .And. (cAliasSE2)->E2_FORNECE==SF1->F1_FORNECE .And. (cAliasSE2)->E2_LOJA==SF1->F1_LOJA\r\n\t\t\t\t\t\taadd(aDupl,{(cAliasSE2)->E2_PREFIXO+(cAliasSE2)->E2_NUM+(cAliasSE2)->E2_PARCELA,(cAliasSE2)->E2_VENCORI,(cAliasSE2)->E2_VLCRUZ - IIF(!lRuleDescISS, (cAliasSE2)->E2_ISS, 0) })\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tdbSelectArea(cAliasSE2)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t    EndDo\r\n\t\t\t    If lQuery\r\n\t\t\t    \tdbSelectArea(cAliasSE2)\r\n\t\t\t    \tdbCloseArea()\r\n\t\t\t    \tdbSelectArea(\"SE2\")\r\n\t\t\t    EndIf\r\n\t\t\tElse\r\n\t\t\t\taDupl := {}\r\n\t\t\tEndIf\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Analisa os impostos de retencao                                         ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf SF1->(FieldPos(\"F1_VALPIS\"))<>0 .And. SF1->F1_VALPIS>0\r\n\t\t\t\taadd(aRetido,{\"PIS\",0,SF1->F1_VALPIS})\r\n\t\t\tEndIf\r\n\t\t\tIf SF1->(FieldPos(\"F1_VALCOFI\"))<>0 .And. SF1->F1_VALCOFI>0\r\n\t\t\t\taadd(aRetido,{\"COFINS\",0,SF1->F1_VALCOFI})\r\n\t\t\tEndIf\r\n\t\t\tIf SF1->(FieldPos(\"F1_VALCSLL\"))<>0 .And. SF1->F1_VALCSLL>0\r\n\t\t\t\taadd(aRetido,{\"CSLL\",0,SF1->F1_VALCSLL})\r\n\t\t\tEndIf\r\n\t\t\tIf SF1->(FieldPos(\"F1_INSS\"))<>0 .and. SF1->F1_INSS>0\r\n\t\t\t\taadd(aRetido,{\"INSS\",SF1->F1_BASEINS,SF1->F1_INSS})\r\n\t\t\tEndIf\r\n\t\t\t//RECOPI\r\n\t\t\tIf SF1->(FieldPos(\"F1_IDRECOP\")) > 0 .and. !Empty(SF1->F1_IDRECOP)\r\n\t\t\t\tcIdRecopi := SF1->F1_IDRECOP\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf !Empty(cIdRecopi)\r\n\t\t\t\tIf AliasIndic(\"CE3\")\r\n\t\t\t\t\tCE3->(DbSetOrder(1))\r\n\t\t\t\t\tIf CE3->(DbSeek(xFilial(\"CE3\")+Alltrim(cIdRecopi)))\r\n\t\t\t\t\t\tcNumRecopi:= IIf(CE3->(FieldPos(\"CE3_RECOPI\")) > 0, Alltrim(CE3->CE3_RECOPI), \"\")\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Volumes / Especie Nota de Entrada                                       ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tcScan := \"1\"\r\n\t\t\tif (nPosCpoEsp := SF1->(ColumnPos(\"F1_ESPECI\"+cScan))) > 0\r\n\r\n\t\t\t\tnPosCpoVol := SF1->(ColumnPos(\"F1_VOLUME\"+cScan))\r\n\t\t\t\tnPosCpoMrc := 0\r\n\t\t\t\tnPosCpoNum := 0\r\n\t\t\t\tif !empty(cMRCVLMSF1)\r\n\t\t\t\t\taCpoMarVol := StrTokArr2(cMRCVLMSF1, \";\" ) \r\n\t\t\t\t\tif len(aCpoMarVol) == 2\r\n\t\t\t\t\t\tcCpoMarca := alltrim(aCpoMarVol[1])\r\n\t\t\t\t\t\tcCpoNumer := alltrim(aCpoMarVol[2])\r\n\t\t\t\t\t\tnPosCpoMrc := SF1->(ColumnPos(cCpoMarca + cScan)) \r\n\t\t\t\t\t\tnPosCpoNum := SF1->(ColumnPos(cCpoNumer + cScan))\r\n\t\t\t\t\tendif\r\n\t\t\t\tendif\r\n\r\n\t\t\t\tWhile ( !Empty(cScan) )\r\n\t\t\t\t\tcEspecie := \"\"\r\n\t\t\t\t\tnVolume := 0\r\n\t\t\t\t\tcMarca := \"\"\r\n\t\t\t\t\tcNumeracao := \"\"\r\n\r\n\t\t\t\t\tif nPosCpoEsp > 0\r\n\t\t\t\t\t\tcEspecie := upper(SF1->(FieldGet(nPosCpoEsp)))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\t\tIf !empty(cEspecie)\r\n\r\n\t\t\t\t\t\tif nPosCpoMrc > 0\r\n\t\t\t\t\t\t\tcMarca := alltrim(SF1->(FieldGet(nPosCpoMrc)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoNum > 0\r\n\t\t\t\t\t\t\tcNumeracao := alltrim(SF1->(FieldGet(nPosCpoNum)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoVol > 0\r\n\t\t\t\t\t\t\tnVolume := SF1->(FieldGet(nPosCpoVol))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tnScan := aScan(aEspVol,{|x| x[1] == cEspecie})\r\n\t\t\t\t\t\tIf ( nScan==0 )\r\n\t\t\t\t\t\t\taadd(aEspVol,{ cEspecie, nVolume , SF1->F1_PLIQUI , SF1->F1_PBRUTO, cMarca, cNumeracao})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taEspVol[nScan][2] += nVolume\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcScan := Soma1(cScan,1)\r\n\t\t\t\t\tnPosCpoEsp := SF1->(ColumnPos(\"F1_ESPECI\"+cScan))\r\n\t\t\t\t\tIf nPosCpoEsp == 0 \r\n\t\t\t\t\t\tcScan := \"\"\r\n\t\t\t\t\t\texit\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tnPosCpoVol := SF1->(ColumnPos(\"F1_VOLUME\"+cScan))\r\n\t\t\t\t\tif !empty(cCpoMarca) .and. !empty(cCpoNumer)\r\n\t\t\t\t\t\tnPosCpoMrc := SF1->(ColumnPos(cCpoMarca+cScan))\r\n\t\t\t\t\t\tnPosCpoNum := SF1->(ColumnPos(cCpoNumer+cScan))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\tEndDo\r\n\t\t\tEndIf\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Posiciona transportador                                                 ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf FieldPos(\"F1_TRANSP\") > 0 .And. !Empty(SF1->F1_TRANSP)\r\n\t\t\t\tdbSelectArea(\"SA4\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA4\")+SF1->F1_TRANSP)\r\n\t\t\t\t\r\n\t\t\t\taadd(aTransp,AllTrim(SA4->A4_CGC))\r\n\t\t\t\taadd(aTransp,SA4->A4_NOME)\r\n\t\t\t\taadd(aTransp,VldIE(SA4->A4_INSEST))\r\n\t\t\t\taadd(aTransp,SA4->A4_END)\r\n\t\t\t\taadd(aTransp,SA4->A4_MUN)\r\n\t\t\t\taadd(aTransp,Upper(SA4->A4_EST)\t)\r\n\t\t\t\taadd(aTransp,SA4->A4_EMAIL\t)\r\n\t\t\t\t\tIf !Empty(SF1->F1_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,SF1->F1_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,SA4->A4_EST)\r\n\t\t\t\t\t\taadd(aVeiculo,\"\")//RNTC\r\n\t\t\t\t\tEndIf\t\t\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SF1->(FieldPos(\"F1_MENNOTA\"))>0\r\n\t\t\t\tIf !AllTrim(SF1->F1_MENNOTA) $ cMensCli\r\n\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIF len(aCMPUSR) > 1  \r\n\t\t\t\t\t\tcFieldMsg := aCMPUSR[2]  \r\n\t\t\t\t\tEndIf  \r\n\t\t\t\t\tIf !Empty(cFieldMsg) .and. SF1->(FieldPos(cFieldMsg)) > 0 .and. !Empty(&(\"SF1->\"+cFieldMsg))\r\n\t\t\t\t\t\tcMensCli := alltrim(&(\"SF1->\"+cFieldMsg))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMensCli += AllTrim(SF1->F1_MENNOTA)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SF1->(FieldPos(\"F1_MENPAD\")) > 0  .and. !Empty(SF1->F1_MENPAD)\r\n\t\t\t\tcRetForm := FORMULA(SF1->F1_MENPAD)\r\n\t\t\t\tIf cRetForm <> nil .And. !AllTrim(cRetForm) $ cMensFis\r\n\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcMensFis += AllTrim(cRetForm)\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\r\n\t\t\tcField := \"%\"\r\n\t\t\tIf SD1->(FieldPos(\"D1_ICMSDIF\")) > 0\r\n\t\t\t\tcField += \",D1_ICMSDIF\"\r\n\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_FILORI\")) > 0\r\n\t\t\t\tcField += \",D1_FILORI\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_DESCZFR\")) > 0\r\n\t\t\t\tcField += \",D1_DESCZFR\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_DESCZFP\")) > 0\r\n\t\t\t\tcField += \",D1_DESCZFP\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_DESCZFC\")) > 0\r\n\t\t\t\tcField += \",D1_DESCZFC\"\r\n\t\t\tEndIf\r\n\t\t\tIf SD1->(FieldPos(\"D1_GRPCST\"))<>0 //Grupo de tributação de ipi\r\n\t\t\t   cField  +=\",D1_GRPCST\"\t\t\t\t    \r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf SD1->( ColumnPos('D1_AFRMIMP') ) > 0 //Campo específico para despesa de importação\r\n\t\t\t   cField  +=\",D1_AFRMIMP\"\t\t\t\t    \r\n\t\t\tEndIf\t\t\t\r\n\r\n\t\t\tIf SD1->( ColumnPos('D1_VOPDIF') ) > 0\r\n\t\t\t   cField  +=\",D1_VOPDIF\"\t\t\t\t    \r\n\t\t\tEndIf\r\n\r\n\t\t\tif SD1->(ColumnPos(\"D1_FCICOD\"))<>0\r\n\t\t\t\tcField  +=\",D1_FCICOD\"\t\t\t\t\t\t    \r\n\t\t\tEndIF\r\n\t\t\t\r\n\t\t\tcField += \"%\"\r\n\t\t\t\r\n\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\tdbSetOrder(1)\t\r\n\t\t\t#IFDEF TOP\r\n\t\t\t\tlQuery  := .T.\r\n\t\t\t\tcAliasSD1 := GetNextAlias()\r\n\t\t\t\tBeginSql Alias cAliasSD1\t\t\t\r\n\t\t\t\t\t\tSELECT D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_COD,D1_ITEM,D1_TES,D1_TIPO,D1_NFORI,D1_SERIORI,D1_ITEMORI,\r\n\t\t\t\t\t\tD1_CF,D1_QUANT,D1_TOTAL,D1_VALDESC,D1_VALFRE,D1_SEGURO,D1_DESPESA,D1_CODISS,D1_VALISS,D1_VALIPI,D1_ICMSRET,\r\n\t\t\t\t\t\tD1_VUNIT,D1_CLASFIS,D1_VALICM,D1_TIPO_NF,D1_PEDIDO,D1_ITEMPC,D1_VALIMP5,D1_VALIMP6,D1_BASEIRR,D1_VALIRR,D1_LOTECTL, \r\n\t\t\t\t\t\tD1_NUMLOTE,D1_CUSTO,D1_ORIGLAN,D1_DESCICM,D1_II,D1_FORMUL,D1_VALPS3,D1_ORIGLAN,D1_VALCF3,D1_TESACLA,D1_IDENTB6,D1_PICM,D1_DESC  %Exp:cField%\r\n\t\t\t\t\t\tFROM %Table:SD1% SD1\r\n\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\tSD1.D1_FILIAL  = %xFilial:SD1% AND\r\n\t\t\t\t\t\tSD1.D1_SERIE   = %Exp:SF1->F1_SERIE% AND\r\n\t\t\t\t\t\tSD1.D1_DOC     = %Exp:SF1->F1_DOC% AND\r\n\t\t\t\t\t\tSD1.D1_FORNECE = %Exp:SF1->F1_FORNECE% AND\r\n\t\t\t\t\t\tSD1.D1_LOJA    = %Exp:SF1->F1_LOJA% AND\r\n\t\t\t\t\t\tSD1.D1_FORMUL  = 'S' AND\r\n\t\t\t\t\t\tSD1.%NotDel%\r\n\t\t\t\t\t\tORDER BY D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_ITEM,D1_COD\r\n\t\t\t\tEndSql\r\n\r\n\t\t\t#ELSE\r\n\t\t\t\tMsSeek(xFilial(\"SD1\")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t#ENDIF\r\n\t\t\t\r\n\t\t\tnCountIT := 0\r\n\t\t\tWhile !Eof() .And. xFilial(\"SD1\") == (cAliasSD1)->D1_FILIAL .And.;\r\n\t\t\t\tSF1->F1_SERIE == (cAliasSD1)->D1_SERIE .And.;\r\n\t\t\t\tSF1->F1_DOC == (cAliasSD1)->D1_DOC .And.;\r\n\t\t\t\tSF1->F1_FORNECE == (cAliasSD1)->D1_FORNECE .And.;\r\n\t\t\t\tSF1->F1_LOJA ==  (cAliasSD1)->D1_LOJA\t\t\t\t\r\n\r\n\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SF4\")+(cAliasSD1)->D1_TES)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t   \tIf SF4->F4_AGRPIS = \"1\"\r\n\t\t\t\t\t\taAdd(aAgrPis,{.T.,0})\r\n\t\t\t\t\t\taAgrPis[Len(aAgrPis)][2] := (cAliasSD1)->D1_VALIMP6\r\n\t\t\t\tElse\r\n\t\t\t\t\t\taAdd(aAgrPis,{.F.,0})\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf SF4->F4_AGRCOF = \"1\"\r\n\t\t\t\t\t\taAdd(aAgrCofins,{.T.,0})\r\n\t\t\t\t\t\taAgrCofins[Len(aAgrCofins)][2] := (cAliasSD1)->D1_VALIMP5\r\n\t\t\t\tElse\r\n\t\t\t\t\t\taAdd(aAgrCofins,{.F.,0})\r\n\t\t\t\tEndIf\r\n\r\n\r\n\t\t\t\tIf SD1->(FieldPos(\"D1_DESCZFR\"))>0\r\n\t\t            nDescZF := (cAliasSD1)->D1_DESCZFR\r\n\t\t\t\tElse\r\n\t\t\t\t\tnDescZF := 0\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//Tratamento para nota sobre Cupom \r\n\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t    DbSetOrder(1)\r\n\t\t\t    IF SFT->(DbSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA)))\r\n\t\t\t\t\tIF AllTrim(SFT->FT_OBSERV) <> \" \" .AND.(cAliasSD1)->D1_ORIGLAN==\"LO\"\r\n\t\t\t\t\t\tIf !Alltrim(SFT->FT_OBSERV) $ Alltrim(cMensCli) \r\n\t\t\t\t\t\t\tIf \"DEVOLUCAO N.F.\" $ Upper(SFT->FT_OBSERV) \r\n\t\t\t\t\t\t\t\tcMensCli +=\" \" + StrTran(AllTrim(SFT->FT_OBSERV),\"N.F.\",\"C.F.\")\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcMensCli +=\" \" + AllTrim(SFT->FT_OBSERV)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf       \r\n           \t\t\tEndIf\r\n\t        \tEndIF\t\t\t\r\n\t\r\n\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_STATUS\"))>0 .And.SD1->(FieldPos(\"D1_TESACLA\"))>0 .And. SF1->F1_STATUS='C' \r\n\t\t\t\t\tMsSeek(xFilial(\"SF4\")+(cAliasSD1)->D1_TESACLA)\r\n\t\t\t\tElse \r\n\t\t\t\t\tMsSeek(xFilial(\"SF4\")+(cAliasSD1)->D1_TES)\r\n\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\tcChaveD1 := \"E\" + ( cAliasSD1 )->( D1_SERIE + D1_DOC + D1_FORNECE + D1_LOJA + D1_ITEM )\t\t\t\t\r\n\t\t\t\tSFT->( dbSetOrder( 1 ) )\r\n\t\t\t\t//utiliza a funcao SpedNatOper ( SPEDXFUN ) que possui o tratamento para a natureza da operacao/prestacao\r\n\t\t\t\tif FindFunction( \"SpedNatOper\" ) .And. SFT->( MsSeek( xFilial( \"SFT\" ) + cChaveD1 ) )\r\n\t\t\t\t\tIf !Alltrim(SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ])$cNatOper\r\n\t\t\t\t\t\tIf\tEmpty(cNatOper)\r\n\t\t\t\t\t\t\tcNatOper := SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcNatOper := cNatOper + \"/ \" +SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\telse\r\n\t\t\t\t\tIf !lNatOper\r\n\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\tcNatOper := Alltrim(SF4->F4_TEXTO)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcNatOper += Iif(!Alltrim(SF4->F4_TEXTO)$cNatOper,\"/ \" + SF4->F4_TEXTO,\"\")\r\n\t\t\t\t\t\tEndif \r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taSX513 \t := FwGetSX5(\"13\",SF4->F4_CF)\r\n\t\t\t\t\t\tIf len(aSX513) > 0\r\n\t\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\t\tcNatOper := AllTrim(SubStr(aSX513[1][4],1,55))\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcNatOper += Iif(!AllTrim(SubStr(aSX513[1][4],1,55)) $ cNatOper, \"/ \" + AllTrim(SubStr(aSX513[1][4],1,55)), \"\")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t    \t\tEndIf\r\n\t\t    \tendif\r\n\t    \t\t\r\n\t    \t\tIf SF4->(FieldPos(\"F4_BASEICM\"))>0\r\n\t    \t\t\tnRedBC := IiF(SF4->F4_BASEICM>0,IiF(SF4->F4_BASEICM == 100,SF4->F4_BASEICM,IiF(SF4->F4_BASEICM > 100,0,100-SF4->F4_BASEICM)),SF4->F4_BASEICM)\r\n\t    \t\t\tcCST   := SF4->F4_SITTRIB \r\n\t    \t\tEndif\r\n\t    \t\t\r\n\t    \t\t//Operação com diferimento parcial de 66,66% do RICMS/PR para importação\r\n\t    \t\tlDifParc := .F.\r\n\t    \t\tIf (SF4->(FieldPos(\"F4_PICMDIF\"))>0 .And. \"66.66\" $ Alltrim(Str(SF4->F4_PICMDIF)) ) ;\r\n\t    \t\t\t.And. (SF4->(FieldPos(\"F4_ICMSDIF\"))>0 .And. SF4->F4_ICMSDIF <> \"2\") ;\r\n\t    \t\t\t.And. (SubStr(SM0->M0_CODMUN,1,2)=='41' .And. SubStr((cAliasSD1)->D1_CF,1,1) == '3')\t    \t\t\t\r\n\t\t\t\t\tlDifParc := .T.\r\n\t    \t\tEndIf\r\n\t    \t\t\r\n\t    \t\tIf ((cAliasSD1)->D1_VALICM > 0 .And. (cAliasSD1)->D1_ICMSDIF > 0 ) .And. lDifParc\r\n\t    \t\t\tnValIcmDev += (cAliasSD1)->D1_VALICM   //Valor total do ICMS devido\r\n\t    \t\t\tnValIcmDif += (cAliasSD1)->D1_ICMSDIF  //Valor total do ICMS diferido \r\n\t    \t\tEndIf\r\n\t    \t\t//O campo F4_FORINFC é o substituto do F4_FORMULA, e através do parâmetro MV_NFEMSF4  se determina se o conteudo da formula devera compor a mensagem do cliente(=\"C\") ou do fisco(=\"F\").\r\n\t\t\t\tIf (cAliasSD1)->D1_FORMUL==\"S\"\r\n\t\t\t\t\tIf SF4->(ColumnPos(\"F4_FORINFC\") ) > 0  .And. !Empty(SF4->F4_FORINFC) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORINFC)\r\n\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4==\"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4==\"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\tElseIf !Empty(SF4->F4_FORMULA) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORMULA)\r\n\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4 == \"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4 == \"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf lMvImpFecp \r\n\t\t\t\t\tIf (lValFecp .Or. lVfecpst) \r\n\t\t\t\t    \tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\tIf SFT->(DbSeek((xFilial(\"SFT\") + cChaveD1 )))\t\r\n\t\t\t\t\t    \tnValTFecp += SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\r\n\t\t\t\t\t\t\tnValIFecp := SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t   \r\n\t\t\t\t\tEndif\t\t\t\t\t\r\n\t\t\t\tEndif\r\n\t   \t\t\t\r\n\t\t\t\t//Verifica se existe Template DCL\r\n      \t\t\tIF (ExistTemplate(\"PROCMSG\"))\r\n      \t\t\t\taMens := ExecTemplate(\"PROCMSG\",.f.,.f.,{cAliasSD1})      \t\t\t\t\t\t\t\t\t\t \t\t      \t\t\t\t\t\r\n\t\t\t\t\t\tFor nA:=1 to len(aMens)\r\n\t\t\t\t\t\t    If aMens[nA][1] == \"V\" .Or. (aMens[nA][1] == \"T\" .And. Ascan(aMensAux,aMens[nA][2])==0)\r\n\t\t\t\t\t\t\t\tAADD(aMensAux,aMens[nA][2])\r\n\t\t\t\t\t\t\tEndif\t\r\n\t\t\t\t\t\tNext    \t\t\t\t\t\r\n     \t\t\tEndif \r\n     \t\t\t\r\n     \t\t\t// Verifica se o CFOP é de devolução por consignação mercantil (CFOP 1111/1111/1918/2918)\r\n\t\t\t\tIf  AllTrim((cAliasSD1)->D1_CF) == \"1111\" .Or.  AllTrim((cAliasSD1)->D1_CF) == \"2111\" .or.  AllTrim((cAliasSD1)->D1_CF) == '1918' .or.   AllTrim((cAliasSD1)->D1_CF) == '2918'\r\n\t\t\t\t\tlConsig  := .T.\r\n\t\t\t\tEndIf\r\n     \t\t\t\r\n     \t\t\t\r\n\t\t\t\t/*Tratamento para NF DE AJUSTE chamado THYZ13 -  PORTARIA N° 163/2007 Artigo 18-B-2 item 4a da SEFAZ-MT */\r\n\t\t\t\t\r\n\t\t\t\tif SF4->F4_AJUSTE ==\"S\" .and. aDest[1] == SM0->M0_CGC .and. (cAliasSD1)->(D1_TIPO) == \"D\" .and. (cAliasSD1)->D1_FORMUL == \"S\"\r\n\t\t\t\t\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\taAreaSA1\t:= SA1->(GetArea())\t\t\t\r\n\t\t\t\t\taAreaSYA\t:= SYA->(GetArea())\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tif SF2->(DbSeek(xFilial(\"SF2\")+(cAliasSD1)->(D1_NFORI)+(cAliasSD1)->(D1_SERIORI))) \r\n\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\r\n\t\t\t\t\t\tif SA1->(DbSeek(xFilial(\"SA1\")+(SF2->F2_CLIENTE)+(SF2->F2_LOJA)))\r\n\t\t\t\t\t\t\tcMensCli += iIf(!Empty(SA1->A1_CGC),'CNPJ: '+Rtrim(SA1->A1_CGC) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_NOME),' NOME: '+Rtrim(SA1->A1_NOME) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_END),' ENDEREÇO: '+Rtrim(SA1->A1_END) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_BAIRRO),' BAIRRO: '+Rtrim(SA1->A1_BAIRRO) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_EST),' UF: '+Rtrim(SA1->A1_EST) ,'')\r\n\t\t\t\t\t\t\tif !Empty(SA1->A1_PAIS)\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SYA\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif SYA->(DbSeek(xFilial(\"SYA\")+(SA1->A1_PAIS)))\r\n\t\t\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SYA->YA_DESCR),' PAIS: '+Rtrim(SYA->YA_DESCR),'')\r\n\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\taAdd( aNfVinc, { SF2->F2_EMISSAO, SF2->F2_SERIE, SF2->F2_DOC,SA1->A1_CGC,SF2->F2_EST,SF2->F2_ESPECIE, SF2->F2_CHVNFE, 0,\"\",\"\",0,\"\",\"\" })\r\n\t\t\t\t\tlVinc := .T.\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tendif\t\t\t\t\r\n\t\t\t\t\tRestArea(aAreaSF2)\r\n\t\t\t\t\tRestArea(aAreaSA1)\t\t\t\t\r\n\t\t\t\t\tRestArea(aAreaSYA)\t\t\t\t\r\n\t\t\t\tendif     \t\t\t\r\n     \t\t\t\r\n     \t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Verifica as notas vinculadas                                            ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\tIf !Empty((cAliasSD1)->D1_NFORI)\r\n\t\t\t\t\t\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\tdbSelectArea(\"SF2\")\r\n        \t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf SF2->(DbSeek(xFilial(\"SF2\")+(cAliasSD1)->(D1_NFORI)+(cAliasSD1)->(D1_SERIORI))) \r\n        \t\t\t\tcSpecie:= Alltrim(SF2->F2_ESPECIE)\r\n        \t\t\tEndIf\r\n        \t\t\tRestArea(aAreaSF2)\r\n\t\t\t\t\t\r\n\t\t\t\t\taOldReg  := SD1->(GetArea())\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Realiza o backup do order e recno da SF1\r\n\t\t\t\t\tnOrderSF1\t:= SF1->( indexOrd() )\r\n\t\t\t\t\tnRecnoSF1\t:= SF1->( recno() )\r\n\r\n\t\t\t\t\tlNfCompl\t:= SF1->F1_TIPO == \"C\" .And. cMVEstado == \"RS\" \r\n                 \r\n                \t//Ajustes para que ao gerar nota de entrada do tipo complemento de preço de uma devolução seja vinculado o cliente correto \r\n\t\t\t\t\t//da nota de origem.                \t\t\r\n\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tcSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SD1\")+cSeekD1)\r\n\t\t\t\t\t\tcTipoNF :=  SD1->D1_TIPO \r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO) $ \"NCI\" // Tratamento para notas de entrada noadminrmais e complementares buscar o fornecedor original corretamente\r\n\t\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO) <> \"N\"  .AND.  cTipoNF $ 'DB'\r\n\t\t\t\t\t\t    cSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+SD1->D1_FORNECE+SD1->D1_LOJA+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_ITEMORI\r\n\t\t\t\t\t    ELSE\r\n\t\t\t\t\t        cSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_ITEMORI\r\n\t\t\t\t\t        cSeekAux:= (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI\r\n\t\t\t\t\t    EndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI\r\n\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\r\n\t\t\t\t\taAreaSD1 := SD1->(GetArea())\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Alterado a chave de busca completa devido ao procedimento de complemento de notas de devolucao de VENDA onde o codigo do fornecedor não seja o mesmo da nota de origem \r\n\t\t\t\t\tIf !MsSeek(xFilial(\"SD1\")+cSeekD1) .and. ((cAliasSD1)->D1_TIPO) $ \"C|I\"\r\n\t\t\t\t\t\tcSeekD1:= cSeekAux\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SD1\")+cSeekD1)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tSF1->( dbSetOrder( 1 ) )\r\n\t\t\t\t\t\tSF1->( msSeek( xFilial( \"SF1\" ) + SD1->D1_DOC + SD1->D1_SERIE + SD1->D1_FORNECE + SD1->D1_LOJA + SD1->D1_TIPO ) )\r\n\t\t\t\t\t\tlSeekOk := .T.\r\n\t\t\t\t\t\tIf SD1->D1_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t        lRural := ( AllTrim(SF1->F1_ESPECIE) == \"NFP\" .Or. AllTrim(SF1->F1_ESPECIE) == \"NFA\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tlSeekOk := .F.\r\n\t\t\t\t\t\tRestArea(aAreaSD1)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf !(cAliasSD1)->D1_TIPO $ \"DBN\" .Or. lRural\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Obtem os dados de nota fiscal de produtor rural referenciada                                  ³\r\n\t\t\t\t\t\t//³Temos duas situacoes:                                                                         ³\r\n\t\t\t\t\t\t//³A NF de saída é uma devolucao, onde a NF original pode ser ou nao uma devolução.              ³\r\n\t\t\t\t\t\t//³1) Quando a NF original for uma devolucao, devemos utilizar o remetente do documento fiscal,  ³\r\n\t\t\t\t\t\t//³    podendo ser o sigamat.emp no caso de formulario proprio ou o proprio SA1 no caso de nf de ³\r\n\t\t\t\t\t\t//³    entrada com formulario proprio igual a NAO.                                               ³\r\n\t\t\t\t\t\t//³2) Quando a NF original NAO for uma devolucao, neste caso tambem pode variar conforme o       ³\r\n\t\t\t\t\t\t//³    formulario proprio igual a SIM ou NAO. No caso do NAO, os dados a serem obtidos retornara ³\r\n\t\t\t\t\t\t//³    da tabela SA2.                                                                            ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf ( AllTrim(SF1->F1_ESPECIE)== \"NFP\" .Or. AllTrim(SF1->F1_ESPECIE)== \"NFA\" ) .and. lSeekOk\r\n\t\t\t\t\t\t\t//para nota de entrada tipo devolucao o emitente eh o cliente ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\tIf SD1->D1_TIPO$\"DB\"\r\n\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA1->A1_CGC),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA1->A1_EST),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA1->A1_INSCR)})\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//para nota de entrada normal o emitente eh o fornecedor ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA2->A2_CGC),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA2->A2_EST),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA2->A2_INSCR)})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t    \t//|                                                             ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\tIf AllTrim(SF1->F1_ESPECIE)==\"CF\" .and. lSeekOk\r\n\t\t\t\t\t\t\taadd(aRefECF,{SD1->D1_DOC,SF1->F1_ESPECIE})\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Outros documentos referenciados\r\n\t\t\t\t\t\tif !lRural .and. lSeekOk\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif cChave <> dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE;\r\n\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taAdd( aNfVinc, { SD1->D1_EMISSAO, SD1->D1_SERIE, SD1->D1_DOC, iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ), SM0->M0_ESTCOB, SF1->F1_ESPECIE, SF1->F1_CHVNFE,SD1->D1_TOTAL,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\tcChave\t:= dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE\r\n\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF1->F1_CHVNFE, SF1->F1_VALBRUT})\r\n\t\t\t\t\t\t\t\t//Busca NFP vinculada, da nota Original.\r\n\t\t\t\t\t\t\t\tIf lNfCompl\r\n\t\t\t\t\t\t\t\t\taNfVincRur :=\tRetNfpVinc(SD1->D1_DOC,SD1->D1_SERIE,SD1->D1_FORNECE,SD1->D1_LOJA)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t    endIf\r\n\t\t\t\t\t\t    \r\n\t\t\t\t\t    \tcItemOr\t:= ( cAliasSD1 )->D1_ITEM\r\n\t\t\t\t\t    \t\r\n\t\t\t\t\t    endIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\tIF (cAliasSD1)->D1_ORIGLAN ==\"LO\"\r\n\t\t\t\t\t\t    If (cAliasSD1)->(FieldPos(\"D1_FILORI\")) > 0\r\n\t\t\t\t\t\t\t\tcFilDev := Iif(Empty((cAliasSD1)->D1_FILORI),xFilial(\"SD2\"),(cAliasSD1)->D1_FILORI)\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcFilDev := xFilial(\"SD2\")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t   cMsSeek\t:=(cFilDev+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI)\r\n\t\t\t\t\t\tELSE \r\n\t\t\t\t\t\t\tIf (cAliasSD1)->(FieldPos(\"D1_FILORI\")) > 0\r\n\t\t\t\t\t\t\t\tcFilDev := Iif(Empty((cAliasSD1)->D1_FILORI),xFilial(\"SD2\"),(cAliasSD1)->D1_FILORI)\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcFilDev := xFilial(\"SD2\")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tif !(SF4->F4_AJUSTE=='S' .and. ((cAliasSD1)->D1_TIPO == \"D\")) .and. cSpecie <> 'NFCE' .And. !DevCliEntr(cAliasSD1)\r\n\t\t\t\t\t   \t\t\tcMsSeek\t:=(cFilDev+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_ITEMORI)\r\n\t\t\t\t\t   \t\telse  /* Quando for uma devolução de Ajuste não tem necessidade de informar os outros campo para posicionar na SD2. chamado TIANDL*/\r\n\t\t\t\t\t   \t\t\tcMsSeek\t:=(cFilDev+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI)\r\n\t\t\t\t\t   \t\tendif       \r\n\t\t\t\t\t\tEndIF                                                                          \r\n\t\t\t\t\t\t    \r\n\t\t\t\t\t\tIF MsSeek (cMsSeek)\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(cFilDev+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\tIf !SD2->D2_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//Tratamento para os campos do Loja(cNfRefcup = Numero da Nota de complemento sobre cupom /cSerRefcup = Serie da Nota de complemento sobre cupom)\r\n\t\t\t\t\t\t\t\tif SD2->(FieldPos(\"D2_NFCUP\")) <> 0\r\n\t\t\t\t\t\t\t\t\tcNfRefcup := SD2->D2_NFCUP\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tcNfRefcup := \"\"\r\n\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\tcSerRefcup := SD2->D2_SERIORI\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t\t    \t//|                                                             ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\tIf Alltrim(SF2->F2_ESPECIE)==\"CF\" .OR. (LjAnalisaLeg(18)[1] .AND. \"ECF\"$SF2->F2_ESPECIE)\r\n\t\t\t\t\t\t\t\taadd( aRefECF,{ SD2->D2_DOC,SF2->F2_ESPECIE,SF2->F2_PDV } )\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Outros documentos referenciados³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf cChave <> Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taadd(aNfVinc,{SD2->D2_EMISSAO,SD2->D2_SERIE,SD2->D2_DOC,SM0->M0_CGC,SM0->M0_ESTCOB,SF2->F2_ESPECIE,SF2->F2_CHVNFE,SD2->D2_TOTAL-SD2->D2_DESCON,SD2->D2_PEDIDO,SF2->F2_TIPO,iif(SD2->D2_TIPO $ \"DB\",2,1),SD2->D2_CLIENTE,SD2->D2_LOJA})\r\n\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\tcChave := Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tnCountIT += 1\r\n\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF2->F2_CHVNFE, SF2->F2_VALBRUT})\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElseIf (cAliasSD1)->D1_TIPO == \"N\" .And. (cAliasSD1)->D1_FORMUL = \"S\"                                                  \t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\t   \t\tdbSetOrder(4)\r\n\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_NFORI)\r\n\t\t\t\t\t   \t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t   \t\tdbSetOrder(4)\r\n\t\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE)\r\n\t\t\t\t\t\t   \t\t\tIf cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA2->A2_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t   \t\t\t\t\t.or. ( cAliasSD1 )->D1_ITEM <> cItemOr\r\n\t\t\t\t\t   \t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA2->A2_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA2->A2_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\tlVinc := .T. \r\n\t\t\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD1 )->D1_ITEM\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tRestArea(aOldReg)\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Restaura a ordem e recno da SF1\r\n\t\t\t\t\tSF1->( dbSetOrder( nOrderSF1 ) )\r\n\t\t\t\t\tSF1->( dbGoTo( nRecnoSF1 ) )\r\n\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Verifica as notas vinculadas na tabela SF8 - Amarracao NF Orig x NF Imp/Fre     ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\t\tIf Alltrim( (cAliasSD1)->D1_ORIGLAN ) $ \"D-DP-FR\" .And. Alltrim( (cAliasSD1)->D1_TIPO ) == \"C\"\r\n\t\t\t\t\t\tdbSelectArea(\"SF8\")\r\n\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\tIf dbSeek(cChavesf8:=xFilial(\"SF8\")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA)\r\n\t\t\t\t\t\t\taAreaSD1 := SD1->(GetArea())\r\n\t\t\t\t\t\t\taAreaSF1 := SF1->(GetArea())\r\n\t\t\t\t\t\t\tDo While cChavesf8 == SF8->(F8_FILIAL+F8_NFDIFRE+F8_SEDIFRE+F8_TRANSP+F8_LOJTRAN)\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)  \r\n\t\t\t\t\t\t\t\tIf dbSeek(xFilial(\"SD1\")+SF8->F8_NFORIG+SF8->F8_SERORIG+SF8->F8_FORNECE+SF8->F8_LOJA)\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tIf dbSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_TIPO)\r\n\t\t\t\t\t\t\t\t\t\tAADD(aNfVinc,{SF1->F1_EMISSAO,SF1->F1_SERIE,SF1->F1_DOC,SM0->M0_CGC,SM0->M0_ESTCOB,SF1->F1_ESPECIE,SF1->F1_CHVNFE,0,\"\",\"\",0,\"\",\"\"})\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tSF8->(DbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\t\tRestArea(aAreaSD1)\r\n\t\t\t\t\t\t\tRestArea(aAreaSF1)\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndif\t\r\n\t\t\t\tEndIf \r\n\t\t\t\t\r\n\t\t\t\tIf lVinc .and. !Empty(aNfVinc)\r\n\t\t\t\t\taADD(aItemVinc,{ATail(aNfVinc)[1]})\r\n\t\t\t\tElse\r\n\t\t\t\t\taADD(aItemVinc,{})\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Obtem os dados do produto                                               ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SB1\")+(cAliasSD1)->D1_COD)\r\n\t\t\t\t//Veiculos Novos\r\n\t\t\t\tIf AliasIndic(\"CD9\")\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"CD9\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD9\")+cChaveD1)\r\n\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t//Combustivel\r\n\t\t\t\tIf AliasIndic(\"CD6\")\r\n\t\t\t\t\tdbSelectArea(\"CD6\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD6\")+cChaveD1)\r\n\t\t\t\tEndIf\r\n\t\t\t\t//Medicamentos\r\n\t\t\t\tIf AliasIndic(\"CD7\")\r\n\t\t\t\t\tdbSelectArea(\"CD7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD7\")+cChaveD1)\r\n\t\t\t\tEndIf\r\n\t            // Armas de Fogo\r\n\t            If AliasIndic(\"CD8\")\r\n\t\t\t\t\tdbSelectArea(\"CD8\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD8\")+cChaveD1)\r\n\t\t\t\tEndIf\r\n\t\t\t\t//Anfavea\r\n\t\t\t\tIf lAnfavea\r\n\t\t\t\t\tdbSelectArea(\"CDR\")\r\n\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\tMsSeek(xFilial(\"CDR\")+\"S\"+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA)\r\n\r\n\t\t\t\t\tdbSelectArea(\"CDS\")\r\n\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\tMsSeek(xFilial(\"CDS\")+\"S\"+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_ITEM+(cAliasSD1)->D1_COD)\r\n\t\t\t\tEndIf   \r\n\t\t\t\t//RASTREABILIDADDE\r\n\t         \tIf AliasIndic(\"F0A\")\r\n\t\t\t\t\tdbSelectArea(\"F0A\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"F0A\")+cChaveD1)\r\n\t\t\t\tEndIf \r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"SB5\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf MsSeek(xFilial(\"SB5\")+(cAliasSD1)->D1_COD)\r\n\t\t\t\t\tIf SB5->(FieldPos(\"B5_DESCNFE\")) > 0 .And. !Empty(SB5->B5_DESCNFE)\r\n\t\t\t\t\t\tcInfAdic := Alltrim(SB5->B5_DESCNFE)\r\n\t\t\t\t\tElse\t\r\n\t\t\t\t\t\tcInfAdic := \"\"\t\t\t\t\r\n\t\t\t\t\tEndIF\r\n\r\n                    cUmDipi  := SB5->B5_UMDIPI\r\n                    nConvDip := SB5->B5_CONVDIP\r\n\t\t\t\tElse\r\n\t\t\t\t\tcInfAdic := \"\"\r\n                    cUmDipi  := \"\"\r\n                    nConvDip := 0\r\n\t\t\t\tEndIF \r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"DY3\")\r\n\t\t\t   \tdbSetOrder(1)\r\n\t\t\t   \tIf MsSeek(xFilial(\"DY3\")+ (cAliasSB5)->B5_ONU)\r\n\t\t\t\t\tIf !Empty(DY3->DY3_DESCRI) .and. DY3->DY3_INFCPL ==\"S\"\r\n\t\t\t\t\t\tIf !cMensONU $ DY3->DY3_ONU\r\n\t\t\t\t     \t   \tcMensONU\t:= cMensONU +'  ONU '+Alltrim(DY3->DY3_ONU)+' '+Alltrim(DY3->DY3_DESCRI)+'   '   \r\n\t\t\t\t    \tEndIF\r\n\t\t\t   \t\tEndIF  \t\t\r\n\t\t\t\tEndIF\r\n\r\n                //Atualiza a Unid. Medida da DIPI(cUmDipi) e o Fator de Conv. da DIPI(nConvDip) com dados da SBZ caso os parâmetro recebidos estejam vazios\r\n                RetInfoSBZ((cAliasSD1)->D1_COD, @cUmDipi, @nConvDip)\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Conforme Decreto RICM, N 43.080/2002 valido somente em MG deduzir o \t³ \r\n\t\t\t\t//³\timposto dispensado na operação\t\t\t\t  \t\t\t                ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tnDescRed := 0\r\n\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\tdbSetOrder(1)\r\n\r\n\t\t\t\tMsSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_ITEM+(cAliasSD1)->D1_COD) \r\n\t\t\t\tIf SFT->(FieldPos(\"FT_DS43080\")) <> 0 .And. SFT->FT_DS43080 > 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\tnDescRed := SFT->FT_DS43080 \r\n\t\t\t\t\tnDesTotal+= nDescRed\r\n\t\t\t\tEndIF\r\n\t\t\t\t\r\n\t\t\t\tIf SFT->(ColumnPos(\"FT_DESCFIS\")) <> 0 .And. SFT->FT_DESCFIS > 0\r\n\t\t\t\t\tnDescFis := SFT->FT_DESCFIS\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf (SFT->(ColumnPos(\"FT_CRDPRES\")) <> 0 .And. SFT->FT_CRDPRES > 0) .and. ( SF4->F4_AGREGCP $\"1|S\")\r\n\t\t\t\t\tnCrdPres := SFT->FT_CRDPRES\r\n\t\t\t\t\tnTotCrdP += nCrdPres\r\n\t\t\t\tEndIf \r\n\r\n\t\t\t\tIf SD1->(FieldPos(\"D1_DESCICM\"))<>0\r\n\t\t\t\t\tnDescIcm := ( IIF(SF4->F4_AGREG == \"D\",(cAliasSD1)->D1_DESCICM,0) )\r\n\t\t\t\t\tIf cVerAmb >= \"3.10\" .and. SF4->F4_AGREG == \"D\" .and. (!Empty(SF4->F4_MOTICMS) .and. (!AllTrim(SF4->F4_MOTICMS) $ \"8|9\" .or. AllTrim(SF4->F4_MOTICMS) != \"90\")) .and. Empty(SF4->F4_CSOSN)\r\n\t\t\t\t\t\tnDescIcm:=0\r\n\t\t\t\t\tEndIF\t\t\t\t\t\t\r\n\t\t\t\tEndIF\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//Alteração realizada no campo F4_ICMSDIF, foi incluido a opção: 6 – Diferido(Deduz NF e Duplicata)\r\n\t\t\t\t//no combo para deduzir os valores de ICMS diferido na NF e da Duplicata\r\n\t\t\t\t//http://tdn.totvs.com/display/public/PROT/2892815+DSERFIS1-6266+DT+Diferimento+ICMS\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\r\n\t\t\t\tnDescNfDup :=0\r\n\t\t\t\tIf\tSF4->F4_ICMSDIF == \"6\"\r\n\t\t\t\t\tnDescNFDup := IIF(SF1->(F1_STATUS) == 'C', (cAliasSD1)->(D1_ICMSDIF),SFT->FT_ICMSDIF)\r\n\t\t\t\tEndIF \r\n\t\t\t\t\t\t\r\n\t\t\t\t//Tratamento para o Tipo de Frete no documento de entrada\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_TPFRETE\")) > 0 .And. !Empty( SF1->F1_TPFRETE )\t\t\t\t\t\r\n\t\t\t\t\tIf SF1->F1_TPFRETE==\"C\"\r\n\t\t\t\t\t\tcModFrete := \"0\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"F\"\r\n\t\t\t\t\t \tcModFrete := \"1\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"T\"\r\n\t\t\t\t\t \tcModFrete := \"2\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"R\"\r\n\t\t\t\t\t \tcModFrete := \"3\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"D\"\r\n\t\t\t\t\t \tcModFrete := \"4\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"S\"\r\n\t\t\t\t\t \tcModFrete := \"9\"\r\n\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tcModFrete := IIF(SF1->F1_FRETE>0,\"0\",\"1\")\r\n\t\t\t\tEndIf\r\n\t\t\t\taAdd(aInfoItem,{(cAliasSD1)->D1_PEDIDO,(cAliasSD1)->D1_ITEMPC,(cAliasSD1)->D1_TES,(cAliasSD1)->D1_ITEM})\r\n\t\t\t\t\r\n\t\t\t\t//Tratamento para que o valor de ICMS ST venha a compor o valor da tag vOutros quando for uma nota de Devolução, impedindo que seja gerada a rejeição 610.\r\n\t\t       nIcmsST := 0\r\n\t\t       If (!lIcmSTDev .And. (cAliasSD1)->D1_TIPO == \"D\" .And. SubStr((cAliasSD1)->D1_CLASFIS,2,2) $ '10#30#70#90') .Or. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM) .Or. (!lIcmSTDev .And. lComplDev .And. (cAliasSD1)->D1_TIPO == \"I\" )\r\n\t\t       nIcmsST := (cAliasSD1)->D1_ICMSRET\r\n\t\t       EndIf   \t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//Tratamento para verificar se o produto é controlado por terceiros (IDENTB6)³\r\n\t\t\t\t//e a partir do tipo do documento (Cliente ou Fornecedor) verifica  se existe³\r\n\t\t\t\t//amarracao entre Produto X Cliente(SA7) ou Produto X Fornecedor(SA5)       ³  \r\n\t\t\t\t//Caso haja a amarracao, o codigo e descricao do produto, assumem o conteudo  ³\r\n\t\t\t\t//da SA7 ou SA5\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ³ \r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  \r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcCodProd  := (cAliasSD1)->D1_COD\t            \r\n\t\t\t\tcDescProd := SB1->B1_DESC \r\n\t\t\t\t\t \r\n\t\t\t\tIf !Empty((cAliasSD1)->D1_IDENTB6) .And. lNFPTER  \r\n\t\t\t\t\tIf (cAliasSD1)->D1_TIPO == \"N\" \r\n\t\t\t\t\t\t//--A5_FILIAL + A5_FORNECE + A5_LOJA + A5_PRODUTO\r\n\t\t\t\t\t\tSA5->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\tIf SA5->(MsSeek( xFilial(\"SA5\") + (cAliasSD1)->(D1_FORNECE+D1_LOJA+D1_COD) )) .and. !empty(SA5->A5_CODPRF) .and. !empty(SA5->A5_DESREF)\r\n\t\t\t\t\t\t\tcCodProd  := SA5->A5_CODPRF \r\n\t\t\t\t\t\t\tcDescProd := SA5->A5_DESREF \t            \r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElseIf (cAliasSD1)->D1_TIPO == \"B\"\r\n\t\t\t         //--A7_FILIAL + A7_CLIENTE + A7_LOJA + A7_PRODUTO\r\n\t\t\t\t\t\tSA7->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\tIf SA7->(MsSeek( xFilial(\"SA7\") + (cAliasSD1)->(D1_FORNECE+D1_LOJA+D1_COD) )) .and. !empty(SA7->A7_CODCLI) .and. !empty(SA7->A7_DESCCLI) \r\n\t\t\t\t\t\t\tcCodProd  := SA7->A7_CODCLI \r\n\t\t\t\t\t\t\tcDescProd := SA7->A7_DESCCLI\t            \t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcOrigem:= IIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,1,1),'0')\r\n\t\t\t    cCSTrib:= IIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,2,2),'50')\r\n\t\t\t            \r\n\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t//\t\t\tFCI - Ficha de Conteúdo de Importação\r\n\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t//**Operação INTERNA:\r\n\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da importação      (Industrialização)\r\n\t\t\t\t//\r\n\t\t\t\t//**Operação INTERESTADUAL:\r\n\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da parcela importada do exterior, o número da FCI e o Conteúdo de\r\n\t\t\t\t//   Importação expresso percentualmente (Industrialização)\r\n\t\t\t\t//----------------------------------------------------------------------------------------- \r\n\t\t\t\t\t\t\r\n\t\t\t\tIf (cOrigem $\"1-2-3-4-5-6-8\" .And. cCSTrib $ \"00-10-20-30-40-41-50-51-60-70-90\")\r\n\t\t\t\t\tIf (cAliasSD1)->(ColumnPos(\"D1_FCICOD\")) > 0 .And. !Empty((cAliasSD1)->D1_FCICOD)\r\n\t\t\t\t\t\taadd(aFCI,{(cAliasSD1)->D1_FCICOD}) \r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf lFCI\r\n\t\t\t\t\t\t\tcMsgFci\t:= \"Resolucao do Senado Federal nº 13/12\"\r\n\t\t\t\t\t\t\tcInfAdic  += cMsgFci + \", Numero da FCI \" + Alltrim((cAliasSD1)->D1_FCICOD) + \".\"\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse \r\n\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³  ³Código de Benefício Fiscal na UF aplicado ao item\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \r\n\t\t\t\tlCodLan := .F.\r\n\t\t\t\tIf SM0->M0_ESTENT $ \"PR/RJ/RS/\" //TAG cBenef buscar o conteúdo da tabela 5.2 no sistema quando for do PR.\r\n\t\t\t\t\tdbSelectArea(\"CDV\")\r\n\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\tcCodlan :=\"\"\r\n\t\t\t\t\tIf MsSeek(xFilial(\"CDV\") +'E'+PadR('SPED',TamSX3(\"CDV_ESPECI\")[1])+'S'+(cAliasSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_ITEM))\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Tratamento realizado enquanto o fiscal não realiza a criação do campo na CDV\r\n\t\t\t\t\t\tif CDV->(ColumnPos(\"CDV_NFE\")) > 0\r\n\t\t\t\t\t\t\tif CDV->CDV_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDY\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf CDV->(ColumnPos(\"CDV_CODAJU\")) > 0 .and. !Empty(CDV->CDV_CODAJU) .and. MsSeek( xFilial(\"CDY\") + CDV->CDV_CODAJU)\r\n\t\t\t\t\t\t\t\tIf CDY->CDY_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif lCodLan\r\n\t\t\t\t\t\t\tcCodlan:= CDV->CDV_CODAJU\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcCodlan := getCodLan( alltrim(SM0->M0_ESTENT), SF4->F4_SITTRIB, cAmbiente )\r\n\t\t\t\t\tEndIF\r\n\t\t\t\tElse\r\n\t\t\t\t\tcCodlan := \"\"\t\r\n\t\t\t\t\tIf SM0->M0_ESTENT <> \"SP\" .and. CDA->(ColumnPos(\"CDA_CODLAN\")) > 0\r\n\t\t\t\t\t\tdbSelectArea(\"CDA\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tcSeekCDA := xFilial(\"CDA\") +'E'+PadR('SPED',TamSX3(\"CDA_ESPECI\")[1])+'S'+(cAliasSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_ITEM)\r\n\t\t\t\t\t\tIf MsSeek(cSeekCDA) //CDA_FILIAL, CDA_TPMOVI, CDA_ESPECI, CDA_FORMUL, CDA_NUMERO, CDA_SERIE, CDA_CLIFOR, CDA_LOJA, CDA_NUMITE, CDA_SEQ, CDA_CODLAN, CDA_CALPRO\r\n\t\t\t\t\t\t\tWhile alltrim(cSeekCDA) == alltrim(CDA->(CDA_FILIAL + CDA_TPMOVI + CDA_ESPECI + CDA_FORMUL + CDA_NUMERO + CDA_SERIE + CDA_CLIFOR + CDA_LOJA + CDA_NUMITE))\r\n\t\t\t\t\t\t\t\tIf !Empty(CDA->CDA_CODLAN) .And. CDA->CDA_TPLANC == \"2\" .and. Len(AllTrim(CDA->CDA_CODLAN)) == 10\r\n\t\t\t\t\t\t\t\t\tcCodlan := CDA->CDA_CODLAN\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCDA->(dbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³  Indicador de Produção em escala relevante, conforme Cláusula 23 do Convenio ICMS 52/2017\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \t\t\t\t\t\t\r\n\t\t\t\tIf AliasIndic(\"D3E\")\r\n\t\t\t\t\tdbSelectArea(\"D3E\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tcIndEscala :=\"\"\r\n\t\t\t\t\tIf MsSeek(PADR(xFilial(\"D3E\"),TAMSX3(\"D3E_FILIAL\")[1]) +(cAliasSD1)->D1_COD)\r\n\t\t\t\t\t\tIf D3E->(ColumnPos(\"D3E_INDESC\")) > 0\r\n\t\t\t\t\t\t\tIf\t!Empty(D3E->D3E_INDESC)  .AND.  D3E->D3E_INDESC == \"1\"\r\n\t\t\t\t\t\t\t\tcIndEscala:= \"S\"\r\n\t\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\tEndIF\t\t\r\n\t\t\t\tEndIF\t\t\r\n\t\t\t\t\r\n\t\t\t\tcTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,(cAliasSD1)->D1_CF)\r\n\t\t\t\t\r\n\t\t\t\tIf((cAliasSD1)->D1_TIPO <> \"D\") .Or. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM)\r\n\t\t\t\t\tlEIPIOutro := .F.\r\n\t\t\t\tEnd\r\n\t\t\t\t\r\n\t\t\t\tIf ((cAliasSD1)->D1_TIPO <> 'B')\r\n\t\t\t\t\tlIPIOutB :=.F.\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).\r\n\t\t\t\tnValOutr  := 0\r\n\t\t\t\tIf (((cAliasSD1)->D1_TIPO == \"D\" .And. (!lEipiDev .Or. lEIPIOutro)) .Or. ((cAliasSD1)->D1_TIPO == \"B\" .and. lIpiBenef)) \r\n\r\n\t\t\t\t    If ((cAliasSD1)->D1_TIPO == \"D\" .and.  lEIPIOutro ) .or. ((cAliasSD1)->D1_TIPO == \"B\" .and. lIPIOutB)\r\n\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n                    EndIf \t\t            \t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\tnValOutr += 0\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tnValOutr += (cAliasSD1)->D1_VALIPI\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tnValOutr += (cAliasSD1)->D1_DESPESA + (cAliasSD1)->D1_VALPS3 + (cAliasSD2)->D2_VALCF3 + nIcmsST + nCrdPres\r\n\t\t\t\tcTpOrig  := IIF(nCountIT > 0 .And. Len(aNfVinc[nCountIT]) > 9, aNfVinc[nCountIT][10], \"\")\r\n\t\t\t\t\t\t\t\t            \t\t            \t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t/*\r\n\t\t\t\tBruno Sigawie\r\n\t\t\t\tse for a itinga a chamada e orignal \r\n\t\t\t\tse for qualita muda a função U_RETPESOFAT\r\n\t\t\t\t*/\r\n\t\t\t\t\r\n\t\t\t\t//If SubString(CNUMEMP,1,2) == \"05\"\r\n\t\t\t\t\t\t\t\t            \t\t            \t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\taadd(aProd,\t{Len(aProd)+1,;  \r\n\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\tSB1->B1_POSIPI,;\r\n\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_CF,;\r\n\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_QUANT,;\r\n\t\t\t\t\t\tIIF(!((cAliasSD1)->D1_TIPO $\"IP\" .Or. ((cAliasSD1)->D1_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,(IIF(!(lMvNFLeiZF),(cAliasSD1)->D1_TOTAL,(cAliasSD1)->D1_TOTAL - ((cAliasSD1)->D1_DESCZFP+(cAliasSD1)->D1_DESCZFC))),0),;\r\n\t\t\t\t\t\tretUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\tretQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), nConvDip, (cAliasSD1)->D1_QUANT ),;    //retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_CONVDIP, (cAliasSD1)->D1_QUANT ),;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_VALFRE,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_SEGURO,;\r\n\t\t\t\t\t\tnDescRed + nDescIcm + nDescNfDup + (cAliasSD1)->D1_VALDESC + nDescFis -(SFT->FT_DESCZFR),;\r\n\t\t\t\t\t   \tIIF(!((cAliasSD1)->D1_TIPO $\"IP\"),(cAliasSD1)->D1_VUNIT,0),;\r\n\t\t\t\t\t   \tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF  \r\n\t\t\t\t\t\t(cAliasSD1)->D1_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t(cAliasSD1)->D1_NUMLOTE,;//Numero do Lote \r\n\t\t\t\t\t\tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).\r\n\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\tIIF(SF4->F4_AGREG<>'N' .And. SF4->F4_ISS='S',\"1\",IIF(SF4->F4_AGREG='N' .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\")),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_TES,;\r\n\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t0,;  // Da posição 28 a 30 tratamento realizado apenas para documento de saída por este motivo campos estão zerados e vazios.\r\n\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFP\"))<>0,(cAliasSD1)->D1_DESCZFP,0),;\t\t\t//Desconto Zona Franca PIS\r\n\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFC\"))<>0,(cAliasSD1)->D1_DESCZFC,0),;\t\t\t//Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t(cAliasSD1)->D1_PICM,;\t\t// [33] Percentual de ICMS\r\n\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;\t\t// [34]\r\n\t\t\t\t\t\t0,;\t\t// [35]\r\n\t\t\t\t\t\t0,;\t\t// [36]\r\n\t\t\t\t\t\t0,;\t\t// [37]\r\n\t\t\t\t\t\t0,;\t\t// [38]\r\n\t\t\t\t\t\t0,;\t\t// [39]\r\n\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_GRPCST\")) > 0 .and. !Empty((cAliasSD1)->D1_GRPCST),(cAliasSD1)->D1_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //[40]\r\n\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aprod[41] NT2015/003\r\n\t\t\t\t\t\tIIF(SF4->(ColumnPos(\"F4_VENPRES\"))>0,SF4->F4_VENPRES,\"\"),; //aprod[42] utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\tnValIFecp ,; //aprod[43]  Valor do FECP. \r\n\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),; //aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),; //aprod[46] \r\n\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\tSF4->F4_ART274,; //aprod[48]\r\n\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t})\r\n\t\t\t\t/*Else\r\n\t\t\t\t\taadd(aProd,\t{Len(aProd)+1,;  \r\n\t\t\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\t\t\tSB1->B1_POSIPI,;\r\n\t\t\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_CF,;\r\n\t\t\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_QUANT,;\r\n\t\t\t\t\t\t\t\tIIF(!((cAliasSD1)->D1_TIPO $\"IP\" .Or. ((cAliasSD1)->D1_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,(IIF(!(lMvNFLeiZF),(cAliasSD1)->D1_TOTAL,(cAliasSD1)->D1_TOTAL - ((cAliasSD1)->D1_DESCZFP+(cAliasSD1)->D1_DESCZFC))),0),;\r\n\t\t\t\t\t\t\t\tretUn2UM ( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), \"\", SB1->B1_UM            ) ,; // BRUNO retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\t\t\tretQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), 0 , (cAliasSD1)->D1_QUANT ) ,; // BRUNO retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), nConvDip, (cAliasSD1)->D1_QUANT ),;    //retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_CONVDIP, (cAliasSD1)->D1_QUANT ),;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_VALFRE,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_SEGURO,;\r\n\t\t\t\t\t\t\t\tnDescRed + nDescIcm + nDescNfDup + (cAliasSD1)->D1_VALDESC + nDescFis -(SFT->FT_DESCZFR),;\r\n\t\t\t\t\t\t\t   \tIIF(!((cAliasSD1)->D1_TIPO $\"IP\"),(cAliasSD1)->D1_VUNIT,0),;\r\n\t\t\t\t\t\t\t   \tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF  \r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_NUMLOTE,;//Numero do Lote \r\n\t\t\t\t\t\t\t\tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).\r\n\t\t\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\t\t\tIIF(SF4->F4_AGREG<>'N' .And. SF4->F4_ISS='S',\"1\",IIF(SF4->F4_AGREG='N' .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\")),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_TES,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;  // Da posição 28 a 30 tratamento realizado apenas para documento de saída por este motivo campos estão zerados e vazios.\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFP\"))<>0,(cAliasSD1)->D1_DESCZFP,0),;\t\t\t//Desconto Zona Franca PIS\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFC\"))<>0,(cAliasSD1)->D1_DESCZFC,0),;\t\t\t//Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_PICM,;\t\t// [33] Percentual de ICMS\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;\t\t// [34]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [35]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [36]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [37]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [38]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [39]\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_GRPCST\")) > 0 .and. !Empty((cAliasSD1)->D1_GRPCST),(cAliasSD1)->D1_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //[40]\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aprod[41] NT2015/003\r\n\t\t\t\t\t\t\t\tIIF(SF4->(ColumnPos(\"F4_VENPRES\"))>0,SF4->F4_VENPRES,\"\"),; //aprod[42] utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\t\t\tnValIFecp ,; //aprod[43]  Valor do FECP. \r\n\t\t\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),; //aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),; //aprod[46] \r\n\t\t\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\t\t\tSF4->F4_ART274,; //aprod[48]\r\n\t\t\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\tEndIf\t\r\n\t\t\t\t*/\r\n\t\t\t\t\t\r\n\t\t\t\t\t        \r\n\t\t\t\taadd(aCST,{IIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,2,2),'50'),;\r\n\t\t\t\t\tIIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,1,1),'0')})\r\n\t\t\t\taadd(aICMS,{})\r\n\t\t\t\taadd(aIPI,{})\r\n\t\t\t\taadd(aICMSST,{})\r\n\t\t\t\taadd(aPIS,{})\r\n\t\t\t\taadd(aPISST,{})\r\n\t\t\t\taadd(aCOFINS,{})\r\n\t\t\t\taadd(aCOFINSST,{})\r\n\t\t\t\taadd(aISSQN,{})\r\n\t\t\t\taadd(aPisAlqZ,{})\r\n\t\t\t\taadd(aCofAlqZ,{})\r\n\t\t\t\taadd(aCsosn,{})\r\n\t\t\t\taadd(aFCI,{})\r\n\t\t\t\taadd(aICMUFDest,{})\r\n\t\t\t\taadd(aIPIDevol,{})\r\n\r\n\t\t\t\tDbSelectArea(\"SC7\")\r\n\t\t\t\tDbSetOrder(1)\r\n\t\t\t\tIf MsSeek(xFilial(\"SC7\")+(cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEM)\r\n\t\t\t\t\taadd(aPedCom,{SC7->C7_NUM,SC7->C7_ITEM})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aPedCom,{})\r\n\t\t\t\tEndif\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento para TAG Exportação quando existe a integração com a EEC     ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf lEECFAT\r\n\t\t\t\t\t/*Alterações TQXWO2\r\n\t\t\t\t\tNa chamada da função, foram criados dois novos parâmetros: \r\n\t\t\t\t\to 3º referente ao código do produto e o 4º referente ao número da nota fiscal + série (chave).\r\n\t\t\t\t\tGetNfeExp(pProcesso, pPedido, cProduto, cChave)\r\n\t\t\t\t\tNo retorno da função serão devolvidas as informações do legado, conforme leiaute anterior à versão 3.10 , \r\n\t\t\t\t\te as informações dos grupos “I03 - Produtos e Serviços / Grupo de Exportação” e “ZA - Informações de Comércio Exterior”, conforme estrutura da NT20013.005_v1.21.\r\n\t\t\t\t\tAs posições 1 e 2 mantém o retorno das informações ZA02 e ZA03, mantendo o legado para os cliente que utilizam versão 2.00\r\n\t\t\t\t\tNa posição 3 passa a ser enviado o agrupamento do ID I50, tendo como filhos os IDs I51 e I52.\r\n\t\t\t\t\tNa posição 4 passa a ser enviado o agrupamento do ZA01, tendo como filhos os IDs ZA02, ZA03 e ZA04.\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tO array de retorno será multimensional, trazendo na primeira posição o identificador (ID), \r\n\t\t\t\t\tnasegunda posição a tag (o campo) e na terceira posição o conteúdo retornado do processo, \r\n\t\t\t\t\t\tpodendo ser um outro array com a mesma estrutura caso o ID possua abaixo de sua estrutura outros IDs.\t\t\t\t\t\t \t\t\t\t\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf !Empty((cAliasSD2)->D2_PREEMB) .and. ((cAliasSD2)->D2_DOC == (cAliasSD1)->D1_NFORI)\r\n\t\t\t\t\t\taExp:= {}\t\r\n\t\t\t\t\t\taadd(aExp,(GETNFEEXP((cAliasSD2)->D2_PREEMB,,cCodProd,(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE,(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV)))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElseiF AliasIndic(\"CDL\")\r\n\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\tDbSelectArea(\"CDL\")\r\n\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\tDbSeek(xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\t\t\t\t\tWhile !CDL->(Eof()) .And. CDL->CDL_FILIAL+CDL->CDL_DOC+CDL->CDL_SERIE+CDL->CDL_CLIENT+CDL->CDL_LOJA == xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA\r\n\t\t\t\t\t\t\tIf CDL->(FieldPos(\"CDL_PRODNF\")) <> 0 .And. CDL->(FieldPos(\"CDL_ITEMNF\")) <> 0 .And. AllTrim(CDL->CDL_PRODNF)+AllTrim(CDL->CDL_ITEMNF) == AllTrim((cAliasSD2)->D2_COD)+AllTrim((cAliasSD2)->D2_ITEM)\r\n\t\t\t\t\t\t\t\taDados := {}\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"I53\",\"nRE\", IIf(CDL->(ColumnPos(\"CDL_NRREG\"))>0,CDL->CDL_NRREG,\"\") })\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"I54\",\"chNFe\",SF2->F2_CHVNFE,\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"I55\",\"qExport\",(cAliasSD1)->D1_QUANT})\t\t\t\t\t\t\t    \r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t    \t\r\n\t\t\t\t\t\t\t\taAdd(aExp[Len(aExp)],aDados)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\t\t    \tCDL->(DbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\tEndIf\t\t\r\n\t\t\t\t\r\n\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t//|                                                             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\tDbSelectArea(\"SF2\")\r\n\t\t\t\tDbSetOrder(1)\r\n\t\t\t\tIf MsSeek(xFilial(\"SF2\")+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI)\r\n\t\t\t\t\tIf AllTrim(SF2->F2_ESPECIE)==\"CF\"\r\n\t\t\t\t\t\taadd(aRefECF,{SF2->F2_DOC,SF2->F2_ESPECIE,\"\"})\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf lEasy  .And. !Empty((cAliasSD1)->D1_TIPO_NF)\r\n\r\n\t\t\t\t\tcTipoNF \t:= (cAliasSD1)->D1_TIPO\r\n\t\t\t\t\tcDocEnt \t:= (cAliasSD1)->D1_DOC\r\n\t\t\t\t\tcSerEnt \t:= (cAliasSD1)->D1_SERIE\r\n\t\t\t\t\tcFornece\t:= (cAliasSD1)->D1_FORNECE\r\n\t\t\t\t\tcLojaEnt\t:= (cAliasSD1)->D1_LOJA\r\n\t\t\t\t\tcTipoNFEnt\t:= (cAliasSD1)->D1_TIPO_NF\r\n\t\t\t\t\tcPedido \t:= (cAliasSD1)->D1_PEDIDO\r\n\t\t\t\t\tcItemPC \t:= (cAliasSD1)->D1_ITEMPC\r\n\t\t\t\t\tcNFOri  \t:= (cAliasSD1)->D1_NFORI\r\n\t\t\t\t\tcSerOri \t:= (cAliasSD1)->D1_SERIORI\r\n\t\t\t\t\tcItemOri\t:= (cAliasSD1)->D1_ITEMORI\r\n\t\t\t\t\tcProd   \t:= (cAliasSD1)->D1_COD\r\n\t\t\t\t\tcLote\t\t:= (cAliasSD1)->D1_LOTECTL\r\n\t\t\t\t\tcItem\t\t:= (cAliasSD1)->D1_ITEM\r\n\r\n\t\t\t\t\tIf !cTipoNF$\"IPC\" .And. cTipoNFEnt <> \"6\"\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para TAG Importação quando existe a integração com a EIC  (Se a nota for primeira ou unica)|\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\taadd(aDI,(GetNFEIMP(.F.,cDocEnt,cSerEnt,cFornece,cLojaEnt,cTipoNFEnt,cPedido,cItemPC,cLote,cItem)))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para TAG Importação quando existe a integração com a EIC  (Se a nota for complementar)     |\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\taadd(aDI,(GetNFEIMP(.F.,cNFOri,cSerOri,cFornece,cLojaEnt,cTipoNFEnt, ,cItemOri, ,cItem )))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taAdi := aDI\r\n\t\t\t\t// Se não o parâmetro de integração entre o SIGAEIC e o SIGAFAT estiver desabilitado,\r\n\t\t\t\t//   procura as informações da importação da tabela CD5 (complemento de importação).\r\n\t\t\t\tElseIf !lEasy .Or. (lEasy .AND. (cAliasSD1)->D1_TIPO $ \"DCPI\")\r\n\t\t\t\t\tDbSelectArea(\"CD5\")\r\n\t\t\t\t\tDbSetOrder(4)\r\n\t\t\t\t\t// Procura algum registro na CD5 referente a nota que foi complementada\r\n\t\t\t\t\tIf MsSeek(xFilial(\"CD5\")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_ITEM)\r\n\t\t\t\t\t\t\taAdd(aDI,{;\r\n\t\t\t\t\t\t\t\t{\"I04\",\"NCM\",SB1->B1_POSIPI},;\t\t\t\t//1\r\n\t\t\t\t\t\t\t\t{\"I15\",\"vFrete\",0},;\t\t\t\t\t\t\t//2\r\n\t\t\t\t\t\t\t\t{\"I16\",\"vSeg\",0},;\t\t\t\t\t\t\t//3\r\n\t\t\t\t\t\t\t\t{\"I19\",\"nDI\",Iif(!Empty(CD5->CD5_NDI),CD5->CD5_NDI,\"NIHIL\")},;\t\t//4\r\n\t\t\t\t\t\t\t\t{\"I20\",\"dDI\",CD5->CD5_DTDI},;\t\t\t\t//5\r\n\t\t\t\t\t\t\t\t{\"I21\",\"xLocDesemb\",CD5->CD5_LOCDES},;\t\t//6\r\n\t\t\t\t\t\t\t\t{\"I22\",\"UFDesemb\",CD5->CD5_UFDES},;\t\t//7\r\n\t\t\t\t\t\t\t\t{\"I23\",\"dDesemb\",CD5->CD5_DTDES},;\t\t\t//8\r\n\t\t\t\t\t\t\t\t{\"I24\",\"cExportador\",CD5->CD5_CODEXP},;\t//9\r\n\t\t\t\t\t\t\t\t{\"I26\",\"nAdicao\",Val(CD5->CD5_NADIC)},;\t//10\r\n\t\t\t\t\t\t\t\t{\"I27\",\"nSeqAdi\",Val(CD5->CD5_SQADIC)},;\t//11\r\n\t\t\t\t\t\t\t\t{\"I28\",\"cFabricante\",CD5->CD5_CODFAB},;\t//12\r\n\t\t\t\t\t\t\t\t{\"I29\",\"vDescDI\",0},;\t\t\t\t\t\t//13\r\n\t\t\t\t\t\t\t\t{\"N14\",\"pRedBC\",0},;\t\t\t\t\t\t\t//14\r\n\t\t\t\t\t\t\t\t{\"O11\",\"qUnid\",0},;\t\t\t\t\t\t\t//15\r\n\t\t\t\t\t\t\t\t{\"O12\",\"vUnid\",0},;\t\t\t\t\t\t\t//16\r\n\t\t\t\t\t\t\t\t{\"P02\",\"vBC\",CD5->CD5_BCIMP},;\t\t\t\t//17\r\n\t\t\t\t\t\t\t\t{\"P03\",\"vDespAdu\",CD5->CD5_DSPAD},;\t\t\t//18\r\n\t\t\t\t\t\t\t\t{\"P04\",\"vII\",(cAliasSD1)->D1_II},;\t\t\t//19\r\n\t\t\t\t\t\t\t\t{\"P05\",\"vIOF\",CD5->CD5_VLRIOF},;\t\t\t//20\r\n\t\t\t\t\t\t\t\t{\"Q10\",\"qBCProd\",0},;\t\t\t\t\t\t//21\r\n\t\t\t\t\t\t\t\t{\"Q11\",\"vAliqProd\",0},;\t\t\t\t\t\t//22\r\n\t\t\t\t\t\t\t\t{\"S09\",\"qBCProd\",0},;\t\t\t\t\t\t//23\r\n\t\t\t\t\t\t\t\t{\"S10\",\"vAliqProd\",0},;\t\t\t\t\t\t//24\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t{\"X04\",\"CNPJ\",0},;\t\t\t\t\t\t\t//25\r\n\t\t\t\t\t\t\t\t{\"X06\",\"xNome\",0},;\t\t\t\t\t\t\t//26\r\n\t\t\t\t\t\t\t\t{\"X07\",\"IE\",0},;\t\t\t\t\t\t\t\t//27\r\n\t\t\t\t\t\t\t\t{\"X08\",\"xEnder\",0},;\t\t\t\t\t\t\t//28\r\n\t\t\t\t\t\t\t\t{\"X09\",\"xMun\",0},;\t\t\t\t\t\t\t//29\r\n\t\t\t\t\t\t\t\t{\"X10\",\"UF\",0},;\t\t\t\t\t\t\t\t//30\r\n\t\t\t\t\t\t\t\t{\"XXX\",\"Emaildesp\",0},;\t\t\t\t\t\t//31\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t{\"HOU\",\"house\",0},;\t\t\t\t\t\t\t//32\r\n\t\t\t\t\t\t\t\t{\"DES\",\"cDesp\",0},;\t\t\t\t\t\t\t//33\r\n\t\t\t\t\t\t\t\t{\"129A\",\"nDraw\",IIf(CD5->(FieldPos(\"CD5_ACDRAW\")) > 0,CD5->CD5_ACDRAW,\"\")},;\t\t\t//34\r\n\t\t\t\t\t\t\t\t{\"105a\",\"NVE\",0},;\t\t\t\t\t\t\t//35\r\n\t\t\t\t\t\t\t\t{\"I23a\",\"tpViaTransp\",IIf(CD5->(FieldPos(\"CD5_VTRANS\")) > 0,CD5->CD5_VTRANS,\"\")},;\t//36\r\n\t\t\t\t\t\t\t\t{\"I23b\",\"vAFRMM\",IIf(CD5->(FieldPos(\"CD5_VAFRMM\")) > 0,CD5->CD5_VAFRMM,\"\")},;\t\t\t//37\r\n\t\t\t\t\t\t\t\t{\"I23c\",\"tpIntermedio\",IIf(CD5->(FieldPos(\"CD5_INTERM\")) > 0,CD5->CD5_INTERM,\"\")},;\t//38\r\n\t\t\t\t\t\t\t\t{\"I23d\",\"CNPJ\",IIf(CD5->(FieldPos(\"CD5_CNPJAE\")) > 0,CD5->CD5_CNPJAE,\"\")},;\t\t\t//39\r\n\t\t\t\t\t\t\t\t{\"I23e\",\"UFTerceiro\",IIf(CD5->(FieldPos(\"CD5_UFTERC\")) > 0,CD5->CD5_UFTERC,\"\")}})\t//40\r\n\t\t\t\t\t\t// O array aAdi deve ser identico ao aDI para futuro tratamento neste fonte\r\n\t\t\t\t\t\taAdi := aDI\r\n\t\t\t\t\t// Caso nenhum registro de complemento de importação para essa nota exista, coloca os arrays em branco\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aAdi,{})\r\n\t\t\t\t\t\taadd(aDi,{})\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aAdi,{})\r\n\t\t\t\t\taadd(aDi,{})\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf (cAliasSD1)->D1_BASEIRR > 0  .And. (cAliasSD1)->D1_VALIRR > 0 \r\n\t\t\t\t\tnBaseIrrf += (cAliasSD1)->D1_BASEIRR\r\n\t\t\t\t\tnValIrrf  += (cAliasSD1)->D1_VALIRR \r\n\t\t\t\tEndIf\t\r\n\r\n\t\t\t\tIf AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0  .And. CD6->(FieldPos(\"CD6_BCCIDE\")) > 0 .And. CD6->(FieldPos(\"CD6_VALIQ\")) > 0 .And. CD6->(FieldPos(\"CD6_VCIDE\")) > 0\r\n\t\t\t\t\taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t         CD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t         CD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t         CD6->CD6_UFCONS,;\r\n\t\t\t\t\t\t         CD6->CD6_BCCIDE,;\r\n\t\t\t\t\t\t         CD6->CD6_VALIQ,;\r\n\t\t\t\t\t\t         CD6->CD6_VCIDE,;\r\n\t\t\t\t\t\t         IIf(CD6->(FieldPos(\"CD6_MIXGN\")) > 0,CD6->CD6_MIXGN,\"\"),;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_DESANP\")) > 0,CD6->CD6_DESANP,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_PGLP\")) > 0,CD6->CD6_PGLP,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_PGNN\")) > 0,CD6->CD6_PGNN,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_PGNI\")) > 0,CD6->CD6_PGNI,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_VPART\")) > 0,CD6->CD6_VPART,\"\"),;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t     0})\r\n\t\t\t    Elseif AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0 \r\n\t\t\t\t\taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_UFCONS,; \r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,; \r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aComb,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf AliasIndic(\"CD7\")\r\n\t\t\t\t\taadd(aMed,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,CD7->CD7_PRECO,IIf(CD7->(FieldPos(\"CD7_CODANV\")) > 0,CD7->CD7_CODANV,\"\"),IIf(CD7->(ColumnPos(\"CD7_MOTISE\")) > 0,CD7->CD7_MOTISE,\"\")})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aMed,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf AliasIndic(\"CD8\")\r\n\t\t\t\t\taadd(aArma,{CD8->CD8_TPARMA,CD8->CD8_NUMARM,CD8->CD8_DESCR})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aArma,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf AliasIndic(\"CD9\")\r\n\t\t\t\t\taadd(aveicProd,{CD9->CD9_TPOPER,CD9->CD9_CHASSI,CD9->CD9_CODCOR,CD9->CD9_DSCCOR,CD9->CD9_POTENC,CD9->CD9_CM3POT,CD9->CD9_PESOLI,;\r\n\t\t\t\t\t                CD9->CD9_PESOBR,CD9->CD9_SERIAL,CD9->CD9_TPCOMB,CD9->CD9_NMOTOR,CD9->CD9_CMKG,CD9->CD9_DISTEI,CD9->CD9_RENAVA,;\r\n\t\t\t\t\t                CD9->CD9_ANOMOD,CD9->CD9_ANOFAB,CD9->CD9_TPPINT,CD9->CD9_TPVEIC,CD9->CD9_ESPVEI,CD9->CD9_CONVIN,CD9->CD9_CONVEI,;\r\n\t\t\t\t\t                CD9->CD9_CODMOD,;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CILIND\")>0,CD9_CILIND,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_TRACAO\")>0,CD9_TRACAO,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_LOTAC\")>0,CD9_LOTAC,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CORDE\")>0,CD9_CORDE,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_RESTR\")>0,CD9_RESTR,\"\"))})\r\n\t\t\t\tElse\r\n\t\t\t\t    aadd(aveicProd,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento para Rastreamento de Lote - Cabecalho e Itens   \r\n\t\t\t\t// Primeiro busca no compl. de rastreabilidade (F0A) e  depois compl.de medicamento (CD7)                ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\tIf AliasIndic(\"F0A\")  .AND. F0A->(FieldPos(\"F0A_LOTE\")) > 0 .And. !Empty(F0A->F0A_LOTE)\t\r\n\t\t\t\t\taadd(aLote,{IIf(F0A->(FieldPos(\"F0A_LOTE\")) > 0,F0A->F0A_LOTE,\"\"),;\r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_QTDLOT\")) > 0,F0A->F0A_QTDLOT,\"\"),;\r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_FABRIC\")) > 0,F0A->F0A_FABRIC,\"\"),;\r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_VALID\")) > 0,F0A->F0A_VALID ,\"\"),;  \r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_CODAGR\")) > 0,F0A->F0A_CODAGR ,\"\")})  \r\n\t\t\t\tElseIf !Empty(aMed) .And. !Empty(aMed[1][1])\r\n\t\t\t\t\taadd(aLote,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,\"\"})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aLote,{})\r\n\t   \t\t\tEndIf\t\r\n\t   \t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento para Anfavea - Cabecalho e Itens                             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\r\n\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t//Cabecalho\r\n\t\t\t\t\taadd(aAnfC,{CDR->CDR_VERSAO,CDR->CDR_CDTRAN,CDR->CDR_NMTRAN,CDR->CDR_CDRECP,CDR->CDR_NMRECP,;\r\n\t\t\t\t\t\tAModNot(CDR->CDR_ESPEC),CDR->CDR_CDENT,CDR->CDR_DTENT,CDR->CDR_NUMINV}) \r\n\t\t\t\t\t//Itens\r\n\t\t\t\t\taadd(aAnfI,{CDS->CDS_PRODUT,CDS->CDS_PEDCOM,CDS->CDS_SGLPED,CDS->CDS_SEPPEN,CDS->CDS_TPFORN,;\r\n\t\t\t\t\t\tCDS->CDS_UM,CDS->CDS_DTVALI,CDS->CDS_PEDREV,CDS->CDS_CDPAIS,CDS->CDS_PBRUTO,CDS->CDS_PLIQUI,;\r\n\t\t\t\t\t\tCDS->CDS_TPCHAM,CDS->CDS_NUMCHA,CDS->CDS_DTCHAM,CDS->CDS_QTDEMB,CDS->CDS_QTDIT,CDS->CDS_LOCENT,;\r\n\t\t\t\t\t\tCDS->CDS_PTUSO,CDS->CDS_TPTRAN,CDS->CDS_LOTE,CDS->CDS_CPI,CDS->CDS_NFEMB,CDS->CDS_SEREMB,;\r\n\t\t\t\t\t\tCDS->CDS_CDEMB,CDS->CDS_AUTFAT,CDS->CDS_CDITEM})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aAnfC,{})\r\n\t\t\t\t\taadd(aAnfI,{})\r\n\t   \t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\tIf !(cAliasSD1)->D1_TIPO $ \"DB\"\t\t\t\r\n\t\t\t\t\tdbSetOrder(2)\r\n\t\t\t\tElse\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf SFT->(DbSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+D1_ITEM+D1_COD)))\r\n\t\t\t\t   aadd(aCSTIPI,{SFT->FT_CTIPI})\r\n\t\t\t\t   //TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t\t   //PEGA OS VALORES E PERCENTUAL DO INNCENTIVO NOS ITENS NA SFT.\r\n\t\t\t\t   If SFT->(FieldPos(\"FT_PRINCMG\")) > 0 .And. SFT->(FieldPos(\"FT_VLINCMG\")) > 0\r\n\t\t\t\t\t\tIf SFT->FT_VLINCMG > 0\r\n\t\t\t\t\t\t\tnValLeite += SFT->FT_VLINCMG\r\n\t\t\t\t\t\t\taprod[Len(aProd)][49]:=  SFT->FT_VLINCMG\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf nPercLeite == 0 .And. SFT->FT_PRINCMG > 0 \r\n\t\t\t\t\t\t\tnPercLeite := SFT->FT_PRINCMG\r\n\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\tEndIF\r\n\t\t\t\tElseIf substr((cAliasSD1)->D1_CF,1,1) ==\"3\"\r\n\t\t\t\t\taadd(aCSTIPI,{SF4->F4_CTIPI})\t\t\t\t\t\t\t\t\r\n\t\t\t\tEndIf \r\n\t\t\t\t\r\n\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t//Posiciona novente na SF1 do documento que esta sendo processado\t\t\t\t\r\n\t\t\t\tSF1->(MsSeek(xFilial(\"SF1\")+(cAliasSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_TIPO)))\r\n\t\t\t\tCD2->(MsSeek(xFilial(\"CD2\")+\"E\"+SF1->F1_SERIE+SF1->F1_DOC+SF1->F1_FORNECE+SF1->F1_LOJA+PadR((cAliasSD1)->D1_ITEM,4)+(cAliasSD1)->D1_COD))\r\n\t\t\t\tWhile !CD2->(Eof()) .And. xFilial(\"CD2\") == CD2->CD2_FILIAL .And.;\r\n\t\t\t\t\t\"E\" == CD2->CD2_TPMOV .And.;\r\n\t\t\t\t\tSF1->F1_SERIE == CD2->CD2_SERIE .And.;\r\n\t\t\t\t\tSF1->F1_DOC == CD2->CD2_DOC .And.;\r\n\t\t\t\t\tSF1->F1_FORNECE == IIF(!(cAliasSD1)->D1_TIPO $ \"DB\",CD2->CD2_CODFOR,CD2->CD2_CODCLI) .And.;\r\n\t\t\t\t\tSF1->F1_LOJA == IIF(!(cAliasSD1)->D1_TIPO $ \"DB\",CD2->CD2_LOJFOR,CD2->CD2_LOJCLI) .And.;\t\t\t\t\r\n\t\t\t\t\t(cAliasSD1)->D1_ITEM == SubStr(CD2->CD2_ITEM,1,Len((cAliasSD1)->D1_ITEM)) .And.;\r\n\t\t\t\t\t(cAliasSD1)->D1_COD == CD2->CD2_CODPRO\r\n\t\t\t\t\t\r\n\t\t\t\t\tnMargem :=  IiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC == 100,CD2->CD2_PREDBC,IF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC)),IiF(Len(aAdI[1])>0 .And. ConvType(aAdI[1][04][01]) == \"I19\",IiF((aAdi[1][14][03]) > 100,0,aAdi[1][14][03]),CD2->CD2_PREDBC))\r\n\t\t\t\t\t\r\n\t\t\t\t\tSF7->(DbSetOrder(1))\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tSA2->(DbSetOrder(1))\r\n\t\t\t\t\tSA1->(DbSetOrder(1))\r\n\r\n\t\t\t\t\tIF !(cAliasSD1)->D1_TIPO $ \"DB\"\r\n\t\t\t\t\t\tIf SA2->(DbSeek(xFilial(\"SA2\")+SF1->F1_FORNECE+SF1->F1_LOJA))\r\n\t\t\t\t\t\t\tIf SF7->(DbSeek(xFilial(\"SF7\")+SB1->B1_GRTRIB+SA2->A2_GRPTRIB))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf  SF7->F7_BASEICM > 0 .And. SF7->F7_BASEICM < 100\r\n\t\t\t\t\t\t\t\t\tnMargem :=  100 - SF7->F7_BASEICM\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n            \t        EndIf\r\n                    Else\r\n\t\t\t\t\t\tIf SA1->(DbSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA))\r\n\t\t\t\t\t\t\tIf SF7->(DbSeek(xFilial(\"SF7\")+SB1->B1_GRTRIB+SA1->A1_GRPTRIB))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf  SF7->F7_BASEICM > 0 .And. SF7->F7_BASEICM < 100\r\n\t\t\t\t\t\t\t\t\tnMargem :=  100 - SF7->F7_BASEICM\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n            \t        EndIf                    \r\n                    EndIf \r\n                    // Verifica se existe percentual de reducao na SFT referente ao RICMS 43080/2002 MG.\r\n\t\t\t\t\tIf SFT->(FieldPos(\"FT_PR43080\")) <> 0 .And. SFT->FT_PR43080 <> 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\t\tnMargem := SFT->FT_PR43080\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf SubStr((cAliasSD1)->D1_CLASFIS,2,2) $ '51'\t .and. !Empty(SFT->FT_ICMSDIF)           .and. SFT->(ColumnPos(\"FT_VOPDIF\")) > 0  .and. !Empty(SFT->FT_VOPDIF) .or.; // verifica diferimento com bloqueio de movimento\r\n\t\t\t\t\t\tSubStr((cAliasSD1)->D1_CLASFIS,2,2) $ '51' .and. !Empty((cAliasSD1)->(D1_ICMSDIF)) .and. SD1->(ColumnPos(\"D1_VOPDIF\")) > 0  .and. !Empty((cAliasSD1)->(D1_VOPDIF)) .and. SF1->(F1_STATUS) == 'C'\r\n\t\t\t\t\t\tlDifer :=.T.\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tlDifer := .F. //Reinicialização da variável\r\n\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tDo Case\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ICM\"\r\n\t\t\t\t\t\t\taTail(aICMS) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\t\t  CD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\t\t  CD2->CD2_MODBC,; \r\n\t\t\t\t\t\t\t                  nMargem,;// Tratamento para obter o percentual da redução de base do icms nota interna e importacao(integracao com EIC)\t\t\t\t\t\t\t                  \r\n\t\t\t\t\t\t\tCD2->CD2_BC,;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), If(lNfCupZero,0,Iif(CD2->CD2_BC>0,xFisRetFCP('4.0','CD2','CD2_ALIQ'),0)), Iif(CD2->CD2_BC>0,CD2->CD2_ALIQ,0)),;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), iif(!lDifer,xFisRetFCP('4.0','CD2','CD2_VLTRIB'),iif(SF1->(F1_STATUS) == 'C',(cAliasSD1)->(D1_VOPDIF),xFisRetFCP('4.0','SFT','FT_VOPDIF'))),Iif(!lDifer,CD2->CD2_VLTRIB,SFT->FT_VOPDIF)),;//Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), Iif(!lDifer,xFisRetFCP('4.0','CD2','CD2_VLTRIB'),xFisRetFCP('4.0','SFT','FT_VOPDIF')), Iif(!lDifer,CD2->CD2_VLTRIB,SFT->FT_VOPDIF)),; \r\n\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\"),;\r\n\t\t\t\t\t\t\tIIF(SF1->(F1_STATUS) == 'C', (cAliasSD1)->(D1_ICMSDIF),SFT->FT_ICMSDIF),;\r\n\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\tSF4->F4_ICMSDIF,;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,CD2->CD2_BFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,CD2->CD2_PFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,CD2->CD2_VFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BSTANT\")) > 0,SFT->FT_BSTANT,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_VSTANT'),0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_PSTANT'),0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BFCANTS\")) > 0,SFT->FT_BFCANTS,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PFCANTS\")) > 0,SFT->FT_PFCANTS,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VFCANTS\")) > 0,SFT->FT_VFCANTS,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VICPRST\")) > 0,SFT->FT_VICPRST,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,0)}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnCon++\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\tnValICMParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\tnBasICMParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"SOL\"\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taTail(aICMSST) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\tCD2->CD2_PREDBC,;\r\n\t\t\t\t\t\t\tCD2->CD2_BC,;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_ALIQ'),CD2->CD2_ALIQ),;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'),CD2_VLTRIB),;\r\n\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,CD2->CD2_BFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,CD2->CD2_PFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,CD2->CD2_VFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\")}   \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf lConsig .And. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM)  .And. CD2->CD2_VLTRIB > 0\r\n\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\")}\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\tnValSTParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\tnBasSTParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tlCalSol := .T.\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Tratamento CAT04 de 26/02/2010                       ³\r\n\t\t\t\t\t\t\t//³Verifica de deve ser garavado no xml o valor e base  ³\r\n\t\t\t\t\t\t\t//³de calculo do ICMS ST para notas fiscais de devolucao³\r\n\t\t\t\t\t\t\t//³Verifica o parametro MV_ICSTDEV                      ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnValST \t:= Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'), CD2->CD2_VLTRIB)\r\n\t\t\t\t\t\t\t//para a 4.0 devera exibir a informação Valor do ICMS ST não majorado.\r\n\t\t\t\t\t\t\tIf cVerAmb == \"4.00\" .and. nValST > 0 .And. lConsig\r\n\t\t\t\t\t\t\t\tnSTConsig += nValST\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf !lIcmSTDev\r\n\t\t\t\t\t\t\t\tIf ( (cAliasSD1)->D1_TIPO==\"D\" .Or. ( (cAliasSD1)->D1_TIPO==\"I\" .And. lComplDev)) .And. !Empty(nValST) \r\n\t\t\t\t\t\t\t\t\tnValSTAux := nValSTAux + nValST\r\n\t\t\t\t\t\t\t\t\tnBsCalcST := nBsCalcST + CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\tnValST \t  := 0\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\")}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t   \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"IPI\"\r\n\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_QTRIB,CD2->CD2_PAUTA,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_MODBC,CD2->CD2_PREDBC}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnValIPI := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf (((cAliasSD1)->D1_TIPO == \"D\" .and. !lEipiDev))  .Or. ((cAliasSD1)->D1_TIPO == \"B\" .And. lIpiBenef .and. !Empty(nValIPI)) .Or. lEIPIOutro .Or. lIPIOutB\r\n\t\t\t\t   \t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"B\" .And. lIpiBenef .and. !Empty(nValIPI)) .or. lIPIOutB\r\n\t\t\t\t   \t\t\t\t\tnValIpiBene += nValIPI  // Quando lIpiBenef = T leva IPI em vOutro e Inf. Adic.\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t \r\n\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,CD2->CD2_PREDBC}\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t/*Chamado TTVZJG - Grupo impostoDevol - informar o percentual e valor do IPI devolvido, em notas de devolução (finNFe =4)\r\n\t\t\t\t\t\t\tIncluida a verificação do campo F4_PODER3=D para os casos de retorno de beneficiamento*/\r\n\t\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"D\" .Or. SF4->F4_PODER3 == \"D\") .And. ((CD2->(FieldPos(\"CD2_PDEVOL\")) > 0 .And. !Empty(CD2->CD2_PDEVOL) .Or. (SF4->F4_QTDZERO == \"1\")) .And. cTPNota == \"4\")\r\n\t\t\t\t\t\t\t\tIf (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM )\r\n\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}\r\n\t\t\t\t\t\t\t\tElseIf cVerAmb >= \"4.00\" .And. (((cAliasSD1)->D1_TIPO == \"D\" .and. (lEipiDev .Or. lEIPIOutro)) .or.((cAliasSD1)->D1_TIPO == \"B\" .and. (!lIpiBenef .Or. lIPIOutB)))\r\n\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,0}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf        \t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS2\"\r\n\t\t\t\t\t\t\tIf (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\t\taTail(aPIS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\taISS[04]          += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF2\"\r\n\t\t\t\t\t\t\tIf (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\t\taTail(aCOFINS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\taISS[05] += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS3\" .And. (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\taTail(aPISST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF3\" .And. (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\taTail(aCOFINSST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ISS\"\r\n\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\taISS[01] += (cAliasSD1)->D1_TOTAL\r\n\t\t\t\t\t\t\taISS[02] += CD2->CD2_BC\r\n\t\t\t\t\t\t\taISS[03] += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\r\n\t\t\t\t\t\t\t\tIf SF3->F3_RECISS ==\"1\"\r\n\t\t\t\t\t\t\t\t\tcSitTrib := \"R\"\r\n\t\t\t\t\t\t\t\tElseif SF3->F3_RECISS ==\"2\"\r\n\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\tElseif SF4->F4_LFISS ==\"I\"\r\n\t\t\t\t\t\t\t\t\tcSitTrib:= \"I\"\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF SF4->F4_ISSST == \"1\" .or. Empty(SF4->F4_ISSST)\r\n\t\t\t\t\t\t\t\tcIndIss := \"1\" //1-Exigível;\r\n\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"2\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"2\"\t//2-Não incidência\r\n\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"3\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"3\" //3-Isenção\r\n\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"4\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"5\"\t //5-Imunidade\r\n\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"5\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"6\"\t //6-Exigibilidade Suspensa por Decisão Judicial\r\n\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"6\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"7\"\t //7-Exigibilidade Suspensa por Processo Administrativo\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcIndIss := \"4\"//4-Exportação\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Pega as deduções ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSSUB\"))>0\r\n\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSSUB\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSMAT\"))>0\r\n\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSMAT\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Verifica se recolhe ISS Retido ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t\tIf SF3->F3_RECISS $\"1|S\"  \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tnValISSRet := SFT->FT_VALICM // Valor do ISSRET por item\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t// If SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t// \tIf SF3->F3_RECISS $\"1|S\"       \r\n\t\t\t\t\t\t\t// \t\tIf SF3->(dbSeek(xFilial(\"SF3\")+SF1->F1_FORNECE+SF1->F1_LOJA+SF1->F1_DOC+SF1->F1_SERIE))\r\n\t\t\t\t\t\t\t// \t\t\tWhile !SF3->(EOF()) .And. xFilial(\"SF3\")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE==SF1->F1_FILIAL+SF1->F1_FORNECE+SF1->F1_LOJA+SF1->F1_DOC+SF1->F1_SERIE\r\n\t\t\t\t\t\t\t// \t\t\t\tIf SF3->F3_TIPO==\"S\" //Serviço\r\n\t\t\t\t\t\t\t// \t\t\t\t\tnValISSRet+= SF3->F3_VALICM\r\n\t\t\t\t\t\t\t// \t\t\t\tEndIf\r\n\t\t\t\t\t\t\t// \t\t\t\tSF3->(dbSkip())\r\n\t\t\t\t\t\t\t// \t\t\tEndDo\r\n\t\t\t\t\t\t\t// \t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t   \t// \tEndif\r\n\t\t\t\t\t\t\t// EndIf\r\n\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taTail(aISSQN) := {CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,\"\",AllTrim((cAliasSD1)->D1_CODISS),cSitTrib,nDeducao,cIndIss,nValISSRet}\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CMP\" //ICMSUFDEST\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taTail(aICMUFDest) := {IIf(CD2->CD2_BC > 0,CD2->CD2_BC, 0),; //[1]vBCUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PFCP\")) > 0 .and. CD2->CD2_PFCP > 0,CD2->CD2_PFCP,0),;  //[2]pFCPUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->CD2_ALIQ > 0,CD2->CD2_ALIQ,0),;//[3]pICMSUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_ADIF\")) > 0 .and. CD2->CD2_ADIF > 0,CD2->CD2_ADIF,0),;//[4]pICMSInter\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PDDES\")) > 0 .and. CD2->CD2_PDDES > 0,CD2->CD2_PDDES,0),;//[5]pICMSInterPart\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VFCP\")) > 0 .and. CD2->CD2_VFCP > 0,CD2->CD2_VFCP,0),;//[6]vFCPUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VDDES\")) > 0 .and. CD2->CD2_VDDES > 0,CD2->CD2_VDDES,0),;//[7]vICMSUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VLTRIB\")) > 0 .and. CD2->CD2_VLTRIB > 0,CD2->CD2_VLTRIB,0)}//[8]vICMSUFRemet\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ZFM\"\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tcICMSZFM := If(CD2->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,\"\")\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndCase\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf nValSTAux > 0 \r\n\t\t\t\t\t\tcValST  := AllTrim(Str(nValSTAux,15,2))\r\n\t\t\t\t\t\tcBsST   := AllTrim(Str(nBsCalcST,15,2))\r\n\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\tIf lComplDev .And.  nBsCalcST == 0\r\n\t\t\t\t\t\t\tcMensCli += \"(Valor do ICMS ST: R$ \"+cValST+\") \" \t\t\t\t\t\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS ST: R$ \"+cBsST+ \" - \"+\"Valor do ICMS ST: R$ \"+cValST+\") \"\r\n\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\tcValST\t  := \"\"  \r\n\t\t\t\t\t\tcBsST \t  := \"\"   \r\n\t\t\t\t\t\tnBsCalcST := 0\r\n\t\t\t\t\t\tnValSTAux := 0\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\tEndDo\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf SFT->FT_DESCZFR>0  .OR. !Empty(cICMSZFM)\r\n\t\t\t\t\taadd(aICMSZFM,{If(SFT->(ColumnPos(\"FT_DESCZFR\")) > 0,SFT->FT_DESCZFR,\"\"),;\r\n\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\"),;\r\n\t\t\t\t\tcICMSZFM})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aICMSZFM,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"SFT\") //Livro Fiscal Por Item da NF\r\n\t\t\t\tdbSetOrder(1) //FT_FILIAL+FT_TIPOMOV+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM+FT_PRODUTO\r\n\t\t\t\tIf MsSeek(xFilial(\"SFT\")+\"E\"+SF1->F1_SERIE+SF1->F1_DOC+SF1->F1_FORNECE+SF1->F1_LOJA+PadR((cAliasSD1)->D1_ITEM,4)+(cAliasSD1)->D1_COD) .And. ;\r\n\t\t\t\t\tSFT->(FieldPos(\"FT_CSTPIS\")) > 0 .And. SFT->(FieldPos(\"FT_CSTCOF\")) > 0\r\n\t\t\t\t\t\r\n\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SFT->FT_CSTPIS)\r\n\t\t\t\t\t\taTail(aPisAlqZ):= {SF4->F4_CSTPIS}\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SFT->FT_CSTCOF)\r\n\t\t\t\t\t\taTail(aCofAlqZ):= {SF4->F4_CSTCOF}\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tElse\r\n\r\n\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SF4->F4_CSTPIS)\r\n\t\t\t\t\t\taTail(aPisAlqZ):= {SF4->F4_CSTPIS}\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SF4->F4_CSTCOF) \r\n\t\t\t\t\t\taTail(aCofAlqZ):= {SF4->F4_CSTCOF}\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf !Len(aCofAlqZ)>0 .Or. !Len(aPisAlqZ)>0\r\n\t\t\t\t\taadd(aCofAlqZ,{})\r\n\t\t\t\t\taadd(aPisAlqZ,{})\r\n\t\t\t\tEndif\r\n\t\t\t\t\r\n\t\t\t\tIf SF4->(FieldPos(\"F4_CSOSN\"))>0\r\n\t\t\t\t\taTail(aCsosn):= SF4->F4_CSOSN\r\n\t\t\t\tElse\r\n\t\t\t\t\taTail(aCsosn):= \"\"\r\n\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf !Len(aCsosn)>0 \r\n\t\t\t\t\taTail(aCsosn):= \"\"\r\n\t\t\t\tEndIf                \r\n                         \r\n\t           //Tratamento para que o valor de PIS ST e COFINS ST venha a compor o valor total da tag vOutros  (NT 2011/004). E devolução de compra com IPI não tributado apenas para saida\r\n\t\t\t\t//Tratamento para que ao transmitir uma nota de devolução leve o valor do IPI conforme configurado o parametro MV_EIPIDEV.\r\n\t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"D\" .and. !lIpiDev .and. cTipo == \"1\")  .Or. ((cAliasSD1)->D1_TIPO == \"D\" .and. !lEipiDev ) .Or. lConsig .Or. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM ) .OR. ((cAliasSD1)->D1_TIPO == \"B\" .and. lIpiBenef) .OR. ((cAliasSD1)->D1_TIPO==\"P\" .And. lComplDev .And. !lIpiDev) .OR. lEIPIOutro .Or. lIPIOutB\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"D\" .and.  lEIPIOutro ) .or. ((cAliasSD1)->D1_TIPO == \"B\" .and.  lIPIOutB)\r\n\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n\t\t\t\t\tEndIf \r\n\r\n\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\taTotal[01] += 0\t\r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taTotal[01] += (cAliasSD1)->D1_VALIPI\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\taTotal[01] += (cAliasSD1)->D1_DESPESA + (cAliasSD1)->D1_VALPS3 + (cAliasSD1)->D1_VALCF3 + nIcmsST + nCrdPres\r\n\t\t\t\t\t\r\n\t\t\t\tIf (cAliasSD1)->D1_TIPO $ \"I\"\r\n\t\t\t\t\tIf (cAliasSD1)->D1_ICMSRET > 0\r\n\t\t\t\t\t\taTotal[02] += (cAliasSD1)->D1_ICMSRET\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taTotal[02] += 0\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\t\t\t\t\r\n\t\t\t\t\taTotal[02] += ((cAliasSD1)->D1_TOTAL-(cAliasSD1)->D1_VALDESC+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA;\r\n\t\t\t\t\t+ IIF(SD1->(ColumnPos('D1_AFRMIMP'))>0,(cAliasSD1)->D1_AFRMIMP,0);\r\n\t\t\t\t\t+ IIF(((cAliasSD1)->D1_TIPO $\"IP\" .Or. ((cAliasSD1)->D1_TIPO == \"D\" .And. cTpOrig == \"P\")),0,(cAliasSD1)->D1_VALIPI)+(cAliasSD1)->D1_ICMSRET + (cAliasSD1)->D1_VALPS3 + (cAliasSD1)->D1_VALCF3;      \r\n\t\t\t\t\t+ IIF(SF4->F4_AGREG   $ \"IB\",(cAliasSD1)->D1_VALICM,0\t);\r\n\t\t\t\t\t+ IIF(SF4->F4_AGRPIS  $ \"1P\",(cAliasSD1)->D1_VALIMP6,0\t);\r\n\t\t\t\t\t+ IIF(SF4->F4_AGRCOF  $ \"1C\",(cAliasSD1)->D1_VALIMP5,0\t));\r\n\t\t\t\t\t-(IIF(SF4->F4_AGREG  $ \"D\",(cAliasSD1)->D1_DESCICM,0\t));\r\n\t\t\t\t\t-(IIF(SF4->F4_AGREG  $ \"N\",(cAliasSD1)->D1_TOTAL,0\t\t));\r\n\t\t\t\t\t-(IIF(SF4->F4_INCSOL $ \"N\",(cAliasSD1)->D1_ICMSRET,0\t));\r\n\t\t\t\t\t-(IIF(Alltrim(SF4->F4_AGRPIS)  $ \"D\",(cAliasSD1)->D1_VALIMP6,0\t));\r\n\t\t\t\t\t-(IIF(Alltrim(SF4->F4_AGRCOF)  $ \"D\",(cAliasSD1)->D1_VALIMP5,0\t))\r\n\t\t\t\tEndIf\r\n\t\t\t\tdbSelectArea(cAliasSD1)\r\n\t\t\t\tdbSkip()\r\n\t\t    EndDo\t\r\n\r\n\t\t\t\t   \t\r\n\t\t    //Retira o desconto referente ao RICMS 43080/2002\r\n\t\t    If nDesTotal > 0\r\n\t\t    \taTotal[2] -= nDesTotal\r\n\t\t    EndIf\r\n\t\t    \r\n\t\t\tIf nBaseIrrf > 0 .And. nValIrrf > 0\r\n\t\t\t\taadd(aRetido,{\"IRRF\",nBaseIrrf,nValIrrf})\r\n\t\t\tEndIf\r\n\t\t\t//TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t//INSERE MSG EM INFADFISCO E SOMA NO TOTAL DA NOTA.\r\n\t\t\tIf nValLeite > 0 .And. nPercLeite > 0\r\n\t\t\t\tcMensFis += Alltrim(Str(nPercLeite,10,2))+'% Incentivo à produção e à industrialização do leite = R$ '+ Alltrim(Str(nValLeite,10,2))\r\n\t\t\t\taTotal[02] += nValLeite\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t//Operação com diferimento parcial de 66,66% do RICMS/PR\r\n\t\t\tIf nValIcmDev > 0 .And. nValIcmDif > 0\r\n\t\t\t\tcMensFis +=\t\"Operacao com diferimento parcial de 66,66% do imposto no valor de R$ \" + Alltrim(Str(nValIcmDif,10,2)) + \" - \"\r\n\t\t\t\tcMensFis += \"ICMS devido de R$ \" + Alltrim(Str(nValIcmDev,10,2)) + \", \"\r\n\t\t\t\tcMensFis += \"nos termos do Art 459 do DECRETO N.º 7.871/2017 - RICMS/PR\" //ISSUE DSERTSS1-6543 - Decreto 7.871 que revoga o regulamento do ICMS aprovado pelo decreto n 6080 de 28 de setembro de 2012.\r\n\t\t\tEndif\r\n\t\t\t\r\n\t\t\tIf nValSTAux > 0 \r\n\t\t\t\tcValST  := AllTrim(Str(nValSTAux,15,2))\r\n\t\t\t\tcBsST   := AllTrim(Str(nBsCalcST,15,2))\r\n\t\t\t\tcMensCli += \" \"\r\n\t\t\t\tIf lComplDev .And.  nBsCalcST == 0\r\n\t\t\t\t\tcMensCli += \"(Valor do ICMS ST: R$ \"+cValST+\") \" \t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS ST: R$ \"+cBsST+ \" - \"+\"Valor do ICMS ST: R$ \"+cValST+\") \"\r\n\t\t\t\tEndIF\t\r\n\t\t\t\tcValST\t  := \"\"  \r\n\t\t\t\tcBsST \t  := \"\"   \r\n\t\t\t\tnBsCalcST := 0\r\n\t\t\t\tnValSTAux := 0\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017) \r\n\t\t\tIf \tlIcmsPR .And. nToTvBC > 0 .And. nToTvICMS > 0 \t\t\t\t\t\t\t\t   \r\n\t\t\t\tcMensCli += \"(Base de Calculo do ICMS : R$ \"+nToTvBC+ \" - \"+\"Valor do ICMS : R$ \"+nToTvICMS+\") \"\r\n\t\t\tEndif\r\n\t\t    \r\n\t\t    If lQuery\r\n\t\t    \tdbSelectArea(cAliasSD1)\r\n\t\t    \tdbCloseArea()\r\n\t\t    \tdbSelectArea(\"SD1\")\r\n\t\t    EndIf\r\n\t\tEndIf\r\n\t\t//Tratamento para incluir a mensagem em informacoes adicionais do FECP -DF - MG - PR - RJ - RS.\r\n\t\tIf nValTFecp > 0\r\n\t\t\tIf cVerAmb >= \"4.00\"\r\n\t\t\t\tcMensFis += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\tElse\r\n\t\t\t\tcMensCli += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\r\nEndIf\r\n\r\n//Tratamento para que o valor de ValII venha compor o total da nota quando o parametro MV_EIC0064 for = .T. \r\nIf len(aDI)> 0\r\n\tFor nX := 1 To Len(aDI)\r\n\t\tIF  Len(aDI[nX])> 0\r\n\t\t\tIF Len(aDI[nX][19]) > 0 .and. lEIC0064 \r\n\t\t\t\taTotal[02]+= aDI[nX][19][03]   //ValIIaDI\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext\r\nEndIf\t\t\r\n\r\nIf FunName() <> \"SPEDNFSE\"\r\n\tIF cVeramb >= \"4.00\"\r\n\t   //Ajute para alimentar o aDetPag\r\n\t\tcTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,aProd[1,7])\r\n\t\t\r\n\t\t//Indicador da Forma de Pagamento\r\n\t\tcIndPag := IIF((Len(aDupl)==1 .And. aDupl[01][02]<=DataValida(aNota[03]+1,.T.)) .Or. Len(aDupl)==0,\"0\",\"1\")\t\r\n\r\n\t\tIf cTipo == \"1\"\r\n\t\t  cChvPag := SF2->F2_COND\r\n\t\tElse\r\n\t\t  cChvPag := SF1->F1_COND\r\n\t\tEndIf\r\n\r\n\t\tIf\tcTPNota $ '3-4'\r\n\t\t\t\r\n\t\t\tcForma := \"90\"  //90=Sem Pagamento.\r\n\t\t\taadd(aDetPag, {cForma, aTotal[2]+aTotal[03], 0.00, \"\", \"\", \"\", \"\", cIndPag})   \r\n\t\tElseIf (lVLojaDir .OR. !Empty(POSICIONE(\"SL1\",2,xFilial(\"SL1\")+SF2->F2_SERIE+SF2->F2_DOC,\"L1_NUM\"))) .And. cTipo == \"1\" .And. ( aRetPgLoj := GetPagLoja(aDupl, cChvPag, aTotal[2], cIndPag,cVerAmb) )[1]\r\n\t\t\t//Montagem do AdetPag quando venda for advindo do Venda Direta ou SigaLoja e condição de pagamento for = \"CN\"(Condicao Negociada)\r\n\t\t\t//Alem disso verifico se existem o registro na SL4, caso não, mantenho o legado anterior\r\n\t\t\taDetPag := aRetPgLoj[2]\t\r\n\t\tElse\t\t\r\n\t\t\t//caso tenha escolhido a forma de pagamento no cadastro de condição de pagamento.\r\n\t\t\tdbSelectArea(\"SE4\")\r\n\t\t\tdbSetOrder(1)\t\r\n\t\t\tIf DbSeek(xFilial(\"SE4\")+cChvPag)\r\n\t\t\t\tcForma := GetFormPgt(Alltrim(SE4->E4_FORMA), aDupl)\r\n\t\t\tElse\r\n\t\t\t\tcForma := GetFormPgt(\"\", aDupl)\t\r\n\t\t\tEndIf\r\n\t\t\taadd(aDetPag, {cForma, aTotal[2]+aTotal[03], 0.00, \"\", \"\", \"\", \"\", cIndPag})   \r\n\t\tEndIf\t\r\n\t\t\r\n\t\t//Exemplo de como gerar o Grupo Cobrança\r\n\t\t//aadd(aFat,{\"Número da Fatura\",Valor Original da Fatura,Valor do desconto,Valor Líquido da Fatura})   \r\n\t\t\r\n\tEndIf\r\nEndIf\r\n\r\n//Tratamento para que se caso mude o cliente o mesmo busque dados do cliente da nota original.\r\nIf lHistTab .and. !Empty(aNfVinc) .and. aNota[5] == \"D\"\r\n \taDest := AjustaDest(aDest,aNfVinc,cCliefor,cLoja)\r\nendif\r\n\r\nIF lPe01Nfe     \r\n\r\n\r\n\taParam := {aProd,cMensCli,cMensFis,aDest,aNota,aInfoItem,aDupl,aTransp,aEntrega,aRetirada,aVeiculo,aReboque,aNfVincRur,aEspVol,aNfVinc,aDetPag,aObsCont,aProcRef}\r\n\r\n\taParam := ExecBlock(\"PE01NFESEFAZ\",.F.,.F.,aParam)\r\n\t\r\n\tIf ( Len(aParam) >= 5 )\r\n\t\taProd\t\t:= aParam[1]\r\n\t\tcMensCli\t:= aParam[2]\r\n\t\tcMensFis\t:= aParam[3]\r\n\t\taDest \t\t:= aParam[4]\r\n\t\taNota \t\t:= aParam[5]\r\n\t\taInfoItem\t:= aParam[6]  \r\n\t\taDupl\t\t:= aParam[7]\r\n\t\taTransp\t\t:= aParam[8]\r\n\t\taEntrega\t:= aParam[9]\r\n\t\taRetirada\t:= aParam[10]\r\n\t\taVeiculo\t:= aParam[11]\r\n\t\taReboque\t:= aParam[12]\r\n\t\taNfVincRur\t:= aParam[13]\r\n\t\taEspVol     := aParam[14]\r\n\t\taNfVinc\t\t:= aParam[15]\r\n\t\tIf ( Len(aParam) >= 16 )\r\n\t\t\taDetPag\t\t:= aParam[16]\r\n\t\tEndIf\r\n\t\tIf ( Len(aParam) >= 17)\r\n\t\t\taObsCont    := aParam[17]\r\n\t\tEndIf\t\r\n\t\tIf ( Len(aParam) >= 18)\r\n\t\t\taProcRef    := aParam[18]\r\n\t\tEndIf\r\n\t\r\n\tEndIf\r\nEndif \r\n\r\n/* PONTO DE ENTRADA PARA TRATAMENTO SEGMENTO GRANITO BRUNO SIGAWISE */                      \r\nIf ExistBlock(\"PEGRNFESEFAZ\")                        \r\n\tIf AllTrim(aNota[1]) = \"2\"\r\n\t\taParam := {aNota,aProd,aIcms,aIcmsSt,aIpi,aICMUFDest,aPis,aCOFINS,aExp,aEspVol,aICMSZFM,aNfVinc}\r\n\t\taParam := ExecBlock(\"PEGRNFESEFAZ\",.F.,.F.,aParam)\r\n\t\t\r\n\t\taProd      := aParam[1]\r\n\t\taIcms      := aParam[2]\r\n\t\taIcmsSt    := aParam[3]\r\n\t\taIpi       := aParam[4]        \r\n\t\taICMUFDest := aParam[5]\r\n\t\taPis       := aParam[6]\r\n\t\taCOFINS    := aParam[7]\r\n\t\taExp       := aParam[8]\r\n\t\taEspVol    := aParam[9]\r\n\t\taICMSZFM   := aParam[10]\r\n\t\taNfVinc    := aParam[11]\r\n\tEndIf\r\nEndIf\r\n\r\n\r\nnLenaIpi := Len(aCstIpi) // Tratamento para CST IPI.\r\n\r\n//Geracao do arquivo XML\r\nIf !Empty(aNota)\r\n\r\n\tIf !lIcmDevol .And. aNota[5] = \"I\"\r\n\t\tlIcmDevol := .T.\r\n\tEnd If\r\n\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017)\r\n\tIf nToTvBC > 0 .And. nToTvICMS > 0 \r\n\t\tlIcmSTDev\t:= lIcmSTDevOri\r\n\t\tlIcmDevol\t:= lIcmDevolOri\t\r\n\tEndIf\r\n\r\n\tcString := \"\"\r\n\tcString += '<?xml version=\"1.0\" encoding=\"UTF-8\"?>'\r\n\tcString += NfeIde(@cNFe,aNota,cNatOper,aDupl,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cIndPres,aDest,aProd,aExp,aComb)\r\n\tcString += NfeEmit(aIEST,cVerAmb,aDest)\r\n\tcString += NfeDest(aDest,cVerAmb,aTransp,aCST,lBrinde,@cMunDest)\r\n\tIf !Empty(cAutXml)\r\n\t\tcString += NfeAutXml(cAutXml)\r\n\tEndIf\r\n\tcString += NfeLocalRetirada(aRetirada)\r\n\tcString += NfeLocalEntrega(aEntrega)\r\n\taTotICMSST := {0,0,0}\r\n\tFor nX := 1 To Len(aProd)\r\n\t\tIf nLenaIpi > 0\r\n\t\t\tIf  nCstIpi <= nLenaIpi\r\n\t\t\t\tcIpiCst := aCSTIPI[nX][1]\r\n\t\t\t\tnCstIpi += 1\r\n\t\t\tElse\r\n\t\t\t\tcIpiCst := \"\"\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\r\n\t\tcString += \tNfeItem(aProd[nX],aICMS[nX],aICMSST[nX],aIPI[nX],aPIS[nX],aPISST[nX],aCOFINS[nX],aCOFINSST[nX],aISSQN[nX],aCST[nX],;\r\n\t\t\t\t\taMed[nX],aArma[nX],aveicProd[nX],aDI[nX],aAdi[nX],aExp[nX],aPisAlqZ[nX],aCofAlqZ[nX],aAnfI[nX],cTipo,cVerAmb, aComb[Nx],;\r\n\t\t\t\t\t@cMensFis,aCsosn[Nx],aPedCom[nX],aNota,aICMSZFM[nX],aDest,cIpiCst,aFCI[nX],lIcmDevol,@nVicmsDeson,@nVIcmDif,cMunPres,;\r\n\t\t\t\t\taAgrPis[nX],aAgrCofins[nX],nIcmsDif,aICMUFDest[nX],@nvFCPUFDest,@nvICMSUFDest,@nvICMSUFRemet,cAmbiente,aIPIDevol[nX],;\r\n\t\t\t\t\t@nvBCUFDest, aItemVinc[nX], @npFCPUFDest,@npICMSUFDest,@npICMSInter,@npICMSIntP,aLote[nX],@cMensDifal,;\r\n\t\t\t\t\t@aTotICMSST,len(aProd), nX, @nValDifer)\r\n\tNext nX\r\n  \tcString += NfeTotal(aTotal,aRetido,aICMS,aICMSST,lIcmDevol,cVerAmb,aISSQN,nVicmsDeson,aNota,nVIcmDif,aAgrPis,aAgrCofins,nValLeite )\r\n\tcString += NfeTransp(cModFrete,aTransp,aImp,aVeiculo,aReboque,aEspVol,cVerAmb,aReboqu2,cMunDest)\r\n\t\r\n\tIf cVeramb == \"3.10\"\r\n\t\tcString += NfeCob(aDupl)\r\n\tEndIf\r\n\t\r\n\t\r\n\tIF cVeramb >= \"4.00\"\r\n\t\t//Obrigatório o preenchimento do Grupo Informações de Pagamento para NF-e e NFC-e. Para as notas com finalidade de Ajuste ou Devolução o\r\n\t\t//campo Forma de Pagamento deve ser preenchido com 90=Sem Pagamento.\r\n\t\t//Retirado o grupo de duplicata para não ocorrer a Rejeição 867: Grupo duplicata informado e forma de pagamento não é Duplicata Mercantil.\r\n\t\t\r\n       //If aScan( aDetPag,{ |x|x[1] == \"14\"} ) > 0\t\t\t\r\n\t\tIf lGrupCob\r\n\t\t\tcString += NfeCob(aDupl,aFat,(Alltrim(cSerie)+ Alltrim(cNota)))\r\n\t\tEndIf\r\n\t\t//EndIf\r\n\t\tcString += NfePag(aDetPag)\r\n\tEndIf\r\n\t\r\n\tnA := 0\r\n\tFor nA:=1 to Len(aMensAux)\r\n\t\tcMensFis += \" \" + aMensAux[nA] + CRLF\r\n\tNext\r\n\t\r\n\tIf cMensONU <> \"\"\r\n\t\tcMensCli:= cMensCli+\" \"+ Alltrim(cMensONU)\r\n\tEndIf\r\n\t\r\n\tIf nValDifer > 0\r\n\t\tcMensCpl += \"Diferimento do ICMS que exceder 12% - Base Legal Item II da Subseção III da Seção IV do Apêndice II do RICMS/RS. Valor do ICMS Diferido R$ \" + ConvType(nValDifer,15,2) + \".\"\r\n\tEndIf\r\n\t\r\n\t// Tratamento para buscar \r\n\tIf  Empty(aPedido) .and. !Empty(aNfVinc)  .and. aNota[5] == \"D\" .and. Len(aNfVinc[1]) > 8\r\n\t\taPedido := DadNfVinc(aNfVinc)\r\n\tEndIf \r\n\t\r\n\tcString += NfeInfAd(cMensCli,cMensFis,aPedido,aExp,cAnfavea,aMotivoCont,aNota,aNfVinc,aProd,aDI,aNfVincRur,aRetido,cNfRefcup,cSerRefcup,cTipo,nIPIConsig,nSTConsig,lBrinde,cVerAmb,Iif(aNota[5] == \"D\",aRefECF,{}),nVicmsDeson,nvFCPUFDest,nvICMSUFDest,nvICMSUFRemet,nvBCUFDest,aICMUFDest,nValIpiBene,npFCPUFDest,npICMSUFDest,npICMSInter,npICMSIntP,aObsCont,aValTotOpe,cMensDifal,aProcRef,aDest,nTotCrdP,cMensCpl)\r\n\t\r\n\tIf LRespTec .and. lTagProduc .and. FindFunction(\"NfeRespTec\")\r\n\t\tcString += NfeRespTec(\"\")\r\n\tEndIf\r\n\t\r\n\tcString += \"</infNFe>\"\r\nEndIf\r\n\r\ncStringUTF := EncodeUTF8(cString)\r\nif cStringUTF == nil\r\n\tcString := SpecialChar( cString )\r\n\tcStringUTF := EncodeUTF8(cString)\r\nendif\r\n\r\nReturn({cNFe, cStringUTF ,cNotaOri,cSerieOri})\r\n\r\nStatic Function NfeIde(cChave,aNota,cNatOper,aDupl,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cIndPres,aDest,aProd,aExp,aComb)\r\n\r\nLocal cString    \t:= \"\"\r\nLocal cNFVinc    \t:= \"\"\r\nLocal cModNot    \t:= \"\"\r\nLocal cOper\t\t\t:= \"\"\r\nLocal cCFOP\t\t\t:= \"\"\r\nLocal cChaveRef\t\t:= \"\"\r\nLocal cIndicador\t:= \"\"\r\nLocal cTipocli\t\t:= \"\"\r\nLocal cVENPRES\t\t:= \"\"\r\nLocal cChvDupli\t\t:= \"\"\t\t\t\t\t\t\t\t\t\t\t// Não permitido gerar a mesma nota \r\nLocal lAvista    \t:= Len(aDupl)==1 .And. aDupl[01][02]<=DataValida(aNota[03]+1,.T.)\r\nLocal lDSaiEnt   \t:= GetNewPar(\"MV_DSAIENT\", .T.)\r\nLocal lNfVincRur \t:= .F.\r\nLocal lNfVinc    \t:= .F.\r\nLocal lEECFAT\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lRefEcf\t\t:= .F.\r\nLocal nX         \t:= 0\r\nLocal nPos       \t:= 0 \r\nLocal nY\t\t\t:= 0\r\nLocal cTpImp\t \t:=  AllTrim(GetNewPar(\"MV_NFTPIMP\",\"\"))\r\nLocal nZ\t\t\t:= 0\r\nLocal aNfLtExpRf \t:= {}\r\n\r\ncVerAmb := PARAMIXB[2]\r\n\r\ncChave := aUF[aScan(aUF,{|x| x[1] == SM0->M0_ESTCOB})][02]+FsDateConv(aNota[03],\"YYMM\")+SM0->M0_CGC+\"55\"+StrZero(Val(aNota[01]),3)+StrZero(Val(aNota[02]),9)\r\ncChave+=Inverte(StrZero(Val(aNota[02]),8))\r\n\r\ncString += '<infNFe versao=\"T01.00\">'\r\ncString += '<ide>'\r\ncString += '<cUF>'+ConvType(aUF[aScan(aUF,{|x| x[1] == SM0->M0_ESTCOB})][02],02)+'</cUF>'\r\ncString += '<cNF>'+ConvType(Inverte(StrZero(Val(aNota[02]),Len(aNota[02]))),08)+'</cNF>'\r\ncString += '<natOp>'+ConvType(cNatOper)+'</natOp>'\r\n\r\nIf cVeramb <> \"4.00\"  //Retirado o campo indicador da Forma de Pagamento do Grupo B\r\n\tcString += '<indPag>'+IIF(lAVista,\"0\",IIf(Len(aDupl)==0,\"2\",\"1\"))+'</indPag>'\r\nEndif\r\n\r\nIf Empty(aNota[01])\r\n\tcString += '<serie>'+\"000\"+'</serie>'\r\nElse\r\n\tcString += '<serie>'+ConvType(Val(aNota[01]),3)+'</serie>'\r\nEndif\r\ncString += '<nNF>'+ConvType(Val(aNota[02]),9)+'</nNF>'\r\n//Nota Técnica 2013/005 - Data e Hora no formato UTC\r\nIf cVeramb >= \"3.10\"\r\n\tcString += '<dhEmi>'+ConvType(aNota[03])+\"T\"+Iif(Len(AllTrim(aNota[06])) > 5,ConvType(aNota[06]),ConvType(aNota[06])+\":00\")+'</dhEmi>'\r\n\tcString += NfeTag('<dhSaiEnt>',Iif(lDSaiEnt,\"\",ConvType(aNota[03])+\"T\"+Iif(Len(AllTrim(aNota[06])) > 5,ConvType(aNota[06]),ConvType(aNota[06])+\":00\")))\r\nElse\t\r\n\tcString += '<dEmi>'+ConvType(aNota[03])+'</dEmi>'\r\n\tcString += NfeTag('<dSaiEnt>',Iif(lDSaiEnt, \"\", ConvType(aNota[03])))\r\n\tIf !lDSaiEnt .And. !Empty(aNota[06])\r\n\t\tif len(aNota[06]) > 5\r\n\t\t\tcString += '<hSaiEnt>'+ConvType(aNota[06])+'</hSaiEnt>'\r\n\t\telse\r\n\t\t\tcString += '<hSaiEnt>'+ConvType(aNota[06])+\":00\"+'</hSaiEnt>'\t\r\n\t\tendif\r\n\tEndif\r\nEndIf\r\ncString += '<tpNF>'+aNota[04]+'</tpNF>'\r\nIf cVeramb >= \"3.10\"\r\n\t\r\n\tcCFOP:= AllTrim(aProd[1][7]) //Considera somente o CFOP da primeira nota\r\n\t\r\n\tIf SubStr(cCFOP,1,1) == \"2\" .Or. SubStr(cCFOP,1,1) == \"6\" \r\n\t\t cOper:= \"2\" //Operação Interestadual\r\n\tElseIf SubStr(cCFOP,1,1) == \"3\" .Or. SubStr(cCFOP,1,1) == \"7\" \r\n\t\tcOper:= \"3\" //Operação com Exterior\r\n\tElse\r\n\t\tcOper:= \"1\" //Operação Interna CFOP 1 e 5\r\n\tEndIf\r\n\r\n\t//Operação Interna/Interestadual, pois apesar de CFOP 3 ou 7, porem UF de cliente diferente de EX/ Rejeição 731 e 520 (NT 2013/005 v 1.10)/(NT 2010/007)\r\n\t//Conforme entendimento com a equipe, ao analisar o campo de UF da variavel aComb, devo verificar apenas a primeira linha, sendo a mesma tratativa feita anteriormente no tocante ao codigo da CFOP\r\n\tIf cOper == \"3\" .And. Len(aComb) > 0 .And. aDest[9] != \"EX\" .And. aComb[1][4] == \"EX\"\t\t\r\n\t\tIf aDest[9] == IIF(!GetNewPar(\"MV_SPEDEND\",.F.),ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))\r\n\t\t\tcOper:= \"1\" \r\n\t\tElse\r\n\t\t\tcOper:= \"2\"\r\n\t\tEndIf\t\t\r\n\tEndIf\r\n\t\r\n\t//Identificador de Local de Destino da Operação\r\n\tcString += '<idDest>'+cOper+'</idDest>'\t\r\n\tcIdDest:= cOper\r\nEndIf\r\n\r\nIf !Empty(cTpImp)\r\n\tcString += '<TpImp>'+cTpImp+'</TpImp>'\t\r\nEndIf\r\n\r\nIf !(cVerAmb >= \"4.00\") .And. !Empty(aNfVinc)\r\n\t\r\n\tcModNot := AModNot(aNfVinc[1][06])\r\n\t\r\n\tIf cModNot == '02'\r\n\t\taNfVinc   := {}\r\n\tEndIf\r\nEndIf\r\n\r\nIf(!Empty(aNfVinc)\t.And. Empty(aExp[1])) .or.(!Empty(aNfVinc).And. !Empty(aExp[1]) .and. lEECFAT)\r\n\tcString += '<NFRef>'\r\n\tFor nX := 1 To Len(aNfVinc)\r\n\t\tlNfVincRur := aScan(aNfVincRur,{|aX| aX[4]==aNfVinc[nX][6] .And. aX[2]==aNfVinc[nX][2] .And. aX[3]==aNfVinc[nX][3] .And. aX[5]==aNfVinc[nX][4]}) == 0\r\n\t\t// Verifica se ja foi gerada a tag para a mesma nota anteriormente, para não ser gerada novamente\r\n\t\t//   ocasionando em rejeição pela SEFAZ\r\n\t\tnPos       := aScan(aNfVinc, {|aX| aX[2] == aNfVinc[nX][2] .And. aX[3] == aNfVinc[nX][3]})\r\n\t\tlNfVinc    := (nPos > 0 .And. nPos <> nX)\r\n\t\t\r\n\t\tIf cVerAmb >= \"2.00\" .And. lNfVincRur .And. !lNfVinc\r\n\t\t\tIf !Empty(aNfVinc[Nx][7]) // Contem chave de NF-e ou Ct-e\r\n\t\t\t\tIf !(aNfVinc[Nx][7] $ cChvDupli)\r\n\t\t\t\t\tif !Empty(aNfVinc[Nx][6]) .and. \"CTE\" == UPPER(Alltrim(aNfVinc[Nx][6]))\r\n\t\t\t\t\t\tcString += '<refCTe>'+aNfVinc[Nx][7]+'</refCTe>'\t\t\t\t\r\n\t\t\t\t\telse\t\t\t\t\r\n\t\t\t\t\t\tcString += '<refNFe>'+aNfVinc[Nx][7]+'</refNFe>'   \r\n\t\t\t\t\tendif\r\n\t\t\t\tcChvDupli += aNfVinc[Nx][7]+'-'\r\n\t\t\t\tEndIf\r\n\t\t\tElseIf !(ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVinc[nX][05]})][02],02)+;\r\n\t\t\t\tFsDateConv(aNfVinc[nX][01],\"YYMM\")+;\r\n\t\t\t\taNfVinc[nX][04]+;\r\n\t\t\t\tAModNot(aNfVinc[nX][06])+;\r\n\t\t\t\tConvType(Val(aNfVinc[nX][02]),3)+;\r\n\t\t\t\tConvType(Val(aNfVinc[nX][03]),9) $ cNFVinc )\r\n\t\t\t\tcString += '<RefNF>'\r\n\t\t\t\tcString += '<cUF>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVinc[nX][05]})][02],02)+'</cUF>'\r\n\t\t\t\tcString += '<AAMM>'+FsDateConv(aNfVinc[nX][01],\"YYMM\")+'</AAMM>'\r\n\t\t\t\tIf Len(AllTrim(aNfVinc[nX][04]))==14\r\n\t\t\t\t\tcString += '<CNPJ>'+aNfVinc[nX][04]+'</CNPJ>'\r\n\t\t\t\tElseIf Len(AllTrim(aNfVinc[nX][04]))>0\r\n\t\t\t\t\tcString += '<CNPJ>'+Replicate(\"0\",14)+'</CNPJ>'\r\n\t\t\t\t\tcString += '<CPF>'+aNfVinc[nX][04]+'</CPF>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<CNPJ></CNPJ>'\r\n\t\t\t\tEndIf\r\n\t\t\t\tcString += '<mod>'+IIf(Alltrim(aNfVinc[nX][06]) == \"NFA\",\"01\",AModNot(aNfVinc[nX][06]))+'</mod>'\r\n\t\t\t\tcString += '<serie>'+ConvType(Val(aNfVinc[nX][02]),3)+'</serie>'\r\n\t\t\t\tcString += '<nNF>'+ConvType(Val(aNfVinc[nX][03]),9)+'</nNF>'\r\n\t\t\t\tcString += '<cNF>' + strZero( val( convType( inverte( strZero( val( aNfVinc[nX][03] ), len( aNfVinc[nX][03] ) ) ), 8 ) ), 9 ) + '</cNF>'\r\n\t\t\t\tcString += '</RefNF>'\r\n\t\t\r\n\t\t\t\tcNFVinc += ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVinc[nX][05]})][02],02)+;\r\n\t\t\t\t\tFsDateConv(aNfVinc[nX][01],\"YYMM\")+;\r\n\t\t\t\t\taNfVinc[nX][04]+;\r\n\t\t\t\t\tAModNot(aNfVinc[nX][06])+;\r\n\t\t\t\t\tConvType(Val(aNfVinc[nX][02]),3)+;\r\n\t\t\t\t\tConvType(Val(aNfVinc[nX][03]),9)\r\n\t\t\tEndIf\t\t\t\t\t\t\r\n\t\tEndIf                \t\t\r\n\tNext nX                  \r\n\tcString += '</NFRef>'\r\nEndIf\r\n\r\nif SM0->M0_ESTCOB  ==  'RS' .and. anota[5] == 'C' .and. len(aNfVincRur) > 0   // verifica se estado é RS e se nota é complemento\r\n\taNfVincRur := FiltEst(@aNfVincRur, SM0->M0_ESTCOB ) // remove notas referenciadas que não são do RS\r\nendif\r\n\r\nIf !Empty(aNfVincRur)\t\r\n\tIf len(aNfVincRur)>0 .and. cVerAmb >= \"2.00\"       \r\n\t\tcString += '<NFRef>'\r\n\t\tFor nX := 1 To Len(aNfVincRur)\r\n\t\t\tcString +='<refNFP>' \r\n\t\t\tcString += '<cUF>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVincRur[nX][06]})][02],02)+'</cUF>'\r\n\t\t\tcString += '<AAMM>'+FsDateConv(aNfVincRur[nX][01],\"YYMM\")+'</AAMM>'\r\n\t\t\tIf Len(AllTrim(aNfVincRur[nX][05]))==14\r\n\t\t\t\tcString += '<CNPJ>'+AllTrim(aNfVincRur[nX][05])+'</CNPJ>'\r\n\t\t\tElseIf Len(AllTrim(aNfVincRur[nX][05]))<>0\r\n\t\t\t\tcString += '<CPF>' +AllTrim(aNfVincRur[nX][05])+'</CPF>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<CNPJ></CNPJ>'         \r\n\t\t\tEndIf\t               \r\n\t\t\tcString += '<IE>'+ConvType(aNfVincRur[nX][07])+'</IE>'\r\n\t\t\tcString += '<mod>'+IIf(Alltrim(aNfVincRur[nX][04]) == \"NFA\",\"01\",AModNot(aNfVincRur[nX][04]))+'</mod>'\t\r\n\t\t\tcString += '<serie>'+ConvType(Val(aNfVincRur[nX][02]),3)+'</serie>'\r\n\t\t\tcString += '<nNf>'+ConvType(Val(aNfVincRur[nX][03]),9)+'</nNf>'\r\n \t\t\tcString +='</refNFP>'\r\n\t\tExit \t\r\n  \t\tNext nX          \r\n  \t\tcString += '</NFRef>'\r\n\tEndif\r\nEndIF\r\n\r\nIf !Empty(aRefECF)\r\n\tIf len(aRefECF) > 0 .and. cVerAmb >= \"2.00\"        \r\n\t\tcString += '<NFRef>'\t\r\n\r\n\t\tFor nX := 1 To Len(aRefECF)\r\n\t\t\t// Verifica se ja foi gerada a tag para o mesmo ECF / CF, para não ser gerada novamente\r\n\t\t\t// ocasionando em rejeição pela SEFAZ\r\n\t\t\tnPos\t\t:= aScan(aRefECF, {|aX| aX[1] == aRefECF[nX][1] .And. aX[3] == aRefECF[nX][3]})\r\n\t\t\tlRefEcf\t:= (nPos > 0 .And. nPos <> nX)\r\n\t\t\t\r\n\t\t\tif !lRefEcf\r\n\t\t\t\tcString +='<refECF>'\r\n\r\n\t\t\t\tif Alltrim(aRefECF[nX][02]) == \"ECF\" .Or. Alltrim(aRefECF[nX][02])==\"CF\" \r\n\t\t  \t\t\tcString += '<Mod>'+\"2C\"+'</Mod>'\r\n\t  \t\t\telse\r\n\t  \t\t\t\tcString += '<Mod>'+\"2B\"+'</Mod>'\r\n\t  \t\t\tendif\r\n\t\t\t\tcString += '<nECF>'+ConvType(Val(aRefECF[nX][03]),3)+'</nECF>'\r\n\t\t\t\tcString += '<nCOO>'+ConvType(Val(aRefECF[nX][01]),6)+'</nCOO>'\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tcString +='</refECF>'\r\n\t\t\tendif\r\n\t\t\t\r\n\t\t\t//if !Empty(aRefECF[nX][01]) .And.  !Empty(aRefECF[nX][02]) .And.  !Empty(aRefECF[nX][03])  \r\n\t\t\t//\tExit\r\n\t\t\t//endif\t\t\t\r\n\r\n  \t\tNext nX \r\n\t\tcString += '</NFRef>'\r\n\t\r\n\tEndif\t\r\nEndIf \r\n\r\n/*Quando há exportação indireta(I52), deve-se informar as chaves(I54) na tag refNFe.\r\nEEC não consegue preencher campo D2_NFORI pois pode existir mais de um documento de entrada para referenciar em um mesmo item,\r\npor este motivo, as chaves recebidas na tag chNFe do grupo exportInd serão geradas automaticamente na refNFe.\r\n*/\r\n\r\nIf !Empty(aExp[1]) .and. lEECFAT .and. cVerAmb >= \"3.10\"\r\n\tIf Len(aExp) > 0 .and. (aNota[04] == \"1\" .OR.  aNota[5] $ \"D|N\") //Somente se nota de saída ou devolução.\r\n\t\tFor nX := 1 To Len(aExp)\r\n\t\t\tIf Len(aExp[nX][3][3]) > 0\r\n\t\t\t\tFor nY := 1 To Len(aExp[nX][3][3][2])\r\n\t\t\t\t\t//Quando não há exportInd, a posição 3 é retornada vazia\r\n\t\t\t\t\tIf !Empty(aExp[nX][3][3][2][nY][3])\r\n\t\t\t\t\t\tIf !aExp[nX][3][3][2][nY][3][2][3] $ cChaveRef \r\n\t\t\t\t\t\t\tcChaveRef += '<refNFe>'+aExp[nX][3][3][2][nY][3][2][3]+'</refNFe>'\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tNext nY\r\n\t\t\tEndIf \r\n         /*Quando há notas fiscais de formação de lote de exportação associadas, deve-se informar as chaves(BA02) na tag refNFe.\r\n\t\t\t  Estas informações ficarão na posição 6 do array aExp retornado peloa função GETNFEEXP( ) do SIGAEEC - Exportação */\r\n\t\t\tIf Len(aExp[nX]) > 4 .And. Len(aExp[nX][5]) > 2 .And. Len(aExp[nX][5][3]) > 0\r\n\t\t\t\tFor nZ := 1 To Len(aExp[nX][5][3])\r\n\t\t\t\t\tIf !Empty(aExp[nX][5][3][nZ][1])\r\n\t\t\t\t\t   If aScan(aNfLtExpRf,aExp[nX][5][3][nZ][1]) == 0\r\n\t\t\t\t\t      cChaveRef += '<refNFe>'+aExp[nX][5][3][nZ][1]+'</refNFe>'\r\n\t\t\t\t\t\t\taAdd( aNfLtExpRf , aExp[nX][5][3][nZ][1] )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tNext nY\r\n\t\t\tEndIf \r\n\t\tNext Nx\r\n\t\t\r\n\t\tIf !Empty(cChaveRef)\r\n\t\t\tcString += '<NFRef>'\r\n\t\t\tcString += cChaveRef\r\n\t\t\tcString += '</NFRef>'\r\n\t\tEndIf\r\n\r\n\t   aNfLtExpRf := {}\r\n\r\n\tEndIf\t\r\n/*SEM INTEGRAÇÃO COM EEC - Quando há exportação indireta, deve-se informar a chave(I54 - tag chNFe) na tag refNFe.\r\nCaso não seja vinculada a NF original no pedido de venda (C6_NFORI/D2_NFORI), será considerada a chave contida\r\nno campo CDL_CHVEXP na montagem da refNFe.\r\n*/\r\nElseIf !Empty(aExp[1]) .and. !lEECFAT .and. (aNota[04] == \"1\" .or. (aNota[04] == \"0\" .and. aNota[5] $ \"D|N\"))  //.and. Empty(aNfVinc)\r\n\tFor nX := 1 To Len(aExp)\r\n\t\tIf !Empty(aExp[nX])\r\n\t\t\tFor nZ := 1 To Len(aExp[nX])\r\n\t\t\t\tIf !Empty(aExp[nX][nZ][5][3])\r\n\t\t\t\t\tIf !aExp[nX][nZ][5][3] $ cChaveRef\r\n\t\t\t\t\t\tcChaveRef += '<refNFe>'+ConvType(aExp[nX][nZ][5][3],44)+'</refNFe>'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tnext\r\n\t\tEndif\t\r\n\tNext nX\r\n\tIf !Empty(cChaveRef)\r\n\t\tcString += '<NFRef>'\r\n\t\tcString += cChaveRef\r\n\t\tcString += '</NFRef>'\r\n\tEndIf\r\nEndIf\r\n\r\ncTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,aProd[1,7])\r\n\t\r\n/*Verificação do conteudo da tag IndIeDest para atribuir valor 1 na tag indFinal - rej 696-NT2015/003_v1.71*/\r\nIf ConvType(aDest[17]) <> \"2\" .and. !Empty(aDest[14])\r\n\tIf \"ISENT\" $ Upper(Alltrim(aDest[14]))\r\n\t\tcIndicador := \"2\"\r\n\tElse\r\n\t\tcIndicador := \"1\"\t\t\r\n\tEndIf\r\nElse\r\n\tcIndicador := \"9\" //9-Não Contribuinte\r\nEndIf\r\n//Ajuste para considerar o tipo do cliente cadastrado na (C5_TIPOCLI) quando alterado no cabeçalho das NF de Saída\r\n//pois todos os cálculos fiscais são feitos com base nessa informação e não no campo A1_TIPO.\r\nIf !Empty(SF2->F2_TIPOCLI) .and. !Empty(aDest[20]) \r\n\tIf (!Empty(aDest[20]) .and. aDest[20]) <> SF2->F2_TIPOCLI\t\r\n  \t\tcTipocli:= SF2->F2_TIPOCLI\r\n  \tElse\r\n  \t   cTipocli:= aDest[20]\r\n  \tEndIf\r\nElse \r\n\tIf !Empty(aDest[20]) \t\r\n\t\tcTipocli:= aDest[20]\r\n\tEndIf\r\nEndIf\r\n\r\ncString += '<tpNFe>'+cTPNota+'</tpNFe>'\r\nIf cVeramb >= \"3.10\"\r\n\tIf cTipocli  == \"F\"\r\n\t\tcString += '<indFinal>1</indFinal>' //1-Operação com consumidor final\r\n\t\tcIndFinal:= \"1\"\r\n\tElse\r\n\t\tIf cIndicador == \"9\" .and. cIdDest <> \"3\" //(tag indIEDest=9)-Não Contribuinte e operação que não é com exterior (tag idDest <> 3)\r\n\t\t\tcString += '<indFinal>1</indFinal>'//1-Consumidor final\r\n\t\t\tcIndFinal:= \"1\"\r\n\t\tElse\r\n\t\t\tcString += '<indFinal>0</indFinal>'//0-Não\r\n\t\t\tcIndFinal:= \"0\"\r\n\t\tEndIf\r\n\tEndIf\r\n\tIf Empty(cIndPres)\r\n\t\tcVENPRES:= AllTrim(aProd[1][42]) //Considera somente o F4_VENPRES do primeiro item\r\n\t\tIf aNota[5] == \"N\"\r\n\t\t\tcIndPres := \"9\" //Operação não presencial \r\n\t\tElseIf aNota[5] == \"D\" .and. aNota[04] == \"0\" .and. (!Empty(cVENPRES) .and. cVENPRES == \"1\")\r\n\t\t\t/*Manutenção para considerar o conteúdo do campo F4_VENPRES=1 na montagem da tag \r\n\t\t\t\tindPres = 1 – Operação Presencial, em notas de devolução de venda para contribuinte de \r\n\t\t\t\toutro Estado, com CFOP iniciado por 1 e sem frete, a fim de não apresentar a \r\n\t\t\t\trejeição 521 - Operação Interna e UF do emitente difere da UF do destinatário/remetente \r\n\t\t\t\tcontribuinte do ICMS.*/\r\n\t\t\tcIndPres := \"1\"\r\n\r\n\t\tElse\r\n\t\t\tcIndPres := \"0\" //0-Não se Aplica\t\r\n\t\tEndIf\r\n\tEndIf\r\n\tcString += '<indPres>'+cIndPres+'</indPres>' // Presenção do comprador no momento da Operação\r\nEndIf\r\ncString += '</ide>'\r\n\r\nReturn( cString )\r\n\r\nStatic Function NfeEmit(aIEST, cVerAmb, aDest)\r\n\r\nLocal aTelDest \t\t:= {} \r\n\r\nLocal cFoneDest\t\t:= \"\"\r\nLocal cMVCODREG\t\t:= SuperGetMV(\"MV_CODREG\", ,\" \")  \r\n//Local cMVEstado\t\t:= SuperGetMV(\"MV_ESTADO\", ,\" \")\r\n//Local cSTIeUf\t\t:= SuperGetMV(\"MV_STNIEUF\",.F.,\"\")\r\nLocal cString \t\t:= \"\"\r\nLocal cUfDest\t\t:= \"\"\r\nLocal cEndEmit\t:= \"\"\r\n\r\nLocal lEndFis \t\t:= GetNewPar(\"MV_SPEDEND\",.F.)\r\nLocal lUsaGesEmp\t:= IIF(FindFunction(\"FWFilialName\") .And. FindFunction(\"FWSizeFilial\") .And. FWSizeFilial() > 2,.T.,.F.)\r\n\r\nDEFAULT aIEST\t := {}\r\n\r\ncVerAmb     := PARAMIXB[2] \r\ncUfDest\t\t:= ConvType(aDest[09])\r\n\r\ncString := '<emit>'\r\nIf Len(AllTrim(SM0->M0_CGC))==14\r\n\tcString += '<CNPJ>'+AllTrim(SM0->M0_CGC)+'</CNPJ>'\r\nElseIf Len(AllTrim(SM0->M0_CGC))<>0\r\n\tcString += '<CPF>'+AllTrim(SM0->M0_CGC)+'</CPF>'\r\nElse\r\n\tcString += '<CNPJ></CNPJ>'\r\nEndIf\r\ncString += '<Nome>'+ConvType(SM0->M0_NOMECOM)+'</Nome>'\r\n\r\n/*\r\nQuando utilizar Gestao de empresas o M0_NOME guarda o nome do Grupo e não da Filial.\r\nFWFilialName - Pega o nome da Filial Atual,só usar funcao se estiver habilitado \r\ngestao de empresa (FWSizeFilial() > 2)\r\n*/\r\n\r\nIf lUsaGesEmp\r\n\tcString += NfeTag('<Fant>',ConvType(FWFilialName()))\r\nElse\r\n\tcString += NfeTag('<Fant>',ConvType(SM0->M0_NOME))\r\nEndIf\t     \r\n\r\ncString += '<enderEmit>'\r\ncString += '<Lgr>'+IIF(!lEndFis,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[1]),ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1]))+'</Lgr>'\r\n\r\nIf !lEndFis\r\n\tIf FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[2]<>0\r\n\t\tcString += '<nro>'+FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[3]+'</nro>'  \r\n\tElse\r\n\t\tcString += '<nro>'+\"SN\"+'</nro>' \r\n\tEndIf\r\nElse\r\n\tIf FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2]<>0\r\n\t\tcString += '<nro>'+FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3]+'</nro>' \r\n\tElse\r\n\t\tcString += '<nro>'+\"SN\"+'</nro>'\r\n\tEndIf\r\nEndIf\t\r\n\t\r\ncEndEmit :=  IIF(!lEndFis,Iif(!Empty(SM0->M0_COMPCOB),SM0->M0_COMPCOB,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[4]) ) ,;\r\n\t\t\t\t\t\t  Iif(!Empty(SM0->M0_COMPENT),SM0->M0_COMPENT,ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[4]) ) )\r\ncString += NfeTag('<Cpl>',cEndEmit)\r\ncString += '<Bairro>'+IIF(!lEndFis,ConvType(SM0->M0_BAIRCOB),ConvType(SM0->M0_BAIRENT))+'</Bairro>'\r\ncString += '<cMun>'+ConvType(SM0->M0_CODMUN)+'</cMun>'\r\ncString += '<Mun>'+IIF(!lEndFis,ConvType(SM0->M0_CIDCOB),ConvType(SM0->M0_CIDENT))+'</Mun>'\r\ncString += '<UF>'+IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))+'</UF>'\r\ncString += NfeTag('<CEP>',IIF(!lEndFis,ConvType(SM0->M0_CEPCOB),ConvType(SM0->M0_CEPENT)))\r\ncString += NfeTag('<cPais>',\"1058\")\r\ncString += NfeTag('<Pais>',\"BRASIL\")\r\naTelDest:= FisGetTel(SM0->M0_TEL)\r\ncFoneDest := IIF(aTelDest[1] > 0,ConvType(aTelDest[1],3),\"\") // Código do Pais\r\ncFoneDest += IIF(aTelDest[2] > 0,ConvType(aTelDest[2],3),\"\") // Código da Área\r\ncFoneDest += IIF(aTelDest[3] > 0,ConvType(aTelDest[3],9),\"\") // Código do Telefone\r\ncString += NfeTag('<fone>',cFoneDest)\r\ncString += '</enderEmit>'\r\ncString += '<IE>'+ConvType(VldIE(SM0->M0_INSC))+'</IE>'\r\nIf !Empty(aIEST) \r\n\t/*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t  ³ Tratamento para acordo entre os estados preenchidos no parametro MV_STNIEUF, quando em      ³\r\n\t  ³ um movimento com ICMS-ST nao e' necessario ter insccricao estadual, assim esse tratamento   ³\r\n\t  ³ retorna a inscricao \" \" para gerar a guia de recolhimento para o estado destino             ³ \r\n\t  ³ Este tratamento foi feito a partir da necessidade das UF de MG p/ PR,onde existe esse \t    ³\r\n\t  ³ acordo PROTOCOLO ICMS CONSELHO NACIONAL DE POLÍTICA FAZENDÁRIA - CONFAZ Nº 191 DE 11.12.2009³ \r\n\t  ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ*/\r\n\r\n\t/*If !(cMVEstado+cUfDest) $ cSTIeUf\r\n\t\tcString += NfeTag('<IEST>',aIEST[01]) \r\n\tEndIf*/\r\n\t\r\n\t// Preenche a tag quando IE do Emitente diferente do IE do parametro MV_SUBTRIB\r\n\t/*Inserida a verificação do idDest = 2 por conta de rejeição\r\n\t347 Informada IE do substituto tributário em operação que não é interestadual\r\n\t\r\n\tRegra de Validação\r\n\tSe informada a IE do Substituto Tributário para uma operação com Exterior ou Operação Interna (tag:idDest=1 ou 3)\r\n\tExceção: A critério da UF, poderá ser aceita a informação da IE-ST em operação interna.\r\n\t*/\r\n\t/* Adicionado tratativa para destacar em XML I.E. especial, para cliente ST, em operações internas no estado do PR, conforme Art. 176 § 10 do RICMS 2017 */                                                                                                                                                                                                                                                       \r\n\tIf((AllTrim(ConvType(VldIE(SM0->M0_INSC))) <> Alltrim(aIEST[01])) .And. (Alltrim (aIEST[01]) <> Alltrim(aIEST[02])) .And.;\r\n\t\t\t (cIdDest == \"2\" .OR. (cIdDest == \"1\" .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\")))\r\n\t\tcString += NfeTag('<IEST>',aIEST[01]) \r\n\tEndIf\r\nEndIf\r\ncString += NfeTag('<IM>',SM0->M0_INSCM)\r\ncString += NfeTag('<CNAE>',ConvType(SM0->M0_CNAE))\r\ncString += '<CRT>'+cMVCODREG+'</CRT>' \r\ncString += '</emit>'\r\nReturn(cString)\r\n\r\nStatic Function NfeDest(aDest,cVerAmb,aTransp,aCST,lBrinde,cMunDest)\r\n\t\r\n\tLocal aTelDest\t\t:= {}\r\n\tLocal cString\t\t:= \"\"\r\n\tLocal cMailTrans \t:= \"\"\r\n\tLocal cFoneDest\t\t:= \"\"\r\n\tLocal cIndicador\t:= \"\"\r\n\r\n\tDefault cMunDest\t:= \"\"\r\n\t\r\n\tcVerAmb\t:= PARAMIXB[2] \r\n\tcMunDest\t:= iIf(!lBrinde,IIf(Len(aDest[07])>5,aDest[07],aUF[aScan(aUF,{|x| x[1] == aDest[09]})][02]+aDest[07]),SM0->M0_CODMUN)\r\n\t\r\n\tcString := '<dest>'\r\n\tIf cVerAmb >= '3.10'\r\n\t//Estrangeiro não manda a tag de CPFCNPJ\r\n\t\tIf !\"EX\"$aDest[09]\r\n\t\t\tIf Len(AllTrim(aDest[01]))==14\r\n\t\t\t\tcString += '<CNPJ>'+iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CNPJ>'\r\n\t\t\tElseIf Len(AllTrim(aDest[01]))<>0\r\n\t\t\t\tcString += '<CPF>' +iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CPF>'\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\tIf !Empty(aDest[21])\r\n\t\t\t\tcString += '<idEstrangeiro>'+aDest[21]+'</idEstrangeiro>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<idEstrangeiro></idEstrangeiro>'\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tElse\r\n\t\tIf Len(AllTrim(aDest[01]))==14\r\n\t\t\tcString += '<CNPJ>'+iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CNPJ>'\r\n\t\tElseIf Len(AllTrim(aDest[01]))<>0\r\n\t\t\tcString += '<CPF>' +iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CPF>'\r\n\t\tElse\r\n\t\t\tcString += '<CNPJ></CNPJ>'\r\n\t\tEndIf\r\n\tEndIf\r\n\tcString += '<Nome>'+ConvType(iIf(!lBrinde,aDest[02],\"Diversos - Brindes\"))+'</Nome>'\r\n\tcString += '<enderDest>'\r\n\tcString += '<Lgr>'+ConvType(iIf(!lBrinde,aDest[03],(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1])))+'</Lgr>'\r\n\tif lBrinde\r\n\t\t\r\n\t\tif FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2]<>0\r\n\t\t\tcString += '<nro>'+FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3]+'</nro>' \r\n\t\telse\r\n\t\t\tcString += '<nro>'+\"SN\"+'</nro>'\r\n\t\tendif\r\n\t\r\n\telse \r\n\t\t\r\n\t\tIf  ValType(aDest[04]) == \"N\" .and. AT(\".\",Alltrim(Str(aDest[04]))) > 0\r\n\t\t\tcString += '<nro>'+Alltrim(Str(aDest[04]))+'</nro>'\r\n\t\tElse\r\n\t\t\tcString += '<nro>'+ConvType(aDest[04])+'</nro>'\r\n\t\tEndIf\r\n\tendif\r\n\tcString += NfeTag('<Cpl>',ConvType(iIf(!lBrinde,aDest[05],SM0->M0_COMPENT)))\r\n\tcString += '<Bairro>'+ConvType(iIf(!lBrinde,aDest[06],SM0->M0_BAIRENT))+'</Bairro>'\r\n\tcString += '<cMun>'+ConvType(cMunDest)+'</cMun>'\r\n\tcString += '<Mun>'+ConvType(iIf(!lBrinde,aDest[08],SM0->M0_CIDENT))+'</Mun>'\r\n\tcString += '<UF>'+ConvType(iIf(!lBrinde,aDest[09],SM0->M0_ESTENT))+'</UF>'\r\n\tcString += NfeTag('<CEP>',iIf(!lBrinde,aDest[10],SM0->M0_CEPENT))\r\n\tcString += NfeTag('<cPais>',aDest[11])\r\n\tcString += NfeTag('<Pais>',ConvType(aDest[12]))\r\n\tif lBrinde\r\n\t\taTelDest\t:= FisGetTel(SM0->M0_TEL)\r\n\t    cFoneDest\t:= IIF(aTelDest[1] > 0,ConvType(aTelDest[1],3),\"\") // Código do Pais\r\n\t    cFoneDest\t+= IIF(aTelDest[2] > 0,ConvType(aTelDest[2],3),\"\") // Código da Área\r\n\t    cFoneDest\t+= IIF(aTelDest[3] > 0,ConvType(aTelDest[3],9),\"\") // Código do Telefone\r\n\t\tcString\t+= NfeTag('<fone>',cFoneDest)\t\t\t\r\n\telse\r\n\t\tcString += NfeTag('<fone>', ConvType( FisGetTel(aDest[13])[2], 3) + ConvType( FisGetTel(aDest[13])[3], 11)  )\r\n\tendif\r\n\tcString += '</enderDest>'\r\n\t\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tIf ConvType(aDest[17]) <> \"2\" .and. !Empty(aDest[14])\r\n\t\t\tIf \"ISENT\" $ Upper(Alltrim(aDest[14]))\r\n\t\t\t\tcIndicador := \"2\"\r\n\t\t\tElse\r\n\t\t\t\tcIndicador := \"1\"\r\n\t\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\t\tcIndicador := \"9\" //9-Não Contribuinte: a IE do destinatário pode ser informada ou não, já que algumas UF concedem inscrição estadual para não contribuintes.\r\n\t\t\t\t//No caso de operação com o Exterior informar indIEDest=9 e não informar a tag IE do destinatário;\r\n\t\t\t\tIf  !\"EX\" $ aDest[09] .And. ConvType(aDest[14]) <> \"ISENTO\"\r\n\t\t\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\t\tcString += '<indIEDest>'+cIndicador+'</indIEDest>'\r\n\t\tcIndIEDest:= cIndicador\r\n\t\t\r\n\t\t/*\tindIEDest - Indicador da IE do destinatário\r\n\t\t\t1=Contribuinte ICMS (informar a IE do destinatário);\r\n\t\t\t2=Contribuinte isento de Inscrição no cadastro de Contribuintes do ICMS;\r\n\t\t\t9=Não Contribuinte, que pode ou não possuir Inscrição Estadual no Cadastro de Contribuintes do ICMS;\t\r\n\t\t*/\r\n\tElse\r\n\t\t// Conforme legislação, não contribuinte em SP, deve levar a IE se preenchida.\r\n\t\tIf ConvType(aDest[18]) == \"1\" .And. ConvType(aDest[17]) == \"2\"\r\n\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\tElseIf ConvType(aDest[17]) == \"2\" .And. ConvType(aDest[14]) <> \"ISENTO\" .And. SuperGetMV(\"MV_ESTADO\") <> \"SP\"  \r\n\t\t\tcString += '<IE>'+\"\"+'</IE>' \r\n\t\t\r\n\t\t/*---------------------------------------------\r\n\t\t Tratamento realizado Produtor Rural - RS\r\n\t\t \r\n\t\t 1. Cliente     \t\t= Produtor Rural\r\n\t\t 2. Documento tipo\t= Devolucao\r\n\t\t 3. Origem Rotina\t\t= Loja\r\n\t\t 4. Parametro\testado\t= RS (Rio G. Sul)\r\n\t\t \r\n\t\t Obs.: Chamado Consultoria Tributaria: TQCMPM\r\n\t\t---------------------------------------------*/\t\r\n\t\tElseIf Alltrim(SA1->A1_TIPO) == \"L\" .And. Alltrim(SF1->F1_TIPO) == \"D\" .And. Alltrim(SF1->F1_ORIGLAN) == \"LO\" .And. SuperGetMV(\"MV_ESTADO\") == \"RS\" \r\n\t\t\tcString += '<IE>'+\"\"+'</IE>'\t\t\t\r\n\t\t\r\n\t\tElse\r\n\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\tEndif\r\n\tEndIf\r\n\t\r\n\t//Tratamento para atender Manual de Orientação do Contribuinte versão 5.00 onde é Obrigatório, nas operações que se beneficiam de incentivos fiscais existentes nas áreas sob controle da SUFRAMA.\r\n\tcString += NfeTag('<IESUF>',aDest[15])\t\r\n\t\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += NfeTag('<IM>',aDest[19])\r\n\tEndIf\r\n\t//Considera o e-mail do cadastro da transportadora\r\n\tIf Len(aTransp) > 0\r\n\t\tIf !Empty(aDest[16]) .and. !Empty(AllTrim(aTransp[07]))\r\n\t\t\tcMailTrans := \";\"+AllTrim(aTransp[07])\r\n\t\tElse \r\n\t\t\tcMailTrans := AllTrim(aTransp[07])\r\n\t\tEndIf \t\r\n\tElse\r\n\t\tcMailTrans := \"\"\r\n\tEndIf\r\n\tif !lBrinde\r\n\t\tcString += NfeTag('<EMAIL>',AllTrim(aDest[16])+cMailTrans)\r\n\tendif\r\n\t\r\n\tcString += '</dest>'\r\nReturn(cString)\r\n\r\nStatic Function NfeLocalEntrega(aEntrega)\r\n\r\nLocal cString:= \"\"\r\n\r\nIf !Empty(aEntrega) .And. (Len(AllTrim(aEntrega[01]))==14 .Or. Len(AllTrim(aEntrega[01]))==11) \r\n\tcString := '<entrega>'\r\n\tIf Len(AllTrim(aEntrega[01]))==14 .AND. !(\"EX\" $ aEntrega[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<CNPJ>'+AllTrim(aEntrega[01])+'</CNPJ>' \r\n\tElseif Len(AllTrim(aEntrega[01]))<>0 .AND. !(\"EX\" $ aEntrega[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<cpf>' +AllTrim(aEntrega[01])+'</cpf>'\t\r\n\tElse\r\n\t\tcString += '<CNPJ></CNPJ>'\r\n\tEndif\r\n\tIf lTagProduc\r\n\t\tcString += '<Nome>'+ConvType(aEntrega[09])+'</Nome>'\r\n\tEndif\r\n\tcString += '<Lgr>'+ConvType(aEntrega[02])+'</Lgr>'\r\n\tcString += '<nro>'+ConvType(aEntrega[03])+'</nro>'\r\n\tcString += NfeTag('<Cpl>',ConvType(aEntrega[04]))\r\n\tcString += '<Bairro>'+ConvType(aEntrega[05])+'</Bairro>'\r\n\tcString += '<cMun>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aEntrega[08]})][02]+aEntrega[06])+'</cMun>'\r\n\tcString += '<Mun>'+ConvType(aEntrega[07])+'</Mun>'\r\n\tcString += '<UF>'+ConvType(aEntrega[08])+'</UF>'\r\n\tIf lTagProduc\r\n\t\tcString += '<CEP>'+ConvType(aEntrega[11])+'</CEP>'\r\n\t\tcString += '<cPais>'+ConvType(aEntrega[12])+'</cPais>'\r\n\t\tcString += '<Pais>'+ConvType(aEntrega[13])+'</Pais>'\r\n\t\tcString += '<fone>'+ConvType(aEntrega[14])+'</fone>'\r\n\t\tcString += '<email>'+ConvType(aEntrega[15])+'</email>'\r\n\t\tcString += '<IE>'+ConvType(aEntrega[10])+'</IE>'\r\n\tEndif\r\n\t\r\n\tcString += '</entrega>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NfeLocalRetirada(aRetirada)\r\n\r\nLocal cString:= \"\"\r\n\r\nIf !Empty(aRetirada)\r\n\tcString := '<retirada>'\r\n\tIf Len(AllTrim(aRetirada[01]))==14 .AND. !(\"EX\" $ aRetirada[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<CNPJ>'+AllTrim(aRetirada[01])+'</CNPJ>' \r\n\tElseif Len(AllTrim(aRetirada[01]))<>0 .AND. !(\"EX\" $ aRetirada[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<cpf>' +AllTrim(aRetirada[01])+'</cpf>'\t\r\n\tElse\r\n\t\tcString += '<CNPJ></CNPJ>'\r\n\tEndif\r\n\tIf lTagProduc\r\n\t\tcString += '<Nome>'+ConvType(aRetirada[09])+'</Nome>'\r\n\tEndif\r\n\tcString += '<Lgr>'+ConvType(aRetirada[02])+'</Lgr>'\r\n\tcString += '<nro>'+ConvType(aRetirada[03])+'</nro>'\r\n\tcString += NfeTag('<Cpl>',ConvType(aRetirada[04]))\r\n\tcString += '<Bairro>'+ConvType(aRetirada[05])+'</Bairro>'\r\n\tcString += '<cMun>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aRetirada[08]})][02]+aRetirada[06])+'</cMun>'\r\n\tcString += '<Mun>'+ConvType(aRetirada[07])+'</Mun>'\r\n\tcString += '<UF>'+ConvType(aRetirada[08])+'</UF>'\r\n\tIf lTagProduc\r\n\t\tcString += '<CEP>'+ConvType(aRetirada[11])+'</CEP>'\r\n\t\tcString += '<cPais>'+ConvType(aRetirada[12])+'</cPais>'\r\n\t\tcString += '<Pais>'+ConvType(aRetirada[13])+'</Pais>'\r\n\t\tcString += '<fone>'+ConvType(aRetirada[14])+'</fone>'\r\n\t\tcString += '<email>'+ConvType(aRetirada[15])+'</email>'\r\n\t\tcString += '<IE>'+ConvType(aRetirada[10])+'</IE>'\r\n\tEndif\r\n\tcString += '</retirada>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NfeItem(aProd,aICMS,aICMSST,aIPI,aPIS,aPISST,aCOFINS,aCOFINSST,aISSQN,aCST,aMed,aArma,aveicProd,aDI,aAdi,aExp,aPisAlqZ,aCofAlqZ,aAnfI,cTipo,cVerAmb,aComb,cMensFis,cCsosn,aPedCom,aNota,aICMSZFM,aDest,cIpiCst,aFCI,lIcmDevol,nVicmsDeson,nVIcmDif,cMunPres,aAgrPis,aAgrCofins,nIcmsDif,aICMUFDest,nvFCPUFDest,nvICMSUFDest,nvICMSUFRemet,cAmbiente,aIPIDevol,nvBCUFDest, aItemVinc,npFCPUFDest,npICMSUFDest,npICMSInter,npICMSIntP,aLote,cMensDifal, aTotICMSST, nTotProd, nItProd, nValDifer)\r\n\r\nLocal cString \t\t:= \"\"\r\nLocal cMVCODREG\t\t:= AllTrim(SuperGetMV(\"MV_CODREG\", ,\" \"))\r\nLocal cVunCom\t\t:= \"\"\r\nLocal cVunTrib\t\t:= \"\"  \r\nLocal cMotDesICMS\t:= \"\"\r\nLocal cMensDeson\t:= \"\"\r\nLocal cDedIcm\t\t:= \"\"\r\nLocal cCrgTrib\t\t:= \"\"\r\nLocal cPercTrib\t\t:= \"\"\r\nLocal cMVINCEFIS\t:= AllTrim(GetNewPar(\"MV_INCEFIS\",\"2\"))\r\nLocal cMVNumProc\t:= AllTrim(GetNewPar(\"MV_NUMPROC\",\" \"))\r\nLocal cF2Tipo\t\t:= \"\"\r\nLocal cMsgDI\t\t:= \"\"\r\nLocal cMensFecp\t\t:= \"\"\r\nLocal cEan\t\t\t:= \"\"\r\nLocal cEantrib\t\t:= \"\"\r\nLocal lAnfProd\t\t:= SuperGetMV(\"MV_ANFPROD\",,.T.)\r\nLocal lArt186\t    := SuperGetMV(\"MV_ART186\",,.F.)\r\nLocal lIssQn     \t:= .F.\r\nLocal lMvPisCofD \t:= GetNewPar(\"MV_DPISCOF\",.F.)   // Parâmetro para informar os valores de Cofins e Pis nas Informações complementares do Danfe \r\n//Local lSimpNac   \t:= SuperGetMV(\"MV_CODREG\")== \"1\" .Or. SuperGetMV(\"MV_CODREG\")== \"2\" \r\nLocal lUnTribCom\t:= GetNewPar(\"MV_VTRICOM\",.F.) //Parâmetro para informar o valor unitário comercial e valor unitário tributável nas informações complementares do DANFE (quando vuncom e vuntrib forem diferentes)\r\nLocal lNContrICM\t:= .F.  //Define se o cliente não é contribuinte do ICMS no estado.\r\nLocal lPesFisica\t:= .F.\r\nLocal lDInoDanfe\t:= GetNewPar(\"MV_DIDANFE\",.F.) //Parâmetro para informar os dados da DI nas informações complementares do Xml/Danfe\r\nLocal lCalcMed \t\t:= GetNewPar(\"MV_STMEDIA\",.F.) //Define se irá calcular a média do ICMS ST e da BASE do ICMS ST. \r\nLocal lSuframa\t\t:= GetNewPar(\"MV_SUFRAMA\",.F.) // Parâmetro referente a Suframa\r\nLocal lProdItem\t\t:= .F.\t//Define se esta configurado para gerar a mensagem da Lei da Transparencia por Produto ou somente nas informacoes Complementares.\r\nLocal lEECFAT\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lEndFis \t\t:= GetNewPar(\"MV_SPEDEND\",.F.)\r\nlocal lDateRefNf\t:= .T.\r\nLocal aPPDifal\t\t:= &(SuperGetMV(\"MV_PPDIFAL\", ,\"{{2016,40,60},{2017,60,40},{2018,80,20},{2019,100,0}}\"))\r\nLocal aPICMSInter\t:= {}\r\nLocal nX\t\t\t:= 0\r\nLocal nBaseIcm   \t:= 0\r\nLocal nValCof \t\t:= 0\r\nLocal nValICM\t \t:= 0\r\nLocal nValPis\t\t:= 0\r\nLocal nDesonICM\t\t:= 0\r\nLocal nValIcmDif\t:= 0\r\nLocal nA\t\t\t:= 0\r\nLocal nPos\t\t\t:= 0\r\nLocal nUltimo\t\t:= 0\r\nLocal nBfcpant\t\t:= 0\r\nLocal nAfcpant\t\t:= 0\r\nLocal nVfcpant\t\t:= 0\r\nLocal nAlqICM   \t:= 0  \r\nLocal nVICPRST  \t:= 0  \r\nLocal cUltAqui  \t:= AllTrim(SuperGetMv(\"MV_ULTAQUI\",,\"\"))\r\nLocal cArt274\t\t:= \"\"\r\nLocal anDraw\t\t:= {}\r\nLocal aExportInd\t:= {}\r\nLocal nValDeson\t\t:= 0\r\nLocal lRetEfet\t\t:= .T.     //ICMS RETIDO COM ICMS EFETIVO\r\nLocal nPIcmsDif\t\t:= 0\r\n\r\nDEFAULT aICMS    \t\t:= {}\r\nDEFAULT aICMSST  \t\t:= {}\r\nDEFAULT aICMSZFM \t\t:= {}\r\nDEFAULT aIPI     \t\t:= {}\r\nDEFAULT aPIS    \t\t:= {}\r\nDEFAULT aPISST   \t\t:= {}\r\nDEFAULT aCOFINS  \t\t:= {}\r\nDEFAULT aCOFINSST\t\t:= {}\r\nDEFAULT aISSQN   \t\t:= {}\r\nDEFAULT aMed     \t\t:= {}\r\nDEFAULT aArma    \t\t:= {}\r\nDEFAULT aveicProd\t\t:= {}\r\nDEFAULT aDI\t\t \t\t:= {}\r\nDEFAULT aAdi\t \t\t:= {}\r\nDEFAULT aExp\t \t\t:= {}\r\nDEFAULT aAnfI\t \t\t:= {}\r\nDEFAULT aPedCom  \t\t:= {}\r\nDEFAULT aFCI\t\t\t:= {}\r\nDEFAULT aIPIDevol\t\t:= {}\r\nDEFAULT aItemVinc\t\t:= {}\r\nDEFAULT aTotICMSST\t\t:= {}\r\nDEFAULT cMensFis \t\t:= \"\"\r\nDEFAULT cCsosn    \t\t:= \"\"\r\nDEFAULT cMensDifal\t\t:= \"\"\r\nDEFAULT nVicmsDeson\t\t:= 0\r\nDEFAULT nVIcmDif\t\t:= 0\r\nDEFAULT nIcmsDif\t\t:= 0 \r\nDEFAULT nvFCPUFDest\t\t:= 0\r\nDEFAULT nvICMSUFDest\t:= 0\r\nDEFAULT nvICMSUFRemet\t:= 0\r\nDEFAULT nvBCUFDest\t\t:= 0\r\nDEFAULT nTotProd\t\t:= 0\r\nDEFAULT nItProd\t\t\t:= 0\r\nDEFAULT nValDifer\t\t:= 0\r\n\r\ncVerAmb     := PARAMIXB[2]\r\ncAmbiente\t:= PARAMIXB[3]\r\ncF2Tipo\t:= IIF(!Empty(aNota[5]),aNota[5], \"N\")\r\ncArt274 := aProd[48]\r\n//Se o campo B1_CODGTIN estiver preenchido considera ele em promeiro lugar  para levar para nfe.\r\n//Porem se  B1_CODGTIN  ='999999999999999' e levando \"\" sendo tratado pelo tss \"SEM GETIN\"\r\n//Se B1_CODGTIN =  \"\" vaziu continua pegando do legado B1_CODBAR para levar para nfe.\r\ncEan\t\t:= IIF(!Empty(aProd[46]),iif( aProd[46] == \"000000000000000\",\"\",aProd[46]), aProd[03])\r\n\r\n//Se a segunda unidade de medida estiver \"B5_2CODBAR\" estiver preenchido leva ele  para nfe.\r\n//senão verifica se a unidade comercial e diferente da tributaria para considerar o mesmo valor da cEan se for igual.\r\ncEantrib\t:= IIF(!Empty(aProd[45]),aProd[45], iif( aProd[08] <> aProd[11],\"\",cEan))\r\n\r\n//Validação para controle das tags que deverão ser preenchidas apenas nas operações não destinadas a consumidor final RS\r\nlRetEfet := (cMVEstado == \"RS\" .and. cIndFinal == '0') .or. cMVEstado <> \"RS\"\r\n\r\ncString += '<det nItem=\"'+ConvType(aProd[01])+'\">'\r\ncString += '<prod>'\r\ncString += '<cProd>'+ConvType(aProd[02])+'</cProd>'\r\ncString += '<ean>'+ConvType(cEan)+'</ean>'\r\ncString += '<Prod>'+ConvType(aProd[04],120)+'</Prod>'\r\nIf len(aDI)> 0\r\n\tcString +='<NCM>'+ConvType(aDI[01][03])+'</NCM>'\r\n\tIf cVerAmb >= \"3.10\" .and. ConvType(aDI[04][1]) == \"I19\"\r\n\t\tcString += NfeTag('<NVE>',ConvType(aDI[35][03]))\r\n\tElseIf cVerAmb >= \"3.10\" .and. ConvType(aDI[02][1]) == \"I19\" //Nota Complementar EEC/EIC\r\n\t\tcString += NfeTag('<NVE>',ConvType(aDI[17][03]))\t\r\n\tEndIf\r\nElse\r\n\tcString +='<NCM>'+ConvType(aProd[05])+'</NCM>'\r\nEndIf\r\ncString += NfeTag('<CEST>',ConvType(aProd[41]))\r\n\r\nIF cVeramb >= \"4.00\"\r\n\tcString += NfeTag('<indEscala>',ConvType(aProd[47]))\r\n\tcString += NfeTag('<cBenef>',ConvType(aProd[44]))\r\n\r\nEndIf\r\ncString += NfeTag('<EXTIPI>',ConvType(aProd[06]))\r\ncString += '<CFOP>'+ConvType(aProd[07])+'</CFOP>'\r\ncString += '<uCom>'+ConvType(aProd[08])+'</uCom>'\r\ncString += '<qCom>'+ConvType(round(aProd[09],4),15,4 )+'</qCom>' // bruno original = ConvType( aProd[09],15,4 )\r\n\r\n/*\r\nbruno sigawise\r\n-original = cString += '<vUnCom>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[09],21,8))+'</vUnCom>'\r\n-não tem o if\r\n*/\r\nIf aProd[8] <> aProd[11]\r\n\tcString += '<vUnCom>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[09],21,8))+'</vUnCom>'\r\nElse\r\n\tcString += '<vUnCom>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[12],21,8))+'</vUnCom>'\r\nEndIf\r\n\r\ncString += '<vProd>' +ConvType(aProd[10],15,2)+'</vProd>' \r\ncString += '<eantrib>'+ConvType(cEantrib)+'</eantrib>'\r\ncString += '<uTrib>'+ConvType(aProd[11])+'</uTrib>'\r\nIf aProd[8] <> aProd[11]  // aProd[8] = B1_UM  e  aProd[11] = B5_UMDIPI - pega diferente para segunda unidade de medida \r\n\tcString += '<qTrib>' + ConvType(aProd[12], 15, TamSX3(\"B5_CONVDIP\")[2]) + '</qTrib>'\r\nElse\r\n\tcString += '<qTrib>' + ConvType(aProd[12], 15, Min(IIf(cTipo == \"0\", TamSX3(\"D1_QUANT\")[2], TamSX3(\"D2_QUANT\")[2]), 4)) + '</qTrib>'\r\nEndif\r\n\r\ncString += '<vUnTrib>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[12],21,8))+'</vUnTrib>'\t\r\n\r\ncString += NfeTag('<vFrete>',ConvType(aProd[13],15,2))\r\ncString += NfeTag('<vSeg>'  ,ConvType(aProd[14],15,2))\r\n\r\n//Tag <vDesc>\r\n//Quando eh Zona Franca de Manaus\r\nIf cVerAmb >= \"3.10\" .and. Len(aICMSZFM) > 0 .And. Len(aCST) > 0 .And. !Empty(aICMSZFM[1])\r\n\tIf !(lMvNFLeiZF)\t\r\n\t\tcString += NfeTag('<vDesc>' ,ConvType((aProd[31]+aProd[32])+aProd[15],15,2))\t\r\n\tElse\t\r\n\t\tcString += NfeTag('<vDesc>' ,ConvType(aProd[15],15,2))\r\n\tEndif\r\nElse\r\n\t//Versao 2.00\r\n\tcString += NfeTag('<vDesc>' ,ConvType((aProd[15]),15,2))\r\nEndIf\r\n\r\ncString += NfeTag('<vOutro>' ,ConvType(aProd[49]+aProd[21]+Iif(aAgrPis[01],aAgrPis[02],0)+Iif(aAgrCofins[01],aAgrCofins[02],0),15,2))\r\n// Define se o valor do produto <vProd> será agregado ao valor total\r\n//   dos produtos do documento <vProd> dentro de <total>\r\ncString += '<indTot>'+aProd[24]+'</indTot>'\r\n\r\n/* Adequação Nota Técnica 2013/003 (Obs. Tratamento apenas para documento de saída pois refere-se a venda ao consumidor) */\r\nIf cTipo == \"1\" .And. cTpCliente == \"F\"\r\n\tcString += NfeTag('<vTotTrib>' ,ConvType(aProd[30],15,2))\r\nEndIf\r\n\r\n\r\n/*Nas situações em que o valor unitário comercial (vUnCom) for diferente do valor unitário tributável (vUnTrib), \r\nambas as informações deverão estar expressas e identificadas no DANFE - CH:TGCOQA*/\r\n\r\ncVunCom := ConvType(aProd[10]/aProd[09],21,8)\r\ncVunTrib:= ConvType(aProd[10]/aProd[12],21,8)\r\n\r\nIf (cVunCom <> cVunTrib) .and. lUnTribCom\r\n\tcMensFis += \" \"\r\n\tcMensFis += \"(Valor unitario comercial: \"+cVunCom+ \", \"\r\n\tcMensFis += \"Valor unitario tributavel: \"+cVunTrib+ \") \"\t\r\nEndIf\r\n\r\n//³Criação de novo grupo “Rastreabilidade de produto” para permitir a rastreabilidade de qualquer produto sujeito a regulações sanitárias.\r\nIf\tcVeramb >= \"4.00\" .and. !empty(aLote)\r\n    If  !empty(aLote[1])\r\n\t\tcString += '<rastro>'\r\n\t\tcString += '<nLote>'+ConvType(aLote[01])+'</nLote>'\r\n\t\tcString += '<qLote>'+ConvType(aLote[02],12,3)+'</qLote>'\r\n\t\tcString += '<dFab>'+ConvType(aLote[03]) +'</dFab>'\r\n\t\tcString += '<dVal>'+ConvType(aLote[04]) +'</dVal>'\r\n\t\tcString += NfeTag('<cAgreg>',ConvType(aLote[05]))\r\n\t\tcString += '</rastro>'\r\n\tEndIf\r\nEndIf \r\n\r\n//Ver II - Average - Tag da Declaração de Importação aDI\r\nIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\"\r\n\tcString += '<DI>'\r\n\tcString += '<nDI>'+ConvType(aDI[04][03])+'</nDI>'\r\n\tcString += '<dtDi>'+ConvType(aDI[05][03])+ '</dtDi>'      \r\n\tcString += '<LocDesemb>'+ConvType(aDI[06][03])+ '</LocDesemb>'\r\n\tcString += '<UFDesemb>'+ConvType(aDI[07][03])+ '</UFDesemb>'\r\n\tcString += '<dtDesemb>'+ConvType(aDI[08][03])+ '</dtDesemb>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<viaTransp>'+ConvType(aDI[36][03],2)+ '</viaTransp>'\r\n\t\tcString += NfeTag('<AFRMM>',ConvType(aDI[37][3],15,2))\r\n\t\tcString += '<intermedio>'+ConvType(aDI[38][03],1)+ '</intermedio>'\r\n\t\tcString += NfeTag('<CNPJ>',ConvType(aDI[39][3],14))\r\n\t\tcString += NfeTag('<UfTerceiro>',ConvType(aDI[40][3],2))\t\t\r\n\tEndIf\r\n\tcString += '<Exportador>'+ConvType(aDI[09][03])+ '</Exportador>'\r\n\tIf Len(aAdi)>0\r\n\t\tcString += '<adicao>'\r\n\t\tcString += '<Adicao>'+ConvType(aAdi[10][03])+ '</Adicao>'\r\n\t\tcString += '<SeqAdic>'+ConvType(aAdi[11][03])+ '</SeqAdic>'\r\n\t\tcString += '<Fabricante>'+ConvType(aAdi[12][03])+ '</Fabricante>'\r\n\t\tcString += '<vDescDI>'+ConvType(aAdi[13][03])+ '</vDescDI>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += NfeTag('<draw>',ConvType(aAdi[34][3],11))\r\n\t\tEndIf\r\n\t\tcString += '</adicao>'\r\n\tEndIf\r\n\tcString += '</DI>'\r\n\t/*Impressão dos dados da DI nas informações complementares do Danfe - CH:TELKDV*/\r\n\tIf lDInoDanfe\r\n\t\tcMsgDI  := \" \"\r\n\t\tcMsgDI += \"(Numero DI: \"+ConvType(aDI[04][03])+ \", \"\r\n\t\tcMsgDI += \"Local do Desembaraco: \"+ConvType(aDI[06][03])+ \", \"\r\n\t\tcMsgDI += \"UF do Desembaraco: \"+ConvType(aDI[07][03])+\", \"\r\n\t\tcMsgDI += \"Data do Desembaraco: \"+ConvType(aDI[08][03])+ \") \"\t\r\n\r\n\t\tIf !cMsgDI $ cMensFis\r\n\t\t\tcMensFis += cMsgDI\r\n\t\tEndIf\r\n\tEndIf\r\nElseif Len(aDI)>0\r\n\t//Nota Complementar - SIGAEIC estrutura 23X3\r\n\tcString += '<DI>'\r\n\tcString += '<nDI>'+ConvType(aDI[02][03])+'</nDI>'\r\n\tcString += '<dtDi>'+ConvType(aDI[03][03])+ '</dtDi>'      \r\n\tcString += '<LocDesemb>'+ConvType(aDI[04][03])+ '</LocDesemb>'\r\n\tcString += '<UFDesemb>'+ConvType(aDI[05][03])+ '</UFDesemb>'\r\n\tcString += '<dtDesemb>'+ConvType(aDI[06][03])+ '</dtDesemb>'\r\n\t\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<viaTransp>'+ConvType(aDI[18][03],2)+ '</viaTransp>'\r\n\t\tcString += NfeTag('<AFRMM>',ConvType(aDI[19][3],15,2))\r\n\t\tcString += '<intermedio>'+ConvType(aDI[20][03],1)+ '</intermedio>'\r\n\t\tcString += NfeTag('<CNPJ>',ConvType(aDI[21][3],14))\r\n\t\tcString += NfeTag('<UfTerceiro>',ConvType(aDI[22][3],2))\t\t\r\n\tEndIf\r\n\tcString += '<Exportador>'+ConvType(aDI[07][03])+ '</Exportador>'\r\n\tIf Len(aAdi)>0\r\n\t\tcString += '<adicao>'\r\n\t\tcString += '<Adicao>'+ConvType(aAdi[08][03])+ '</Adicao>'\r\n\t\tcString += '<SeqAdic>'+ConvType(aAdi[09][03])+ '</SeqAdic>'\r\n\t\tcString += '<Fabricante>'+ConvType(aAdi[10][03])+ '</Fabricante>'\r\n\t //\tcString += '<vDescDI>'+ConvType(aAdi[13][03])+ '</vDescDI>'\r\n\t \tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += NfeTag('<draw>',ConvType(aAdi[23][3],11))\r\n\t\tEndIf\r\n\t\tcString += '</adicao>'\r\n\tEndIf\r\n\tcString += '</DI>'\r\n\t/*Impressão dos dados da DI nas informações complementares do Danfe - CH:TELKDV*/\r\n\tIf lDInoDanfe\r\n\t\tcMsgDI := \" \"\r\n\t\tcMsgDI += \"(Numero DI: \"+ConvType(aDI[02][03])+ \", \"\r\n\t\tcMsgDI += \"Local do Desembaraco: \"+ConvType(aDI[04][03])+ \", \"\r\n\t\tcMsgDI += \"UF do Desembaraco: \"+ConvType(aDI[05][03])+\", \"\r\n\t\tcMsgDI += \"Data do Desembaraco: \"+ConvType(aDI[06][03])+ \") \"\t\r\n\r\n\t\tIf !cMsgDI $ cMensFis\r\n\t\t\tcMensFis += cMsgDI\r\n\t\tEndIf\r\n\tEndIf\r\nEndIf\r\n\r\n/*Grupo de informações de exportação para o item - versão 3.10*/\r\nIf cVerAmb >= \"3.10\" .and. Len(aExp)>0\r\n\tIf lEECFAT\r\n\t\t/*Quando a terceira posição do array estiver vazia ou possuir tamanho 0 é porque a informação não existe no processo.\r\n\t\t  Quando não houver dados de retorno referente ao ato concessório e a exportação indireta, a posição [3][3] terá tamanho 0.\r\n\t\t  Quando houver ato concessório, a informação será retornada na posição [3][3][1]. O tamanho dessa dimensão corresponde à quantidade de atos concessórios encontrados para o item.\r\n\t\t  Quando houver exportação indireta, a informação será retornada na posição [3][3][2]. O tamanho dessa dimensão corresponde à quantidade de notas fiscais de remessa com fim específico de exportação encontrada para o item.\r\n\t\t*/\r\n\t\tIf ConvType(aExp[03][1]) == \"I50\" .and. Len(aExp[03][3]) > 0\r\n\t\t\t\r\n\t\t\t\tFor nA:= 1 to Len(aExp[03][3][1])\r\n\t\t\t\t\tanDraw:= aExp[03][3][1][nA] //Array (tag nDraw - I51)\r\n\t\t\t\t\taExportInd:= aExp[03][3][2][nA]//Array I52(Grupo - I52)\r\n\t\t\t\t\t\r\n\t\t\t\t\tcString += '<detExport>'\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(anDraw[3])\r\n\t\t\t\t\t\tcString += '<Draw>'+ConvType(anDraw[3],11)+ '</Draw>'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Caso não tenha I52, posição 3 é retornada vazia\r\n\t\t\t\t\tIf !Empty(aExportInd[3])\r\n\t\t\t\t\t\tcString += '<exportInd>'\r\n\t\t\t\t\t\tcString += '<nre>'+ConvType(aExportInd[03][1][3],12)+ '</nre>'\r\n\t\t\t\t\t\tcString += '<chnfe>'+ConvType(aExportInd[03][2][3],44)+ '</chnfe>'\r\n\t\t\t\t\t\tcString += '<qExport>'+ConvType(aExportInd[03][3][3],15,4)+ '</qExport>'\r\n\t\t\t\t\t\tcString += '</exportInd>'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tcString += '</detExport>'\r\n\t\t\t\tNext\r\n\t\t\t\r\n\t\tEndIf\r\n\t// Para nota de devolução de exportação gerar a tag  exportInd para não ocorrer a rejeição:340\r\n\t//340-Rejeicao: Nao informado o grupo de exportacao indireta no item [nItem:1] chamado:TVTAA8                                                                                                                                                                                  \r\n\tElseIf !lEECFAT .and. aNota[04] == \"0\" .and. aNota[5] $ \"D|N\"  \r\n\t\tFor nX := 1 To Len(aExp)\r\n\t\t\t   IF !Empty(aExp[nX][03][03]) .Or. !Empty(aExp[nX][04][03]) \r\n\t\t\t\t\tcString += '<detExport>'\r\n\t\t\t\t\tIf !Empty(aExp[nX][04][03])\r\n\t\t\t\t\t\tcString += '<exportInd>'\r\n\t\t\t\t\t\tcString += '<nre>'+ConvType(aExp[nX][04][03],12)+ '</nre>'\r\n\t\t\t\t\t\tcString += '<chnfe>'+ConvType(aExp[nX][05][03],44)+ '</chnfe>'\r\n\t\t\t\t\t\tcString += '<qExport>'+ConvType(aExp[nX][06][03],15,4)+ '</qExport>'\r\n\t\t\t\t\t\tcString += '</exportInd>'\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcString += '</detExport>'\r\n\t\t\t\tEndif\r\n\t\tNext\t\r\n\tElse\r\n\t\tFor nX := 1 To Len(aExp)\r\n\t\t\tIf ConvType(aExp[nX][03][1]) == \"I51\"\r\n\t\t\t   IF !Empty(aExp[nX][03][03]) .Or. aExp[nX][08][03] == \"1\" .Or. (!Empty(aExp[nX][04][03]) .And. !Empty(aExp[nX][05][03]) .And. !Empty(aExp[nX][06][03]))\r\n\t\t\t\t\tcString += '<detExport>'\r\n\t\t\t\t\tcString += '<Draw>'+ConvType(aExp[nX][03][03],11)+ '</Draw>'\r\n\t\t\t\t\tIf aExp[nX][08][03] == \"1\" .Or. (!Empty(aExp[nX][04][03]) .And. !Empty(aExp[nX][05][03]) .And. !Empty(aExp[nX][06][03]))\r\n\t\t\t\t\t\tcString += '<exportInd>'\r\n\t\t\t\t\t\tcString += '<nre>'+ConvType(aExp[nX][04][03],12)+ '</nre>'\r\n\t\t\t\t\t\tcString += '<chnfe>'+ConvType(aExp[nX][05][03],44)+ '</chnfe>'\r\n\t\t\t\t\t\tcString += '<qExport>'+ConvType(aExp[nX][06][03],15,4)+ '</qExport>'\r\n\t\t\t\t\t\tcString += '</exportInd>'\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcString += '</detExport>'\r\n\t\t\t\tEndif\r\n\t\t\tEndIf\r\n\t\tNext \r\n\tEndIf\r\nEndif\r\n//Combustiveis\r\n\r\nIf Len(aComb) > 0  .And. !Empty(aComb[01])\r\n\tcString += '<comb>'\r\n\tcString += '<cprodanp>'+ConvType(aComb[01])+'</cprodanp>'\r\n\tIf cVeramb >= \"3.10\" .and. Len(aComb) > 4\r\n\t\tcString += NfeTag('<mixGN>',ConvType(aComb[08],7,4))\r\n\tEndIf\r\n\t\r\n\tIf\tcVeramb >= \"4.00\" .and. Len(aComb) > 4\r\n\t\tcString += '<descANP>'+ConvType(aComb[14])+'</descANP>'\r\n\t\tcString += NfeTag('<pGLP>',ConvType(aComb[15],15,4))\r\n\t\tcString += NfeTag('<pGNn>',ConvType(aComb[16],15,4))\r\n\t\tcString += NfeTag('<pGNi>',ConvType(aComb[17],15,4))\r\n\t\tcString += NfeTag('<vPart>',ConvType(aComb[18],13,2))\r\n\tEndif\r\n\t\r\n\tcString += NfeTag('<codif>',ConvType(aComb[02]))\r\n\r\n\tcString += NfeTag('<qTemp>',ConvType(aComb[03],12,4))\r\n\tcString += '<ICMSCONS>'\r\n\tcString += '<UFCons>'+aComb[04]+'</UFCons>'\r\n    cString += '</ICMSCONS>'\t\r\n    If Len(aComb) > 4 .and. !Empty(aComb[05])\r\n\t\tcString += '<CIDE>'\r\n\t\tcString += '<qBCProd>'+ConvType(aComb[05],16,2)+'</qBCProd>'\r\n\t\tcString += '<vAliqProd>'+ConvType(aComb[06],15,4)+'</vAliqProd>'\r\n\t\tcString += '<vCIDE>'+ConvType(aComb[07],15,2)+'</vCIDE>'\r\n\t\tcString += '</CIDE>'\r\n\tEndif\t\r\n\t/*NT 2015/002\r\n\t379 - Rejeição: Grupo de Encerrante na NF-e (modelo 55) para CFOP diferente \r\n\tde venda de combustível para consumidor final (CFOP=5.656, 5.667).\t\r\n\t*/\r\n\tIf Len(aComb) > 4 .and. !Empty(aComb[09])\r\n\t\tcString += '<encerrante>'\r\n\t\tcString += '<nBico>'+ConvType(aComb[09])+'</nBico>'\r\n\t\tcString += NfeTag('<nBomba>',ConvType(aComb[10]))\r\n\t\tcString += '<nTanque>'+ConvType(aComb[11])+'</nTanque>'\r\n\t\tcString += '<vEncIni>'+ConvType(aComb[12],15)+'</vEncIni>'\r\n\t\tcString += '<vEncFin>'+ConvType(aComb[13],15)+'</vEncFin>'\r\n\t\tcString += '</encerrante>'\t\t\r\n\tEndIf\r\n\tcString += '</comb>'\r\n\r\nElseIf !Empty(aProd[17])\r\n\tcString += '<comb>'\r\n\tcString += '<cprodanp>'+ConvType(aProd[17])+'</cprodanp>'\r\n\tcString += NfeTag('<codif>',ConvType(aProd[18]))\r\n\tcString += '</comb>'\r\n\t//Tratamento da CIDE - Ver com a Average\r\n\t//Tratamento de ICMS-ST - Ver com fisco\r\nEndIf\r\n\r\n//Veiculos Novos\r\nIf !Empty(aveicProd) .And. !Empty(aveicProd[02])\r\n\tcString += '<veicProd>'\r\n\tcString += '<tpOp>'+ConvType(aveicProd[01])+'</tpOp>'\r\n\tcString += '<chassi>'+ConvType(aveicProd[02],17)+'</chassi>'\r\n\tcString += '<cCor>'+ConvType(aveicProd[03],4)+'</cCor>'\r\n\tcString += '<xCor>'+ConvType(aveicProd[04],40)+'</xCor>'\r\n\tcString += '<pot>'+ConvType(aveicProd[05],4)+'</pot>'\r\n\tcString += '<Cilin>'+ConvType(aveicProd[23],4)+'</Cilin>'\r\n\t//Alteração efeutada para permitir que de acorodo com o Manual NFE 6.0, \r\n\t//quando peso liquido e bruto forem em toledas que se tenham 4 casas decimais.\r\n\tcString += '<pesol>'+ConvType(aveicProd[07],9,4)+'</pesol>'\r\n\tcString += '<pesob>'+ConvType(aveicProd[08],9,4)+'</pesob>'\t\r\n\tcString += '<nserie>'+ConvType(aveicProd[09],9)+'</nserie>'\r\n\tcString += '<tpcomb>'+ConvType(aveicProd[10],2)+'</tpcomb>'\r\n\tcString += '<nmotor>'+ConvType(aveicProd[11],21)+'</nmotor>'\r\n\tcString += '<CMT>'+ConvType(aveicProd[24],9)+'</CMT>' \r\n\tcString += '<dist>'+ConvType(aveicProd[13],4)+'</dist>'\r\n\tcString += '<anomod>'+ConvType(aveicProd[15],4)+'</anomod>'\r\n\tcString += '<anofab>'+ConvType(aveicProd[16],4)+'</anofab>'\r\n\tcString += '<tppint>'+ConvType(aveicProd[17],1)+'</tppint>'\r\n\tcString += '<tpveic>'+ConvType(aveicProd[18],2)+'</tpveic>'\r\n\tcString += '<espvei>'+SubStr(aveicProd[19],2,1)+'</espvei>'  // Considera apenas a segunda posição do campo CD9_ESPVEI\r\n\tcString += '<vin>'+ConvType(aveicProd[20],1)+'</vin>'\r\n\tcString += '<condvei>'+ConvType(aveicProd[21],1)+'</condvei>'\r\n\tcString += '<cmod>'+ConvType(aveicProd[22],6)+'</cmod>'\r\n\tcString += '<cCorDENATRAN>'+ConvType(aveicProd[26],2)+'</cCorDENATRAN>'\r\n\tcString += '<Lota>'+ConvType(aveicProd[25],3)+'</Lota>'\r\n\tcString += '<tpRest>'+ConvType(aveicProd[27],1)+ '</tpRest>'\r\n\tcString += '</veicProd>'                            \r\nEndIf \r\n\r\n\r\n//Medicamentos\r\nIf !Empty(aMed) .And. !Empty(aMed[01])\r\n\tcString += '<med>'\t\r\n\tcString += '<cProdANVISA>'+ConvType(aMed[06],13)+'</cProdANVISA>'\r\n\tIf lTagProduc .and. !Empty(aMed[07])\r\n\t\tcString += '<MotivoIsencao>'+ConvType(aMed[07],225)+'</MotivoIsencao>'\r\n\tEndIf\r\n\tcString += '<Lote>'+ConvType(aMed[01],20)+'</Lote>'\r\n\tcString += NfeTag('<qLote>',ConvType(aMed[02],11,3))\r\n\tcString += NfeTag('<dtFab>',ConvType(aMed[03]))\r\n\tcString += NfeTag('<dtVal>',ConvType(aMed[04]))\r\n\tcString += '<vPMC>'+ConvType(aMed[05],15,2)+'</vPMC>'\r\n\tcString += '</med>'                            \r\nEndIf \r\n\r\n//Armas de Fogo\r\nIf !Empty(aArma) .And. !Empty(aArma[01])\r\n\tcString += '<arma>'\t\r\n\tcString += '<tpArma>'+ConvType(aArma[01])+'</tpArma>'\r\n\tIf cVeramb >= \"3.10\"\r\n\t\tcString += NfeTag('<nSerie>',ConvType(aArma[02],15))\r\n\t\tcString += NfeTag('<nCano>' ,ConvType(aArma[02],15))\r\n\tElse\r\n\t\tcString += NfeTag('<nSerie>',ConvType(aArma[02],9))\r\n\t\tcString += NfeTag('<nCano>' ,ConvType(aArma[02],9))\r\n\tEndIf\r\n\tcString += NfeTag('<descr>' ,ConvType(aArma[03],256))\r\n\tcString += '</arma>'                            \r\nEndIf \r\n\r\n//RECOPI\r\nIf cVeramb >= \"3.10\" .and. !Empty(cNumRecopi)\r\n\tcString += '<Recopi>'\r\n\tcString += '<nRECOPI>'+cNumRecopi+'</nRECOPI>'\r\n\tcString += '</Recopi>'\r\nEndIf\r\n\r\nIf Len(aPedCom) > 0 .And. !Empty(aPedCom[01])\r\n\tcString += '<xPed>'+ConvType(aPedCom[01])+'</xPed>'\r\n\tcString += '<nItemPed>'+ConvType(aPedCom[02])+'</nItemPed>'\r\nEndif\r\n\r\n//Nota Técnica 2013/006\r\nIf !Empty(aFCI)\r\n\tcString += '<nFCI>'+Alltrim(aFCI[01])+'</nFCI>'\r\nEndIf\r\ncString += '</prod>'\r\nDbSelectArea(\"SF4\")\r\n\r\nlIssQn:=(Len(aISSQN)>0 .and. !Empty(aISSQN[01]))\r\n\r\nIf (aCST[01] = \"60\" .or. cCsosn$ \"500\") .and. !Empty(cUltAqui)  .and. Len(aIcms)>19\r\n\t//novos campos na tabela SFT são: FT_BSTANT (Base) FT_PSTANT (Percentual) FT_VSTANT (Valor) Atenciosamente.\r\n\tnBaseIcm :=  aICMS[20]      //SFT->FT_BSTANT\r\n\tnValICM  :=  aICMS[21]      //SFT->FT_VSTANT\r\n\tnAlqICM  :=  aICMS[22]      //SFT->FT_PSTANT\r\n\t//novos campos do FECP na tabela SFT são: FT_BFCANTS (Base) FT_PFCANTS (Percentual) FT_VFCANTS (Valor) Atenciosamente.\r\n\tnBfcpant := aICMS[23]    //SFT->FT_BFCANTS\r\n\tnAfcpant := aICMS[24]    //SFT->FT_PFCANTS\r\n\tnVfcpant := aICMS[25]    //SFT->FT_VFCANTS\r\n\r\n\tnVICPRST := aICMS[26]   // FT_VICPRST  (Tag vICMSSubstituto)\r\nEndif\r\n\r\nIf  !lIssQn    \r\n\tIf cMVCODREG == \"1\" .and. SF4->(FieldPos(\"F4_CSOSN\"))>0 .And. !Empty(SF4->F4_CSOSN)\r\n\t\r\n\t\tIf Len(aIcms)>0\t\t\t\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>ICMSSN</codigo>'\r\n\t\t \tcString += '<cpl>'\r\n\t\t   \tcString += '<orig>'+ConvType(aICMS[01])+'</orig>'\r\n\t\t   \tcString += '</cpl>' \r\n\t\t   \tcString += '<Tributo>'\r\n\t\t\tcString += '<CSOSN>'+cCsosn+'</CSOSN>'   \r\n\t\tElse\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>ICMSSN</codigo>'\r\n\t\t \tcString += '<cpl>'\r\n\t\t   \tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\r\n\t\t   \tcString += '</cpl>' \r\n\t\t   \tcString += '<Tributo>'\r\n\t\t\tcString += '<CSOSN>'+cCsosn+'</CSOSN>' \t\r\n\t\tEndif\t\r\n\t\t\r\n\t\tIf cCsosn$\"900\" .And. Len(aIcms)>0\t    \r\n\t\t\tcString += '<modBC>'+ConvType(aICMS[03])+'</modBC>'\r\n\t\t\tcString += '<vBC>'+ConvType(aICMS[05],15,2)+'</vBC>'\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\" .And. !Empty(aAdi[14][03])\t\t\t \r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\r\n\t\t   \tElse\r\n\t   \t\t\tcString += '<pRedBC>'+ConvType(aICMS[04],8,4)+'</pRedBC>'\r\n\t\t\tEndIf\r\n\t\t\tcString += '<pICMS>'+ConvType(aICMS[06],5,2)+'</pICMS>'\r\n\t\t\tcString += '<vICMS>'+ConvType(aICMS[07],15,2)+'</vICMS>'\r\n\t\t\t\r\n\t\tElseIf cCsosn$\"900\" .And. Len(aIcms)<=0\t  \r\n\t\t\tcString += '<modBC>'+ConvType(0)+'</modBC>'\r\n\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\" .And. !Empty(aAdi[14][03])\t\t\t \r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\t\t\t \r\n\t\t   \tElse\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\t\t   \t\r\n\t\t\tEndIf\r\n\t\t\tcString += '<pICMS>'+ConvType(0,5,2)+'</pICMS>'\r\n\t\t\tcString += '<vICMS>'+ConvType(0,15,2)+'</vICMS>'\r\n\t\t\t\r\n\t    Endif\r\n\t\t\r\n\t\tIf cCsosn$\"201,202,203,900\" .AND. Len(aICMSST)>0\t\r\n\t\t\tcString += '<modBCST>'+ConvType(aICMSST[03])+'</modBCST>'\r\n\t\t\tIf cVeramb >= \"3.10\"\r\n\t\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],8,4)+'</pmvast>'\r\n\t\t\t\tcString += '<pRedBCST>'+ConvType(aICMSST[04],7,4)+'</pRedBCST>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],6,2)+'</pmvast>'\r\n\t\t\t\tcString += '<pRedBCST>'+ConvType(aICMSST[04],5,2)+'</pRedBCST>'\r\n\t\t\tEndIf\t\t\t\r\n\t\t\tcString += '<vBCST>'+ConvType(aICMSST[05],15,2)+'</vBCST>'\r\n\t\t\tcString += '<pICMSST>'+ConvType(aICMSST[06],5,2)+'</pICMSST>'\r\n\t\t\tcString += '<vICMSST>'+ConvType(aICMSST[07],15,2)+'</vICMSST>'\r\n\t    Elseif cCsosn$\"201,202,203,900\"\r\n\t    \tcString += '<modBCST>0</modBCST>'\r\n\t\t\tcString += '<vBCST>'+ConvType(0,15,2)+'</vBCST>'\r\n\t\t\tcString += '<pICMSST>'+ConvType(0,5,2)+'</pICMSST>'\r\n\t\t\tcString += '<vICMSST>'+ConvType(0,15,2)+'</vICMSST>'\r\n\t\t\t\r\n\t\t\tIF cVeramb >= \"4.00\" .AND. Len(aICMSST)>0 \r\n\t\t\t   IF cCsosn$ \"201\"\r\n\t\t\t\t\tcString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\t\t\t\r\n\t\t\t\t//pCredSN Alíquota aplicável de cálculo do crédito\r\n             // vCredICMSSN Valor crédito do ICMS\t\r\n\t\t\t   elseIf  cCsosn$ \"202,203\"\r\n\t\t\t        cString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\t\t   Endif\t\r\n\t\t\tEndif\r\n\t\tEndif\r\n\t\t\r\n\t\tIf cCsosn$\"500\"   \r\n\t\t\tIf Empty(cUltAqui) \r\n\t\t\t\tSPEDRastro2(aProd[20],aProd[19],aProd[02],@nBaseIcm,@nValICM,,,lCalcMed,@nAlqICM,,,,,,,,,,,@nBfcpant,@nAfcpant,@nVfcpant)        \r\n\t\t\t\r\n\t\t\t\tIf nBaseIcm > 0 .and. nValICM>0\r\n\t\t\t\t\tnBaseIcm := aProd[09]*nBaseIcm\r\n\t\t\t\t\tnValICM  := aProd[09]*nValICM\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t//multiplica o valor facp anterior.\r\n\t\t\t\tIf\tnBfcpant > 0 .and. nVfcpant>0\r\n\t\t\t\t\tnBfcpant  := aProd[09]*nBfcpant\r\n\t\t\t\t\tnVfcpant  := aProd[09]*nVfcpant\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tif lRetEfet\r\n\t\t\t\r\n\t\t\t\tIf nBaseIcm > 0\r\n\t\t\t\t\tcString += '<vBCSTRet>'+ConvType(nBaseIcm,15,2)+'</vBCSTRet>' \r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<vBCSTRet>'+ConvType(0,15,2)+'</vBCSTRet>'\r\n\t\t\t\tEndif\r\n\t\t\t\tIf nValICM > 0\r\n\t\t\t\t\tcString += '<vICMSSTRet>'+ConvType(nValICM,15,2)+'</vICMSSTRet>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<vICMSSTRet>'+ConvType(0,15,2)+'</vICMSSTRet>'\r\n\t\t\t\tEndif \r\n\t\t\t\t\r\n\t\t\t\tIf cVeramb >= \"4.00\" .AND. Len(aICMSST)>0\t\r\n\t\t\t\t\tcString += '<pST>'+ConvType((aICMSST[06]+aICMSST[14]),5,2)+'</pST>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<pST>'+ConvType((nAlqICM),5,2)+'</pST>'\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf lTagProduc \r\n\t\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\t\tEndif\r\n\r\n\t\t\t\tcString += '<vBCFCPSTRet>'+ConvType(nBfcpant,15,2)+'</vBCFCPSTRet>'\r\n\t\t\t\tcString += '<pFCPSTRet>'+ConvType(nAfcpant,5,2)+'</pFCPSTRet>'\r\n\t\t\t\tcString += '<vFCPSTRet>'+ConvType(nVfcpant,15,2)+'</vFCPSTRet>'\r\n\t\t\tendif\r\n\t\t\t\r\n\t\t\t//Tratamento implementado para atender o DECRETO Nº 54.308, DE 6 DE NOVEMBRO DE 2018. (publicado no DOE n.º 212, de 7 de novembro de 2018)\t\t\t\t\t\r\n\t\t\tIf cIndFinal == \"1\"\t.and. Len(aIcms)>0\t\t\t\t \r\n\t\t\t\tcString += '<pRedBCEfet>'+ConvType(aICMS[4],8,4)+'</pRedBCEfet>'\r\n\t\t\t\tcString += '<vBCEfet>'+ConvType( aICMS[5] ,16,2)+'</vBCEfet>'\r\n\t\t\t\tcString += '<pICMSEfet>'+ConvType(aICMS[6],8,4)+'</pICMSEfet>'\r\n\t\t\t\tcString += '<vICMSEfet>'+ConvType(aICMS[7],16,2)+'</vICMSEfet>'\r\n\t\t\tEndif\r\n\t\tEndif\r\n\t\t\r\n\t\tIF cVeramb >= \"4.00\" .AND. cCsosn$\"201,202,900\" .AND. Len(aICMSST)>0\t\r\n\t\t\tcString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\tEndIf\t\r\n\t\t\r\n\t\tIf cCsosn$\"101,201,900,\" .And. Len(aIcms)>0\t   \r\n\t\t\tcString += '<pCredSN>'+ConvType(aICMS[06],5,2)+'</pCredSN>'    \r\n\t\t\tcString += '<vCredICMSSN>'+ConvType(aICMS[07],15,2)+'</vCredICMSSN>'\r\n\t\tElseIf cCsosn$\"101,201,900,\" .And. Len(aIcms)<=0\t  \r\n\t\t\tcString += '<pCredSN>'+ConvType(0,5,2)+'</pCredSN>'\r\n\t\t\tcString += '<vCredICMSSN>'+ConvType(0,15,2)+'</vCredICMSSN>'\r\n\t\tEndif\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\t\r\n\tElseIf ( Len(aIcms) >0 .And. Len(aIcmsST)> 0 ).And. ( aICMSST[11] == \"2\" .And. aIcms[13] == \"2\" ) .And. aCST[01] $ \"10-90\"\r\n\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSPART</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\t\t\r\n\t\t//cString += '<pmvast>'+ConvType(aICMSST[08],6,2)+'</pmvast>'\r\n\t\tcString += '</cpl>'\t\t\t\t\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>' \r\n\t\tcString += '<modBC>'+ConvType(aICMS[03])+'</modBC>'\t\t\r\n\t\tcString += '<vBC>'+ConvType(aICMS[05],15,2)+'</vBC>'\r\n\t\t//cString += '<pRedBC>'+ConvType(aICMS[04],5,2)+'</pRedBC>'\t\t\r\n\t\tIf cVeramb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMS[06],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMS[06],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tcString += '<valor>'+ConvType(aICMS[07],15,2)+'</valor>'\r\n\t\tcString += '<modBCST>'+ConvType(aICMSST[03])+'</modBCST>'\t\t\r\n\t\t//cString += '<pRedBCST>'+ConvType(aICMSST[04],5,2)+'</pRedBCST>'\t\r\n\t\tcString += '<vBCST>'+ConvType(aICMSST[05],15,2)+'</vBCST>'\t\r\n\t\tIf cVeramb >= \"3.10\"\t\r\n\t\t\tcString += '<aliquotaST>'+ConvType(aICMSST[06],7,4)+'</aliquotaST>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquotaST>'+ConvType(aICMSST[06],5,2)+'</aliquotaST>'\r\n\t\tEndif\r\n\t\tcString += '<valorST>'+ConvType(aICMSST[07],15,2)+'</valorST>'\t\t\r\n\t\tIf cVeramb >= \"3.10\"\r\n\t\t\tcString += '<pBCOp>'+ConvType(aICMS[04],7,4)+'</pBCOp>'\r\n\t\tElse\r\n\t\t\tcString += '<pBCOp>'+ConvType(aICMS[04],5,2)+'</pBCOp>'\r\n\t\tEndIf\r\n\t\tcString += '<UFST>'+aDest[09]+'</UFST>'\t\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\t\r\n\tElse\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMS</codigo>'\r\n\t\tIf Len(aIcms)>0\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += '<orig>'+ConvType(aICMS[01])+'</orig>'\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\t\r\n\t\t\t// No caso de diferimento (CST 51) o cliente que deverá escolher a opção 90\r\n\t\t\t//   caso esteja utilizando a versão 2.00 da NF-e, enquanto não houver adequação.\r\n\t\t\t// o sistema não pode forçar o CST 90\r\n\t\t\tcString += '<CST>'+ConvType(aICMS[02])+'</CST>'\r\n\t\t\t\r\n\t   \t\tIf(aCST[1] $ '40,41,50') .Or. ((aCST[1] == '51') .And. lArt186)\r\n\t   \t\t\tcString += '<vBC>'+'0'+'</vBC>'     \r\n\t\t\t\tIf Len(aICMSZFM)>0 .And. aCST[1] $ '40|41|50'\r\n\t\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMSZFM[02])+'</motDesICMS>'\r\n\t\t\t\t\tcMotDesICMS:= ConvType(aICMSZFM[02])\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMS[11])+'</motDesICMS>' \r\n\t\t\t\t\tcMotDesICMS:= ConvType(aICMS[11])\r\n\t\t\t\tEndIf\t\t\r\n\t\t\tElse\r\n\t\t\t\tIf aICMS[04] == 100 .And. aICMS[02] == \"20\"\r\n\t\t\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\t\t\tElse\r\n\t\t    \t\tcString += '<vBC>'+ConvType(iIf(lIcmDevol,aICMS[05],0),15,2)+'</vBC>'\r\n\t\t    \tEndIf\r\n\t\r\n\t   \t\tEndIf\t\r\n\t\t\tcString += '<modBC>'+ConvType(aICMS[03])+'</modBC>'\r\n\t\t\t\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\" .And. !Empty(aAdi[14][03])\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\t\t\t\t\t\r\n\t\t\tElse\r\n    \t\t\tcString += '<pRedBC>'+ConvType(aICMS[04],8,4)+'</pRedBC>'\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf ( aCST[1] == '51' .And. lArt186 )\r\n\t\t\t\tcString += '<aliquota>0</aliquota>'\t\t\r\n\t\t\tElse\r\n\t\t\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\t\t\tcString += '<aliquota>'+ConvType(iIf(lIcmDevol,aICMS[06],0),7,4)+'</aliquota>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<aliquota>'+ConvType(iIf(lIcmDevol,aICMS[06],0),5,2)+'</aliquota>'\r\n\t\t\t\tEndIf\t\t\t\r\n\t\t\tEndIf\t\t\t\t\r\n\t\t\r\n\t\t\tIf aICMS[04] == 100 .And. aICMS[02] == \"20\"\r\n\t\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\t\tElseIf ( aCST[1] == '51' .And. lArt186 )\r\n\t\t\t\tIf !Empty(aICMS[12]) .and. !Empty(aICMS[07]) .and. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) $ \"RS\"\r\n\t\t\t\t\tcString += '<pDif>100.00</pDif>'\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .And. aICMS[03] == \"2\"\r\n\t\t\t\t\tcString += '<vICMSOp>0</vICMSOp>'\r\n\t\t\t\t\tcString += '<pDif>100.00</pDif>'\r\n\t\t\t\t\tcString += '<vICMSDif>0</vICMSDif>'\r\n\t\t\t\tEndIf\t\r\n\t\t\t\tcString += '<valor>0</valor>'\t\t\t\t\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t\tIf cVerAmb >= \"3.10\" .and. aCST[1] $ '51' .and. !Empty(aICMS[12]) .and. !lArt186\r\n\r\n\t\t\t\t\t// Foi retirado o tratamento feito para o diferimento = 3. Pois, apos atualizacao do fiscal, o valor do diferimento e gravado em um campo sem necessidade de fazer calculo\r\n\r\n\t\t\t\t\t/*If\taICMS[14] == \"3\"\t\r\n\t\t\t\t\t\tcString += NfeTag('<vICMSOp>' ,ConvType(iIf(lIcmDevol,aICMS[07],0)+aICMS[12],15,2))\r\n\t\t\t\t  \t\tcString += NfeTag('<pDif>' ,ConvType(aICMS[12]/( aICMS[12]+iIf(lIcmDevol,aICMS[07],0))*100,8,4))\r\n\t\t\t\t  \t\tcString += NfeTag('<vICMSDif>' ,ConvType(aICMS[12],15,2))\r\n\t\t\t\t  \t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,(aICMS[07]+aICMS[12])-aICMS[12],0),15,2)+'</valor>'\r\n\t\t\t\t\tElse*/\r\n\t\t\t\t\t\r\n\t\t\t\t\tcString += NfeTag('<vICMSOp>' ,ConvType(iIf(lIcmDevol,aICMS[07],0),15,2))\r\n\t\t\t\t\t//cString += NfeTag('<pDif>' ,ConvType(aICMS[12]/iIf(lIcmDevol,aICMS[07],0)*100,8,4))\r\n\t\t\t\t\tcString += NfeTag('<pDif>' ,ConvType(aICMS[19],8,4))\r\n\t\t\t\t\tcString += NfeTag('<vICMSDif>' ,ConvType(aICMS[12],15,2))\r\n\t\t\t\t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,aICMS[07]-aICMS[12],0),15,2)+'</valor>'\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tnVIcmDif += iIf(lIcmDevol,aICMS[07]-aICMS[12],0)\r\n\t\t\t\t\t/*Na versão 3.10, para CST=51, O Valor do ICMS(vICMS) deve ser a diferença do Valor do ICMS da Operação (vICMSOp) e o Valor do ICMS diferido (vICMSDif),\r\n\t\t\t\t\tpara não apresentar a rejeição 353-Valor do ICMS no CST=51 não corresponde a diferença do ICMS operação e ICMS diferido*/\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. aCST[1] $ '51' .and. Empty(aICMS[12]) .and. Empty(aICMS[07])\r\n\t\t\t\t\tcString += '<vICMSOp>0</vICMSOp>'\r\n\t\t\t\t\tcString += '<pDif>100.00</pDif>'\r\n\t\t\t\t\tcString += '<vICMSDif>0</vICMSDif>'\r\n\t\t\t\t\tcString += '<valor>0</valor>'\r\n\t\t\t\t\tnVIcmDif += 0\r\n\t\t\t\t//Regra para quando não tiver icms diferido com CST=51 (F4_icmsdif = 2 e F4_picmdif = 0) \r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. aCST[1] $ '51' .and. Empty(aICMS[12]) .and. !Empty(aICMS[07])\r\n\t\t\t\t\tcString += NfeTag('<vICMSOp>' ,ConvType(iIf(lIcmDevol,aICMS[07],0),15,2))\r\n\t\t\t\t\tcString += '<pDif>0</pDif>'\r\n\t\t\t\t\tcString += '<vICMSDif>0</vICMSDif>'\r\n\t\t\t\t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,aICMS[07]-aICMS[12],0),15,2)+'</valor>' \r\n\t\t\t\t\tnVIcmDif += 0\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '40') .and. alltrim(aICMS[11]) == \"8\" // F4_MOTICMS = 8=Venda Orgao Publico\r\n\t\t\t\t\tcString += '<valor>'+ConvType(aICMS[15],15,2)+'</valor>'\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '40') .and. (alltrim(aICMS[11]) == \"9\" .or. alltrim(aICMS[11]) == \"90\") // F4_MOTICMS = 9=Outros. (NT 2011/004)ou 90=Solicitado pelo Fisco.\r\n\t\t\t\t\tIf aICMS[15] > 0\r\n\t\t\t\t\t   cString += '<valor>'+ConvType(aICMS[15],15,2)+'</valor>'\r\n\t\t\t\t\tElse\t\t\t\t\r\n\t\t\t\t\t\tcString += '<valor>'+ConvType(aICMS[07],15,2)+'</valor>'\t\t\r\n\t\t\t\t   EndIf\r\n\t\t\t\tElse\t\t\t\t\r\n\t\t\t\t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,aICMS[07],0),15,2)+'</valor>'\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\tif !empty(cMotDesICMS)\r\n\t\t\t\t\tif  aICMS[15] >\t0 \r\n\t\t\t\t\t\tnDesonICM := ConvType(aICMS[15],15,2)\r\n\t\t\t\t\t\tnVicmsDeson += iIf(lIcmDevol,aICMS[15],0)\r\n\t\t\t\t\tElseiF Len(aICMSZFM)>0 .And. aCST[1] $ '40|41|50'\r\n\t\t\t\t\t\tnDesonICM := ConvType(aICMSZFM[3],15,2)\t\t\t\t\t\t\r\n\t\t\t\t\t\tnVicmsDeson += iIf(lIcmDevol,aICMSZFM[3],0)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tnDesonICM :=   ConvType(aICMS[07],15,2)\t\t\t\t\t\r\n\t\t\t\t\t\tnVicmsDeson += iIf(lIcmDevol,aICMS[07],0)\r\n\t\t\t\t\tendif\r\n\t\t\t\tendif\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '20,70,90') .and. !Empty(aICMS[11])\r\n\t\t\t\tcString += NfeTag('<motDesICMS>' ,ConvType(aICMS[11]))\r\n\t\t\t\tIf aICMS[04] == 100 .And. aICMS[02] == \"20\"\r\n\t\t\t\t\tcString += NfeTag('<vICMSDeson>' ,ConvType(0,15,2))\r\n\t\t\t\t\tnVicmsDeson += 0\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<vICMSDeson>'+ConvType(iIf(lIcmDevol,aICMS[15],0),15,2)+'</vICMSDeson>'\r\n\t\t\t\t\tnVicmsDeson\t+= IIf(lIcmDevol,aICMS[15],0)\r\n\r\n\t\t\t\t\tIf(aCST[1] $ '20') .And. !empty(aICMS[11])\r\n\t\t\t\t\t\tcMotDesICMS := ConvType(aICMS[11])\r\n\t\t\t\t\t\tnDesonICM := ConvType(aICMS[15],15,2)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\t\t\tElseIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '40') .and. alltrim(aICMS[11]) == \"8\" // F4_MOTICMS = 8=Venda Orgao Publico \r\n\t\t\t\tcString\t\t+= NfeTag('<vICMSDeson>',ConvType(aICMS[15],15,2))\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf (aCST[1] $ '10' .and. (IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\") .and. !Empty(aICMS[12]));\r\n\t\t\t\t.Or. (aICMS[12] > 0 .And. aDest[9] == 'RS' .And. SM0->M0_ESTENT == 'RS' .And. aCST[1] $ '51' .And. aICMS[19] > 12)\r\n\t\t\t\tnIcmsDif\t+= aICMS[12]\r\n\t\t\t\tnPIcmsDif\t:= aICMS[19]\r\n\t\t\tEndIf\r\n\r\n\t\t\tcString += '<qtrib>'+ConvType(aICMS[09],16,4)+'</qtrib>'\r\n\t\t\tcString += '<vltrib>'+ConvType(aICMS[10],15,4)+'</vltrib>'\t\r\n\t\t\t//Criação de campos relativos ao FCP (Fundo de Combate à Pobreza) para operações internas ou interestaduais com ST.\r\n\t\t\tIF cVeramb >= \"4.00\" .and. aCST[1] $'00,10,20,41,51,70,90' \r\n\t\t\t   IF  aCST[1] <> '00'\r\n\t\t\t\t\tcString += '<vBCFCP>'+ConvType(aICMS[16],15,2)+'</vBCFCP>'\r\n\t\t\t\tEndIf\r\n\t\t\t\tcString += '<pFCP>'+ConvType(aICMS[17],5,2)+'</pFCP>'\r\n\t\t\t\tcString += '<vFCP>'+ConvType(aICMS[18],15,2)+'</vFCP>'\t\r\n\t\t\tEndIf\t\r\n\t\t\tcString += '</Tributo>'\r\n\t\tElse\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>'\t\r\n\t\t\tcString += '<modBC>'+ConvType(3)+'</modBC>'\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\"\r\n\t\t\t\tIf !Empty(aAdi[14][03])\r\n\t\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\r\n\t\t\t    Else\r\n\t\t\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\t\t\tEndIf\r\n\t\t\tElseif aProd[23]==\"20\" .And. aProd[22]>0\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aProd[22],7,4)+'</pRedBC>'\r\n\t\t\tElseif allTrim(aCST[01]) $ \"51,70,90\"\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aProd[22],7,4)+'</pRedBC>'\r\n\t\t\tEndif\t\r\n\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\t\t\r\n\t\t\tIf Len(aICMSZFM)>0 .And. aCST[1] $ '40|41|50'\r\n\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMSZFM[02])+'</motDesICMS>'  \t\t\t\r\n\t\t\t\tnValDeson := aICMSZFM[01]-aProd[31]-aProd[32]\r\n\t\t\t\tnVicmsDeson += nValDeson\r\n\t\t\t\tcString += '<valor>'+ConvType(nValDeson,15,4)+'</valor>'\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\t\tEndIf\t\r\n\r\n\t\t\tcString += '<qtrib>'+ConvType(0,16,4)+'</qtrib>'\r\n\t\t\tcString += '<vltrib>'+ConvType(0,15,4)+'</vltrib>'\r\n\t\t\tcString += '</Tributo>'\r\n\t\tEndIf\r\n\t\tcString += '</imposto>'\r\n\tEndif\r\n\r\n\tIf Len(aComb) > 0 .And. cVeramb >= \"4.00\" .and. aCST[1] $ \"60\" .And. aComb[01] $ NfeProdANP()\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSST'+ aCST[1] + '</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\r\n\t\tcString += '</cpl>'\t\t\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>'      \r\n\t\t\r\n\t\tIf Empty(cUltAqui)\r\n\t\t\tSPEDRastro2(aProd[20],aProd[19],aProd[02],@nBaseIcm,@nValICM,,,,,,,,,,,,,,,@nBfcpant,@nAfcpant,@nVfcpant)             \r\n\t\tEndIf\r\n\t\t\r\n\t\tif lRetEfet\r\n\r\n\t\t\tIf aComb[19] > 0\t\r\n\t\t\t\tcString += '<vBCSTRet>'+ConvType(aComb[19],15,2)+'</vBCSTRet>' \r\n\t\t\t\tcString += '<vICMSSTRet>'+ConvType(aComb[20],15,2)+'</vICMSSTRet>'\r\n\t\t\t\tnAlqICM := aComb[23]\r\n\t\t\tElseIf nBaseIcm > 0\r\n\t\t\t\tcString += '<vBCSTRet>'+ConvType(nBaseIcm,15,2)+'</vBCSTRet>' \r\n\t\t\t\tcString += '<vICMSSTRet>'+ConvType(nValICM,15,2)+'</vICMSSTRet>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<vBCSTRet>'+ConvType(0,15,2)+'</vBCSTRet>'\r\n\t\t\t\tcString += '<vICMSSTRet>'+ConvType(0,15,2)+'</vICMSSTRet>'\r\n\t\t\tEndif\t\t\r\n\t\t\r\n\t\t\tIf lTagProduc \r\n\t\t\t\t//cString += '<pST>'+ConvType(aICMS[6]+ aICMS[17],5,2)+'</pST>'\r\n\t\t\t\tcString += '<pST>'+ConvType((nAlqICM),5,2)+'</pST>'\r\n\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\tEndif\r\n\r\n\t\t\tcString += '<vBCFCPSTRet>'+ConvType(nBfcpant,15,2)+'</vBCFCPSTRet>'\r\n\t\t\tcString += '<pFCPSTRet>'+ConvType(nAfcpant,5,2)+'</pFCPSTRet>'\r\n\t\t\tcString += '<vFCPSTRet>'+ConvType(nVfcpant,15,2)+'</vFCPSTRet>'\r\n\t\tendif\t\r\n\t\t\r\n\t\t//Tratamento implementado para atender o DECRETO Nº 54.308, DE 6 DE NOVEMBRO DE 2018. (publicado no DOE n.º 212, de 7 de novembro de 2018)\t\r\n\t\t\t\r\n\t\tIf cIndFinal == \"1\"\t.and. Len(aIcms)>0\t\t\t\t\t\t \r\n\t\t\tcString += '<pRedBCEfet>'+ConvType(aICMS[4],8,4)+'</pRedBCEfet>'\r\n\t\t\tcString += '<vBCEfet>'+ConvType( aICMS[5] ,16,2)+'</vBCEfet>'\r\n\t\t\tcString += '<pICMSEfet>'+ConvType(aICMS[6],8,4)+'</pICMSEfet>'\r\n\t\t\tcString += '<vICMSEfet>'+ConvType(aICMS[7],16,2)+'</vICMSEfet>'\r\n\t\tEndif\r\n\t\t\r\n\t\tcString += '<vBCSTDest>'+ConvType(aComb[21],15,2)+'</vBCSTDest>' \t   \t\r\n\t\tcString += '<vICMSSTDest>'+ConvType(aComb[22],15,2)+'</vICMSSTDest>'\r\n\t\t\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\tEndIf\t\r\n\t\r\n\tIf Len(aIcmsST)>0\t\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSST</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],8,4)+'</pmvast>'\r\n\t\tElse\r\n\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],6,2)+'</pmvast>'\r\n\t\tEndIf\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aICMSST[02])+'</CST>'\t\r\n\t\tcString += '<modBC>'+ConvType(aICMSST[03])+'</modBC>'\r\n\t\tcString += '<pRedBC>'+ConvType(aICMSST[04],7,4)+'</pRedBC>'\r\n\t\tcString += '<vBC>'+ConvType(aICMSST[05],15,2)+'</vBC>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMSST[06],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMSST[06],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tIf Len(aICMSZFM)>0 .And. aCST[1] $ '30-40'\r\n\t\t\tif !empty( aICMSZFM[02] )\r\n\t\t\t\tcString += NfeTag('<motDesICMS>' ,ConvType(aICMSZFM[02]))\r\n\t\t\t\tcString\t+= \"<vICMSDeson>\" + ConvType(aICMSZFM[3],15,2) + \"</vICMSDeson>\"\r\n\t\t\tendif\t\r\n\t\t\tnVicmsDeson\t+= IIf(lIcmDevol,aICMSZFM[3],0)\r\n\t\tElse\r\n\t\t\tif !empty( aICMSST[17] )\r\n\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMSST[17])+'</motDesICMS>'\r\n\t\t\t\tcString\t+= \"<vICMSDeson>\" + ConvType(aICMSST[12],15,2) + \"</vICMSDeson>\"\r\n\t\t\tendif\r\n\t\t\tcMotDesICMS:= ConvType(aICMSST[17])\r\n\t\tEndIf\r\n\t\tcString += '<valor>'+ConvType(aICMSST[07],15,2)+'</valor>'\r\n\t\tcString += '<qtrib>'+ConvType(aICMSST[09],16,4)+'</qtrib>'\r\n\t\tcString += '<vltrib>'+ConvType(aICMSST[10],15,4)+'</vltrib>'\r\n\t\t\r\n\t\tIf cVeramb >= \"4.00\" .and. aCST[1] =='60' \r\n\t\t\tif lRetEfet\r\n\t\t\t\tcString += '<pST>'+ConvType((aICMSST[06]+aICMSST[14]),5,2)+'</pST>'\r\n\t\t\t\tIf lTagProduc \r\n\t\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\t\tEndif\r\n\t\t\tendif\t\r\n\t\tEndIf\r\n\t\r\n\t\t//Criação de campos relativos ao FCP (Fundo de Combate à Pobreza) para operações internas ou interestaduais com ST.\r\n\t\tIF cVeramb >= \"4.00\" .and. aCST[1] $'10,30,70,90' //.and. !Empty(aICMS[13])\r\n\t\t\t\tcString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\tEndIf\t\r\n\t\t\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\t\t\r\n\tELse\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSST</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<pmvast>0</pmvast>'\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>'          \r\n\t\tIf (aCST[01] = \"60\" .or. cCsosn$ \"500\")\t\t\r\n\t\t\t//Se o parâmetro  MV_ULTAQUI que trata a última aquisição não estiver preenchido usa o modelo antigo de rastro.\r\n\t\t\tIf Empty(cUltAqui) \r\n\t\t\t\tSPEDRastro2(aProd[20],aProd[19],aProd[02],@nBaseIcm,@nValICM,,,lCalcMed,@nAlqICM,,,,,,,,,,,@nBfcpant,@nAfcpant,@nVfcpant)\r\n\t\t\t\t\r\n\t\t\t\tIf nBaseIcm > 0 .and. nValICM>0\r\n\t\t\t\t\tnBaseIcm := aProd[09]*nBaseIcm\r\n\t\t\t\t\tnValICM  := aProd[09]*nValICM\r\n\t\t\t    EndIf\r\n\t\t\t     //Multiplica o valor facp anterior pela quantidade de item.\r\n\t\t\t    If\tnBfcpant > 0 .and. nVfcpant>0\r\n\t\t\t     \tnBfcpant  := aProd[09]*nBfcpant\r\n\t\t\t     \tnVfcpant  := aProd[09]*nVfcpant\r\n\t\t\t    EndIf\r\n\t\t\tendif\r\n\t\t\t\t\r\n\t\t\tIf nBaseIcm > 0 .and. nValICM > 0\t.and. nAlqICM > 0\r\n\t\t   \t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\tEndIf\r\n\t\t\t    If cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SP\"\r\n\t\t\t\t\t// cMensFis += \"Imposto Recolhido por Substituição - Artigo 274 do RICMS (Lei 6.374/89, art.67,Paragrafo 1o., e Ajuste SINIEF-4/93',cláusa terceira, na redação do Ajuste SINIEF-1/94) 'Cod.Produto:  \" +ConvType(aProd[02])+\" ' Valor da Base de ST: R$ \" +str(nBaseIcm,15,2)+\" Valor de ICMS ST: R$ \"+str(nValICM,15,2)+\" \"\r\n\t\t\t\t\tif Empty(At(\"Artigo 274 do RICMS\", cMensFis))\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Artigo 274 do RICMS (Lei 6.374/89, art.67,Paragrafo 1o., e Ajuste SINIEF-4/93',cláusa terceira, na redação do Ajuste SINIEF-1/94) &|\"+ConvType(aProd[02])+\"|\"+AllTrim(str(nValICM,15,2))+\"|&\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcMensFis := AllTrim(cMensFis) + \"|\"+ConvType(aProd[02])+\"|\"+AllTrim(str(nValICM,15,2))+\"|&\"\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\"  \r\n\t\t\t\t\tif SF4->F4_CODIGO > \"500\"  /* TES de Saída */  \r\n\t\t\t\t\t\t//Decreto 6080/2012 com o Regulamento do ICMS está revogado\r\n\t\t\t\t\t\tcMensFis += \" Imposto Recolhido por Substituição - ART. 5º, II , ANEXO IX ,DO RICMS/PR DECRETO 7871/2017 - DOE PR de 02.10.2017, onde o 'Cod.Produto:  \" +ConvType(aProd[02])+\" '  Valor da Base de ST: R$ \" +Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\telse //entrada\r\n\t\t\t\t\t\tcMensFis += \" Imposto Recolhido por Substituição - ART. 5º, I  , ANEXO IX ,DO RICMS/PR DECRETO 7871/2017 - DOE PR de 02.10.2017, onde o 'Cod.Produto:  \" +ConvType(aProd[02])+\" '  Valor da Base de ST: R$ \" +Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\tendif\r\n\t\t\t\t\t/* Conforme consulta realizado no chamado TIBIKO\r\n\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Artigo 471 do RICMS (Parágrafo 1o, alínea B, inciso II, onde o 'Cod.Produto:  \" +ConvType(aProd[02])+\" ' Valor da Base de ST: R$ \" +str(nBaseIcm,15,2)+\" Valor de ICMS ST: R$ \"+str(nValICM,15,2)+\" \"\r\n\t\t\t\t\t*/\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SC\"  \r\n\t\t\t\t\tlPesFisica := IIF(SA1->A1_PESSOA==\"F\",.T.,.F.)\r\n\t\t\t\t\tlNContrICM := IIf(Empty(SA1->A1_INSCR) .Or. \"ISENT\"$SA1->A1_INSCR .Or. \"RG\"$SA1->A1_INSCR .Or. ( SA1->(FieldPos(\"A1_CONTRIB\"))>0 .And. SA1->A1_CONTRIB == \"2\"),.T.,.F.)\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !lPesFisica .And. !lNContrICM \r\n\t\t\t\t\t\tcMensFis += \"Imposto Retido por Substituição Tributária - RICMS-SC/01 - Anexo 3. 'Cod.Produto: \" +ConvType(aProd[02])+\" '  Valor da Base de ST: R$ \" +str(nBaseIcm,15,2)+\"  Valor de ICMS ST: R$ \"+str(nValICM,15,2)+\" \"\r\n\t\t\t\t\tEndIf\t \t\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"AM\"\r\n\t\t\t\t \tlNContrICM := IIf(Empty(SA1->A1_INSCR) .Or. \"ISENT\"$SA1->A1_INSCR .Or. \"RG\"$SA1->A1_INSCR .Or. ( SA1->(FieldPos(\"A1_CONTRIB\"))>0 .And. SA1->A1_CONTRIB == \"2\"),.T.,.F.)\r\n\t\t\t\t \t\r\n\t\t\t\t \tIf (lNContrICM .And. SA1->A1_EST <> \"AM\") .Or. SA1->A1_EST == \"AM\"  //Conforme consulta (TGVUIP).\r\n\t\t\t\t \t\tcMensFis += \"Mercadoria já tributada nas demais fases de comercialização - Convênio ou Protocolo ICMS nº \"+Alltrim(aProd[28])+ \". Cod.Produto: \" +ConvType(aProd[02])+\".\"\r\n\t\t\t\t \tEndIf\r\n\t\t\t\t\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"RS\"\t\t\t \r\n\t\t\t\t \tif !Empty(aProd[28])\t\t\t\t \t\r\n\t\t\t\t \t\tcMensFis += \"Imposto recolhido por ST nos termos do (Convênio ou Protocolo ICMS nº \"+ Alltrim(aProd[28]) +\") RICMS-RS. Valor da Base de ICMS ST R$\"+ cValToChar(nBaseIcm) +\" e valor do ICMS ST R$ \"+ cValToChar(nValICM) +\". Cod.Produto: \" +ConvType(aProd[02])+\".\" \r\n\t\t\t\t \telse\r\n\t\t\t\t \t\tcMensFis += \"Imposto recolhido por ST nos termos do RICMS-RS. Valor da Base de ICMS ST R$\"+ cValToChar(nBaseIcm) +\" e Valor do ICMS ST R$\"+ cValToChar(nValICM) +\". Cod.Produto: \" +ConvType(aProd[02])+\".\"\r\n\t\t\t\t \tendIf\t\t\t\t\t \t\r\n\t\t\t\tElseIf cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"ES\" .And. Len(aICMS) > 0 .And. ( nBaseIcm+nValICM > 0 )\r\n\t\t\t\t\t\r\n\t\t\t\t\tnValIcmDif := ( (nBaseIcm *  17 )/ 100 ) -  aIcms[7]\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição RICMS. Cod.Produto:  \" +ConvType(aProd[02])+\" Base de cálculo da retenção - R$ \" + Alltrim(str(nBaseIcm,15,2))+\". \" \r\n\t\t\t\t\tcMensFis += \"ICMS da operação própria do contribuinte substituto - R$ \"+Alltrim(str(aIcms[7],15,2))+\". \"\r\n\t\t\t\t\tcMensFis += \"ICMS retido pelo contribuinte substituto - R$ \" +Alltrim(str(nValIcmDif,15,2))+\". \"\r\n\t\t\t\tElseIf cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\" .And. Len(aICMS) > 0 .And. ( nBaseIcm+nValICM > 0 )  // Conforme Chamado TIABCS\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Empty(cUltAqui)\r\n\t\t\t\t\t\tnVICPRST := ( (nBaseIcm * 18 )/ 100 ) - aIcms[7]\r\n\t\t\t\t\tEndif\r\n\t\t\t\t\t\r\n\t\t\t\t\taTotICMSST[1] += nBaseIcm\r\n\t\t\t\t\taTotICMSST[2] += nValICM\r\n\t\t\t\t\taTotICMSST[3] += nVICPRST\r\n\r\n\t\t\t\t\tIf nTotProd == nItProd\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - ICMS retido pelo cliente S.T. DECRETO 43708 19/12/2009.\"\r\n\t\t\t\t\t\tcMensFis += \" Valor da Base de ST: R$ \"+Alltrim(str(aTotICMSST[1],15,2))+\".\"\r\n\t\t\t\t\t\tcMensFis += \" Valor de ICMS ST: R$ \"+Alltrim(str(aTotICMSST[2],15,2))+\".\"\r\n\t\t\t\t\t\tcMensFis += \" Valor de ICMS: R$\"+Alltrim(str(aTotICMSST[3],15,2))+\".\"\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tElseIf IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SP\" \r\n\t\t\t\t\tIf cIndFinal == \"1\"\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Contempla o artigo 313-Z19 do RICMS-SP.\"\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t//Artigo somente para o estado de SP - DSERTSS1-6532\r\n\t\t\t\t\t\t//http://tdn.totvs.com.br/pages/releaseview.action?pageId=267795989\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Contempla os artigos 273, 313 do RICMS. Valor da Base de ST: R$ \"+Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tElseIf IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"RJ\"\r\n\t\t\t\t\tif aComb[01] $ NfeProdANP()\r\n\t\t\t\t\t\t//http://jiraproducao.totvs.com.br/browse/DSERTSS1-11434\r\n\t\t\t\t\t\tcMensFis += \"ICMS a ser repassado nos termos do Capítulo V do Convênio ICMS 110/07. Valor da Base de ST: R$ \"+Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\telseif cArt274 == \"1\"\r\n\t\t\t\t\t\tcMensFis += \"ICMS RECOLHIDO ANTECIPADO POR SUBS. TRIBUTARIA CONF. INC. II ART 27 DO LIVRO II, E ITEM 23 DO ANEXO I DO LIVRO II DO RICMS\"\t\r\n\t\t\t\t\tendif\r\n\t\t\t\tEndIf\r\n\t        \r\n\t        \r\n\t        EndIf\r\n\t        \r\n\t   \t\tcString += '<modBC>0</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\tElse\r\n\t\t\tcString += '<modBC>0</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\t\r\n\t\tEndif\r\n\t\tIf nBaseIcm > 0\r\n\t\t\tcString += '<vBC>'+ConvType(nBaseIcm,15,2)+'</vBC>' \r\n\t\tElse\r\n\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\tEndif\r\n\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\tIf nValICM > 0\r\n\t\t\tcString += '<valor>'+ConvType(nValICM,15,2)+'</valor>'\r\n\t\tElse\r\n\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\tEndif   \r\n\t\r\n\t\tcString += '<qtrib>'+ConvType(0,16,4)+'</qtrib>'\r\n\t\tcString += '<vltrib>'+ConvType(0,15,4)+'</vltrib>'\r\n\t\t\r\n\t\tIf cVeramb >= \"4.00\" .and. aCST[1] =='60'\r\n\t\t\t\r\n\t\t\tif lRetEfet\r\n\t\t\t\tcString += '<pST>'+ConvType((nAlqICM),5,2)+'</pST>'\r\n\t\t\t\t//cString += '<pST>'+ConvType(aICMS[6]+ aICMS[17],5,2)+'</pST>'\r\n\t\t\t\tIf lTagProduc \r\n\t\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\t\tEndif\r\n\t\t\t\t//Tratamento implementado para atender o DECRETO Nº 54.308, DE 6 DE NOVEMBRO DE 2018. (publicado no DOE n.º 212, de 7 de novembro de 2018)\t\r\n\t\t\t\tcString += '<vBCFCPSTRet>'+ConvType(nBfcpant,15,2)+'</vBCFCPSTRet>'\r\n\t\t\t\tcString += '<pFCPSTRet>'+ConvType(nAfcpant,5,2)+'</pFCPSTRet>'\r\n\t\t\t\tcString += '<vFCPSTRet>'+ConvType(nVfcpant,15,2)+'</vFCPSTRet>'\r\n\t\t\tendif\t\r\n\t\t\t\r\n\t\t\tIf cIndFinal == \"1\"\t.and. Len(aIcms)>0\t\t\t\t \r\n\t\t\t\tcString += '<pRedBCEfet>'+ConvType(aICMS[4],8,4)+'</pRedBCEfet>'\r\n\t\t\t\tcString += '<vBCEfet>'+ConvType( aICMS[5] ,16,2)+'</vBCEfet>'\r\n\t\t\t\tcString += '<pICMSEfet>'+ConvType(aICMS[6],8,4)+'</pICMSEfet>'\r\n\t\t\t\tcString += '<vICMSEfet>'+ConvType(aICMS[7],16,2)+'</vICMSEfet>'\r\n\t\t\tEndif\r\n\t\tEndif\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\t\t\r\n\t\t\t\r\n\tEndIf\r\n\t\r\n\t//A sefaz nao permite referenciar nota de difal antes de 2016 da a Rejeiçao 699  \r\n\tIf len(aItemVinc) > 0 \r\n\t\tlDateRefNf := FsDateConv(aItemVinc[01],\"YYYY\") >= \"2016\" \r\n\tElse \r\n\t\tlDateRefNf := .T.\t\t  \t\t\t\r\n\tEndif\r\n\t\r\n\tIf (cIdDest == \"2\" .and. cIndFinal == \"1\" .and. cIndIEDest == \"9\") .and. (Len(aISSQN)== 0) .and. ;\r\n\t   (cAmbiente == \"2\" .or. (cAmbiente == \"1\" .and. FsDateConv(aNota[03],\"YYYY\") >= \"2016\" .and. lDateRefNf)) .and. ;\r\n\t   (iif(Len(aComb) > 0 .And. !Empty(aComb[01]),aComb[01] $ NfeCodANP(),.T.))\r\n\t\t\r\n\t\tIf Len(aICMUFDest) > 0 .And. !(aNota[04] == \"0\" .and. aNota[5] == \"N\" .And. aICMUFDest[05] == 0)\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>ICMSUFDest</codigo>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<VBC>'+ConvType(aICMUFDest[01],15,2)+'</VBC>' //vBCUFDest\r\n\t\t\tIF cVeramb >= \"4.00\"\r\n\t\t\t\tcString += '<vBCFCPUFDest>'+ConvType(aICMUFDest[01],15,2)+'</vBCFCPUFDest>' //vBCFCPUFDest\r\n\t\t\tEndif\r\n\t\t\tcString += '<pFCPUF>'+ConvType(aICMUFDest[02],7,4)+'</pFCPUF>' //pFCPUFDest\r\n\t\t\tcString += '<Aliquota>'+ConvType(aICMUFDest[03],7,4)+'</Aliquota>' //pICMSUFDest\r\n\t\t\tcString += '<AliquotaInter>'+ConvType(aICMUFDest[04],6,2)+'</AliquotaInter>' //pICMSInter\r\n\t\t\tcString += '<pICMSInter>'+ConvType(aICMUFDest[05],8,4)+'</pICMSInter>'//pICMSInterPart\r\n\t\t\tcString += '<ValorFCP>'+ConvType(aICMUFDest[06],15,2)+'</ValorFCP>' //vFCPUFDest\r\n\t\t\tcString += '<ValorICMSDes>'+ConvType(aICMUFDest[07],15,2)+'</ValorICMSDes>' //vICMSUFDest\r\n\t\t\tcString += '<ValorICMSRem>'+ConvType(aICMUFDest[08],15,2)+'</ValorICMSRem>' //vICMSUFRemet\r\n\t\t\tcString += '</Tributo>'\r\n\t\t\tcString += '</imposto>'\r\n\r\n\t\t\tnvBCUFDest    += aICMUFDest[01]\r\n\t\t\tnpFCPUFDest   := aICMUFDest[02]\r\n\t\t\tnpICMSUFDest  := aICMUFDest[03]\t\t\r\n\t\t\tnpICMSIntP    := aICMUFDest[05]\r\n\t\t\tnvFCPUFDest   += aICMUFDest[06]\r\n\t\t\tnvICMSUFDest  += aICMUFDest[07]\r\n\t\t\tnvICMSUFRemet += aICMUFDest[08]\r\n\r\n\t\t\t// <AliquotaInter> padrão 4,7 ou 12. Em caso de pedido com produtos com aliquotas diferentes, as alíquotas serão separadas em vírgula para exibição. (Ex.: 4.00%, 7.00%)\r\n\t\t\tIf (aICMUFDest[04] == 4 .or. aICMUFDest[04] == 7 .or. aICMUFDest[04] == 12) .and. !ConvType(aICMUFDest[04])$cMensDifal\r\n\t\t\t\tIif (empty(cMensDifal),cMensDifal += ConvType(aICMUFDest[04],6,2)+'%',cMensDifal += ', '+ ConvType(aICMUFDest[04],6,2)+'%')\t\r\n\t\t\tEndif\r\n\t\t\t\r\n\t\tElseif Len(aICMUFDest) == 0\r\n\t\t\t\r\n\t\t\t/*Para os casos em que não há calculo de Difal na CD2( ICMS Isento), o grupo ICMSUFDEST deve ser gerado com valores zerados, para\r\n\t\t\tnão apresentar a rejeição 694: Não informado o grupo de ICMS para a UF de destino [nItem:999].\r\n\t\t\tApenas as tags pICMSUInter e pICMSInterPart devem ser geradas com valores para não apresentar erro de schema\r\n\t\t\tTAG pICMSInter - SD2_PICM\r\n\t\t\tTAG pICMSInterPart - MV_PPDIFAL\r\n\t\t\t*/\r\n\t\t\tIf (valType(aPPDifal)== \"A\" .and. Len(aPPDifal)>0 .and. Year(aNota[03]) >= aPPDifal[1][1])\r\n\t\t\t\r\n\t\t\t\tnUltimo := Len(aPPDifal)\r\n\t\t\r\n\t\t\t\tIF !Empty(aItemVinc) .and. (nPos := aScan(aPPDifal,{|x| x[1]== Year(aItemVinc[01])})) > 0 // Verifica o ano da nota vinculada para pegar a aliquota do parâmetro\r\n\t\t\t\t\taPICMSInter:= aPPDifal[nPos][2]\r\n\t\t\t\tElseIf (nPos := aScan(aPPDifal,{|x| x[1]== Year(aNota[03])})) > 0\r\n\t\t\t\t\taPICMSInter:= aPPDifal[nPos][2]\t\t\t\t\r\n\t\t\t\tElseIf Year(aNota[03] ) > aPPDifal[nUltimo][1]\t\t\r\n\t\t\t\t\taPICMSInter:= aPPDifal[nUltimo][2]\t\t\t\t\r\n\t\t\t\tEndif\r\n\t\t\t\r\n\t\t\t\tIf Alltrim(Str(aProd[33])) == \"4\" .Or. Alltrim(Str(aProd[33])) == \"7\" .Or. Alltrim(Str(aProd[33])) == \"12\"\r\n\t\t\t\t\tcString += '<imposto>'\r\n\t\t\t\t\tcString += '<codigo>ICMSUFDest</codigo>'\r\n\t\t\t\t\tcString += '<Tributo>'\r\n\t\t\t\t\tcString += '<VBC>'+ConvType(0,15,2)+'</VBC>' //vBCUFDest\r\n\t\t\t\t\tcString += '<vBCFCPUFDest>'+ConvType(0,15,2)+'</vBCFCPUFDest>' //vBCFCPUFDest\r\n\t\t\t\t\tcString += '<pFCPUF>'+ConvType(0,7,4)+'</pFCPUF>' //pFCPUFDest\r\n\t\t\t\t\tcString += '<Aliquota>'+ConvType(0,7,4)+'</Aliquota>' //pICMSUFDest\r\n\t\t\t\t\tcString += '<AliquotaInter>'+ConvType(aProd[33],6,2)+'</AliquotaInter>' //pICMSInter\r\n\t\t\t\t\tcString += '<pICMSInter>'+ConvType(aPICMSInter,8,4)+'</pICMSInter>'//pICMSInterPart\r\n\t\t\t\t\tcString += '<ValorFCP>'+ConvType(0,15,2)+'</ValorFCP>' //vFCPUFDest\r\n\t\t\t\t\tcString += '<ValorICMSDes>'+ConvType(0,15,2)+'</ValorICMSDes>' //vICMSUFDest\r\n\t\t\t\t\tcString += '<ValorICMSRem>'+ConvType(0,15,2)+'</ValorICMSRem>' //vICMSUFRemet\r\n\t\t\t\t\tcString += '</Tributo>'\r\n\t\t\t\t\tcString += '</imposto>'\r\n\t\t\t\t\t\r\n\t\t\t\t\tnvBCUFDest    += 0 \r\n\t\t\t\t\tnpFCPUFDest   += 0\r\n\t\t\t\t\tnpICMSUFDest  += 0\r\n\t\t\t\t\tnpICMSInter   += 0\r\n\t\t\t\t\tnpICMSIntP    += 0\r\n\t\t\t\t\tnvFCPUFDest\t+= 0\r\n\t\t\t\t\tnvICMSUFDest  += 0\r\n\t\t\t\t\tnvICMSUFRemet += 0\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\t\r\n\t\tEndIf\r\n\tEndIf\t\t\r\n\t\t\t\t\t\t\t\r\n\tIf Len(aIPI)>0 \r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>IPI</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += NfeTag('<clEnq>',ConvType(AIPI[01]))\r\n\t\tcString += NfeTag('<cSelo>',ConvType(AIPI[02]))\r\n\t\tcString += NfeTag('<qSelo>',ConvType(AIPI[03]))\r\n\t\tcString += NfeTag('<cEnq>' ,ConvType(AIPI[04]))\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(AIPI[05])+'</CST>'\r\n\t\tcString += '<modBC>'+ConvType(AIPI[11])+'</modBC>'\r\n\t\tcString += '<pRedBC>'+ConvType(AIPI[12],7,4)+'</pRedBC>'\r\n\t\tcString += '<vBC>'  +ConvType(AIPI[06],15,2)+'</vBC>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tcString += '<vlTrib>'+ConvType(AIPI[08],15,4)+'</vlTrib>'\r\n\t\tcString += '<qTrib>'+ConvType(AIPI[07],16,4)+'</qTrib>'\r\n\t\tcString += '<valor>'+ConvType(AIPI[10],15,2)+'</valor>'\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\tElseIf Len(aCSTIPI) > 0  .And. !Empty(cIpiCst)\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>IPI</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += NfeTag('<cEnq>' ,aprod[40])\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(cIpiCst)+'</CST>'\r\n\t\tcString += '<modBC>'+ConvType(3)+'</modBC>'\r\n\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\tcString += '<vBC>'  +ConvType(0,15,2)+'</vBC>'\r\n\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\t\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\tEndIf\r\nElse\r\n\tIf Len(aISSQN)>0 .and. !Empty(aISSQN[01])\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ISS</codigo>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<vBC>'+ConvType(aISSQN[01],15,2)+'</vBC>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(aISSQN[02],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(aISSQN[02],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tcString += '<Valor>'+ConvType(aISSQN[03],15,4)+'</Valor>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += NfeTag('<deducao>',ConvType(aISSQN[07],15,2))//SF3->F3_ISSSUB + SF3->F3_ISSMAT\r\n\t\t\tcString += NfeTag('<outro>',ConvType(0,15,2))//atualmente nao existe valor de Outras retencoes \r\n\t\t\tcString += NfeTag('<descIncond>',ConvType(0,15,2))//atualmente nao existe valor de Desconto Incondicionado\r\n\t\t\tcString += NfeTag('<descCond>',ConvType(0,15,2))//atualmente nao existe valor de Desconto condicionado\r\n\t\t\tcString += NfeTag('<Issret>',ConvType(aISSQN[09],15,2))\t\t\t\t\r\n\t\tEndIf\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<cmunfg>'+ConvType(SM0->M0_CODMUN)+'</cmunfg>'\t\r\n\t\tcString += '<clistserv>'+aISSQN[05]+'</clistserv>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<Indiss>'+aISSQN[08]+'</Indiss>'\r\n\t\t\tcString += NfeTag('<codserv>',ConvType(aProd[34],20))//B1_TRIBMUN\r\n\t\t\tcString += NfeTag('<cmunInc>',ConvType(cMunPres,7))\r\n\t\t\t//cPais Código do País onde o serviço foi prestado\r\n\t\t\t//Tabela do BACEN. Informar somente se o município da prestação do serviço for \"9999999\".\r\n\t\t\tIF cMunPres == \"9999999\"\r\n\t\t\t\tcString += NfeTag('<codpais>',aDest[11])\r\n\t\t\tEndIf\t\r\n\t\t\tcString += NfeTag('<processo>',ConvType(cMVNumProc,30))\r\n\t\t\tcString += '<incentivo>'+ConvType(cMVINCEFIS,1)+'</incentivo>'\r\n\t\tElse\r\n\t\t\tcString += '<cSitTrib>'+ConvType(aISSQN[06])+'</cSitTrib>'\r\n\t\tEndIf\t\t \t\r\n\t\tcString += '</cpl>'\t\t\r\n\t\tcString += '</imposto>'\r\n\tEndIf\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tIf Len(aIPI)>0 \r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>IPI</codigo>'\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += NfeTag('<clEnq>',ConvType(AIPI[01]))\r\n\t\t\tcString += NfeTag('<cSelo>',ConvType(AIPI[02]))\r\n\t\t\tcString += NfeTag('<qSelo>',ConvType(AIPI[03]))\r\n\t\t\tcString += NfeTag('<cEnq>' ,ConvType(AIPI[04]))\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<CST>'+ConvType(AIPI[05])+'</CST>'\r\n\t\t\tcString += '<modBC>'+ConvType(AIPI[11])+'</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(AIPI[12],7,4)+'</pRedBC>'\r\n\t\t\tcString += '<vBC>'  +ConvType(AIPI[06],15,2)+'</vBC>'\r\n\t\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],7,4)+'</aliquota>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],5,2)+'</aliquota>'\r\n\t\t\tEndIf\r\n\t\t\tcString += '<vlTrib>'+ConvType(AIPI[08],15,4)+'</vlTrib>'\r\n\t\t\tcString += '<qTrib>'+ConvType(AIPI[07],16,4)+'</qTrib>'\r\n\t\t\tcString += '<valor>'+ConvType(AIPI[10],15,2)+'</valor>'\r\n\t\t\tcString += '</Tributo>'\r\n\t\t\tcString += '</imposto>'\r\n\t\tElseIf Len(aCSTIPI) > 0  .And. !Empty(cIpiCst)\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>IPI</codigo>'\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += NfeTag('<cEnq>' ,aprod[40])\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<CST>'+ConvType(cIpiCst)+'</CST>'\r\n\t\t\tcString += '<modBC>'+ConvType(3)+'</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\t\tcString += '<vBC>'  +ConvType(0,15,2)+'</vBC>'\r\n\t\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\t\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\t\t\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\t\tcString += '</Tributo>'\r\n\t\t\tcString += '</imposto>'\r\n\t\tEndIf\r\n\tEndIf\r\nEndIf\r\ncString += '<imposto>'\r\ncString += '<codigo>PIS</codigo>'\r\nIf Len(aPIS)>0\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aPIS[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aPIS[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aPIS[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aPIS[03],5,2)+'</aliquota>'\r\n\tEndif\r\n\tcString += '<vlTrib>'+ConvType(aPIS[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aPIS[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aPIS[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tnValPis += aPIS[04]\r\nElse\r\n\tcString += '<Tributo>'\r\n\t\r\n\tIf len(aPisAlqZ) > 0 .and. !empty(aPisAlqZ[01])\r\n\t\tcString += '<CST>'+ConvType(aPisAlqZ[01])+'</CST>'\r\n\tElse\r\n\t\tcString += '<CST>08</CST>'\r\n\tEndIf\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\nEndIf\r\ncString += '</imposto>'\r\nIf Len(aPISST)>0\r\n\tcString += '<imposto>'\r\n\tcString += '<codigo>PISST</codigo>'\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aPISST[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aPISST[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aPISST[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aPISST[03],5,2)+'</aliquota>'\r\n\tEndIf\r\n\tcString += '<vlTrib>'+ConvType(aPISST[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aPISST[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aPISST[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tcString += '</imposto>'\r\n\tnValPis += aPISST[04]\r\nEndIf\r\ncString += '<imposto>'\r\ncString += '<codigo>COFINS</codigo>'\r\nIf Len(aCOFINS)>0\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aCOFINS[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aCOFINS[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINS[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINS[03],5,2)+'</aliquota>'\r\n\tEndIf\r\n\tcString += '<vlTrib>'+ConvType(aCOFINS[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aCOFINS[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aCOFINS[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tnValCof += aCOFINS[04]\r\nElse\r\n\tcString += '<Tributo>'\r\n\t\r\n\tIf len(aCofAlqZ) > 0 .and. !Empty(aCofAlqZ[01])\r\n\t\tcString += '<CST>'+ConvType(aCofAlqZ[01])+'</CST>'\r\n\tElse\r\n\t\tcString += '<CST>08</CST>'\r\n\tEndIf                       \r\n\t\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\nEndIf\r\ncString += '</imposto>'\r\n\r\nIf Len(aCOFINSST)>0\r\n\tcString += '<imposto>'\r\n\tcString += '<codigo>COFINSST</codigo>'\t\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aCOFINSST[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aCOFINSST[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINSST[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINSST[03],5,2)+'</aliquota>'\r\n\tEndIf\r\n\tcString += '<vlTrib>'+ConvType(aCOFINSST[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aCOFINSST[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aCOFINSST[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tcString += '</imposto>'\r\n\tnValCof += aCOFINSST[04]\r\nEndIf \r\n \tIf lMvPisCofD  .And. aDest[9] == 'PR'  // Lei Est. PR 17.127/12 informar todos os impostos na Danfe\r\n\t\tcMensFis += \" Conforme Lei Estadual PR 17.127/12 segue o Valor Pis / Cofins:\"\r\n\t\tcMensFis += \" Valor Pis R$ \" + ConvType(nValPis,15,2) \r\n\t\tcMensFis += \" Valor Cofins R$ \" + ConvType(nValCof,15,2)\r\nEndIf\r\n\r\nIf nIcmsDif > 0 .And. aDest[9] == 'PR' .And. aCST[1] $ '10' .And. SM0->M0_ESTENT == 'PR'\r\n\tcMensFis += \"Diferimento Parcial conforme Anexo VIII, Art. 28 do RICMS/PR - Decreto 7871/2017. ICMS Diferido em \" + ConvType(nPIcmsDif,6,2) +  \"% no valor de R$\" + ConvType(nIcmsDif,15,2) + \". \"\r\nEndIf\r\n\r\nIf nIcmsDif > 0 .And. aDest[9] == 'RS' .And. SM0->M0_ESTENT == 'RS' .And. aCST[1] $ '51' .And. nPIcmsDif > 12\r\n\tnValDifer += nIcmsDif\r\nEndif\r\n\r\nIf !lIssQn\r\n\t// Tratamento de imposto de importacao quando \r\n\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\"\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>II</codigo>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<vBC>'      +ConvType(aDI[17][03],15,2)+'</vBC>'\r\n\t\tcString += '<Valor>'    +ConvType(aDI[19][03],15,2)+'</Valor>'\r\n\t\tcString += '</Tributo>'\t\t\t\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<vDespAdu>' +ConvType(aDI[18][03],15,2)+'</vDespAdu>'\r\n\t\tcString += '<vIOF>'     +ConvType(aDI[20][03],15,2)+'</vIOF>'\r\n\t\tcString += '</cpl>'\t\t\t\t\t\t\r\n\t\tcString += '</imposto>'\r\n\tElseIf Len(aDI)>0\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>II</codigo>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<vBC>'      +ConvType(aDI[15][03],15,2)+'</vBC>'\r\n\t\tcString += '<Valor>'    +ConvType(aDI[14][03],15,2)+'</Valor>'\r\n\t\tcString += '</Tributo>'\t\t\t\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<vDespAdu>' +ConvType(aDI[13][03],15,2)+'</vDespAdu>'\r\n\t\tcString += '<vIOF>'     +ConvType(aDI[16][03],15,2)+'</vIOF>'\r\n\t\tcString += '</cpl>'\t\t\t\t\t\t\r\n\t\tcString += '</imposto>'\t\r\n\tEndIf\r\nEndIf\r\n\t\r\n//Anfavea Itens\r\nIf lAnfavea\r\n\tIf !Empty(aAnfI) .And. !Empty(aAnfI[01])\r\n\t\tcString += '<AnfaveaProd>'\r\n\t\tcString += \t'<![CDATA[<id'\r\n\t\tIf !Empty(aAnfI[01])\r\n\t\t\tcString += \t' item=\"' \t\t+ convType(Iif(lAnfProd,aAnfI[01],aAnfI[26])) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[02])\r\n\t\t\tcString += \t' ped=\"'\t\t+ convType(aAnfI[02]) + '\"'\r\n\t    Endif\r\n\t\tIf !Empty(aAnfI[03])\r\n\t\t\tcString += \t' sPed=\"'\t\t+ convType(aAnfI[03]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[04])\r\n\t\t\tcString += \t' alt=\"'\t\t+ convType(aAnfI[04]) + '\"'\r\n\t\tEndif\t\r\n\t\tIf !Empty(aAnfI[05])\r\n\t\t\tcString += \t' tpF=\"'\t\t+ convType(aAnfI[05]) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><div'\r\n\t\tIf !Empty(aAnfI[06])\r\n\t\t\tcString += \t' uM=\"'  \t\t+ convType(aAnfI[06]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[07])\r\n\t\t\tcString += \t' dVD=\"'\t\t+ convType(aAnfI[07]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[08])\r\n\t\t\tcString += \t' pedR=\"'\t\t+ convType(aAnfI[08]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[09])\r\n\t\t\tcString += \t' pE=\"'\t\t\t+ convType(aAnfI[09]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[10])\r\n\t\t\tcString += \t' psB=\"'\t\t+ convType(Alltrim(Str(aAnfI[10],TAMSX3(\"B1_PESO\")[1],TAMSX3(\"B1_PESO\")[2]))) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[11])\r\n\t\t\tcString += \t' psL=\"'\t\t+ convType(Alltrim(Str(aAnfI[11],TAMSX3(\"B1_PESO\")[1],TAMSX3(\"B1_PESO\")[2]))) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><entg'\r\n\t\tIf !Empty(aAnfI[12])\r\n\t\t\tcString += \t' tCh=\"'\t\t+ convType(Iif(aAnfI[12]==\"PeA\",'P&A',aAnfI[12])) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[13])\r\n\t\t\tcString += \t' ch=\"'\t\t\t+ convType(aAnfI[13]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[14])\r\n\t\t\tcString += \t' hCh=\"'\t\t+ convType(aAnfI[14]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[15])\r\n\t\t\tcString += \t' qtEm=\"'\t\t+ convType(Alltrim(Str(aAnfI[15],14,2))) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[16])\r\n\t\t\tcString += \t' qtlt=\"'\t\t+ convType(Alltrim(Str(aAnfI[16],14,2))) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><dest'\r\n\t\tIf !Empty(aAnfI[17])\r\n\t\t\tcString += \t' dca=\"'\t\t+ convType(aAnfI[17]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[18])\r\n\t\t\tcString += \t' ptU=\"'\t\t+ convType(aAnfI[18]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[19])\r\n\t\t\tcString += \t' trans=\"'\t\t+ convType(aAnfI[19]) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><ctl'\r\n\t\tIf !Empty(aAnfI[20])\r\n\t\t\tcString += \t' ltP=\"'\t\t+ convType(aAnfI[20]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[21])\r\n\t\t\tcString += \t' cPI=\"'\t\t+ convType(aAnfI[21]) + '\"'\t\r\n\t\tEndif\r\n\t\tcString += \t'/><ref'\r\n\t\tIf !Empty(aAnfI[22])\r\n\t\t\tcString += \t' nFE=\"'\t\t+ convType(aAnfI[22]) + '\"'\t\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[23])\r\n\t\t\tcString += \t' sNE=\"'\t\t+ convType(aAnfI[23]) + '\"'\t\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[24])\r\n\t\t\tcString += \t' cdEm=\"'\t\t+ convType(aAnfI[24]) + '\"'\t\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[25])\r\n\t\t\tcString += \t' aF=\"'\t\t\t+ convType(aAnfI[25]) + '\"'\t\r\n\t\tEndif\r\n\t\tcString += \t'/>]]>'\r\n\t\tcString += '</AnfaveaProd>'\r\n\tEndif\r\nEndif\r\n\r\nif !empty(aProd[15]) .And. !empty(cMotDesICMS) .or. ( !empty(cMotDesICMS).and. lIcmDevol .and. !Empty(nDesonICM) ) /*Conforme chamado TILXYR foi incluido o .OR. para incluir devolução na mensagem*/\r\n\tcMensDeson := 'Valor Dispensado R$ '+ cValtoChar(nDesonICM) + ', Motivo da Desoneracao do ICMS: '+cMotDesICMS+'.(Ajuste SINIEF 25/12, efeitos a partir de 20.12.12)'\r\nendif\r\n\r\n/*Nota Técnica 004 de 2011 conforme chamado - THCTB4 */\r\n/*Nota Técnica 004 de 2011 conforme chamado - THCTB4 e conforme portaria nº 275/2009 do chamado TPIPVV */\r\n\r\nif lSuframa .and. Len(aICMSZFM)>0 \r\n\tIf!(lMvNFLeiZF)\r\n\t\tif aIcmsZFM[1] > 0 .and. empty(aProd[15])\t\r\n\t\t\t\r\n\t\t\t//cMensDeson := 'Valor do ICMS abatido: R$ '+ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( '+Iif(aProd[33] > 0,AllTrim(Str(aProd[33])),'7')+'% sobre R$ ' +ConvType(aProd[10],15,2)+ ' ).'\r\n\t\t\tIf aProd[33] > 0\r\n\t\t\t\tcMensDeson := 'Valor do ICMS abatido: R$ '+ ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( '+AllTrim(Str(aProd[33]))+'% sobre R$ ' +ConvType(aProd[10] + aProd[13] + aProd[14],15,2)+ ' ).'\r\n\t\t\tElse\r\n\t\t\t\tcMensDeson := 'Valor do ICMS abatido: R$ '+ ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( '+'7% sobre R$ ' + ConvType(aProd[10]- IIF(cTipo == '1', aProd[31]+aProd[32], 0),15,2)+ ' ).'\t\r\n\t\t\tEndIf\t\r\n\t\t\t\r\n\t\telse\r\n\t\t\tcMensDeson := 'Valor do ICMS abatido: R$ '+ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( 7% sobre R$ ' +ConvType(aProd[10],15,2)+ ' ). Valor do desconto comercial: R$ '+ConvType(aProd[15],15,2)+'.'\t\r\n\t\tendif\r\n\tElse\r\n\t\tcMensDeson := 'Remessa de Mercadoria para ZFM ou ALC conforme Portaria 275.2009'\r\n\tEndif\r\nEndif\r\n\r\nIf aProd[29] > 0\r\n\tcDedIcm := 'Valor do ICMS deduzido R$ '+ cValtoChar(aProd[29] ) + '. Conforme artigo 55 anexo I do RICMS-SP.'\r\nEndIf \r\n\r\n// Valor dos Tributos por Ente Tributante: Federal, Estadual e Municipal\r\nIf lMvEnteTrb\r\n\r\n\tIf cMvMsgTrib $ \"2-3\" .And. cTpCliente == \"F\" .And. ( ( aProd[35] + aProd[36] + aProd[37] ) > 0 )\r\n\t\r\n\t\tlProdItem\t:= .T.\t\r\n\r\n\t\tcCrgTrib\t:= 'Valor aproximado do(s) Tributo(s): '\r\n\r\n\t\t// Federal\r\n\t\tIf aProd[35] > 0\r\n\t\t\tcPercTrib\t:= PercTrib( aProd, lProdItem, \"1\", aNota )  \r\n\t\t\tcCrgTrib\t+= 'R$ ' + ConvType( aProd[35], 15, 2 ) + \" (\"+cPercTrib+\"%) Federal\"\r\n\t\tEndIf\r\n\r\n\t\t// Estadual\r\n\t\tIf aProd[36] > 0\r\n\t\t\tcPercTrib\t:= PercTrib( aProd, lProdItem, \"2\", aNota )\r\n\t\t\tIf aProd[35] > 0\r\n\t\t\t\tcCrgTrib\t+= \" e \"\r\n\t\t\tEndif\r\n\t\t\tcCrgTrib\t+= \"R$ \" + ConvType( aProd[36], 15, 2 ) + \" (\"+cPercTrib+\"%) Estadual\"\r\n\t\tEndIf\r\n\t\r\n\t\t// Municipal\r\n\t\tIf aProd[37] > 0\r\n\t\t\tcPercTrib\t:= PercTrib( aProd, lProdItem, \"3\", aNota )  \r\n\t\t\tIf aProd[35] > 0 .Or. aProd[36] > 0\r\n\t\t\t\tcCrgTrib\t+= \" e \"\r\n\t\t\tEndif\r\n\t\t\tcCrgTrib\t+= \"R$ \" + ConvType( aProd[37], 15, 2 ) + \" (\"+cPercTrib+\"%) Municipal.\"\r\n\t\tEndIf\r\n\t\t\r\n\t\tIf !Empty( cFntCtrb )\r\n\t\t   cCrgTrib += \"  Fonte: \" + cFntCtrb + \".\"\r\n\t\tEndIf\r\n\t\t\r\n\t\t\r\n\tEndif\r\n\t\r\nElse\r\n\r\n\tIf aProd[30] > 0 .And. cMvMsgTrib $ \"2-3\" .And. cTpCliente == \"F\"\r\n\t\tlProdItem := .T.\t\r\n\t\tcPercTrib := PercTrib(aProd, lProdItem,,aNota)  \r\n\t\r\n\t\tcCrgTrib := 'Valor Aproximado dos Tributos: R$ '+ ConvType(aProd[30],15,2)+ \" (\"+cPercTrib+\"%).\"\t\r\n\tEndIf\r\n\r\nEndif\r\n\r\n// Grupo opcional 'impostoDevol' para informar o valor e percentual do IPI devolvido para notas de Devolução\r\nIf Len(aIPIDevol) > 0 .and. cTPNota == \"4\" \r\n\tcString += '<IPIDEV>'\r\n\tcString += '<pdevol>'+ConvType(aIPIDevol[01],6,2)+'</pdevol>' //Percentual da mercadoria devolvida\r\n\tcString += '<vipidevol>'+ConvType(aIPIDevol[02],15,2)+'</vipidevol>' //Valor do IPI devolvido\r\n\tcString += '</IPIDEV>'\t\r\nEndIf\r\n\r\n\r\n//Tratamento para incluir a mensagem em informacoes adicionais  do Produto (PR)\r\nIf aProd[43] > 0 .and. aDest[9] == \"PR\" .and.  cVerAmb ='3.10'\r\n\tcMensFecp := NfeMFECOP(aProd[43],aDest[9],\"2\")\r\nElseIf aProd[43] > 0  .and. cVerAmb ='4.00'\r\n   cMensFecp := NfeMFECOP(aProd[43],aDest[9],\"2\",aICMS,aICMSST,cVerAmb)\r\nEndIf\r\ncString += '<infadprod>'+ConvType(aProd[25],500)+cMensDeson+cDedIcm+cCrgTrib+cMensFecp+'</infadprod>'\r\n\r\ncString += '</det>' \r\nReturn(cString)\r\n\r\nStatic Function NfeTotal(aTotal,aRet,aICMS,aICMSST,lIcmDevol,cVerAmb,aISSQN,nVicmsDeson,aNota,nVIcmDif,aAgrPis,aAgrCofins,nValLeite )\r\n\r\nLocal cString\t\t:= \"\"\r\nLocal cMVREGIESP\t:= AllTrim(GetNewPar(\"MV_REGIESP\",\"2\"))\r\n/*1 – Microempresa Municipal; 2 – Estimativa; 3 – Sociedade de Profissionais; \r\n4 – Cooperativa; 5 – Microempresário Individual (MEI); \r\n6 – Microempresário e Empresa de Pequeno Porte (ME EPP)*/\r\nLocal nX     := 0\r\nLocal nBicm := 0\r\nLOcal nVicm := 0\r\nLocal nBicmst := 0\r\nLOcal nVicmst := 0\r\nLocal nAgrPis := 0\r\nLocal nAgrCofins := 0\r\n\r\nDefault nVicmsDeson\t:= 0\r\nDefault nVIcmDif\t:= 0\r\nDefault nValLeite   := 0\r\n\r\ncString += '<total>'\r\nIf Len(aICMS)>0 \r\n\tFor nX := 1 To Len(aICMS)\r\n\t\tIf Len(aICMS[NX]) >0\r\n\t\t\tnBicm += iIf(lIcmDevol,aICMS[NX][05],0)\r\n\t\t\tnVicm += iIf(lIcmDevol,aICMS[NX][07],0)\r\n\t\tEndif\t\r\n\tNext nX\r\nEndif\r\n\r\nIf Len(aICMSST)>0 \r\n\tFor nX := 1 To Len(aICMSST)\r\n\t\tIf Len(aICMSST[NX]) >0\r\n\t\t\tnBicmst += aICMSST[NX][05]\r\n\t\t\tnVicmst += aICMSST[NX][07]\r\n\t\tEndif\t\r\n\tNext nX\r\nEndif\r\n\r\nFor nX := 1 to Len(aAgrPis)\r\n\tnAgrPis\t\t+=\taAgrPis[nX][02]\r\n\tnAgrCofins\t+=\taAgrCofins[nX][02]\r\nNext\r\n\r\ncString += '<vBC>'+ConvType(nBicm, 15,2)+'</vBC>' \r\n\r\nIf cVerAmb >= \"3.10\" .and. nVIcmDif > 0\r\n\tcString += '<vICMS>'+ConvType(nVicm-nVIcmDif,15,2)+'</vICMS>'\r\nElse\r\n\tcString += '<vICMS>'+ConvType(nVicm,15,2)+'</vICMS>'\r\nEndIf\r\n\r\ncString += '<vBCST>'+ConvType(nBicmst,15,2)+'</vBCST>'\r\ncString += '<vICMSST>'+ConvType(nVicmst,15,2)+'</vICMSST>'\r\ncString += '<despesa>'+ConvType(aTotal[01]+nAgrPis+nAgrCofins+nValLeite,15,2)+'</despesa>'\r\n//cString += '<vNF>'+ConvType(aTotal[02],15,2)+'</vNF>'\r\n//Alteração para que o valor de PIS ST e COFINS ST venha a compor o valor da nota este valor se encontra na tag vOutros  (NT 2011/004). E devolução de compra com IPI não tributado\r\ncString += '<vNF>'+ConvType(aTotal[02]+aTotal[03],15,2)+'</vNF>'\r\n\r\nIf cVerAmb >= \"3.10\" .and. Len(aISSQN)>0\r\n\tcString += NfeTag('<cRegTrib>',ConvType(cMVREGIESP,1))\r\n\tcString += '<dCompet>'+Strtran(ConvType(aNota[03]),\"-\",\"\")+'</dCompet>'\r\nEndIf\t\r\nIf Len(aRet)>0\r\n\tFor nX := 1 To Len(aRet)\r\n\t\tcString += '<TributoRetido>'\r\n\t\tcString += NfeTag('<codigo>' ,ConvType(aRet[nX,01],15,2))\r\n\t\tcString += NfeTag('<BC>'     ,ConvType(aRet[nX,02],15,2))\r\n\t\tcString += NfeTag('<valor>',ConvType(aRet[nX,03],15,2))\r\n\t\tcString += '</TributoRetido>'\r\n/*\t    If aRet[nX,01] =='PIS'\r\n\t    \tnValPis += ConvType(aRet[nX,03],15,2)\r\n\t    EndIf\r\n\t    If aRet[nX,01] =='COFINS'\r\n\t    \tnValCof += ConvType(aRet[nX,03],15,2)\r\n\t    EndIf\t\t*/\r\n\tNext nX\r\nEndIf\r\ncString += '</total>'\r\n\r\n//Variavel para ter o valor total da nota para ser utilizado na Lei da Transparencia\r\nnTotNota \t:= Val(ConvType((aTotal[02]+aTotal[03]),15,2))\r\n\r\n\r\nReturn(cString)\r\n\r\nStatic Function NfeTransp(cModFrete,aTransp,aImp,aVeiculo,aReboque,aVol,cVerAmb,aReboqu2,cMunDest)\r\n           \r\nLocal nX := 0\r\nLocal cString := \"\"\r\nLocal lMVINTTRAN := SuperGetMV(\"MV_INTTRAN\", ,.T.)  // Parametro que define se as tags <veicTransp> e <reboque>, seram geradas em operações internas.\r\nLocal lGeraTags\t := .T.\r\nDEFAULT cMunDest\t:= \"\"\r\nDEFAULT aTransp := {}\r\nDEFAULT aImp    := {}\r\nDEFAULT aVeiculo:= {}\r\nDEFAULT aReboque:= {}\r\nDEFAULT aReboqu2:= {}\r\nDEFAULT aVol    := {}\r\n\r\ncString += '<transp>'\r\nIf cVerAmb >= \"2.00\"\r\n\tIf cModFrete == \"\"\r\n\t\tcString += '<modFrete>'+\"1\"+'</modFrete>' \r\n\tElse \r\n\t\tcString += '<modFrete>'+cModFrete+'</modFrete>'\r\n\tEndif\r\nEndif\r\n\r\nIf cVerAmb == \"4.00\"\r\n\t//Se operação interestadual(idDest=2), não informar os Grupos Veiculo Transporte (id:X18; veicTransp) e Grupo Reboque (id: X22)\r\n\t//Obs1: a critério de cada UF, a regra de validação acima também pode ser aplicada nas operações internas (idDest=1) se cMun (id:C10) do Emitente <> cMun (id: E10) do Destinatário\r\n\tIf cIdDest == \"2\" .or. (cIdDest == \"1\" .And. SM0->M0_CODMUN <> cMunDest .And. !lMVINTTRAN)\r\n\t\tlGeraTags:= .F.  \r\n\tEndif\r\nEndif\r\n\r\nIf Len(aTransp)>0\r\n\tcString += '<transporta>'\r\n\t\tIf Len(aTransp[01])==14\r\n\t\t\tcString += NfeTag('<CNPJ>',aTransp[01])\r\n\t\tElseIf Len(aTransp[01])<>0\r\n\t\t\tcString += NfeTag('<CPF>',aTransp[01])\r\n\t\tEndIf\r\n\t\tcString += NfeTag('<Nome>' ,ConvType(aTransp[02]))\r\n\t\tcString += NfeTag('<IE>'    ,aTransp[03])\r\n\t\tcString += NfeTag('<Ender>',ConvType(aTransp[04]))\r\n\t\tcString += NfeTag('<Mun>'  ,ConvType(aTransp[05]))\r\n\t\tcString += NfeTag('<UF>'    ,ConvType(aTransp[06]))\r\n\tcString += '</transporta>'\r\n\tIf Len(aImp)>0 //Ver Fisco\r\n\t\tcString += '<retTransp>'\r\n\t\tcString += '<codigo>ICMS</codigo>'\r\n\t\tcString += '<Cpl>'\r\n\t\tcString += '<vServ>'+ConvType(aImp[01],15,2)+'</vServ>'\r\n\t\tcString += '<CFOP>'+ConvType(aImp[02])+'</CFOP>'\r\n\t\tcString += '<cMunFG>'+ConvType(aImp[03],7)+'</cMunFG>'\t\t\r\n\t\tcString += '</Cpl>'\r\n\t\tcString += '<CST>'+ConvType(aImp[04])+'</CST>'\r\n\t\tcString += '<MODBC>'+ConvType(aImp[05])+'</MODBC>'\r\n\t\tcString += '<PREDBC>'+ConvType(aImp[06],7,2)+'</PREDBC>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<VBC>'+ConvType(aImp[07],15,2)+'</VBC>'\r\n\t\tcString += '<aliquota>'+ConvType(aImp[08],7,4)+'</aliquota>'\r\n\t\tcString += '<valor>'+ConvType(aImp[9],15,2)+'</valor>'\r\n\t\tcString += '</Tributo>'\t\t\r\n\t\t// cString += '<vltrib>'+ConvType(aImp[09],15,4)+'</vltrib>'\t\r\n\t\t// cString += '<qtrib>'+ConvType(aImp[10],16,4)+'</qtrib>'\t\t\r\n\t\tcString += '</retTransp>'\r\n\tEndIf\r\n\tIf lGeraTags\r\n\t\tIf Len(aVeiculo)>0\r\n\t\t\tcString += '<veicTransp>'\r\n\t\t\t\tcString += '<placa>'+ConvType(aVeiculo[01])+'</placa>'\r\n\t\t\t\tcString += '<UF>'   +ConvType(aVeiculo[02])+'</UF>'\r\n\t\t\t\tcString += NfeTag('<RNTC>',ConvType(aVeiculo[03]))\r\n\t\t\tcString += '</veicTransp>'\r\n\t\tEndIf\r\n\t\tIf Len(aReboque)>0\r\n\t\t\tcString += '<reboque>'\r\n\t\t\t\tcString += '<placa>'+ConvType(aReboque[01])+'</placa>'\r\n\t\t\t\tcString += '<UF>'   +ConvType(aReboque[02])+'</UF>'\r\n\t\t\t\tcString += NfeTag('<RNTC>',ConvType(aReboque[03]))\r\n\t\t\tcString += '</reboque>'\r\n\t\t\tIf Len(aReboqu2)>0\r\n\t\t\t\tcString += '<reboque>'\r\n\t\t\t\tcString += '<placa>'+ConvType(aReboqu2[01])+'</placa>'\r\n\t\t\t\tcString += '<UF>'   +ConvType(aReboqu2[02])+'</UF>'\r\n\t\t\t\tcString += NfeTag('<RNTC>',ConvType(aReboqu2[03]))\r\n\t\t\t\tcString += '</reboque>'\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\t\t\r\nElseIf lGeraTags .And. Len(aVeiculo)>0\r\n\t\tcString += '<veicTransp>'\r\n\t\t\tcString += '<placa>'+ConvType(aVeiculo[01])+'</placa>'\r\n\t\t\tcString += '<UF>'   +ConvType(aVeiculo[02])+'</UF>'\r\n\t\t\tcString += NfeTag('<RNTC>',ConvType(aVeiculo[03]))\r\n\t\tcString += '</veicTransp>'\r\nEndIf\r\nFor nX := 1 To Len(aVol)\t\t\r\n\tcString += '<vol>'\r\n\t\tcString += NfeTag('<qVol>',ConvType(aVol[nX][02]))\r\n\t\tcString += NfeTag('<esp>' ,ConvType(aVol[nX][01],30,0))\r\n\t\tif len( aVol[nX] ) >= 5 \r\n\t\t\tcString += NfeTag('<marca>' ,ConvType(aVol[nX][05]))\r\n\t\tendif\r\n\t\tif len( aVol[nX] ) >= 6 \r\n\t\t\tcString += NfeTag('<nVol>'  ,ConvType(aVol[nX][06]))\r\n\t\tendif\r\n\t\tcString += NfeTag('<pesoL>' ,ConvType(aVol[nX][03],15,3))\r\n\t\tcString += NfeTag('<pesoB>' ,ConvType(aVol[nX][04],15,3))\r\n\t\t//cString += '<nLacre>'+aVol[07]+'</nLacre>'\r\n\tcString += '</vol>'\r\nNext nX\r\ncString += '</transp>'\r\nReturn(cString)\r\n\r\nStatic Function NfeCob(aDupl,aFat,cFatura)\r\n\r\nLocal cString := \"\"\r\nLocal nX := 0 \r\nLocal nValorfat := 0  \r\nLocal cValorDesc := \"0\"  \r\nlocal lDatDupl\t\t:= SuperGetMV(\"MV_DATDUPL\",.F.,.F.) \r\nDEFAULT cFatura\t:= \"\"\r\nDEFAULT aDupl\t:= {}  \r\nDEFAULT aFat\t:= {}\r\n               \r\n//Ordeno as duplicatas por data de vencimento\r\nIf Len(aDupl) > 1\r\n\taDupl := SortArray(aDupl,,,{|x,y| x[2] < y[2] .and. x[3] > y[3] })\r\nEndIf\t\r\n\r\nIf Len(aDupl)>0\r\n\r\n\tcString += '<cobr>'\r\n\t\r\n\tIf Len(aFat)>0\r\n\t\tcString += '<fat>'\r\n\t\tcString += '<nFatura>'+ConvType(aFat[01][01])+'</nFatura>'\r\n\t\tcString += '<vOriginal>'+ConvType(aFat[01][02],15,2)+'</vOriginal>'\r\n\t\tcString += '<vDesconto>'+ConvType(aFat[01][03],15,2)+'</vDesconto>'\r\n\t\tcString += '<vLiquido>' +ConvType(aFat[01][04],15,2)+'</vLiquido>'\r\n\t\tcString += '</fat>'\r\n\telse\r\n\t\tFor nX := 1 To Len(aDupl)\r\n\t\t\tnValorfat:= nValorfat + aDupl[nX][03]\r\n\t\tNext nX\t\r\n\t\t\r\n\t\tcString += '<fat>'\r\n\t\tcString += '<nFatura>'+ConvType(cFatura)+'</nFatura>'\r\n\t\tcString += '<vOriginal>'+ConvType(nValorfat,15,2)+'</vOriginal>'\r\n\t\tcString += '<vDesconto>'+cValorDesc+'</vDesconto>'\r\n\t\tcString += '<vLiquido>' +ConvType(nValorfat,15,2)+'</vLiquido>'\r\n\t\tcString += '</fat>'\r\n\tEndIf\r\n\t\r\n\t\r\n\tFor nX := 1 To Len(aDupl)\r\n\t\tcString += '<dup>'\r\n\t\tcString += '<Dup>'+ConvType(PADL(nX,3,\"0\"))+'</Dup>'\r\n\t\tIf (aDupl[nX][02] < DATE()) .and. lDatDupl\r\n\t\t\tcString += '<dtVenc>'+ConvType(DATE())+'</dtVenc>'\t\r\n\t\tElse\r\n\t\t\tcString += '<dtVenc>'+ConvType(aDupl[nX][02])+'</dtVenc>'\r\n\t\tEndIf\r\n\t\tcString += '<vDup>'+ConvType(aDupl[nX][03],15,2)+'</vDup>'\r\n\t\tcString += '</dup>'\r\n\tNext nX\t\r\n\tcString += '</cobr>'\r\nEndIf\r\n\r\nReturn(cString)\r\n\r\nStatic Function NfeInfAd(cMsgCli,cMsgFis,aPedido,aExp,cAnfavea,aMotivoCont,aNfSa,aNfVinc,aProd,aDI,aNfVincRur,aRet,cNfRefcup,cSerRefcup,cTipo,nIPIConsig,nSTConsig,lBrinde,cVerAmb,aRefECF,nVicmsDeson,nvFCPUFDest,nvICMSUFDest,nvICMSUFRemet,nvBCUFDest,aICMUFDest,nValIpiBene,npFCPUFDest,npICMSUFDest,npICMSInter,npICMSIntP,aObsCont,aValTotOpe,cMensDifal,aProcRef,aDest,nTotCrdP,cMensCpl)\r\nLocal cString   \t\t:= \"\"\r\nLocal cCfor     \t\t:= \"\"\r\nLocal cLojaEn   \t\t:= \"\"\r\nLocal cCnpjen   \t\t:= \"\"\r\nLocal cDocEn    \t\t:= \"\"\r\nLocal cSerieEn  \t\t:= \"\"\r\nLocal cChave1   \t\t:= \"\"\r\nLocal cValidCh\t\t\t:= \"\"\r\nLocal cInfRem\t\t\t:= \"\"\r\nLocal cNfVinc\t\t\t:= \"\"\r\nLocal cEcfVinc\t\t\t:= \"\"\r\nLocal cChvNFe\t\t\t:= \"\"\r\nLocal cNfVincRur\t\t:= \"\"\r\nLocal cPercTrib \t\t:= \"\"\r\nLocal aEEC     \t\t\t:= {}\r\nLocal aNcm    \t\t\t:= {}\r\nLocal aDadosDest\t\t:= {}\r\nLocal aInfoDest\t\t\t:= {}\r\nLocal nX        \t\t:= 0\r\nLocal nY        \t\t:= 0\r\nLocal nZ\t\t\t\t:= 0\r\nLocal nW\t\t\t\t:= 0\r\nLocal nPos\t\t\t\t:= 0\r\nLocal nValII\t\t\t:= 0\r\nLocal nVlrTotal \t\t:= 0\r\nLocal lEasy\t\t\t\t:= SuperGetMV(\"MV_EASY\") == \"S\"\r\nLocal lImpRet\t\t\t:= GetNewPar(\"MV_IMPRET\",.F.)\r\nLocal lProdItem\t\t\t:= .F.\t//Define se esta configurado para gerar a mensagem da Lei da Transparencia por Produto ou somente nas informacoes Complementares.\r\nLocal lEECFAT\t\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lEIC0064\t\t\t:= GetNewPar(\"MV_EIC0064\",.F.)\r\nLocal lMsnOk    \t\t:= .F.\r\n\r\n\r\nDEFAULT cAnfavea\t\t:= \"\"\r\nDEFAULT aPedido \t\t:= {}\r\nDEFAULT aExp\t\t\t:= {}\r\nDEFAULT aNfSa\t\t\t:= {}\r\nDEFAULT aNfVinc \t\t:= {}\r\nDEFAULT aProd\t\t\t:= {}  \r\nDEFAULT aDI \t\t\t:= {}  \r\nDEFAULT aNfVincRur \t\t:= {}  \r\nDEFAULT aRefECF\t\t\t:= {} \r\nDEFAULT nIPIConsig \t\t:= 0  \r\nDEFAULT nSTConsig \t\t:= 0  \r\nDEFAULT nvFCPUFDest\t\t:= 0\r\nDEFAULT nvICMSUFDest\t:= 0\r\nDEFAULT nvICMSUFRemet\t:= 0\r\nDEFAULT npFCPUFDest   \t:= 0 \r\nDEFAULT npICMSUFDest  \t:= 0 \r\nDEFAULT npICMSInter   \t:= 0 \r\nDEFAULT npICMSIntP    \t:= 0 \t\r\nDEFAULT nValIpiBene\t\t:= 0\r\nDEFAULT nTotCrdP        := 0\r\nDEFAULT cAnfavea\t\t:= \"\"\r\nDEFAULT nvBCUFDest \t\t:= 0\r\nDEFAULT aICMUFDest \t\t:= {} \r\nDEFAULT aObsCont   \t\t:= {}\t\r\nDEFAULT aProcRef   \t\t:= {}\t\r\nDEFAULT aDest      \t\t:= {}\r\n\r\ncString += '<infAdic>'\r\n\r\nIf AliasIndic(\"EYY\")\r\n\taEEC:= AvGetNfRem(aNfSa[2],aNfSa[1])\t \r\nEndif\r\n\r\n//array aEEC:= AvGetNfRem\r\n//documento   1\r\n//serie       2\r\n//fornecedor  3\r\n//loja        4\r\nIf len(aEEC) > 0\r\n\tFor nY := 1 To Len(aEEC)        \r\n\t   \tdbSelectArea(\"SF1\")\r\n\t\tdbSetOrder(1)\r\n\t\tIf DbSeek(xFilial(\"SF1\")+aEEC[ny][2][1]+aEEC[ny][2][2]+aEEC[ny][2][3]+aEEC[ny][2][4])\r\n\t\t\tIf cValidCh <> (xFilial(\"SF1\")+aEEC[ny][2][1]+aEEC[ny][2][2]+aEEC[ny][2][3]+aEEC[ny][2][4])\r\n\t\t\t\tcCfor      := SF1->F1_FORNECE\r\n\t\t\t    cLojaEn    := SF1->F1_LOJA\r\n\t\t\t    dEmisEn    := SF1->F1_EMISSAO  \r\n\t\t\t\tcDocEn\t   := SF1->F1_DOC\r\n\t\t\t\tcSerieEn   := SF1->F1_SERIE\r\n\t\t\t    cValidCh   := (xFilial(\"SF1\")+aEEC[ny][2][1]+aEEC[ny][2][2]+aEEC[ny][2][3]+aEEC[ny][2][4])\r\n\t\t\t    \r\n\t\t\t    dbSelectArea(\"SA2\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf DbSeek(xFilial(\"SA2\")+cCfor+cLojaEn)\r\n\t\t\t\t\tcCnpjen    := SA2->A2_CGC\r\n\t\t\t\tEndIf   \r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea( \"SD1\" )\r\n\t\t\t\tdbSetOrder( 1 )\r\n\t\t\t\tcChave1 := xFilial( \"SD1\" ) + cDocEn + cSerieEn + cCfor + cLojaEn\r\n\r\n\t\t\t\tif( dbSeek( cChave1 ) )\r\n\t\t\t\t\tdbSelectArea( \"SB1\" )\r\n\t\t\t   \t\tdbSetOrder( 1 )\r\n\r\n\t\t\t\t\twhile !SD1->(eof()) .and. cChave1 == xFilial( \"SD1\" ) + SD1->D1_DOC + SD1->D1_SERIE + SD1->D1_FORNECE + SD1->D1_LOJA\r\n\t\t\t\t\t\tif( dbSeek( xFilial( \"SB1\" ) + SD1->D1_COD ) )\r\n\t\t\t\t\t\t\tnPos := aScan( aNcm,{ |x|x[2] == SB1->B1_POSIPI } )\r\n\r\n\t\t\t\t\t\t\tif( nPos > 0 )\r\n\t\t\t\t\t\t\t\taNcm[nPos,03] += SD1->D1_QUANT\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\taadd( aNcm,{ cChave1,SB1->B1_POSIPI,SD1->D1_QUANT,SB1->B1_UM } )\r\n\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\tendIf\r\n\r\n\t\t\t\t\t\tSD1->( dbSkip() )\r\n\t\t\t\t\tendDo\r\n\t\t\t\t\t\r\n\t\t\t\t\tif( nY > 1 )\r\n\t\t\t\t\t\tcInfRem += \"CNPJ-CPF Rem.\"+\": \"+cCnpjen+\"/\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcInfRem := \"CNPJ-CPF Rem.\"+\": \"+cCnpjen+\"/\"\r\n\t\t\t\t\tendIf\r\n\t\t\t\t\t \t\t\t\t\t \r\n\t\t\t\t\tcInfRem += \"Numero NF\"+\": \"+cDocEn+\"/\"+\"Serie\"+\": \"+cSerieEn+\"/\"+\"Data Emissao\"+\": \"+StrZero(Day(dEmisEn),2)+'-'+StrZero(Month(dEmisEn),2)+'-'+StrZero(Year(dEmisEn),4)\r\n\t\t\t\t\t \r\n\t\t\t\t\tfor nX := 1 to len( aNcm )\r\n\t\t\t\t\t\tcInfRem += +\"/\"+\"NCM-SH\"+\": \"+aNcm[nx,02]+\"/\"+\"UM\"+\": \"+aNcm[nx,04]+\"/\"+\"Quantidade\"+\": \"+AllTrim(Str(aNcm[nx,03]))\r\n\t\t\t\t\tnext nX\r\n\t\t\t\tendIf\r\n\t\t\tEndif\r\n\t\tEndIf\r\n\tNext ny\r\nEndIf \r\n\r\n/*\r\nREQUISITO PAF-ECF - Controle de Lojas\r\nEssa função insere o MD-5 do PAFLISTA.TXT\r\nno inicio da mensagem no campo \"Mensagens Adicionais\"\r\n*/\r\nIf ExistFunc(\"STFMMD5Nfe\")\r\n\tSTFMMD5Nfe(@cMsgFis)\r\nEndIf\r\n\r\nIf Len(cMsgFis)>0    \r\n\tcString += '<Fisco>'+ConvType(cMsgFis,Len(cMsgFis))+'</Fisco>'\r\nEndIf\r\n\r\ncString += '<Cpl>[ContrTSS='+StrZero(Year(ddatabase),4)+'-'+StrZero(Month(ddatabase),2)+'-'+StrZero(Day(ddatabase),2)+'#'+AllTrim(Time())+'#'+AllTrim(UsrFullName())+']'\r\n\r\nIf Len(cInfRem)>0\r\n\tcString += ConvType(cInfRem,Len(cInfRem))+\" \"\r\nEndIf\r\n\r\nIf !Empty(cMensCpl)\r\n\tcString += cMensCpl + \" \"\r\nEndIF\r\n\r\nIf Len(aMotivoCont)>0\r\n\t//cString += ConvType(\"DANFE emitida em contingencia devido a problemas técnicos - será necessária a substituição.\",Len(\"DANFE emitida em contingencia devido a problemas técnicos - será necessária a substituição.\"))+\" \"\r\n\tcString += \"Motivo da contingencia: \"+ConvType(aMotivoCont[1],Len(aMotivoCont[1]))+\", com \"\r\n\tcString += ConvType(\"inicío em\",Len(\"inicío em\"))+\" \"+StrZero(Day(aMotivoCont[2]),2)+\"/\"+StrZero(Month(aMotivoCont[2]),2)+\"/\"+StrZero(Year(aMotivoCont[2]),4)+\" \"\r\n\tcString += ConvType(\"às\",2)+\" \"+ConvType(aMotivoCont[3],Len(aMotivoCont[3]))+\".\"\r\nEndIf \r\nIf Len(cMsgCli)>0 .and. !Empty(cMsgCli)\r\n\tcString += ConvType(cMsgCli,Len(cMsgCli))+\" \"  \r\n\t//A Nota Fiscal de devolução deve ser preenchida com a nota e a data Original de acordo com a legislação:\r\n\t//Fundamento: Artigo 136 do RICMS-SP - O contribuinte,  excetuado o produtor,  emitirá Nota Fiscal (Lei nº 6374/89,  art. 67,  \r\n\t//Parágrafo 1º,  e Convênio de 15.12.70 - SINIEF, arts. 54 e 56, na redação do Ajuste SINlEF- 3/94, cláusula primeira, XII):.\r\n\tIF (SM0->M0_ESTENT) $ \"SP\" .AND. cTipo=='0' .And. !Empty(cSerRefcup + cNfRefcup)\r\n\t\tSFT->(dbSetOrder(6))\r\n\t\tIf SFT->(dbSeek(xFilial(\"SFT\")+\"S\"+cNfRefcup+cSerRefcup))\r\n\t\t\tcString += \" Artigo 136 do RICMS-SP Emissao Original NF-e: \"+cSerRefcup+\" \"+cNfRefcup+\" \"+Dtoc(SFT->FT_EMISSAO)+\" \" \r\n\t\tEndIf\t\t\r\n\tEndif\r\nEndIf   \r\n\r\nif SM0->M0_ESTENT == 'SP' .and. Len(aNfVinc) > 0\r\n\taSort(aNfVinc, , , {|x,y| x[4]+x[3] < y[4]+y[3] } ) //Ordena por CNPJ + Doc para aglutinar/totalizar os documentos por CNPJ\r\nEndIf\r\n\r\nIf Len( aNfVinc ) > 0 //Nota de espécie NFE ou NCE ou CTE vinculada\r\n\tFor nZ := 1  to Len( aNfVinc )\r\n\t\tIf !( aNfVinc[nZ][2] + aNfVinc[nZ][3] ) $ cChvNFe\r\n\t\t\tif !Empty(aNfVinc[nZ][6]) .and. \"CTE\" == UPPER(Alltrim(aNfVinc[nZ][6]))\r\n\t\t\t\tcString += \"Emissao Original CT-e: \"\r\n\t\t\telseif !Empty(aNfVinc[nZ][6]) .and. \"NFCE\" == UPPER(Alltrim(aNfVinc[nZ][6]))\r\n\t\t\t\tcString += \"Emissao Original NFC-e: \"\r\n\t\t\tElse\r\n\t\t\t\tif SM0->M0_ESTENT == 'SP' .And. !(aNfSa[5] $ \"I/P/C\") .And. !Empty(aNfVinc[nZ][13])\r\n\t\t\t\t\t//Busca pela chave: Codigo + Loja + Tipo de cadastro (1-cliente/2-fornecedor)\r\n\t\t\t\t\tif (nPos := aScan(aDadosDest,{|x| x[1]+x[2]+x[10] == aNfVinc[nZ][12]+aNfVinc[nZ][13]+AllTrim(Str(aNfVinc[nZ][11])) }) ) == 0\r\n\t\t\t\t\t\tIf At(\"#valor\",cString) > 0 //Verifica se houve uma troca de Cliente/fornecedor para totalizar o anterior\r\n\t\t\t\t\t\t\tcString :=  StrTran( cString, \"#valor\", ConvType(nVlrTotal,15,2))\r\n\t\t\t\t\t\t\tnVlrTotal := 0\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf aNfVinc[nZ][11]==1\r\n\t\t\t\t\t\t\taInfoDest := GetAdvFVal(\"SA1\", { \"A1_COD\",\"A1_LOJA\",\"A1_NOME\", \"A1_MUN\", \"A1_EST\", \"A1_END\", \"A1_BAIRRO\", \"A1_CGC\", \"A1_INSCR\"}, xFilial(\"SA1\")+aNfVinc[nZ][12]+aNfVinc[nZ][13], 1, { \"\", \"\", \"\", \"\", \"\", \"\", \"\" })\r\n\t\t\t\t\t\t\taAdd(aInfoDest, \"1\")\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taInfoDest := GetAdvFVal(\"SA2\", { \"A2_COD\",\"A2_LOJA\",\"A2_NOME\", \"A2_MUN\", \"A2_EST\", \"A2_END\", \"A2_BAIRRO\", \"A2_CGC\", \"A2_INSCR\"}, xFilial(\"SA1\")+aNfVinc[nZ][12]+aNfVinc[nZ][13], 1, { \"\", \"\", \"\", \"\", \"\", \"\", \"\" })\r\n\t\t\t\t\t\t\taAdd(aInfoDest, \"2\")\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\taAdd(aDadosDest,aInfoDest)\r\n\t\t\t\t\t\tnPos := Len(aDadosDest)\r\n\r\n\t\t\t\t\t\tcString += 'Retorno recebidos no Total R$ #valor , '\r\n\t\t\t\t\t\tcString += 'atraves da ' + Alltrim(aDadosDest[nPos,3]) + ', estabelecida na cidade de ' + alltrim(aDadosDest[nPos,4]) + '/' + alltrim(aDadosDest[nPos,5]) + ', na '\r\n\t\t\t\t\t\tcString += alltrim(aDadosDest[nPos,6]) + ', ' + alltrim(aDadosDest[nPos,7]) + ', inscrita no CNPJ sob nº ' + alltrim(aDadosDest[nPos,8]) + ' e Inscricao Estadual '\r\n\t\t\t\t\t\tcString += alltrim(aDadosDest[nPos,9]) + ' atraves das NFs: '\r\n\t\t\t\t\t\tlMsnOk:= .T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcString += \"NF-e: \"\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += \"Emissão Original NF-e: \"\r\n\t\t\t\tendIf\r\n\t\t\tendif\r\n\r\n\t\t\tcChvNFe += aNfVinc[nZ][2] + aNfVinc[nZ][3] + \"|\"\r\n\t\t\tcNfVinc := ( aNfVinc[nZ][2] + \" \" + aNfVinc[nZ][3] + \" \" + StrZero( Day( aNfVinc[nZ][1] ), 2 ) + \"-\" + StrZero( Month( aNfVinc[nZ][1] ), 2 ) + \"-\" + StrZero( Year( aNfVinc[nZ][1] ), 4 ) + \", \" )\r\n\t\t\tcString += ConvType( cNfVinc, Len( cNfVinc ) ) + \" \"\r\n\t\t\tif SM0->M0_ESTENT == 'SP'  \r\n\t\t\t\tIf Len (aNfVinc[nZ] ) >= 8 .and.  !Empty(aNfVinc[nZ][08]) .And. Len(aValTotOpe) > 0\r\n\t\t\t\t\tnW := Ascan( aValTotOpe, { | e | e[1] == aNfVinc[nZ][7] } )\r\n\t\t\t\t\tIf nW > 0\r\n\t\t\t\t\t\tcString += \"Valor da Operacao do Documento de Origem: \" + ConvType(aValTotOpe[nW][2],15,2) +' '\r\n\t\t\t\t\t\tnVlrTotal:= nVlrTotal + aValTotOpe[nW][2]\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tendif\r\n\t\t\tendif \r\n\t\tEndIf\r\n\tNext nZ\r\n\r\n\tIf lMsnOk //Para totalizar o ultimo cliete/fornecedor\r\n\t\tcString :=  StrTran( cString, \"#valor\", ConvType(nVlrTotal,15,2))\r\n\tEndIf\r\n\r\nEndIf\r\n\r\nIf Len( aRefECF ) > 0\t \t//Nota de espécie ECF vinculada\r\n\tcString += \"Emissao Original CF: \"\r\n\tFor nX := 1  to Len( aRefECF )\r\n\t\tIf !( Alltrim(aRefECF[nX][1]) + Alltrim(aRefECF[nX][2]) + Alltrim(aRefECF[nX][3]) ) $ cChvNFe\r\n\t\t\tcChvNFe += Alltrim(aRefECF[nX][1]) + Alltrim(aRefECF[nX][2]) + Alltrim(aRefECF[nX][3]) + \"|\"\r\n\t\t\tcEcfVinc := Alltrim(aRefECF[nX][2]) + \" \" + Alltrim(aRefECF[nX][1]) +\" \"+ Alltrim(aRefECF[nX][3])\r\n\t\t\tcString += ConvType( cEcfVinc, Len( cEcfVinc ) ) + \" \"\r\n\t\tEndIf\r\n\tNext Nx\r\nEndIf\r\n\r\nIf Len( aNfVincRur ) > 0 \t//Nota de espécie NFP vinculada \r\n\tcString += \"Emissao Original NFP: \"\r\n\tFor nX := 1  to Len( aNfVincRur )\r\n\t\tIf !( aNfVincRur[nX][2] + aNfVincRur[nX][3] ) $ cChvNFe\r\n\t\t\tcChvNFe += aNfVincRur[nX][2] + aNfVincRur[nX][3] + \"|\"\r\n\t\t\tcNfVincRur := ( aNfVincRur[nX][2] + \" \" + aNfVincRur[nX][3] + \" \" + StrZero( Day( aNfVincRur[nx][1] ), 2 ) + \"-\" + StrZero( Month( aNfVincRur[Nx][1] ), 2 ) + \"-\" + StrZero( Year( aNfVincRur[Nx][1] ), 4 ) + \", \" )\r\n\t\t\tcString += ConvType( cNfVincRur, Len( cNfVincRur ) ) + \" \"\r\n\t\tEndIf\r\n\tNext Nx\r\nEndIf\r\n\r\nnValII := 0\r\nFor nX := 1 To Len(aProd)\r\n\tIf Substr(ConvType(aProd[nX,7]),1,1) $ \"3\" \r\n\t\tIf Len(aDI[nx]) > 0 \r\n\t\t\tnValII += aDI[nX][19][03]\r\n\t\tEndIf\r\n\tEndIf\r\nNext\r\nIf nValII > 0\r\n\tIf lEasy .And. IIF(!GetNewPar(\"MV_SPEDEND\",.F.),ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SP\" .and. lEIC0064\r\n\t\tcString += (\"Valor total do Imposto de Importacao : R$ \" + ConvType(nValII,15,2))\r\n\t\tcString += (\" .O valor do Imposto de Importacao nao esta embutido no valor dos produtos, somente ao valor total da NF-e.\")\r\n\tElse\r\n\t\tcString += (\"Valor total do Imposto de Importacao : R$ \" + ConvType(nValII,15,2))\r\n\tEndIf\t\r\nEndif\r\n\r\nIf Len(aRet) > 0 .And. lImpRet\r\n\tcString += \"Retencoes: \"\r\n\tFor nX :=1 to Len(aRet)\r\n\t\tDo Case\r\n\t\t\tCase aRet[nX,1] == \"PIS\"\r\n\t\t\t\tcString += \"PIS: \"+ConvType(aRet[nX,3],15,2)+ \"  \"\r\n\t\t\tCase aRet[nX,1] == \"COFINS\"\r\n\t\t\t\tcString += \t\"COFINS: \" + ConvType(aRet[nX,3],15,2) + \"  \"\r\n\t\t\tCase aRet[nX,1] == \"CSLL\"\r\n\t\t\t\tcString += \"CSLL: \" + ConvType(aRet[nX,3],15,2) + \"  \"\r\n\t\t\tCase aRet[nX,1] == \"IRRF\"\r\n\t\t\t\tcString += \"IR: \" + ConvType(aRet[nX,3],15,2) + \"  \"\r\n\t\t\tCase aRet[nX,1] == \"INSS\"\r\n\t\t\t\tcString += \"INSS: \" + ConvType(aRet[nX,3],15,2) \r\n\t\tEndCase\r\n\tNext\r\nEndIf \r\n\r\nIf nIPIConsig > 0\r\n\tcString += \"Valor do IPI: R$ \" + AllTrim(Transform(nIPIConsig, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf \r\nIf nSTConsig > 0\r\n\tcString += \"Valor do ICMS ST: R$ \" + AllTrim(Transform(nSTConsig, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nendIf\t\r\nIf nValIpiBene > 0 // Quando lIpiBenef = T leva IPI em vOutro e Inf. Adic.\r\n\tcString += \"Valor do IPI: R$ \" + AllTrim(Transform(nValIpiBene, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf\r\n\r\nIf nTotCrdP > 0 // valor de crédito Presumido -  Art.75, XXXII do RICMS/MG\r\n\tcString += \"Valor de crédito Presumido: R$ \" + AllTrim(Transform(nTotCrdP, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf\r\n\r\n// Valor dos tributos por Ente Tributante\r\nIf lMvEnteTrb\r\n\r\n\tIf cMvMsgTrib $ \"1-3\" .And. cTpCliente == \"F\" .And. ( ( nTotFedCrg + nTotEstCrg + nTotMunCrg ) > 0 )\r\n\r\n\t\tcString\t\t+= 'Valor Aproximado do(s) Tributo(s): '\r\n\r\n\t\tIf nTotFedCrg > 0\r\n\t\t\tcPercTrib\t:= PercTrib( Nil , .F., \"1\" )\r\n\t\t\tcString\t\t+= 'R$ ' + ConvType( nTotFedCrg, 15, 2 ) + \" (\"+cPercTrib+\"%) Federal\"\r\n\t\tEndIf\r\n\t\r\n\t\tIf nTotEstCrg > 0\r\n\t\t\tcPercTrib\t:= PercTrib( Nil , .F., \"2\" )\r\n\t\t\tIf nTotFedCrg > 0\r\n\t\t\t\tcString\t+= ' e '\r\n\t\t\tEndif\r\n\t\t\tcString\t\t+= 'R$ ' + ConvType( nTotEstCrg, 15, 2 ) + \" (\"+cPercTrib+\"%) Estadual\"\r\n\t\tEndIf\r\n\t\r\n\t\tIf nTotMunCrg > 0\r\n\t\t\tcPercTrib\t:= PercTrib( Nil , .F., \"3\" )\r\n\t\t\tIf ( nTotFedCrg + nTotEstCrg ) > 0\r\n\t\t\t\tcString\t+= ' e '\r\n\t\t\tEndif\r\n\t\t\tcString\t\t+= 'R$ ' + ConvType( nTotMunCrg, 15, 2 ) + \" (\"+cPercTrib+\"%) Municipal.\"\r\n\t\tEndIf\r\n\t                             \r\n\t\tIf !Empty( cFntCtrb )\r\n\t\t\tIf ( nTotFedCrg + nTotEstCrg + nTotMunCrg ) > 0\r\n\t\t\t\tcString += \" \"\r\n\t\t\tEndif\r\n\t\t\tcString += \"Fonte: \" + cFntCtrb + \".\"\r\n\t\tEndif\r\n\r\n\tEndif\r\n\t\t\r\nElse\r\n\r\n\tIf cMvMsgTrib $ \"1-3\" .And. nTotalCrg > 0 .And. cTpCliente == \"F\"\r\n\t\tlProdItem := .F.\r\n\t\tcPercTrib := PercTrib( nil , lProdItem)   \r\n\t\t\r\n\t\tIf !Empty(cFntCtrb)\r\n\t\t\tcString += 'Valor Aproximado dos Tributos: R$ ' +ConvType(nTotalCrg,15,2)+ \" (\"+cPercTrib+\"%). Fonte: \"+cFntCtrb+\".\"\r\n\t\tElse\r\n\t\t\tcString += 'Valor Aproximado dos Tributos: R$ ' +ConvType(nTotalCrg,15,2)+ \" (\"+cPercTrib+\"%).\"\r\n\t\tEndIf \r\n\tEndIf\r\n\r\nEndif\r\n\r\n//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças - TRGTM2\r\nIf lCustoEntr\r\n\tcString += \"ICMS apurado nos termos do Decreto nº 35.679, de 13 de Outubro de 2010.\"\r\nEndIf\r\n\r\n//Tratamento para adcionar o valor do ICMS desonerado para informação complementar da Danfe.\r\nIf nVicmsDeson >0\r\n\tcString += \"Valor do ICMS Desonerado: R$ \" + AllTrim(Transform(nVicmsDeson, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf\r\nIf nvFCPUFDest > 0 .or.  nvICMSUFDest > 0 .or. nvICMSUFRemet > 0 .or. nvBCUFDest  > 0     \r\n \tIF (IIF(!(GetNewPar(\"MV_SPEDEND\",.F.)),ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"BA\" )   \r\n    cString +=\"Valor da BC do ICMS na UF de destino: R$ \"+ConvType(nvBCUFDest,15,2)+\". \"  \r\n \t\tcString +=\"Percentual do ICMS relativo ao Fundo de Combate a Pobreza - FCP na UF de destino: \"+ConvType(npFCPUFDest)+\"%. \"     //2  pFCPUFDest     nao\r\n \t\tcString +=\"Alíquota interna da UF de destino:  \"+ConvType(npICMSUFDest)+\"%. \"                                                  //3  pICMSUFDest    nao\r\n \t\tcString +=\"Alíquota interestadual das UF envolvidas: \"+cMensDifal+ \". \"\r\n \t\tcString +=\"Percentual provisório de partilha do ICMS Interestadual: \" +ConvType(npICMSIntP)+\"%. \"\r\n \tEndIf                                                                                                                             \t //5  pICMSInterPart nao\r\n \t\tcString +=\"Valor do ICMS relativo ao Fundo de Combate a Pobreza - FCP da UF de destino: R$ \"+ConvType(nvFCPUFDest,15,2)+\". \"       //6  vFCPUFDest\r\n \t\tcString +=\"Valor do ICMS Interestadual para a UF de destino: R$ \"+ConvType(nvICMSUFDest,15,2)+\". \"                                 //7  vICMSUFDest\r\n \t\tcString +=\"Valor do ICMS Interestadual para a UF do remetente: R$ \"+ConvType(nvICMSUFRemet,15,2)+\".\"                               //8  vICMSUFRemet\r\nEndIf \r\n\t\r\ncString:=If(Substr(cString,Len(cString)-1,1) $ \",\",Substr(cString,1,Len(cString)-2),cString)\r\ncString += '</Cpl>' \r\nIf !Empty(AllTrim(cAnfavea))\r\n\tcString += \"<AnfaveaCPL>\" + cAnfavea + \"</AnfaveaCPL>\"\r\nEndIf\r\n\r\nFor nX := 1 To Len(aObsCont)\r\n\tcString += '<obsCont>'\r\n\tcString += '<xCampo>'+Substr(aObsCont[nX][1], 1, 20)+ '</xCampo>'\r\n\tcString += '<xTexto>'+Substr(aObsCont[nX][2], 1, 60)+ '</xTexto>'\r\n\tcString += '</obsCont>'\t\r\nNext nX\r\n\r\n//Processo referenciado\r\nFor nX := 1 To Len(aProcRef)\r\n\tcString += '<procRef>'\r\n\tcString += '<nProc>'+aProcRef[nX][1]+ '</nProc>'\r\n\tcString += '<indProc>'+aProcRef[nX][2]+ '</indProc>'\r\n\tcString += '</procRef>'\t\r\nNext nX\r\n\r\ncString += '</infAdic>'\r\n       \r\n// Tratamento TAG Exportação integração com EEC Average \r\nIf Len(aExp)>0 .And. !Empty(aExp[01])\r\n\tIf lEECFAT\r\n\t/*Se versão 2.00 considera o retorno das posições 1 e 2\r\n\t\tSe versão 3.10, considera array da posição 4 do primeiro item\r\n\t*/\r\n\t\tIf cVerAmb == \"2.00\"\r\n\t\t\tcString += '<exporta>'\r\n\t\t\tcString += '<UFEmbarq>'+ConvType(aExp[01][01][03])+ '</UFEmbarq>'\r\n\t\t\tcString += '<locembarq>'+ConvType(aExp[01][02][03])+ '</locembarq>'\r\n\t\t\tcString += '</exporta>'\t\r\n\t\tEndIf\r\n\t\tIf ( cTipo == \"1\") //Somente se nota de saída ou devolução.\r\n\t\t\tIf !Empty(aExp[01][04][03])\r\n\t\t\t\tcString += '<exporta>'\r\n\t\t\t\tcString += '<UFEmbarq>'+ConvType(aExp[01][04][03][01][03])+ '</UFEmbarq>'\r\n\t\t\t\tcString += '<locembarq>'+ConvType(aExp[01][04][03][02][03])+ '</locembarq>'\t\t\t\t\r\n\t\t\t\tcString += NfeTag('<locdespacho>' ,ConvType(aExp[01][04][03][03][03]))\r\n\t\t\t\tcString += '</exporta>'\r\n\t\t\tEndIf\r\n\t\tEndIf\t\t\r\n\tElseIf ( cTipo == \"1\") \r\n\t\tcString += '<exporta>'\r\n\t\tcString += '<UFEmbarq>'+ConvType(aExp[01][01][01][03])+ '</UFEmbarq>'\r\n\t\tcString += '<locembarq>'+ConvType(aExp[01][01][02][03])+ '</locembarq>'\r\n\t\tIf cVerAmb >= \"3.10\" .And. !Empty(aExp[01][01][07][03])\r\n\t\t\tcString += NfeTag('<locdespacho>' ,ConvType(aExp[01][01][07][03]))\r\n\t\tEndIf\r\n\t\tcString += '</exporta>'\t\r\n\tEndIf\r\nEndIf\r\n\r\nIf Len(aPedido)>0\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tIf !Empty(aPedido[01]) .or. !Empty(aPedido[02]) .or. !Empty(aPedido[03])\r\n\t\t\tcString += '<compra>'\r\n\t\t\tcString += NfeTag('<nEmp>',aPedido[01])\r\n\t\t\tcString += NfeTag('<Pedido>',aPedido[02])\r\n\t\t\tcString += NfeTag('<Contrato>',aPedido[03])\r\n\t\t\tcString += '</compra>'\r\n\t\tEndIf\r\n\tElse\r\n\t\tcString += '<compra>'\r\n\t\tcString += '<nEmp>'+aPedido[01]+'</nEmp>'\r\n\t\tcString += '<Pedido>'+aPedido[02]+'</Pedido>'\r\n\t\tcString += '<Contrato>'+aPedido[03]+'</Contrato>'\r\n\t\tcString += '</compra>'\r\n\tEndIf\r\nEndIf\t\r\n\r\naSize(aInfoDest,0)\r\naInfoDest := Nil\r\naSize(aDadosDest,0)\r\naDadosDest := Nil\r\n\r\nReturn(cString)\r\n\r\nStatic Function ConvType(xValor,nTam,nDec)\r\n\r\nLocal cNovo := \"\"\r\nDEFAULT nDec := 0\r\nDo Case\r\n\tCase ValType(xValor)==\"N\"\r\n\t\tIf xValor <> 0\r\n\t\t\tcNovo := AllTrim(Str(xValor,nTam,nDec))\t\r\n\t\tElse\r\n\t\t\tcNovo := \"0\"\r\n\t\tEndIf\r\n\tCase ValType(xValor)==\"D\"\r\n\t\tcNovo := FsDateConv(xValor,\"YYYYMMDD\")\r\n\t\tcNovo := SubStr(cNovo,1,4)+\"-\"+SubStr(cNovo,5,2)+\"-\"+SubStr(cNovo,7)\r\n\tCase ValType(xValor)==\"C\"\r\n\t\tIf nTam==Nil\r\n\t\t\txValor := AllTrim(xValor)\r\n\t\tEndIf\r\n\t\tDEFAULT nTam := 60\r\n\t\tcNovo := AllTrim(NoAcento(SubStr(xValor,1,nTam)))\r\nEndCase\r\nReturn(cNovo)\r\n\r\nStatic Function Inverte(uCpo, nDig)\r\nLocal cRet\t:= \"\"\r\nDefault nDig := 9\r\n/*\r\nLocal cCpo\t:= uCpo\r\nLocal cByte\t:= \"\"\r\nLocal nAsc\t:= 0\r\nLocal nI\t\t:= 0\r\nLocal aChar\t:= {}\r\nLocal nDiv\t:= 0\r\n*/\r\ncRet\t:=\tGCifra(Val(uCpo),nDig)\r\n/*\r\nAadd(aChar,\t{\"0\", \"9\"})\r\nAadd(aChar,\t{\"1\", \"8\"})\r\nAadd(aChar,\t{\"2\", \"7\"})\r\nAadd(aChar,\t{\"3\", \"6\"})\r\nAadd(aChar,\t{\"4\", \"5\"})\r\nAadd(aChar,\t{\"5\", \"4\"})\r\nAadd(aChar,\t{\"6\", \"3\"})\r\nAadd(aChar,\t{\"7\", \"2\"})\r\nAadd(aChar,\t{\"8\", \"1\"})\r\nAadd(aChar,\t{\"9\", \"0\"})\r\n\r\nFor nI:= 1 to Len(cCpo)\r\n   cByte := Upper(Subs(cCpo,nI,1))\r\n   If (Asc(cByte) >= 48 .And. Asc(cByte) <= 57) .Or. ;\t// 0 a 9\r\n   \t\t(Asc(cByte) >= 65 .And. Asc(cByte) <= 90) .Or. ;\t// A a Z\r\n   \t\tEmpty(cByte)\t// \" \"\r\n\t   nAsc\t:= Ascan(aChar,{|x| x[1] == cByte})\r\n   \tIf nAsc > 0\r\n   \t\tcRet := cRet + aChar[nAsc,2]\t// Funcao Inverte e chamada pelo rdmake de conversao\r\n\t   EndIf\r\n\tElse\r\n\t\t// Caracteres <> letras e numeros: mantem o caracter\r\n\t\tcRet := cRet + cByte\r\n\tEndIf\r\nNext\r\n*/\r\nReturn(cRet)\r\n\r\nStatic Function NfeTag(cTag,cConteudo)\r\n\r\nLocal cRetorno := \"\"\r\nIf (!Empty(AllTrim(cConteudo)) .And. IsAlpha(AllTrim(cConteudo))) .Or. Val(AllTrim(cConteudo))<>0\r\n\tcRetorno := cTag+AllTrim(cConteudo)+SubStr(cTag,1,1)+\"/\"+SubStr(cTag,2)\r\nEndIf\r\nReturn(cRetorno)\r\n\r\nStatic Function VldIE(cInsc,lContr,lIsent)\r\n\r\nLocal cRet\t:=\t\"\"\r\nLocal nI\t:=\t1\r\nDEFAULT lContr  :=      .T.\r\nDEFAULT lIsent  :=      .T.\r\nFor nI:=1 To Len(cInsc)\r\n\tIf Isdigit(Subs(cInsc,nI,1)) .Or. IsAlpha(Subs(cInsc,nI,1))\r\n\t\tcRet+=Subs(cInsc,nI,1)\r\n\tEndif\r\nNext\r\ncRet := AllTrim(cRet)\r\nIf \"ISENT\"$Upper(cRet)\r\n\tcRet := \"\"\r\nEndIf\r\nIf lContr .And. Empty(cRet) .And. lIsent\r\n\tcRet := \"ISENTO\"\r\nEndIf\r\nIf !lContr\r\n\tcRet := \"\"\r\nEndIf\r\nReturn(cRet)\r\n\r\n\r\nstatic FUNCTION NoAcento(cString)\r\nLocal cChar  := \"\"\r\nLocal nX     := 0 \r\nLocal nY     := 0\r\nLocal cVogal := \"aeiouAEIOU\"\r\nLocal cAgudo := \"áéíóú\"+\"ÁÉÍÓÚ\"\r\nLocal cCircu := \"âêîôû\"+\"ÂÊÎÔÛ\"\r\nLocal cTrema := \"äëïöü\"+\"ÄËÏÖÜ\"\r\nLocal cCrase := \"àèìòù\"+\"ÀÈÌÒÙ\" \r\nLocal cTio   := \"ãõÃÕ\"\r\nLocal cCecid := \"çÇ\"\r\nLocal cMaior := \"&lt;\"\r\nLocal cMenor := \"&gt;\"\r\n\r\nFor nX:= 1 To Len(cString)\r\n\tcChar:=SubStr(cString, nX, 1)\r\n\tIF cChar$cAgudo+cCircu+cTrema+cCecid+cTio+cCrase\r\n\t\tnY:= At(cChar,cAgudo)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\r\n\t\tnY:= At(cChar,cCircu)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\r\n\t\tnY:= At(cChar,cTrema)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\r\n\t\tnY:= At(cChar,cCrase)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\t\t\r\n\t\tnY:= At(cChar,cTio)\r\n\t\tIf nY > 0          \r\n\t\t\tcString := StrTran(cString,cChar,SubStr(\"aoAO\",nY,1))\r\n\t\tEndIf\t\t\r\n\t\tnY:= At(cChar,cCecid)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(\"cC\",nY,1))\r\n\t\tEndIf\r\n\tEndif\r\nNext\r\n\r\nIf cMaior$ cString \r\n\tcString := strTran( cString, cMaior, \"\" ) \r\nEndIf\r\nIf cMenor$ cString \r\n\tcString := strTran( cString, cMenor, \"\" )\r\nEndIf\r\n\r\ncString := StrTran( cString, CRLF, \" \" )\r\n\r\nReturn cString\r\n\r\n/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³MyGetEnd  ³ Autor ³ Liber De Esteban             ³ Data ³ 19/03/09 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Verifica se o participante e do DF, ou se tem um tipo de endereco ³±±\r\n±±³          ³ que nao se enquadra na regra padrao de preenchimento de endereco  ³±±\r\n±±³          ³ por exemplo: Enderecos de Area Rural (essa verificção e feita     ³±±\r\n±±³          ³ atraves do campo ENDNOT).                                         ³±±\r\n±±³          ³ Caso seja do DF, ou ENDNOT = 'S', somente ira retornar o campo    ³±±\r\n±±³          ³ Endereco (sem numero ou complemento). Caso contrario ira retornar ³±±\r\n±±³          ³ o padrao do FisGetEnd                                             ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Obs.     ³ Esta funcao so pode ser usada quando ha um posicionamento de      ³±±\r\n±±³          ³ registro, pois será verificado o ENDNOT do registro corrente      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ SIGAFIS                                                           ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/\r\nStatic Function MyGetEnd(cEndereco,cAlias)\r\n\r\nLocal cCmpEndN\t:= SubStr(cAlias,2,2)+\"_ENDNOT\"\r\nLocal cCmpEst\t:= SubStr(cAlias,2,2)+\"_EST\"\r\nLocal aRet\t\t:= {\"\",0,\"\",\"\"}\r\n\r\n//Campo ENDNOT indica que endereco participante mao esta no formato <logradouro>, <numero> <complemento>\r\n//Se tiver com 'S' somente o campo de logradouro sera atualizado (numero sera SN)\r\nIf (&(cAlias+\"->\"+cCmpEst) == \"DF\") .Or. ((cAlias)->(FieldPos(cCmpEndN)) > 0 .And. &(cAlias+\"->\"+cCmpEndN) == \"1\")\r\n\taRet[1] := cEndereco\r\n\taRet[3] := \"SN\"\r\nElse\r\n\taRet := FisGetEnd(cEndereco, (&(cAlias+\"->\"+cCmpEst)))\r\nEndIf\r\n\r\nReturn aRet\r\n\r\n\r\nStatic Function NFSeIde(aNotaServ,cNatOper,cTipoRPS,cModXml)\r\nLocal cString  := \"\"\r\nLocal cRegTrib := \"\"\r\nLocal cOptSimp := \"\"\r\nLocal cIncCult := \"\"\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString += '<InfRps>'\r\n\tcString += '<IdentificacaoRps>'\r\n\tcString += '<Numero>'+ConvType(Val(aNotaServ[02]),15)+'</Numero>'\r\n\tcString += '<Serie>'+AllTrim(aNotaServ[01])+'</Serie>'             \r\n\tcString += '<Tipo>'+cTipoRPS+'</Tipo>'\r\n\tcString += '</IdentificacaoRps>' \r\n\tcString += '<DataEmissao>'+ConvType(aNotaServ[03])+\"T\"+Time()+'</DataEmissao>'\r\n\tcString += '<NaturezaOperacao>'+cNatOper+'</NaturezaOperacao>'\r\n\tcString += '<RegimeEspecialTributacao>'+cRegTrib+'</RegimeEspecialTributacao>'\r\n\tcString += '<OptanteSimplesNacional>'+cOptSimp+'</OptanteSimplesNacional>'\r\n\tcString += '<IncentivadorCultural>'+cIncCult+'</IncentivadorCultural>'\r\n\tcString += '<Status>'+\"1\"+'</Status>'\r\n\t//cString += '<RpsSubstituido>'\r\n\t//cString += '<Numero>'+ConvType(Val(aNotaServ[02]),15)+'</Numero>'\r\n\t//cString += '<Serie>'+AllTrim(aNotaServ[01])+'</Serie>'             \r\n\t//cString += '<Tipo>'+cTipoRPS+'</Tipo>'\r\n\t//cString += '</RpsSubstituido>' \r\n\t\r\nElse//ISSNET\r\n\tcString += '<tc:InfRps>'\r\n\tcString += '<tc:IdentificacaoRps>'\r\n\tcString += '<tc:Numero>'+ConvType(Val(aNotaServ[02]),15)+'</tc:Numero>'\r\n\t//cString += '<tc:Serie>'+'8'+'</tc:Serie>'             \r\n\tcString += '<tc:Serie>'+AllTrim(aNotaServ[01])+'</tc:Serie>'             \r\n\tcString += '<tc:Tipo>'+cTipoRPS+'</tc:Tipo>'\r\n\tcString += '</tc:IdentificacaoRps>' \r\n\tcString += '<tc:DataEmissao>'+ConvType(aNotaServ[03])+\"T\"+Time()+'</tc:DataEmissao>'\r\n\tcString += '<tc:NaturezaOperacao>'+cNatOper+'</tc:NaturezaOperacao>'\r\n\tcString += '<tc:RegimeEspecialTributacao>'+cRegTrib+'</tc:RegimeEspecialTributacao>'\r\n\tcString += '<tc:OptanteSimplesNacional>'+cOptSimp+'</tc:OptanteSimplesNacional>'\r\n\tcString += '<tc:IncentivadorCultural>'+cIncCult+'</tc:IncentivadorCultural>'\r\n\tcString += '<tc:Status>'+\"1\"+'</tc:Status>'\r\n\t//cString += '<tc:RpsSubstituido>'\r\n\t//cString += '<tc:Numero>'+ConvType(Val(aNotaServ[02]),15)+'</tc:Numero>'\r\n\t//cString += '<tc:Serie>'+AllTrim(aNotaServ[01])+'</tc:Serie>'             \r\n\t//cString += '<tc:Tipo>'+cTipoRPS+'</tc:Tipo>'\r\n\t//cString += '</tc:RpsSubstituido>' \r\nEndIf\r\nReturn( cString )\r\n\r\nStatic Function NFSeServ(aISSQN,aRet,nDed,nIssRet,cRetIss,cServ,cMunPres,cModXml,cTpPessoa)\r\nLocal cString    := \"\"\r\nLocal nBase      := 0\r\nLocal nValLiq    := 0\r\nLocal nOutRet    := 0\r\n\r\n//Base de Cálculo \r\nnBase      := aISSQN[02]-nDed-aISSQN[06]\r\n//Valor Líquido\r\nIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\"  // Tratamento realizado para o municipio de Belo Horizonte- MG quando o Tomador for Órgão Público\r\n\tnValLiq    := aISSQN[02]-aRet[06]-aISSQN[06]-aISSQN[05]\r\nElse\r\n\tnValLiq    := aISSQN[02]-aRet[06]-aISSQN[06]\r\nEndIf\r\n//Outras retenções\r\nnOutRet    := aRet[06]-aRet[05]-aRet[04]-aRet[03]-aRet[02]-aRet[01]\r\n\r\nIf nOutRet > 0\r\n\tnOutRet:= nOutRet-nIssRet\r\nEndIf\r\n\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString += '<Servico>'\r\n\tcString += '<Valores>'\r\n\tcString += '<ValorServicos>'+ConvType(aISSQN[02],15,2)+'</ValorServicos>'\r\n\tcString += NfeTag('<ValorDeducoes>',ConvType(nDed,15,2))\r\n\tcString += NfeTag('<ValorPis>',ConvType(aRet[03],15,2))\r\n\tcString += NfeTag('<ValorCofins>',ConvType(aRet[04],15,2))\r\n\tcString += NfeTag('<ValorInss>',ConvType(aRet[05],15,2))\r\n\tcString += NfeTag('<ValorIr>',ConvType(aRet[01],15,2))\r\n\tcString += NfeTag('<ValorCsll>',ConvType(aRet[02],15,2))\r\n\tcString += '<IssRetido>'+cRetIss+'</IssRetido>'\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\"\r\n\t\tcString += NfeTag('<ValorIss>0.00</ValorIss>') \r\n\tElse\r\n\t\tcString += NfeTag('<ValorIss>',ConvType((aISSQN[05]),15,2)) \r\n\tEndIf\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\" \r\n\t\tcString += NfeTag('<ValorIssRetido>0.00</ValorIssRetido>') \r\n\tElse\r\n\t\tcString += NfeTag('<ValorIssRetido>',ConvType(nIssRet,15,2)) \r\n\tEndIf\r\n\tcString += NfeTag('<OutrasRetencoes>',ConvType(nOutRet,15,2))\r\n\tcString += '<BaseCalculo>'+ConvType(nBase,15,2)+'</BaseCalculo>'\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\" \r\n\t\tcString += NfeTag('<Aliquota>0.00</Aliquota>')\r\n\tElse\r\n\t\tcString += NfeTag('<Aliquota>',ConvType(aISSQN[04],5,2))\r\n\tEndIf\r\n\tcString += NfeTag('<ValorLiquidoNfse>',ConvType(nValLiq,15,2))\r\n\tcString += NfeTag('<DescontoIncondicionado>',ConvType((aISSQN[06]),15,2))\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\" \r\n\t\tcString += NfeTag('<DescontoCondicionado>',ConvType((aISSQN[05]),15,2))\r\n\tEndIf\r\n\t//cString += '<DescontoCondicionado>'++'</DescontoCondicionado>'\r\n\tcString += '</Valores>'\r\n\t//cString += '<ItemListaServico>'+ConvType(StrTran(aISSQN[01],\".\",\"\"),4)+'</ItemListaServico>'\r\n\tcString += '<ItemListaServico>'+ConvType(aISSQN[01],5)+'</ItemListaServico>'\r\n\tcString += NfeTag('<CodigoCnae>',ConvType(aISSQN[03],7))\r\n\t//cString += '<CodigoTributacaoMunicipio>'+'710'+'</CodigoTributacaoMunicipio>'\r\n\tcString += '<CodigoTributacaoMunicipio>'+ConvType(aISSQN[07],20)+'</CodigoTributacaoMunicipio>'\r\n\tcString += '<Discriminacao>'+ConvType(cServ,2000)+'</Discriminacao>'\r\n\tcString += '<CodigoMunicipio>'+ConvType(cMunPres,7)+'</CodigoMunicipio>'\r\n\tcString += '</Servico>'\r\n\t\r\nElse //ISSNET\r\n\tcString += '<tc:Servico>'\r\n\tcString += '<tc:Valores>'\r\n\tcString += '<tc:ValorServicos>'+ConvType(aISSQN[02],15,2)+'</tc:ValorServicos>'\r\n\tcString += NfeTag('<tc:ValorDeducoes>',ConvType(nDed,15,2))\r\n\tcString += NfeTag('<tc:ValorPis>',ConvType(aRet[03],15,2))\r\n\tcString += NfeTag('<tc:ValorCofins>',ConvType(aRet[04],15,2))\r\n\tcString += NfeTag('<tc:ValorInss>',ConvType(aRet[05],15,2))\r\n\tcString += NfeTag('<tc:ValorIr>',ConvType(aRet[01],15,2))\r\n\tcString += NfeTag('<tc:ValorCsll>',ConvType(aRet[02],15,2))\r\n\tcString += '<tc:IssRetido>'+cRetIss+'</tc:IssRetido>'\r\n\tIf aISSQN[05] > 0\r\n\t\tcString += NfeTag('<tc:ValorIss>',ConvType((aISSQN[05]),15,2))\r\n\tElse\r\n\t\tcString += '<tc:ValorIss>0.00</tc:ValorIss>'\r\n\tEndIf\t\t\r\n\tcString += NfeTag('<tc:ValorIssRetido>',ConvType(nIssRet,15,2))\r\n\tcString += NfeTag('<tc:OutrasRetencoes>',ConvType(nOutRet,15,2))\r\n\tcString += '<tc:BaseCalculo>'+ConvType(nBase,15,2)+'</tc:BaseCalculo>'\r\n\tIf  aISSQN[04] > 0\t\r\n\t\tcString += NfeTag('<tc:Aliquota>',ConvType(aISSQN[04],5,2))\r\n\telse\r\n\t\tcString += '<tc:Aliquota>0.00</tc:Aliquota>'\r\n\tendif\t\t\r\n\tcString += NfeTag('<tc:ValorLiquidoNfse>',ConvType(nValLiq,15,2))\r\n\tcString += '<tc:DescontoIncondicionado>'+ConvType((aISSQN[06]),15,2)+'</tc:DescontoIncondicionado>'\r\n\tcString += '<tc:DescontoCondicionado>0</tc:DescontoCondicionado>'\r\n\tcString += '</tc:Valores>'\r\n\t//cString += '<tc:ItemListaServico>'+ConvType(StrTran(aISSQN[01],\".\",\"\"),4)+'</tc:ItemListaServico>'\r\n\tcString += '<tc:ItemListaServico>'+ConvType(aISSQN[01],4)+'</tc:ItemListaServico>'\r\n\tcString += NfeTag('<tc:CodigoCnae>',ConvType(aISSQN[03],7))\r\n\t//cString += '<tc:CodigoTributacaoMunicipio>'+'710'+'</tc:CodigoTributacaoMunicipio>'\r\n\tcString += '<tc:CodigoTributacaoMunicipio>'+ConvType(aISSQN[07],20)+'</tc:CodigoTributacaoMunicipio>'\r\n\tcString += '<tc:Discriminacao>'+ConvType(cServ,2000)+'</tc:Discriminacao>'\r\n\tcString += '<tc:MunicipioPrestacaoServico>'+Iif(Len(cMunPres) == 9,substr(cMunPres,3,7),ConvType(cMunPres,7))+'</tc:MunicipioPrestacaoServico>'\r\n\t//cString += '<tc:MunicipioPrestacaoServico>999</tc:MunicipioPrestacaoServico>'\r\n\tcString += '</tc:Servico>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NFSePrest(cModXml)\r\nLocal cString    := \"\"\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString +='<Prestador>'\r\n\tcString += '<Cnpj>'+SM0->M0_CGC+'</Cnpj>'\r\n\tcString += NfeTag('<InscricaoMunicipal>',ConvType(SM0->M0_INSCM))\r\n\tcString +='</Prestador>'\r\nElse //ISSNET\r\n\tcString +='<tc:Prestador>'\r\n\tcString +='<tc:CpfCnpj>'\r\n\tcString += '<tc:Cnpj>'+SM0->M0_CGC+'</tc:Cnpj>'\r\n\tcString +='</tc:CpfCnpj>'\r\n\tcString += NfeTag('<tc:InscricaoMunicipal>',ConvType(SM0->M0_INSCM))\r\n\tcString +='</tc:Prestador>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NFSeTom(aDest,cModXml,cMunPres)\r\nLocal cCPFCNPJ :=\"\"\r\nLocal cInscMun :=\"\"\r\nLocal cString  :=\"\"\r\n\r\n//Identifica Tipo\r\nIf RetPessoa(AllTrim(aDest[01]))==\"J\"\r\n\tcCPFCNPJ:=\"2\"\r\nElse\r\n\tcCPFCNPJ:=\"1\"\r\nEndIf\r\n//Identifica Inscricao\r\nIf AllTrim(cMunPres)==AllTrim(SM0->M0_CODMUN)\r\n\tcInscMun:=aDest[11]\r\nEndIf\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString +='<Tomador>'\r\n\tcString +='<IdentificacaoTomador>'\r\n\t//Estrangeiro não manda a tag de CPFCNPJ\r\n\tIf !\"EX\"$aDest[08]\r\n\t\tcString +='<CpfCnpj>'\r\n\t\t\tIf \"2\"$cCPFCNPJ\r\n\t\t\t\tcString += NfeTag('<Cnpj>',ConvType(aDest[01]))\r\n\t\t\tElse\r\n\t\t\t\tcString += NfeTag('<Cpf>',ConvType(aDest[01]))\r\n\t\t\tEndIf\r\n\t\tcString +='</CpfCnpj>'\r\n\tEndIf\r\n\tcString += NfeTag('<InscricaoMunicipal>',ConvType(cInscMun))\r\n\tcString +='</IdentificacaoTomador>'\r\n\tcString += NfeTag('<RazaoSocial>',ConvType(aDest[02],115))\r\n\t\r\n\tcString +='<Endereco>'\r\n\tcString += NfeTag('<Endereco>',ConvType(aDest[03],125))\r\n\tcString += NfeTag('<Numero>',ConvType(aDest[04],10))\r\n\tcString += NfeTag('<Complemento>',ConvType(aDest[05],60))\r\n\tcString += NfeTag('<Bairro>',ConvType(aDest[06],60))\r\n\tcString += NfeTag('<CodigoMunicipio>',ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[08]})][02]+aDest[07]))\r\n\tcString += NfeTag('<Uf>',ConvType(aDest[08]))\r\n\tcString += NfeTag('<Cep>',ConvType(aDest[09]))\r\n\tcString +='</Endereco>'\r\n\t\r\n\tcString +='<Contato>'\r\n\tcString += NfeTag('<Telefone>',AllTrim(ConvType(FisGetTel(aDest[10])[3],11)))\r\n\tcString += NfeTag('<Email>',ConvType(aDest[12],80))\r\n\tcString +='</Contato>'\r\n\tcString +='</Tomador>'\r\n\t\r\n\t//cString +='<Intermediario>'\r\n\t//cString += '<RazaoSocial>'+'</RazaoSocial>'\r\n\t//cString +='<CpfCnpj>'\r\n\t//cString += '<Cpf>'+'</Cpf>'\r\n\t//cString += '<Cnpj>'+'</Cnpj>'\r\n\t//cString +='</CpfCnpj>'\r\n\t//cString += '<InscricaoMunicipal>'+'</InscricaoMunicipal>'\r\n\t//cString +='</Intermediario>'\r\n\t\r\n\t//cString +='<Construcao>'\r\n\t//cString += '<CodigoObra>'+'</CodigoObra>'\r\n\t//cString += '<Art>'+'</Art>'  \r\n\t//cString +='</Construcao>'\r\n\tcString +='</InfRps>'\r\n\t\r\nElse //ISSNET\r\n\tcString +='<tc:Tomador>'\r\n\tcString +='<tc:IdentificacaoTomador>'\r\n\tcString +='<tc:CpfCnpj>'\r\n\tif \"EX\"$aDest[08]\r\n\t    cString += NfeTag('<tc:Cnpj>','99999999999999')\r\n\tElse\r\n\t\tIf \"2\"$cCPFCNPJ\r\n\t\t\tcString += NfeTag('<tc:Cnpj>',ConvType(aDest[01]))\r\n\t\tElse\r\n\t\t\tcString += NfeTag('<tc:Cpf>',ConvType(aDest[01]))\r\n\t\tEndIf\r\n\tEndIf\r\n\tcString +='</tc:CpfCnpj>'\r\n\tcString += NfeTag('<tc:InscricaoMunicipal>',ConvType(cInscMun))\r\n\tcString +='</tc:IdentificacaoTomador>'\r\n\tcString += NfeTag('<tc:RazaoSocial>',ConvType(aDest[02],115))\r\n\t\r\n\tcString +='<tc:Endereco>'\r\n\tcString += NfeTag('<tc:Endereco>',ConvType(aDest[03],125))\r\n\tcString += NfeTag('<tc:Numero>',ConvType(aDest[04],10))\r\n\tcString += NfeTag('<tc:Complemento>',ConvType(aDest[05],60))\r\n\tcString += NfeTag('<tc:Bairro>',ConvType(aDest[06],60))\r\n\tIf \"EX\"$aDest[08]\r\n\t\tcString += NfeTag('<tc:Cidade>','99999')\r\n\tElse\r\n\t\tcString += NfeTag('<tc:Cidade>',ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[08]})][02]+aDest[07]))\r\n\tEndIf\r\n\r\n\tcString += NfeTag('<tc:Estado>',ConvType(aDest[08]))\r\n\tcString += NfeTag('<tc:Cep>',ConvType(aDest[09]))\r\n\tcString +='</tc:Endereco>'\r\n\t\r\n\tcString +='<tc:Contato>'\r\n\tcString += NfeTag('<tc:Telefone>',ConvType(aDest[10],11))\r\n\tcString += NfeTag('<tc:Email>',ConvType(aDest[12],80))\r\n\tcString +='</tc:Contato>'\r\n\tcString +='</tc:Tomador>'\r\n\t\r\n\t//cString +='<tc:Intermediario>'\r\n\t//cString += '<tc:RazaoSocial>'+'</tc:RazaoSocial>'\r\n\t//cString +='<tc:CpfCnpj>'\r\n\t//cString += '<tc:Cpf>'+'</tc:Cpf>'\r\n\t//cString += '<tc:Cnpj>'+'</tc:Cnpj>'\r\n\t//cString +='</tc:CpfCnpj>'\r\n\t//cString += '<tc:InscricaoMunicipal>'+'</tc:InscricaoMunicipal>'\r\n\t//cString +='</tc:Intermediario>'\r\n\t\r\n\t//cString +='<tc:Construcao>'\r\n\t//cString += '<tc:CodigoObra>'+'</tc:CodigoObra>'\r\n\t//cString += '<tc:Art>'+'</tc:Art>'  \r\n\t//cString +='</tc:Construcao>'\r\n\tcString +='</tc:InfRps>'\r\nEndIf\r\nReturn(cString)\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} LgxMsgNfs()\r\nFuncao que verifica os vinculos entre pedidos de venda e realiza o \r\ntratamento do texto do C5_MENNOTA quando a origem do PV é igual a 'LOGIX'\r\n\r\n@author Caio Murakami       \r\n@since 12.12.2012\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function LgxMsgNfs()\r\nLocal aAreaSC5\t:= SC5->( GetArea() )\r\nLocal aAreaSC6 := SC6->( GetArea() )\r\nLocal aArea\t\t:= GetArea()  \r\nLocal aPedVinc\t:= {} \r\nLocal nX \t\t:= 0 \r\nLocal cPedVinc\t:= \"\"  \r\nLocal cChave\t:= \"\"  \r\nLocal lAtuSC5\t:= .F. \r\nLocal cMsgNfs  := SC5->C5_MENNOTA\r\nLocal cNumPed \t:= SC5->C5_NUM \r\n\r\nIf SC6->( FieldPos(\"C6_PEDVINC\") ) > 0 .And. !Empty(SC6->C6_PEDVINC)  \r\n\t\r\n\tcPedVinc := SC6->C6_PEDVINC \r\n\t\t\r\n   SC5->( dbSetOrder(1) ) \r\n\tSC6->( dbSetOrder(1) )      \r\n\t\r\n\tIf SC5->( MsSeek( cChave := xFilial(\"SC5\") + cPedVinc ) )\t\r\n\t   \r\n\t   If SC6->( MsSeek( cChave )  )\r\n\t   \t//-- Percorre itens de pedido de venda relacionado o número do pedido com a NF , Série e Data\r\n\t   \tWhile SC6->( C6_FILIAL+C6_NUM ) == cChave .And.  !SC6->( Eof() ) \r\n\t   \t\t\r\n\t   \t\tIf !Empty(SC6->C6_NOTA)    \t\t\r\n\t   \t\t\tIf Ascan( aPedVinc, { | e | e[1]+e[2] == SC6->(C6_NOTA+C6_SERIE) } ) == 0\r\n\t\t   \t\t\tAadd( aPedVinc, { SC6->C6_NOTA , SC6->C6_SERIE , SC6->C6_DATFAT  }  ) \r\n\t\t   \t\tEndIf\r\n\t\t   \tEndIf\r\n\t\t   \t\t   \t\t\r\n\t   \t\tSC6->( dbSkip() )  \r\n\t   \t\t\r\n\t   \tEndDo\r\n\t   EndIf   \r\n\tEndIf \r\n\t//-- Atualiza mensagem do pedido, @N ( Numero da NF ) ; @S ( Série da NF) ; @D ( Data emissao )\r\n\tFor nX := 1 To Len(aPedVinc)\r\n\t\t\r\n\t\tcMsgNfs := StrTran( cMsgNfs , '@N' , aPedVinc[nX,1] \t\t \t,, 1 )\r\n\t\tcMsgNfs := StrTran( cMsgNfs , '@S' , aPedVinc[nX,2] \t\t \t,, 1 )\r\n\t\tcMsgNfs := StrTran( cMsgNfs , '@D' , dToC(aPedVinc[nX,3])\t,, 1 )\r\n\t\t\r\n\t\tIf At('@N' , cMsgNfs ) == 0\r\n\t\t\tlAtuSC5 := .T.\t \r\n\t\t\tExit\r\n\t\tEndIf\t\t\t\r\n\t\t\t   \r\n\tNext nX  \r\n\t\r\n\t//-- Atualiza C5_MENNOTA do pedido de venda posicionado inicialmente\r\n\tIf lAtuSC5 .And. SC5->( MsSeek( xFilial(\"SC5\") + cNumPed )   ) \r\n\t\tIf AllTrim(SC5->C5_MENNOTA) <> AllTrim(cMsgNfs)\r\n\t\t\tRecLock( \"SC5\" , .F. )\r\n\t\t\tSC5->C5_MENNOTA := cMsgNfs\r\n\t\t\tMsUnLock()\t\r\n\t\tEndIf\r\n\tEndIf\r\n  \r\nEndIf    \r\n \r\nRestArea( aAreaSC5 )\r\nRestArea( aAreaSC6 )\r\nRestArea( aArea    )\r\n\r\nReturn NIL  \r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} RetNfpVinc()\r\nFuncao que verifica se existe nota de NFP vinculada a Nota , e retorna o \r\narrey com as informações da nota de NFP\r\n\r\n@author Fernando Bastos       \r\n@since 03.01.2013\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function RetNfpVinc(cDocNFP,cSerieNFP,cForneceNFP,cLojaNFP)\r\n\r\nlocal nOrderSF1\t:= 0\r\nlocal nRecnoSF1\t:= 0\t\r\nlocal nOrderSD1\t:= 0\t\r\nlocal nRecnoSD1\t:= 0\r\n\r\nLocal aNfViRuNFP:={}\r\n\r\n\t// Realiza o backup do order e recno da SF1 e SD1\r\n\tnOrderSF1\t:= SF1->( indexOrd() )\r\n\tnRecnoSF1\t:= SF1->( recno() ) \r\n\t\r\n\tnOrderSD1\t:= SD1->( indexOrd() )\r\n\tnRecnoSD1\t:= SD1->( recno() )\r\n\t\t\r\n\tSD1->(dbSetOrder(1))\r\n\t\tIf SD1->(dbSeek(xFilial(\"SD1\")+SD1->D1_NFORI+SD1->D1_SERIORI))//D1_NFORI,D1_SERIORI\r\n   \t\t\t\tSF1->(dbSetOrder(1))\r\n   \t\t\t\tIf SF1->(dbSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA) .And. AllTrim(SF1->F1_ESPECIE)==\"NFP\")\r\n\t   \t\t\taadd(aNfViRuNFP,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA2->A2_CGC),; \r\n\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA2->A2_EST),; \r\n\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA2->A2_INSCR)})\t\r\n\t\t\tEndif\r\n\t\tEndif\r\n   \t// Restaura a ordem e recno da SF1 e SD1\r\n\tSF1->( dbSetOrder( nOrderSF1 ) )\r\n\tSF1->( dbGoTo( nRecnoSF1 ) )\r\n\t\t\t        \r\n\tSD1->( dbSetOrder( nOrderSD1 ) )\r\n\tSD1->( dbGoTo( nRecnoSD1 ) )\r\n\t\t\t\t\t\t\t\t\r\nReturn (aNfViRuNFP) \r\n\r\n//------------------------------------------------------------------------\r\n/*/{Protheus.doc} MsgCliRsIcm\r\nFuncao que retorna a mensagem para ser colocada nos dados adicionais da NFe,\r\nreferente ao RICMS do RIO GRANDE do SUL:\r\nLivro II , Art.29 , Inciso VII, Alinea \"a\" numero 1\r\nLivro III, Art. 26 \r\n\r\n@author Rafael Iaquinto    \r\n@since 22.05.2013\r\n@version 1.0  \r\n\r\n@param\t\taICMS\t\tArray com informações referente ao ICMS proprio\r\n@param\t\taICMSST\tArray com informações referente ao ICMS-ST\r\n\t\t\t\r\n@return\tcMsg\t\tRetorna a Mensagem a ser utilizada.\t\r\n\r\n/*/\r\n//------------------------------------------------------------------------                                                        \r\nStatic Function MsgCliRsIcm(aICMS, aICMSST)\r\n\r\nLocal cMsg \t\t:= \"\"\r\n\r\nLocal nX\t\t\t:= \"\"\r\nLocal nValIcm\t\t:= 0\r\nLocal nValST\t\t:= 0 \r\nLocal nBaseIcm\t\t:= 0\r\nLocal nBaseST\t\t:= 0\r\n\r\nLocal lIcmsST\t\t:= .F.\r\nLocal lIcms\t\t:= .F.\r\nLocal lIcmsSemSt\t:= .F.\r\n\r\nFor nX := 1 to Len( aICMS )\r\n\t\r\n\tlIcms := .F.\r\n\t\r\n\tIf Len( aICMS[nX] ) > 0 .And. aICMS[nX][07] > 0\r\n\t\t\r\n\t\tnValIcm \t+= aICMS[nX][07] \r\n\t\tnBaseIcm\t+= aICMS[nX][05]\r\n\t\t\r\n\t\tif len( aICMSSt[nX] ) > 0 .and. aICMSSt[nX][07] > 0 \r\n\t\t\tnValST\t\t+= aICMS[nX][07] \r\n\t\t\tnBaseST\t+= aICMS[nX][05]\r\n\t\tendif\r\n\t\t\r\n\t\tlIcms := .T.\r\n\t\t\t\t\r\n\tEndIf\r\n\t\r\n\tIf Len( aICMSSt[nX] ) > 0 .And. aICMSSt[nX][07] > 0 \t\t\r\n\t\t\r\n\t\tlIcmsST := .T.\r\n\t\t\t\t\t\t\r\n\tElseIf lIcms .And. !lIcmsSemSt  \r\n\t\tlIcmsSemSt := .T.\r\n\tEndIF\r\n\t \t\r\nNext nX\r\n\r\nIf lIcmsSemSt .And. lIcmsST\r\n\r\n\tcMsg += \"Operações não sujeitas a Regime de ST, \"\r\n\tcMsg += \"Base de Cálculo do ICMS próprio: R$ \" + Alltrim( Str(nBaseIcm-nBaseST, 14, 2) )+ \", \"\r\n\tcMsg += \"Valor do ICMS próprio: R$ \" + Alltrim( Str(nValIcm-nValST, 14, 2) )+ \". \"\r\n\tcMsg += \"Operações sujeitas a Regime de ST, \" \t\t\t\r\n\tcMsg += \"Base de cálculo do ICMS próprio : R$ \" + Alltrim( Str(nBaseST, 14, 2) )+ \", \"\r\n\tcMsg += \"Valor do ICMS próprio: R$ \" + Alltrim( Str(nValST, 14, 2) )+ \". \"\r\n\t\r\nEndIf\r\n\r\n\r\nreturn cMsg\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} DocDatOrig\r\nFuncao criada para retornar para a função XmlNfeSef os valores da Nota Original quando houver controle de SubLote\r\n\r\n@param\t\tcNumLote\tNúmero do SubLote.\r\n@param\t\tcLoteClt\tNúmero do lote.\r\n@param \t\tcProduto   Codigo do produto\r\n\r\n\t\t\r\n@return\tnil\r\n\r\n@author\tEduardo Silva\r\n@since\t\t22/01/2014\r\n@version\t11.8\r\n/*/\r\n//-----------------------------------------------------------------------\r\n\r\nStatic Function DocDatOrig(cNumLote,cLoteCtl,cProduto)\r\n\r\nLocal aArea\t\t := GetArea()\r\n\r\nLocal cAliasSFT\t:= GetNextAlias()\r\nLocal cCliFor\t\t:= \"\"\r\nLocal cData\t\t:= \"\"\r\nLocal cLocCQ    \t:= PADR(SuperGetMV(\"MV_CQ\"),TAMSX3(\"D7_LOCAL\")[1])  //adequo o conteudo padrão \"98\" para \"98 \"\r\nLocal cLoja\t\t:= \"\"\r\nLocal cNfiscal\t\t:= \"\"\r\nLocal cNumCQ\t\t:= \"\"\r\nLocal cNfOrig\t\t:= \"\"\r\nLocal cSeek\t\t:= \"\"        \r\nLocal cSeek1\t\t:= \"\"        \r\nLocal cSerie\t\t:= \"\"\r\nLocal cSerieOri\t:= \"\"\r\n                     \r\ndbSelectArea(\"SB8\")\r\ndbSetOrder(2)\r\nif MsSeek(xFilial(\"SB8\")+cNumLote+cLoteCtl+cProduto)      \t\t\r\n\t\t\t\t\r\n\tdbSelectArea(\"SD7\")\r\n\tSD7->(dbSetOrder(1))\r\n\tcNumCQ := PADR(SB8->B8_DOC,LEN(SD7->D7_NUMERO))\t\t\t\t\t \t\t\r\n\tif SD7->(MsSeek(SB8->B8_FILIAL+cNumCQ+cProduto+cLocCQ))      \t\t\t\t\t\r\n\t\tcNfiscal\t:= SD7->D7_DOC\r\n\t\tcSerie \t\t:= SD7->D7_SERIE \r\n\t\tcCliFor\t:= SD7->D7_FORNECE\r\n\t\tcLoja \t\t:= SD7->D7_LOJA\r\n\telse\t\t\t\r\n\t\tcNfiscal\t:= SB8->B8_DOC\r\n\t\tcSerie\t\t:= SB8->B8_SERIE\r\n\t\tcCliFor\t:= SB8->B8_CLIFOR\r\n\t\tcLoja \t\t:= SB8->B8_LOJA \t\t\t\t\t\t\t\t\t\r\n\tendif\t\t\t\t\r\n\t\r\n\tcSeek\t:= cCliFor+cLoja+cSerie+cNfiscal\t\t\r\n\tcSeek1\t:= cNfiscal+cSerie+cCliFor+cLoja+cProduto+cLoteCtl+cNumLote\r\nendif\r\n\t\t\r\nif len (cSeek)>0 \r\n\t\t\t\r\n\tBeginSql Alias cAliasSFT\r\n\t\tSELECT FT_PRODUTO,FT_EMISSAO,FT_NFISCAL,FT_SERIE,FT_BASERET,FT_ICMSRET\r\n\t\t\tFROM %Table:SFT% SFT\r\n\t\t\tWHERE\r\n\t\t\tSFT.FT_FILIAL = %xFilial:SFT% AND\r\n\t\t\tSFT.%NotDel% AND \r\n\t\t\tFT_NFISCAL\t=%Exp:cNfiscal% AND\r\n\t\t\tFT_SERIE  \t=%Exp:cSerie% AND\r\n\t\t\tFT_TIPOMOV\t=%Exp:\"E\" % AND\r\n\t\t\tFT_CLIEFOR\t=%Exp:cCliFor% AND\r\n\t\t\tFT_LOJA\t=%Exp:cLoja% AND\r\n\t\t\tFT_ITEM\t=%Exp:SD1->D1_ITEM% AND \t\t\t\t\t\t\r\n\t\t\tFT_PRODUTO\t=%Exp:cProduto%\r\n\tEndSql\r\n\t\t\r\n\tif (cAliasSFT)->(!Eof()) \r\n\t\tcData \t\t:= (cAliasSFT)->FT_EMISSAO\r\n\t\tcNfOrig\t:= (cAliasSFT)->FT_NFISCAL\r\n\t\tcSerieOri\t:= (cAliasSFT)->FT_SERIE\t\r\n\tendif\r\n\t\t\r\n\t(cAliasSFT)->(DBCLOSEAREA())\r\n\t\r\nendif\r\n\r\nRestArea(aArea)\r\nReturn({dtoc(stod(cData)),cNfOrig,cSerieOri})\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} PercTrib\r\nRetorna a porcentagem a ser impresso no DANFE para a Lei Transparencia (Lei 12.741)\r\n\r\n\r\n@param\taProd\t\tContendo as informacoes do(s) produto(s).\r\n@param\tlProdItem\tIdentifica se a mensagem da Lei da Transparencia sera gerado\r\n\t\t\t\t\tno Produto e/ou informacoes complementares.\r\n@param\tcEnte\t\tEnte Tributante: 1-Federal / 2-Estadual / 3-Municipal\r\n@param  aNota\t\tContendo as informacoes da nota.\r\n\r\n@return cPercTrib Porcentagem do Tributo\r\n\r\n@author Douglas Parreja\r\n@since 26/06/2014\r\n@version 12\r\n/*/\r\n//-----------------------------------------------------------------------\r\n\r\nStatic Function PercTrib( aProd, lProdItem, cEnte, aNota ) \r\n\r\nLocal aArea\t\t\t:= GetArea()\r\nLocal aAreaSB1\t\t:= SB1->( GetArea() )\r\n\r\n//Local nAliquota\t\t:= 0\r\n//Local nTributo\t\t:= 0\r\n//Local nTotTrib\t\t:= 0\r\nLocal cPercTrib\t\t:= \"\"\r\nLocal nPos\t\t\t:= 30\r\nLocal nTotCargaTrib\t:= nTotalCrg\r\nLocal nAliq\t\t\t:= 0\r\n\r\nDefault aProd \t\t:= {}            \r\nDefault lProdItem \t:= .F.\r\nDefault cEnte\t\t:= \"\"\r\nDefault aNota\t\t:= {}\r\n\r\nIf lMvEnteTrb .And. ( cEnte $ \"1-2-3\" )\r\n\t\r\n\tIf cEnte == \"1\"\t// FEDERAL\r\n\r\n\t\tnPos \t\t\t:= 35\r\n\t\tnTotCargaTrib\t:= nTotFedCrg\r\n\r\n\tElseIf cEnte == \"2\"\t// ESTADUAL\r\n\r\n\t\tnPos\t\t\t:= 36\r\n\t\tnTotCargaTrib\t:= nTotEstCrg\r\n\r\n\tElse\r\n\r\n\t\tnPos \t\t\t:= 37\r\n\t\tnTotCargaTrib\t:= nTotMunCrg\r\n\r\n\tEndif\r\n\t\r\nEndif\r\n\r\nIf lProdItem\r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1) // B1_FILIAL+B1_COD\r\n\t\r\n\tIf dbSeek( xFilial(\"SB1\") + AllTrim( aProd[2] ) )\r\n\t\r\n\t\tnAliq\t:= LeiTransp(nPos,aProd, aNota)\r\n\t\tcPercTrib := ConvType( nAliq * 100 , 15, 2 )\r\n\t\t\r\n\t /*\t\r\n\txRetVal := AlqLei2741(aProd[5],aProd[6],SB1->B1_CODISS,SA1->A1_EST,SA1->A1_COD_MUN,aProd[2],aProd[1],SD2->D2_NUMLOTE,SD2->D2_LOTECTL,cMvFisCTrb,cMvFisAlCT,lMvFisFRas)\t\r\n\t\r\n\t\tIf ValType(xRetVal)== \"A\"\r\n\t\t\tcPercTrib := ConvType( xRetVal[1], 15, 2 )\r\n\t\tElseIf ValType(xRetVal)== \"N\"\r\n\t\t\tcPercTrib := ConvType( xRetVal, 15, 2 )\r\n\t\tEndIf\r\n\t\t\r\n\t\tnAliquota\t:= AlqLeiTran( \"SB1\", \"SBZ\" )[1]    \r\n\t\tnTributo\t:= ConvType( ( aProd[nPos] * nAliquota ) / 100, 15, 2 )\r\n\t\tnTotTrib\t:= Val( nTributo )\r\n\t\r\n\t\tcPercTrib\t:= ConvType( ( nTotTrib / aProd[10] ) * 100, 15, 2 )*/\r\n\t\r\n\tEndif\r\n\r\nElse\r\n\r\n\tcPercTrib\t:= ConvType( ( nTotCargaTrib / nTotNota ) * 100, 15, 2 )\r\n\r\nEndIf\t\r\n\t\r\nRestArea( aAreaSB1 )\r\nRestArea( aArea )\t\r\n\r\nReturn cPercTrib\r\n\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} LeiTransp\r\nRetorna a porcentagem a ser impresso no por documento gerado \r\nDANFE para a Lei Transparencia (Lei 12.741) \r\n\r\n\r\n@param\tnPos \tPosição ref. Aliq. Tributante: 30 - Aliquota Total\r\n\t\t\t\t\t\t\t35-Federal / 36-Estadual / 37-Municipal\r\n\r\n@return nAliq\t\tAliquota do Produto\r\n\r\n@author Douglas Parreja\r\n@since 19/12/2014\r\n@version 11.80\r\n/*/\r\n//-----------------------------------------------------------------------\r\n\r\nStatic Function LeiTransp (nPos,aProd,aNota)\r\n\r\nLocal nAliq := 0\r\nLocal aAreaSD2 := SD2->( GetArea() )\r\n\r\nDefault nPos\t:= 30\r\nDefault aProd :={}\r\nDefault aNota :={}\r\n\r\nDbSelectArea(\"SD2\")\r\nDbSetOrder(3) // D2_FILIAL+D2_DOC+D2_SERIE\r\n\r\nIf len(aProd) > 36 .and. len(aNota) > 1 .and. MsSeek( xFilial(\"SD2\") + PADR(aNota[2],TAMSX3(\"D2_DOC\")[1]) + PADR(aNota[1],TAMSX3(\"D2_SERIE\")[1]))\r\n\tnAliq := aProd[nPos] /  (SD2->D2_VALBRUT + SD2->D2_DESCON)\r\nEndif\t\r\n\r\nRestArea(aAreaSD2)\r\n\r\nReturn nAliq\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} DevCliEntr\r\nVerifica se nota de devolução utiliza cliente de entrega da nota de origem.\r\n\r\n@param\tcAliasSD1 Alias corrente do arquivo temp utilizado para a SD1\r\n\r\n@return lRet\t\tVerdadeiro se nota de devolucao utiliza cliente de entrega.\r\n\r\n@author Fabricio Romera\r\n@since 13/11/2015\r\n@version 11.80\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function DevCliEntr(cAliasSD1)\r\nLocal aArea    := GetArea()\r\nLocal aAreaSF2 := SF2->(GetArea())\r\nLocal lRet     := .F.\r\n\r\nDbSelectArea(\"SF2\")\r\nDbSetOrder(1)\r\nIf SF2->( DbSeek(xFilial(\"SF2\")+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI) )\r\n\tIf SF2->F2_CLIENTE <> SF1->F1_FORNECE .And. SF2->F2_CLIENT = SF1->F1_FORNECE\r\n\t\tlRet := .T.\r\n\tEnd If\r\nEnd If\r\n\r\nRestArea(aAreaSF2)\r\nRestArea(aArea)\r\nReturn lRet\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} ComplPreco\r\nVerifica se nota de complemento de preco e se a nota origem está na base\r\n@param\taAreaSDx Alias corrente do arquivo temp utilizado para a SD2/SD1\r\n@param\taAreaSFx Alias corrente do arquivo temp utilizado para a SF2/SF1\r\n@return Valor das tags vUnCom , vUnTrib\r\n@author Cleiton Genuino\r\n@since 24/11/2015\r\n@version 11.80\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function ComplPreco(cTipo,cF2Tipo,aProd)\r\nLocal aArea    := GetArea()\r\nLocal aAreaSDx := iif (cTipo== \"1\",SD2->(GetArea()),SD1->(GetArea()))\r\nLocal aAreaSFx := iif (cTipo== \"1\",SF2->(GetArea()),SF1->(GetArea()))\r\nLocal vComPreco  := \"0\"\r\nDefault cTipo   := \"\"\r\nDefault cF2Tipo := \"\"\r\nDefault aProd   := {}\r\nIF cTipo == \"1\" .And. cF2Tipo == \"C\" .And. len (aProd) > 0 .And. SF2->F2_TPCOMPL <> \"2\"\r\n\tDbSelectArea(\"SD2\")\r\n\tDbSetOrder(3)//D2_FILIAL, D2_DOC, D2_SERIE, D2_CLIENTE, D2_LOJA, D2_COD, D2_ITEM,\r\n\tIf SD2->( DbSeek(xFilial(\"SD2\")+ SD2->D2_DOC + SD2->D2_SERIE ))\r\n\t\tIf !Empty(SD2->D2_NFORI).And. !Empty(SD2->D2_SERIORI) .And. !Empty(SD2->D2_ITEMORI)\r\n\t\t\tDbSelectArea(\"SF2\")\r\n\t\t\tDbSetOrder(1)//F2_FILIAL, F2_DOC, F2_SERIE, F2_CLIENTE, F2_LOJA, F2_FORMUL, F2_TIPO,\r\n\t\t\tIF SF2->( DbSeek(xFilial(\"SF2\")+ SD2->D2_NFORI + SD2->D2_SERIORI ))\r\n\t\t\tIf !Empty(SF2->F2_CHVNFE) .And. len (SF2->F2_CHVNFE)== 44\r\n\t\t\t\tvComPreco  :=ConvType(aProd[10],15,2)\r\n\t\t\t\tEndIF\r\n\t\t\tEndIF\r\n\t\tEndif\r\n\tEndIf\r\nElse\r\n\tvComPreco := ConvType(aProd[10]/aProd[12],21,8)\r\nEndIF\r\nRestArea(aAreaSDx)\r\nRestArea(aAreaSFx)\r\nRestArea(aArea)\r\nReturn vComPreco\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfeAutXml\r\nFunção que monta o grupo autXML da NFe\r\n\r\n@param\t\tcAutXml\t String com os CPFs/CNPJs autorizados a visualizar \r\n\t\t\t\t\t\t o xml\r\n@return\tcString\t String contendo o grupo autXML  \r\n\r\n@author Natalia Sartori\r\n@since 21/12/2015\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeAutXml(cAutXml)\r\n\r\nLocal cString := \"\"\r\nLocal cSeparador := \";\"\r\nLocal cConteudo\t:= \"\"\r\nLocal nAt\t:= 0\r\nLocal nX\t:= 0\r\nLocal aAux :={}\r\n\r\n\r\nIf cSeparador $ cAutXml\r\n\tnAt:= at(cSeparador,cAutXml)\r\n\tWhile nAt > 0\r\n\t\tcConteudo := Substr(cAutXml,1,nAt-1)\r\n\t\taadd(aAux,{cConteudo})\r\n\t\tcAutXml:= Substr(cAutXml,nAt+1)\r\n\t\tnAT := at(cSeparador,cAutXml)\r\n\tEndDo\r\n\tIf !Empty(cAutXml)\r\n\t\taadd(aAux,{cAutXml})\r\n\tEndIf\r\nElse\r\n\taadd(aAux,{cAutXml})\r\nEndIf\r\n\r\nIf Len(aAux) > 0 .and. !Empty(aAux[1][1])\r\n\tFor nX := 1 to Len( aAux )\r\n\t\tcString += '<autXML>'\r\n\t\tIf Len(aAux[nX][1])== 14\r\n\t\t\tcString += '<CNPJ>'+aAux[nX][1]+'</CNPJ>'\r\n\t\tElseIf Len(aAux[nX][1])== 11\r\n\t\t\tcString += '<CPF>'+aAux[nX][1]+'</CPF>'\r\n\t\tEndIf\r\n\t\tcString += '</autXML>'\r\n\tNext nX\t\r\nEndIf\r\n\r\nReturn(cString)\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfeCodANP\r\nFunção que verifica se o código ANP permitido para gerar o grupo ICMSUFDes para\r\nnão ocorrer a  Rejeição. 695 :Informado indevidamente o grupo de ICMS para a UF de destino.\r\n\r\n@param\t\tNil  \r\n@return    cString\tString contendo os codigos ANP permitidos para gerar o grupo ICMSUFDes.\r\n                       \r\n                        Operação com combustível (tag:comb) derivado de petróleo:\r\n                        código ANP diferente de: \r\n                        820101001, 820101010, 810102001,810102004, 810102002, 810102003, 810101002, 810101001,\r\n                        810101003, 220101003, 220101004, 220101002, 220101001,220101005, 220101006, 560101001\r\n@author Valter da silva\r\n@since 11/02/2016\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeCodANP()\r\n\r\nLocal cRetorno \t:= \"\"\r\nLocal cPipe \t\t:= \"-\"\r\n\r\n\tcRetorno += \"820101001\" + cPipe \r\n\tcRetorno += \"820101010\" + cPipe \r\n\tcRetorno += \"810102001\" + cPipe \r\n\tcRetorno += \"810102004\" + cPipe \r\n\tcRetorno += \"810102002\" + cPipe \r\n\tcRetorno += \"810102003\" + cPipe \r\n\tcRetorno += \"810101002\" + cPipe \r\n\tcRetorno += \"810101001\" + cPipe \r\n\tcRetorno += \"810101003\" + cPipe \r\n\tcRetorno += \"220101003\" + cPipe \r\n\tcRetorno += \"220101004\" + cPipe \r\n\tcRetorno += \"220101002\" + cPipe \r\n\tcRetorno += \"220101001\" + cPipe \r\n\tcRetorno += \"220101005\" + cPipe \r\n\tcRetorno += \"220101006\" + cPipe\r\n\tcRetorno += \"560101001\" + cPipe\r\n\t\r\nReturn cRetorno\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfMultCup\r\nRetorna array com cupons relacionados a nota sobre cupom\r\n\r\n@param\taItemCup\tArray com itens separados por cupom referenciado\r\n@param\tcSerie\t\tSerie da nota atual\r\n@param\tcNota\t\tNumero da nota atual\r\n@param\tcClieFor\tCliente/Fornecedor da nota atual\r\n@param\tcLoja\t\tLoja da nota atual\r\n\r\n@return aRet\t\tArray com cupons referenciados na NF\r\n\r\n@author Leonardo Kichitaro\r\n@since 24/06/2015\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfMultCup(aItemCup, cSerie, cNota, cClieFor, cLoja)\r\n\r\nLocal aRet\t\t\t:= {}\r\nLocal nX\t\t\t:= 0\r\n\r\nDefault aItemCup\t:= {}\r\nDefault cSerie\t\t:= \"\"\r\nDefault cNota\t\t:= \"\"\r\nDefault cClieFor\t:= \"\"\r\nDefault cLoja\t\t:= \"\"\r\n\r\nIf Len(aItemCup) == 0\r\n\taAdd(aRet,{cSerie, cNota, cClieFor, cLoja})\r\nElse\r\n\tFor nX := 1 To Len(aItemCup)\r\n\t\tIf Len(aRet) == 0 .Or. aScan(aRet,{|x| x[1]+x[2]+x[3]+x[4] == aItemCup[nX][3]+aItemCup[nX][2]+aItemCup[nX][5]+aItemCup[nX][6]}) == 0\r\n\t\t\taAdd(aRet,{aItemCup[nX][3], aItemCup[nX][2], aItemCup[nX][5], aItemCup[nX][6]})\r\n\t\tEndIf\r\n\tNext\r\nEndIf\r\n\r\nReturn aRet\r\n\r\n//--------------------------------------------------------------------\r\n\r\n/*/{Protheus.doc}NfeMFECOP\r\nFunção  para gerar a mensagem do FECP  por estado -DF - MG - PR - RJ - RS \r\n         utilizado em informacoes complementares da nota\r\n      \r\n@param\t\tnVfecp\t      Valor numérico do FECOP referente ao valor total\r\n@param\t\tnVfecp\t      Estado da Filial Corrente.\r\n@param\t\tcFinalid  //'1' Retorna a mensagem no campo \"Informações Complementares\"\r\n                       //'2' Retorna a mensagem no campo \"Informação Adicional do Produto\"\r\n                     \r\n@return    cString\tString contendo a mensagem  \"Informações Complementares\" \r\n                        ou \"Informação Adicional do Produto Conforme o cFinalid \"\r\n\r\n                       \r\n@author Valter da silva\r\n@since 14/11/2016\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeMFECOP(nVfecp,cEstado,cDestDanf,aICMS,aICMSST,cVerAmb)\r\n\r\nlocal cMensFcop\t:= \"\"\r\nlocal cMensPadr := \"\"\r\nlocal cMensICMS := \"\"\r\nlocal cMensST\t:= \"\"\r\nLocal nX\t\t:= \"\"\r\nLocal nBaseIcm\t:= 0\r\nLocal nBaseST\t:= 0\r\nLocal nPerc\t\t:= 0\r\nLocal nValor\t:= 0\r\n\r\nDefault nVfecp := 0\r\nDefault cDestDanf     := \"1\"\r\nDefault cEstado      := \"\"\r\nDefault aICMS     := {}\r\nDefault aICMSST   := {}\r\nDefault cVerAmb   := \"\"\r\n\r\nDo Case\r\n  // MG: \"Arquivo Decreto nº 46.927, de 29 de dezembro de 2015.docx\", página 3:\r\n  //Art. 6º Nas operações sujeitas ao adicional de alíquota, o contribuinte indicará no campo “Informações \r\n  //Complementares” da nota fiscal a expressão “Adicional de alíquota – Fundo de Erradicação da Miséria\r\n  //” acompanhada do respectivo valor.\r\n\tCase cEstado== \"MG\"   // Tratamento legado de FECP\r\n\t\tIf  cDestDanf =='1'\r\n\t\t\tcMensFcop := \"Adicional de alíquota - Fundo de Erradicação da Miséria - R$ \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t   EndIf\r\n\t   \t\r\n\t//Case cEstado== \"PR\" \r\n\tCase cEstado== \"PR\" \r\n\t\t//PR: Arquivo \"Decreto Nº 3.339, de 20 de janeiro de 2016 - FECOP a partir de 01-02-2016.doc\", página 4:\r\n    \t//Art. 6º - Na Nota Fiscal Eletrônica - NF-e, modelos 55 ou 65, emitida para acobertar as operações com os produtos de que trata o art. 1º, deverá constar:\r\n    \t//I - o valor numérico do FECOP referente a cada item, no campo \"Informação Adicional do Produto\", com o seguinte formato: ##FECOP<N.\r\n    \t//NN>##, onde N.NN é o valor numérico do FECOP referente a cada item, com duas casas decimais, separadas por ponto, sem separador de milhar;\r\n    \t//II - o valor numérico do FECOP referente ao valor total, no campo \"Informações Complementares\", com o seguinte formato: ##FECOP<N.\r\n    \t//NN>##, onde N.NN é o valor numérico do FECOP referente ao valor total, com duas casas decimais, separadas por ponto, sem separador de milhar.  cValToChar(nVfecp)  \r\n\t\tIf  cDestDanf =='1' \r\n\t    \tcMensFcop := \"O valor numerico do FECOP referente ao valor total R$ \" + cValToChar(nVfecp)\r\n\t    ElseIf cDestDanf =='2'\r\n\t       cMensFcop := \"O valor numerico do FECOP referente a cada item R$ \" + cValToChar(nVfecp)\r\n\t    EndIf\r\n\t                \r\n\tCase cEstado== \"RJ\"\r\n    \tIf  cDestDanf =='1'\r\n\t\t\tcMensFcop := \"Adicional de alíquota - Fundo Estadual de Combate à Pobreza e às Desigualdades Sociais (FECP) - \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t    EndIf\r\n\t   \r\n\tCase cEstado== \"RS\" \r\n\t\tIf  cDestDanf =='1'\r\n\t    \tcMensFcop := \"Adicional de alíquota relativo ao AMPARA/RS, criado pela Lei nº 14.742/15 - R$ \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\")) \r\n\t\tEndIf\r\n\t\r\n\tOtherWise     \r\n\t\r\n\t\tIF cDestDanf =='1'\r\n\t\t\tIf\tcVerAmb == \"3.10\"\r\n\t\t\t\tcMensFcop  := \"Adicional de alíquota - Fundo Estadual de Combate à Pobreza e às Desigualdades Sociais (FECP) - \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t\t\tElse\r\n\t\t\t\tcMensFcop  := \"Adicional de alíquota - Fundo Estadual de Combate à Pobreza e às Desigualdades Sociais  - R$\" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t\t\tEndIf\r\n  \t\tEndIf\r\n  \tEndCase\r\n\t\r\n\tIF cVerAmb == \"4.00\" \r\n\t\r\n\t\tcMensPadr:= \"(FCP):\"+ cMensFcop\r\n\r\n\t\tIf cDestDanf =='1' // Informação do fisco <infAdFisco> para fecp\r\n\t\t\tnBaseIcm:=0\r\n\t\t\tnValor  :=0\r\n\t\t\tnPerc   :=0\r\n\t\t\tFor nX := 1 to Len( aICMS )\r\n\t\t\t\tIf Len( aICMS[nX] ) > 0 .And. aICMS[nX][16] > 0 .And.  aICMS[nX][17] > 0 .And. aICMS[nX][18] > 0  \r\n\t\t\t\t\tnBaseIcm\t:= nBaseIcm +  aICMS[nX][16] \r\n\t\t\t\t\tnValor\t\t:= nValor   +  aICMS[nX][18] \r\n\t\t\t\t\tnPerc \t\t:= aICMS[nX][17]\r\n  \t\t\t\tEndIf\r\n  \t\t\tNext nX\r\n  \t\t\t\r\n  \t\t\tIf  nBaseIcm > 0 .and.  nPerc > 0\r\n  \t\t\t\tcMensICMS := AllTrim(\" Base R$ \"+ConvType(nBaseIcm,13,2)+\" Perc.(\"+ConvType(nPerc)+\"%)\")\r\n  \t\t\t\tcMensFcop := cMensPadr +\" \"+cMensICMS\r\n  \t\t\tEndIf  \r\n  \t\t\t\r\n  \t\t\tnBaseST:=0\r\n\t\t\tnValor :=0\r\n\t\t\tnPerc  :=0\r\n  \t\t\tFor nX := 1 to Len( aICMSSt )\r\n\t\t\t\tIf Len( aICMSSt[nX] ) > 0 .And. aICMSSt[nX][13] > 0 .And.  aICMSSt[nX][14] > 0 .And. aICMSSt[nX][15] > 0  \r\n\t\t\t\t\tnBaseST\t:= nBaseST  +  aICMSSt[nX][13]\r\n\t\t\t\t\tnValor\t\t:= nValor   +  aICMSSt[nX][15] \r\n\t\t\t\t\tnPerc     \t:= aICMSSt[nX][14]   \r\n\t\t\t\t\t\r\n  \t\t\t\tEndIf\r\n  \t\t\tNext nX \r\n  \t\t\t\r\n  \t\t\tIf\tnBaseST > 0 .and.  nPerc > 0\r\n  \t\t\t  \tcMensST := \"(FCPST): \"+AllTrim(\"Base R$ \"+ConvType(nBaseST,13,2)+\" Perc.(\"+ConvType(nPerc)+\"%)\")\r\n  \t\t\t\tcMensFcop := \tcMensPadr +\" \"+cMensICMS+\" \"+cMensST\r\n  \t\t\tEndIf\r\n  \t\t\t\t \r\n  \t\telseIf  cDestDanf =='2' // Informação do fisco <indAdProd> para fecp\r\n  \t\t\tIf Len(aICMS) > 0 \r\n      \t\t\tIf  (aICMS[16] > 0 .or. aICMS[17] > 0 .or.  aICMS[18] > 0)\r\n      \t\t\t\tIf cEstado <> \"PR\" \r\n      \t\t\t\t\tcMensICMS := AllTrim(\"Base R$ \"+ConvType(aICMS[16],13,2)+\" Perc.(\"+ConvType(aICMS[17])+\"%) Vlr. R$ \" + ConvType(aICMS[18],13,2))\r\n  \t\t\t\t\t\tcMensFcop := cMensPadr + \" \" + cMensICMS\r\n  \t\t\t\t\tElse\r\n  \t\t\t\t\t\tcMensICMS := AllTrim(\"Base R$ \"+ConvType(aICMS[16],13,2)+\" Perc.(\"+ConvType(aICMS[17])+\"%)\")\r\n  \t\t\t\t\t\tcMensFcop := cMensPadr + \" \" + cMensICMS\r\n  \t\t\t\t\tEndIf \r\n  \t\t\t\tEndIf\r\n  \t\t\tEndIf\r\n  \t\t\t\r\n  \t\t\tIf Len(aICMSSt) > 0 \r\n  \t\t\t\tIf  (aICMSST[13] > 0 .or. aICMSST[14] > 0 .or.  aICMSST[15] > 0)\r\n  \t\t\t\t\tIf cEstado <> \"PR\"  // Para PR. não enviamos o valor \r\n  \t\t\t\t\t\tcMensST := \"(FCPST): \" + AllTrim(\"Base R$ \"+ConvType(aICMSST[13],13,2)+\" Perc.(\"+ConvType(aICMSST[14])+\"%) Vlr. R$ \" + ConvType(aICMSST[15],13,2))\r\n  \t\t\t\t\t\tcMensFcop := \tcMensPadr +\" \"+cMensICMS+\" \"+cMensST\r\n  \t\t\t\t\tElse\r\n  \t\t\t\t\t\tcMensST := \" (FCPST): \" + AllTrim(\"Base R$ \"+ConvType(aICMSST[13],13,2)+\" Perc.(\"+ConvType(aICMSST[14])+\"%)\")\r\n  \t\t\t\t\t\tcMensFcop := cMensPadr +\" \"+cMensICMS+\" \"+cMensST\r\n  \t\t\t\t\tEndIf\r\n  \t\t\t\tEndIf\t\r\n  \t\t\tEndIf\r\n  \t\tEndIf\t  \r\n  \tEndIf\r\n  \t\r\nReturn cMensFcop\r\n\r\n//---------------------------------------------------------------------------\r\n/*/{Protheus.doc} MsgCliDFIcm\r\nFuncao que retorna a mensagem para ser colocada nos dados adicionais da NFe.\r\nTratamento legislacao do DF, quando existir intes com ICMS-ST e intens somente com ICMS  próprio\r\n\r\n@author Valter Da Silva   \r\n@since 14.11.2016\r\n@version 1.0  \r\n\r\n@param\t\taICMS\t\tArray com informações referente ao ICMS proprio\r\n@param\t\taICMSST\tArray com informações referente ao ICMS-ST\r\n\t\t\t\r\n@return\tcMsg\t\tRetorna a Mensagem a ser utilizada.\t\r\n\r\n/*/\r\nStatic Function MsgCliDFIcm(aICMS, aICMSST, lNCMOk)\r\n\r\nLocal cMsg \t\t:= \"\"\r\n\r\nLocal nX\t\t\t:= \"\"\r\nLocal nValIcm\t\t:= 0\r\nLocal nValST\t\t:= 0 \r\nLocal nBaseIcm\t\t:= 0\r\nLocal nBaseST\t\t:= 0\r\n\r\nLocal lIcmsST\t\t:= .F.\r\nLocal lIcms\t\t:= .F.\r\nLocal lIcmsSemSt\t:= .F.\r\nDEFAULT aICMS  \t:= {}\r\nDEFAULT aICMSST \t:= {}\r\n\r\nDEFAULT lNCMOk\t\t:= .F.\r\n\r\nFor nX := 1 to Len( aICMS )\r\n\t\r\n\tlIcms := .F.\r\n\t\r\n\tIf Len( aICMS[nX] ) > 0 .And. aICMS[nX][07] > 0\r\n\t\t\r\n\t\tnValIcm \t+= aICMS[nX][07] \r\n\t\tnBaseIcm\t+= aICMS[nX][05]\r\n\t\t\r\n\t\tif len( aICMSSt[nX] ) > 0 .and. aICMSSt[nX][07] > 0 \r\n\t\t\tnValST\t\t+= aICMSST[nX][07]\r\n\t\t\tnBaseST\t+= aICMSST[nX][05]\r\n\t\tendif\r\n\t\t\r\n\t\tlIcms := .T.\r\n\t\t\t\t\r\n\tEndIf\r\n\t\r\n\tIf Len( aICMSSt[nX] ) > 0 .And. aICMSSt[nX][07] > 0 \t\t\r\n\t\t\r\n\t\tlIcmsST := .T.\r\n\t\t\t\t\t\t\r\n\tElseIf lIcms .And. !lIcmsSemSt  \r\n\t\tlIcmsSemSt := .T.\r\n\tEndIF\r\n\t \t\r\nNext nX\r\n\r\nIf  lIcmsST .And. lNCMOk\r\n\tcMsg +=\"Valor das operações sujeitas ao adicional:: R$  \" + Alltrim( Str(nBaseST, 14, 2) ) \r\n\tcMsg +=\" O valor corresponde à base de cálculo do ICMS ST\"\r\nEndIf\r\n\r\nReturn cMsg\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} retUn2UM\r\nRetorna a unidade da 2a. Unidade de Medida \r\n\r\n@author Sergio S. Fuzinaka\r\n@since 12.07.2017\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\nStatic Function retUn2UM( lNoImp2UM, cCFOPExp, cCFOP, cUMDIPI, cUM)\r\n\r\nLocal cReturn := \"\"\r\n\r\n// Tratamento para operacoes dentro do País\r\nIf lNoImp2UM\r\n   If ( Left(cCFOP,1) $ \"3-7\" ) .Or. ( cCFOP $ cCFOPExp )\r\n      If !Empty( cUMDIPI )\r\n         cReturn := cUMDIPI\r\n      Else\r\n         cReturn := cUM\r\n      Endif\r\n   Else\r\n      cReturn := cUM\r\n   Endif\r\nElse\r\n   If !Empty( cUMDIPI )\r\n      cReturn := cUMDIPI\r\n   Else\r\n      cReturn := cUM\r\n   Endif\r\nEndif\r\n\r\nReturn( cReturn )\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} retQtd2UM\r\nRetorna a quantidade da 2a. Unidade de Medida\r\n\r\n@author Sergio S. Fuzinaka\r\n@since 12.07.2017\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\nStatic Function retQtd2UM( lNoImp2UM, cCFOPExp, cCFOP, nCONVDIP, nQUANT)\r\n\r\nLocal nReturn := 0\r\n\r\n// Tratamento para operacoes dentro do País\r\nIf lNoImp2UM\r\n   If ( Left(cCFOP,1) $ \"3-7\" ) .Or. ( cCFOP $ cCFOPExp )\r\n      If nCONVDIP > 0\r\n         nReturn := ( nCONVDIP * nQUANT )\r\n      Else\r\n         nReturn := nQUANT\r\n      Endif\r\n   Else\r\n      nReturn := nQUANT\r\n   Endif\r\nElse\r\n   If nCONVDIP > 0\r\n      nReturn := ( nCONVDIP * nQUANT )\r\n   Else\r\n      nReturn := nQUANT\r\n   Endif\r\nEndif\r\n\r\n//O valor é limitado a 4 casas deciamais \r\n//porque o Schema(.XSD) da Sefaz nao aceita mais que 4 casas\r\nnReturn := NoRound(nReturn,5) //bruno alterado de 4 para 5\r\n\r\nReturn( nReturn )\r\n\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} NfePag\r\nRetorna o grupo da forma de pagamento.\r\n@author Valter da Silva\r\n@since 26.03.2018\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\n\r\nStatic Function NfePag(aDetPag)\r\nLocal cString    := \"\"\r\nLocal nX         := 0  \r\nLocal nTroco     := 0 \r\nDefault aDetPag  := {}\r\n\r\nIF len(aDetPag) > 0  \r\n\tcString +='<pagamento>'\r\n\tFor nX := 1 To Len(aDetPag)\r\n\t\tcString +='<detPag>'\r\n\t\tcString += '<indForma>'+aDetPag[nX][8]+'</indForma>'\r\n\t\tcString +='<forma>'+aDetPag[nX][1]+'</forma>' \r\n\t\tIf aDetPag[nX][1] == \"90\" //SEM PAGAMENTO\r\n\t\t\tcString +='<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\telse\r\n\t\t\tcString +='<valor>'+ConvType(aDetPag[nX][2],15,2)+'</valor>'\r\n\t\tEndIf\r\n\t\t\r\n\t\tIf Len(aDetPag[nX]) > 3 \r\n\t\t\tIF\t!empty(aDetPag[nX][4]) .and. aDetPag[nX][1] $ '03-04'\r\n\t\t\t\tcString += '<cartoes>'\r\n\t\t\t\tcString += '<tpIntegra>' +aDetPag[nX][4]+ '</tpIntegra>'\r\n\t\t\t\tcString += '<cnpj>'+aDetPag[nX][5]+ '</cnpj>'\r\n\t\t\t\tcString += '<bandeira>'+aDetPag[nX][6]+'</bandeira>'\r\n\t\t\t\tcString += '<autorizacao>'+aDetPag[nX][7]+'</autorizacao>'\r\n\t\t\t\tcString += '</cartoes>'\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\tcString +='</detPag>'\r\n\t\tnTroco  += aDetPag[nX][3]\r\n\tNext    \t\r\n\tcString +='<vTroco>'+ConvType(nTroco,15,2)+'</vTroco>'\r\n\tcString +='</pagamento>'\r\nEndIf\r\nReturn(cString)\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} NfeTpNota\r\nRetorna o tipo da nota.\r\n@author Valter da Silva\r\n@since 26.03.2018\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\nStatic Function NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cCFOP)\r\nLocal cTPNota     \t:= \"\"\r\nLocal cMVCfopTran \t:= SuperGetMV(\"MV_CFOPTRA\", ,\" \")   \t\t// Parametro que define as CFOP´s pra transferência de Crédito/Débito\r\nLocal nPos        \t:= 0 \r\nLocal cMVDevCfop  \t:= AllTrim(GetNewPar(\"MV_DEVCFOP\",\"\"))\r\nLocal aMVDevCfop  \t:= {}\r\n\r\nDefault cVerAmb   \t:= \"3.10\"\r\nDefault cCFOP   \t:= \"\"\r\nDefault aNota\t    := {}\r\nDefault aNfVinc   \t:= {}\r\nDefault aNfVincRur\t:= {}\r\nDefault aRefECF   \t:= {}\r\n\r\nDo Case\r\n\tCase (!Empty(aNfVinc) .And. !(aNota[5]$\"NDB\") .And. SF4->F4_AJUSTE <> \"S\")\r\n  \t\tcTPNota:= \"2\" \r\n \tCase (SubStr(SM0->M0_CODMUN,1,2)=='31' .And. SF4->F4_AJUSTE == \"S\" .And. (aNota[5]) $ \"N\" )\r\n \t\tcTPNota:= \"3\"\r\n\tCase ((aNota[5]) $ \"I-D-C-B\" .And. SF4->F4_AJUSTE == \"S\")\r\n   \t\tcTPNota:= \"3\"\r\n\t/* Referente ao chamado TIDMJV que contempla, nota de transferência de crédito / débito */\t   \t\t\r\n   \tCase ( ( AllTrim( SF4->F4_CF ) $ cMVCfopTran ) .and. ( SF4->F4_SITTRIB == \"90\" ) .and.  ( SF4->F4_AJUSTE == \"S\" ) ) \r\n\t\tcTPNota:= \"3\"\r\n\tCase (cVeramb >= \"3.10\" .and. (!Empty(aNfVinc) .Or. !Empty(aRefECF) .Or. !Empty(aNfVincRur))) .and. ( (aNota[5] $ \"D|B\" .And. SF4->F4_AJUSTE <> \"S\") .or. (aNota[5] $ \"N\" .And. SF4->F4_PODER3 == \"D\") )\r\n   \t\t  \t\t\r\n   \t\t//Retorna um array, de acordo com os dados passados no parametro MV_DEVCFOP\r\n   \t\taMVDevCfop\t:= StrTokArr( cMVDevCfop , \";\" )\t\r\n   \t\t\r\n   \t\t// Verifica a CFOP da NF de Devolucao consta no parametro MV_DEVCFOP \r\n   \t\tIF  !Empty(Alltrim(SFT->FT_CFOP))\r\n   \t\t\tnPos := Ascan( aMVDevCfop , Alltrim(SFT->FT_CFOP) ) \r\n   \t\tElse\r\n   \t\t\tnPos := Ascan( aMVDevCfop , Alltrim(cCFOP)) \r\n   \t\tEndIf \r\n   \t\t\r\n   \t\t// Se achou o conteudo, o Tipo de Nota fica igual a 1 conforme NT 2013.005.v1.03 (Chamado TQMCY6) \r\n   \t\tIf nPos > 0 \r\n   \t\t\tcTPNota:= \"1\" \r\n   \t\tElse\r\n   \t\t\tcTPNota:= \"4\" //Devolução de Mercadoria\r\n   \t\tEndIf\r\n   \t\t\r\n   \t /*Ajuste para emitir notas do tipo devolução Tag< finnfe> =4  sem necessidade de referenciar a nota original \r\n     para os  CFOP  1.201, 1.202, 1.410, 1.411, 5,921 e 6,921 . Evitando a rejeição 321- Rejeição: NF-e de devolução de mercadoria não possui\r\n     documento fiscal referenciado conforme  NT 2013/005 v 1.20.\r\n   \t */\r\n    Case (aNota[5]) $ \"D\" .and. Empty(aNfVinc).and. Alltrim(SFT->FT_CFOP) $ \"1201-1202-1410-1411-5921-6921\"\r\n   \t \tcTPNota:= \"4\" \r\n   \t\t\r\n\r\n\tOtherWise \r\n  \t\tcTPNota:= \"1\"\r\n\tEndCase\r\n\r\nReturn(cTPNota)\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfeProdANP\r\n\r\nGrupo ICMS60 (id:N08) informado indevidamente nas operações\r\ncom os produtos combustíveis sujeitos a repasse interestadual\r\n(tag:cProdANP).\r\n\r\n@param\t\tNil  \r\n@return    cString\tString contendo os codigos de produto ANP não permitidos para gerar o grupo ICMS60 quando cst 60.\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 21/03/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeProdANP()\r\n\r\nLocal cRetorno \t:= \"\"\r\n\r\n\tcRetorno := \"210203001|320101001|320101002|320102002|320102001|320102003|320102005|320201001|\"\r\n\tcRetorno += \"320103001|220102001|320301001|320103002|820101032|820101026|820101027|820101004|\"\r\n\tcRetorno += \"820101005|820101022|820101031|820101030|820101014|820101006|820101016|820101015|\"\r\n\tcRetorno += \"820101025|820101017|820101018|820101019|820101020|820101021|420105001|420101005|\"\r\n\tcRetorno += \"420101004|420102005|420102004|420104001|820101033|820101034|420106001|820101011|\"\r\n\tcRetorno += \"820101003|820101013|820101012|420106002|830101001|420301004|420202001|420301001|\"\r\n\tcRetorno += \"420301002|410103001|410101001|410102001|430101004|510101001|510101002|510102001|\"\r\n\tcRetorno += \"510102002|510201001|510201003|510301003|510103001|510301001|\"\r\n\t\r\nReturn cRetorno\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} GetPagLoja\r\n\r\nRetornar informações de pagamentos feitas via Venda Direta/Sigaloja\r\n\r\n@param\t\taDupl     Duplicatas para o caso de não ser enviada nenhuma forma de pagamento, para entao fazer-se a validação para os tipos  //outros e //14=Duplicata Mercantil \r\n@param\t\tcChvPag   Condição de pagamento\r\n@param\t\tnTotVd    Total da venda\r\n \r\n@return    Array Contendo as formas de pagamentos utilizados no Loja.\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 09/05/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function GetPagLoja(aDupl, cChvPag, nTotVd, cIndPag, cVerAmb)\r\nLocal aRet\t\t := {}\r\nLocal aAreaSL1 \t := SL1->(GetArea())\r\nLocal aAreaSL4 \t := SL4->(GetArea())\r\nLocal aAreaSA1 \t := {}\r\nLocal aAreaSE4 \t := {}\r\nLocal aDetPag \t := {}\r\nLocal lTEF\t\t := .F.\r\nLocal isloja\t := .F.\r\nLocal cForma\t := \"\"\r\nLocal cTpIntegra := \"\"\r\nLocal cAutTef \t := \"\"\r\nLocal cTpBand    := \"\"\r\nLocal nTamA1COD  := TamSX3(\"A1_COD\")[1]\t//tamanho do campo A1_COD\r\nLocal nTamAECOD  := TamSX3(\"AE_COD\")[1]\t//tamanho do campo AE_COD\r\nLocal cA1Cgc\t := \"\"\r\nLocal lCondCN\t := .F.\t//Condição Negociada\r\nLocal nTroco\t := 0\r\n\r\nDefault aDupl \t := {}\r\nDefault cChvPag\t := \"\"\r\nDefault nTotVd\t := 0\r\n\r\nIf ExistFunc(\"LjGetPgNfe\")\r\n\taRet := LjGetPgNfe(cVerAmb)\r\nElse\r\n\tdbselectarea(\"SL1\")\r\n\tSL1->(dbsetorder(2))\t\t\t\r\n\tIf SL1->(dbseek(xFilial('SL1') + SF2->F2_SERIE + SF2->F2_DOC))\r\n\t\r\n\t\tlTEF    := ( (AllTrim(SL1->L1_VENDTEF) == \"S\") .Or. (SL1->L1_CARTAO > 0) .Or. (SL1->L1_VLRDEBI > 0) )\r\n\t\tlCondCN := Alltrim(cChvPag) == \"CN\"\r\n\r\n\t\t//Caso tenha sido utilizada NCC(Nota de Credito na venda)\r\n\t\tIf SL1->L1_CREDITO > 0\r\n\t\t\tisloja\t:= .T.\t\t\t\r\n\t\t\t\t\t    //{cForma          , Valor          , Troco, Tp Integra, CGC Adm Cartao, Cod Bandeira, Autorização TEF}\r\n\t\t\taadd(aDetPag, {GetFormPgt(\"CR\"), SL1->L1_CREDITO, 0.00 , \"2\"       , \"\"            , \"\"          , \"\", cIndPag}) \r\n\t\t\t\r\n\t\t\t//Caso em conjunto com a NCC tenha sido utilizada condição de pagamento cadastrada na SE4 que nao seja negociada, ja trato aqui\r\n\t\t\tIf !Empty(cChvPag) .And. !lCondCN .And. ((nTotVd - SL1->L1_CREDITO) > 0)\r\n\r\n\t\t\t\taAreaSE4 := SE4->(GetArea())\r\n\t\t\t\t\t//caso tenha escolhido a forma de pagamento no cadastro de condição de pagamento.\r\n\t\t\t\t\tdbSelectArea(\"SE4\")\r\n\t\t\t\t\tdbSetOrder(1)\t\r\n\t\t\t\t\tIf DbSeek(xFilial(\"SE4\") + cChvPag)\r\n\t\t\t\t\t\tcForma := GetFormPgt(Alltrim(SE4->E4_FORMA), aDupl)\r\n\t\t\t\t\t\tnTroco := IIF(SL1->L1_TROCO1 > 0, SL1->L1_TROCO1, 0.00)\r\n\t\t\t\t\t\taadd(aDetPag, {cForma, nTotVd - SL1->L1_CREDITO , nTroco, \"2\", \"\", \"\", \"\", cIndPag})   \r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\tRestArea(aAreaSE4)\r\n\t\t\tEndIf\t\r\n\t\tEndIf\t\r\n\r\n\t\tdbselectarea(\"SL4\")\t\t\t\r\n\t\tSL4->(dbsetorder(1))\r\n\t\tIf lCondCN .And. SL4->(dbseek(SL1->L1_FILIAL + SL1->L1_NUM))\r\n\t\t\tisloja\t:= .T.\r\n\t\t\tWhile !SL4->(Eof()) .And. xFilial(\"SL4\") == SL4->L4_FILIAL .And. SL1->L1_NUM == SL4->L4_NUM\r\n\t\t\t\r\n\t\t\t\tcForma     := GetFormPgt(Alltrim(SL4->L4_FORMA), aDupl)\t\t\r\n\t\t\t\tcTpIntegra := IIF(lTEF, \"1\", \"2\")\r\n\t\t\t\t\t\r\n\t\t\t\t////////////////////////////////////\r\n\t\t\t\tcAutTef := AllTrim(SL4->L4_AUTORIZ)\r\n\t\t\t\tIf EmpTy(cAutTef)\r\n\t\t\t\t\tcAutTef := AllTrim(SL4->L4_NSUTEF)\r\n\t\t\t\t\tIf EmpTy(cAutTef)\r\n\t\t\t\t\t\tcAutTef := AllTrim(SL4->L4_DOCTEF)\r\n\t\t\t\t\t\tIf EmpTy(cAutTef)\r\n\t\t\t\t\t\t\tcTpIntegra := \"2\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t/////////////////////////////////////\r\n\r\n\t\t\t\tnTroco :=  IIF(SL4->L4_TROCO > 0, SL4->L4_TROCO, 0.00)\r\n\t\t\t\t\r\n\t\t\t\tIf cTpIntegra == \"1\"\r\n\t\t\t\t\t//obtemos o codigo da administradora financeira conforme cadastrada no SA1\r\n\t\t\t\t\tcAdmFin := PadR( SubStr(SL4->L4_ADMINIS,1,nTamAECOD), nTamA1COD )\r\n\t\t\t\t\tIf !Empty(cAdmFin)\r\n\r\n\t\t\t\t\t\taAreaSA1 \t := SA1->(GetArea())\r\n\t\t\t\t\t\t\tDbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\tSA1->( DbSetOrder(1) )\t//A1_FILIAL + A1_COD + A1_LOJA\r\n\t\t\t\t\t\t\tIf SA1->(MsSeek(xFilial(\"SA1\") + cAdmFin)) .And. !Empty(SA1->A1_CGC)\r\n\t\t\t\t\t\t\t\tcA1Cgc := SA1->A1_CGC\r\n\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\tcA1Cgc := \"\"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tRestArea(aAreaSA1)\r\n\t\t\t\t\tElse\t\r\n\t\t\t\t\t\tcA1Cgc := \"\"\r\n\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcTpBand := GetTBandLo(SL4->L4_INSTITU)\r\n\t\t\t\tElse\r\n\t\t\t\t\tcA1Cgc  := \"\"\r\n\t\t\t\t\tcTpBand := \"\"\r\n\t\t\t\t\tcAutTef := \"\"\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\taadd(aDetPag, {cForma, SL4->L4_VALOR, nTroco, cTpIntegra, cA1Cgc, cTpBand, cAutTef, cIndPag}) \r\n\r\n\t\t\t\tSL4->(DbSkip())\r\n\t\t\tEndDo\t\t\r\n    \tEndIf\t\r\n    EndIf\r\n\tRestArea(aAreaSL1)\r\n\tRestArea(aAreaSL4)\r\n\t\r\n\taRet := {isloja, aDetPag}\r\nEndIf\r\n\r\nReturn \taRet\r\n\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} GetFormPgt\r\n\r\nRetornar codigos de formas de pagamento exigidos pela Sefaz\r\n\r\n@param\t\tcCondPag  Condição de pagamento entre \"R$\"//DINHEIRO, \"CH\"//CHEQUE, \"CC\" //CARTAO DE CREDITO, \"CD\"//CARTAO DE DEBITO AUTOMATICO, \"CR\"//CREDITO LOJA\r\n\t\t\t\t        \t\t\t\t\t\t  \"VA\"//VALE ALIMENTAÇÃO, \"VR\"//VALE REFEIÇÃO, \"VP\"//VALE PRESENTE, \"VC\"//VALE COMBUSTIVEL, \"DM\"//Duplicata Mercantil\r\n\t\t\t\t\t\t\t\t\t\t\t\t  \"BOL\" //BOLETO BANCARIO, \"SPG\" //SEM PAGAMENTO\r\n@param\t\taDupl     Duplicatas para o caso de não ser enviada nenhuma forma de pagamento, para entao fazer-se a validação para os tipos  //outros e //14=Duplicata Mercantil \r\n\r\n@return     String  Contendo o codigo de forma de pagamento exigida epela Sefaz\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 09/05/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function GetFormPgt(cCondPag, aDupl)\r\n\r\nLocal cForma\t:= \"\"\r\n\r\nDefault cCondPag\t:= \"\"\r\nDefault aDupl\t    := {}\r\n\r\n\tIf !Empty(cCondPag)\r\n\t\tDo Case\r\n\t\t\tCase cCondPag == \"R$\"//DINHEIRO\r\n\t\t\t\tcForma := \"01\"\r\n\t\t\tCase cCondPag == \"CH\"//CHEQUE\r\n\t\t\t\tcForma := \"02\"\r\n\t\t\tCase cCondPag == \"CC\" //CARTAO DE CREDITO\r\n\t\t\t\tcForma := \"03\"\r\n\t\t\tCase cCondPag == \"CD\"//CARTAO DE DEBITO AUTOMATICO\r\n\t\t\t\tcForma := \"04\"\r\n\t\t\tCase cCondPag == \"CR\"//CREDITO LOJA\r\n\t\t\t\tcForma := \"05\"\r\n\t\t\tCase cCondPag == \"VA\"//VALE ALIMENTAÇÃO\r\n\t\t\t\tcForma := \"10\"\r\n\t\t\tCase cCondPag == \"VR\"//VALE REFEIÇÃO\r\n\t\t\t\tcForma := \"11\"\r\n\t\t\tCase cCondPag == \"VP\"//VALE PRESENTE\r\n\t\t\t\tcForma := \"12\"\r\n\t\t\tCase cCondPag == \"VC\"//VALE COMBUSTIVEL\r\n\t\t\t\tcForma := \"13\"\r\n\t\t\t//Case cCondPag == \"DM\"//Duplicata Mercantil\r\n\t\t\t//\tcForma := \"14\"\t\r\n\t\t\tCase cCondPag == \"BOL\" //BOLETO BANCARIO\r\n\t\t\t\tcForma := \"15\"\t\r\n\t\t\tCase cCondPag == \"SPG\" //SEM PAGAMENTO\r\n\t\t\t\tcForma := \"90\"\r\n\t\t\tOtherWise\r\n\t\t\t\tcForma := \"99\"\t// OUTROS\r\n\t\tEndCase\r\n\tElse\t\r\n\t\tIf Empty(cForma)\r\n\t\t\tIf Len(aDupl) == 0\r\n\t\t\t\tcForma := \"90\"  //sem pagamento\r\n\t\t\tElseIf Len(aDupl) > 0\r\n\t\t\t\tcForma := \"15\"  //15=Boleto Bancário \r\n\t\t\tEndif\r\n\t\tEndIf\r\n\tEndIf\t\r\n\r\nReturn cForma\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} GetTBandLo\r\n\r\nRetornar codigos do tipo da bandeira conforme cartao de de credito ou debito exigidos pela Sefaz\r\n\r\n@param\t\tcCondPag  Condição de pagamento entre \"R$\"//DINHEIRO, \"CH\"//CHEQUE, \"CC\" //CARTAO DE CREDITO, \"CD\"//CARTAO DE DEBITO AUTOMATICO, \"CR\"//CREDITO LOJA\r\n\t\t\t\t        \t\t\t\t\t\t  \"VA\"//VALE ALIMENTAÇÃO, \"VR\"//VALE REFEIÇÃO, \"VP\"//VALE PRESENTE, \"VC\"//VALE COMBUSTIVEL, \"DM\"//Duplicata Mercantil\r\n\t\t\t\t\t\t\t\t\t\t\t\t  \"BOL\" //BOLETO BANCARIO, \"SPG\" //SEM PAGAMENTO\r\n@param\t\taDupl     Duplicatas para o caso de não ser enviada nenhuma forma de pagamento, para entao fazer-se a validação para os tipos  //outros e //14=Duplicata Mercantil \r\n\r\n@return     String  Contendo o codigo de forma de pagamento exigida epela Sefaz\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 09/05/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function GetTBandLo(cBandeira)\r\n\r\nLocal c_tBand\t\t:= \"\"\t//codigo da bandeira utilizada pelo SEFAZ\r\n\r\nDefault cBandeira\t:= \"\"\r\n\r\n\tcBandeira := AllTrim( cBandeira )\r\n\tDo Case\r\n\t\tCase (\"VISA\" $ cBandeira)              //( (\"VISA\" $ cBandeira) .OR. (\"ELECTRON\" $ cBandeira) )\r\n\t\t\tc_tBand := \"01\"\r\n\t\tCase (\"MASTERCARD\" $ cBandeira)        // ( (\"MAESTRO\" $ cBandeira) .OR. (\"MASTERCARD\" $ cBandeira) )\r\n\t\t\tc_tBand := \"02\"\r\n\t\tCase (\"AMERICAN EXPRESS\" $ cBandeira)  //( (\"AMEX\" $ cBandeira) .OR. (\"EXPRESS\" $ cBandeira) )\r\n\t\t\tc_tBand := \"03\"\r\n\t\tCase (\"SOROCRED\" $ cBandeira)\r\n\t\t\tc_tBand := \"04\"\r\n\t\tCase (\"DINERS CLUB\" $ cBandeira)\r\n\t\t\tc_tBand := \"05\"\t\r\n\t\tCase (\"ELO\" $ cBandeira)\r\n\t\t\tc_tBand := \"06\"\t\r\n\t\tCase (\"HIPERCARD\" $ cBandeira)\r\n\t\t\tc_tBand := \"07\"\t\r\n\t\tCase (\"AURA\" $ cBandeira)\r\n\t\t\tc_tBand := \"08\"\t\t\r\n\t\tCase (\"CABALAURA\" $ cBandeira)\r\n\t\t\tc_tBand := \"09\"\t\t\t\r\n\t\tOtherwise\r\n\t\t\tc_tBand := \"99\"\r\n\tEndCase\r\n\r\nReturn c_tBand\r\n\r\n/*/{Protheus.doc} DadNfVinc()\r\nFuncao que verifica os dados da nota vinculadas ao documento de entrada.\r\n@author Valter Da silva     \r\n@since 02.07.2018\r\n@version 1.0 \r\n/*/\r\nStatic Function DadNfVinc(aNfVinc)\r\nLocal aAreaSC5\t:= SC5->( GetArea() )\r\nLocal aAreaSC6 := SC6->( GetArea() )\r\nLocal aDadNfVi\t:= {} \r\nLocal cNEmp\t:= \"\"  \r\nLocal cPed  \t:= \"\"  \r\nDefault aNfVinc \t:= {}\r\n\t\r\nSC5->( dbSetOrder(1) ) \r\nSC6->( dbSetOrder(1) ) \r\n\t     \r\nIf SC5->(MsSeek(xFilial(\"SC5\")+aNfVinc[1][9]))\r\n\tcNEmp:= Iif(SC5->(FieldPos(\"C5_NTEMPEN\")) > 0,Alltrim(SC5->C5_NTEMPEN),\"\")\r\nEndIf\r\n\t   \r\nIf SC6->(MsSeek(xFilial(\"SC6\")+aNfVinc[1][9]))\r\n\tcPed := AllTrim(SC6->C6_PEDCLI)\r\nEndIf   \r\n\t \r\n\taDadNfVi := {cNEmp,cPed,\"\"}\r\n \r\n\tRestArea( aAreaSC5 )\r\n\tRestArea( aAreaSC6 )\r\n\r\nReturn aDadNfVi\r\n\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} FiltEst\r\n\r\nRemove a citação á nota fiscal complementar que seja diferente do estado do emissor \r\n\r\n@param\t\taRef      Array que contém as notas de referência\r\n\r\n@param\t\tcEst\t   Estado do Emissor (obtido do SM0) \r\n\r\n@return     aRet    Possui notas de referência que podem ser citadas no xml (que são do mesmo estado que o emissor).\r\n                       \r\n@author Bruno Colisse\r\n@since 03/07/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function FiltEst(aRef, cEst)\r\nLocal i := 0\r\n\r\nLocal aRet := {}\r\n\r\nfor i := 1 to len(aRef)\r\n\tif aRef[i][6] == cEst\r\n\t\taAdd(aRet, aRef[i])\r\n\tendif\r\nNext\r\nReturn aRet\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} RetInfoSBZ\r\nRetorna a Unid. Medida da DIPI e o Fator de Conv. da DIPI da SBZ caso os parâmetro recebidos estejam vazios.\r\n\r\n@param  cProduto - Produto que será localizado na SBZ\r\n@param  cUmDipi  - Unid. Medida da DIPI\r\n@param  nConvDip - Fator de Conv. da DIPI\r\n                       \r\n@author  Rafael Tenorio da Costa\r\n@since   11/06/2019\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function RetInfoSBZ(cProduto, cUmDipi, nConvDip)\r\n\r\n    Local aArea := GetArea()\r\n\r\n    DbSelectArea(\"SBZ\")\r\n    SBZ->( DbSetOrder(1) )    //BZ_FILIAL+BZ_COD\r\n    If SBZ->( DbSeek(xFilial(\"SBZ\") + cProduto) )\r\n\r\n        If Empty(cUmDipi) .And. SBZ->( ColumnPos(\"BZ_UMDIPI\") ) > 0\r\n            cUmDipi := SBZ->BZ_UMDIPI\r\n        EndIf\r\n\r\n        If nConvDip == 0 .And. SBZ->( ColumnPos(\"BZ_CONVDIP\") ) > 0\r\n            nConvDip := SBZ->BZ_CONVDIP\r\n        EndIf\r\n    EndIf\r\n    \r\n    RestArea(aArea)\r\n\r\nReturn Nil\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} getCodLan\r\nValidação com a tabela 5.2 para enviar o codigo SEM CBENEF ou NULO de acordo com a UF\r\n\r\n@param  cUF \t- Estado que será validado\r\n@param  cCST \t- CST do produto informado\r\n@author  Bruno Seiji\r\n@since   14/08/2019\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nstatic function getCodLan( cUF, cCST, cAmbiente )\r\n\r\nlocal cCodlan\t\t:= \"\"\r\nlocal lSemCbenef\t:= .F.\r\ndefault cUF \t\t:= \"\"\r\ndefault cCST \t\t:= \"\"\r\ndefault cAmbiente\t:= \"2\"\r\n\r\nif !empty(cUF) .and. !empty(cCST)\r\n\r\n\tlSemCbenef := cAmbiente == \"2\"\r\n\r\n\tdo case\r\n\t\tcase cUF == \"PR\"\r\n\t\t\tif cCST == \"90\"\r\n\t\t\t\tcCodlan := \"SEM CBENEF\"\r\n\t\t\tendif\r\n\t\tcase cUF == \"RS\"\r\n\t\t\tcCodlan := \"SEM CBENEF\"\r\n\t\t\tif cCST <> \"90\" .and. date() > CTOD(\"09/08/2020\")\r\n\t\t\t\tcCodlan := \"\"\r\n\t\t\tendif\r\n\tendCase\r\n\r\nendif\r\n\r\nreturn cCodlan\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} SpecialChar\r\nLimpa os códigos ASCII faixa 127 a 255 que falham os EncodeUTF8\r\n\r\n@param  cString\t- xml\r\n@param  cString\t- Xml sem os os codigos da tabela asci que falham os EncodeUTF8.\r\n@author  Bruno Akyo\r\n@since   28/10/2019\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nstatic Function SpecialChar( cString )\r\nlocal nX     := 0\r\nlocal aChar  := {}\r\n\r\ndefault cString := \"\"\r\n\r\nif !empty( cString )\r\n    aAdd( aChar, 129)\r\n    aAdd( aChar, 141)\r\n    aAdd( aChar, 143)\r\n    aAdd( aChar, 144)\r\n    aAdd( aChar, 157)\r\n    for nX := 1 to len(aChar)\r\n        cString := StrTran( cString, Chr( aChar[nX] ), \".\" )\r\n    next\r\nendif\r\n\r\nreturn cString\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} PosiTriang\r\nVerifica se a operação se trata de uma triangulação\r\n\r\n@author  Felipe Sales Martinez\r\n@since   09/12/2019\r\n@version 1.0\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function PosiTriang(cAliasSD2)\r\nLocal lRet := .F.\r\nSD1->(DBSetOrder(4)) //D1_FILIAL+D1_NUMSEQ\r\nlRet := !Empty((cAliasSD2)->D2_IDENTB6) .And. SD1->(DBSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_IDENTB6)) .And. SD1->(D1_DOC+D1_SERIE+D1_COD) == (cAliasSD2)->(D2_NFORI+D2_SERIORI+D2_COD)\r\nReturn lRet\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} AjustaDest\r\nFunção para que quando mudar o cadastro de cliente referente ao grupo de destinatário na tabela AIF o mesmo busque dados da nota vinculada e retorna no array . \r\n@param  aDest \t - Array com o destinatário\r\n@param  aNfVinc  - Array com a nota vinculada\r\n@param  cCliefor - Fornecedor\r\n@param  cLoja    - Loja\r\n\r\n@return    aDest - Array aDeste contendo os dados da nota vinculada.\r\n\r\n@author  Valter da Silva\r\n@since   04/03/2020\r\n@version 1.0\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function AjustaDest(aDest,aNfVinc,cCliefor,cLoja)\r\n\tLocal   cAliasAIF\t:= getNextAlias()\r\n\tLocal   dDataEmis   := \"\"\r\n\tLocal   aDestVinc \t:= {}\r\n\tLocal   lDestVinc   := .F.\r\n\t\r\n\tDefault cCliefor\t:= \"\"\r\n\tDefault cLoja\t    := \"\"\r\n\tDefault aDest\t    := {}\r\n\tDefault aNfVinc\t    := {}\r\n    \r\n\tif !Empty(aNfVinc)\r\n\t\tdDataEmis:= aNfVinc[1][1]\r\n    \tdDataEmis:= Dtos(dDataEmis)\r\n\tendif\r\n\r\n\tBeginSql Alias cAliasAIF\r\n\tcolumn AIF_DATA as Date\r\n\r\n\tSELECT max(AIF_DATA) AIF_DATA\r\n\t\tFROM %Table:AIF% AIF\r\n\t\tWHERE\r\n\t\t\tAIF.AIF_FILIAL = %xFilial:AIF% AND\r\n\t\t\tAIF.AIF_FILTAB = %Exp:xFilial(\"SA1\")%  AND\r\n\t\t\tAIF.AIF_TABELA = %Exp:\"SA1\" % AND\r\n        \tAIF.AIF_CODIGO = %Exp:cCliefor%  AND\r\n\t\t\tAIF.AIF_LOJA   = %Exp:cLoja%  AND\r\n\t\t\tAIF.AIF_CAMPO  IN ('A1_NOME','A1_END','A1_COMPLEM','A1_BAIRRO',' A1_COD_MUN','A1_MUN','A1_EST','A1_CEP','A1_PAIS','A1_TEL','A1_EST','A1_INSCR','A1_SUFRAMA','A1_INSCRM','A1_CONTRIB','A1_IENCONT','A1_TIPO','A1_PFISICA','A1_EMAIL')  AND\r\n\t\t\tAIF.AIF_DATA >= %Exp:dDataEmis% AND\r\n\t\t\tAIF.%NotDel% \r\n\t\tEndSql\r\n\t\t\r\n\t\tif (cAliasAIF)->(!Eof()) .and. !empty((cAliasAIF)->AIF_DATA)\r\n\t\t\tlDestVinc:=.T.\t\r\n\t\tendif\r\n\t\t\r\n\t\t(cAliasAIF)->(DBCLOSEAREA())\r\n\t\t\r\n\t\tif lDestVinc\r\n    \t\taDestVinc:= NotaVinc(aNfVinc[1][2]+aNfVinc[1][3])\r\n            \r\n\t\t\tIf !Empty(aDestVinc)\r\n\t\t\t\taDest[02]  := aDestVinc[02] // - Nome\r\n\t\t\t\taDest[03]  := aDestVinc[03] // - Logradouro\r\n\t\t\t\taDest[04]  := aDestVinc[04] // - Número\r\n\t\t\t\taDest[05]  := aDestVinc[05] // - Complemento\r\n\t\t\t\taDest[06]  := aDestVinc[06] // - Bairro\r\n\t\t\t\taDest[07]  := aDestVinc[07] // - Código do município\r\n\t\t\t\taDest[08]  := aDestVinc[08] // - Nome do município\r\n\t\t\t\taDest[09]  := aDestVinc[09] // - Sigla da UF\r\n\t\t\t\taDest[10]  := aDestVinc[10] // - Código do CEP\r\n\t\t\t\taDest[11]  := aDestVinc[11] // - Código do País\r\n\t\t\t\taDest[12]  := aDestVinc[12] // - Nome do País\r\n\t\t\t\taDest[13]  := aDestVinc[13] // - Telefone\r\n\t\t\t\taDest[14]  := iif(EMPTY(aDestVinc[15]),'ISENTO',aDestVinc[15]) // - Inscrição Estadual do Destinatário\r\n\t\t\t\taDest[15]  := aDestVinc[16] // - Inscrição na SUFRAMA\r\n\t\t\t\taDest[19]  := aDestVinc[17] // - Inscrição Municipal do Tomador do Serviço\r\n\t\t\t\taDest[16]  := aDestVinc[18] // - Email\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\r\nReturn aDest\r\n\r\nStatic Function SortArray(aArray,nIni,nLen,bCompara)\r\nLocal i\r\nLocal nTam\r\n\r\nIf ValType(aArray) == \"A\" .AND. Len(aArray) > 0\r\n\r\n\tnTam := Int(log(Len(aArray))/log(10))+1\r\n\r\n\tFor i := 1 To Len(aArray)\r\n\t\taArray[i] := {aArray[i],StrZero(i,nTam)}\r\n\tNext i\r\n\r\n\tIf ValType(nAux := Eval(bCompara,aArray[1][1],aArray[1][1])) == \"N\" .AND. nAux == 0\r\n\t\taSort(aArray,nIni,nLen,{|X,Y| nAux := Eval(bCompara,X[1],Y[1]),If(nAux == 0,X[2]<Y[2],nAux > 0)})\r\n\tEndIf\r\n\r\n\tFor i := 1 To Len(aArray)\r\n\t\taArray[i] := aClone(aArray[i][1])\r\n\tNext i\r\n\r\nEndIf\r\n\r\nReturn aArray\r\n"}}}
