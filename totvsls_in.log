Content-Length: 3122
{"jsonrpc":"2.0","id":0,"method":"initialize","params":{"processId":54248,"clientInfo":{"name":"vscode","version":"1.64.0"},"rootPath":"d:\\TOTVS 12\\Microsiga\\Protheus\\ProjetoVSCode","rootUri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode","capabilities":{"workspace":{"applyEdit":true,"workspaceEdit":{"documentChanges":true,"resourceOperations":["create","rename","delete"],"failureHandling":"textOnlyTransactional"},"didChangeConfiguration":{"dynamicRegistration":true},"didChangeWatchedFiles":{"dynamicRegistration":true},"symbol":{"dynamicRegistration":true,"symbolKind":{"valueSet":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]}},"executeCommand":{"dynamicRegistration":true},"configuration":true,"workspaceFolders":true},"textDocument":{"publishDiagnostics":{"relatedInformation":true,"versionSupport":false,"tagSupport":{"valueSet":[1,2]}},"synchronization":{"dynamicRegistration":true,"willSave":true,"willSaveWaitUntil":true,"didSave":true},"completion":{"dynamicRegistration":true,"contextSupport":true,"completionItem":{"snippetSupport":true,"commitCharactersSupport":true,"documentationFormat":["markdown","plaintext"],"deprecatedSupport":true,"preselectSupport":true,"tagSupport":{"valueSet":[1]}},"completionItemKind":{"valueSet":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25]}},"hover":{"dynamicRegistration":true,"contentFormat":["markdown","plaintext"]},"signatureHelp":{"dynamicRegistration":true,"signatureInformation":{"documentationFormat":["markdown","plaintext"],"parameterInformation":{"labelOffsetSupport":true}},"contextSupport":true},"definition":{"dynamicRegistration":true,"linkSupport":true},"references":{"dynamicRegistration":true},"documentHighlight":{"dynamicRegistration":true},"documentSymbol":{"dynamicRegistration":true,"symbolKind":{"valueSet":[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26]},"hierarchicalDocumentSymbolSupport":true},"codeAction":{"dynamicRegistration":true,"isPreferredSupport":true,"codeActionLiteralSupport":{"codeActionKind":{"valueSet":["","quickfix","refactor","refactor.extract","refactor.inline","refactor.rewrite","source","source.organizeImports"]}}},"codeLens":{"dynamicRegistration":true},"formatting":{"dynamicRegistration":true},"rangeFormatting":{"dynamicRegistration":true},"onTypeFormatting":{"dynamicRegistration":true},"rename":{"dynamicRegistration":true,"prepareSupport":true},"documentLink":{"dynamicRegistration":true,"tooltipSupport":true},"typeDefinition":{"dynamicRegistration":true,"linkSupport":true},"implementation":{"dynamicRegistration":true,"linkSupport":true},"colorProvider":{"dynamicRegistration":true},"foldingRange":{"dynamicRegistration":true,"rangeLimit":5000,"lineFoldingOnly":true},"declaration":{"dynamicRegistration":true,"linkSupport":true},"selectionRange":{"dynamicRegistration":true}},"window":{"workDoneProgress":true}},"initializationOptions":{"launchArgs":["--log-file=totvsls.log","--record=totvsls"]},"trace":"off","workspaceFolders":[{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode","name":"ProjetoVSCode"}]}}
Content-Length: 52
{"jsonrpc":"2.0","method":"initialized","params":{}}
Content-Length: 705
{"jsonrpc":"2.0","id":1,"method":"$totvsserver/reconnect","params":{"reconnectInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxNTg5MzowOjE6MQ==.j2uqRcEQ8jvYxmT+LRNH9aWeSPbq24/SB7AltRu3HyIdFDSzHHm2Ux4U9I7EbTUSLALirXfzVlWHmfRdxdrsAIiZQGjMyhbEd3/MaEdigppkb35vzF4phvEBCFZHS47QhOpLIkmdhA1U9sCfCr5uXmdafkj7I45spLcnTmAyDbKIWj1TRsjb5thtEbxMydCQuhib2rqJLEmrcniZU8ZzE0NFj7qwov0eLrJcvqFNg6GAuF2cKXQEQ/TGmzX9zUFr6XehOAqX+XDlW7tLZsRTN75xrin+zKSuTTgT5PTZfbIlao8avAL3z4lgGeZ/TrS6oMwIlnY5jBDrM8GMHCHgcg==","serverName":"SRV_DEVELOPER","connType":3}}}
Content-Length: 679
{"jsonrpc":"2.0","id":2,"method":"$totvsserver/serverPermissions","params":{"serverPermissionsInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw=="}}}
Content-Length: 183
{"jsonrpc":"2.0","id":3,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"includes","value":"D:\\TOTVS 12\\Microsiga\\Protheus\\include;"}}}
Content-Length: 148
{"jsonrpc":"2.0","id":4,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":5,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 153
{"jsonrpc":"2.0","id":6,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 145
{"jsonrpc":"2.0","id":7,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 148
{"jsonrpc":"2.0","id":8,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":9,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":10,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":11,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 76
{"jsonrpc":"2.0","method":"$/setTraceNotification","params":{"value":"off"}}
Content-Length: 149
{"jsonrpc":"2.0","id":12,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":13,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":14,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":15,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 149
{"jsonrpc":"2.0","id":16,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":17,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":18,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":19,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 76
{"jsonrpc":"2.0","method":"$/setTraceNotification","params":{"value":"off"}}
Content-Length: 149
{"jsonrpc":"2.0","id":20,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":21,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":22,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":23,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 149
{"jsonrpc":"2.0","id":24,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":25,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":26,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":27,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 76
{"jsonrpc":"2.0","method":"$/setTraceNotification","params":{"value":"off"}}
Content-Length: 9412
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MA103OPC.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"rwmake.ch\"\r\n#include \"protheus.ch\"  \r\n\r\n/* \r\nDesenvolvido para Itinga Minegaracao/Qualita\r\nBruno Lage\r\nData : 21/03/2019\r\n*/\r\n\r\n\r\nUser Function MA103OPC()\r\n**************************************************************************************\r\n*\t/**/\r\n*\r\n***\r\nLocal   aRet := {}\r\n  \r\n\t//Aadd(aRet ,{\"COMPLEMENTOS FISCAIS\"  ,\"a910Compl\"     , 0 , 4 ,0 ,NIL})\t\r\n\tAadd(aRet ,{\"PDF FINANCEIROS\"       ,\"u_MAddPDFTit()\", 0 , 4 ,0 ,NIL})\r\n\t\r\n\tAadd(aRet ,{\"Rateio Custo Serviço\"  ,\"U_GROA015\"     , 0 , 2 ,0 ,NIL})\r\n\t\r\n\t\r\n\tIf SubString(CNUMEMP,1,2) == \"01\"\r\n\t\tAadd(aRet ,{\"CONTROLE BX DIRETA\" ,\"u_CBXDIRETA()\" , 0 , 4 ,0 ,NIL})\r\n\tEndIf\r\n\t\r\n\tAadd(aRet ,{\"Estorna Classificação\"\t ,\"u_MVALIDEST()\" \t , 0 , 5, 0, nil})\r\n\r\n\r\nReturn(aRet)\r\n\r\nUser Function MVALIDEST()\r\n**************************************************************************************\r\n*\t/**/\r\n*\r\n***\r\nLocal lRet := .T.\r\nLocal aArea:= GetArea()\r\n\r\nIF dDatabase <> SF1->F1_DTDIGIT\r\n\tAlert(\"Você não pode excluir a NF fora da data de entrada original. Data digitada:\" + dToC(SF1->F1_DTDIGIT))\r\n\tlRet := .F.\r\nElse\r\n\tA140EstCla()\r\nEndIf\r\n\r\nRestArea(aArea)\r\n\r\nReturn(lRet)\r\n\r\n\r\nUser Function CBXDIRETA()\r\n***********************************************************************************************************\r\n*  // Controle de baixas Direas\r\n*\r\n***  \r\n\r\n// Variaveis Locais da Funcao\r\nPrivate cEdit1\t := Space(25)\r\nPrivate cEdit2\t := Space(25)\r\nPrivate cEdit3\t := Space(25)\r\nPrivate cEdit4\t := Space(30)\r\nPrivate cEdit5\t := Space(25)\r\nPrivate cEdit6\t := Space(25)\r\nPrivate cEdit7\t := Space(25)\r\nPrivate cMemo1\t := \"\"\r\n\r\nPrivate lCheckBox1\t := .T.\r\nPrivate oCheckBox1\r\n\r\nPrivate oEdit1\r\nPrivate oEdit2\r\nPrivate oEdit3\r\nPrivate oEdit4\r\nPrivate oEdit5\r\nPrivate oEdit6\r\nPrivate oEdit7\r\nPrivate oMemo1\r\n\r\n// Variaveis Private da Funcao\r\nPrivate _oDlg\t\t\t\t// Dialog Principal\r\nPrivate lChaveOk := .F.\r\n\r\ndbSelectArea(\"ZA1\")\r\ndbSetOrder(2)\r\nIf dbSeek(xFilial(\"ZA1\") + SF1->F1_FILIAL + SF1->F1_DOC + SF1->F1_SERIE + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_TIPO  )\r\n\tlChaveOk := .f.\t\r\n\t\r\n\tcEdit1\t    := ZA1->ZA1_USUAIN\r\n\tcEdit2\t    := ZA1->ZA1_DTINC\r\n\tcEdit3\t    := ZA1->ZA1_HORAIN\r\n\tlCheckBox1  := ZA1->ZA1_STATUS\r\n\tcEdit4\t    := ZA1->ZA1_INDEX\r\n\tcMemo1      := ZA1->ZA1_OBS\r\n\t\r\n\tcEdit5\t    := ZA1->ZA1_USUBX\r\n\tcEdit6\t    := ZA1->ZA1_DTBX\r\n\t//cEdit7\t := \r\n\t\r\nElse\r\n\tlChaveOk := .t.\r\n\t\r\n\tcEdit1\t := SUBSTR(CUSUARIO,7,15)\r\n\tcEdit2\t := dDataBase\r\n\tcEdit3\t := TRIM(TIME())\r\n\tlCheckBox1 := .T.\r\n\tcEdit4\t := SF1->F1_FILIAL + SF1->F1_DOC + SF1->F1_SERIE + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_TIPO\r\nEndIf     \r\n\r\n            \r\nDEFINE MSDIALOG _oDlg TITLE \"Controle de baixa direta\" FROM U_MGETTELA(526),U_MGETTELA(779) TO U_MGETTELA(855),U_MGETTELA(1312) PIXEL\r\n\r\n\t// Cria as Groups do Sistema\r\n\t@ U_MGETTELA(000),U_MGETTELA(004) TO U_MGETTELA(058),U_MGETTELA(262) LABEL \" Dados: \" PIXEL OF _oDlg\r\n\r\n\t\t// Cria Componentes Padroes do Sistema\r\n\t\t@ U_MGETTELA(009),U_MGETTELA(011) Say \" Usuário: \" Size U_MGETTELA(021),U_MGETTELA(008) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(008),U_MGETTELA(085) Say \" Data:    \" Size U_MGETTELA(015),U_MGETTELA(008) COLOR CLR_BLUE PIXEL OF _oDlg\t\t\r\n\t\t@ U_MGETTELA(009),U_MGETTELA(163) Say \" Hora:    \" Size U_MGETTELA(013),U_MGETTELA(008) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(019),U_MGETTELA(011) MsGet oEdit1 Var cEdit1 Size U_MGETTELA(060),U_MGETTELA(009) WHEN(.F.) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(019),U_MGETTELA(085) MsGet oEdit2 Var cEdit2 Size U_MGETTELA(060),U_MGETTELA(009) WHEN(.F.) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(019),U_MGETTELA(163) MsGet oEdit3 Var cEdit3 Size U_MGETTELA(034),U_MGETTELA(009) WHEN(.F.) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(019),U_MGETTELA(206) CheckBox oCheckBox1 Var lCheckBox1 Prompt \" Pendente? \" Size U_MGETTELA(048),U_MGETTELA(008) WHEN(.F.) PIXEL OF _oDlg\r\n\t\t\r\n\t\t@ U_MGETTELA(032),U_MGETTELA(011) Say \" Chave de pesquisa: \" Size U_MGETTELA(047),U_MGETTELA(008) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(042),U_MGETTELA(011) MsGet oEdit4 Var cEdit4 Size U_MGETTELA(240),U_MGETTELA(009) WHEN(.F.) COLOR CLR_BLUE PIXEL OF _oDlg\r\n\t\r\n\t@ U_MGETTELA(060),U_MGETTELA(005) Say \" Observações: \" Size U_MGETTELA(035),U_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(068),U_MGETTELA(005) GET oMemo1 Var cMemo1 MEMO Size U_MGETTELA(256),U_MGETTELA(045) WHEN(lChaveOk) PIXEL OF _oDlg\r\n\r\n\t@ U_MGETTELA(117),U_MGETTELA(006) TO U_MGETTELA(157),U_MGETTELA(209) LABEL \" Confirmação das baixas: \" PIXEL OF _oDlg\t\r\n\t\t@ U_MGETTELA(133),U_MGETTELA(012) Say \" Usuário: \" Size U_MGETTELA(021),U_MGETTELA(008) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(134),U_MGETTELA(085) Say \" Data:    \" Size U_MGETTELA(015),U_MGETTELA(008) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t//@ U_MGETTELA(134),U_MGETTELA(164) Say \" Hora:    \" Size U_MGETTELA(015),U_MGETTELA(008) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(144),U_MGETTELA(011) MsGet oEdit5 Var cEdit5 Size U_MGETTELA(060),U_MGETTELA(009) WHEN(.F.) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t@ U_MGETTELA(144),U_MGETTELA(085) MsGet oEdit6 Var cEdit6 Size U_MGETTELA(060),U_MGETTELA(009) WHEN(.F.) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\t//@ U_MGETTELA(144),U_MGETTELA(163) MsGet oEdit7 Var cEdit7 Size U_MGETTELA(037),U_MGETTELA(009) WHEN(.F.) COLOR CLR_RED PIXEL OF _oDlg\r\n\t\r\n\t@ U_MGETTELA(124),U_MGETTELA(223) Button \" Excluir \" Action(CBXDIRGRAVA(2,lChaveOk),_oDlg:End() ) Size U_MGETTELA(037),U_MGETTELA(012) PIXEL OF _oDlg\r\n\t@ U_MGETTELA(144),U_MGETTELA(223) Button \" Salvar  \" Action(CBXDIRGRAVA(1,lChaveOk),_oDlg:End() ) Size U_MGETTELA(037),U_MGETTELA(012) PIXEL OF _oDlg\r\n\r\nACTIVATE MSDIALOG _oDlg CENTERED \r\n\r\nReturn(.T.)\r\n\r\n\r\nStatic Function CBXDIRGRAVA(nTipo,lChaveOk)\r\n***********************************************************************************************************\r\n*  // Controle de baixas direas Grava\r\n*\r\n***  \r\n//Alert(nTipo)\r\n\r\nIf nTipo = 1\r\n\t RecLock( 'ZA1', .T. )\t\r\n\t  \tReplace ZA1->ZA1_FILIAL With xFilial(\"ZA1\")\r\n\t\tReplace ZA1->ZA1_STATUS With lCheckBox1 \r\n\t\tReplace ZA1->ZA1_USUAIN With AllTrim(cEdit1)\r\n\t\tReplace ZA1->ZA1_DTINC  With cEdit2\r\n\t\tReplace ZA1->ZA1_HORAIN With SubStr(cEdit3,1,5)\r\n\t\tReplace ZA1->ZA1_INDEX  With AllTrim(cEdit4)\r\n\t\tReplace ZA1->ZA1_OBS    With UPPER(AllTrim(cMemo1))\r\n\t MsUnLock()\r\n\t AVISO(\"Salvando...\", \"Dados salvo com sucesso!\" , { \"Fechar\" }, 1)\r\nEndIf\r\n\r\nIf nTipo = 2 .AND. lChaveOk == .F.\r\n\t RecLock( 'ZA1', .F. )\t\r\n\t \tDbDelete()\r\n\t MsUnLock()\r\n\t AVISO(\"Deletando...\", \"Dados excluídos com sucesso!\" , { \"Fechar\" }, 1)\r\nEndIf\r\n\r\nReturn(.T.)\r\n\r\n\r\nUser Function MAddPDFTit()\r\n**************************************************************************************\r\n*\t/**/\r\n*\r\n***\r\nLocal nCont  := 0\r\nLocal nContx := 0\r\nLocal cMsgAlert := \"\"\r\n\r\n\t/*\r\n\tContagem de quantos \r\n\ttitulos possuem a nota.\r\n\t*/\r\n\tdbSelectArea(\"SE2\")\r\n\tdbSetOrder(6) \r\n\tdbSeek( SF1->F1_FILIAL + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_SERIE + SF1->F1_DOC  )\r\n\r\n\tDo While ( SF1->F1_FILIAL + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_SERIE + SF1->F1_DOC  ) == ( SE2->E2_FILIAL + SE2->E2_FORNECE + SE2->E2_LOJA + SE2->E2_PREFIXO + SE2->E2_NUM)\r\n\t\tnCont := nCont + 1\r\n\t\tdbSelectArea(\"SE2\")\r\n\t\tdbSkip()\r\n\tEndDo\r\n\t\r\n\t/*\r\n\tMensagem para ser exibida durante a \r\n\tadição dos anexos\r\n\t*/\r\n\tdbSelectArea(\"SE2\")\r\n\tdbSetOrder(6) \r\n\tIf dbSeek( SF1->F1_FILIAL + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_SERIE + SF1->F1_DOC  )\t\r\n\t\tDo While ( SF1->F1_FILIAL + SF1->F1_FORNECE + SF1->F1_LOJA + SF1->F1_SERIE + SF1->F1_DOC  ) == ( SE2->E2_FILIAL + SE2->E2_FORNECE + SE2->E2_LOJA + SE2->E2_PREFIXO + SE2->E2_NUM)\r\n\t\r\n\t\t\t\tnContx := nContx + 1\r\n\t\t\t\tcMsgAlert := \"\"\r\n\t\t\t\tcMsgAlert += \"Foi encontrado 0\" + AllTrim(Str(nCont)) +\" parcela(s).[0\" + AllTrim(Str(nCont))+\"/0\"+  AllTrim(Str(nContx))+\"]\" + chr(13)+chr(10)   \r\n\t\t\t\tcMsgAlert += \"Adicione os arquivos PDF conforme seguência abaixo:\" + chr(13)+chr(10)   \r\n\t\t\t\tcMsgAlert += \"PDF da Nota fiscal na Primeira linha. NF: \" + SF1->F1_DOC + chr(13)+chr(10)\r\n\t\t\t\tIf nCont <> 1\r\n\t\t\t\t\tcMsgAlert += \"PDF do boleto Parcela [\" +SE2->E2_PARCELA + \"] no segundo anexo.\" + chr(13)+chr(10)\r\n\t\t\t\tElse\r\n\t\t\t\t\tcMsgAlert += \"PDF do boleto no segundo anexo.\" + chr(13)+chr(10)\r\n\t\t\t\tEndIf\r\n\t\t\t\tAVISO(\"Adicionando PDF,s\", cMsgAlert , { \"Fechar\" }, 1)\r\n\t\t\t\tMsDocument('SE2',SE2->(RecNo()), 4,)\r\n\t\t\r\n\t\t\tdbSelectArea(\"SE2\")\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\tElse\r\n\t\tAlert(\"Não foi encontrado títulos financeiros para anexar os PDF´s!\")\r\n\tEndIf\r\n\t\r\nReturn() \r\n"}}}
Content-Length: 167
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MA103OPC.prw"}}}
Content-Length: 1642
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/mXdtVal.prw","languageId":"advpl","version":1,"text":"#include 'protheus.ch'\n#include 'parmtype.ch'\n//VENCIMENTO FINANCEIRO\n//MV_UCONPGL\n\nUser Function mXdtVal(cProg)\n***********************************************************************************\n*//M->E2_VENCTO >= (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n*//IIF(RetCodUsr()$\"000003/000031/000028\" .OR. \"PA\"$M->E2_TIPO,.T.,M->E2_VENCTO >= (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)) \n***\nLocal lRet    := .T.\nLocal amXdtVal:= GetArea()\nLocal cULiberado := GetMV(\"MV_UCONPGL\")\n\n\tIf AllTrim(FunName()) $ \"MATA103/MATA116/U_GATI001\" \n\t\tIF (!RetCodUsr() $ cULiberado )\n\t\t\tIF cProg = \"MT103FIN\"\n\t\t\t\tIF aLocCols[1][2] < (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n\t\t\t\t\tlRet := .F.\n\t\t\t\tEndIf\n\t\t\tElse\n\t\t\t\tIF M->E2_VENCTO < (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n\t\t\t\t\tlRet := .F.\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tEndIf\n\n\tElseIf (AllTrim(FunName()) $ \"AUTPAG/IMPORT\") \n\t\tIF( !AllTrim(M->E2_TIPO) $ \"PA/GUI/FOL\")\n\t\t\tIF (!RetCodUsr() $ cULiberado )\n\t\t\t\tIF M->E2_VENCTO < (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n\t\t\t\t\tlRet := .F.\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tEndIf\n\tElse\n\n\t\tIF( AllTrim(M->E2_TIPO) <> \"PA\")\n\t\t\tIF (!RetCodUsr() $ cULiberado ) \n\t\t\t\tIF M->E2_VENCTO < (STOD(FWTIMEUF(GETMV(\"MV_ESTADO\"))[1])+5)\n\t\t\t\t\tlRet := .F.\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tEndIf\n\n\tEndIF\n\t\n\tRestArea(amXdtVal)\n\nReturn(lRet)\n"}}}
Content-Length: 166
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/mXdtVal.prw"}}}
Content-Length: 765
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/03_CONEX%C3%83ONFE/MTA103MNU.PRW","languageId":"advpl","version":1,"text":"/* ####################################################################### *\\\r\n|| #           PONTO DE ENTRADA UTILIZADO PELO IMPORTADOR GATI           # ||\r\n|| #                                                                     # ||\r\n|| #    PONTO DE ENTRADA UTILIZADO PARA INSERIR NOVAS OPÇÕES NO ARRAY    # ||\r\n|| #                   AROTINA EM DOCUMENTO DE ENTRADA                   # ||\r\n\\* ####################################################################### */\r\n\r\nUser Function GMTA103MNU()\r\n\tU_GTPE010()\r\nReturn"}}}
Content-Length: 176
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/03_CONEX%C3%83ONFE/MTA103MNU.PRW"}}}
Content-Length: 763
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/01_SOMENTE_ITINGA/MTA103MNU.PRW","languageId":"advpl","version":1,"text":"/* ####################################################################### *\\\r\n|| #           PONTO DE ENTRADA UTILIZADO PELO IMPORTADOR GATI           # ||\r\n|| #                                                                     # ||\r\n|| #    PONTO DE ENTRADA UTILIZADO PARA INSERIR NOVAS OPÇÕES NO ARRAY    # ||\r\n|| #                   AROTINA EM DOCUMENTO DE ENTRADA                   # ||\r\n\\* ####################################################################### */\r\n\r\nUser Function MTA103MNU()\r\n\tU_GTPE010()\r\nReturn"}}}
Content-Length: 175
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/01_SOMENTE_ITINGA/MTA103MNU.PRW"}}}
Content-Length: 2362
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/01_SOMENTE_ITINGA/MT103FIM.PRW","languageId":"advpl","version":1,"text":"#INCLUDE \"RWMAKE.CH\"\r\n/* ####################################################################### *\\\r\n|| #           PONTO DE ENTRADA UTILIZADO PELO IMPORTADOR GATI           # ||\r\n|| #                                                                     # ||\r\n|| #  É EXECUTADO DEPOIS QUE A NOTA É EXCLUÍDA PARA FAZER O XML VOLTAR   # ||\r\n|| #                  PARA A TELA INICIAL DO IMPORTADOR                  # ||\r\n\\* ####################################################################### */\r\n\r\n/*\r\nSO funciona na qualita pois foi incapsulado o ponto original para o GrPlus\r\nNão pode usar o MT103FIM\r\nESTE E PARA ITINGA\r\n*/\r\n\r\nUser Function MT103FIM()\r\n\r\nLocal nOpcao    := PARAMIXB[1]   // Opção Escolhida pelo usuario no aRotina\r\nLocal nConfirma := PARAMIXB[2]   // Se o usuario confirmou a operação de gravação da NFE\r\nLocal Usuario   := \"\"\r\n\r\n\r\nU_GTPE002()\r\n\r\nConOut(\"*****************************\")\r\nConOut(\"MT103FIM() NÃO USAR NO GRPLUS Informativo dos parametros\")\r\nConOut(CNUMEMP)\r\nConOut(SUBSTR(CUSUARIO,7,15)+\" \"+TRIM(DTOC(DATE()))+\" \"+TRIM(TIME())+\" \"+TRIM(COMPUTERNAME()))\r\nConOut(nConfirma )\r\nConOut(nOpcao)\r\nConOut(\"*****************************\")\r\n\r\nUsuario := SUBSTR(CUSUARIO,7,15)+\" \"+TRIM(DTOC(DATE()))+\" \"+TRIM(TIME())+\" \"+TRIM(COMPUTERNAME())\r\n\r\nIF INCLUI  \r\n\tIf RecLock(\"SF1\",.F.) \r\n\t\tIf nConfirma == 1 .and. nOpcao == 3 \r\n\t\t   \r\n\t\t    ConOut(\"*****************************\")\r\n\t\t    ConOut(Usuario)   \r\n\t    \tConOut(\"GMT103FIM() Entrou\")\r\n\t    \tConOut(\"*****************************\")\r\n\t    \t\r\n\t    \t//Replace F1_INCUSER With cUserName     \r\n\t    \tReplace F1_INCUSER With Usuario \r\n\t\t\tReplace F1_ESPECI4 With SED->ED_CODIGO\r\n\t\t\t//Replace F1_NATUREZ With SED->ED_CODIGO\r\n\t\tElse\r\n\t\t\tConOut(\"*****************************\")\r\n\t\t    ConOut(Usuario)   \r\n\t    \tConOut(\"GMT103FIM() Nao entrou\")\r\n\t    \tConOut(\"*****************************\")\r\n\t    \t\r\n\t\t\r\n\t\tEndIf\r\n\t\r\n\t\tMsUnLock()\r\n\tEndIf\r\nENDIF\r\n\r\n\r\nReturn(.T.)\r\n"}}}
Content-Length: 209
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","languageId":"advpl","version":1,"text":""}}}
Content-Length: 219
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":3},"contentChanges":[{"text":"\r\n\r\n"}]}}
Content-Length: 243
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":4},"contentChanges":[{"text":"\r\n\r\nUser Function MT103FIM()"}]}}
Content-Length: 247
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":5},"contentChanges":[{"text":"\r\n\r\n\r\nUser Function MT103FIM()"}]}}
Content-Length: 269
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":6},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\nUser Function MT103FIM()"}]}}
Content-Length: 273
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":7},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103FIM()"}]}}
Content-Length: 281
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":9},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103FIM()\r\n\r\n"}]}}
Content-Length: 293
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":10},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103FIM()\r\n\r\nReturn(.T.)"}]}}
Content-Length: 307
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":11},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103FIM()\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 307
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":12},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 311
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":13},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 315
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":14},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\n\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 316
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":15},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nS\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":28,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":1},"context":{"triggerKind":1}}}
Content-Length: 319
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":17},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nSEÇ\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 316
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":19},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nS\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 317
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":20},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nSa\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":29,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":2},"context":{"triggerKind":1}}}
Content-Length: 318
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":21},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nSal\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 316
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":23},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nS\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":30,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":1},"context":{"triggerKind":1}}}
Content-Length: 316
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":25},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nA\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":31,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":1},"context":{"triggerKind":1}}}
Content-Length: 317
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":26},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAl\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 319
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":28},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAler\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 320
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":29},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAlert\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 322
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":31},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAlert()\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 326
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":32},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAlert(\"\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":33},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAlert(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 330
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":34},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nA(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":32,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":1},"context":{"triggerKind":1}}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":38},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":33,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":5},"context":{"triggerKind":1}}}
Content-Length: 337
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":39},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVIS.or.(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":42},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVIS.(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 333
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":43},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVIS(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":44},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISI(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":34,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":5},"context":{"triggerKind":1}}}
Content-Length: 333
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":45},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVIS(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 334
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":46},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 241
{"jsonrpc":"2.0","id":35,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":5},"context":{"triggerKind":1}}}
Content-Length: 335
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":47},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",)\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 339
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":48},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 339
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":49},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 340
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":50},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 341
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":51},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 342
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":52},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.O\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 342
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":54},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\")\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 343
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":55},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",)\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 345
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":56},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 345
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":57},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 346
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":58},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{O})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 242
{"jsonrpc":"2.0","id":36,"method":"textDocument/completion","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"},"position":{"line":6,"character":25},"context":{"triggerKind":1}}}
Content-Length: 347
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":59},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{OK})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 345
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":61},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 349
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":62},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{\"\"})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 351
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":64},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"P.E\",{\"OK\"})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 356
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":65},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"})\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 357
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":66},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},)\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 358
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":67},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})"}]}}
Content-Length: 1239
{"jsonrpc":"2.0","id":37,"method":"$totvsserver/compilation","params":{"compilationInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw==","environment":"compila_q","includeUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/include"],"fileUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"],"compileOptions":{"recompile":true,"debugAphInfo":true,"gradualSending":true,"generatePpoFile":false,"showPreCompiler":false,"priorVelocity":true,"returnPpo":false,"commitWithErrorOrWarning":false},"extensionsAllowed":[".PRW",".PRX",".PRG",".PPX",".PPP",".TLPP",".APW",".APH",".APL",".AHU",".TRES",".PNG",".BMP",".RES",".4GL",".PER",".JS",".RPTDESIGN"],"includeUrisRequired":true}}}
Content-Length: 362
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":68},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\nAVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 179
{"jsonrpc":"2.0","method":"textDocument/didSave","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":68}}}
Content-Length: 1239
{"jsonrpc":"2.0","id":38,"method":"$totvsserver/compilation","params":{"compilationInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw==","environment":"compila_q","includeUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/include"],"fileUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"],"compileOptions":{"recompile":true,"debugAphInfo":true,"gradualSending":true,"generatePpoFile":false,"showPreCompiler":false,"priorVelocity":true,"returnPpo":false,"commitWithErrorOrWarning":false},"extensionsAllowed":[".PRW",".PRX",".PRG",".PPX",".PPP",".TLPP",".APW",".APH",".APL",".AHU",".TRES",".PNG",".BMP",".RES",".4GL",".PER",".JS",".RPTDESIGN"],"includeUrisRequired":true}}}
Content-Length: 1239
{"jsonrpc":"2.0","id":39,"method":"$totvsserver/compilation","params":{"compilationInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw==","environment":"compila_q","includeUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/include"],"fileUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"],"compileOptions":{"recompile":true,"debugAphInfo":true,"gradualSending":true,"generatePpoFile":false,"showPreCompiler":false,"priorVelocity":true,"returnPpo":false,"commitWithErrorOrWarning":false},"extensionsAllowed":[".PRW",".PRX",".PRG",".PPX",".PPP",".TLPP",".APW",".APH",".APL",".AHU",".TRES",".PNG",".BMP",".RES",".4GL",".PER",".JS",".RPTDESIGN"],"includeUrisRequired":true}}}
Content-Length: 364
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":70},"contentChanges":[{"text":"\r\n\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 356
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":72},"contentChanges":[{"text":"#INCLUDE \"RWMAKE.CH\"\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 1239
{"jsonrpc":"2.0","id":40,"method":"$totvsserver/compilation","params":{"compilationInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw==","environment":"compila_q","includeUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/include"],"fileUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"],"compileOptions":{"recompile":true,"debugAphInfo":true,"gradualSending":true,"generatePpoFile":false,"showPreCompiler":false,"priorVelocity":true,"returnPpo":false,"commitWithErrorOrWarning":false},"extensionsAllowed":[".PRW",".PRX",".PRG",".PPX",".PPP",".TLPP",".APW",".APH",".APL",".AHU",".TRES",".PNG",".BMP",".RES",".4GL",".PER",".JS",".RPTDESIGN"],"includeUrisRequired":true}}}
Content-Length: 179
{"jsonrpc":"2.0","method":"textDocument/didSave","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":72}}}
Content-Length: 174
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/01_SOMENTE_ITINGA/MT103FIM.PRW"}}}
Content-Length: 581327
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO/nfesefaz.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"PROTHEUS.CH\"   \r\n#INCLUDE \"COLORS.CH\"\r\n#INCLUDE \"TBICONN.CH\"\r\n\r\n/*\r\n****************************************************************\r\nDATA DO ARQUIVO: Quarta-feira, 18/06/2020, \r\nDATA DA IMPLEMENTAÇÃO: 16/09/2020\r\n****************************************************************\r\n*/\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³XmlNFeSef ³ Autor ³ Eduardo Riera         ³ Data ³13.02.2007³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Rdmake de- exemplo para geracao da Nota Fiscal Eletronica do ³±±\r\n±±³          ³SEFAZ - Versao T01.00 / 2.00                                ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³String da Nota Fiscal Eletronica                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ExpC1: Tipo da NF                                           ³±±\r\n±±³          ³       [0] Entrada                                          ³±±\r\n±±³          ³       [1] Saida                                            ³±±\r\n±±³          ³ExpC2: Serie da NF                                          ³±±\r\n±±³          ³ExpC3: Numero da nota fiscal                                ³±±\r\n±±³          ³ExpC4: Codigo do cliente ou fornecedor                      ³±±\r\n±±³          ³ExpC5: Loja do cliente ou fornecedor                        ³±± \r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nUser Function XmlNfeSef(cTipo,cSerie,cNota,cClieFor,cLoja,cNotaOri,cSerieOri)\r\n\r\n//Declaração de Arrays\r\nLocal aNota     \t:= {}\r\nLocal aDupl     \t:= {}\r\nLocal aDest     \t:= {}\r\nLocal aEntrega  \t:= {}\r\nLocal aProd     \t:= {}\r\nLocal aICMS     \t:= {}\r\nLocal aICMSST   \t:= {}\r\nLocal aICMSZFM\t\t:= {}\r\nLocal aIPI      \t:= {}\r\nLocal aPIS      \t:= {}                         \r\nLocal aCOFINS   \t:= {}\r\nLocal aPISST    \t:= {}\r\nLocal aCOFINSST \t:= {}\r\nLocal aISSQN   \t\t:= {}\r\nLocal aISS      \t:= {}\r\nLocal aCST      \t:= {}\r\nLocal aRetido   \t:= {}\r\nLocal aTransp   \t:= {}\r\nLocal aImp      \t:= {}\r\nLocal aVeiculo  \t:= {}\r\nLocal aDetPag\t\t:= {}  \r\nLocal aReboque  \t:= {}\r\nLocal aReboqu2  \t:= {}\r\nLocal aEspVol   \t:= {}\r\nLocal aNfVinc   \t:= {}\r\nLocal aPedido   \t:= {}\r\nLocal aOldReg   \t:= {}\r\nLocal aOldReg2  \t:= {}\r\nLocal aMed\t\t\t:= {}\r\nLocal aArma\t\t\t:= {}\r\nLocal aComb\t\t\t:= {}\r\nLocal aveicProd\t\t:= {}\r\nLocal aLote\t\t\t:= {}\r\nLocal aIEST\t\t\t:= {}\r\nLocal aDI\t\t\t:= {}\r\nLocal aAdi\t\t\t:= {}\r\nLocal aExp\t\t\t:= {}\r\nLocal aDados\t\t:= {}\r\nLocal aPisAlqZ\t\t:= {}\r\nLocal aCofAlqZ\t\t:= {}\r\nLocal aCsosn\t\t:= {}\r\nLocal aIPIDev\t\t:= {}\r\nLocal aIPIAux\t\t:= {}\r\nLocal aNotaServ \t:= {}\r\nLocal aAnfC\t   \t\t:= {}\r\nLocal aAnfI\t   \t\t:= {} \r\nLocal aPedCom   \t:= {} \r\nLocal aInfoItem\t\t:= {}\r\nLocal aNfVincRur\t:= {}\r\nLocal aRefECF\t\t:= {}\r\nLocal aAreaSD2  \t:= {}    \t\t\t// Area do SD2\r\nLocal aAreaSF2  \t:= {}    \t\t\t// Area do SF2\r\nLocal cNfeArea\t\t:= {}\r\nLocal aRetServ \t\t:= {}\r\nLocal aRetirada\t\t:= {}\r\nLocal aMotivoCont \t:= {}\r\nLocal aTotal    \t:= {0,0,0}\r\nLocal aFCI\t\t\t:= {}\r\nLocal aDocDat\t\t:= {}\r\nLocal aICMUFDest\t:= {}\r\nLocal aIPIDevol\t\t:= {}\r\nLocal aSb1\t\t\t:= {}\r\nLocal aAgrPis\t\t:= {}\t\t\t\t\t\t\t\t\t// Verifica se a TES utiliza agrega Pis para incluir o valor na Tag vOutros\r\nLocal aAgrCofins\t:= {}\t\t\t\t\t\t\t\t\t// Verifica se a TES utiliza agrega Cofins para incluir o valor na Tag vOutros\r\nLocal aItemCupRef\t:= {}\t\t\t\t\t\t\t\t\t// Array para itens dos cupons vinculados na nota sobre cupom\r\nLocal aCupRefLoj\t:= {}\t\t\t\t\t\t\t\t\t// Array para buscar cupons relacionados na nota sobre cupom(quando e utilizado a rotina de multiplos cupons na nota sobre cupom)\r\nLocal aItemVinc\t\t:= {}\t\t\t\t\t\t\t\t\t// Array para as notas vinculadas por item\r\nLocal cAmbiente\t\t:= {}\r\nLocal cVerAmb\t\t:= {}\r\nLocal aMensAux\t\t:= {}\r\nLocal aTelEmit\t\t:= {}\r\nLocal aCMPUSR\t\t:= {}\r\nLocal aFat\t\t\t:= {}\r\nLocal aValTotOpe\t:= {}\r\n\r\n//Declaração de Strings\r\nLocal cString    \t:= \"\"\r\nLocal cNatOper   \t:= \"\"\r\nLocal cModFrete  \t:= \"\"\r\nLocal cScan      \t:= \"\"\r\nLocal cEspecie   \t:= \"\"\r\nLocal cMensCli   \t:= \"\"\r\nLocal cMensONU\t\t:= \"\"\r\nLocal cMensFis   \t:= \"\"\r\nLocal cNFe       \t:= \"\"\r\nLocal cMVSUBTRIB \t:= \"\"\r\nLocal cLJTPNFE\t\t:= \"\"\r\nLocal cWhere\t\t:= \"\"\r\nLocal cMunISS\t\t:= \"\"\r\nLocal cCodIss\t\t:= \"\"\r\nLocal cValIPI    \t:= \"\"\r\nLocal cNCM\t     \t:= \"\" \r\nLocal cField\t\t:= \"\"\r\nLocal cRetISS   \t:= \"\"\r\nLocal cTipoNF   \t:= \"\"\r\nLocal cDocEnt  \t\t:= \"\"\r\nLocal cSerEnt  \t\t:= \"\"\r\nLocal cFornece  \t:= \"\"\r\nLocal cLojaEnt  \t:= \"\"\r\nLocal cTipoNFEnt\t:= \"\"\r\nLocal cPedido   \t:= \"\"\r\nLocal cItemPC   \t:= \"\"\r\nLocal cNFOri    \t:= \"\"\r\nLocal cSerOri   \t:= \"\"\r\nLocal cItemOri  \t:= \"\"\r\nLocal cProd     \t:= \"\"\r\nLocal cLote         := \"\"\r\nLocal cTribMun  \t:= \"\"\r\nLocal cModXML   \t:= \"\"\r\nLocal cItem\t\t\t:= \"\"\r\nLocal cAnfavea\t\t:= \"\"\r\nLocal cSerNfCup \t:= \"\"\t// Serie da NF sobre Cupom\r\nLocal cNumNfCup \t:= \"\"\t// Numero do Documento da NF sobre Cupom\r\nLocal cD2Cfop  \t\t:= \"\"  // CFOP da nota \r\nLocal cD2Tes  \t\t:= \"\"\t// TES do SD2\r\nLocal cSitTrib\t\t:= \"\"\r\nLocal cValST  \t\t:= \"\"\r\nLocal cBsST    \t\t:= \"\"\r\nLocal cChave \t\t:= \"\"\r\nLocal cItemOr\t\t:= \"\"\r\nLocal cCST      \t:= \"\"\r\nLocal cInfAdic\t\t:= \"\"\r\nLocal cUmDipi       := \"\"\r\nLocal nConvDip      := 0\r\nLocal cServ     \t:= \"\"\r\nLocal cMunPres  \t:= \"\"\r\nLocal cAliasSE1  \t:= \"SE1\"\r\nLocal cAliasSE2  \t:= \"SE2\"\r\nLocal cAliasSD1  \t:= \"SD1\"\r\nLocal cAliasSD2  \t:= \"SD2\" \r\nlocal cAliasSB5   \t:=\"SB5\"\r\nLocal cAnttRntrc\t:= iif(!Empty(SM0->M0_RNTRC),AllTrim(SM0->M0_RNTRC), AllTrim(SuperGetMV(\"MV_TMSANTT\",,\"\")))  //Parametro do TMS que informa o codigo ANTT do transpotador\r\nLocal cMVNFEMSA1\t:= AllTrim(GetNewPar(\"MV_NFEMSA1\",\"\"))\r\nLocal cMVNFEMSF4\t:= AllTrim(GetNewPar(\"MV_NFEMSF4\",\"\"))\r\nLocal cMVCFOPREM\t:= AllTrim(GetNewPar(\"MV_CFOPREM\",\"\"))     // Parâmetro que informa as CFOPs de Remessa para entrega Futura que terão tratamento para que o valor de IPI seja considerado como Outras Despesas Acessórias (tag vOutros).\r\n//Local cConjug   \t:= AllTrim(SuperGetMv(\"MV_NFECONJ\",,\"\"))\r\nLocal cMV_LJTPNFE\t:= SuperGetMV(\"MV_LJTPNFE\", ,\" \")\r\nLocal cValLiqB\t\t:= SuperGetMv(\"MV_BR10925\", ,\"2\")\r\nLocal cDescServ \t:= SuperGetMV(\"MV_NFESERV\", ,\"2\")\r\nlocal cMVREFNFE\t\t:= SuperGetMV(\"MV_REFNFE\", ,\" \") \t\t\t// Parametro para informe quais CFOPs são de simples Remessa para levar informação \r\nLocal cMVCfopTran\t:= SuperGetMV(\"MV_CFOPTRA\", ,\" \")   \t\t// Parametro que define as CFOP´s pra transferência de Crédito/Débito\r\nLocal cCliLoja\t\t:= \"\" \r\nLocal cCliNota\t\t:= \"\"\r\nLocal cInfAdPr\t\t:= SuperGetMV(\"MV_INFADPR\", .F.,\"2\")      // Parametro que define de onde sera impressa as informacoes adicionais do produto\r\nLocal cInfAdPed  \t:= \"\"\r\nLocal cCodProd\t\t:= \"\" \r\nLocal cDescProd\t\t:= \"\"\r\nLocal cMsSeek\t\t:= \"\"\r\nLocal cTpPessoa\t\t:= \"\"\r\nLocal cSeekD1\t\t:= \"\"  \r\nLocal cSeekAux\t\t:= \"\" \r\nLocal cIpiCst\t\t:= \"\"\r\nLocal cNfRefcup\t\t:= \"\"\r\nLocal cSerRefcup\t:= \"\"\r\nLocal cOrigem\t\t:= \"\"\r\nLocal cCSTrib\t\t:= \"\"\r\nLocal cMsgFci\t\t:= \"\"\r\nLocal cChaveD2\t\t:= \"\"\r\nLocal cChaveF2\t\t:= \"\"\r\nLocal cTpOper\t\t:= \"\" //Tipo de operação complemento\r\nLocal cChaveD1\t\t:= \"\" \r\nLocal cMVAEHC \t\t:= AllTrim(GetNewPar(\"MV_AEHC\",\"\"))     // Informar o código de classificação AEHC\r\nLocal cHoraNota\t\t:= \"\"\r\nLocal cIndPres\t\t:= \"\"\r\nLocal cIndIss\t\t:= \"\"\r\nLocal cFilDev\t\t:= \"\"\t\t//Guarda filial de devolução\r\nLocal cTpGar\t\t:= SuperGetMV(\"MV_LJTPGAR\",,\"GE\")\r\nLocal cFieldMsg\t\t:= \"\"\r\nLocal cSpecie\t\t:= \"\"\r\nLocal cChCupom\t\t:= \"\"\r\nLocal cDevMerc\t\t:= \"\" //Identifica devolução de mercadoria que não foi entregue ao destinatário em atendimento ao Artigo 453, I, do RICMS/2000 SP)\r\nLocal cEndEmit\t\t:= \"\"\r\nLocal cFoneEmit\t\t:= \"\"\r\nLocal cCodlan\t\t:= \"\"\r\nLocal cMunTransp\t:= \"\"\r\nLocal cMunDest \t\t:= \"\"\r\nLocal cIndEscala\t:= \"\"\r\nLocal cMensDifal\t:= \"\"\r\nlocal cEstado       := \"\"\r\nlocal cICMSZFM      := \"\"\r\nLocal cMensCpl\t\t:= \"\"\r\n//Declaração de numéricos\r\nLocal nA\t\t\t:= 0\r\nLocal nX         \t:= 0\r\nLocal nCon       \t:= 1  \r\nLocal nCstIpi \t\t:= 1\r\nLocal nLenaIpi\t\t:= 0\r\nLocal nPosI\t\t\t:= 0\r\nLocal nPosF\t\t\t:= 0\r\nLocal nBaseIrrf  \t:= 0\r\nLocal nValIrrf   \t:= 0\r\nLocal nValIPI    \t:= 0\r\nLocal nValAux    \t:= 0\r\nLocal nValPisZF  \t:= 0\r\nLocal nValCofZF  \t:= 0\r\nLocal nPisRet   \t:= 0\r\nLocal nCofRet   \t:= 0\r\nLocal nInssRet  \t:= 0\r\nLocal nIrRet    \t:= 0\r\nLocal nCsllRet  \t:= 0\r\nLocal nDedu     \t:= 0\r\nLocal nIssRet   \t:= 0\r\nLocal nTotRet   \t:= 0\r\nLocal nRedBC    \t:= 0\r\nLocal nValST    \t:= 0\r\nLocal nValSTAux \t:= 0\r\nLocal nBsCalcST \t:= 0\r\nLocal nMargem\t\t:= 0\r\nLocal nDesconto \t:= 0   \t\t\t// Desconto no total da NF sobre cupom\r\nLocal nDescRed  \t:= 0   \t\t\t// Valores dos descontos dos itens referente ao Decreto nº 43.080/2002 RICMS-MG (SFT)\r\nLocal nDesTotal  \t:= 0   \t\t\t// Valor total dos descontos referente ao Decreto nº 43.080/2002 RICMS-MG\r\nLocal nDescIcm  \t:= 0   \t\t\t// Valor do desconto do ICMS-Quando TES configurada com AGREGA Valor = D\r\nLocal nDescZF\t  \t:= 0   \t\t\t// Valores dos descontos Zona Franca\r\nLocal nDescNfDup\t:= 0   \t\t\t// Valores dos descontos para deduzir os valores de ICMS diferido na NF e da Duplicata (opção: 6 – Diferido(Deduz NF e Duplicata)\t\r\nLocal nPercLeite\t:= 0\t  \t\t\t//Percentual da redução do Leite\t\r\nLocal nValLeite\t\t:= 0   \t\t\t//Valor da reduçao do Leite\r\nLocal nPrTotal\t\t:= 0   \r\nLocal nCont\t \t\t:= 0\r\nLocal nValBse\t\t:= 0\r\nLocal nValIss\t\t:= 0\r\nLocal nIcmsST\t\t:= 0\r\nLocal cNumitem\t\t:= 0\r\nLocal nOrderSF1\t\t:= 0\r\nLocal nRecnoSF1\t\t:= 0  \r\n//Local nValParImp\t\t:= 0\r\n//Local nContImp\t\t:= 0\r\nLocal nSF3Index\t\t:= 0\r\nLocal nSF3Recno\t\t:= 0\r\nlocal nValIPIDestac\t:= 0\r\nLocal nValIcmDev\t:= 0\r\nLocal nValIcmDif\t:= 0\r\nLocal nIPIConsig\t:= 0\r\nLocal nSTConsig\t\t:= 0\r\nLocal nValICMParc\t:= 0\r\nLocal nBasICMParc\t:= 0\r\nLocal nValSTParc \t:= 0\r\nLocal nBasSTParc \t:= 0\r\nLocal nVicmsDeson\t:= 0\r\nLocal nToTvBC\t\t:= 0\t\r\nLOcal nToTvICMS\t\t:= 0\r\nLocal nDeducao\t\t:= 0\r\nLocal nVIcmDif\t\t:= 0\r\nLocal nIcmsDif \t\t:= 0\r\nLocal nValISSRet\t:= 0\r\nLocal nValSimprem\t:= 0\r\nLocal nvFCPUFDest\t:= 0\r\nLocal nvICMSUFDest\t:= 0\r\nLocal nvICMSUFRemet\t:= 0\r\nLocal nvBCUFDest  \t:= 0 \r\nLocal npFCPUFDest \t:= 0 \r\nLocal npICMSUFDest\t:= 0 \r\nLocal npICMSInter \t:= 0 \r\nLocal npICMSIntP  \t:= 0 \r\nLocal nValTFecp\t    := 0\r\nLocal nValIFecp\t    := 0   \r\nLocal nTDescIt\t\t:= 0\r\nLocal nCount\t\t:= 0\r\nLocal nSD1Pos\t\t:= 0\r\nLocal nCountNF\t\t:= 0\r\nLocal nValIpiBene\t:= 0\r\nLocal nValtrib\t\t:= 0\r\nLocal nCountIT\t\t:= 0\r\nLocal nDesVrIcms\t:= 0\r\nLocal nValDifer\t\t:= 0\r\n//Declaração de Lógicos\r\nLocal lQuery    \t:= .F.\r\nLocal lCalSol\t\t:= .F.\r\nLocal lOk\t\t\t:= .T.\r\nLocal lBrinde\t\t:= .F.\t\t\t\t\t\t\t// Flag que define se é uma operação de Brinde\r\nLocal lContinua\t\t:= .T.\r\nLocal lCabAnf\t\t:= .T.\r\nLocal lConsig   \t:= .F.\t\t\t\t\t\t\t\t// Flag que diz se a operação é de consignação mercantil\r\nLocal lNfCup\t\t:= .F.\t\t\t\t\t\t\t\t// Define se eh Nf sobre cupom\r\nLocal lNFPTER\t\t:= GetNewPar(\"MV_NFPTER\",.T.)\t\t\t\t\t\r\nLocal lComplDev\t\t:= .F.\t\t   \t  \t\t\t\t\t         //Utilizado para identificar quando for uma nota de complemento de IPI de uma devulução.\r\n\r\nLocal lIpiOutr      := .F.\r\n\r\nLocal lIpiDev   \t:= GetNewPar(\"MV_IPIDEV\",.F.)   \t        //Apenas para devolução de compra de IPI (nota de saída). T-Séra gerado na tag vIPI e destacado no campo//VALOR IPI do cabeçalho do danfe. F-Será gerado na tag vIPIDevol e destacado nas informações complementares do danfe.\r\nLocal lIPIOutro \t:= GetNewPar(\"MV_IPIOUT\",.F.) .And. lIpiDev //Quando habilitado juntamente com o MV_IPIDEV, o valor do IPI será gerado na tag vOutro, destacado nas informações complementares e no campo OUTRAS DESPESAS ACESSORIAS.\r\n\r\nLocal lEipiDev   \t:= GetNewPar(\"MV_EIPIDEV\",.F.)\r\nLocal lEIPIOutro \t:= GetNewPar(\"MV_EIPIOUT\",.F.) .And. lEipiDev //Quando habilitado juntamente com o MV_EIPIDEV, o valor do IPI será gerado na tag vOutro, destacado nas informações complementares e no campo OUTRAS DESPESAS ACESSORIAS.\r\n\r\nLocal lIpiBenef\t\t:= GetNewPar(\"MV_IPIBENE\",.F.) \t\t\t\t   //Nota de saída de retorno com tipo = Beneficiamento. .T.- Será gerado na tag vOutro e destacado nas informações//complementares do danfe e no campo OUTRAS DESPESAS ACESSORIAS. .F. - Séra gerado na tag vIPI e destacado no campo//VALOR IPI do cabeçalho do danfe (procedimento padrão)\r\nLocal lIPIOutB \t    := GetNewPar(\"MV_IPIOUTB\",.F.) .And. lIpiBenef //Quando habilitado juntamente com o MV_IPIBENE, o valor do IPI será gerado na tag vOutro, destacado nas informações complementares e no campo OUTRAS DESPESAS ACESSORIAS.\r\n\r\nLocal lIcmSTDev \t:= GetNewPar(\"MV_ICSTDEV\",.T.)  //Indica se sera gravado no XML o valor e base de ICMS ST para nf de devolucao.(Padrao T - leva)\r\nLocal lIcmDevol\t\t:= GetNewPar(\"MV_ICMDEVO\",.T.)\t//Define se sera gravado no XML o valor e base de ICMS para nf de devolucao. (Padrao T - leva)\r\nLocal lIcmsPR\t\t:= .F.\t\t\t\t\t\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017)\r\nlocal lIcmSTDevOri\t:= lIcmSTDev\t\t\t\t\t// Arnazena o valor original pois é alterado para legislação ICMS/PR 2017\r\nlocal lIcmDevolOri\t:= lIcmDevol\t  \t\t\t\t// Arnazena o valor original pois é alterado para legislação ICMS/PR 2017\r\nLocal lNatOper   \t:= GetNewPar(\"MV_SPEDNAT\",.F.)\r\nLocal lInfAdZF   \t:= GetNewPar(\"MV_INFADZF\",.F.)\r\nLocal lEndFis \t\t:= GetNewPar(\"MV_SPEDEND\",.F.)\r\nLocal lEECFAT\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lMVCOMPET\t\t:= SuperGetMV(\"MV_COMBPET\", ,.F.)\r\nLocal lEasy\t\t\t:= SuperGetMV(\"MV_EASY\") == \"S\"\r\nLocal lSimpNac   \t:= SuperGetMV(\"MV_CODREG\")== \"1\" .or. SuperGetMV(\"MV_CODREG\")== \"2\"\r\nLocal lCD2PARTIC\t:= CD2->(FieldPos(\"CD2_PARTIC\")) > 0\r\nLocal lC6_CODINF\t:= SC6->(FieldPos(\"C6_CODINF\")) > 0 \r\nLocal lCpoAlqSB1 \t:= SB1->(FieldPos(\"B1_IMPNCM\")) > 0        \t// Verifica a existencia do campo de Aliq. de Imposto NCM/NBS\r\nLocal lCpoAlqSBZ\t:= SBZ->(FieldPos(\"BZ_IMPNCM\")) > 0     \t   \t// Verifica a existencia do campo de Aliq. de Imposto NCM/NBS na tabela SBZ\r\nLocal lCpoMsgLT\t\t:= SF4->(FieldPos(\"F4_MSGLT\")) > 0 \r\nLocal lCpoCusEnt\t:= SF4->(FieldPos(\"F4_CUSENTR\")) > 0 \t\t\t//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças\r\nLocal lCpoLoteFor\t:= SB8->(FieldPos(\"B8_LOTEFOR\")) > 0  \r\nLocal lValFecp\t\t:= SF3->(FieldPos(\"F3_VALFECP\")) >0 \r\nLocal lVfecpst\t\t:= SF3->(FieldPos(\"F3_VFECPST\")) >0 \r\nLocal lSb1CT\t\t:= SB1->(FieldPos(\"B1_X_CT\")) >0 \r\nLocal lHistTab\t    := existFunc(\"NotaVinc\") .And. SuperGetMv(\"MV_HISTTAB\",.F.,.F.) .And. AliasIndic('AIF') \r\n\r\n\r\nLocal lMvImpFecp\t:= GetNewPar(\"MV_IMPFECP\",.F.)\t                // Imprime FECP\r\nLocal lOrgaoPub\t\t:= GetNewPar(\"MV_NFORGPU\",.F.)\t\t\t\t//NF-e de remessa nas operações de aquisição de órgão público, com entrega em outro órgão público (RICMS SP)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//AJUSTE SINIEF 13, DE 26 DE JULHO DE 2013 \r\n\r\nLocal lUsaCliEnt\t:= GetNewPar(\"MV_NFEDEST\",.F.) \t\t\t\t//Quando habilitado considera o Cliente, Cli. Entrega e Cli. Retirada utilizados, para compor\r\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//respectivamente as tags \"dest\", \"entrega\" e \"retirada\" no XML\r\nLocal lVinc \t\t:= .F.\t// Se existe nota vinculada\r\nlocal lGrupCob\t\t:= SuperGetMV(\"MV_GRUPCOB\",.F.,.T.) \r\nLocal LRespTec  \t:= iif(findFunction(\"getRespTec\"),getRespTec(\"1\"),.T.) //0-Todos, 1-NFe, 2-MDFe\r\nLocal lNfCupZero\t:= .F.\r\nLocal lRural\t\t:= .F.\r\nLocal lSeekOk   \t:= .F.\r\nLocal lDifParc\t\t:= .F.\r\nLocal lNfCompl\t\t:= .F.\r\nLocal lFCI\t\t\t:= GetNewPar(\"MV_FCIDANF\",.F.) // Imprime ou não os dados da FCI no Xml/Danfe (De acordo com as configurações necessárias)\r\nLocal lGE\t\t\t:= FindFunction(\"LjUP104OK\") .AND. LjUP104OK() .AND. SuperGetMV(\"MV_LJIMPGF\",,.F.)\t// Indica se usa garantia\r\nLocal lLjDescIt\t\t:= .F.\t// Inicializa as variaveis que serao utilizadas para desconto \r\nLocal lFirstItem \t:= .T.\r\nLocal lF1Motivo\t\t:= SF1->(FieldPos(\"F1_MOTIVO\")) > 0\r\nLocal lNfCupNFCE\t:= .F.\r\nLocal lNfCupSAT\t\t:= .F.\r\nLocal lChave     \t:= .F.\r\nLocal lCNPJIgual\t:= .F.\r\nLocal lEIC0064\t\t:= GetNewPar(\"MV_EIC0064\",.F.)\r\nLocal lVeicNovo     := .F.\r\nLocal cD2TesNF\t\t:= \"\" // TES da NF Sobre Cupom (SD2)\r\nLocal cForma\t\t:= \"\"\r\nlocal cChvPag\t\t:= \"\"      \r\nLocal aSX560      \t:= {}\r\nLocal aSX513      \t:= {}\r\nLocal cFiltro\t\t:= \"\"\r\n//Parametro Logico - Define se sera impresso a 2a. Unidade de Medida para operacoes dentro do País - Opcoes: [.T.]-Não Imprime ou [.F.]-Imprime (Default)\r\nLocal lNoImp2UM\t\t:= GetNewPar(\"MV_NIMP2UM\",.F.)\r\n\r\n//Relacao de CFOP's vinculadas a exportacao - NT 2016.001\r\nLocal cCFOPExp \t\t:= \"1501-2501-5501-5502-5504-5505-6501-6502-6504-6505\"\r\n\r\nLocal lPe01Nfe\t\t:= ExistBlock(\"PE01NFESEFAZ\")\r\nLocal lIntegHtl \t:= SuperGetMv(\"MV_INTHTL\",, .F.) //Integracao via Mensagem Unica - Hotelaria\r\n//Alimentação da tag retTransp\r\nLocal nBCTot \t\t:= 0\r\nLocal nALIQTot\t\t:= 0\r\nLocal nVLTRIBTot\t:= 0\r\nLocal aObsCont\t\t:= {}\r\n\r\n//Alimentação do Grupo de Repasse\r\nLocal nBRICMSO \t\t:= 0\r\nLocal nICMRETO\t\t:= 0\r\nLocal nBRICMSD \t\t:= 0\r\nLocal nICMRETD\t\t:= 0\r\nLocal nAliqST\t\t:= 0\r\nLocal nCrdPres\t\t:= 0\r\nLocal nTotCrdP      := 0\r\n\r\nLocal aRetPgLoj \t:= {}\r\nLocal aProcRef\t\t:= {}\r\nLocal lVLojaDir \t:= .F. //Venda Direta ou Loja ou Nota Sobre Cupom\r\nLocal cIndPag\t\t:= \"\"\r\nLocal nValOutr\t\t:= 0\r\nLocal cTpOrig \t\t:= \"\"\r\nLocal lDescIss\t\t:= SuperGetMV(\"MV_DESCISS\",,.F.) //Informa ao sistema se o ISS devera ser descontado do valor do titulo financeiro caso o cliente for responsável pelo recolhimento.\r\nLocal lTpabiss\t\t:= SuperGetMV(\"MV_TPABISS\",,\"2\") == \"1\"//Se parâmetro igual a 1 indica se será efetuado um desconto na duplicata quando o cliente recolhe ISS se igual a 2 será gerado um titulo de abatimento.\r\nLocal lRuleDescISS  := lDescIss .And. lTpabiss\r\nLocal cSeekCDA\t\t:= \"\"\r\nlocal lCodLan\t\t:= .F.\r\nLocal nDescFis\t\t:= 0\r\nLocal cTpEspcBen\t:= \"\"\r\nlocal cStringUTF\t:= \"\"\r\nLocal lNCMOk\t\t:= .F.\r\n\r\nLocal aTotICMSST\t:= {}\r\n\r\nLocal aOrdSED\t\t:= {}\r\nLocal cNatFin\t\t:= \"\"\r\nLocal cED_DEDINSS\t:= \"\"\r\nLocal cED_RECFUN\t:= \"\"\r\nLocal cFilTit \t\t:= \"\"\r\nLocal cPrfTit \t\t:= \"\"\r\nLocal cNumTit \t\t:= \"\"\r\nLocal cNumDupl\t\t:= \"\"\r\nLocal cChaveSE1 \t:= \"\"\r\n\r\nlocal cRetForm\t\t:= \"\"\r\n\r\nlocal nPosCpoEsp\t:= 0\r\nlocal nPosCpoVol\t:= 0\r\nlocal nVolume\t\t:= 0\r\nlocal cMRCVLMSF1\t:= alltrim(SuperGetMV(\"MV_MRCVLM1\",,\"\"))\r\nlocal cMRCVLMSF2\t:= alltrim(SuperGetMV(\"MV_MRCVLM2\",,\"\"))\r\nlocal aCpoMarVol\t:= {}\r\nlocal cCpoMarca\t\t:= \"\"\r\nlocal cCpoNumer\t\t:= \"\"\r\nlocal nPosCpoMrc\t:= 0\r\nlocal nPosCpoNum\t:= 0\r\nlocal cMarca\t\t:= \"\"\r\nlocal cNumeracao\t:= \"\"\r\n\r\n//Declaração de Arrays\r\nPrivate aUF     \t:= {}\r\nPrivate aCSTIPI \t:= {}\r\n \r\n//Declaração de Strings\r\nPrivate cFntCtrb\t:= \"\"\r\nPrivate cMvMsgTrib\t:= SuperGetMV(\"MV_MSGTRIB\",,\"1\")\r\nPrivate cMvFntCtrb\t:= SuperGetMV(\"MV_FNTCTRB\",,\" \")\r\nPrivate cMvFisCTrb\t:= SuperGetMV(\"MV_FISCTRB\",,\"1\")\r\nPrivate cAutXml\t\t:= SuperGetMV(\"MV_AUTXML\",,\"\")\r\nPrivate cMVEstado\t:= SuperGetMV(\"MV_ESTADO\", ,\" \")\r\nPrivate cTpCliente\t:= \"\"\r\nPrivate cIdRecopi\t:= \"\"\r\nPrivate cNumRecopi\t:= \"\"\r\nPrivate cIdDest\t\t:= \"\"\r\nPrivate cIndFinal\t:= \"\"\r\nPrivate cIndIEDest \t:= \"\"\r\nPrivate cTPNota\t    := \"\"\t\r\n//Declaração de numéricos\r\nPrivate nTotNota\t:= 0\r\nPrivate nTotalCrg\t:= 0\r\nPrivate nTotFedCrg\t:= 0\t// Ente Tributante Federal\r\nPrivate nTotEstCrg\t:= 0\t// Ente Tributante Estadual\r\nPrivate nTotMunCrg\t:= 0\t// Ente Tributante Municipal\r\n\r\n//Declaração de Lógicos\r\nPrivate lMvEnteTrb\t:= SuperGetMV(\"MV_ENTETRB\",,.F.)\t// Valor dos tributos por Ente Tributante: Federal, Estadual e Municipal\r\nPrivate lMvNFLeiZF\t:= SuperGetMV(\"MV_NFLEIZF\",,.F.)\t// Tratamento para a lei da Portaria Suframa nº 275/2009 para Pis e Cofins do chamado TPIPVV\r\nPrivate lAnfavea\t:= If(AliasIndic(\"CDR\") .And. AliasIndic(\"CDS\"),.T.,.F.)\r\nPrivate lCustoEntr\t:= .F.\t//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças\r\nPrivate lDifal\t\t:= .F.\r\nPrivate lDifer\t\t:= .F.\r\nPrivate lTagProduc\t:= .F.\r\n\r\nIf FunName() == \"SPEDNFSE\"\r\n\tDEFAULT cTipo   := PARAMIXB[1]\r\n\tDEFAULT cSerie  := PARAMIXB[3]\r\n\tDEFAULT cNota   := PARAMIXB[4]\r\n\tDEFAULT cClieFor:= PARAMIXB[5]\r\n\tDEFAULT cLoja   := PARAMIXB[6]     \r\n\t\r\n\t\r\nElse\r\n\tDefault cTipo     := PARAMIXB[1,1] // PARAMIXB[1]\r\n\tDefault cSerie    := PARAMIXB[1,3] // PARAMIXB[3]\r\n\tDefault cNota     := PARAMIXB[1,4] // PARAMIXB[4]\r\n\tDefault cClieFor  := PARAMIXB[1,5] // PARAMIXB[5]\r\n\tDefault cLoja     := PARAMIXB[1,6] // PARAMIXB[6]    \r\n\taMotivoCont \t  := PARAMIXB[1,7]\r\n\tcVerAmb     \t  := PARAMIXB[2]\r\n\tcAmbiente\t\t  := PARAMIXB[3]                  \r\n\tDEFAULT cNotaOri  := PARAMIXB[4,1]                  \r\n\tDEFAULT cSerieOri := PARAMIXB[4,2]\r\n\tlTagProduc \t\t  := date() > CTOD(\"06/05/2019\") .or. cAmbiente == \"2\"\r\nEndif\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Preenchimento do Array de UF                                            ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\naadd(aUF,{\"RO\",\"11\"})\r\naadd(aUF,{\"AC\",\"12\"})\r\naadd(aUF,{\"AM\",\"13\"})\r\naadd(aUF,{\"RR\",\"14\"})\r\naadd(aUF,{\"PA\",\"15\"})\r\naadd(aUF,{\"AP\",\"16\"})\r\naadd(aUF,{\"TO\",\"17\"})\r\naadd(aUF,{\"MA\",\"21\"})\r\naadd(aUF,{\"PI\",\"22\"})\r\naadd(aUF,{\"CE\",\"23\"})\r\naadd(aUF,{\"RN\",\"24\"})\r\naadd(aUF,{\"PB\",\"25\"})\r\naadd(aUF,{\"PE\",\"26\"})\r\naadd(aUF,{\"AL\",\"27\"})\r\naadd(aUF,{\"MG\",\"31\"})\r\naadd(aUF,{\"ES\",\"32\"})\r\naadd(aUF,{\"RJ\",\"33\"})\r\naadd(aUF,{\"SP\",\"35\"})\r\naadd(aUF,{\"PR\",\"41\"})\r\naadd(aUF,{\"SC\",\"42\"})\r\naadd(aUF,{\"RS\",\"43\"})\r\naadd(aUF,{\"MS\",\"50\"})\r\naadd(aUF,{\"MT\",\"51\"})\r\naadd(aUF,{\"GO\",\"52\"})\r\naadd(aUF,{\"DF\",\"53\"})\r\naadd(aUF,{\"SE\",\"28\"})\r\naadd(aUF,{\"BA\",\"29\"})\r\naadd(aUF,{\"EX\",\"99\"})\r\n\r\nIf FindFunction(\"GETSUBTRIB\")\r\n\tcMVSUBTRIB := GetSubTrib()\r\nEndif\r\n\r\nIF GetNewPar(\"MV_CMPUSR\",\"\")  <>  \"\"\r\n\taCMPUSR\t:= StrTokArr( GetNewPar(\"MV_CMPUSR\",\"\"), \"|\" )\t\r\nEndif \r\n\r\nIf cTipo == \"1\"\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Verifica se existem mais de um cupom relacionado na nota sobre cupom    ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\r\n\t//Para usar a função do loja LjR30Sped ja tem que estar posicionado na SF2 \r\n\tIf FindFunction(\"LjR30Sped\")\r\n\t\tcNFeArea := SF2->(GetArea()) \r\n\t\tdbSelectArea(\"SF2\") \r\n\t\tdbSetOrder(1)\r\n\t\tIf MsSeek(xFilial(\"SF2\")+cNota+cSerie+cClieFor+cLoja)\r\n\t\t\taItemCupRef := LjR30Sped()\r\n\t\tEndif\r\n\t\tRestArea(cNfeArea)\r\n\tEndIf\r\n\r\n\taCupRefLoj := NfMultCup(aItemCupRef, cSerie, cNota, cClieFor, cLoja)\r\n\r\n\tFor nCountNF := 1 To Len(aCupRefLoj)\r\n\t\taNota\t\t:= {}\r\n\t\taEntrega\t:= {}\r\n\t\taDest\t\t:= {}\r\n\t\taTransp\t\t:= {}\r\n\t\taVeiculo\t:= {}\r\n\t\taReboque\t:= {}\r\n\t\taReboqu2\t:= {}\r\n\t\tlVLojaDir \t:= .F.\r\n\r\n\t\tcSerie\t\t:= aCupRefLoj[nCountNF][1]\r\n\t\tcNota\t\t:= aCupRefLoj[nCountNF][2]\r\n\t\tcClieFor\t:= aCupRefLoj[nCountNF][3]\r\n\t\tcLoja\t\t:= aCupRefLoj[nCountNF][4]\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Posiciona NF                                                            ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tdbSelectArea(\"SF2\")\r\n\t\tdbSetOrder(1)\r\n\t\tIf MsSeek(xFilial(\"SF2\")+cNota+cSerie+cClieFor+cLoja)\r\n\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Busca dados do ISS                                                      ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\tdbSetOrder(4)\r\n\t\t\tIf MsSeek(xFilial(\"SF3\")+cClieFor+cLoja+cNota+cSerie)\r\n\t\t\t\tWhile !SF3->(Eof()) .And. cClieFor+cLoja+cNota+cSerie == SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE\r\n\t\t\t\t\t\r\n\t\t\t\t\tnCont++\r\n\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t//FT_FILIAL+FT_TIPOMOV+FT_CLIEFOR+FT_LOJA+FT_SERIE+FT_NFISCAL+FT_IDENTF3\r\n\t\t\t\t\tMsSeek(xFilial(\"SFT\")+\"S\"+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_SERIE+SF3->F3_NFISCAL+SF3->F3_IDENTFT)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SFT->FT_NFISCAL+SFT->FT_SERIE+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_PRODUTO)\r\n\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SF4\")+SD2->D2_TES)\r\n\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\r\n\t\t\t\t\t\tIf SF3->F3_RECISS ==\"1\"\r\n\t\t\t\t\t\t\tcSitTrib := \"R\"\r\n\t\t\t\t\t\tElseif SF3->F3_RECISS ==\"2\" \r\n\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\tElseif SF4->F4_LFISS ==\"I\"\r\n\t\t\t\t\t\t\tcSitTrib:= \"I\"\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndif\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SB1\")+SD2->D2_COD)\r\n\t\t\t\t\tIf SB1->(FieldPos(\"B1_TRIBMUN\"))>0\r\n\t\t\t\t\t\tcTribMun:= SB1->B1_TRIBMUN\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\r\n\t\t\t\t\tcTpPessoa\t:= SA1->A1_TPESSOA\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tIf nCont == 1\r\n\t\t\t\t\t\tDo While !SD2->(Eof ()) .And. xFilial(\"SD2\") == (cAliasSD2)->D2_FILIAL .And.;\r\n\t\t\t\t\t\t\t\tSF2->F2_DOC == (cAliasSD2)->D2_DOC . And. SF2->F2_SERIE == (cAliasSD2)->D2_SERIE .And.;\r\n\t\t\t\t\t\t\t\tSF2->F2_CLIENTE == (cAliasSD2)->D2_CLIENTE .And. SF2->F2_LOJA == (cAliasSD2)->D2_LOJA .And.;\r\n\t\t\t\t\t\t\t\t( SF3->F3_TIPO == \"S\" .Or. lSimpNac )\r\n\t\t\t\t\t\t\t\tIf SF3->F3_TIPO == \"S\"\r\n\t\t\t\t\t\t\t\t\tnPrTotal += (cAliasSD2)->D2_PRCVEN\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t//------------------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\t// Retirado o uso do parametro MV_SIMPREM para que a mensagem sejá gerado de acordo com o CSOSN\r\n\t\t\t\t\t\t\t\t//------------------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+SD2->D2_TES)\r\n\t\t\t\t\t\t\t\tIf lSimpNac .And. (SF4->F4_CSOSN $ '101-201-900')\r\n\t\t\t\t\t\t\t\t\tnValSimprem += (cAliasSD2)->D2_VALICM\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tSD2->(DbSkip ())\r\n\t\t   \t\t\t\tEndDo\r\n\t\t   \t\t\t\t\r\n\t\t   \t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t   \t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t   \t\t\r\n\t\t   \t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf DbSeek(xFilial(\"CD2\")+\"S\"+SF2->F2_SERIE+SF2->F2_DOC+cClieFor+cLoja+PadR(SD2->D2_ITEM,4)+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\tDo While !CD2->(Eof ()) .And. CD2->CD2_DOC == (cAliasSD2)->D2_DOC  \r\n\t\t\t                    If Alltrim(CD2->CD2_IMP) == \"ISS\" \r\n\t\t\t                    \tnValIss\t+= CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCD2->(DbSkip ())\r\n\t\t\t\t\t\t\tEndDo \r\n\t\t\t\t\t\tEndIf \r\n\t\t   \t\t\tEndIf\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf FunName() == \"SPEDNFSE\" //.Or. FunName() == \"SPEDCTE\"\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\r\n\t\t\t\t\t\t\taadd(aISSQN,;\r\n\t\t\t\t\t\t\t\t\t\t{AllTrim(SF3->F3_CODISS),;\r\n\t\t\t\t\t\t\t\t\t\tnPrTotal+SF3->F3_VALOBSE,;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_CNAE,;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_ALIQICM,;\r\n\t\t\t\t\t\t\t\t\t\tIIf((SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\"),nValIss,SF3->F3_VALICM),;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_VALOBSE,;\r\n\t\t\t\t\t\t\t\t\t\tcTribMun,;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_BASEICM,;\r\n\t\t\t\t\t\t\t\t\t\tcSitTrib})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aISSQN,;\r\n\t\t\t\t\t\t\t\t\t\t{\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\"})\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tSF3->(dbSkip())\r\n\t\t\t\tEnd\r\n\t\t\t\t\r\n\t\t\tEndif\r\n\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Tratamento temporario do CTe                                            ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf FunName() == \"SPEDCTE\" .Or. AModNot(SF2->F2_ESPECIE)==\"57\"\r\n\t\t\t\tcNFe := \"CTe35080944990901000143570000000000200000168648\"\r\n\t\t\t\tcString := '<infNFe versao=\"T02.00\" modelo=\"57\" >'\r\n\t\t\t\tcString += '<CTe xmlns=\"http://www.portalfiscal.inf.br/cte\">'\r\n\t\t\t\tcString += '<infCte Id=\"CTe35080944990901000143570000000000200000168648\" versao=\"1.02\"><ide><cUF>35</cUF><cCT>000016864</cCT><CFOP>6353</CFOP>'\r\n\t\t\t\tcString += '<natOp>ENTREGA NORMAL</natOp><forPag>1</forPag><mod>57</mod><serie>0</serie><nCT>20</nCT><dhEmi>2008-09-12T10:49:00</dhEmi>'\r\n\t\t\t\tcString += '<tpImp>2</tpImp><tpEmis>2</tpEmis><cDV>8</cDV><tpAmb>2</tpAmb><tpCTe>0</tpCTe><procEmi>0</procEmi><verProc>1.12a</verProc>'\r\n\t\t\t\tcString += '<cMunEmi>3550308</cMunEmi><xMunEmi>Sao Paulo</xMunEmi><UFEmi>SP</UFEmi><modal>01</modal><tpServ>0</tpServ><cMunIni>3550308</cMunIni>'\r\n\t\t\t\tcString += '<xMunIni>Sao Paulo</xMunIni><UFIni>SP</UFIni><cMunFim>3550308</cMunFim><xMunFim>Sao Paulo</xMunFim><UFFim>SP</UFFim><retira>1</retira>'\r\n\t\t\t\tcString += '<xDetRetira>TESTE</xDetRetira><toma03><toma>0</toma></toma03></ide><emit><CNPJ>44990901000143</CNPJ><IE>00000000000</IE>'\r\n\t\t\t\tcString += '<xNome>FILIAL SAO PAULO</xNome><xFant>Teste</xFant><enderEmit><xLgr>Av. Teste, S/N</xLgr><nro>0</nro><xBairro>Teste</xBairro><cMun>3550308</cMun>'\r\n\t\t\t\tcString += '<xMun>Sao Paulo</xMun><CEP>00000000</CEP><UF>SP</UF></enderEmit></emit><rem><CNPJ>58506155000184</CNPJ><IE>115237740114</IE><xNome>CLIENTE SP</xNome>'\r\n\t\t\t\tcString += '<xFant>CLIENTE SP</xFant><enderReme><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun><xMun>SAO PAULO</xMun>'\r\n\t\t\t\tcString += '<CEP>77777777</CEP><UF>SP</UF></enderReme><infOutros><tpDoc>00</tpDoc><dEmi>2008-09-17</dEmi></infOutros></rem><dest><CNPJ></CNPJ><IE></IE>'\r\n\t\t\t\tcString += '<xNome>CLIENTE RJ</xNome><enderDest><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun><xMun>RIO DE JANEIRO</xMun>'\r\n\t\t\t\tcString += '<CEP>44444444</CEP><UF>RJ</UF></enderDest></dest><vPrest><vTPrest>1.93</vTPrest><vRec>1.93</vRec></vPrest><imp><ICMS><CST00><CST>00</CST><vBC>250.00</vBC>'\r\n\t\t\t\tcString += '<pICMS>18.00</pICMS><vICMS>450.00</vICMS></CST00></ICMS></imp><infCteComp><chave>35080944990901000143570000000000200000168648</chave><vPresComp>'\r\n\t\t\t\tcString += '<vTPrest>10.00</vTPrest></vPresComp><impComp><ICMSComp><CST00Comp><CST>00</CST><vBC>10.00</vBC><pICMS>10.00</pICMS><vICMS>10.00</vICMS></CST00Comp>'\r\n\t\t\t\tcString += '</ICMSComp></impComp></infCteComp></infCte></CTe>'\r\n\t\t\t\tcString += '</infNFe>'\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento Nota de Servico  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tElseIf FunName() == \"SPEDNFSE\"\r\n\t\t\t\t\r\n\t\t\t\t//Modelo do XML ISSNET ou BH\r\n\t\t\t\tcModXML:= mv_par04\r\n\t\t\t\t\r\n\t\t\t\taadd(aNotaServ,SF2->F2_SERIE)\r\n\t\t\t\taadd(aNotaServ,SF2->F2_DOC)\r\n\t\t\t\taadd(aNotaServ,SF2->F2_EMISSAO)\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Posiciona cliente  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\taadd(aDest,AllTrim(SA1->A1_CGC))\r\n\t\t\t\taadd(aDest,SA1->A1_NOME)\r\n\t\t\t\taadd(aDest,FisGetEnd(SA1->A1_END,SA1->A1_EST)[1])\r\n\t\t\t\tIf \"/\" $ FisGetEnd(SA1->A1_END,SA1->A1_EST)[3]\r\n\t\t\t\t\taadd(aDest,IIF(FisGetEnd(SA1->A1_END,SA1->A1_EST)[3]<>\"\",FisGetEnd(SA1->A1_END,SA1->A1_EST)[3],\"SN\"))\r\n\t\t\t\tElse\r\n\t \t\t\t\taadd(aDest,IIF(FisGetEnd(SA1->A1_END,SA1->A1_EST)[2]<>0,FisGetEnd(SA1->A1_END,SA1->A1_EST)[2],\"SN\"))\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\taadd(aDest,FisGetEnd(SA1->A1_END,SA1->A1_EST)[4])\r\n\t\t\t\taadd(aDest,SA1->A1_BAIRRO)\r\n\t\t\t\t\r\n\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aDest,\"99999\")\r\n\t\t\t\tEndIf\r\n\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\taadd(aDest,SA1->A1_CEP)\r\n\t\t\t\taadd(aDest,Alltrim(SA1->A1_DDD)+SA1->A1_TEL)\r\n\t\t\t\taadd(aDest,SA1->A1_INSCRM)\r\n\t\t\t\taadd(aDest,SA1->A1_EMAIL)\r\n\t\t\t\t\r\n\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\tSC6->(dbSetOrder(4))\r\n\t\t\t\t\tSC5->(dbSetOrder(1))\r\n\t\t\t\t\tIf (SC6->(MsSeek(xFilial(\"SC6\")+SF2->F2_DOC+SF2->F2_SERIE)))\r\n\t\t\t\t\t\tSC5->(MsSeek(xFilial(\"SC5\")+SC6->C6_NUM))\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf Empty (SC5->C5_FORNISS)\r\n\t\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tSA2->(dbSetOrder(1))\r\n\t\t\t\t\t\t\tSA2->(MsSeek(xFilial(\"SA2\")+SC5->C5_FORNISS+\"00\"))\r\n\t\t\t\t\t\t\taadd(aDest,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aDest,Upper(SA2->A2_EST))\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aDest,\"99999\")\r\n\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\tdbSetOrder(4)\r\n\t\t\t\tMsSeek(xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE)\r\n\t\t\t\t\r\n\t\t\t\tWhile !Eof() .And. xFilial(\"SF3\") == SF3->F3_FILIAL .And.;\r\n\t\t\t\t\tSF2->F2_SERIE == SF3->F3_SERIE .And.;\r\n\t\t\t\t\tSF2->F2_DOC == SF3->F3_NFISCAL .And. !Empty(SF3->F3_CODISS) .And. SF3->F3_TIPO==\"S\"\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Natureza da Operação\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSST\"))>0\r\n\t\t\t\t\t\tcNatOper:= SF3->F3_ISSST\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Tipo de RPS - O sistema de BH ainda não está recebendo Notas Conjugadas\r\n\t\t\t\t\t//If SF2->F2_ESPECIE $ cConjug\r\n\t\t\t\t\t//cTipoRps:=\"2\" //RPS - Conjugada (Mista)\r\n\t\t\t\t\tIf !Empty(SF2->F2_PDV)\r\n\t\t\t\t\t\tcTipoRps:=\"3\" //Cupom\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcTipoRps:=\"1\" //RPS\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Pega os impostos de retencao somente quando houver a retenção, ³\r\n\t\t\t\t\t//³ou seja, os titulos de retenção que existirem                  ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\t\t\tSE1->(dbSetOrder(2))\r\n\t\t\t\t\tIf SE1->(dbSeek(xFilial(\"SE1\")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_SERIE+SF3->F3_NFISCAL))\r\n\t\t\t\t\t\tWhile !SE1->(Eof()) .And. xFilial(\"SE1\") == SE1->E1_FILIAL .And.;\r\n\t\t\t\t\t\t\t\tSF3->F3_CLIEFOR == SE1->E1_CLIENTE .And. SF3->F3_LOJA == SE1->E1_LOJA .And.;\r\n\t\t\t\t\t\t\t\tSF3->F3_SERIE == SE1->E1_PREFIXO .And. SF3->F3_NFISCAL == SE1->E1_NUM\r\n\t\t\t\t\t\t\tIf 'NF' $ SE1->E1_TIPO\r\n\t\t\t\t\t\t\t\tnTotRet+=SumAbatRec(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,SE1->E1_MOEDA,\"V\",SE1->E1_BAIXA,,@nIrRet,@nCsllRet,@nPisRet,@nCofRet,@nInssRet)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tSE1->(DbSkip ())\r\n\t\t\t\t\t\tEndDo\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aRetServ,{nIrRet,nCsllRet,nPisRet,nCofRet,nInssRet,nTotRet})\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Pega as deduções ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSSUB\"))>0\r\n\t\t\t\t\t\tnDedu+= SF3->F3_ISSSUB\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSMAT\"))>0\r\n\t\t\t\t\t\tnDedu+= SF3->F3_ISSMAT\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Obtem os dados do Serviço ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\taSX560 \t := FwGetSX5(\"60\",SF3->F3_CODISS)\r\n\t\t\t\t\tIf len(aSX560) > 0\r\n\t\t\t\t\t\t//Verifico se a Descrição é composta do pedido de Venda ou SX5\r\n\t\t\t\t\t\tIf cDescServ$\"1\"\r\n\t\t\t\t\t\t\tSC6->(dbSetOrder(4))\r\n\t\t\t\t\t\t\tSC5->(dbSetOrder(1))\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SC6\")+SF3->F3_NFISCAL+SF3->F3_SERIE)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SC5\")+SC6->C6_NUM)\r\n\t\t\t\t\t\t\t\r\n\t\t\t           \tIF len(aCMPUSR) > 0  \r\n\t\t\t\t\t\t\t\t\tcFieldMsg := aCMPUSR[1]  \r\n\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf !Empty(cFieldMsg) .and. SC5->(FieldPos(cFieldMsg)) > 0 .and. !Empty(&(\"SC5->\"+cFieldMsg))\r\n\t\t\t\t\t\t\t\tcServ := &(\"SC5->\"+cFieldMsg) \r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcServ := SC5->C5_MENNOTA\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf Empty(cServ)\r\n\t\t\t\t\t\t\t\tcServ := aSX560[1][4]\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcServ := aSX560[1][4]\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Verifica se recolhe ISS Retido ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\tIf SF3->F3_RECISS $\"1|S\"\r\n\t\t\t\t\t\t\tcRetIss :=\"1\"\r\n\t\t\t\t\t\t\tnIssRet := SF3->F3_VALICM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcRetIss :=\"2\"\r\n\t\t\t\t\t\t\tnIssRet := 0\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tElseIf SA1->A1_RECISS $\"1|S\"\r\n\t\t\t\t\t\tcRetIss :=\"1\"\r\n\t\t\t\t\t\tnIssRet := SF3->F3_VALICM\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcRetIss :=\"2\"\r\n\t\t\t\t\t\tnIssRet := 0\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Verifica se municipio de prestação foi informado no pedido ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf SC5->(FieldPos(\"C5_MUNPRES\")) > 0 .And. !Empty(SC5->C5_MUNPRES)\r\n\t\t\t\t\t\tcMunPres  := SC5->C5_MUNPRES\r\n\t\t\t\t\t\tcMunPres:= ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[14]})][02]+cMunPres)\r\n\t\t\t\t\t\tcDescMunP := SC5->C5_DESCMUN\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMunPres:= aDest[13]\r\n\t\t\t\t\t\tcMunPres:= ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[14]})][02]+cMunPres)\r\n\t\t\t\t\t\tcDescMunP := aDest[08]\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SB1\")+SD2->D2_COD)\r\n\t\t\t\t\tIf SB1->(FieldPos(\"B1_TRIBMUN\"))>0\r\n\t\t\t\t\t\tcTribMun:= SB1->B1_TRIBMUN\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tcString := \"\"\r\n\t\t\t\t\tcString += NFSeIde(aNotaServ,cNatOper,cTipoRPS,cModXML)\r\n\t\t\t\t\tcString += NFSeServ(aISSQN[1],aRetServ[1],nDedu,nIssRet,cRetIss,cServ,cMunPres,cModXML,cTpPessoa)\r\n\t\t\t\t\tcString += NFSePrest(cModXML)\r\n\t\t\t\t\tcString += NFSeTom(aDest,cModXML,cMunPres)\r\n\t\t\t\t\t\r\n\t\t\t\t\tExit\r\n\t\t\t\tEndDo\r\n\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Para o caso de Nota sobre Cupom Fiscal, busca os dados da Nota  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t  \t\r\n\t\t\t  \tIf (\"CF\" $ SF2->F2_ESPECIE .OR. \"NFCE\" $ SF2->F2_ESPECIE .OR. \"SATCE\" $ SF2->F2_ESPECIE .OR. (LjAnalisaLeg(18)[1] .AND. \"ECF\" $ SF2->F2_ESPECIE .AND. (\"S\" $ SF2->F2_ECF) )) .AND. !Empty(SF2->F2_NFCUPOM) \r\n\t\t\t\t\tcSerNfCup \t:= SubStr(SF2->F2_NFCUPOM,1,TamSx3(\"F2_SERIE\")[1])\r\n\t\t\t\t\tcNumNfCup \t:= SubStr(SF2->F2_NFCUPOM,4,TamSx3(\"F2_DOC\")[1]) \r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(cNotaOri) .And. cNotaOri <> cNumNfCup\t\t\t\t                                                            \r\n\t\t\t\t\t\tcSerNfCup \t:= cSerieOri\r\n\t\t\t\t\t\tcNumNfCup \t:= cNotaOri\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Alltrim(SF2->F2_ESPECIE) == \"NFCE\"\r\n\t\t\t\t\t\tlNfCupNFCE := .T.\r\n\t\t\t\t\tElseIf Alltrim(SF2->F2_ESPECIE) == \"SATCE\"\r\n\t\t\t\t\t\tlNfCupSAT := .T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tDbSelectArea( \"SF2\" )\r\n\t\t\t\t\tDbSetOrder(1)  // F2_DOC + F2_SERIE + F2_CLIENTE + F2_LOJA\r\n\t\t\t\t\tIf DbSeek( xFilial(\"SF2\") + cNumNfCup + cSerNfCup)\r\n\t\t\t\t\t\taadd(aNota,SF2->F2_SERIE)\r\n\t\t\t\t\t\taadd(aNota,IIf(Len(SF2->F2_DOC)==6,\"000\",\"\")+SF2->F2_DOC)\r\n\t\t\t\t\t\taadd(aNota,SF2->F2_EMISSAO)\r\n\t\t\t\t\t\tlNfCup\t:= .T.\r\n\t\t\t\t\t\tcCliNota\t:= SF2->F2_CLIENTE\r\n\t\t\t\t\t\tcCliLoja\t:= SF2->F2_LOJA\r\n\t\t\t\t\t\tcHoraNota\t:= SF2->F2_HORA\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tRestArea(aAreaSF2)\r\n\t \t\t\tEndIf       \r\n\t            \r\n\t\t\t\tIf !lNfCup .OR. Len(aNota) == 0\r\n\t\t\t\t\taadd(aNota,SF2->F2_SERIE)\r\n\t\t\t\t\taadd(aNota,IIF(Len(SF2->F2_DOC)==6,\"000\",\"\")+SF2->F2_DOC)\r\n\t\t\t\t\taadd(aNota,SF2->F2_EMISSAO)\r\n\t\t\t\tEndIf    \r\n\t\t\t\t\r\n\t\t\t\taadd(aNota,cTipo)\r\n\t\t\t\taadd(aNota,SF2->F2_TIPO)\r\n\t\t\t\taadd(aNota,Iif(lNfCup,cHoraNota,SF2->F2_HORA))\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Posiciona cliente ou fornecedor                                         ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\t\t\t\tIf !SF2->F2_TIPO $ \"DB\" \r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tIf (SF2->(ColumnPos(\"F2_CLIRET\")) > 0 .And. SF2->(ColumnPos(\"F2_LOJARET\")) > 0) .And. !Empty(SF2->F2_CLIRET+SF2->F2_LOJARET) .And. SF2->F2_CLIRET+SF2->F2_LOJARET<>SF2->F2_CLIENTE+SF2->F2_LOJA\r\n\t\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf MsSeek(xFilial(\"SA1\")+SF2->F2_CLIRET+SF2->F2_LOJARET)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_CGC)\r\n\t\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,AllTrim(MyGetEnd(SA1->A1_COMPLEM,\"SA1\")[1]))\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_EMAIL))\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcChaveF2 := \"S\" + SF2->( F2_SERIE + F2_DOC + F2_CLIENTE + F2_LOJA )\r\n\r\n\t\t\t\t\tIf AliasIndic(\"CD9\")\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"CD9\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tif MsSeek(xFilial(\"CD9\") + cChaveF2 )\r\n\t\t\t\t\t\t\tcTpOper := CD9->CD9_TPOPER\r\n\t\t\t\t\t\tendif\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf (SF2->(FieldPos(\"F2_CLIENT\"))<>0 .And. !Empty(SF2->F2_CLIENT+SF2->F2_LOJENT) .And. (SF2->F2_CLIENT+SF2->F2_LOJENT<>SF2->F2_CLIENTE+SF2->F2_LOJA .OR. cTpOper == \"1\" )) .OR.;\r\n\t\t\t\t\t(SF2->(ColumnPos(\"F2_CLIREM\"))<>0 .And. SF2->(ColumnPos(\"F2_LOJAREM\"))<>0 .And. !Empty(SF2->F2_CLIREM + SF2->F2_LOJAREM) .And. (SF2->F2_CLIREM+SF2->F2_LOJAREM <> SF2->F2_CLIENT+SF2->F2_LOJENT .OR. cTpOper == \"1\" ))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tIf (SF2->(ColumnPos(\"F2_CLIREM\"))<>0 .AND. !Empty(SF2->F2_CLIREM + SF2->F2_LOJAREM))//verifica se existe cliente remessa preenchido\r\n\t\t\t\t\t\t\tcFiltro := xFilial(\"SA1\") + SF2->F2_CLIREM + SF2->F2_LOJAREM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcFiltro := xFilial(\"SA1\") + SF2->F2_CLIENT + SF2->F2_LOJENT\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t \r\n\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\r\n                        If MsSeek(cFiltro)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_CGC)\r\n\t\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\t\taadd(aEntrega,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\t\taadd(aEntrega,AllTrim(MyGetEnd(SA1->A1_COMPLEM,\"SA1\")[1]))\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_MUN)\r\n\t\t\t\t\t\t\taadd(aEntrega,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\t\taadd(aEntrega,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL)) \r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_EMAIL))\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t/* Se MV_NFEDEST estiver desabilitado (default .F.) permanece o legado:\r\n\t\t\t\t\ta) Para operações interestaduais (UF do emitente diferente da UF do Cliente de Entrega) e o CNPJ do Destinatario(Cliente - F2_CLIENTE)\r\n\t\t\t\t\t\tfor DIFERENTE do emitente, serão considerados os dados do CLIENTE DE ENTREGA.  \r\n\t\t\t\t\t\t- Os dados do Cliente de Entrega serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\tb) Para operações internas (UF do emitente igual a UF do Cliente de Entrega) e se o CNPJ do Destinatário(Cliente - F2_CLIENTE)\r\n\t\t\t\t\t\tfor IGUAL ao do emitente, serão considerado os dados do CLIENTE, mesmo que UFs sejam diferentes.\r\n\t\t\t\t\t\t- Os dados do Cliente serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf !lUsaCliEnt\r\n\t\t\t\t\t\tlCNPJIgual := AllTrim(SA1->A1_CGC) == Alltrim(SM0->M0_CGC)\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(AllTrim(SF2->F2_CLIENT)) .And. !Empty(AllTrim(SF2->F2_LOJENT))\t\t\t\r\n\t\t\t\t\t\t\tIf Len(aEntrega) > 0\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//Se a UF da entrega for diferente da UF do emitente (operação interestadual) e o CNPJ do destinatario for diferente do emitente, \r\n\t\t\t\t\t\t\t\t//tenho que buscar os dados do cliente de entrega para nao ocorrer \r\n\t\t\t\t\t\t\t\t//rejeicao 523 - CFOP não é de Operação Estadual e UF emitente igual à UF destinatário\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] <> IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .And. !lCNPJIgual //aEntrega[08] <> Upper(SA1->A1_EST)\r\n\t\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENT+SF2->F2_LOJENT))\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t//Se a UF de entrega for igual a UF do emitente (Operação interna) - busco os dados do cliente para montar como destinatario.\r\n\t\t\t\t\t\t\t\t//Se o CNPJ do emitente for igual ao do destinatário também levo os dados do cliente, mesmo que UFs forem diferente.\r\n\t\t\t\t\t\t\t\t//Se o cliente não for consumidor final e possuir IE, pode ocorrer a rejeição 773 - Operação Interna e UF de destino difere da UF do emitente\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] == IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .OR. lCNPJIgual\r\n\t\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tIf !Empty(cCliNota+cCliLoja)\r\n\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+cCliNota+cCliLoja))   //Busca os dados do cliente da Nota sobre Cupom para montar os dados do destinatário do XML\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t/* Se MV_NFEDEST estiver habilitado (.T.):\r\n\t\t\t\t\t\t\tA tag de destinatário - 'dest' será gerada com os dados do CLIENTE (F2_CLIENTE)\r\n\t\t\t\t\t\t\tCaso possua Cliente de Entrega (F2_CLIENT) a tag de entrega será gerada exatamente com os dados do Cliente de Entrega \r\n\t\t\t\t\t\t\tCaso possua Cliente de Retirada (F2_CLIRET) a tag de retirada será gerada exatamente com os dados do Cliente de Retirada (***FUTURA IMPLEMENTAÇÃO*** campo F2_CLIRET inexistente)\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tIf !Empty(cCliNota+cCliLoja)\r\n\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+cCliNota+cCliLoja))   //Busca os dados do cliente da Nota sobre Cupom para montar os dados do destinatário do XML\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\r\n\t\t\t\t\tIf !Empty(SA1->A1_MENSAGE)\r\n\t\t\t\t\t\tcRetForm := SA1->(Formula(A1_MENSAGE))\r\n\t\t\t\t\t\tif cRetForm <> Nil .and. !empty(cRetForm)\r\n\t\t\t\t\t\t\tIf cMVNFEMSA1==\"C\"\r\n\t\t\t\t\t\t\t\tcMensCli\t:=\tcRetForm\r\n\t\t\t\t\t\t\tElseIf cMVNFEMSA1==\"F\"\r\n\t\t\t\t\t\t\t\tcMensFis\t:=\tcRetForm\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_CGC))\r\n\t\t\t\t\taadd(aDest,SA1->A1_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t   \r\n\t\t\t\t\tIf MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0\r\n\t\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[3]) \r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(SA1->(FieldPos(\"A1_COMPLEM\")) > 0 .And. !Empty(SA1->A1_COMPLEM),AllTrim(SA1->A1_COMPLEM),MyGetEnd(SA1->A1_END,\"SA1\")[4]))\r\n\t\t\t\t\taadd(aDest,SA1->A1_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\taadd(aDest,SA1->A1_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_DDD)+SA1->A1_TEL)                                                 \t\t\t\t\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"                                                      \t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(SA1->A1_INSCRUR) .And. SA1->A1_PESSOA == \"F\" .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\"  .And. SA1->A1_EST == \"PR\"\r\n\t\t\t\t\t\t\taadd(aDest,SA1->A1_INSCRUR)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,VldIE(SA1->A1_INSCR))\r\n\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,SA1->A1_SUFRAMA)\r\n\t\t\t\t\taadd(aDest,SA1->A1_EMAIL)\r\n\t\t\t\t\taAdd(aDest,SA1->A1_CONTRIB) // Posição 17\r\n\t\t\t\t\taadd(aDest,Iif(SA1->(FieldPos(\"A1_IENCONT\")) > 0 ,SA1->A1_IENCONT,\"\"))\r\n\t\t\t\t\taadd(aDest,SA1->A1_INSCRM)\r\n\t\t\t\t\taadd(aDest,SA1->A1_TIPO)\r\n\t\t\t\t\taadd(aDest,SA1->A1_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\t//Fornecedor\r\n\t\t\t\t\tIf (SF2->(ColumnPos(\"F2_CLIRET\")) > 0 .And. SF2->(ColumnPos(\"F2_LOJARET\")) > 0) .And. !Empty(SF2->F2_CLIRET+SF2->F2_LOJARET) .And. SF2->F2_CLIRET+SF2->F2_LOJARET<>SF2->F2_CLIENTE+SF2->F2_LOJA .and. SF2->F2_TIPO == \"B\"\r\n\t\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf MsSeek(xFilial(\"SA1\")+SF2->F2_CLIRET+SF2->F2_LOJARET)\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_CGC)\r\n\t\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,AllTrim(MyGetEnd(SA1->A1_COMPLEM,\"SA1\")[1]))\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_EMAIL))\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t    dbSelectArea(\"SA2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t// Tratamento para quando existir um cliente de entrega, utilizá-lo ao invés do fornecedor (apenas por garantia)\r\n\t\t\t\t\tIf !Empty(AllTrim(SF2->F2_CLIENT)) .And. !Empty(AllTrim(SF2->F2_LOJENT))\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SF2->F2_CLIENT+SF2->F2_LOJENT)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taDest := {}\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_CGC))\r\n\t\t\t\t\taadd(aDest,SA2->A2_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t                \r\n\t\t\t\t\tIf !Empty(SA2->A2_NR_END) .Or. MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0 \r\n\t\t\t\t\t\taadd(aDest,iif(Empty(SA2->A2_NR_END),MyGetEnd(SA2->A2_END,\"SA2\")[3],SA2->A2_NR_END))\r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(SA2->(FieldPos(\"A2_COMPLEM\")) > 0 .And. !Empty(SA2->A2_COMPLEM),SA2->A2_COMPLEM,MyGetEnd(SA2->A2_END,\"SA2\")[4]))\t\t\t\t\r\n\t\t\t\t\taadd(aDest,SA2->A2_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(SA2->A2_EST))\r\n\t\t\t\t\taadd(aDest,SA2->A2_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\")))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_DDD)+SA2->A2_TEL)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\t\t\t\t\r\n\t\t\t\t\t\taadd(aDest,VldIE(SA2->A2_INSCR))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,\"\")//SA2->A2_SUFRAMA\r\n\t\t\t\t\taadd(aDest,SA2->A2_EMAIL)\t\t\t\t\t\r\n\t\t\t\t\tIf SA2->(FieldPos(\"A2_CONTRIB\"))>0\r\n\t\t\t\t\t\taAdd(aDest,SA2->A2_CONTRIB)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\r\n\t\t\t\t\tEndIf\t \r\n\t\t\t\t\taadd(aDest,\"\")// Posição 18 (referente a A1_IENCONT, sendo passado como vazio já que não existe A2_IENCONT)\r\n\t\t\t\t\taadd(aDest,SA2->A2_INSCRM)\r\n\t\t\t\t\taadd(aDest,\"\")//Posição 20\r\n\t\t\t\t\taadd(aDest,SA2->A2_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Posiciona transportador                                                 ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf !Empty(SF2->F2_TRANSP)\r\n\t\t\t\t\tdbSelectArea(\"SA4\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SA4\")+SF2->F2_TRANSP)\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aTransp,AllTrim(SA4->A4_CGC))\r\n\t\t\t\t\taadd(aTransp,SA4->A4_NOME)\r\n\t\t\t\t\tIf (SA4->A4_TPTRANS <> \"3\")\r\n\t\t\t\t\t//Conforme RICMS/MG, Anexo V Art. 2º, na emissão do documento fiscal em relação ao quadro transportador, \r\n\t\t\t\t\t//se o mesmo for o próprio remetente ou destinatário, deve-se informar a palavra Remetente ou Destinatário, \r\n\t\t\t\t\t//dispensado o preenchimento dos campos: condição de pagamento, CNPJ ou CPF do transportador, endereço, município, \r\n\t\t\t\t\t//unidade da Federação e a inscrição estadual do transportador (CHAMADO-TVMWZL).\r\n\t\t\t\t\t\tif (IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\") .and. Empty(SA4->A4_INSEST) .and. (ALLTRIM(Upper(SA4->A4_NOME)) =='REMETENTE' .OR. ALLTRIM(Upper(SA4->A4_NOME)) =='DESTINATARIO')\r\n\t\t\t\t\t\t\taadd(aTransp,VldIE(SA4->A4_INSEST,.F.))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aTransp,VldIE(SA4->A4_INSEST))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t                    aadd(aTransp,\"\")\t\t\t\t\r\n\t                EndIf    \r\n\t\t\t\t\taadd(aTransp,SA4->A4_END)\r\n\t\t\t\t\taadd(aTransp,SA4->A4_MUN)\r\n\t\t\t\t\taadd(aTransp,Upper(SA4->A4_EST)\t)\r\n\t\t\t\t\taadd(aTransp,SA4->A4_EMAIL\t)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(SF2->F2_VEICUL1)\r\n\t\t\t\t\t\tdbSelectArea(\"DA3\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"DA3\")+SF2->F2_VEICUL1)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\taadd(aVeiculo,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,iif(!Empty(cAnttRntrc),cAnttRntrc,\"\")))//RNTC\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(SF2->F2_VEICUL2)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"DA3\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"DA3\")+SF2->F2_VEICUL2)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aReboque,DA3->DA3_PLACA)\r\n\t\t\t\t\t\t\taadd(aReboque,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\t\taadd(aReboque,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,\"\")) //RNTC\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf !Empty(SF2->F2_VEICUL3)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"DA3\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"DA3\")+SF2->F2_VEICUL3)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taadd(aReboqu2,DA3->DA3_PLACA)\r\n\t\t\t\t\t\t\t\taadd(aReboqu2,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\t\t\taadd(aReboqu2,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,\"\")) //RNTC\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\tElseIf lNfCup   \r\n\t\t\t\t\t\tSL1->(dbSetOrder(2))\r\n\t\t\t\t\t\tSL1->(MsSeek(xFilial(\"SL1\")+SF2->F2_SERIE+SF2->F2_DOC))\r\n\t\t\t\t\r\n\t\t\t\t\t\taadd(aVeiculo,SL1->L1_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,SL1->L1_UFPLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,iif(!Empty(cAnttRntrc),cAnttRntrc,\"\"))  \r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf GetNewPar(\"MV_SUFRAMA\",.F.) .And. !empty(aDest[15])\r\n\t\t\t\t\tcMensFis += \"Código Suframa: \"+alltrim(aDest[15])+\".\" \r\n\t\t\t\tEndif\r\n\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t// Procura registro nos livros fiscais para tratamentos\r\n\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\r\n\t\t\t\tcChave:=\"\"\r\n\t\t\t\tIf !lNfCup\r\n\t\t\t\t\tcChave :=  xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE\r\n\t\t\t\tElse\r\n\t\t\t\t\tcChave :=  xFilial(\"SF3\")+cCliNota+cCliLoja+cNumNfCup+cSerNfCup\r\n\t\t\t\tEndif\r\n\r\n\t\t\t\tIf MsSeek(cChave)\r\n\t\t\t\t\r\n\t\t\t\t\t// Verifica se o CFOP é de venda por consignação mercantil (CFOP 5111 ou 6111)\r\n\t\t\t\t\tIf AllTrim(SF3->F3_CFO) == \"5111\" .Or. AllTrim(SF3->F3_CFO) == \"6111\" .or.  AllTrim(SF3->F3_CFO)  == '5918' .or.  AllTrim(SF3->F3_CFO)  == '6918'\r\n\t\t\t\t\t\tlConsig  := .T.\r\n\t\t\t\t\telseif ( AllTrim(SF3->F3_CFO) == \"5949\" .or. AllTrim(SF3->F3_CFO) == \"5910\" ) .and. SM0->M0_ESTENT == 'SP' /*termos do inciso II do art. 456 do RICMS/ SP  chamado THPXGS*/ \r\n\t\t\t\t\t\t//lBrinde := .T. //Retirado tratamento de brinde pois foi constatado pela consultoria tributária que nao e' possivel amarrar por CFOP.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Msg Simples Nacional\r\n\t\t\t\t\tIf lSimpNac\r\n\r\n\t\t\t\t\t\tcChave := xFilial(\"SD2\") + SFT->FT_NFISCAL + SFT->FT_SERIE + SFT->FT_CLIEFOR + SFT->FT_LOJA\r\n\r\n\t\t\t\t\t \tSD2->(MsSeek(cChave))\r\n\r\n\t\t\t\t\t\tDo While !SD2->(Eof ()) .And. cChave == SD2->(D2_FILIAL + D2_DOC + D2_SERIE + D2_CLIENTE + D2_LOJA)\r\n\t\t\t\t\t\t\tIf Empty(SD2->D2_PICM) .Or. SD2->D2_PICM == 0\r\n\t\t\t\t\t\t\t\tSD2->(DbSkip ())\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tExit\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndDo\r\n\r\n\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf SF2->F2_TIPO == \"D\"\r\n\t\t\t\t\t\t\tcMensFis += \"Documento emitido por ME ou EPP optante pelo Simples Nacional. \"\r\n\t\t\t\t\t\t\tcMensFis += \"Base de cálculo do ICMS: R$ \" + Str(SF2->F2_BASEICM, 14, 2) + \". \"\r\n\t\t\t\t\t\t\tcMensFis += \"Valor do ICMS: R$ \" + Str(SF2->F2_VALICM, 14, 2) + \". \"\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tIf SF2->F2_VALICM > 0 .And. nValSimprem > 0   // Novo Tratamento\r\n\t\t\t\t\t\t\t\tcMensFis += \"Documento emitido por ME ou EPP optante pelo Simples Nacional.\"\r\n\t\t\t\t\t\t\t\tcMensFis += \"Permite o aproveitamento do credito de ICMS no valor de R$ \" + IIf( Empty(nValSimprem),Str(SF2->F2_VALICM, 14, 2), Str(nValSimprem, 14, 2) ) + \" corresponde a aliquota de \"+str(SD2->D2_PICM,5,2)+ \"% , nos termos do art. 23 da LC 123/2006.\"\r\n\t\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\t\tcMensFis += \"Documento emitido por ME ou EPP optante pelo Simples Nacional. Nao gera direito a credito fiscal de IPI.\"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\t\t\r\n\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Volumes / Especie Nota de Saida                                         ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tcScan := \"1\"\r\n\t\t\t\tnPosCpoEsp := SF2->(ColumnPos(\"F2_ESPECI\"+cScan))\r\n\t\t\t\tnPosCpoVol := SF2->(ColumnPos(\"F2_VOLUME\"+cScan))\r\n\t\t\t\tnPosCpoMrc := 0\r\n\t\t\t\tnPosCpoNum := 0\r\n\t\t\t\tif !empty(cMRCVLMSF2)\r\n\t\t\t\t\taCpoMarVol := StrTokArr2(cMRCVLMSF2, \";\" ) \r\n\t\t\t\t\tif len(aCpoMarVol) == 2\r\n\t\t\t\t\t\tcCpoMarca := alltrim(aCpoMarVol[1])\r\n\t\t\t\t\t\tcCpoNumer := alltrim(aCpoMarVol[2])\r\n\t\t\t\t\t\tnPosCpoMrc := SF2->(ColumnPos(cCpoMarca + cScan)) \r\n\t\t\t\t\t\tnPosCpoNum := SF2->(ColumnPos(cCpoNumer + cScan))\r\n\t\t\t\t\tendif\r\n\t\t\t\tendif\r\n\r\n\t\t\t\tWhile ( !Empty(cScan) )\r\n\t\t\t\t\tcEspecie := \"\"\r\n\t\t\t\t\tnVolume := 0\r\n\t\t\t\t\tcMarca := \"\"\r\n\t\t\t\t\tcNumeracao := \"\"\r\n\r\n\t\t\t\t\tif nPosCpoEsp > 0\r\n\t\t\t\t\t\tcEspecie := upper(SF2->(FieldGet(nPosCpoEsp)))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\t\tIf !empty(cEspecie)\r\n\r\n\t\t\t\t\t\tif nPosCpoMrc > 0\r\n\t\t\t\t\t\t\tcMarca := alltrim(SF2->(FieldGet(nPosCpoMrc)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoNum > 0\r\n\t\t\t\t\t\t\tcNumeracao := alltrim(SF2->(FieldGet(nPosCpoNum)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoVol > 0\r\n\t\t\t\t\t\t\tnVolume := SF2->(FieldGet(nPosCpoVol))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tnScan := aScan(aEspVol,{|x| x[1] == cEspecie})\r\n\t\t\t\t\t\tIf ( nScan==0 .AND.cScan == \"1\" )\r\n\t\t\t\t\t\t\taadd(aEspVol,{ cEspecie, nVolume , SF2->F2_PLIQUI , SF2->F2_PBRUTO, cMarca, cNumeracao})\r\n\t\t\t\t\t\tElseIf ( nScan<>0 .AND.cScan == \"1\" )\r\n\t\t\t\t\t\t\taEspVol[nScan][2] += nVolume\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aEspVol,{ cEspecie, nVolume , 0 , 0, cMarca, cNumeracao})\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcScan := Soma1(cScan,1)\r\n\t\t\t\t\tnPosCpoEsp := SF2->(ColumnPos(\"F2_ESPECI\"+cScan))\r\n\t\t\t\t\tIf nPosCpoEsp == 0 \r\n\t\t\t\t\t\tcScan := \"\"\r\n\t\t\t\t\t\texit\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tnPosCpoVol := SF2->(ColumnPos(\"F2_VOLUME\"+cScan))\r\n\t\t\t\t\tif !empty(cCpoMarca) .and. !empty(cCpoNumer)\r\n\t\t\t\t\t\tnPosCpoMrc := SF2->(ColumnPos(cCpoMarca+cScan))\r\n\t\t\t\t\t\tnPosCpoNum := SF2->(ColumnPos(cCpoNumer+cScan))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\tEndDo\r\n\r\n\t\t\t\t//Verifica se é uma venda de origem do Venda Direta ou SIGALOJA\r\n\t\t\t\tdbSelectArea(\"SL1\")\r\n\t\t\t\tSL1->(DbSetOrder(2)) //L1_FILIAL+L1_SERIE+L1_DOC+L1_PDV\r\n\t\t\t\tlVLojaDir := SL1->(DbSeek(xFilial('SL1') + SF2->F2_SERIE + SF2->F2_DOC))\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Procura duplicatas                                                      ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf !Empty(SF2->F2_DUPL)\t.Or. lVLojaDir\r\n\t\t\t\t\t\r\n\t\t\t\t\tcFilTit := xFilial(\"SE1\")\r\n\r\n\t\t\t\t\tIf lVLojaDir\r\n\t\t\t\t\t\t//Verifica se é venda com Entrega ou Retira Posterior, pois pode ter ocorrido em outra filial.\r\n\t\t\t\t\t\tIf !Empty(SL1->L1_ORCRES)\r\n\t\t\t\t\t\t\tcFilTit := xFilial(\"SE1\",SL1->L1_FILRES)\r\n\t\t\t\t\t\t\tSL1->(DbSetOrder(1)) //L1_FILIAL + L1_NUM\r\n\t\t\t\t\t\t\t//Posiciona no Orçamento Pai\r\n\t\t\t\t\t\t\tSL1->(DbSeek(xFilial(\"SL1\",SL1->L1_FILRES)+SL1->L1_ORCRES))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tcPrfTit\t\t:= If(Empty(SL1->L1_SERIE),SL1->L1_SERPED,SL1->L1_SERIE)\r\n\t\t\t\t\t\tcNumTit \t:= LJ7NumTit()\r\n\t\t\t\t\t\tcNumDupl \t:= cNumTit\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcPrfTit \t:= SF2->F2_PREFIXO\r\n\t\t\t\t\t\tcNumTit \t:= SF2->F2_DOC\r\n\t\t\t\t\t\tcNumDupl \t:= SF2->F2_DUPL\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcChaveSE1 := cFilTit + cPrfTit + cNumTit\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SED\")\r\n\t\t\t\t\taOrdSED := SED->(getArea())\r\n\t\t\t\t\tSED->(dbSetOrder(1))\r\n\t\t\t\t\tcLJTPNFE := (StrTran(cMV_LJTPNFE,\",\",\" ','\"))+\" \"\r\n\t\t\t\t\tcWhere := cLJTPNFE\r\n\t\t\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\t\t\tSE1->(dbSetOrder(1))\r\n\t\t\t\t\t#IFDEF TOP\r\n\t\t\t\t\t\tlQuery  := .T.\r\n\t\t\t\t\t\tcAliasSE1 := GetNextAlias()\r\n\t\t\t\t\t\tBeginSql Alias cAliasSE1\r\n\t\t\t\t\t\t\tCOLUMN E1_VENCORI AS DATE\r\n\t\t\t\t\t\t\tSELECT E1_FILIAL,E1_PREFIXO,E1_NUM,E1_PARCELA,E1_TIPO,E1_VENCORI,E1_VALOR,E1_VLCRUZ,E1_ORIGEM,E1_PIS,E1_COFINS,E1_CSLL,E1_INSS,E1_VLRREAL,E1_IRRF,E1_ISS,E1_NATUREZ\r\n\t\t\t\t\t\t\tFROM %Table:SE1% SE1\r\n\t\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\tSE1.E1_FILIAL = %Exp:cFilTit% AND\r\n\t\t\t\t\t\t\tSE1.E1_PREFIXO = %Exp:cPrfTit% AND \r\n\t\t\t\t\t\t\tSE1.E1_NUM = %Exp:cNumDupl% AND \r\n\t\t\t\t\t\t\t((SE1.E1_TIPO = %Exp:MVNOTAFIS%) OR (SE1.E1_TIPO = 'DP ' ) OR\r\n\t\t\t\t\t\t\t ((SE1.E1_ORIGEM IN ('LOJA701','FATA701','LOJA010')) AND SE1.E1_TIPO IN (%Exp:cWhere%))) AND\r\n\t\t\t\t\t\t\tSE1.%NotDel%\r\n\t\t\t\t\t\t\tORDER BY %Order:SE1%\r\n\t\t\t\t\t\tEndSql\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t#ELSE\r\n\t\t\t\t\t\tcChaveSE1 := cFilTit + SF2->F2_PREFIXO + SF2->F2_DOC\r\n\t\t\t\t\t\tSE1->(MsSeek(cChaveSE1))\r\n\t\t\t\t\t#ENDIF\r\n\t\t\t\t\tWhile (cAliasSE1)->(!Eof()) .And. (cAliasSE1)->E1_FILIAL+(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM == cChaveSE1\r\n\t\t\t\t\t\t\tIf empty(cNatFin) .Or. !(cNatFin == (cAliasSE1)->E1_NATUREZ)\r\n\t\t\t\t\t\t\t\tcNatFin := (cAliasSE1)->E1_NATUREZ\r\n\t\t\t\t\t\t\t\tSED->(dbSeek( xfilial(\"SED\") + cNatFin))\r\n\t\t\t\t\t\t\t\tcED_DEDINSS := alltrim(SED->ED_DEDINSS)\r\n\t\t\t\t\t\t\t\tcED_RECFUN := alltrim(SED->ED_RECFUN)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf (cAliasSE1)->E1_TIPO = MVNOTAFIS .OR. (cAliasSE1)->E1_TIPO = 'DP' .OR. ((Alltrim((cAliasSE1)->E1_ORIGEM) $ 'LOJA701|FATA701|LOJA010') .AND. (cAliasSE1)->E1_TIPO $ cWhere)\r\n\t\t\t\t\t\t\t\t//Aletrado a busca do valor da Fatura do campo E1_VLCURZ para E1_VLRREAL, \r\n\t\t\t\t\t\t\t\t//devido a titulos com desconto da TAXA do Cartão de Créito que não devem\r\n\t\t\t\t\t\t\t\t//ser repassados para o XML e DANFE.                                                                                    \r\n\t\t\t\t\t\t\t\tnValDupl := IIF((cAliasSE1)->E1_VLRREAL > 0,(cAliasSE1)->E1_VLRREAL,(cAliasSE1)->E1_VLCRUZ)\r\n\t\t\t\t\t\t\t\tIf cValLiqB == \"2\" // 1 Baixa - 2 Emissao\r\n\t\t\t\t\t\t\t\t\tIf Alltrim(SM0->M0_PRODRUR) $ \"1|2|F|J\" .And.;\r\n\t\t\t\t\t\t\t\t\t\t(Alltrim(SM0->M0_PRODRUR) $ \"2|J\" .Or. ;\r\n\t\t\t\t\t\t\t\t\t\t(Alltrim(SM0->M0_PRODRUR) $ \"1|F\" .And. ( Alltrim(SA1->A1_PESSOA) == \"F\" .or. ( (cED_DEDINSS == \"2\" .and. cED_RECFUN == \"2\") .or. Alltrim(SA1->A1_RECINSS) == \"S\"))))\r\n\t\t\t\t\t\t\t\t\t\taadd(aDupl,{(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM+(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_VENCORI;\r\n\t\t\t\t\t\t\t\t\t\t,(nValDupl-(cAliasSE1)->E1_PIS-(cAliasSE1)->E1_COFINS-(cAliasSE1)->E1_CSLL)-(cAliasSE1)->E1_IRRF- IIF(!lRuleDescISS, (cAliasSE1)->E1_ISS, 0)})\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taadd(aDupl,{(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM+(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_VENCORI;\r\n\t\t\t\t\t\t\t\t\t\t,(nValDupl-(cAliasSE1)->E1_PIS-(cAliasSE1)->E1_COFINS-(cAliasSE1)->E1_CSLL-(cAliasSE1)->E1_INSS)-(cAliasSE1)->E1_IRRF- IIF(!lRuleDescISS, (cAliasSE1)->E1_ISS, 0)})\t\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t  \r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\taadd(aDupl,{(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM+(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_VENCORI,nValDupl})\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tdbSelectArea(cAliasSE1)\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t    EndDo\r\n\t\t\t\t    If lQuery\r\n\t\t\t\t    \tdbSelectArea(cAliasSE1)\r\n\t\t\t\t    \tdbCloseArea()\r\n\t\t\t\t    \tdbSelectArea(\"SE1\")\r\n\t\t\t\t    EndIf\r\n\t\t\t\t\tRestArea(aOrdSED)\r\n\t\t\t\tElse\r\n\t\t\t\t\taDupl := {}\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Analisa os impostos de retencao                                         ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t//Tratamento para notas sobre cupom(Incluir demais estados conforme conforme legislacao).\r\n\t\t\t\t//A Nota Fiscal  deve ser toda preenchida, sendo a sua escrituração feita com valores zerados, já que o débito será feito pelo cupom\r\n\t\t\t\t//Assim, no livro Registro de Saídas deve ser registrado para esta nota apenas a coluna \"Observações\", onde serão indicados o seu número e a sua série.\r\n\t\t\t\t//Fundamento: artigo 135, § 2º, do RICMS/2000.\t\t  \t\r\n\t\t\t\t//Fundamento: Decreto nº 29.907/2009 , art. 36 , §§ 9º e 10º; RICMS-CE/1997 , art. 731-E1\t\r\n\t\t\t\t//Fundamento: Portaria SEFP nº 799, de 30.12.1997 - DO DF de 31.12.1997\r\n\t\t\t\tIf lNfCup .And. SM0->M0_ESTCOB $ \"CE/DF\" \r\n\t\t\t\t\tlNfCupZero\t:= .T.\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\tDbSelectArea( \"SF2\" )\r\n\t\t\t\t\tDbSetOrder(1)  // F2_DOC + F2_SERIE + F2_CLIENTE + F2_LOJA\r\n\t\t\t\t\tDbSeek( xFilial(\"SF2\") + cNumNfCup + cSerNfCup)\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALPIS\"))<>0 .and. SF2->F2_VALPIS>0\r\n\t\t\t\t\taadd(aRetido,{\"PIS\",0,SF2->F2_VALPIS})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALCOFI\"))<>0 .and. SF2->F2_VALCOFI>0\r\n\t\t\t\t\taadd(aRetido,{\"COFINS\",0,SF2->F2_VALCOFI})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALCSLL\"))<>0 .and. SF2->F2_VALCSLL>0\r\n\t\t\t\t\taadd(aRetido,{\"CSLL\",0,SF2->F2_VALCSLL})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALIRRF\"))<>0 .and. SF2->F2_VALIRRF>0\r\n\t\t\t\t\taadd(aRetido,{\"IRRF\",SF2->F2_BASEIRR,SF2->F2_VALIRRF})\r\n\t\t\t\tEndIf\t\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALINSS\"))<>0 .and. SF2->F2_VALINSS>0\r\n\t\t\t\t\taadd(aRetido,{\"INSS\",SF2->F2_BASEINS,SF2->F2_VALINSS})\r\n\t\t\t\tEndIf  \r\n\t\t\t\t\r\n\t\t\t\t// Total Carga Tributária \r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTIMP\"))<>0 .and. SF2->F2_TOTIMP>0\r\n\t\t\t\t\tnTotalCrg := SF2->F2_TOTIMP\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//----------------------------------------------\r\n\t\t\t\t// Total Carga Tributária por Ente Tributante\r\n\t\t\t\t//----------------------------------------------\r\n\t\t\t\t\r\n\t\t\t\t// Ente Federal\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTFED\"))<>0 .and. SF2->F2_TOTFED>0\r\n\t\t\t\t\tnTotFedCrg := SF2->F2_TOTFED\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t// Ente Estadual\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTEST\"))<>0 .and. SF2->F2_TOTEST>0\r\n\t\t\t\t\tnTotEstCrg := SF2->F2_TOTEST\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t// Ente Municipal\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTMUN\"))<>0 .and. SF2->F2_TOTMUN>0\r\n\t\t\t\t\tnTotMunCrg := SF2->F2_TOTMUN\r\n\t\t\t\tEndIf\t\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//RECOPI\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_IDRECOP\")) > 0 .and. !Empty(SF2->F2_IDRECOP)\r\n\t\t\t\t\tcIdRecopi := SF2->F2_IDRECOP\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf !Empty(cIdRecopi)\r\n\t\t\t\t\tIf AliasIndic(\"CE3\")\r\n\t\t\t\t\t\tCE3->(DbSetOrder(1))\r\n\t\t\t\t\t\tIf CE3->(DbSeek(xFilial(\"CE3\")+Alltrim(cIdRecopi)))\r\n\t\t\t\t\t\t\tcNumRecopi:= IIf(CE3->(FieldPos(\"CE3_RECOPI\")) > 0, Alltrim(CE3->CE3_RECOPI), \"\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//////INCLUSAO DE CAMPOS NA QUERY////////////\r\n\t\t\t\t\r\n\t\t\t\tcField := \"%\"\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_DESCZFC\"))<>0 .AND. SD2->(FieldPos(\"D2_DESCZFP\"))<>0\r\n\t\t\t\t\tcField += \",D2_DESCZFC,D2_DESCZFP\" \t\t\t\t\t\t\r\n\t\t\t\tEndIf     \r\n\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_NFCUP\"))<>0\r\n\t\t\t\t   cField  +=\",D2_NFCUP\"\r\n\t\t\t\tEndIF   \r\n\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_DESCICM\"))<>0\r\n\t\t\t\t   cField  +=\",D2_DESCICM\"\t\t\t\t\t\t    \r\n\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_FCICOD\"))<>0\r\n\t\t\t\t   cField  +=\",D2_FCICOD\"\t\t\t\t\t\t    \r\n\t\t\t\tEndIF\r\n\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_VLIMPOR\"))<>0\r\n\t\t\t\t   cField  +=\",D2_VLIMPOR\"\t\t\t\t    \r\n\t\t\t\tEndIF\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTIMP\"))<>0\r\n\t\t\t\t   cField  +=\",D2_TOTIMP\"\t\t\t\t    \r\n\t\t\t\tEndIf\t\t\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTFED\"))<>0\t// Ente Tributante Federal\r\n\t\t\t\t   cField  +=\",D2_TOTFED\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTEST\"))<>0\t// Ente Tributante Estadual\r\n\t\t\t\t   cField  +=\",D2_TOTEST\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTMUN\"))<>0\t// Ente Tributante Municipal\r\n\t\t\t\t   cField  +=\",D2_TOTMUN\"\t\t\t\t    \r\n\t\t\t\tEndIf\t \r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_GRPCST\"))<>0 //Grupo de tributação de ipi\r\n\t\t\t\t   cField  +=\",D2_GRPCST\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_VRDICMS\"))<>0\r\n\t\t\t\t   cField  +=\",D2_VRDICMS\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tcField += \"%\"\r\n\t\t\t\t\r\n\t\t\t\t//////////////////////////////////////////////\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf lNfCupZero\r\n\t\t\t\t\tRestArea(aAreaSF2)\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Pesquisa itens de nota                                                  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t#IFDEF TOP\r\n\t\t\t\t\tlQuery  := .T.\r\n\t\t\t\t\tcAliasSD2 := GetNextAlias()\r\n\t\t\t\t\t//Verifica se existe Template DCL\r\n\t      \t\t\tIF cVerAmb >= \"4.00\" .And. (ExistTemplate(\"PROCMSG\")) //Tratativa para Grupo de Repasse de Combustiveis\r\n\t\t\t\t\t\tBeginSql Alias cAliasSD2\r\n\t\t\t\t\t\t\t\tSELECT D2_FILIAL,D2_SERIE,D2_DOC,D2_CLIENTE,D2_LOJA,D2_COD,D2_TES,D2_NFORI,D2_SERIORI,D2_ITEMORI,D2_TIPO,D2_ITEM,D2_CF,\r\n\t\t\t\t\t\t\t\tD2_QUANT,D2_TOTAL,D2_DESCON,D2_VALFRE,D2_SEGURO,D2_PEDIDO,D2_ITEMPV,D2_DESPESA,D2_VALBRUT,D2_VALISS,D2_PRUNIT,\r\n\t\t\t\t\t\t\t\tD2_CLASFIS,D2_PRCVEN,D2_IDENTB6,D2_CODISS,D2_DESCZFR,D2_PREEMB,D2_DESCZFC,D2_DESCZFP,D2_LOTECTL,D2_NUMLOTE,D2_ICMSRET,D2_VALPS3,\r\n\t\t\t\t\t\t\t\tD2_ORIGLAN,D2_VALCF3,D2_VALIPI,D2_VALACRS,D2_PICM,D2_PDV,D2_BRICMSO,D2_ICMRETO,D2_BRICMSD,D2_ICMRETD %Exp:cField% \r\n\t\t\t\t\t\t\t\tFROM %Table:SD2% SD2\r\n\t\t\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\t\tSD2.D2_FILIAL  = %xFilial:SD2% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_SERIE   = %Exp:SF2->F2_SERIE% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_DOC     = %Exp:SF2->F2_DOC% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_CLIENTE = %Exp:SF2->F2_CLIENTE% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_LOJA    = %Exp:SF2->F2_LOJA% AND\r\n\t\t\t\t\t\t\t\tSD2.%NotDel%\r\n\t\t\t\t\t\t\t\tORDER BY D2_FILIAL,D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA,D2_ITEM,D2_COD\r\n\t\t\t\t\t\tEndSql\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tBeginSql Alias cAliasSD2\r\n\t\t\t\t\t\t\tSELECT D2_FILIAL,D2_SERIE,D2_DOC,D2_CLIENTE,D2_LOJA,D2_COD,D2_TES,D2_NFORI,D2_SERIORI,D2_ITEMORI,D2_TIPO,D2_ITEM,D2_CF,\r\n\t\t\t\t\t\t\tD2_QUANT,D2_TOTAL,D2_DESCON,D2_VALFRE,D2_SEGURO,D2_PEDIDO,D2_ITEMPV,D2_DESPESA,D2_VALBRUT,D2_VALISS,D2_PRUNIT,\r\n\t\t\t\t\t\t\tD2_CLASFIS,D2_PRCVEN,D2_IDENTB6,D2_CODISS,D2_DESCZFR,D2_PREEMB,D2_DESCZFC,D2_DESCZFP,D2_LOTECTL,D2_NUMLOTE,D2_ICMSRET,D2_VALPS3,\r\n\t\t\t\t\t\t\tD2_ORIGLAN,D2_VALCF3,D2_VALIPI,D2_VALACRS,D2_PICM,D2_PDV %Exp:cField% \r\n\t\t\t\t\t\t\tFROM %Table:SD2% SD2\r\n\t\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\tSD2.D2_FILIAL  = %xFilial:SD2% AND\r\n\t\t\t\t\t\t\tSD2.D2_SERIE   = %Exp:SF2->F2_SERIE% AND\r\n\t\t\t\t\t\t\tSD2.D2_DOC     = %Exp:SF2->F2_DOC% AND\r\n\t\t\t\t\t\t\tSD2.D2_CLIENTE = %Exp:SF2->F2_CLIENTE% AND\r\n\t\t\t\t\t\t\tSD2.D2_LOJA    = %Exp:SF2->F2_LOJA% AND\r\n\t\t\t\t\t\t\tSD2.%NotDel%\r\n\t\t\t\t\t\t\tORDER BY D2_FILIAL,D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA,D2_ITEM,D2_COD\r\n\t\t\t\t\t\tEndSql\r\n\r\n\t\t\t\t\tEndIf\t\r\n\t\r\n\t\t\t\t#ELSE\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tlLjDescIt\t:= .F.\t// Inicializa as variaveis que serao utilizadas para desconto \r\n\t\t\t\tlFirstItem \t:= .T.\r\n\t\t\t\tnCount\t\t:= 0\r\n\t\t\t\tlVLojaDir\t:= .F. //Verifica se tem item de venda de origem Venda Direta, Sigaloja ou Nota Sobre Cupom\r\n\t\t\t\tnCountIT := 0\r\n\t\t\t\tWhile !Eof() .And. xFilial(\"SD2\") == (cAliasSD2)->D2_FILIAL .And.;\r\n\t\t\t\t\tSF2->F2_SERIE == (cAliasSD2)->D2_SERIE .And.;\r\n\t\t\t\t\tSF2->F2_DOC == (cAliasSD2)->D2_DOC\r\n\t\t\t\t\t\r\n\t\t\t\t\tlContinua := .T.\r\n\t\t\t\t\t\r\n\t\t\t\t\tnCount++\r\n\t\t\t\t\t//Se for nota sobre cupom, pega somente os itens do cupom que estão na nota sobre cupom.\t\t\t\t\r\n\t\t\t\t\tIf SD2->(FieldPos(\"D2_NFCUP\")) <> 0 .And. !Empty( (cAliasSD2)->D2_NFCUP )\r\n\t\t\t\t\t\tIf lNfCup .And. !( cSerNfCup + cNumNfCup  == SubStr((cAliasSD2)->D2_SERIORI,1,TamSx3(\"F2_SERIE\")[1]) + SubStr((cAliasSD2)->D2_NFCUP,1,TamSx3(\"F2_DOC\")[1]) )\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tlContinua := .F.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tendIf\r\n\t\t\t\t\tEndif\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf (cAliasSD2)->D2_TIPO == \"D\" .And. SM0->M0_ESTENT == \"PR\" .And. (cAliasSD2)->D2_ICMSRET > 0\r\n\t\t\t\t\t\t/* Tratamento para com base na legislação do Estado do Paraná Decreto n 6.080/2012 - DOE PR Suplemento  \r\n\t\t\t\t\t\te para atender a ICMS/PR 2017 (Decreto 7.871/2017) Art. 9, Seção I, Anexo IX \r\n\t\t\t\t\t\tque não prevê o destaque do ICMS no campo específico (tanto o da operação própria do substituto quanto do \r\n\t\t\t\t\t\tretido por substituição tributária) ISSUE DSERTSS1-5542. */\t\t\t\t\t\t\r\n\t\t\t\t\t\tlIcmSTDev\t:= .F.\r\n\t\t\t\t\t\tlIcmDevol\t:= .F.\t\t\t\t\t\t\r\n\t\t\t\t\t\tlIcmsPR\t:= .T.\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tlIcmSTDev\t:= lIcmSTDevOri\r\n\t\t\t\t\t\tlIcmDevol\t:= lIcmDevolOri\t\r\n\t\t\t\t\t\tlIcmsPR\t:= .F.\r\n\t\t\t\t\tendif\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf lGE .and. lNfCup \r\n\t\t\t\t\t\tDbSelectArea(\"SB1\")\r\n\t\t\t\t\t\taSb1 := SB1->(GetArea())\r\n\t\t\t\t\t\tDbSetOrder(1) // B1_FILIAL+B1_COD\r\n\t\t\t\t\t\tIf DbSeek(xFilial(\"SB1\")+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\tIf SB1->B1_TIPO == cTpGar \t\r\n\t\t\t\t\t\t\t\tlContinua := .F.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tRestArea(aSb1)\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf lContinua\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Verifica a natureza da operacao                                         ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf lNfCup\r\n\t\t\t\t\t\t\taAreaSD2  \t:= SD2->(GetArea())\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Pesquisa itens de nota                                                  ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\t\t\t\t\t\t\tIf Val((cAliasSD2)->D2_ITEMORI)== 0\r\n\t\t\t\t\t\t\t   cNumitem := (cAliasSD2)->D2_ITEM\r\n\t\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\t   cNumitem := (cAliasSD2)->D2_ITEMORI\r\n\t\t\t\t\t\t\tEnd\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t/*Ajuste para buscar a TES do cupom fiscal*/\r\n\t\t\t\t\t\t\tDbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\tDbSetOrder(3)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf Dbseek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\t\t\tcD2Tes\t:= SD2->D2_TES\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf DbSeek(xFilial(\"SD2\")+cNumNfCup+cSerNfCup+cCliNota+cCliLoja+(cAliasSD2)->D2_COD+cNumitem)\r\n\t\t\t\t\t\t\t\tcD2Cfop := SD2->D2_CF\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tlChave:=.T.\r\n\t\t\t\t\t\t\t\tcChCupom := \"S\"+cSerNfCup+cNumNfCup+cCliNota+cCliLoja+cNumitem\r\n\t\t\t\t\t\t\t\tcD2TesNF := SD2->D2_TES\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tRestArea(aAreaSD2)\r\n\t\t\t\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t\t    \t//|                                                             ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf Alltrim(SF2->F2_ESPECIE) == \"NFCE\" .OR. Alltrim(SF2->F2_ESPECIE) == \"SATCE\"\r\n\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF2->F2_EMISSAO, SF2->F2_SERIE, SF2->F2_DOC, SM0->M0_CGC, SM0->M0_ESTCOB, SF2->F2_ESPECIE, SF2->F2_CHVNFE,0,\"\",\"\",0,\"\",\"\" })\r\n\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aRefECF,{SD2->D2_DOC,SF2->F2_ESPECIE,SF2->F2_PDV})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Quando nao for cupom fiscal,\t\t\t\t\t\t\t³\r\n\t\t\t\t\t\t\t//³\to CFOP deve ser atualizado com o CFOP de cada ITEM, |\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t \r\n\t\t\t\t\t\t\tcD2Cfop := (cAliasSD2)->D2_CF\r\n\t\t\t\t\t\t\tcD2Tes\t:= (cAliasSD2)->D2_TES\r\n\t\t\t\t\t\t\tlChave:=.F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcChaveD2 := \"S\" + ( cAliasSD2 )->( D2_SERIE + D2_DOC + D2_CLIENTE + D2_LOJA + D2_ITEM )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+cD2Tes)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças\r\n\t\t\t\t\t\tIf lCpoCusEnt .And. cMVEstado == \"PE\" .And. SF4->F4_CUSENTR ==\"1\"\r\n\t\t\t\t\t\t\tlCustoEntr := .T.\r\n\t\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\t\tIf SF4->F4_AGRPIS = \"1\"\r\n\t\t\t\t\t\t\taAdd(aAgrPis,{.T.,0})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taAdd(aAgrPis,{.F.,0})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf SF4->F4_AGRCOF = \"1\"\r\n\t\t\t\t\t\t\taAdd(aAgrCofins,{.T.,0})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taAdd(aAgrCofins,{.F.,0})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcChave:=\"\"\r\n\t\t\t\t\t\tIf !lChave\r\n\t\t\t\t\t\t\tcChave :=  cChaveD2   \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcChave :=  cChCupom\r\n\t\t\t\t\t\tEndif\r\n\t\r\n\t          // Posiciono na TES do cupom fiscal para pegar a natureza de operação da nf sobre cupom\r\n\t\t\t\t\t\t/*Necessario para imprimir a natureza de operação do cupom fiscal emitido em ECF*/\r\n\t\t\t\t\t\tIf lNfCup .And. !Empty(cD2TesNF)\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+cD2TesNF)\r\n\t\t\t\t\t\tEndIf              \r\n\t                  \r\n\t\t\t\t\t\tSFT->( dbSetOrder( 1 ) )\r\n\t\t\t\t\t\t//utiliza a funcao SpedNatOper ( SPEDXFUN ) que possui o tratamento para a natureza da operacao/prestacao\r\n\t\t\t\t\t\tif FindFunction( \"SpedNatOper\" ) .And. SFT->( MsSeek( xFilial( \"SFT\" ) +cChave) )\r\n\t\t\t\t\t\t\tIf !Alltrim(SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ])$cNatOper\r\n\t\t\t\t\t\t  \t\tIf\tEmpty(cNatOper)\r\n\t\t\t\t\t\t     \t\tcNatOper := SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\t  \t\tElse\r\n\t\t\t\t\t\t      \t\tcNatOper := cNatOper + \"/ \" +SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\t  \t\tEndif\r\n\t\t\t\t\t\t   Endif\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tIf !lNatOper\r\n\t\t\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\t\t\tcNatOper := Alltrim(SF4->F4_TEXTO)\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tcNatOper += Iif(!Alltrim(SF4->F4_TEXTO)$cNatOper,\"/ \" + SF4->F4_TEXTO,\"\")\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\tElse\t\t\t\t   \t\r\n\t\t\t\t\t\t\t\taSX513 \t := FwGetSX5(\"13\",SF4->F4_CF)\r\n\t\t\t\t\t\t\t\tIf len(aSX513) > 0\r\n\t\t\t\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\t\t\t\tcNatOper := AllTrim(SubStr(aSX513[1][4],1,55))\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tcNatOper += Iif(!AllTrim(SubStr(aSX513[1][4],1,55)) $ cNatOper, \"/ \" + AllTrim(SubStr(aSX513[1][4],1,55)), \"\")\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t    \t\tEndIf\r\n\t\t\t\t    \tendif\r\n\t\t\t    \t\t\r\n\t\t\t    \t\t// Posiciono na TES da NF Sobre Cupom novamente\r\n\t\t\t\t\t\t/*Necessario para posicionar noo SF4 referente a nota sobre cupom*/\r\n\t\t\t\t\t\tIf lNfCup\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+cD2Tes)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t    \t\tIf SF4->(FieldPos(\"F4_BASEICM\"))>0\r\n\t\t\t    \t\t\tnRedBC := IiF(SF4->F4_BASEICM>0,IiF(SF4->F4_BASEICM == 100,SF4->F4_BASEICM,IiF(SF4->F4_BASEICM > 100,0,100-SF4->F4_BASEICM)),SF4->F4_BASEICM)\r\n\t\t\t    \t\t\tcCST   := SF4->F4_SITTRIB \r\n\t\t\t    \t\tEndif\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Verifica as notas vinculadas                                            ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_NFORI)\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_TIPO $ \"DBN\"\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tIf\t( MsSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD+PADL(alltrim((cAliasSD2)->D2_ITEMORI),TamSx3(\"D2_ITEMORI\")[1],\"0\")) ) .OR. ;\r\n\t\t\t\t\t\t\t\t\t( MsSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA) .And. Empty(cMVREFNFE) )  .Or. ;\r\n\t\t\t\t\t\t\t\t\tPosiTriang(cAliasSD2)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//Posiciona SD1 de acordo com o D1_NUMSEQ caso tenha referencia de poder de terceiro.\r\n\t\t\t\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_IDENTB6)    \t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tnSD1Pos := SD1->(Recno())\t\t\t\t\t\t\t\t\t\t\t\t\t    \t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_IDENTB6)\r\n\t\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\t\tSD1->(DbGoTo(nSD1Pos))\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_TIPO)\r\n\t\t\t\t\t\t\t\t\tIf SD1->D1_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Obtem os dados de nota fiscal de produtor rural referenciada                                  ³\r\n\t\t\t\t\t\t\t\t\t//³Temos duas situacoes:                                                                         ³\r\n\t\t\t\t\t\t\t\t\t//³A NF de saída é uma devolucao, onde a NF original pode ser ou nao uma devolução.              ³\r\n\t\t\t\t\t\t\t\t\t//³1) Quando a NF original for uma devolucao, devemos utilizar o remetente do documento fiscal,  ³\r\n\t\t\t\t\t\t\t\t\t//³    podendo ser o sigamat.emp no caso de formulario proprio ou o proprio SA1 no caso de nf de ³\r\n\t\t\t\t\t\t\t\t\t//³    entrada com formulario proprio igual a NAO.                                               ³\r\n\t\t\t\t\t\t\t\t\t//³2) Quando a NF original NAO for uma devolucao, neste caso tambem pode variar conforme o       ³\r\n\t\t\t\t\t\t\t\t\t//³    formulario proprio igual a SIM ou NAO. No caso do NAO, os dados a serem obtidos retornara ³\r\n\t\t\t\t\t\t\t\t\t//³    da tabela SA2.                                                                            ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf AllTrim(SF1->F1_ESPECIE)==\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t//para nota de entrada tipo devolucao o emitente eh o cliente ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\t\t\t\tIf SD1->D1_TIPO$\"DB\"\r\n\t\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA1->A1_CGC),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA1->A1_EST),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA1->A1_INSCR)})\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t//para nota de entrada normal o emitente eh o fornecedor ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA2->A2_CGC),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA2->A2_EST),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA2->A2_INSCR)})\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\t//Informacoes do cupom fiscal referenciado\r\n\t\t\t\t\t\t\t\t\tIf AllTrim(SF1->F1_ESPECIE)==\"CF\"\r\n\t\t\t\t\t\t\t\t\t\taadd(aRefECF,{SD1->D1_DOC,SF1->F1_ESPECIE,\"\"})\r\n\t\t\t\t\t\t\t\t\tEndif  \r\n\t\t\t\t\t\t\t\t\t//Outros documentos referenciados\r\n\t\t\t\t\t\t\t\t\tif AllTrim(SF1->F1_ESPECIE)<>\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t//Documento de Estorno - Tipo Devolucao e F4_AJUSTE=\"S\"\r\n\t\t\t\t\t\t\t\t\t\t//identifica que se trata de nf de estorno.\r\n\t\t\t\t\t\t\t\t\t\tIf ( ( cAliasSD2 )->D2_COD == SD1->D1_COD .AND. SF4->F4_AJUSTE == \"S\" )\t\r\n\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SD1->D1_EMISSAO, SD1->D1_SERIE , SD1->D1_DOC, iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ), SM0->M0_ESTCOB, SF1->F1_ESPECIE, SF1->F1_CHVNFE, SD1->D1_TOTAL-SD1->D1_DESC, \"\", SF1->F1_TIPO, iif(SD1->D1_TIPO $ \"DB\",1,2), SD1->D1_FORNECE, SD1->D1_LOJA })\r\n\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tnCountIT += 1\r\n\t\t\t\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF1->F1_CHVNFE, SF1->F1_VALBRUT})\r\n\r\n\t\t\t\t\t\t\t\t\t\tElseif cChave <> dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE;\r\n\t\t\t\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SD1->D1_EMISSAO, SD1->D1_SERIE, SD1->D1_DOC, iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ), SM0->M0_ESTCOB, SF1->F1_ESPECIE, SF1->F1_CHVNFE,SD1->D1_TOTAL-SD1->D1_DESC,\"\",SF1->F1_TIPO, iif(SD1->D1_TIPO $ \"DB\",1,2), SD1->D1_FORNECE, SD1->D1_LOJA })\r\n\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\tnCountIT += 1\r\n\t\t\t\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF1->F1_CHVNFE, SF1->F1_VALBRUT})\r\n\t\t\t\t\t\t\t\t\t\tendIf\t\r\n\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\r\n\t\t\t\t\t\t\t\t\tendIf\t\r\n\t\t\t\t\t\t\t\tElseIf (cAliasSD2)->D2_TIPO == \"N\"                                                     \t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t   \t\tdbSetOrder(4)     \r\n\t\t\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SFT\")+\"S\"+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_NFORI)\r\n\t\t\t\t\t\t\t\t\t\tIf SFT->FT_ESTADO == \"EX\" .or. ((SubStr(SM0->M0_CODMUN,1,2) == \"35\" .Or. SubStr(SM0->M0_CODMUN,1,2) == \"29\") .and. \"REMESSA POR CONTA E ORDEM DE TERCEIROS\" $ Upper(cNatOper) .and. lOrgaoPub )//(Venda para orgao publico - SP/BA/CFOP Remessa por conta e ordem de terceiros (cfop 5923/6923)- ch:TIDWCY   \r\n\t\t\t\t\t\t\t\t\t\t\t//Se venda para orgao publico, vincula NFe do tipo Normal de faturamento\r\n\t\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\t\t\t   \t\tdbSetOrder(4) \r\n\t\t\t\t\t\t\t\t\t   \t\tMsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE) \r\n\t\t\t\t\t\t\t\t\t\t\tif cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA1->A1_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tElseIf Alltrim(SFT->FT_CFOP) $ cMVREFNFE\r\n\t\t\t\t\t\t\t\t\t\t\t//Tratamento para que leve na TAG <refNFe> as notas referenciadas que contém o CFOP no parâmetro MV_REFNFE\r\n\t\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\t\t\t   \t\tdbSetOrder(4) \r\n\t\t\t\t\t\t\t\t\t   \t\tIf (MsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE))\r\n\t\t\t\t\t\t\t\t\t\t   \t\tIf cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA1->A1_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\t\t\t\t\t\t\t\t\t\t\t\r\n\t                                                lVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\r\n\t\t\t\t\t\t\t\t\t\t   \tEndif\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\t\t\t   \t\tdbSetOrder(4) \r\n\t\t\t\t\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE)\t\t\t\t\t\t\t\t\t\t   \t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t//Obtem os dados de nota fiscal de produtor rural referenciada\r\n\t\t\t\t\t\t\t\t\t\t\t\t//A NF de saída Para este tipo de nota, o emitente eh sempre o sigamat.emp\r\n\t\t\t\t\t\t\t\t\t\t\t\tIf AllTrim(SF3->F3_ESPECIE)==\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//para nota de saida normal o emitente eh o sigamat\r\n\t\t\t\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SF3->F3_EMISSAO,SF3->F3_SERIE,SF3->F3_NFISCAL,SF3->F3_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tSM0->M0_CGC,SM0->M0_ESTENT,SM0->M0_INSC})\r\n\t\t\t\t\t\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\t   \t\t\t\t\tIf cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t\t\t\t   \t\t\t\t\t\t.or. (cAliasSD2)->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t   \t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA1->A1_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE ,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tendIf \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taOldReg  := SD2->(GetArea())\r\n\t\t\t\t\t\t\t\taOldReg2 := SF2->(GetArea())\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\t\t\t//Alterado a chave de busca completa devido ao procedimento de complemento de notas de devolucao de compras. FNC -> 00000008125/2011.\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//If MsSeek(xFilial(\"SD2\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD+(cAliasSD2)->D2_ITEMORI)\r\n\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SD2\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI)//+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD+(cAliasSD2)->D2_ITEMORI)\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SF2\")+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\tIf !SD2->D2_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\t\tlComplDev := .T.\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t//Obtem os dados de nota fiscal de produtor rural referenciada\r\n\t\t\t\t\t\t\t\t\t//A NF de saída NAO EH uma devolucao, portanto eh uma nota de saida complementar. Para este tipo\r\n\t\t\t\t\t\t\t\t\t//de nota, o emitente eh sempre o sigamat.emp\r\n\t\t\t\t\t\t\t\t\tIf AllTrim(SF2->F2_ESPECIE)==\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t//para nota de saida normal o emitente eh o sigamat\r\n\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD2->D2_EMISSAO,SD2->D2_SERIE,SD2->D2_DOC,SF2->F2_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\tSM0->M0_CGC,SM0->M0_ESTENT,SM0->M0_INSC})\r\n\t\t\t\t\t\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Outros documentos referenciados³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf cChave <> Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\taadd(aNfVinc,{SF2->F2_EMISSAO,SD2->D2_SERIE,SD2->D2_DOC,SM0->M0_CGC,SM0->M0_ESTCOB,SF2->F2_ESPECIE,SF2->F2_CHVNFE,0,\"\",\"\",0,\"\",\"\"})\r\n\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\tcChave := Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tRestArea(aOldReg)\r\n\t\t\t\t\t\t\t\tRestArea(aOldReg2)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf lVinc .and. !Empty(aNfVinc)\r\n\t\t\t\t\t\t\taadd(aItemVinc,{ATail(aNfVinc)[1]})\r\n\t\t\t\t\t\tElse\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aItemVinc,{})\r\n\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Obtem os dados do produto\r\n\t\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SB1\")+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\r\n\t\t   \t\t\t\tdbSelectArea(\"SB5\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf MsSeek(xFilial(\"SB5\")+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\tIf SB5->(FieldPos(\"B5_DESCNFE\")) > 0 .And. !Empty(SB5->B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tcInfAdic := Alltrim(SB5->B5_DESCNFE)\r\n\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\tcInfAdic := \"\"\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\r\n                            cUmDipi  := SB5->B5_UMDIPI      \r\n                            nConvDip := SB5->B5_CONVDIP    \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcInfAdic := \"\"\t\t\r\n                            cUmDipi  := \"\"    \r\n                            nConvDip := 0      \r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t \t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"DY3\")\r\n\t\t\t\t   \t\tdbSetOrder(1)\r\n\t\t\t\t   \t\tIf MsSeek(xFilial(\"DY3\")+ (cAliasSB5)->B5_ONU)\r\n\t\t\t\t\t\t\tIf !Empty(DY3->DY3_DESCRI) .and. (DY3->DY3_INFCPL ==\"S\" .OR. DY3->DY3_INFCPL ==\"1\")\r\n\t\t\t\t\t\t\t\tIf !cMensONU $ DY3->DY3_ONU\r\n\t\t\t\t\t     \t   \t\tcMensONU\t:= cMensONU +'  ONU '+Alltrim(DY3->DY3_ONU)+' '+Alltrim(DY3->DY3_DESCRI)+'   '   \r\n\t\t\t\t\t    \t\tEndIF\r\n\t\t\t\t   \t\t\tEndIF  \t\t\r\n\t\t\t\t\t\tEndIF\r\n\r\n                        \r\n                        //Atualiza a Unid. Medida da DIPI(cUmDipi) e o Fator de Conv. da DIPI(nConvDip) com dados da SBZ caso os parâmetro recebidos estejam vazios\r\n                        RetInfoSBZ((cAliasSD2)->D2_COD, @cUmDipi, @nConvDip)\r\n                        \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//------------------------------------------------------------------------\r\n\t\t\t\t\t\t//Obtem dados adicionais ou do produto, ou do item do pedido de venda\r\n\t\t\t\t\t\t//------------------------------------------------------------------------\r\n\t\t\t\t\t\tIf lC6_CODINF .And. cInfAdPr <> \"2\" .And. !Empty(cInfAdPr)\r\n\t\t\t\t\t\t\tSC6->(dbSetOrder(2))\r\n\t\t\t\t\t\t\tIf SC6->(MsSeek(xFilial(\"SD2\")+(cAliasSD2)->(D2_COD+D2_PEDIDO+D2_ITEMPV))) \r\n\t\t\t\t\t\t\t\tcInfAdPed := Alltrim(MSMM(SC6->C6_CODINF,80))\r\n\t\t\t\t\t\t\t\tIf !Empty(cInfAdPed)\r\n\t\t\t\t\t\t\t\t\t//--Obtem informacoes do item do pedido de venda\r\n\t\t\t\t\t          \tIf cInfAdPr == \"1\"     \r\n\t\t\t\t\t           \t\tcInfAdic := cInfAdPed\r\n\t\t\t\t\t           \t//--Obtem informacoes do item do pedido de venda e do produto\r\n\t\t\t\t\t           \tElseIf cInfAdPr == \"3\" \r\n\t\t\t\t\t           \t   cInfAdPed := SubStr(AllTrim(cInfAdPed),1,250)\r\n\t\t\t\t\t           \t   cInfAdic  := SubStr(AllTrim(cInfAdic),1,249)\r\n\t\t\t\t\t           \t   cInfAdic  += \" \" + cInfAdPed\r\n\t\t\t\t\t           \tEndIf \r\n\t\t\t\t\t      \tEndIf\r\n\t\t\t\t\t\t\tEndIf                                                  \t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Veiculos Novos\r\n\t\t\t\t\t\tIf AliasIndic(\"CD9\")\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD9\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD9\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//Combustivel\r\n\t\t\t\t\t\tIf AliasIndic(\"CD6\")\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD6\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD6\")+\"S\"+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+Padr((cAliasSD2)->D2_ITEM,4)+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//Medicamentos\r\n\t\t\t\t\t\tIf AliasIndic(\"CD7\")\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD7\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD7\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t// Armas de Fogo\r\n\t\t\t\t\t\tIf AliasIndic(\"CD8\")\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD8\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD8\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Anfavea\r\n\t\t\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDR\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tDbSeek(xFilial(\"CDR\")+\"S\"+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDS\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tcItem := PADR((cAliasSD2)->D2_ITEM,TAMSX3(\"CDS_ITEM\")[1])\r\n\t\t\t\t\t\t\tDbSeek(xFilial(\"CDS\")+\"S\"+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+cItem+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\tEndIf  \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Rastreabilidade\r\n\t\t\t\t\t\tIf AliasIndic(\"F0A\")\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"F0A\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"F0A\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t \t\t                    \t\t\t\t\t\r\n\t\t\t\t\t\t//Desconto Zona Franca PIS e COFINS \r\n\t\t\t\t\t\tIf\tSD2->(FieldPos(\"D2_DESCZFC\"))<>0 .AND. SD2->(FieldPos(\"D2_DESCZFP\"))<>0\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_DESCZFC > 0\t\r\n\t\t\t\t\t\t\t\tnValCofZF += (cAliasSD2)->D2_DESCZFC\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_DESCZFP > 0\t\r\n\t\t\t\t\t\t\t\tnValPisZF += (cAliasSD2)->D2_DESCZFP\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"SC5\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SC5\")+(cAliasSD2)->D2_PEDIDO)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"SC6\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SC6\")+(cAliasSD2)->D2_PEDIDO+(cAliasSD2)->D2_ITEMPV+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcTpCliente:= Alltrim(SF2->F2_TIPOCLI)\r\n\t\t\t\t\t\t//Para nota sobre cupom deve ser \r\n\t\t\t\t\t\t//impresso os valores da lei da transparência.\t\t\t\t\t\r\n\t\t\t\t\t\tif lNfCup\r\n\t\t\t\t\t\t\tcTpCliente := \"F\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !AllTrim(SC5->C5_MENNOTA) $ cMensCli\r\n\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t***********************\r\n\t\t\t\t\t\t\t* BRUNO LAGE\r\n\t\t\t\t\t\t\t***********************\r\n\t\t\t\t\t\t\t*\r\n\t\t\t\t\t\t\t*    \r\n\r\n\t\t\t\t\t\t\tcMensCli += AllTrim(SC5->C5_MENNOTA) + AllTrim(SC5->C5_MSG2)\r\n\r\n\t\t\t\t\t\t\t//MENSAGEM 2 PARA NF <TLM>\r\n\t\t\t\t\t\t\tIf !AllTrim(SC5->C5_MSG2) $ cMensCli\r\n\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t//cMensCli += \" \"\r\n\t\t\t\t\t\t\t\t\tcMensCli += AllTrim(SC5->C5_MSG2)\r\n\t\t\t\t\t\t\t\tEndIf                 \r\n\t\t\t\t\t\t\t\t//cMensCli += AllTrim(SC5->C5_MSG2) \r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t*\r\n\t\t\t\t\t\t\t*********** \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//-- Tratamento para a integração entre WMS Logix X ERP Protheus \r\n\t\t\t\t\t\t\tIf SC5->( FieldPos(\"C5_ORIGEM\") ) > 0 .And. 'LOGIX' $ Upper(SC5->C5_ORIGEM) \r\n\t\t\t\t\t\t\t\tLgxMsgNfs()\r\n\t\t\t\t\t\t\tEndIf     \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF len(aCMPUSR) > 0  \r\n\t\t\t\t\t\t\t\tcFieldMsg := aCMPUSR[1]  \r\n\t\t\t\t\t\t\tEndIf    \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//BRUNO (VALIDAR POIS O CAMPO C5_MENNOTA É MEMO NA QUALITA)                       \r\n\t\t\t\t\t\t\tIf !Empty(cFieldMsg) .and. SC5->(FieldPos(cFieldMsg)) > 0 .and. !Empty(&(\"SC5->\"+cFieldMsg))\r\n\t\t\t\t\t\t\t\tcMensCli := alltrim(&(\"SC5->\"+cFieldMsg))\r\n\t\t\t\t\t\t\tElseIf !(IIF( SF2->(FieldPos(\"F2_MENNOTA\")) > 0, AllTrim(SF2->F2_MENNOTA),AllTrim(SC5->C5_MENNOTA)) $ cMensCli)\r\n\t\t\t\t\t\t\t\tcMensCli += IIF( SF2->(FieldPos(\"F2_MENNOTA\")) > 0, AllTrim(SF2->F2_MENNOTA),AllTrim(SC5->C5_MENNOTA))\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf !Empty(SC5->C5_MENPAD) \r\n\t\t\t\t\t\t\tcRetForm := FORMULA(SC5->C5_MENPAD)\r\n\t\t\t\t\t\t\tif cRetForm <> nil .and. !AllTrim(cRetForm) $ cMensFis\r\n\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensFis += AllTrim(cRetForm)\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf !Empty( cNumNfCup )\r\n\t\t\t\t\t\t\t//Tratamento para nota sobre Cupom \r\n\t\t\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\t\t\tIf Len(aItemCupRef) > 0\r\n\t\t\t\t\t\t\t\tcMsgCup := \" CF/SERIE: \" + AllTrim((cAliasSD2)->D2_DOC) + \" \" + Alltrim((cAliasSD2)->D2_SERIE) +\" ECF:\" + Alltrim((cAliasSD2)->D2_PDV)\r\n\t\t\t\t\t\t\t\tif !upper(Alltrim(cMsgCup)) $ upper(Alltrim(cMensCli))\r\n\t\t\t\t\t\t\t\t\tif \"CF/SERIE:\" $ upper(Alltrim(cMensCli))\r\n\t\t\t\t\t\t\t\t\t\tcMensCli +=\" / \"\r\n\t\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\t\tcMensCli +=\" CF/SERIE: \" + AllTrim((cAliasSD2)->D2_DOC) + \" \" + Alltrim((cAliasSD2)->D2_SERIE) +\" ECF:\" + Alltrim((cAliasSD2)->D2_PDV)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t    DbSetOrder(1)\r\n\t\t\t\t\t\t\t    If SFT->(DbSeek((xFilial(\"SD2\")+\"S\"+ cSerNfCup + cNumNfCup )))\r\n\t\t\t\t\t\t\t\t\tIF  AllTrim(SFT->FT_OBSERV) <> \" \" .AND.(cAliasSD2)->D2_ORIGLAN==\"LO\"\r\n\t\t\t\t\t\t\t\t\t\tIF !Alltrim(SFT->FT_OBSERV) $ Alltrim(cMensCli) \r\n\t\t\t\t\t\t\t\t\t\t\tif upper( \"F - simples faturamento\" ) $  upper( Alltrim(SFT->FT_OBSERV) )\r\n\t\t\t\t\t\t\t\t\t\t\t\tcMensCli +=\" CF/SERIE: \" + AllTrim((cAliasSD2)->D2_DOC) + \" \" + Alltrim((cAliasSD2)->D2_SERIE) +\" ECF:\" + Alltrim((cAliasSD2)->D2_PDV)\r\n\t\t\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\t\t\tIf \"DEVOLUCAO N.F.\" $ Upper(SFT->FT_OBSERV) \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcMensCli +=\" \" + StrTran(AllTrim(SFT->FT_OBSERV),\"N.F.\",\"C.F.\")\r\n\t\t\t\t\t\t\t\t\t\t\t\tElseIf !lNfCupNFCE .and. !lNfCupSAT\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcMensCli +=\" \" + AllTrim(SFT->FT_OBSERV)\r\n\t\t\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\tendif\t\t\r\n\t\t\t\t\t\t\t\t\t\tEndIf       \r\n\t\t\t\t\t           \t\tEndIf\r\n\t\t\t\t\t        \tEndIF\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tRestArea(aAreaSF2)\t        \t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tif !lIcmDevol .And. !(\"Nota fiscal emitida sem destaque do ICMS\" $ cMensCli)\r\n\t\t\t\t\t\t\tif Len( cMensCli ) > 0\r\n\t\t\t\t\t\t\t\tcMensCli += ' '\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\tif SM0->M0_ESTENT == \"PR\"\r\n\t\t\t\t\t\t\t\tcMensCli += \" Nota fiscal emitida sem destaque do ICMS conforme artigo 9. do Anexo IX do RICMS-PR/2017.\"\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tcMensCli += \" Nota fiscal emitida sem destaque do ICMS.\"\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tendif \t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Obtem os dados do veiculo informado no pedido de venda\r\n\t\t\t\t\t\tIf Empty(aVeiculo)\r\n\t\t\t\t\t\t\tDbSelectArea(\"DA3\")\r\n\t\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\tIf DbSeek(xFilial(\"DA3\")+Iif(SC5->(FieldPos(\"C5_VEICULO\")) > 0 ,SC5->C5_VEICULO,\"\"))\r\n\t\t\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_PLACA)\r\n\t\t\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\t\t\taadd(aVeiculo,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,iif(!Empty(cAnttRntrc),cAnttRntrc,\"\")))//RNTC\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//O campo F4_FORINFC é um substituto do F4_FORMULA, e através do parâmetro MV_NFEMSF4 se determina se o conteúdo da formula devera compor a mensagem do cliente (=\"C\") ou do fisco (=\"F\"). \t\t\t\t\r\n\t\t\t\t\t\tIf SF4->(ColumnPos(\"F4_FORINFC\") ) > 0  .And. !Empty(SF4->F4_FORINFC) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORINFC)\r\n\t\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4==\"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4==\"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tElseIf !Empty(SF4->F4_FORMULA) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORMULA)\r\n\t\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4==\"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4==\"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tIf lSb1CT\r\n\t\t\t\t\t\t\tIf lMvImpFecp  .And. SB1->B1_X_CT$cMVAEHC\r\n\t\t\t\t\t\t\t\tIf (lValFecp .Or. lVfecpst) \r\n\t\t\t\t\t\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t\t    DbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tIf SFT->(DbSeek((xFilial(\"SFT\") + cChaveD2 )))\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tIf SFT->FT_VFECPST > 0\r\n\t\t\t\t\t\t\t\t   \t\t\tcMensFis += \" Cod.Prod: \" + Alltrim((cAliasSD2)->D2_COD) + IIF(SB1->B1_X_CT$cMVAEHC,\" AEHC \",\"\") + \" BC R$: \" + Alltrim(Transform(SFT->FT_BASERET,\"@E 999,999,999.99\"))  + \" o adicional de \" + Alltrim(Str(SFT->FT_ALQFECP, 14, 2))+\"%\" + \" valor FECP R$ \" + Alltrim(Transform(SFT->FT_VFECPST,\"@E 999,999,999.99\")) \r\n\t\t\t\t\t\t\t\t\t    Endif\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\tEndif \r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tIf lMvImpFecp \r\n\t\t\t\t\t\t   If (lValFecp .Or. lVfecpst) \r\n\t\t\t\t\t\t   \t\tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\t\tIf SFT->(DbSeek((xFilial(\"SFT\") + cChaveD2 )))\t\r\n\t\t\t\t\t\t\t\t\t\tnValTFecp += SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\r\n\t\t\t\t\t\t\t\t\t\tnValIFecp := SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t   \r\n\t\t\t\t\t\t   Endif\t\t\t\t\t\r\n\t\t\t\t\t\tEndif\t\r\n\t\t\t\t\t\t//Verifica se existe Template DCL\r\n\t      \t\t\t\tIF (ExistTemplate(\"PROCMSG\"))\r\n\t      \t\t\t\t\taMens := ExecTemplate(\"PROCMSG\",.f.,.f.,{cAliasSD2})      \t\t\t\t\t\t\t\t\t\t \t\t      \t\t\t\t\t\r\n\t\t\t\t\t\t\t\tFor nA:=1 to len(aMens)\r\n\t\t\t\t\t\t\t\t    If aMens[nA][1] == \"V\" .Or. (aMens[nA][1] == \"T\" .And. Ascan(aMensAux,aMens[nA][2])==0)\r\n\t\t\t\t\t\t\t\t\t\tAADD(aMensAux,aMens[nA][2])\r\n\t\t\t\t\t\t\t\t\tEndif\t\r\n\t\t\t\t\t\t\t\tNext    \t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\tIf len(aMens) > 0\r\n\t\t\t\t\t\t\t\t\taAreaSD2  \t:= SD2->(GetArea())\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(3)\r\n\r\n\t\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SD2\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD )\r\n\t\t\t\t\t\t\t\t\t\tnBRICMSO \t:= SD2->D2_BRICMSO\r\n\t\t\t\t\t\t\t\t\t\tnICMRETO\t:= SD2->D2_ICMRETO\r\n\t\t\t\t\t\t\t\t\t\tnBRICMSD \t:= SD2->D2_BRICMSD\r\n\t\t\t\t\t\t\t\t\t\tnICMRETD\t:= SD2->D2_ICMRETD \r\n\t\t\t\t\t\t\t\t\t\tnAliqST\t\t:= SD2->D2_ALIQSOL\r\n\t\t\t\t\t\t\t\t\tEndif  \r\n\r\n\t\t\t\t\t\t\t\t\tRestArea(aAreaSD2) \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t     \t\t\t\tEndif \r\n\t     \t\t\t\t\r\n\t\t\t\t \t\tIf SF2->F2_TPFRETE == \"C\"\r\n\t\t\t\t\t\t\tcModFrete := \"0\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"F\"\r\n\t\t\t\t\t\t \tcModFrete := \"1\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"T\"\r\n\t\t\t\t\t\t \tcModFrete := \"2\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"R\"\r\n\t\t\t\t\t \t\tcModFrete := \"3\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"D\"\r\n\t\t\t\t\t \t\tcModFrete := \"4\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"S\"\r\n\t\t\t\t\t\t \tcModFrete := \"9\"\r\n\t\t\t\t\t \tElseIf Empty(cModFrete)\r\n\t\t\t\t\t \t\tIf SC5->C5_TPFRETE==\"C\"\r\n\t\t\t\t\t\t\t\tcModFrete := \"0\"\r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"F\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"1\"\r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"T\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"2\"\r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"S\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"9\" \r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"R\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"3\" \r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"D\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"4\" \r\n\t\t\t\t\t\t \tElse\r\n\t\t\t\t\t\t \t\tcModFrete := \"1\" \t\t\t \t \t\r\n\t\t\t\t\t\t\tEndIf   \t\t\t \r\n\t\t\t\t\t\tEndIf               \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf Empty(aPedido)\r\n\t\t\t\t\t\t\taPedido := {Iif(SC5->(FieldPos(\"C5_NTEMPEN\")) > 0,Alltrim(SC5->C5_NTEMPEN),\"\"),AllTrim(SC6->C6_PEDCLI),\"\"}\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Indicador de presença do comprador no estabelecimento comercial no momento da operação - VERSÃO 3.10\r\n\t\t\t\t\t\tIf SC5->(FieldPos(\"C5_INDPRES\")) > 0\r\n\t\t\t\t\t\t\t If lNfCup .Or. (cAliasSD2)->D2_ORIGLAN $ \"VD|LO\"\r\n\t\t\t\t\t\t\t \tcIndPres := \"1\" //1=Operação presencial\r\n\t\t\t\t\t\t\t Else\r\n\t\t\t\t\t\t\t \tcIndPres:= Alltrim(SC5->C5_INDPRES)\r\n\t\t\t\t\t\t\t EndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Verifica se municipio de prestação foi informado no pedido\r\n\t\t\t\t\t\tIf SC5->(FieldPos(\"C5_MUNPRES\")) > 0 .And. !Empty(SC5->C5_MUNPRES)\r\n\t\t\t\t\t\t\tif len(AllTrim(SC5->C5_MUNPRES)) == 7 \r\n\t\t\t\t\t\t\t\tcMunPres  := SC5->C5_MUNPRES\r\n\t\t\t\t\t\t\t\tcMunTransp := cMunPres\r\n\t\t\t\t\t\t\telseif SC5->(FieldPos(\"C5_ESTPRES\")) > 0 .and. !Empty(SC5->C5_ESTPRES)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tcMunPres  := ConvType(aUF[aScan(aUF,{|x| x[1] == SC5->C5_ESTPRES})][02]+SC5->C5_MUNPRES)\r\n\t\t\t\t\t\t\t\tcMunTransp := cMunPres\r\n\t\t\t\t\t\t\tendif  \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcMunPres := ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[09]})][02]+aDest[07])\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t// Tags xPed e nItemPed (controle de B2B) para nota de saída\r\n\t\t\t\t\t\tIf SC6->(FieldPos(\"C6_NUMPCOM\")) > 0 .And. SC6->(FieldPos(\"C6_ITEMPC\")) > 0\r\n\t\t\t\t\t\t\tIf !Empty(SC6->C6_NUMPCOM) .And. !Empty(SC6->C6_ITEMPC) \r\n\t\t\t\t\t\t\t\taadd(aPedCom,{SC6->C6_NUMPCOM,SC6->C6_ITEMPC})\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aPedCom,{})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aPedCom,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Conforme Decreto RICM, N 43.080/2002 valido somente em MG deduzir o\r\n\t\t\t\t\t\t//imposto dispensado na operação\r\n\t\t\t\t\t\tnDescRed := 0\r\n\t\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t//FT_FILIAL+FT_TIPOMOV+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM+FT_PRODUTO\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SFT\") + cChaveD2 + \"  \" + (cAliasSD2)->D2_COD)  \r\n\t\t\t\t\t\tIf SFT->(FieldPos(\"FT_DS43080\")) <> 0 .And. SFT->FT_DS43080 > 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\t\t\tnDescRed := SFT->FT_DS43080 \r\n\t\t\t\t\t\t\tnDesTotal+= nDescRed\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SFT->(ColumnPos(\"FT_DESCFIS\")) <> 0 .And. SFT->FT_DESCFIS > 0\r\n\t\t\t\t\t\t\tnDescFis := SFT->FT_DESCFIS\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf (SFT->(ColumnPos(\"FT_CRDPRES\")) <> 0 .And. SFT->FT_CRDPRES > 0) .and. ( SF4->F4_AGREGCP $\"1|S\")\r\n\t\t\t\t\t\t\tnCrdPres := SFT->FT_CRDPRES\r\n\t\t\t\t\t\t\tnTotCrdP += nCrdPres\r\n\t\t\t\t\t\tEndIf \r\n\r\n\t\t\t\t\t\t//Alteração realizada no campo F4_ICMSDIF, foi incluido a opção: 6 – Diferido(Deduz NF e Duplicata)\r\n\t\t\t\t\t\t//no combo para deduzir os valores de ICMS diferido na NF e da Duplicata\r\n\t\t\t\t\t\t//http://tdn.totvs.com/display/public/PROT/2892815+DSERFIS1-6266+DT+Diferimento+ICMS\r\n\t\t\t\t\t\tnDescNfDup :=0\r\n\t\t\t\t\t\tIf\tSF4->F4_ICMSDIF == \"6\"\r\n\t\t\t\t\t\t\tnDescNFDup := IIF(SF1->(F1_STATUS) == 'C', (cAliasSD1)->(D1_ICMSDIF),SFT->FT_ICMSDIF)\r\n\t\t\t\t\t\tEndIF \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Incluido o tratamento pelo fato do SIGALOJA e o VENDA DIRETA nao gravar\r\n\t\t\t\t\t\t//o campo D2_DESCON, quando e' dado desconto no total da venda.\r\n\t\t\t\t\t\tIf lNfCup .Or. (cAliasSD2)->D2_ORIGLAN $ \"VD|LO\"\r\n\r\n\t\t\t\t\t\t\tlVLojaDir := .T.\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnDesconto := 0\r\n\t\t\t\t\t\t\t//Caso possua desconto vai fazer essa logica abaixo para se adequar a mesma logica do faturamento , \r\n\t\t\t\t\t\t\t//Pq ao contrario do faturamento o LOJA nao grava o D2_DESCON quando o desconto eh no total \r\n\t\t\t\t\t\t\tIf SF2->F2_DESCONT > 0\r\n\t\t\t\t\t\t\t\tIf lFirstItem\t// Somente faz o looping nos itens na primeira vez\r\n\t\t\t\t\t\t\t\t\tnTDescIt := 0\r\n\r\n\t\t\t\t\t\t\t\t\t//Posicionando diretamente na SD2, para poder utilizar o Get/RestArea e atender TOP e DBF.\r\n\t\t\t\t\t\t\t\t\taAreaSD2  \t:= SD2->(GetArea())\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tWhile !SD2->(Eof()) .And. xFilial(\"SD2\") == SD2->D2_FILIAL .And.;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  SF2->F2_SERIE  == SD2->D2_SERIE  .And.;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  SF2->F2_DOC    == SD2->D2_DOC\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tnTDescIt += SD2->D2_DESCON \t// Soma de todos os descontos nos itens\r\n\t\t\t\t\t\t\t\t\t\tSD2->(DbSkip())\r\n\t\t\t\t\t\t\t\t\tEnd\r\n\t\t\t\t\t\t\t\t\tlFirstItem := .F.\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tRestArea(aAreaSD2)\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t/*Retirado tratamento pois não funciona para DBF\r\n\t\t\t\t\t\t\t\t\tnX := 1\r\n\t\t\t\t\t\t\t\t\t// Como nao temos RestArea para alias temp , da um gotop e depois certifica que esta no recno correto\r\n\t\t\t\t\t\t\t\t\tWhile nCount <> (cAliasSD2)->(Recno()) .AND. nX < 50 // Protecao para nao ficar loop infinito\r\n\t\t\t\t\t\t\t\t\t\t(cAliasSD2)->(DbSkip())\r\n\t\t\t\t\t\t\t\t\t\tnX++\r\n\t\t\t\t\t\t\t\t\tEnd\r\n\t\t\t\t\t\t\t\t\t */\r\n\t\t\t\t\t\t\t\t\t// Se o valor do desconto for igual significa que soemente teve desconto no item \r\n\t\t\t\t\t\t\t\t\t// Nesse caso pode seguir a mesma regra do faturamente e pegar direto do D2_DESCON\t\r\n\t\t\t\t\t\t\t\t\tIf nTDescIt = SF2->F2_DESCONT\r\n\t\t\t\t\t\t\t\t\t\tlLjDescIt\t:= .T.\t\t\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf lLjDescIt\t// Se so teve desconto no item pega direto do D2_DESCON\r\n\t\t\t\t\t\t\t\t\tnDesconto := (cAliasSD2)->D2_DESCON\r\n\t\t\t\t\t\t\t\tElse\t\t\t// Faz o rateio do desconto no total + o desconto no item\r\n\t\t\t\t\t\t\t\t\tnDesconto := ((((cAliasSD2)->D2_QUANT*(cAliasSD2)->D2_PRUNIT)/SF2->F2_VALMERC) * (SF2->F2_DESCONT- nTDescIt))+(cAliasSD2)->D2_DESCON \r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t            Else \r\n\t\t\t\t\t\t\tnDesconto := (cAliasSD2)->D2_DESCON            \t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf  (cAliasSD2)->D2_VRDICMS > 0  .and. nDesconto >= (cAliasSD2)->D2_VRDICMS \r\n\t\t\t\t\t\t\t\tnDesVrIcms := (cAliasSD2)->D2_VRDICMS\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf\tSD2->(FieldPos(\"D2_DESCICM\"))<>0\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tnDescIcm := ( IIF(SF4->F4_AGREG == \"D\",(cAliasSD2)->D2_DESCICM,0) )\r\n\t\r\n\t\t\t\t\t\t\t\tIf cVerAmb >= \"3.10\" .and. SF4->F4_AGREG == \"D\" .and.  (!Empty(SF4->F4_MOTICMS) .and. (AllTrim(SF4->F4_MOTICMS) $ \"3-8-9\" .or.  AllTrim(SF4->F4_MOTICMS) =='90')) .and. Empty(SF4->F4_CSOSN)\r\n\t\t\t\t\t\t\t\t\tnDescIcm:=0\r\n\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t            EndIf\r\n\t\t\t            \r\n\t\t\t\t\t\t//Tratamento para verificar se o produto e controlado por terceiros (IDENTB6)\r\n\t\t\t\t\t\t//e a partir do tipo do pedido (Cliente ou Fornecedor) verifica  se existe\r\n\t\t\t\t\t\t//amarracao entre Produto X Cliente(SA7) ou Produto X Fornecedor(SA5)\r\n\t\t\t\t\t\t//Caso haja a amarraca, o codigo e descricao do produto, assumem o conteudo da SA7 ou SA5\r\n\t\t\r\n\t\t\t\t\t\tcCodProd  := (cAliasSD2)->D2_COD\t            \r\n\t\t\t\t\t\tcDescProd := IIF(Empty(SC6->C6_DESCRI),SB1->B1_DESC,SC6->C6_DESCRI) \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t********************************************************************\r\n\t\t\t\t\t\t* BRUNO LAGE FERREIRA\r\n\t\t\t\t\t\t********************************************************************\r\n\t\t\t\t\t\t*  \r\n\t\t\t\t\t\t*\r\n\t\t\t\t\t\tIF(Alltrim((cAliasSD2)->D2_LOTECTL) == '')\r\n\t\t\t\t\t\t\tcDescProd := IIf(Empty(SC6->C6_LTREM) , cDescProd , Alltrim(cDescProd) + \" - NUM. \" + Alltrim(SC6->C6_LTREM))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcDescProd := IIf(Empty((cAliasSD2)->D2_LOTECTL) , cDescProd , Alltrim(cDescProd) + \" - NUM. \" + Alltrim((cAliasSD2)->D2_LOTECTL))\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t//Acrescentar comprimento, altura e largura bruta para Remessa p/ industrialização por conta ord.\r\n\t\t\t\t\t\tIf ( !Empty(SC6->C6_COMPBRU) .AND. !Empty(SC6->C6_ALTBRU ) .AND. !Empty(SC6->C6_LARGBRU) .AND. SC6->C6_TES == \"526\" )\r\n\r\n\t\t\t\t\t\t\tcDescProd += \" Bru.- \" + ALLTRIM(cValToChar(SC6->C6_COMPBRU)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_ALTBRU)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_LARGBRU)) + \" Liq.- \"\r\n\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf ( !Empty(SC6->C6_COMPLIQ) .AND. !Empty(SC6->C6_ALTLIQ) .AND. !Empty(SC6->C6_LARGLIQ) )\r\n\r\n\t\t\t\t\t\t\tcDescProd += \" \" + ALLTRIM(cValToChar(SC6->C6_COMPLIQ)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_ALTLIQ)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_LARGLIQ))\r\n\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t*\r\n\t\t\t\t\t\t*\r\n\t\t\t\t\t\t*******************************************************************\r\n\t\t\t\t\t\t \r\n\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_IDENTB6) .And. lNFPTER  \r\n\t\t\t\t         \tIf SC5->C5_TIPO == \"N\" \r\n\t\t\t\t\t\t         //--A7_FILIAL + A7_CLIENTE + A7_LOJA + A7_PRODUTO\r\n\t\t\t\t\t\t         SA7->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\t         If SA7->(MsSeek( xFilial(\"SA7\") + (cAliasSD2)->(D2_CLIENTE+D2_LOJA+D2_COD) )) .and. !empty(SA7->A7_CODCLI) .and. !empty(SA7->A7_DESCCLI) \r\n\t\t\t\t\t\t         \tcCodProd  := SA7->A7_CODCLI \r\n\t\t\t\t\t\t            cDescProd := SA7->A7_DESCCLI\t            \t\t\t\t\t\t\r\n\t\t\t\t\t\t         EndIf \r\n\t\t\t\t\t\t\tElseIf SC5->C5_TIPO == \"B\"\r\n\t\t\t\t\t\t      \t//--A5_FILIAL + A5_FORNECE + A5_LOJA + A5_PRODUTO\r\n\t\t\t\t\t\t         SA5->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\t         If SA5->(MsSeek( xFilial(\"SA5\") + (cAliasSD2)->(D2_CLIENTE+D2_LOJA+D2_COD) )) .and. !empty(SA5->A5_CODPRF) .and. !empty(SA5->A5_DESREF)\r\n\t\t\t\t\t\t         \tcCodProd  := SA5->A5_CODPRF \r\n\t\t\t\t\t\t            cDescProd := SA5->A5_DESREF \t            \r\n\t\t\t\t\t\t         EndIf \t\r\n\t\t\t\t\t      \tEndIf  \r\n\t\t\t         \tEndIf \r\n\t\t\t         \r\n\t\t\t            nDescZF := (cAliasSD2)->D2_DESCZFR \r\n\t\t\t            \r\n\t\t\t            // Faz o destaque do IPI nos dados complementares caso seja uma venda por consignação mercantil e possuir IPI\r\n\t\t\t\t\t\tIf (lConsig .Or. Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .And. (cAliasSD2)->D2_VALIPI > 0\r\n\t\t\t\t\t\t\tnIPIConsig += (cAliasSD2)->D2_VALIPI\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Faz o destaque do ICMS ST nos dados complementares caso seja uma venda por consignação mercantil e possuir ICMS ST\r\n\t\t\t\t\t\tIf Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM .And. (cAliasSD2)->D2_ICMSRET > 0 .And. lConsig    \r\n\t\t\t\t\t\t\tnSTConsig += (cAliasSD2)->D2_ICMSRET \r\n\t\t\t\t\t\tEndIf  \t\r\n\t\t\t            \r\n\t\t\t            //Tratamento para que o valor de ICMS ST venha a compor o valor da tag vOutros quando for uma nota de Devolução, impedindo que seja gerada a rejeição 610.\r\n\t\t\t            nIcmsST := 0\r\n\t\t\t            If (!lIcmSTDev .And. (cAliasSD2)->D2_TIPO == \"D\" .And. SubStr((cAliasSD2)->D2_CLASFIS,2,2) $ '00#10#30#70#90') .Or. (lConsig .And. Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .Or. (!lIcmSTDev .And. lComplDev .And. (cAliasSD2)->D2_TIPO == \"I\" )\r\n\t\t\t            \tnIcmsST := (cAliasSD2)->D2_ICMSRET\r\n\t\t\t            EndIf   \r\n\t\t\t            cOrigem:= IIF(!Empty((cAliasSD2)->D2_CLASFIS),SubStr((cAliasSD2)->D2_CLASFIS,1,1),'0')\r\n\t\t\t            cCSTrib:= IIF(!Empty((cAliasSD2)->D2_CLASFIS),SubStr((cAliasSD2)->D2_CLASFIS,2,2),'50')\r\n\t\t\t            \r\n\t\t\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//\t\t\tFCI - Ficha de Conteúdo de Importação\r\n\t\t\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//**Operação INTERNA:\r\n\t\t\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da importação      (Industrialização)\r\n\t\t\t\t\t\t//\r\n\t\t\t\t\t\t//**Operação INTERESTADUAL:\r\n\t\t\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da parcela importada do exterior, o número da FCI e o Conteúdo de\r\n\t\t\t\t\t\t//   Importação expresso percentualmente (Industrialização)\r\n\t\t\t\t\t\t//----------------------------------------------------------------------------------------- \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf (cOrigem $\"1-2-3-4-5-6-8\" .And. cCSTrib $ \"00-10-20-30-40-41-50-51-60-70-90\")\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->(FieldPos(\"D2_FCICOD\")) > 0 .And. !Empty((cAliasSD2)->D2_FCICOD)\r\n\t\t\t\t\t\t\t\taadd(aFCI,{(cAliasSD2)->D2_FCICOD}) \r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf lFCI\r\n\t\t\t\t\t\t\t\t\tcMsgFci\t:= \"Resolucao do Senado Federal nº 13/12\"\r\n\t\t\t\t\t\t\t\t\tcInfAdic  += cMsgFci + \", Numero da FCI \" + Alltrim((cAliasSD2)->D2_FCICOD) + \".\"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t// Retirada a validação devido a criação da tag nFCI (NT 2013/006)\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//Campo SD2->D2_FCICOD só é preenchido nos casos de Industrialização Interestadual\r\n\t\t\t\t\t\t//Executar UPDSIGAFIS para criação do campo na D2 e tabela CFD.\r\n\t\t\t\t\t\t//Obs.: O campo D2_FCICOD é alimentado com o conteúdo do campo CFD_FCICOD após\r\n\t\t\t\t\t\t//faturar os Documentos de Saída (MATA461).\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//If AliasIndic(\"CFD\")\r\n\t\t\t\t\t\t\t//CFD->(DbSetOrder(3))   //Tabela de Ficha de Conteudo de Importação\r\n\t\t\t\t\t\t\t//If CFD->(DbSeek(xFilial(\"CFD\")+(cAliasSD2)->D2_FCICOD))\r\n\t\t\t\t\t\t\t\t//-----------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\t//Obs.: Retirado o valor da parcela importada devido ao Convênio 38/2013  CH: THHDRV\r\n\t\t\t\t\t\t\t\t//nValParImp\t:= IIf(CFD->(FieldPos(\"CFD_VPARIM\")) > 0,CFD->CFD_VPARIM, 0)         \r\n\t\t\t\t\t\t\t\t//-----------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\t//nContImp\t:= IIf(CFD->(FieldPos(\"CFD_CONIMP\")) > 0,CFD->CFD_CONIMP, 0)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//cInfAdic  += cMsgFci + \", Valor da Parcela Importada R$ \"+ ConvType(nValParImp, 11,2)+ \", Conteudo de Importacao \" + ConvType(nContImp, 11,2) + \"% , Numero da FCI \" + Alltrim((cAliasSD2)->D2_FCICOD)\r\n\t\t\t\t\t\t\t\t//cInfAdic  += cMsgFci + \", Conteudo de Importacao \" + ConvType(nContImp, 11,2) + \"% , Numero da FCI \" + Alltrim((cAliasSD2)->D2_FCICOD)\r\n\t\t\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//Preencher o campo C6_VLIMPOR com o valor da Importação para popular o D2_VLIMPOR\r\n\t\t\t\t\t\t//Obs.: Somente preencher nos casos em que não utilize RASTRO, caso utilize será\r\n\t\t\t\t\t\t//      populado automaticamente.\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\t\r\n\t\t\t\t\t\t//ElseIf (cAliasSD2)->(FieldPos(\"D2_VLIMPOR\")) > 0 .And. !Empty((cAliasSD2)->D2_VLIMPOR)\r\n\t\t\t\t\t\t\t//cInfAdic  += cMsgFci + \", Valor da Importacao R$ \" + ConvType((cAliasSD2)->D2_VLIMPOR, 11,2)\r\n\t\t\t\t\t\t//EndIf\r\n\t\r\n\t\t\t\t\t\t//Adequação NT2013/003 - Verifica se o valor será composto da tabela SBZ ou SB1\r\n\t\t\t\t\t\tnAliqNcm := 0\r\n\t\t\t\t\t\tIf lCpoAlqSBZ .And. lCpoAlqSB1   \r\n\t\t\t\t\t\t\tnAliqNcm := RetFldProd(cCodProd,\"B1_IMPNCM\",\"SB1\")\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !empty(nAliqNcm) .and. nAliqNcm == 0 .And. lCpoAlqSB1   \t \r\n\t\t\t\t\t\t\tnAliqNcm:=  SB1->B1_IMPNCM\r\n\t\t\t\t\t\tEndIf\t\r\n\t\t\t            \t\t            \r\n\t\t\t            If lCpoMsgLT .And. lCpoLoteFor .And. SF4->F4_MSGLT $ \"1\" \r\n\t\t\t\t\t\t\tcNumLotForn := Alltrim(Posicione(\"SB8\",2,xFilial(\"SB8\")+(cAliasSD2)->D2_NUMLOTE+(cAliasSD2)->D2_LOTECTL+cCodProd,\"B8_LOTEFOR\"))\r\n\t\t\t\t\t\t\tif !Empty(cNumLotForn)\r\n\t\t\t\t\t\t\t\tcInfAdic := \"LOTE:\"+cNumLotForn+\" \"+cInfAdic\r\n\t\t\t\t\t\t\tEndIf\t\t\t            \t            \t\t             \r\n\t\t\t            endif  \r\n\t\t\t            \r\n\t\t\t            //Verifica fonte carga tributária\r\n\t\t\t            \t            \r\n\t\t\t            If cMvMsgTrib $ \"1-3\"\r\n\t\t\t            \tIf lIntegHtl //Integracao Hotelaria\r\n                                cFntCtrb := SF2->F2_LTRAN \r\n                            Else\r\n\t\t\t\t            \tIf cMvFisCTrb ==\"1\"\r\n\t\t\t\t\t            \tIf FindFunction(\"AlqLeiTran\")\t\t            \t\t\r\n\t\t\t\t\t            \t\tcFntCtrb := AlqLeiTran(\"SB1\",\"SBZ\" )[2]\t\t\t            \t\t\r\n\t\t\t\t\t            \tEndIf\r\n\t\t\t\t\t            \tIf Empty(cFntCtrb) .And. !Empty(cMvFntCtrb).And. !cFntCtrb $ \"IBPT\"\r\n\t\t\t\t\t\t             \tcFntCtrb := cMvFntCtrb\r\n\t\t\t\t\t\t            EndIf \r\n\t\t\t\t            \tElse\r\n\t\t\t\t            \t\tIf Empty(cFntCtrb) .And. !Empty(cMvFntCtrb)\r\n\t\t\t\t\t\t             \tcFntCtrb := cMvFntCtrb\r\n\t\t\t\t\t\t            EndIf \r\n\t\t\t\t            \tEndIf\r\n\t\t\t\t            EndIf\r\n\t\t\t            EndIf\r\n\t\t\t            \r\n\t\t\t            \r\n\t\t\t          \t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³  ³Código de Benefício Fiscal na UF aplicado ao item\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \r\n\t\t\t\t\t\tIf lNfCupNFCE\r\n\t\t\t\t\t\t\tcTpEspcBen := 'NFCE'\r\n\t\t\t\t\t\tElseIf lNfCupSAT\r\n\t\t\t\t\t\t\tcTpEspcBen := 'SATCE'\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcTpEspcBen := 'SPED'\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tlCodLan := .F.\r\n\t\t\t\t\t\tIf SM0->M0_ESTENT $ \"PR/RJ/RS/\" //TAG cBenef buscar o conteúdo da tabela 5.2 no sistema quando for do PR.\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDV\")\r\n\t\t\t\t\t\t\tdbSetOrder(4) //CDV_FILIAL+CDV_TPMOVI+CDV_ESPECI+CDV_FORMUL+CDV_DOC+CDV_SERIE+CDV_CLIFOR+CDV_LOJA+CDV_NUMITE+CDV_SEQ+CDV_CODAJU\r\n\t\t\t\t\t\t\tcCodlan := \"\"\r\n\t\t\t\t\t\t\tIf MsSeek(xFilial(\"CDV\") +'S'+PadR(cTpEspcBen,TamSX3(\"CDV_ESPECI\")[1])+'S'+(cAliasSD2)->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_ITEM))\r\n\t\t\t\t\t\t\t\t//Tratamento realizado enquanto o fiscal não realiza a criação do campo na CDV\r\n\t\t\t\t\t\t\t\tif CDV->(ColumnPos(\"CDV_NFE\")) > 0\r\n\t\t\t\t\t\t\t\t\tif CDV->CDV_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"CDY\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf CDV->(ColumnPos(\"CDV_CODAJU\")) > 0 .and. !Empty(CDV->CDV_CODAJU) .and. MsSeek( xFilial(\"CDY\") + CDV->CDV_CODAJU)\r\n\t\t\t\t\t\t\t\t\t\tIf CDY->CDY_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\tendif\t\r\n\r\n\t\t\t\t\t\t\t\tif lCodLan\r\n\t\t\t\t\t\t\t\t\tcCodlan:= CDV->CDV_CODAJU\r\n\t\t\t\t\t\t\t\tendif\t\r\n\t\t\t\t\t\t\telse \r\n\t\t\t\t\t\t\t\tcCodlan := getCodLan( alltrim(SM0->M0_ESTENT), SF4->F4_SITTRIB, cAmbiente )\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcCodlan := \"\"\t\r\n\t\t\t\t\t\t\tIf SM0->M0_ESTENT <> \"SP\" .and. CDA->(ColumnPos(\"CDA_CODLAN\")) > 0\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"CDA\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1) //CDA_FILIAL+CDA_TPMOVI+CDA_ESPECI+CDA_FORMUL+CDA_NUMERO+CDA_SERIE+CDA_CLIFOR+CDA_LOJA+CDA_NUMITE+CDA_SEQ+CDA_CODLAN+CDA_CALPRO\r\n\t\t\t\t\t\t\t\tcSeekCDA := xFilial(\"CDA\") + 'S' + PadR(cTpEspcBen,TamSX3(\"CDA_ESPECI\")[1]) + 'S' + (cAliasSD2)->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_ITEM)\r\n\t\t\t\t\t\t\t\tIf CDA->(MsSeek(cSeekCDA))\r\n\t\t\t\t\t\t\t\t\tWhile alltrim(cSeekCDA) == alltrim(CDA->(CDA_FILIAL + CDA_TPMOVI + CDA_ESPECI + CDA_FORMUL + CDA_NUMERO + CDA_SERIE + CDA_CLIFOR + CDA_LOJA + CDA_NUMITE))\r\n\t\t\t\t\t\t\t\t\t\tIf !Empty(CDA->CDA_CODLAN) .And. Len(AllTrim(CDA->CDA_CODLAN)) == 10\r\n\t\t\t\t\t\t\t\t\t\t\tcCodlan := CDA->CDA_CODLAN\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\tCDA->(dbSkip())\r\n\t\t\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t          \t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³  Indicador de Produção em escala relevante, conforme Cláusula 23 do Convenio ICMS 52/2017\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \t\t\t\t\t\t\r\n\t\t\t\t\t\tIf AliasIndic(\"D3E\")\r\n\t\t\t\t\t\t\tdbSelectArea(\"D3E\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tcIndEscala :=\"\"\r\n\t\t\t\t\t\t\tIf MsSeek(PADR(xFilial(\"D3E\"),TAMSX3(\"D3E_FILIAL\")[1]) +(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\t\tIf D3E->(ColumnPos(\"D3E_INDESC\")) > 0\r\n\t\t\t\t\t\t\t\t\tIf\t!Empty(D3E->D3E_INDESC)  .AND.  D3E->D3E_INDESC == \"1\"\r\n\t\t\t\t\t\t\t\t\t\tcIndEscala:= \"S\"\r\n\t\t\t\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cD2Cfop)\r\n\r\n\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO <> 'D') .Or. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM)\r\n\t\t\t\t\t\t\tlIPIOutro:=.F.\r\n\t\t\t\t\t\tEnd\r\n                        \r\n\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO <> 'B')\r\n\t\t\t\t\t\t\tlIPIOutB :=.F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t   \r\n\t\t\t\t\t\tnValOutr  := 0\r\n\t\t\t\t\t\t//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).E devolução com IPI. (Nota de compl.Ipi de uma devolução de compra(MV_IPIDEV=F) leva o IPI em voutros)\t\r\n\t\t\t\t\t\tIF((cAliasSD2)->D2_TIPO == \"D\" .And. (!lIpiDev .Or. lIPIOutro)) .Or. lConsig .Or. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM ) .or. ((cAliasSD2)->D2_TIPO == \"B\" .and. lIpiBenef) .or. ((cAliasSD2)->D2_TIPO==\"P\" .And. lComplDev .And. !lIpiDev)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO  == \"D\" .and.  lIPIOutro ) .or. ((cAliasSD2)->D2_TIPO  == \"B\" .and. lIPIOutB)\r\n\t\t\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n                            EndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\t\t\tnValOutr += 0\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tnValOutr +=(cAliasSD2)->D2_VALIPI\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\t\r\n\r\n\t\t\t\t\t\tnValOutr += (cAliasSD2)->D2_DESPESA + (cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3 + nIcmsST + nCrdPres\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcTpOrig  := IIF(nCountIT > 0 .And. Len(aNfVinc[nCountIT]) > 9, aNfVinc[nCountIT][10], \"\") //Pegar tipo da nota de origem\r\n\t\t\t\t\t\t\r\n\t\t\t           \t//BRUNO\r\n\t\t\t\t\t\tcF2Tipo\t:= IIF(!Empty(aNota[5]),aNota[5], \"N\")\r\n\t\t\t           \t\t            \t\t\r\n\t\t\t\t\t\taAdd(aInfoItem,{(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV,(cAliasSD2)->D2_TES,(cAliasSD2)->D2_ITEM})\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf aDest[09] == \"DF\"\r\n\t\t\t\t\t\t\tIf Substr(SB1->B1_POSIPI,1,4) $ \"2401|2402|2403|2203\" .Or. Substr(SB1->B1_POSIPI,1,6) $ \"210690|220290\"\r\n\t\t\t\t\t\t\t\tlNCMOk := .T.\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tBruno SigawiSe\r\n\t\t\t\t\t\tse for a itinga a chamada e orignal \r\n\t\t\t\t\t\tse for qualita muda a função U_RETPESOFAT\r\n\t\t\t\t\t\tAlert(SC5->C5_NUM)\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SubString(CNUMEMP,1,2) == \"05\" .OR. !SubString(AllTrim(SB1->B1_COD),1,2) $  'CH/AM' .OR. SC5->C5_YTIPO $ \"MI/TF\"\r\n\t\t\t\t\t\t\r\n\t\t\t\t   \t\t   aadd(aProd,\t{Len(aProd)+1,;\r\n\t\t\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\t\t\tSB1->B1_POSIPI,;//Retirada validação do parametro MV_CAPPROD, de acordo com a NT2014/004 não é mais possível informar o capítulo do NCM\r\n\t\t\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t\t\tcD2Cfop,;\r\n\t\t\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_QUANT,;\r\n\t\t\t\t\t\t\t\tIIF(!((cAliasSD2)->D2_TIPO$\"IP\" .Or. ((cAliasSD2)->D2_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,IIF(!(lMvNFLeiZF),(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR-nDesVrIcms,(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR - ((cAliasSD2)->D2_DESCZFP+(cAliasSD2)->D2_DESCZFC+nDesVrIcms)),IIF(((cAliasSD2)->D2_TIPO==\"I\" .And. SF4->F4_AJUSTE == \"S\" .And. \"RESSARCIMENTO\" $ Upper(cNatOper) .And. \"RESSARCIMENTO\" $ Upper(cDescProd)),(cAliasSD2)->D2_TOTAL,0)),;\r\n\t\t\t\t\t\t\t\tretUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\t\t\tretQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), nConvDip, (cAliasSD2)->D2_QUANT ),;    //retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_CONVDIP, (cAliasSD2)->D2_QUANT ),;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_VALFRE,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_SEGURO,;\r\n\t\t\t\t\t\t\t\t(nDesconto+nDescIcm+nDescRed+nDescNfDup+nDescFis),;\r\n\t\t\t\t\t\t\t\t0,;// O valor unitario sera obtido pela divisao do valor do produto pela quantidade comercial de acordo com o  Manual do Contribuinte 6.00 realizado na tag <vUnCom>(ConvType(aProd[10]/aProd[09],21,8)) \r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_NUMLOTE,;//Numero do Lote\r\n\t\t\t\t\t\t\t   \tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).E devolução com IPI. (Nota de compl.Ipi de uma devolução de compra(MV_IPIDEV=F) leva o IPI em voutros)\r\n\t\t\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\t\t\tIIF((SF4->F4_AGREG='N' .And. !AllTrim(SF4->F4_CF) $ cMVCfopTran) .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\"),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_TES,;\r\n\t\t\t\t\t\t\t\tIIF(SB5->(FieldPos(\"B5_PROTCON\"))<>0,SB5->B5_PROTCON,\"\"),; //Campo criado para informar protocolo ou convenio ICMS \r\n\t\t\t\t\t\t\t\tIIf(SubStr(SM0->M0_CODMUN,1,2) == \"35\" .And. cTpPessoa == \"EP\" .And. nDescIcm > 0, nDescIcm,0),;   \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTIMP\"))<>0,(cAliasSD2)->D2_TOTIMP,0),;   //aProd[30] - Total imposto carga tributária. \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFP,;\t\t\t//aProd[31] - Desconto Zona Franca PIS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFC,;\t\t\t//aProd[32] - Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PICM,;\t\t//aProd[33] - Percentual de ICMS\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;  //aProd[34]\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTFED\"))<>0,(cAliasSD2)->D2_TOTFED,0),;   //aProd[35] - Total carga tributária Federal\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTEST\"))<>0,(cAliasSD2)->D2_TOTEST,0),;   //aProd[36] - Total carga tributária Estadual\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTMUN\"))<>0,(cAliasSD2)->D2_TOTMUN,0),;   //aProd[37] - Total carga tributária Municipal\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PEDIDO,;\t //aProd[38] \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_ITEMPV,;\t //aProd[39] \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_GRPCST\")) > 0 .and. !Empty((cAliasSD2)->D2_GRPCST),(cAliasSD2)->D2_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //aProd[40]\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aProd[41] NT2015/003\r\n\t\t\t\t\t\t\t\t\"\",; //aprod[42] apenas na entrada é utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\t\t\tnValIFecp,; //aprod[43]  Valor do FECP.\r\n\t\t\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),;//aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),;  //aprod[46]\r\n\t\t\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\t\t\tSF4->F4_ART274,;  //aprod[48]\r\n\t\t\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aProd,\t{Len(aProd)+1,;\r\n\t\t\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\t\t\tSB1->B1_POSIPI,;//Retirada validação do parametro MV_CAPPROD, de acordo com a NT2014/004 não é mais possível informar o capítulo do NCM\r\n\t\t\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t\t\tcD2Cfop,;\r\n\t\t\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_QUANT,;\r\n\t\t\t\t\t\t\t\tIIF(!((cAliasSD2)->D2_TIPO$\"IP\" .Or. ((cAliasSD2)->D2_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,IIF(!(lMvNFLeiZF),(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR-nDesVrIcms,(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR - ((cAliasSD2)->D2_DESCZFP+(cAliasSD2)->D2_DESCZFC+nDesVrIcms)),IIF(((cAliasSD2)->D2_TIPO==\"I\" .And. SF4->F4_AJUSTE == \"S\" .And. \"RESSARCIMENTO\" $ Upper(cNatOper) .And. \"RESSARCIMENTO\" $ Upper(cDescProd)),(cAliasSD2)->D2_TOTAL,0)),;\r\n\t\t\t\t\t\t\t\tretUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\t\t\tIIf(cF2Tipo == \"B\",retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_CONVDIP, (cAliasSD2)->D2_QUANT ),U_RETPESOFAT((cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV)  ),; \t\t\t// BRUNO SIGAWISE retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_CONVDIP, (cAliasSD2)->D2_QUANT )\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_VALFRE,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_SEGURO,;\r\n\t\t\t\t\t\t\t\t(nDesconto+nDescIcm+nDescRed+nDescNfDup+nDescFis),;\r\n\t\t\t\t\t\t\t\t0,;// O valor unitario sera obtido pela divisao do valor do produto pela quantidade comercial de acordo com o  Manual do Contribuinte 6.00 realizado na tag <vUnCom>(ConvType(aProd[10]/aProd[09],21,8)) \r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_NUMLOTE,;//Numero do Lote\r\n\t\t\t\t\t\t\t   \tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).E devolução com IPI. (Nota de compl.Ipi de uma devolução de compra(MV_IPIDEV=F) leva o IPI em voutros)\r\n\t\t\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\t\t\tIIF((SF4->F4_AGREG='N' .And. !AllTrim(SF4->F4_CF) $ cMVCfopTran) .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\"),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_TES,;\r\n\t\t\t\t\t\t\t\tIIF(SB5->(FieldPos(\"B5_PROTCON\"))<>0,SB5->B5_PROTCON,\"\"),; //Campo criado para informar protocolo ou convenio ICMS \r\n\t\t\t\t\t\t\t\tIIf(SubStr(SM0->M0_CODMUN,1,2) == \"35\" .And. cTpPessoa == \"EP\" .And. nDescIcm > 0, nDescIcm,0),;   \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTIMP\"))<>0,(cAliasSD2)->D2_TOTIMP,0),;   //aProd[30] - Total imposto carga tributária. \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFP,;\t\t\t//aProd[31] - Desconto Zona Franca PIS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFC,;\t\t\t//aProd[32] - Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PICM,;\t\t//aProd[33] - Percentual de ICMS\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;  //aProd[34]\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTFED\"))<>0,(cAliasSD2)->D2_TOTFED,0),;   //aProd[35] - Total carga tributária Federal\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTEST\"))<>0,(cAliasSD2)->D2_TOTEST,0),;   //aProd[36] - Total carga tributária Estadual\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTMUN\"))<>0,(cAliasSD2)->D2_TOTMUN,0),;   //aProd[37] - Total carga tributária Municipal\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PEDIDO,;\t //aProd[38] \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_ITEMPV,;\t //aProd[39] \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_GRPCST\")) > 0 .and. !Empty((cAliasSD2)->D2_GRPCST),(cAliasSD2)->D2_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //aProd[40]\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aProd[41] NT2015/003\r\n\t\t\t\t\t\t\t\t\"\",; //aprod[42] apenas na entrada é utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\t\t\tnValIFecp,; //aprod[43]  Valor do FECP.\r\n\t\t\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),;//aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),;  //aprod[46]\r\n\t\t\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\t\t\tSF4->F4_ART274,;  //aprod[48]\r\n\t\t\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aCST,{cCSTrib,cOrigem})\r\n\t\t\t\t\t\taadd(aICMS,{})\r\n\t\t\t\t\t\taadd(aIPI,{})\r\n\t\t\t\t\t\taadd(aICMSST,{})\r\n\t\t\t\t\t\taadd(aPIS,{})\r\n\t\t\t\t\t\taadd(aPISST,{})\r\n\t\t\t\t\t\taadd(aCOFINS,{})\r\n\t\t\t\t\t\taadd(aCOFINSST,{})\r\n\t\t\t\t\t\taadd(aISSQN,{})\r\n\t\t\t\t\t\taadd(aAdi,{})\r\n\t\t\t\t\t\taadd(aDi,{})\r\n\t\t\t\t\t\taadd(aICMUFDest,{})\r\n\t\t\t\t\t\taadd(aIPIDevol,{})\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//aadd(aPedCom,{})\r\n\t\t\t\t\t\taadd(aPisAlqZ,{})\r\n\t\t\t\t\t\taadd(aCofAlqZ,{})\r\n\t\t\t\t\t\taadd(aCsosn,{})\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcNCM := SB1->B1_POSIPI\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para TAG Exportação quando existe a integração com a EEC     ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf lEECFAT\r\n\t\t\t\t\t\t\t/*Alterações TQXWO2\r\n\t\t\t\t\t\t\tNa chamada da função, foram criados dois novos parâmetros: \r\n\t\t\t\t\t\t\to 3º referente ao código do produto e o 4º referente ao número da nota fiscal + série (chave).\r\n\t\t\t\t\t\t\tGetNfeExp(pProcesso, pPedido, cProduto, cChave)\r\n\t\t\t\t\t\t\tNo retorno da função serão devolvidas as informações do legado, conforme leiaute anterior à versão 3.10 , \r\n\t\t\t\t\t\t\te as informações dos grupos “I03 - Produtos e Serviços / Grupo de Exportação” e “ZA - Informações de Comércio Exterior”, conforme estrutura da NT20013.005_v1.21.\r\n\t\t\t\t\t\t\tAs posições 1 e 2 mantém o retorno das informações ZA02 e ZA03, mantendo o legado para os cliente que utilizam versão 2.00\r\n\t\t\t\t\t\t\tNa posição 3 passa a ser enviado o agrupamento do ID I50, tendo como filhos os IDs I51 e I52.\r\n\t\t\t\t\t\t\tNa posição 4 passa a ser enviado o agrupamento do ZA01, tendo como filhos os IDs ZA02, ZA03 e ZA04.\r\n\t\t\t\t\t\t\tNa posição 5 passa a ser enviado informaçãoes para o grupo \"BA02 - Chaves Nfe referenciadas\" as chaves de notas fiscais de saída de lote de exportação associadas à nota de saída de exportação.\r\n\t\t\t\t\t\t\tO array de retorno será multimensional, trazendo na primeira posição o identificador (ID), \r\n\t\t\t\t\t\t\tna segunda posição a tag (o campo) e na terceira posição o conteúdo retornado do processo, \r\n\t\t\t\t\t\t\tpodendo ser um outro array com a mesma estrutura caso o ID possua abaixo de sua estrutura outros IDs. \t\t\t\t\t\t \t\t\t\t\r\n\t\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\t/*Alterações TUSHX4\r\n\t\t\t\t\t\t\tFoi incluido o parametro D2_LOTECTL para que a função localize as notas de entrada (produto com lote e endereçamento) amarradas no pedido de exportção e consiga\r\n\t\t\t\t\t\t\tretornar o array de exportind de acordo com a quantidade de cada item da SD2, para não ocorrer a rejeição \r\n\t\t\t\t\t\t\t346 Somatório das quantidades informadas na Exportação Indireta não correspondem a quantidade do item.*/\r\n\t\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_PREEMB)\r\n\t\t\t\t\t\t\t\taadd(aExp,(GETNFEEXP((cAliasSD2)->D2_PREEMB,,cCodProd,(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE,(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV,(cAliasSD2)->D2_LOTECTL)))\r\n\t\t\t\t\t\t\tElseIf !Empty(SC5->C5_PEDEXP)\r\n\t\t\t\t\t\t\t\taADD(aExp,(GETNFEEXP(,SC5->C5_PEDEXP,cCodProd,(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE,(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV,(cAliasSD2)->D2_LOTECTL)))\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElseiF AliasIndic(\"CDL\")\r\n\t\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\t\tDbSelectArea(\"CDL\")\r\n\t\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\tDbSeek(xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\t\t\t\t\t\tWhile !CDL->(Eof()) .And. CDL->CDL_FILIAL+CDL->CDL_DOC+CDL->CDL_SERIE+CDL->CDL_CLIENT+CDL->CDL_LOJA == xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA\r\n\t\t\t\t\t\t    \tIf CDL->(FieldPos(\"CDL_PRODNF\")) <> 0 .And. CDL->(FieldPos(\"CDL_ITEMNF\")) <> 0 .And. AllTrim(CDL->CDL_PRODNF)+AllTrim(CDL->CDL_ITEMNF) == AllTrim((cAliasSD2)->D2_COD)+AllTrim((cAliasSD2)->D2_ITEM)\r\n\t\t\t\t\t\t\t    \taDados := {}\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"ZA02\",\"ufEmbarq\"  , IIF(CDL->(FieldPos(\"CDL_UFEMB\"))<>0 , CDL->CDL_UFEMB  ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"ZA03\",\"xLocEmbarq\", IIF(CDL->(FieldPos(\"CDL_LOCEMB\"))<>0, CDL->CDL_LOCEMB ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I51\",\"nDraw\", IIF(CDL->(FieldPos(\"CDL_ACDRAW\"))<>0, CDL->CDL_ACDRAW ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I53\",\"nRE\", IIF(CDL->(FieldPos(\"CDL_NRREG\"))<>0, CDL->CDL_NRREG ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I54\",\"chNFe\", IIF(CDL->(FieldPos(\"CDL_CHVEXP\"))<>0, CDL->CDL_CHVEXP ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I55\",\"qExport\", IIF(CDL->(FieldPos(\"CDL_QTDEXP\"))<>0, CDL->CDL_QTDEXP ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"ZA04\",\"xLocDespacho\", IIF(CDL->(FieldPos(\"CDL_LOCDES\"))<>0, CDL->CDL_LOCDES ,\"\") })\r\n\t\t\t\t\t\t\t\t\taAdd(aDados,{\"NAT_EXP\",\"Natureza\", IIF(CDL->(FieldPos(\"CDL_NATEXP\"))<>0, CDL->CDL_NATEXP ,\"\") }) //Adicionado para utilizar na verificação da montagem das tags do grupo de exportação indireta (I52 - exportind) substituindo o I53 - nRE.\r\n\r\n\t\t\t\t\t\t\t    \taAdd(aExp[Len(aExp)],aDados)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\t\t    \tCDL->(DbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0  .And. CD6->(FieldPos(\"CD6_BCCIDE\")) > 0 .And. CD6->(FieldPos(\"CD6_VALIQ\")) > 0 .And. CD6->(FieldPos(\"CD6_VCIDE\")) > 0\r\n\t\t\t\t\t\t\taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_UFCONS,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_BCCIDE,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_VALIQ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_VCIDE,;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_MIXGN\")) > 0,CD6->CD6_MIXGN,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_BICO\")) > 0,CD6->CD6_BICO,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_BOMBA\")) > 0,CD6->CD6_BOMBA,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_TANQUE\")) > 0,CD6->CD6_TANQUE,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_ENCINI\")) > 0,CD6->CD6_ENCINI,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_ENCFIN\")) > 0,CD6->CD6_ENCFIN,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_DESANP\")) > 0,CD6->CD6_DESANP,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_PGLP\")) > 0,CD6->CD6_PGLP,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_PGNN\")) > 0,CD6->CD6_PGNN,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_PGNI\")) > 0,CD6->CD6_PGNI,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_VPART\")) > 0,CD6->CD6_VPART,\"\"),;\r\n\t\t\t\t\t\t\t\tnBRICMSO,;\r\n\t\t\t\t\t\t\t\tnICMRETO,;\r\n\t\t\t\t\t\t\t\tnBRICMSD,;\r\n\t\t\t\t\t\t\t\tnICMRETD,;\r\n\t\t\t\t\t\t\t\tnAliqST})\r\n\r\n\t\t\t\t\t    Elseif AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0 \r\n\t\t\t\t\t    \taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_UFCONS,; \r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\tnBRICMSO,;\r\n\t\t\t\t\t\t\t\tnICMRETO,; \r\n\t\t\t\t\t\t\t\tnBRICMSD,;\r\n\t\t\t\t\t\t\t\tnICMRETD,;\r\n\t\t\t\t\t\t\t\tnAliqST})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aComb,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf AliasIndic(\"CD7\")\r\n\t\t\t\t\t\t\taadd(aMed,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,CD7->CD7_PRECO,IIf(CD7->(ColumnPos(\"CD7_CODANV\")) > 0,CD7->CD7_CODANV,\"\"),IIf(CD7->(ColumnPos(\"CD7_MOTISE\")) > 0,CD7->CD7_MOTISE,\"\")})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aMed,{})\r\n\t\t\t   \t\t\tEndIf\r\n\t\t\t   \t\t\tIf AliasIndic(\"CD8\")\r\n\t\t\t\t\t\t\taadd(aArma,{CD8->CD8_TPARMA,CD8->CD8_NUMARM,CD8->CD8_DESCR})                       \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aArma,{})\r\n\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\tIf AliasIndic(\"CD9\")    \t\r\n\t\t\t\t\t\t\taadd(aveicProd,{IIF(CD9->CD9_TPOPER$\"03\",1,IIF(CD9->CD9_TPOPER$\"1\",2,IIF(CD9->CD9_TPOPER$\"2\",3,IIF(CD9->CD9_TPOPER$\"9\",0,\"\")))),;\r\n\t\t\t\t\t\t\t\t\t\t\tCD9->CD9_CHASSI,CD9->CD9_CODCOR,CD9->CD9_DSCCOR,CD9->CD9_POTENC,CD9->CD9_CM3POT,CD9->CD9_PESOLI,;\r\n\t\t\t\t\t\t\t                CD9->CD9_PESOBR,CD9->CD9_SERIAL,CD9->CD9_TPCOMB,CD9->CD9_NMOTOR,CD9->CD9_CMKG,CD9->CD9_DISTEI,CD9->CD9_RENAVA,;\r\n\t\t\t\t\t\t\t                CD9->CD9_ANOMOD,CD9->CD9_ANOFAB,CD9->CD9_TPPINT,CD9->CD9_TPVEIC,CD9->CD9_ESPVEI,CD9->CD9_CONVIN,CD9->CD9_CONVEI,;\r\n\t\t\t\t\t\t\t                CD9->CD9_CODMOD,;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CILIND\")>0,CD9_CILIND,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_TRACAO\")>0,CD9_TRACAO,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_LOTAC\")>0,CD9_LOTAC,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CORDE\")>0,CD9_CORDE,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_RESTR\")>0,CD9_RESTR,\"\"))})\r\n\t\t\t\t\t\t\tlVeicNovo:= (!empty(CD9->CD9_CHASSI))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t    aadd(aveicProd,{})\r\n\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para Rastreamento de Lote - Cabecalho e Itens   \r\n\t\t\t\t\t\t//Primeiro busca no compl. de rastreabilidade (F0A) e  depois compl.de medicamento (CD7)                ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\t\t\t\t\t\tIf AliasIndic(\"F0A\") .AND. F0A->(FieldPos(\"F0A_LOTE\")) > 0 .And. !Empty(F0A->F0A_LOTE)\r\n\t\t\t\t\t\t\taadd(aLote,{IIf(F0A->(FieldPos(\"F0A_LOTE\")) > 0,F0A->F0A_LOTE,\"\"),;\r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_QTDLOT\")) > 0,F0A->F0A_QTDLOT,\"\"),;\r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_FABRIC\")) > 0,F0A->F0A_FABRIC,\"\"),;\r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_VALID\")) > 0,F0A->F0A_VALID ,\"\"),;  \r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_CODAGR\")) > 0,F0A->F0A_CODAGR ,\"\")})  \r\n\t\t\t\t\t\tElseIf !Empty(aMed) .And. !Empty(aMed[1][1])\r\n\t\t\t\t\t\t\taadd(aLote,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,\"\"})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aLote,{})\r\n\t   \t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para Anfavea - Cabecalho e Itens                             ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\r\n\t\t\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t\t\t//Cabecalho\r\n\t\t\t\t\t\t\taAnfC := {}\r\n\t\t\t\t\t\t\taadd(aAnfC,{CDR->CDR_VERSAO,CDR->CDR_CDTRAN,CDR->CDR_NMTRAN,CDR->CDR_CDRECP,CDR->CDR_NMRECP,;\r\n\t\t\t\t\t\t\t\tAModNot(CDR->CDR_ESPEC),CDR->CDR_CDENT,CDR->CDR_DTENT,CDR->CDR_NUMINV}) \r\n\t\t\t\t\t\t\t//Itens\r\n\t\t\t\t\t\t\taadd(aAnfI,{CDS->CDS_PRODUT,CDS->CDS_PEDCOM,CDS->CDS_SGLPED,CDS->CDS_SEPPEN,CDS->CDS_TPFORN,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_UM,CDS->CDS_DTVALI,CDS->CDS_PEDREV,CDS->CDS_CDPAIS,CDS->CDS_PBRUTO,CDS->CDS_PLIQUI,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_TPCHAM,CDS->CDS_NUMCHA,CDS->CDS_DTCHAM,CDS->CDS_QTDEMB,CDS->CDS_QTDIT,CDS->CDS_LOCENT,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_PTUSO,CDS->CDS_TPTRAN,CDS->CDS_LOTE,CDS->CDS_CPI,CDS->CDS_NFEMB,CDS->CDS_SEREMB,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_CDEMB,CDS->CDS_AUTFAT,CDS->CDS_CDITEM})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aAnfC,{})\r\n\t\t\t\t\t\t\taadd(aAnfI,{})\r\n\t\t\t   \t\t\tEndIf\t\t\t\t\r\n\t\r\n\t\t\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t\t\tIf !Empty(aAnfC) .And. !Empty(aAnfC[01,01]) .And. lCabAnf\r\n\t\t\t\t\t\t\t\tlCabAnf := .F.\r\n\t\t\t\t\t\t\t\tcAnfavea := '<![CDATA[[' \r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,01])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' <versao>' + allTrim(aAnfC[01,01]) + '</versao>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tcAnfavea += \t'<transmissor'\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,02])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' codigo=\"' + allTrim(aAnfC[01,02]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,03])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' nome=\"' + allTrim(aAnfC[01,03]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t    cAnfavea += '/><receptor'\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,04])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' codigo=\"' + allTrim(aAnfC[01,04]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,05])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' nome=\"' + allTrim(aAnfC[01,05]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t    cAnfavea += '/>'\t\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,06])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<especieNF>' + allTrim(aAnfC[01,06]) + '</especieNF>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,07])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<fabEntrega>' + allTrim(aAnfC[01,07]) + '</fabEntrega>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,08])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<prevEntrega>' + allTrim(Dtos(aAnfC[01,08])) + '</prevEntrega>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,09])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<Invoice>' + allTrim(aAnfC[01,09]) + '</Invoice>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tcAnfavea +=\t']]>'\r\n\t\t\t\t\t\t\tEndif  \r\n\t\t\t\t\t\tEndif\r\n\t\r\n\t\t\t\t\t\tDbSelectArea(\"SF2\")\r\n\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SF2\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\t\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\t\tIf !(cAliasSD2)->D2_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tdbSetOrder(2)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t    \r\n\t\t\t\t\t    DbSelectArea(\"SFT\")\r\n\t\t\t\t\t    DbSetOrder(1)\r\n\t\t\t\t\t    If SFT->(DbSeek(xFilial(\"SFT\")+\"S\"+(cAliasSD2)->(D2_SERIE+D2_DOC+D2_CLIENTE+D2_LOJA+PadR(D2_ITEM,TamSx3(\"FT_ITEM\")[1])+D2_COD)))\r\n\t\t\t\t\t\t   If !Empty( SFT->FT_CTIPI )\r\n\t\t\t\t\t\t   \t\taadd(aCSTIPI,{SFT->FT_CTIPI})\r\n\t\t\t\t\t\t   EndIf\r\n\t\t\t\t\t\t   //TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t\t\t\t   //PEGA OS VALORES E PERCENTUAL DO INNCENTIVO NOS ITENS NA SFT.\r\n\t\t\t\t\t\t   If SFT->(FieldPos(\"FT_PRINCMG\")) > 0 .And. SFT->(FieldPos(\"FT_VLINCMG\")) > 0\r\n\t\t\t\t\t\t\t\tIf SFT->FT_VLINCMG > 0\r\n\t\t\t\t\t\t\t\t\tnValLeite += SFT->FT_VLINCMG\r\n\t\t\t\t\t\t\t\t\t aprod[Len(aProd)][49]:=  SFT->FT_VLINCMG\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tIf nPercLeite == 0 .And. SFT->FT_PRINCMG > 0 \r\n\t\t\t\t\t\t\t\t\tnPercLeite := SFT->FT_PRINCMG\r\n\t\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t     \r\n\t\t\t\t\t\tCD2->(dbSeek(xFilial(\"CD2\")+\"S\"+SF2->F2_SERIE+SF2->F2_DOC+SF2->F2_CLIENTE+SF2->F2_LOJA+PadR((cAliasSD2)->D2_ITEM,4)+(cAliasSD2)->D2_COD))\r\n\t\t\t\r\n\t\t\t\t\t\tWhile CD2->(!Eof()) .And. xFilial(\"CD2\") == CD2->CD2_FILIAL .And.;\r\n\t\t\t\t\t\t\t\"S\" == CD2->CD2_TPMOV .And.;\r\n\t\t\t\t\t\t\tSF2->F2_SERIE == CD2->CD2_SERIE .And.;\r\n\t\t\t\t\t\t\tSF2->F2_DOC == CD2->CD2_DOC .And.;\r\n\t\t\t\t\t\t\tSF2->F2_CLIENTE == IIF(!(cAliasSD2)->D2_TIPO $ \"DB\",CD2->CD2_CODCLI,CD2->CD2_CODFOR) .And.;\r\n\t\t\t\t\t\t\tSF2->F2_LOJA == IIF(!(cAliasSD2)->D2_TIPO $ \"DB\",CD2->CD2_LOJCLI,CD2->CD2_LOJFOR) .And.;\r\n\t\t\t\t\t\t\t(cAliasSD2)->D2_ITEM == SubStr(CD2->CD2_ITEM,1,Len((cAliasSD2)->D2_ITEM)) .And.;\r\n\t\t\t\t\t\t\tAlltrim((cAliasSD2)->D2_COD) == Alltrim(CD2->CD2_CODPRO)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t    nMargem :=  IiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC == 100,CD2->CD2_PREDBC,IF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC)),CD2->CD2_PREDBC)              \t\t \t\t\t\t\t\r\n\t\r\n\t\t\t\t\t\t\t/*DbSelectArea(\"SF7\")\t\t\t\t\r\n\t\t\t\t\t\t\tDbSetOrder(1)\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf DbSeek(xFilial(\"SF7\")+SB1->B1_GRTRIB+SA1->A1_GRPTRIB)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf SF7->F7_BASEICM > 0\r\n\t\t\t\t\t\t\t\t\t\tnMargem := SF7->F7_BASEICM\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf*/\t\t\r\n\t\t\t\t\t\t\tnValtrib:= CD2->CD2_VLTRIB\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//Alterado conteudo da variavel de CD2->CD2_VLTRIB para SFT->FT_VOPDIF - Para pegar valor de diferimento - Devido atualizacao do Fiscal\r\n\t\t\t\t\t\t\tIf SubStr((cAliasSD2)->D2_CLASFIS,2,2) $ '51' .and. !Empty(SFT->FT_ICMSDIF) .and. SFT->(ColumnPos(\"FT_VOPDIF\")) > 0  .and. !Empty(SFT->FT_VOPDIF)\r\n\t\t\t\t\t\t\t\tnValtrib:= Iif(cVerAmb == \"4.00\".and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','SFT','FT_VOPDIF'),SFT->FT_VOPDIF)\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tElseIf SFT->(FieldPos(\"FT_TRFICM\")) <> 0 .And. SFT->FT_TRFICM <> 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) $ \"RS/GO\"\r\n\t\t\t\t\t\t\t\tnValtrib:= Iif(cVerAmb == \"4.00\".and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','SFT','FT_TRFICM'),SFT->FT_TRFICM)\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tnValtrib:= Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'),CD2->CD2_VLTRIB)\t\r\n\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Verifica se existe percentual de reducao na SFT referête ao RICMS 43080/2002 MG.\r\n\t\t\t\t\t\t\tIf SFT->(FieldPos(\"FT_PR43080\")) <> 0 .And. SFT->FT_PR43080 <> 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\t\t\t\tnMargem := SFT->FT_PR43080\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tDo Case\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ICM\"\r\n\t\t\t\t\t\t\t\t\taTail(aICMS) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t   If(lNfCupZero,SF4->F4_SITTRIB,CD2->CD2_CST),;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t   CD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t                   If(lNfCupZero,0,nMargem),;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t   If(lNfCupZero .Or. lIcmsPR,0,CD2->CD2_BC),;\r\n\t\t\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), If(lNfCupZero,0,Iif(CD2->CD2_BC>0,xFisRetFCP('4.0','CD2','CD2_ALIQ'),0)), If(lNfCupZero,0,Iif(CD2->CD2_BC>0,CD2->CD2_ALIQ,0))),;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero .Or. lIcmsPR,0,nValtrib),;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\"),;\r\n\t\t\t\t\t\t\t\t\tSFT->FT_ICMSDIF,;\r\n\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\tSF4->F4_ICMSDIF,;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,xFisRetFCP('4.0','CD2','CD2_BFCP'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,xFisRetFCP('4.0','CD2','CD2_PFCP'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,xFisRetFCP('4.0','CD2','CD2_VFCP'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BSTANT\")) > 0,SFT->FT_BSTANT,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_VSTANT'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_PSTANT'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BFCANTS\")) > 0,SFT->FT_BFCANTS,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PFCANTS\")) > 0,SFT->FT_PFCANTS,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VFCANTS\")) > 0,SFT->FT_VFCANTS,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VICPRST\")) > 0,SFT->FT_VICPRST,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,0)}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\t\t\tnValICMParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\t\t\tnBasICMParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017) \r\n\t\t\t\t\t\t\t\t\tIf \tlIcmsPR \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tnToTvBC \t+= \tCD2->CD2_BC \t\t//aICMS[05]\t\r\n\t\t\t\t\t\t\t\t\t\tnToTvICMS\t+=\tCD2->CD2_VLTRIB\t//aICMS[07]   \r\n\t\t\t\t\t\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"SOL\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aICMSST) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero,SF4->F4_SITTRIB,CD2->CD2_CST),;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero,0,IiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC),CD2->CD2_PREDBC)),;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero,0,CD2->CD2_BC),;\r\n\t\t\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_ALIQ'), If(lNfCupZero,0,CD2->CD2_ALIQ)),; \r\n\t\t\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'), If(lNfCupZero,0,CD2->CD2_VLTRIB)),; \r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,CD2->CD2_BFCP,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,CD2->CD2_PFCP,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,CD2->CD2_VFCP,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\")}\r\n\r\n\t\t\t\t\t\t\t\t\tIf lConsig .And. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM)  .And. CD2->CD2_VLTRIB > 0\r\n\t\t\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\"))>0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\")}\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t\t\t\tlCalSol := .T.\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Tratamento CAT04 de 26/02/2010                       ³\r\n\t\t\t\t\t\t\t\t\t//³Verifica de deve ser garavado no xml o valor e base  ³\r\n\t\t\t\t\t\t\t\t\t//³de calculo do ICMS ST para notas fiscais de devolucao³\r\n\t\t\t\t\t\t\t\t\t//³Verifica o parametro MV_ICSTDEV                      ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tnValST \t:= Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'), CD2->CD2_VLTRIB)\r\n\t\t\t\t\t\t\t\t\t//para a 4.0 devera exibir a informação Valor do ICMS ST não majorado.\r\n\t\t\t\t\t\t\t\t\tIf cVerAmb == \"4.00\" .and. nValST > 0 .And. lConsig\r\n\t\t\t\t\t\t\t\t\t\tnSTConsig += nValST\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf !lIcmSTDev\r\n\t\t\t\t\t\t\t\t\t\tIf ( (cAliasSD2)->D2_TIPO==\"D\" .Or. ( (cAliasSD2)->D2_TIPO==\"I\" .And. lComplDev)) .And. !Empty(nValST) \r\n\t\t\t\t\t\t\t\t\t\t\tnValSTAux := nValSTAux + nValST\r\n\t\t\t\t\t\t\t\t\t\t\tnBsCalcST := nBsCalcST + CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\t\t\tnValST \t  := 0\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\"))>0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\")}\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\t\t\tnValSTParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\t\t\tnBasSTParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"IPI\"\r\n\t\t\t\t\t\t\t\t\t//If !lConsig\r\n\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,;\r\n\t\t\t\t\t\t\t\t\t\tSB1->B1_CLASSE,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),; //NT2015/002\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_BC,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_ALIQ,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_VLTRIB,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t\tIiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC),CD2->CD2_PREDBC)}\r\n\t\t\t\t\t\t\t\t\t\tnValIPI := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\t\t\tIf (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .And. !Empty(nValIPI) \r\n\t\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0  .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,0,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,0}\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\tIf (!lIpiDev .OR. lIPIOutro) .And. !(Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .OR. ((cAliasSD2)->D2_TIPO==\"B\" .And. (lIpiBenef .OR. lIPIOutB))  \r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tIf ( (cAliasSD2)->D2_TIPO==\"B\" .And. lIpiBenef .and. !Empty(nValIPI) )\r\n\t\t\t\t\t\t\t\t\t\t\t\tnValIpiBene += nValIPI  // Quando lIpiBenef = T leva IPI em vOutro e Inf. Adic.\r\n\t\t\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,0,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,0}\r\n\t\t\t\t\t\t\t\t\t\t\tElseIf ( (cAliasSD2)->D2_TIPO==\"D\" .And. !Empty(nValIPI) ).OR. ( (cAliasSD2)->D2_TIPO==\"P\" .And. lComplDev .And. !Empty(nValIPI) ) \r\n\t\t\t\t\t\t\t\t\t\t\t\taAdd(aIPIDev, {nValIPI,cNCM})\r\n\t\t\t\t\t\t\t\t\t\t\t\tnValIPI := 0\r\n\t\t\t\t\t\t\t\t\t\t\t\tcNCM\t:= \"\"\r\n\t\t\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,0,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,0}\r\n\t\t\t\t\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t\t\t/*Chamado TTVZJG - Grupo impostoDevol - informar o percentual e valor do IPI devolvido, em notas de devolução (finNFe =4)\r\n\t\t\t\t\t\t\t\tIncluida a verificação do campo F4_PODER3=D para os casos de retorno de beneficiamento*/\r\n\t\t\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO == \"D\" .or. SF4->F4_PODER3 == \"D\") .and. ((CD2->(FieldPos(\"CD2_PDEVOL\")) > 0 .and. !Empty(CD2->CD2_PDEVOL) .Or. (SF4->F4_QTDZERO == \"1\")) .And. cTPNota == \"4\")\r\n\t\t\t\t\t\t\t\t\tIf (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM ) \r\n\t\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\t\tElseIf cVerAmb >= \"4.00\" .and. (((cAliasSD2)->D2_TIPO == \"D\" .and. (lIpiDev .Or. lIPIOutro)) .or. ((cAliasSD2)->D2_TIPO == \"B\" .and. (!lIpiBenef .or. lIPIOutB))) \r\n\t\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,0}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS2\"\r\n\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\taTail(aPIS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tIf aAgrPis[Len(aAgrPis)][1]\r\n\t\t\t\t\t\t\t\t\t\t\taAgrPis[Len(aAgrPis)][2] := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aPIS) := {SF4->F4_CSTPIS,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF2\"\r\n\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\taTail(aCOFINS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tIf aAgrCofins[Len(aAgrCofins)][1]\r\n\t\t\t\t\t\t\t\t\t\t\taAgrCofins[Len(aAgrCofins)][2] := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aCOFINS) := {SF4->F4_CSTCOF,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS3\" .And. (cAliasSD2)->D2_VALISS==0\r\n\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\taTail(aPISST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aPISST) := {SF4->F4_CSTPIS,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\t\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF3\" .And. (cAliasSD2)->D2_VALISS==0\r\n\t\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\t\taTail(aCOFINSST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\taTail(aCOFINSST) := {SF4->F4_CSTCOF,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ISS\" \r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\taISS[01] += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_DESCON\r\n\t\t\t\t\t\t\t\t\taISS[02] += CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\taISS[03] += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\t\t\tcMunISS := ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[09]})][02]+aDest[07])\r\n\t\t\t\t\t\t\t\t\t/* (Inicio) Alterado em 04/04/2019 por Felipe Azevedo - Desenvolvimento TSS NFS-e\r\n\t\t\t\t\t\t\t\t\t//\r\n\t\t\t\t\t\t\t\t\t//Conjunto de Alterações 229221 - Aline Yumi Kokumai - 21/05/2014 18:27:45 - Inclusão do fonte para manter o histórico.\r\n\r\n\t\t\t\t\t\t\t\t\tA condição da validação do Codigo do ISS passou a ser Verdadeira (.T.) \r\n\t\t\t\t\t\t\t\t\tdevido as rotinas do REINF ter começado a popular a tabela CDN causando\r\n\t\t\t\t\t\t\t\t\terro em municipios especificos.\r\n\t\t\t\t\t\t\t\t\tPortanto será mantido o legado da tabela CDN, porém para emissão de NF-e\r\n\t\t\t\t\t\t\t\t\tconjugada será considerado o \"Código de serviço da Nota fiscal eletônica\" (SD2).\r\n\r\n\t\t\t\t\t\t\t\t\t[Antes]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t\tcCodIss := AllTrim((cAliasSD2)->D2_CODISS)\r\n\t\t\t\t\t\t\t\t\tIf AliasIndic(\"CDN\") .And. CDN->(dbSeek(xFilial(\"CDN\")+cCodIss))\r\n\t\t\t\t\t\t\t\t\t\tcCodIss := AllTrim(CDN->CDN_CODLST)\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t[Depois] */\r\n\t\t\t\t\t\t\t\t\tcCodIss := AllTrim((cAliasSD2)->D2_CODISS)\r\n\t\t\t\t\t\t\t\t\tIf AliasIndic(\"CDN\") .And. CDN->(dbSeek(xFilial(\"CDN\")+cCodIss))\r\n\t\t\t\t\t\t\t\t\t\tcCodIss := AllTrim(CDN->CDN_CODISS)\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t//\r\n\t\t\t\t\t\t\t\t\t// (Fim) Alterado em 04/04/2019 por Felipe Azevedo - Desenvolvimento TSS NFS-e\r\n\t\t\t\t\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t\t\tIf SF3->F3_RECISS ==\"1\" \r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib := \"R\"\r\n\t\t\t\t\t\t\t\t\t\tElseif SF3->F3_RECISS ==\"2\" //.and. ( !SF4->F4_LFISS == \"I\" .and. !SM0->M0_ESTENT == \"\" )\r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\t\t\tElseif SF4->F4_LFISS ==\"I\"\r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib:= \"I\"\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIF SF4->F4_ISSST == \"1\" .or. Empty(SF4->F4_ISSST)\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"1\" //1-Exigível;\r\n\t\t\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"2\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"2\"\t//2-Não incidência\r\n\t\t\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"3\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"3\" //3-Isenção\r\n\t\t\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"4\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"5\"\t //5-Imunidade\r\n\t\t\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"5\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"6\"\t //6-Exigibilidade Suspensa por Decisão Judicial\r\n\t\t\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"6\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"7\"\t //7-Exigibilidade Suspensa por Processo Administrativo\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"4\"//4-Exportação\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Pega as deduções ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSSUB\")) > 0\r\n\t\t\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSSUB\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSMAT\")) > 0\r\n\t\t\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSMAT\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Verifica se recolhe ISS Retido ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t\t\t\tIf SF3->F3_RECISS $\"1|S\"  \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tnValISSRet := SFT->FT_VALICM // Valor do ISSRET por item\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t/*If SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t\t\t\tIf SF3->F3_RECISS $\"1S\"       \r\n\t\t\t\t\t\t\t\t\t\t\tIf SF3->(dbSeek(xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE))\r\n\t\t\t\t\t\t\t\t\t\t\t\tWhile !SF3->(EOF()) .And. xFilial(\"SF3\")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE==SF2->F2_FILIAL+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tIf SF3->F3_TIPO==\"S\" //Serviço\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnValISSRet+= SF3->F3_VALICM\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tSF3->(dbSkip())\r\n\t\t\t\t\t\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t   \t\tEndif\r\n\t\t\t\t\t\t\t\t\tEndIf*/\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aISSQN) := {CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,cMunISS,cCodIss,cSitTrib,nDeducao,cIndIss,nValISSRet}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CMP\" //ICMSUFDEST\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aICMUFDest) := {IIf(CD2->CD2_BC > 0,CD2->CD2_BC, 0),; //[1]vBCUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PFCP\")) > 0 .and. CD2->CD2_PFCP > 0,CD2->CD2_PFCP,0),;  //[2]pFCPUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->CD2_ALIQ > 0,CD2->CD2_ALIQ,0),;//[3]pICMSUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_ADIF\")) > 0 .and. CD2->CD2_ADIF > 0,CD2->CD2_ADIF,0),;//[4]pICMSInter\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PDDES\")) > 0 .and. CD2->CD2_PDDES > 0,CD2->CD2_PDDES,0),;//[5]pICMSInterPart\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VFCP\")) > 0 .and. CD2->CD2_VFCP > 0,CD2->CD2_VFCP,0),;//[6]vFCPUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VDDES\")) > 0 .and. CD2->CD2_VDDES > 0,CD2->CD2_VDDES,0),;//[7]vICMSUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VLTRIB\")) > 0 .and. CD2->CD2_VLTRIB > 0,CD2->CD2_VLTRIB,0)}//[8]vICMSUFRemet\r\n\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"TST\" \r\n\r\n\t\t\t\t\t\t\t\t\tnBCTot += IIf(CD2->CD2_BC > 0,CD2->CD2_BC,0)\t\t\t\t//Total Base de Calculo\r\n\t\t\t\t\t\t\t\t\tnALIQTot += IIf(CD2->CD2_ALIQ > 0,CD2->CD2_ALIQ,0)\t\t\t//Total de aliquota\r\n\t\t\t\t\t\t\t\t\tnVLTRIBTot += IIf(CD2->CD2_VLTRIB > 0,CD2->CD2_VLTRIB,0)\t//Total do valor tributado\r\n\r\n\t\t\t\t\t\t\t\t\t//Preenchimento da Tag <retTransp>\r\n\t\t\t\t\t\t\t\t\taImp := {;\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SC5->C5_FRETAUT > 0,SC5->C5_FRETAUT,0),;\t\t//vServ - Valor do Serviço\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIf(SC5->(ColumnPos(\"C5_FRTCFOP\")) > 0 .And. !Empty(SC5->C5_FRTCFOP) ,SC5->C5_FRTCFOP,\"\"),; \t//CFOP\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIf(!Empty(cMunTransp),cMunTransp,0),;\t//cMunFG - Código do município de ocorrência do fato gerador do ICMS do transporte\r\n\t\t\t\t\t\t\t\t\t\t\t\t0,;\t\t\t//CST - Não utiliza no manual do contribuinte v6.00\r\n\t\t\t\t\t\t\t\t\t\t\t\t0,;\t\t\t//MODBC - Não utiliza no manual do contribuinte v6.00\r\n\t\t\t\t\t\t\t\t\t\t\t\t0,;\t\t\t//PREDBC - Não utiliza no manual do contribuinte v6.00\r\n\t\t\t\t\t\t\t\t\t\t\t\tnBCTot,;\t//vBCRet - BC da Retenção do ICMS \r\n\t\t\t\t\t\t\t\t\t\t\t\tnALIQTot,;\t//pICMSRet - Alíquota da Retenção\r\n\t\t\t\t\t\t\t\t\t\t\t\tnVLTRIBTot;\t//vICMSRet - Valor do ICMS Retido\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ZFM\"\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tcICMSZFM := If(CD2->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,\"\")\r\n\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\tEndCase\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tEndDo\r\n\r\n\t\t\t\t\t\tIf SFT->FT_DESCZFR>0  .OR. !Empty(cICMSZFM)\r\n\t\t\t\t\t\t\taadd(aICMSZFM,{If(SFT->(ColumnPos(\"FT_DESCZFR\")) > 0,SFT->FT_DESCZFR,\"\"),;\r\n\t\t\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\"),;\r\n\t\t\t\t\t\t\tcICMSZFM})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aICMSZFM,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Tratamento para que o valor de PIS ST e COFINS ST venha a compor o valor total da tag vOutros  (NT 2011/004). E devolução de compra com IPI não tributado\r\n\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO == \"D\" .and. (!lIpiDev .OR. lIPIOutro))  .Or. lConsig .Or. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM ) .OR. ((cAliasSD2)->D2_TIPO == \"B\" .and. (lIpiBenef .OR. lIPIOutB)) .OR. ((cAliasSD2)->D2_TIPO==\"P\" .And. lComplDev .And. !lIpiDev)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO  == \"D\" .and.  lIPIOutro ) .or. ((cAliasSD2)->D2_TIPO  == \"B\" .and.  lIPIOutB)\r\n\t\t\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n                            EndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\t\t\taTotal[01] += 0\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taTotal[01] += (cAliasSD2)->D2_VALIPI\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\taTotal[01] += (cAliasSD2)->D2_DESPESA + (cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3 + nIcmsST + nCrdPres\r\n\t\t\t\t\t   \r\n\t\t\t\t\t\tIf (cAliasSD2)->D2_TIPO == \"I\"\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_ICMSRET > 0\r\n\t\t\t\t\t\t\t\taTotal[02] += (cAliasSD2)->D2_VALBRUT\r\n\t\t\t\t\t\t\tElseIf  ( (SF4->F4_AGREG == \"S\" .And. SF4->F4_AJUSTE == \"S\") .And. (\"RESSARCIMENTO\" $ Upper(cNatOper) .And. \"RESSARCIMENTO\" $ Upper(cDescProd)))\r\n\t\t\t\t\t\t\t\taTotal[02] += (cAliasSD2)->D2_TOTAL\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taTotal[02] += 0\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tElseIf (cAliasSD2)->D2_TIPO == \"N\" .And. AllTrim(SF4->F4_CF) $ cMVCfopTran\r\n\t\t\t\t\t\t\taTotal[02] += (cAliasSD2)->D2_TOTAL\r\n\t\t\t\t\t\tElseIf SF4->F4_PSCFST == \"1\" .And. SF4->F4_APSCFST == \"1\"\r\n\t\t\t\t\t\t\taTotal[02] += ((cAliasSD2)->D2_VALBRUT - ((cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3))\r\n\t\t\t\t\t\tElse\r\n\t\t                    aTotal[02] += (cAliasSD2)->D2_VALBRUT\r\n\t\t              EndIf\t\t\r\n\t\t              //Tratamento para que o valor de PIS ST,COFINS ST venha a compor o valor total da nota.\r\n\t\t\t\t\t\taTotal[03]+= (cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3\t\r\n\t\t\t\t\t\tIf findfunction( 'ColumnPos' )\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF SF4->(ColumnPos(\"F4_DIFAL\")) > 0 .And. SF4->F4_DIFAL == \"1\"\r\n\t\t\t\t\t\t\t\tlDifal := .T.\r\n\t\t\t\t\t\t\tEndIF \t\t\t\t\t\r\n\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\tMsgInfo(\"É necessário a atualização do sistema para a expedição mais recente.\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf (lCalSol .OR.  lMVCOMPET .OR. lDifal )\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE)\r\n\t\t\t\t\t\t\t\tcEstado := IIf(lVeicNovo,SF3->F3_ESTADO,(iif(aDest[09]<> nil,aDest[09],\"\" )))\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf At (cEstado, cMVSUBTRIB)>0\r\n\t\t\t\t\t\t\t\t\tnPosI\t:=\tAt (cEstado, cMVSUBTRIB)+2\r\n\t\t\t\t\t\t\t\t\tnPosF\t:=\tAt (\"/\", SubStr (cMVSUBTRIB, nPosI))-1\r\n\t\t\t\t\t\t\t\t\tnPosF\t:=\tIIf(nPosF<=0,len(cMVSUBTRIB),nPosF)\r\n\t\t\t\t\t\t\t\t\taAdd (aIEST, SubStr (cMVSUBTRIB, nPosI, nPosF))\t//01 - IE_ST\r\n\t\t\t\t\t\t\t\t\taAdd (aIEST,iif(aDest[14]<> nil,aDest[14],\"\" ))\t//IE Dest.\r\n\t\t\t\t\t\t\t\tElseif  lDifal\r\n\t\t\t\t\t\t\t\t\tIf AliasInDic(\"F0L\")\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"F0L\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"F0L\")+cEstado)\t//F0L_FILIAL, F0L_UF, F0L_INSCR, R_E_C_N_O_, D_E_L_E_T_\r\n\t\t\t\t\t\t\t\t\t\t\taAdd (aIEST, F0L->F0L_INSCR)\t\t\t\t\t  \t//01 - IE_ST DIFAL\r\n\t\t\t\t\t\t\t\t\t\t\taAdd (aIEST,iif(aDest[14]<> nil,aDest[14],\"\" ))\t//IE Dest.\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t    Endif\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SFT->(FieldPos(\"FT_CSTPIS\")) > 0 .And. SFT->(FieldPos(\"FT_CSTCOF\")) > 0\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"SFT\") //Livro Fiscal Por Item da NF\r\n\t\t\t\t\t\t\tdbSetOrder(1) //FT_FILIAL+FT_TIPOMOV+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM+FT_PRODUTO\r\n\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SFT\")+\"S\"+SF2->F2_SERIE+SF2->F2_DOC+SF2->F2_CLIENTE+SF2->F2_LOJA+PadR((cAliasSD2)->D2_ITEM,4)+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SFT->FT_CSTPIS)\r\n\t\t\t\t\t\t\t\t\taTail(aPisAlqZ):= {SFT->FT_CSTPIS}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SFT->FT_CSTCOF)\r\n\t\t\t\t\t\t\t\t\taTail(aCofAlqZ) := {SFT->FT_CSTCOF}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SF4->F4_CSTPIS)\r\n\t\t\t\t\t\t\t\taTail(aPisAlqZ):= {SF4->F4_CSTPIS}\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SF4->F4_CSTCOF)\r\n\t\t\t\t\t\t\t\taTail(aCofAlqZ):= {SF4->F4_CSTCOF}\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !len(aCofAlqZ)>0 .or. !len(aPisAlqZ)>0\r\n\t\t\t\t\t\t\taadd(aCofAlqZ,{})  \r\n\t\t\t\t\t   \t\taadd(aPisAlqZ,{})\t\t\t\t\t\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tIf SF4->(FieldPos(\"F4_CSOSN\"))>0\r\n\t\t\t\t\t\t\taTail(aCsosn):= SF4->F4_CSOSN\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taTail(aCsosn):= \"\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t   \t\t\r\n\t\t\t\t\t\tIf !len(aCsosn)>0 \r\n\t\t\t\t\t\t\taadd(aCsosn,\"\")  \r\n\t\t\t\t\t   \tEndif\r\n\t\t\t\t\tendif\t\r\n\t\r\n\t\t\t\t\tdbSelectArea(cAliasSD2)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t    EndDo \r\n\t\r\n\t\t\t\t//Tratamento para incluir a mensagem em informacoes adicionais do Suframa\r\n\t\t\t\tIf !Empty(aDest[15])\r\n\t\t\t\t// Msg Zona Franca de Manaus / ALC\r\n\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\tdbSeek (xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE)\r\n\t\t\t\t\tDo While !SF3->(Eof()) .AND. xFilial(\"SF3\") == SF3->F3_FILIAL .And.;\r\n\t\t\t\t\t\tSF2->F2_CLIENTE == SF3->F3_CLIEFOR .And. SF2->F2_LOJA == SF3->F3_LOJA .And.;\r\n\t\t\t\t\t\tSF2->F2_DOC == SF3->F3_NFISCAL .And. SF2->F2_SERIE == SF3->F3_SERIE\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnValBse += SF3->F3_VALOBSE\r\n\t\t\t\t\t\t\tSF3->(DbSkip ())\r\n\t   \t\t\t\tEndDo\t\t\r\n\t\t\t\t\tIf !SF2->F2_DESCZFR == 0 .or. ( lInfAdZF .and. nValBse > 0 )//Desnecessario seek redundante na SF3 pois o campo F2_DESCZFR ja possui os valores de ZFR de toda a venda\r\n\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t   cMensFis += \" \"\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\t\tIf lInfAdZF .And. (nValPisZF > 0 .Or. nValCofZF > 0)\r\n\t\t\t\t\t\t\tcMensFis += \"Descontos Ref. a Zona Franca de Manaus / ALC. ICMS - R$ \"+str(nValBse-SF2->F2_DESCONT-nValPisZF-nValCofZF,13,2)+\", PIS - R$ \"+ str(nValPisZF,13,2) +\"e COFINS - R$ \" +str(nValCofZF,13,2) \t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElseIF !lInfAdZF .And. (nValPisZF > 0 .Or. nValCofZF > 0) \r\n\t\t\t\t\t\t\tcMensFis += \"Desconto Ref. ao ICMS - Zona Franca de Manaus / ALC. R$ \"+str(nValBse-SF2->F2_DESCONT-nValPisZF-nValCofZF,13,2)\r\n\t\t\t\t\t    Else\r\n\t\t\t\t\t    \tcMensFis += \"Total do desconto Ref. a Zona Franca de Manaus / ALC. R$ \"+str(nValBse-SF2->F2_DESCONT,13,2)\r\n\t\t\t\t\t    EndIF\r\n\t\t\t\t\tEndIf \t\r\n\t\t\t\tEndIF\r\n\t\r\n\t\t\t\t//TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t\t//INSERE MSG EM INFADFISCO E SOMA NO TOTAL DA NOTA.\r\n\t\t\t\tIf nValLeite > 0 .And. nPercLeite > 0\r\n\t\t\t\t\tcMensFis += Alltrim(Str(nPercLeite,10,2))+'% Incentivo à produção e à industrialização do leite = R$ '+ Alltrim(Str(nValLeite,10,2))\r\n\t\t\t\t\taTotal[02] += nValLeite\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf Len(aIPIDev)>0\r\n\t\t\t    \tnX := 1\r\n\t\t\t\t\tDo While lOk\r\n\t\t\r\n\t\t\t\t\t   nValAux := aIPIDev[nX][1]               \r\n\t\t\t\t\t   cNCMAux := aIPIDev[nX][2]\r\n\t\t\t\t\t   \r\n\t\t\t\t\t   npos := aScan( aIPIAux,{|x| x[2]==cNCMAux})\r\n\t\t\t\t\t   IF npos >0\t\t\t\r\n\t\t\t\t\t\t\taIPIAux[npos][1]+=nValAux\r\n\t\t\t\t       Else\r\n\t\t\t\t\t\t\tAaDd(aIPIAux,{nValAux,cNCMAux})\t\t       \r\n\t\t\t\t       EndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tnX += 1\r\n\t\t\t\t\t\tIf nX > Len(aIPIDev)\r\n\t\t\t\t\t\t\tlOk := .F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndDo\r\n\t\t\r\n\t\t\t\t\t\tFor nX := 1 To Len(aIPIAux)\r\n\t\t\t\t\t\t\tcValIPI  := AllTrim(Str(aIPIAux[nX][1],15,2))\r\n\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\tcMensCli += \"(Valor do IPI: R$ \"+cValIPI+\" - \"+\"Classificação fiscal: \"+aIPIAux[nX][2]+\") \"\r\n\t\t\t\t\t\t\tcValIPI  := \"\"\r\n\t\t\t\t\t\t\tcNCMAux  := \"\"\r\n\t\t\t\t\t\tNext nX\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf nValSTAux > 0 \r\n\t\t\t\t\tcValST  := AllTrim(Str(nValSTAux,15,2))\r\n\t\t\t\t\tcBsST   := AllTrim(Str(nBsCalcST,15,2))\r\n\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\tIf lComplDev .And.  nBsCalcST == 0\r\n\t\t\t\t\t\tcMensCli += \"(Valor do ICMS ST: R$ \"+cValST+\") \" \t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS ST: R$ \"+cBsST+ \" - \"+\"Valor do ICMS ST: R$ \"+cValST+\") \"\r\n\t\t\t\t\tEndIF\t\r\n\t\t\t\t\tcValST\t  := \"\"  \r\n\t\t\t\t\tcBsST \t  := \"\"   \r\n\t\t\t\t\tnBsCalcST := 0\r\n\t\t\t\t\tnValSTAux := 0\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017) \r\n\t\t\t\tIf \tnToTvBC > 0 .And. nToTvICMS > 0 \t\t\t\t\t\t\t\t   \r\n\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS : R$ \"+AllTrim(Str(nToTvBC,15,2))+\" - \"+\"Valor do ICMS : R$ \"+AllTrim(Str(nToTvICMS,15,2))+\") \"\r\n\t\t\t\tEndif\r\n\t\t\t\t//Tratamento legislacao do Rio Grande do Sul, quando existir intes com ICMS-ST e intens somente com ICMS  próprio\r\n\t\t\t\tIf SM0->M0_ESTCOB $ \"RS\" .And. Len(aICMS) > 0 .And. Len(aICMSSt) > 0 \r\n\t\t\t\t\tcMensCli += MsgCliRsIcm(aICMS,aICMSSt)\r\n\t\t\t\tEndif\r\n\t\t\t\t//Tratamento legislacao do DF, quando existir intes com ICMS-ST e intens somente com ICMS  próprio\r\n\t\t\t\tIf aDest[9] $ \"DF\" .And. Len(aICMS) > 0 .And. Len(aICMSSt) > 0 \r\n\t\t\t\t\tcMensCli += MsgCliDFIcm(aICMS,aICMSSt,lNCMOk)\r\n\t\t\t\tEndif\r\n\t\t\t    \r\n\t\t\t    //Mensagem para ICMS Particionado - Convênio ICMS Nº 51/00,\r\n\t\t\t    if nValICMParc > 0 .And. nBasICMParc > 0 .And. nValSTParc > 0 .And. nBasSTParc > 0\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t   cMensFis += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tcMensFis += \"Faturamento Direto ao Consumidor - Convenio ICMS Nº 51/00, de 15 de setembro de 2000. \"\r\n\t\t\t\t\tcMensFis += \"Base de calculo ICMS R$\"+ AllTrim(Str(nBasICMParc,15,2))+\" e \"\r\n\t\t\t\t\tcMensFis += \"Valor do ICMS R$\"+ AllTrim(Str(nValICMParc,15,2))+\". \"\r\n\t\t\t\t\tcMensFis += \"Base do ICMS-ST R$\"+ AllTrim(Str(nBasSTParc,15,2))+\" e \"\r\n\t\t\t\t\tcMensFis += \"Valor do ICMS-ST R$\"+ AllTrim(Str(nValSTParc,15,2))+\". \"\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(aEntrega) \r\n\t\t\t\t\t\tcMensFis += \"Concessionaria que ira entregar o veiculo ao adquirente \"+ConvType(aEntrega[09],115)+\". \"\r\n\t\t\t\t\t\tcMensFis += \"CNPJ: \"+AllTrim(aEntrega[01])+\" e IE: \"+AllTrim(aEntrega[10])+\". \"\r\n\t\t\t\t\t\tcMensFis += \"Endereço: \"+ConvType(aEntrega[02],125)+\", \"+ConvType(aEntrega[03],10)+\" \"+ConvType(aEntrega[04],60)+\". \" //Rua,Num,Complemento\r\n\t\t\t\t\t\tcMensFis += ConvType(aEntrega[05],60)+\" - \"+ ConvType(aEntrega[07],50) +\"-\"+ConvType(aEntrega[08],2)+\". \"//Bairro, Cidade, UF\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMensFis += \"Concessionaria que ira entregar o veiculo ao adquirente \"+ConvType(aDest[02],115)+\". \"\r\n\t\t\t\t\t\tcMensFis += \"CNPJ \"+AllTrim(aDest[01])+\" e IE: \"+AllTrim(aDest[14])+\". \"\r\n\t\t\t\t\t\tcMensFis += \"Endereço: \"+ConvType(aDest[03],125)+\" \"+ConvType(aDest[04],10)+\" \"+ConvType(aDest[05],60)+\", \" //Rua,Num,Complemento\r\n\t\t\t\t\t\tcMensFis += ConvType(aDest[06],60)+ \", \"+ ConvType(aDest[08],50) +\" - \"+ConvType(aDest[09],2)+\". \"//Bairro, Cidade, UF \r\n\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tendif\r\n\t\t\t\t\r\n\t\t\t\tIf ((SubStr(SM0->M0_CODMUN,1,2) == \"35\" ) .and. \"REMESSA POR CONTA E ORDEM DE TERCEIROS\" $ Upper(cNatOper) .and. lOrgaoPub )\r\n\t\t\t\t\tcMensFis += \"NF-e emitida nos termos do artigo 129-A do RICMS.\"\r\n\t\t\t\t\tcMensFis += \"(Redacao dada ao artigo pelo Decreto n60.060 , de 14.01.2014, DOE SP de 15.01.2014)\"\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t    \r\n\t\t\t    If lQuery\r\n\t\t\t    \tdbSelectArea(cAliasSD2)\r\n\t\t\t    \tdbCloseArea()\r\n\t\t\t    \tdbSelectArea(\"SD2\")\r\n\t\t\t    \r\n\t\t\t    \tdbSelectArea(\"SC5\")\r\n\t\t\t    \tdbCloseArea()\r\n\t\t\t    EndIf\r\n\t\t\t    /*Tratamento para buscar a Nota Original e a Data referente inciso II do art. 456 do RICMS / SP, chamado THPXGS*/\r\n\t\t\t    if lBrinde\r\n\t\t\t    \taDocDat := DocDatOrig(SD2->D2_NUMLOTE,SD2->D2_LOTECTL,SD2->D2_COD)\r\n\t\t\t    \tif len (cMensCli) > 0\r\n\t\t\t    \t\tcMensCli += ' '\r\n\t\t\t    \tendif\r\n\t\t\t    \tcMensCli += \"Nota Fiscal emitida nos termos do inciso II do art. 456 do RICMS - Nota Fiscal de Aquisição nº \"+aDocDat[2]+\", de \"+aDocDat[1]+\".\"\r\n\t\t\t    endif \r\n\t\t\t    //Tratamento para incluir a mensagem em informacoes adicionais do FECP -DF - MG - PR - RJ - RS.\r\n\t\t\t    If nValTFecp > 0\r\n\t\t\t\t\tIf cVerAmb >= \"4.00\"\t\t\t\t\r\n\t\t\t    \tcMensFis += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\t\t\tElse\r\n\t\t\t    \t\tcMensCli += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\t\t\tEndIf\r\n\t\t\t    EndIf\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext\r\nElse\r\n\tdbSelectArea(\"SF1\")\r\n\tdbSetOrder(1)\r\n\tIf MsSeek(xFilial(\"SF1\")+cNota+cSerie+cClieFor+cLoja)\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Tratamento temporario do CTe                                            ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\tIf FunName() == \"SPEDCTE\" .Or. AModNot(SF1->F1_ESPECIE)==\"57\"\r\n\t\t\tcNFe := \"CTe35080944990901000143570000000000200000168648\"\r\n\t\t\tcString := '<infNFe versao=\"T02.00\" modelo=\"57\" >'\r\n\t\t\tcString += '<CTe xmlns=\"http://www.portalfiscal.inf.br/cte\"><infCte Id=\"CTe35080944990901000143570000000000200000168648\" versao=\"1.02\"><ide><cUF>35</cUF>'\r\n\t\t\tcString += '<cCT>000016864</cCT><CFOP>6353</CFOP><natOp>ENTREGA NORMAL</natOp><forPag>1</forPag><mod>57</mod><serie>0</serie><nCT>20</nCT>'\r\n\t\t\tcString += '<dhEmi>2008-09-12T10:49:00</dhEmi><tpImp>2</tpImp><tpEmis>2</tpEmis><cDV>8</cDV><tpAmb>2</tpAmb><tpCTe>0</tpCTe><procEmi>0</procEmi>'\r\n\t\t\tcString += '<verProc>1.12a</verProc><cMunEmi>3550308</cMunEmi><xMunEmi>Sao Paulo</xMunEmi><UFEmi>SP</UFEmi><modal>01</modal><tpServ>0</tpServ>'\r\n\t\t\tcString += '<cMunIni>3550308</cMunIni><xMunIni>Sao Paulo</xMunIni><UFIni>SP</UFIni><cMunFim>3550308</cMunFim><xMunFim>Sao Paulo</xMunFim>'\r\n\t\t\tcString += '<UFFim>SP</UFFim><retira>1</retira><xDetRetira>TESTE</xDetRetira><toma03><toma>0</toma></toma03></ide><emit><CNPJ>44990901000143</CNPJ>'\r\n\t\t\tcString += '<IE>00000000000</IE><xNome>FILIAL SAO PAULO</xNome><xFant>Teste</xFant><enderEmit><xLgr>Av. Teste, S/N</xLgr><nro>0</nro><xBairro>Teste</xBairro>'\r\n\t\t\tcString += '<cMun>3550308</cMun><xMun>Sao Paulo</xMun><CEP>00000000</CEP><UF>SP</UF></enderEmit></emit><rem><CNPJ>58506155000184</CNPJ><IE>115237740114</IE>'\r\n\t\t\tcString += '<xNome>CLIENTE SP</xNome><xFant>CLIENTE SP</xFant><enderReme><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun>'\r\n\t\t\tcString += '<xMun>SAO PAULO</xMun><CEP>77777777</CEP><UF>SP</UF></enderReme><infOutros><tpDoc>00</tpDoc><dEmi>2008-09-17</dEmi></infOutros></rem><dest><CNPJ>'\r\n\t\t\tcString += '</CNPJ><IE></IE><xNome>CLIENTE RJ</xNome><enderDest><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun><xMun>RIO DE JANEIRO</xMun>'\r\n\t\t\tcString += '<CEP>44444444</CEP><UF>RJ</UF></enderDest></dest><vPrest><vTPrest>1.93</vTPrest><vRec>1.93</vRec></vPrest><imp><ICMS><CST00><CST>00</CST><vBC>250.00</vBC><pICMS>18.00</pICMS><vICMS>450.00</vICMS>'\r\n\t\t\tcString += '</CST00></ICMS></imp><infCteComp><chave>35080944990901000143570000000000200000168648</chave><vPresComp><vTPrest>10.00</vTPrest>'\r\n\t\t\tcString += '</vPresComp><impComp><ICMSComp><CST00Comp><CST>00</CST><vBC>10.00</vBC><pICMS>10.00</pICMS><vICMS>10.00</vICMS></CST00Comp></ICMSComp></impComp>'\r\n\t\t\tcString += '</infCteComp></infCte></CTe>'\r\n\t\t\tcString += '</infNFe>'\r\n\t\tElse\t\t\t\t\r\n\t\t\taadd(aNota,SF1->F1_SERIE)\r\n\t\t\taadd(aNota,IIF(Len(SF1->F1_DOC)==6,\"000\",\"\")+SF1->F1_DOC)\r\n\t\t\taadd(aNota,SF1->F1_EMISSAO)\r\n\t\t\taadd(aNota,cTipo)\r\n\t\t\taadd(aNota,SF1->F1_TIPO)\r\n\t\t\taadd(aNota,SF1->F1_HORA)\t\t\t\r\n\t\t\tIf SF1->F1_TIPO $ \"DB\" \r\n\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA1\")+cClieFor+cLoja)\r\n\r\n\t\t\t\tIf !Empty(SA1->A1_MENSAGE) \r\n\t\t\t\t\tcRetForm := SA1->(Formula(A1_MENSAGE))\r\n\t\t\t\t\tif cRetForm <> Nil .and. !empty(cRetForm)\r\n\t\t\t\t\t\tIf cMVNFEMSA1==\"C\"\r\n\t\t\t\t\t\t\tcMensCli\t:=\tcRetForm\r\n\t\t\t\t\t\tElseIf cMVNFEMSA1==\"F\"\r\n\t\t\t\t\t\t\tcMensFis\t:=\tcRetForm\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tendif\r\n\t\t\t\tEndIf\t\t\t\t\t\t\t\t\r\n\t\t\t\t/* Quando houver uma troca/devolução (LOJA720) de uma NFC-e no Estado do AM, a tag <infAdFisco> \r\n\t\t\t\tda NF-e de entrada deve conter o motivo de devolução, nome, endereço e cpf do cliente\r\n\t\t\t\tO campo F1_MOTIVO é preenchido na funcao LOJA720 do SIGALOJA */\r\n\t\t\t\tIf lF1Motivo .AND. AllTrim(SF1->F1_ORIGLAN) == \"LO\" .AND. LjAnalisaLeg(73)[1] .AND. !Empty(SF1->F1_MOTIVO)\r\n\t\t\t\t\tcMensFis += SF1->F1_MOTIVO\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_FORRET\"))<>0 .And. !Empty(SF1->F1_FORRET+SF1->F1_LOJARET) .And. SF1->F1_FORRET+SF1->F1_LOJARET <> SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIF MsSeek(xFilial(\"SA1\")+SF1->F1_FORRET+SF1->F1_LOJARET)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_CGC)\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[4])\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_EMAIL))\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_FORENT\")) <> 0 .And. !Empty(SF1->F1_FORENT+SF1->F1_LOJAENT) .And. SF1->F1_FORENT+SF1->F1_LOJAENT <> SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SA1\")+SF1->F1_FORENT+SF1->F1_LOJAENT)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_CGC)\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\taadd(aEntrega,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA1->A1_END,\"SA1\")[4])\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_NOME)\r\n\t\t\t\t\t\taadd(aEntrega,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL)) \r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_EMAIL))\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndIf\r\n\t\t\t\t/*MMAN-5156\r\n\t\t\t\tAtendimento ao processo de Recusa de mercadoria por parte do cliente,\r\n\t\t\t\tonde o Emitente deverá realizar a inclusão de recebimento da recusa utilizando\r\n\t\t\t\tCFOP 1.201/2.201 - devolução de venda de produção do estabelecimento; \r\n\t\t\t\te (ii) 1.410/2.410 - devolução de venda de produção do estabelecimento em operação \r\n\t\t\t\tcom produto sujeito ao regime de substituição tributária. \r\n\t\t\t\tBem como incluindo seus dados de Emitente como Destinatário.\r\n\t\t\t\tParecer da Consultoria de segmentos:\r\n\t\t\t\thttp://tdn.totvs.com/pages/releaseview.action?pageId=269448809\r\n\t\t\t\t\r\n\t\t\t\tFoi criado o campo na aba DANFE no Documento de Entrada (campo do materiais UPDCOM18)\r\n\t\t\t\tF1_DEVMERC (Identifica devolução de mercadoria que não foi entregue ao destinatário em\r\n\t\t\t\tatendimento ao Artigo 453, I, do RICMS/2000 SP) \r\n\t\t\t\tTipo Caracter (Combo S=Sim;N=Não) Tamanho 1\r\n\t\t\t\t\r\n\t\t\t\tAo preencher o campo como S=Sim, os dados do próprio estabelecimento (Emitente)\r\n\t\t\t\tserão utilizados como destinatário no XML e Danfe, ao invés do cliente padrão da nota.\t\t\r\n\t\t\t\t*/\r\n\t\t\t\tIf SF1->( ColumnPos( \"F1_DEVMERC\" ) ) > 0\r\n\t\t\t\t\tcDevMerc := Alltrim(SF1->F1_DEVMERC)\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf cDevMerc == \"S\"\r\n\t\t\t\t\r\n\t\t\t\t\taadd(aDest,AllTrim(SM0->M0_CGC)) // 1\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_NOMECOM))// 2\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[1]),ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1])))// 3\r\n\t\r\n\t\t\t\t\tIf !lEndFis\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcEndEmit :=  IIF(!lEndFis,Iif(!Empty(SM0->M0_COMPCOB),SM0->M0_COMPCOB,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[4]) ) ,;\r\n\t\t\t\t\t\t  \t\tIif(!Empty(SM0->M0_COMPENT),SM0->M0_COMPENT,ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[4]) ) )\r\n\t\t\t\t\taadd(aDest,cEndEmit)// 5\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_BAIRCOB),ConvType(SM0->M0_BAIRENT)))// 6\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_CODMUN))// 7\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CIDCOB),ConvType(SM0->M0_CIDENT)))// 8\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))))// 9\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CEPCOB),ConvType(SM0->M0_CEPENT)))// 10\r\n\t\t\t\t\taadd(aDest,\"1058\")// 11\r\n\t\t\t\t\taadd(aDest,\"BRASIL\")// 12\r\n\t\t\t\t\t\r\n\t\t\t\t\taTelEmit:= FisGetTel(SM0->M0_TEL)\r\n\t\t\t\t\tcFoneEmit := IIF(aTelEmit[1] > 0,ConvType(aTelEmit[1],3),\"\") // Código do Pais\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[2] > 0,ConvType(aTelEmit[2],3),\"\") // Código da Área\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[3] > 0,ConvType(aTelEmit[3],9),\"\") // Código do Telefone\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,cFoneEmit)// 13\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(VldIE(SM0->M0_INSC)))// 14\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_SUFRAMA*/)// 15\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_EMAIL*/)// 16\r\n\t\t\t\t\taAdd(aDest,\"1\" /*SA1->A1_CONTRIB*/) // 17\r\n\t\t\t\t\taadd(aDest,\"\") // 18\r\n\t\t\t\t\taadd(aDest,SM0->M0_INSCM) // 19\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_TIPO*/) // 20\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_PFISICA*/)//21\r\n\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t/* Se MV_NFEDEST estiver desabilitado (default .F.) permanece o legado:\r\n\t\t\t\t\ta) Para operações interestaduais (UF do emitente diferente da UF do Cliente de Entrega) e o CNPJ do Destinatario(Cliente - F1_FORNECE)\r\n\t\t\t\t\t\tfor DIFERENTE do emitente, serão considerados os dados do CLIENTE DE ENTREGA.  \r\n\t\t\t\t\t\t- Os dados do Cliente de Entrega serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\tb) Para operações internas (UF do emitente igual a UF do Cliente de Entrega) e se o CNPJ do Destinatário(Cliente - F1_FORNECE)\r\n\t\t\t\t\t\tfor IGUAL ao do emitente, serão considerado os dados do CLIENTE, mesmo que UFs sejam diferentes.\r\n\t\t\t\t\t\t- Os dados do Cliente serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf !lUsaCliEnt\r\n\t\t\t\t\t\tlCNPJIgual := AllTrim(SA1->A1_CGC) == Alltrim(SM0->M0_CGC)\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(AllTrim(SF1->F1_FORENT)) .And. !Empty(AllTrim(SF1->F1_LOJAENT))\t\t\t\r\n\t\t\t\t\t\t\tIf Len(aEntrega) > 0\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//Se a UF da entrega for diferente da UF do emitente (operação interestadual) e o CNPJ do destinatario for diferente do emitente, \r\n\t\t\t\t\t\t\t\t//tenho que buscar os dados do cliente de entrega para nao ocorrer \r\n\t\t\t\t\t\t\t\t//rejeicao 523 - CFOP não é de Operação Estadual e UF emitente igual à UF destinatário\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] <> IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .And. !lCNPJIgual //aEntrega[08] <> Upper(SA1->A1_EST)\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORENT+SF1->F1_LOJAENT)\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t//Se a UF de entrega for igual a UF do emitente (Operação interna) - busco os dados do cliente para montar como destinatario.\r\n\t\t\t\t\t\t\t\t//Se o CNPJ do emitente for igual ao do destinatário também levo os dados do cliente, mesmo que UFs forem diferente.\r\n\t\t\t\t\t\t\t\t//Se o cliente não for consumidor final e possuir IE, pode ocorrer a rejeição 773 - Operação Interna e UF de destino difere da UF do emitente\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] == IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .OR. lCNPJIgual\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t/* Se MV_NFEDEST estiver habilitado (.T.):\r\n\t\t\t\t\t\t\tA tag de destinatário - 'dest' será gerada com os dados do CLIENTE (F1_FORNECE)\r\n\t\t\t\t\t\t\tCaso possua Cliente de Entrega (F1_FORENT) a tag de entrega será gerada exatamente com os dados do Cliente de Entrega \r\n\t\t\t\t\t\t\tCaso possua Cliente de Retirada (F1_FORRET) a tag de retirada será gerada exatamente com os dados do Cliente de Retirada\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_CGC))\r\n\t\t\t\t\taadd(aDest,SA1->A1_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\r\n\t\t\t   \t\tIf MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0\r\n\t\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[3]) \r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(SA1->(FieldPos(\"A1_COMPLEM\")) > 0 .And. !Empty(SA1->A1_COMPLEM),SA1->A1_COMPLEM,MyGetEnd(SA1->A1_END,\"SA1\")[4]))\r\n\t\r\n\t\t\t\t\taadd(aDest,SA1->A1_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\taadd(aDest,SA1->A1_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_DDD)+SA1->A1_TEL)\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,VldIE(SA1->A1_INSCR))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,SA1->A1_SUFRAMA)\r\n\t\t\t\t\taadd(aDest,SA1->A1_EMAIL)\r\n\t\t\t\t\taAdd(aDest, SA1->A1_CONTRIB) // Posição 17\r\n\t\t\t\t\taadd(aDest,Iif(SA1->(FieldPos(\"A1_IENCONT\")) > 0 ,SA1->A1_IENCONT,\"\"))\r\n\t\t\t\t\taadd(aDest,SA1->A1_INSCRM)\r\n\t\t\t\t\taadd(aDest,SA1->A1_TIPO)\r\n\t\t\t\t\taadd(aDest,SA1->A1_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t   \tdbSelectArea(\"SA2\")\r\n\t\t\t\tdbSetOrder(1)  \t\t\t\t\r\n\t\t\t\tMsSeek(xFilial(\"SA2\")+cClieFor+cLoja)\r\n\t\t\t\tIf SF1->( ColumnPos( \"F1_DEVMERC\" ) ) > 0\r\n\t\t\t\t\tcDevMerc := Alltrim(SF1->F1_DEVMERC)\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t/*Atendimento ao processo de Recusa de mercadoria. Notas do Tipo D, B e N\r\n\t\t\t\tAo preencher o campo como S=Sim, os dados do próprio estabelecimento (Emitente)\r\n\t\t\t\tserão utilizados como destinatário no XML e Danfe, ao invés do fornecedor padrão da nota*/\r\n\t\t\t\t\r\n\t\t\t\tIf cDevMerc == \"S\"\r\n\t\t\t\t\taadd(aDest,AllTrim(SM0->M0_CGC)) // 1\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_NOMECOM))// 2\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[1]),ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1])))// 3\r\n\t\r\n\t\t\t\t\tIf !lEndFis\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcEndEmit :=  IIF(!lEndFis,Iif(!Empty(SM0->M0_COMPCOB),SM0->M0_COMPCOB,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[4]) ) ,;\r\n\t\t\t\t\t\t  \t\tIif(!Empty(SM0->M0_COMPENT),SM0->M0_COMPENT,ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[4]) ) )\r\n\t\t\t\t\taadd(aDest,cEndEmit)// 5\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_BAIRCOB),ConvType(SM0->M0_BAIRENT)))// 6\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_CODMUN))// 7\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CIDCOB),ConvType(SM0->M0_CIDENT)))// 8\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))))// 9\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CEPCOB),ConvType(SM0->M0_CEPENT)))// 10\r\n\t\t\t\t\taadd(aDest,\"1058\")// 11\r\n\t\t\t\t\taadd(aDest,\"BRASIL\")// 12\r\n\t\t\t\t\t\r\n\t\t\t\t\taTelEmit:= FisGetTel(SM0->M0_TEL)\r\n\t\t\t\t\tcFoneEmit := IIF(aTelEmit[1] > 0,ConvType(aTelEmit[1],3),\"\") // Código do Pais\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[2] > 0,ConvType(aTelEmit[2],3),\"\") // Código da Área\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[3] > 0,ConvType(aTelEmit[3],9),\"\") // Código do Telefone\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,cFoneEmit)// 13\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(VldIE(SM0->M0_INSC)))// 14\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,\"\")// 15\r\n\t\t\t\t\taadd(aDest,\"\")// 16\r\n\t\t\t\t\taAdd(aDest,\"1\") // 17\r\n\t\t\t\t\taadd(aDest,\"\") // 18\r\n\t\t\t\t\taadd(aDest,SM0->M0_INSCM) // 19\r\n\t\t\t\t\taadd(aDest,\"\") // 20\r\n\t\t\t\t\taadd(aDest,\"\")//21\r\n\t\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_CGC))\r\n\t\t\t\t\taadd(aDest,SA2->A2_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t\r\n\t\t\t\t\tIf MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0 .or. !Empty(SA2->A2_NR_END)\r\n\t\t\t\t\t\taadd(aDest,iif(!Empty(SA2->A2_NR_END),alltrim(SA2->A2_NR_END),MyGetEnd(SA2->A2_END,\"SA2\")[3])) \r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA2->A2_END,\"SA2\")[4])\r\n\t\t\t\t\taadd(aDest,SA2->A2_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(SA2->A2_EST))\r\n\t\t\t\t\taadd(aDest,SA2->A2_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\")))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_DDD)+SA2->A2_TEL)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\t\t\t\t\r\n\t\t\t\t\t\taadd(aDest,VldIE(SA2->A2_INSCR))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,\"\")//SA2->A2_SUFRAMA\r\n\t\t\t\t\taadd(aDest,SA2->A2_EMAIL)\r\n\t\t\t\t\tIf SA2->(FieldPos(\"A2_CONTRIB\"))>0\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_CONTRIB)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taAdd(aDest, \"\") \r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\taAdd(aDest, \"\")// Posição 18 (referente a A1_IENCONT, sendo passado como vazio já que não existe A2_IENCONT)\r\n\t\t\t\t\taadd(aDest,SA2->A2_INSCRM)\r\n\t\t\t\t\taadd(aDest,\"\")//Posição 20\r\n\t\t\t\t\taadd(aDest,SA2->A2_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\tEndIf\r\n\t\t       \r\n\t\t       If SF1->(FieldPos(\"F1_FORRET\"))<>0 .And. !Empty(SF1->F1_FORRET+SF1->F1_LOJARET) .And. SF1->F1_FORRET+SF1->F1_LOJARET<>SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SA2\")+SF1->F1_FORRET+SF1->F1_LOJARET)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_CGC)\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0,MyGetEnd(SA2->A2_END,\"SA2\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA2->A2_END,\"SA2\")[4])\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_BAIRRO)\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,Upper(SA2->A2_EST))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA2->A2_NOME))\r\n\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA2->A2_INSCR),VldIE(SA2->A2_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA2->A2_CEP))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA2->A2_DDD)+SA2->A2_TEL))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA2->A2_EMAIL))\t\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_FORENT\")) <> 0 .And. !Empty(SF1->F1_FORENT+SF1->F1_LOJAENT) .And. SF1->F1_FORENT+SF1->F1_LOJAENT <> SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SA2\")+SF1->F1_FORENT+SF1->F1_LOJAENT)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_CGC)\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t\t\t\t\t\taadd(aEntrega,ConvType(IIF(MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0,MyGetEnd(SA2->A2_END,\"SA2\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA2->A2_END,\"SA2\")[4])\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_BAIRRO)\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,Upper(SA2->A2_EST))\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_NOME)\r\n\t\t\t\t\t\taadd(aEntrega,Iif(!Empty(SA2->A2_INSCR),VldIE(SA2->A2_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA2->A2_CEP))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(AllTrim(SA2->A2_DDD)+SA2->A2_TEL)) \r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA2->A2_EMAIL))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\tIf SF1->F1_TIPO $ \"DB\" \r\n\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\t\r\n\t\t\tElse\r\n\t\t\t    dbSelectArea(\"SA2\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA2\")+SF1->F1_FORNECE+SF1->F1_LOJA)\t\r\n\t\t\tEndIf\r\n\r\n\t\t\t// Faz o destaque do IPI nos dados complementares caso seja uma venda que possuir IPI\r\n\t\t\tnSF3Recno:= SF3->(RECNO())\r\n\t\t\tnSF3Index:= SF3->(IndexOrd()) \t\t\t\r\n\t\t\tSF3->(dbSetOrder(5))\r\n\t\t\tif ( SF3->(dbSeek(xFilial(\"SF3\")+cSerie+cNota)) ) \r\n\r\n\t\t\t\t//Conforme consultoria tributaria \r\n\t\t\t\t//§ 1º do artigo 442, do RICMS CE, determina que todos os documentos recebidos pelo Estado\r\n\t\t\t\t// que acobertam operações interestaduais com este Estado deverão possuir a Inscrição Estadual de Substituto\r\n\t\t\t\tIf SF3->F3_ESTADO == \"CE\"\t\t\t\t\t\r\n\t\t\t\t\tIf At (SF3->F3_ESTADO, cMVSUBTRIB)>0\r\n\t\t\t\t\t\tnPosI\t:=\tAt (SF3->F3_ESTADO, cMVSUBTRIB)+2\r\n\t\t\t\t\t\tnPosF\t:=\tAt (\"/\", SubStr (cMVSUBTRIB, nPosI))-1\r\n\t\t\t\t\t\tnPosF\t:=\tIIf(nPosF<=0,len(cMVSUBTRIB),nPosF)\t\t\t\t\t\t\r\n\t\t\t\t\t\taAdd (aIEST, SubStr (cMVSUBTRIB, nPosI, nPosF))\t//01 - IE_ST\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\taAdd (aIEST,iif(aDest[14]<> nil,aDest[14],\"\" ))\t//IE Dest.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\twhile SF3->F3_SERIE == cSerie .and. SF3->F3_NFISCAL == cNota\r\n\t\t\t\t\tIf SF3->F3_VALIPI > 0 .And. SF3->F3_TIPO == \"D\"\r\n\t\t\t\t\t\tnValIPIDestac += SF3->F3_VALIPI\t\t\t\t\r\n\t\t\t\t\tElseIf SF3->F3_IPIOBS > 0 .And. SF3->F3_TIPO == \"D\"\r\n\t\t\t\t\t\tnValIPIDestac += SF3->F3_IPIOBS\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\tSF3->(dbSkip())\r\n\t\t\t\tend\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\tif nValIPIDestac > 0\r\n\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcMensFis += \"Valor do IPI: R$ \" + AllTrim(Transform(nValIPIDestac, \"@ze 9,999,999,999,999.99\")) + \" \"\r\n\t\t\t\tendif  \r\n\t\t\t\t\r\n\t\t\tEndIf\t\r\n\t\t\t\r\n\t  \r\n\t\t\tSF3->(DBSETORDER(nSF3Index))\r\n\t\t\tSF3->(DBGOTO(nSF3Recno))\r\n\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Verifica Duplicatas da nota de entrada                                  ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\r\n\t\t\tIf !Empty(SF1->F1_DUPL)\t\r\n\t\t\t\tdbSelectArea(\"SE2\")\r\n\t\t\t\tdbSetOrder(1)\t\r\n\t\t\t\t#IFDEF TOP\r\n\t\t\t\t\tlQuery  := .T.\r\n\t\t\t\t\tcAliasSE2 := GetNextAlias()\r\n\t\t\t\t\tBeginSql Alias cAliasSE2\r\n\t\t\t\t\t\tCOLUMN E2_VENCORI AS DATE\r\n\t\t\t\t\t\tSELECT E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA,E2_VENCORI,E2_VALOR,E2_VLCRUZ,E2_ORIGEM,E2_ISS\r\n\t\t\t\t\t\tFROM %Table:SE2% SE2\r\n\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\tSE2.E2_FILIAL = %xFilial:SE2% AND\r\n\t\t\t\t\t\tSE2.E2_PREFIXO = %Exp:SF1->F1_PREFIXO% AND\r\n\t\t\t\t\t\tSE2.E2_NUM = %Exp:SF1->F1_DUPL% AND\r\n\t\t\t\t\t\tSE2.E2_FORNECE = %Exp:SF1->F1_FORNECE% AND\r\n\t\t\t\t\t\tSE2.E2_LOJA = %Exp:SF1->F1_LOJA% AND\r\n\t\t\t\t\t\tSE2.E2_TIPO = %Exp:MVNOTAFIS% AND\r\n\t\t\t\t\t\tSE2.%NotDel%\r\n\t\t\t\t\t\tORDER BY %Order:SE2%\r\n\t\t\t\t\tEndSql\r\n\t\t\t\t\t\r\n\t\t\t\t#ELSE\r\n\t\t\t\t\tMsSeek(xFilial(\"SE2\")+SF1->F1_PREFIXO+SF1->F1_DOC)\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tWhile !Eof() .And. xFilial(\"SE2\") == (cAliasSE2)->E2_FILIAL .And.;\r\n\t\t\t\t\tSF1->F1_PREFIXO == (cAliasSE2)->E2_PREFIXO .And.;\r\n\t\t\t\t\tSF1->F1_DOC == (cAliasSE2)->E2_NUM\r\n\t\t\t\t\tIf \t(cAliasSE2)->E2_TIPO==MVNOTAFIS .And. (cAliasSE2)->E2_FORNECE==SF1->F1_FORNECE .And. (cAliasSE2)->E2_LOJA==SF1->F1_LOJA\r\n\t\t\t\t\t\taadd(aDupl,{(cAliasSE2)->E2_PREFIXO+(cAliasSE2)->E2_NUM+(cAliasSE2)->E2_PARCELA,(cAliasSE2)->E2_VENCORI,(cAliasSE2)->E2_VLCRUZ - IIF(!lRuleDescISS, (cAliasSE2)->E2_ISS, 0) })\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tdbSelectArea(cAliasSE2)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t    EndDo\r\n\t\t\t    If lQuery\r\n\t\t\t    \tdbSelectArea(cAliasSE2)\r\n\t\t\t    \tdbCloseArea()\r\n\t\t\t    \tdbSelectArea(\"SE2\")\r\n\t\t\t    EndIf\r\n\t\t\tElse\r\n\t\t\t\taDupl := {}\r\n\t\t\tEndIf\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Analisa os impostos de retencao                                         ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf SF1->(FieldPos(\"F1_VALPIS\"))<>0 .And. SF1->F1_VALPIS>0\r\n\t\t\t\taadd(aRetido,{\"PIS\",0,SF1->F1_VALPIS})\r\n\t\t\tEndIf\r\n\t\t\tIf SF1->(FieldPos(\"F1_VALCOFI\"))<>0 .And. SF1->F1_VALCOFI>0\r\n\t\t\t\taadd(aRetido,{\"COFINS\",0,SF1->F1_VALCOFI})\r\n\t\t\tEndIf\r\n\t\t\tIf SF1->(FieldPos(\"F1_VALCSLL\"))<>0 .And. SF1->F1_VALCSLL>0\r\n\t\t\t\taadd(aRetido,{\"CSLL\",0,SF1->F1_VALCSLL})\r\n\t\t\tEndIf\r\n\t\t\tIf SF1->(FieldPos(\"F1_INSS\"))<>0 .and. SF1->F1_INSS>0\r\n\t\t\t\taadd(aRetido,{\"INSS\",SF1->F1_BASEINS,SF1->F1_INSS})\r\n\t\t\tEndIf\r\n\t\t\t//RECOPI\r\n\t\t\tIf SF1->(FieldPos(\"F1_IDRECOP\")) > 0 .and. !Empty(SF1->F1_IDRECOP)\r\n\t\t\t\tcIdRecopi := SF1->F1_IDRECOP\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf !Empty(cIdRecopi)\r\n\t\t\t\tIf AliasIndic(\"CE3\")\r\n\t\t\t\t\tCE3->(DbSetOrder(1))\r\n\t\t\t\t\tIf CE3->(DbSeek(xFilial(\"CE3\")+Alltrim(cIdRecopi)))\r\n\t\t\t\t\t\tcNumRecopi:= IIf(CE3->(FieldPos(\"CE3_RECOPI\")) > 0, Alltrim(CE3->CE3_RECOPI), \"\")\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Volumes / Especie Nota de Entrada                                       ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tcScan := \"1\"\r\n\t\t\tif (nPosCpoEsp := SF1->(ColumnPos(\"F1_ESPECI\"+cScan))) > 0\r\n\r\n\t\t\t\tnPosCpoVol := SF1->(ColumnPos(\"F1_VOLUME\"+cScan))\r\n\t\t\t\tnPosCpoMrc := 0\r\n\t\t\t\tnPosCpoNum := 0\r\n\t\t\t\tif !empty(cMRCVLMSF1)\r\n\t\t\t\t\taCpoMarVol := StrTokArr2(cMRCVLMSF1, \";\" ) \r\n\t\t\t\t\tif len(aCpoMarVol) == 2\r\n\t\t\t\t\t\tcCpoMarca := alltrim(aCpoMarVol[1])\r\n\t\t\t\t\t\tcCpoNumer := alltrim(aCpoMarVol[2])\r\n\t\t\t\t\t\tnPosCpoMrc := SF1->(ColumnPos(cCpoMarca + cScan)) \r\n\t\t\t\t\t\tnPosCpoNum := SF1->(ColumnPos(cCpoNumer + cScan))\r\n\t\t\t\t\tendif\r\n\t\t\t\tendif\r\n\r\n\t\t\t\tWhile ( !Empty(cScan) )\r\n\t\t\t\t\tcEspecie := \"\"\r\n\t\t\t\t\tnVolume := 0\r\n\t\t\t\t\tcMarca := \"\"\r\n\t\t\t\t\tcNumeracao := \"\"\r\n\r\n\t\t\t\t\tif nPosCpoEsp > 0\r\n\t\t\t\t\t\tcEspecie := upper(SF1->(FieldGet(nPosCpoEsp)))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\t\tIf !empty(cEspecie)\r\n\r\n\t\t\t\t\t\tif nPosCpoMrc > 0\r\n\t\t\t\t\t\t\tcMarca := alltrim(SF1->(FieldGet(nPosCpoMrc)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoNum > 0\r\n\t\t\t\t\t\t\tcNumeracao := alltrim(SF1->(FieldGet(nPosCpoNum)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoVol > 0\r\n\t\t\t\t\t\t\tnVolume := SF1->(FieldGet(nPosCpoVol))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tnScan := aScan(aEspVol,{|x| x[1] == cEspecie})\r\n\t\t\t\t\t\tIf ( nScan==0 )\r\n\t\t\t\t\t\t\taadd(aEspVol,{ cEspecie, nVolume , SF1->F1_PLIQUI , SF1->F1_PBRUTO, cMarca, cNumeracao})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taEspVol[nScan][2] += nVolume\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcScan := Soma1(cScan,1)\r\n\t\t\t\t\tnPosCpoEsp := SF1->(ColumnPos(\"F1_ESPECI\"+cScan))\r\n\t\t\t\t\tIf nPosCpoEsp == 0 \r\n\t\t\t\t\t\tcScan := \"\"\r\n\t\t\t\t\t\texit\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tnPosCpoVol := SF1->(ColumnPos(\"F1_VOLUME\"+cScan))\r\n\t\t\t\t\tif !empty(cCpoMarca) .and. !empty(cCpoNumer)\r\n\t\t\t\t\t\tnPosCpoMrc := SF1->(ColumnPos(cCpoMarca+cScan))\r\n\t\t\t\t\t\tnPosCpoNum := SF1->(ColumnPos(cCpoNumer+cScan))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\tEndDo\r\n\t\t\tEndIf\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Posiciona transportador                                                 ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf FieldPos(\"F1_TRANSP\") > 0 .And. !Empty(SF1->F1_TRANSP)\r\n\t\t\t\tdbSelectArea(\"SA4\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA4\")+SF1->F1_TRANSP)\r\n\t\t\t\t\r\n\t\t\t\taadd(aTransp,AllTrim(SA4->A4_CGC))\r\n\t\t\t\taadd(aTransp,SA4->A4_NOME)\r\n\t\t\t\taadd(aTransp,VldIE(SA4->A4_INSEST))\r\n\t\t\t\taadd(aTransp,SA4->A4_END)\r\n\t\t\t\taadd(aTransp,SA4->A4_MUN)\r\n\t\t\t\taadd(aTransp,Upper(SA4->A4_EST)\t)\r\n\t\t\t\taadd(aTransp,SA4->A4_EMAIL\t)\r\n\t\t\t\t\tIf !Empty(SF1->F1_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,SF1->F1_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,SA4->A4_EST)\r\n\t\t\t\t\t\taadd(aVeiculo,\"\")//RNTC\r\n\t\t\t\t\tEndIf\t\t\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SF1->(FieldPos(\"F1_MENNOTA\"))>0\r\n\t\t\t\tIf !AllTrim(SF1->F1_MENNOTA) $ cMensCli\r\n\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIF len(aCMPUSR) > 1  \r\n\t\t\t\t\t\tcFieldMsg := aCMPUSR[2]  \r\n\t\t\t\t\tEndIf  \r\n\t\t\t\t\tIf !Empty(cFieldMsg) .and. SF1->(FieldPos(cFieldMsg)) > 0 .and. !Empty(&(\"SF1->\"+cFieldMsg))\r\n\t\t\t\t\t\tcMensCli := alltrim(&(\"SF1->\"+cFieldMsg))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMensCli += AllTrim(SF1->F1_MENNOTA)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SF1->(FieldPos(\"F1_MENPAD\")) > 0  .and. !Empty(SF1->F1_MENPAD)\r\n\t\t\t\tcRetForm := FORMULA(SF1->F1_MENPAD)\r\n\t\t\t\tIf cRetForm <> nil .And. !AllTrim(cRetForm) $ cMensFis\r\n\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcMensFis += AllTrim(cRetForm)\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\r\n\t\t\tcField := \"%\"\r\n\t\t\tIf SD1->(FieldPos(\"D1_ICMSDIF\")) > 0\r\n\t\t\t\tcField += \",D1_ICMSDIF\"\r\n\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_FILORI\")) > 0\r\n\t\t\t\tcField += \",D1_FILORI\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_DESCZFR\")) > 0\r\n\t\t\t\tcField += \",D1_DESCZFR\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_DESCZFP\")) > 0\r\n\t\t\t\tcField += \",D1_DESCZFP\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_DESCZFC\")) > 0\r\n\t\t\t\tcField += \",D1_DESCZFC\"\r\n\t\t\tEndIf\r\n\t\t\tIf SD1->(FieldPos(\"D1_GRPCST\"))<>0 //Grupo de tributação de ipi\r\n\t\t\t   cField  +=\",D1_GRPCST\"\t\t\t\t    \r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf SD1->( ColumnPos('D1_AFRMIMP') ) > 0 //Campo específico para despesa de importação\r\n\t\t\t   cField  +=\",D1_AFRMIMP\"\t\t\t\t    \r\n\t\t\tEndIf\t\t\t\r\n\r\n\t\t\tIf SD1->( ColumnPos('D1_VOPDIF') ) > 0\r\n\t\t\t   cField  +=\",D1_VOPDIF\"\t\t\t\t    \r\n\t\t\tEndIf\r\n\r\n\t\t\tif SD1->(ColumnPos(\"D1_FCICOD\"))<>0\r\n\t\t\t\tcField  +=\",D1_FCICOD\"\t\t\t\t\t\t    \r\n\t\t\tEndIF\r\n\t\t\t\r\n\t\t\tcField += \"%\"\r\n\t\t\t\r\n\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\tdbSetOrder(1)\t\r\n\t\t\t#IFDEF TOP\r\n\t\t\t\tlQuery  := .T.\r\n\t\t\t\tcAliasSD1 := GetNextAlias()\r\n\t\t\t\tBeginSql Alias cAliasSD1\t\t\t\r\n\t\t\t\t\t\tSELECT D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_COD,D1_ITEM,D1_TES,D1_TIPO,D1_NFORI,D1_SERIORI,D1_ITEMORI,\r\n\t\t\t\t\t\tD1_CF,D1_QUANT,D1_TOTAL,D1_VALDESC,D1_VALFRE,D1_SEGURO,D1_DESPESA,D1_CODISS,D1_VALISS,D1_VALIPI,D1_ICMSRET,\r\n\t\t\t\t\t\tD1_VUNIT,D1_CLASFIS,D1_VALICM,D1_TIPO_NF,D1_PEDIDO,D1_ITEMPC,D1_VALIMP5,D1_VALIMP6,D1_BASEIRR,D1_VALIRR,D1_LOTECTL, \r\n\t\t\t\t\t\tD1_NUMLOTE,D1_CUSTO,D1_ORIGLAN,D1_DESCICM,D1_II,D1_FORMUL,D1_VALPS3,D1_ORIGLAN,D1_VALCF3,D1_TESACLA,D1_IDENTB6,D1_PICM,D1_DESC  %Exp:cField%\r\n\t\t\t\t\t\tFROM %Table:SD1% SD1\r\n\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\tSD1.D1_FILIAL  = %xFilial:SD1% AND\r\n\t\t\t\t\t\tSD1.D1_SERIE   = %Exp:SF1->F1_SERIE% AND\r\n\t\t\t\t\t\tSD1.D1_DOC     = %Exp:SF1->F1_DOC% AND\r\n\t\t\t\t\t\tSD1.D1_FORNECE = %Exp:SF1->F1_FORNECE% AND\r\n\t\t\t\t\t\tSD1.D1_LOJA    = %Exp:SF1->F1_LOJA% AND\r\n\t\t\t\t\t\tSD1.D1_FORMUL  = 'S' AND\r\n\t\t\t\t\t\tSD1.%NotDel%\r\n\t\t\t\t\t\tORDER BY D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_ITEM,D1_COD\r\n\t\t\t\tEndSql\r\n\r\n\t\t\t#ELSE\r\n\t\t\t\tMsSeek(xFilial(\"SD1\")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t#ENDIF\r\n\t\t\t\r\n\t\t\tnCountIT := 0\r\n\t\t\tWhile !Eof() .And. xFilial(\"SD1\") == (cAliasSD1)->D1_FILIAL .And.;\r\n\t\t\t\tSF1->F1_SERIE == (cAliasSD1)->D1_SERIE .And.;\r\n\t\t\t\tSF1->F1_DOC == (cAliasSD1)->D1_DOC .And.;\r\n\t\t\t\tSF1->F1_FORNECE == (cAliasSD1)->D1_FORNECE .And.;\r\n\t\t\t\tSF1->F1_LOJA ==  (cAliasSD1)->D1_LOJA\t\t\t\t\r\n\r\n\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SF4\")+(cAliasSD1)->D1_TES)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t   \tIf SF4->F4_AGRPIS = \"1\"\r\n\t\t\t\t\t\taAdd(aAgrPis,{.T.,0})\r\n\t\t\t\t\t\taAgrPis[Len(aAgrPis)][2] := (cAliasSD1)->D1_VALIMP6\r\n\t\t\t\tElse\r\n\t\t\t\t\t\taAdd(aAgrPis,{.F.,0})\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf SF4->F4_AGRCOF = \"1\"\r\n\t\t\t\t\t\taAdd(aAgrCofins,{.T.,0})\r\n\t\t\t\t\t\taAgrCofins[Len(aAgrCofins)][2] := (cAliasSD1)->D1_VALIMP5\r\n\t\t\t\tElse\r\n\t\t\t\t\t\taAdd(aAgrCofins,{.F.,0})\r\n\t\t\t\tEndIf\r\n\r\n\r\n\t\t\t\tIf SD1->(FieldPos(\"D1_DESCZFR\"))>0\r\n\t\t            nDescZF := (cAliasSD1)->D1_DESCZFR\r\n\t\t\t\tElse\r\n\t\t\t\t\tnDescZF := 0\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//Tratamento para nota sobre Cupom \r\n\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t    DbSetOrder(1)\r\n\t\t\t    IF SFT->(DbSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA)))\r\n\t\t\t\t\tIF AllTrim(SFT->FT_OBSERV) <> \" \" .AND.(cAliasSD1)->D1_ORIGLAN==\"LO\"\r\n\t\t\t\t\t\tIf !Alltrim(SFT->FT_OBSERV) $ Alltrim(cMensCli) \r\n\t\t\t\t\t\t\tIf \"DEVOLUCAO N.F.\" $ Upper(SFT->FT_OBSERV) \r\n\t\t\t\t\t\t\t\tcMensCli +=\" \" + StrTran(AllTrim(SFT->FT_OBSERV),\"N.F.\",\"C.F.\")\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcMensCli +=\" \" + AllTrim(SFT->FT_OBSERV)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf       \r\n           \t\t\tEndIf\r\n\t        \tEndIF\t\t\t\r\n\t\r\n\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_STATUS\"))>0 .And.SD1->(FieldPos(\"D1_TESACLA\"))>0 .And. SF1->F1_STATUS='C' \r\n\t\t\t\t\tMsSeek(xFilial(\"SF4\")+(cAliasSD1)->D1_TESACLA)\r\n\t\t\t\tElse \r\n\t\t\t\t\tMsSeek(xFilial(\"SF4\")+(cAliasSD1)->D1_TES)\r\n\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\tcChaveD1 := \"E\" + ( cAliasSD1 )->( D1_SERIE + D1_DOC + D1_FORNECE + D1_LOJA + D1_ITEM )\t\t\t\t\r\n\t\t\t\tSFT->( dbSetOrder( 1 ) )\r\n\t\t\t\t//utiliza a funcao SpedNatOper ( SPEDXFUN ) que possui o tratamento para a natureza da operacao/prestacao\r\n\t\t\t\tif FindFunction( \"SpedNatOper\" ) .And. SFT->( MsSeek( xFilial( \"SFT\" ) + cChaveD1 ) )\r\n\t\t\t\t\tIf !Alltrim(SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ])$cNatOper\r\n\t\t\t\t\t\tIf\tEmpty(cNatOper)\r\n\t\t\t\t\t\t\tcNatOper := SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcNatOper := cNatOper + \"/ \" +SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\telse\r\n\t\t\t\t\tIf !lNatOper\r\n\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\tcNatOper := Alltrim(SF4->F4_TEXTO)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcNatOper += Iif(!Alltrim(SF4->F4_TEXTO)$cNatOper,\"/ \" + SF4->F4_TEXTO,\"\")\r\n\t\t\t\t\t\tEndif \r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taSX513 \t := FwGetSX5(\"13\",SF4->F4_CF)\r\n\t\t\t\t\t\tIf len(aSX513) > 0\r\n\t\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\t\tcNatOper := AllTrim(SubStr(aSX513[1][4],1,55))\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcNatOper += Iif(!AllTrim(SubStr(aSX513[1][4],1,55)) $ cNatOper, \"/ \" + AllTrim(SubStr(aSX513[1][4],1,55)), \"\")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t    \t\tEndIf\r\n\t\t    \tendif\r\n\t    \t\t\r\n\t    \t\tIf SF4->(FieldPos(\"F4_BASEICM\"))>0\r\n\t    \t\t\tnRedBC := IiF(SF4->F4_BASEICM>0,IiF(SF4->F4_BASEICM == 100,SF4->F4_BASEICM,IiF(SF4->F4_BASEICM > 100,0,100-SF4->F4_BASEICM)),SF4->F4_BASEICM)\r\n\t    \t\t\tcCST   := SF4->F4_SITTRIB \r\n\t    \t\tEndif\r\n\t    \t\t\r\n\t    \t\t//Operação com diferimento parcial de 66,66% do RICMS/PR para importação\r\n\t    \t\tlDifParc := .F.\r\n\t    \t\tIf (SF4->(FieldPos(\"F4_PICMDIF\"))>0 .And. \"66.66\" $ Alltrim(Str(SF4->F4_PICMDIF)) ) ;\r\n\t    \t\t\t.And. (SF4->(FieldPos(\"F4_ICMSDIF\"))>0 .And. SF4->F4_ICMSDIF <> \"2\") ;\r\n\t    \t\t\t.And. (SubStr(SM0->M0_CODMUN,1,2)=='41' .And. SubStr((cAliasSD1)->D1_CF,1,1) == '3')\t    \t\t\t\r\n\t\t\t\t\tlDifParc := .T.\r\n\t    \t\tEndIf\r\n\t    \t\t\r\n\t    \t\tIf ((cAliasSD1)->D1_VALICM > 0 .And. (cAliasSD1)->D1_ICMSDIF > 0 ) .And. lDifParc\r\n\t    \t\t\tnValIcmDev += (cAliasSD1)->D1_VALICM   //Valor total do ICMS devido\r\n\t    \t\t\tnValIcmDif += (cAliasSD1)->D1_ICMSDIF  //Valor total do ICMS diferido \r\n\t    \t\tEndIf\r\n\t    \t\t//O campo F4_FORINFC é o substituto do F4_FORMULA, e através do parâmetro MV_NFEMSF4  se determina se o conteudo da formula devera compor a mensagem do cliente(=\"C\") ou do fisco(=\"F\").\r\n\t\t\t\tIf (cAliasSD1)->D1_FORMUL==\"S\"\r\n\t\t\t\t\tIf SF4->(ColumnPos(\"F4_FORINFC\") ) > 0  .And. !Empty(SF4->F4_FORINFC) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORINFC)\r\n\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4==\"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4==\"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\tElseIf !Empty(SF4->F4_FORMULA) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORMULA)\r\n\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4 == \"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4 == \"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf lMvImpFecp \r\n\t\t\t\t\tIf (lValFecp .Or. lVfecpst) \r\n\t\t\t\t    \tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\tIf SFT->(DbSeek((xFilial(\"SFT\") + cChaveD1 )))\t\r\n\t\t\t\t\t    \tnValTFecp += SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\r\n\t\t\t\t\t\t\tnValIFecp := SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t   \r\n\t\t\t\t\tEndif\t\t\t\t\t\r\n\t\t\t\tEndif\r\n\t   \t\t\t\r\n\t\t\t\t//Verifica se existe Template DCL\r\n      \t\t\tIF (ExistTemplate(\"PROCMSG\"))\r\n      \t\t\t\taMens := ExecTemplate(\"PROCMSG\",.f.,.f.,{cAliasSD1})      \t\t\t\t\t\t\t\t\t\t \t\t      \t\t\t\t\t\r\n\t\t\t\t\t\tFor nA:=1 to len(aMens)\r\n\t\t\t\t\t\t    If aMens[nA][1] == \"V\" .Or. (aMens[nA][1] == \"T\" .And. Ascan(aMensAux,aMens[nA][2])==0)\r\n\t\t\t\t\t\t\t\tAADD(aMensAux,aMens[nA][2])\r\n\t\t\t\t\t\t\tEndif\t\r\n\t\t\t\t\t\tNext    \t\t\t\t\t\r\n     \t\t\tEndif \r\n     \t\t\t\r\n     \t\t\t// Verifica se o CFOP é de devolução por consignação mercantil (CFOP 1111/1111/1918/2918)\r\n\t\t\t\tIf  AllTrim((cAliasSD1)->D1_CF) == \"1111\" .Or.  AllTrim((cAliasSD1)->D1_CF) == \"2111\" .or.  AllTrim((cAliasSD1)->D1_CF) == '1918' .or.   AllTrim((cAliasSD1)->D1_CF) == '2918'\r\n\t\t\t\t\tlConsig  := .T.\r\n\t\t\t\tEndIf\r\n     \t\t\t\r\n     \t\t\t\r\n\t\t\t\t/*Tratamento para NF DE AJUSTE chamado THYZ13 -  PORTARIA N° 163/2007 Artigo 18-B-2 item 4a da SEFAZ-MT */\r\n\t\t\t\t\r\n\t\t\t\tif SF4->F4_AJUSTE ==\"S\" .and. aDest[1] == SM0->M0_CGC .and. (cAliasSD1)->(D1_TIPO) == \"D\" .and. (cAliasSD1)->D1_FORMUL == \"S\"\r\n\t\t\t\t\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\taAreaSA1\t:= SA1->(GetArea())\t\t\t\r\n\t\t\t\t\taAreaSYA\t:= SYA->(GetArea())\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tif SF2->(DbSeek(xFilial(\"SF2\")+(cAliasSD1)->(D1_NFORI)+(cAliasSD1)->(D1_SERIORI))) \r\n\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\r\n\t\t\t\t\t\tif SA1->(DbSeek(xFilial(\"SA1\")+(SF2->F2_CLIENTE)+(SF2->F2_LOJA)))\r\n\t\t\t\t\t\t\tcMensCli += iIf(!Empty(SA1->A1_CGC),'CNPJ: '+Rtrim(SA1->A1_CGC) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_NOME),' NOME: '+Rtrim(SA1->A1_NOME) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_END),' ENDEREÇO: '+Rtrim(SA1->A1_END) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_BAIRRO),' BAIRRO: '+Rtrim(SA1->A1_BAIRRO) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_EST),' UF: '+Rtrim(SA1->A1_EST) ,'')\r\n\t\t\t\t\t\t\tif !Empty(SA1->A1_PAIS)\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SYA\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif SYA->(DbSeek(xFilial(\"SYA\")+(SA1->A1_PAIS)))\r\n\t\t\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SYA->YA_DESCR),' PAIS: '+Rtrim(SYA->YA_DESCR),'')\r\n\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\taAdd( aNfVinc, { SF2->F2_EMISSAO, SF2->F2_SERIE, SF2->F2_DOC,SA1->A1_CGC,SF2->F2_EST,SF2->F2_ESPECIE, SF2->F2_CHVNFE, 0,\"\",\"\",0,\"\",\"\" })\r\n\t\t\t\t\tlVinc := .T.\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tendif\t\t\t\t\r\n\t\t\t\t\tRestArea(aAreaSF2)\r\n\t\t\t\t\tRestArea(aAreaSA1)\t\t\t\t\r\n\t\t\t\t\tRestArea(aAreaSYA)\t\t\t\t\r\n\t\t\t\tendif     \t\t\t\r\n     \t\t\t\r\n     \t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Verifica as notas vinculadas                                            ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\tIf !Empty((cAliasSD1)->D1_NFORI)\r\n\t\t\t\t\t\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\tdbSelectArea(\"SF2\")\r\n        \t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf SF2->(DbSeek(xFilial(\"SF2\")+(cAliasSD1)->(D1_NFORI)+(cAliasSD1)->(D1_SERIORI))) \r\n        \t\t\t\tcSpecie:= Alltrim(SF2->F2_ESPECIE)\r\n        \t\t\tEndIf\r\n        \t\t\tRestArea(aAreaSF2)\r\n\t\t\t\t\t\r\n\t\t\t\t\taOldReg  := SD1->(GetArea())\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Realiza o backup do order e recno da SF1\r\n\t\t\t\t\tnOrderSF1\t:= SF1->( indexOrd() )\r\n\t\t\t\t\tnRecnoSF1\t:= SF1->( recno() )\r\n\r\n\t\t\t\t\tlNfCompl\t:= SF1->F1_TIPO == \"C\" .And. cMVEstado == \"RS\" \r\n                 \r\n                \t//Ajustes para que ao gerar nota de entrada do tipo complemento de preço de uma devolução seja vinculado o cliente correto \r\n\t\t\t\t\t//da nota de origem.                \t\t\r\n\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tcSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SD1\")+cSeekD1)\r\n\t\t\t\t\t\tcTipoNF :=  SD1->D1_TIPO \r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO) $ \"NCI\" // Tratamento para notas de entrada noadminrmais e complementares buscar o fornecedor original corretamente\r\n\t\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO) <> \"N\"  .AND.  cTipoNF $ 'DB'\r\n\t\t\t\t\t\t    cSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+SD1->D1_FORNECE+SD1->D1_LOJA+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_ITEMORI\r\n\t\t\t\t\t    ELSE\r\n\t\t\t\t\t        cSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_ITEMORI\r\n\t\t\t\t\t        cSeekAux:= (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI\r\n\t\t\t\t\t    EndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI\r\n\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\r\n\t\t\t\t\taAreaSD1 := SD1->(GetArea())\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Alterado a chave de busca completa devido ao procedimento de complemento de notas de devolucao de VENDA onde o codigo do fornecedor não seja o mesmo da nota de origem \r\n\t\t\t\t\tIf !MsSeek(xFilial(\"SD1\")+cSeekD1) .and. ((cAliasSD1)->D1_TIPO) $ \"C|I\"\r\n\t\t\t\t\t\tcSeekD1:= cSeekAux\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SD1\")+cSeekD1)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tSF1->( dbSetOrder( 1 ) )\r\n\t\t\t\t\t\tSF1->( msSeek( xFilial( \"SF1\" ) + SD1->D1_DOC + SD1->D1_SERIE + SD1->D1_FORNECE + SD1->D1_LOJA + SD1->D1_TIPO ) )\r\n\t\t\t\t\t\tlSeekOk := .T.\r\n\t\t\t\t\t\tIf SD1->D1_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t        lRural := ( AllTrim(SF1->F1_ESPECIE) == \"NFP\" .Or. AllTrim(SF1->F1_ESPECIE) == \"NFA\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tlSeekOk := .F.\r\n\t\t\t\t\t\tRestArea(aAreaSD1)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf !(cAliasSD1)->D1_TIPO $ \"DBN\" .Or. lRural\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Obtem os dados de nota fiscal de produtor rural referenciada                                  ³\r\n\t\t\t\t\t\t//³Temos duas situacoes:                                                                         ³\r\n\t\t\t\t\t\t//³A NF de saída é uma devolucao, onde a NF original pode ser ou nao uma devolução.              ³\r\n\t\t\t\t\t\t//³1) Quando a NF original for uma devolucao, devemos utilizar o remetente do documento fiscal,  ³\r\n\t\t\t\t\t\t//³    podendo ser o sigamat.emp no caso de formulario proprio ou o proprio SA1 no caso de nf de ³\r\n\t\t\t\t\t\t//³    entrada com formulario proprio igual a NAO.                                               ³\r\n\t\t\t\t\t\t//³2) Quando a NF original NAO for uma devolucao, neste caso tambem pode variar conforme o       ³\r\n\t\t\t\t\t\t//³    formulario proprio igual a SIM ou NAO. No caso do NAO, os dados a serem obtidos retornara ³\r\n\t\t\t\t\t\t//³    da tabela SA2.                                                                            ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf ( AllTrim(SF1->F1_ESPECIE)== \"NFP\" .Or. AllTrim(SF1->F1_ESPECIE)== \"NFA\" ) .and. lSeekOk\r\n\t\t\t\t\t\t\t//para nota de entrada tipo devolucao o emitente eh o cliente ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\tIf SD1->D1_TIPO$\"DB\"\r\n\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA1->A1_CGC),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA1->A1_EST),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA1->A1_INSCR)})\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//para nota de entrada normal o emitente eh o fornecedor ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA2->A2_CGC),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA2->A2_EST),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA2->A2_INSCR)})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t    \t//|                                                             ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\tIf AllTrim(SF1->F1_ESPECIE)==\"CF\" .and. lSeekOk\r\n\t\t\t\t\t\t\taadd(aRefECF,{SD1->D1_DOC,SF1->F1_ESPECIE})\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Outros documentos referenciados\r\n\t\t\t\t\t\tif !lRural .and. lSeekOk\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif cChave <> dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE;\r\n\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taAdd( aNfVinc, { SD1->D1_EMISSAO, SD1->D1_SERIE, SD1->D1_DOC, iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ), SM0->M0_ESTCOB, SF1->F1_ESPECIE, SF1->F1_CHVNFE,SD1->D1_TOTAL,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\tcChave\t:= dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE\r\n\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF1->F1_CHVNFE, SF1->F1_VALBRUT})\r\n\t\t\t\t\t\t\t\t//Busca NFP vinculada, da nota Original.\r\n\t\t\t\t\t\t\t\tIf lNfCompl\r\n\t\t\t\t\t\t\t\t\taNfVincRur :=\tRetNfpVinc(SD1->D1_DOC,SD1->D1_SERIE,SD1->D1_FORNECE,SD1->D1_LOJA)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t    endIf\r\n\t\t\t\t\t\t    \r\n\t\t\t\t\t    \tcItemOr\t:= ( cAliasSD1 )->D1_ITEM\r\n\t\t\t\t\t    \t\r\n\t\t\t\t\t    endIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\tIF (cAliasSD1)->D1_ORIGLAN ==\"LO\"\r\n\t\t\t\t\t\t    If (cAliasSD1)->(FieldPos(\"D1_FILORI\")) > 0\r\n\t\t\t\t\t\t\t\tcFilDev := Iif(Empty((cAliasSD1)->D1_FILORI),xFilial(\"SD2\"),(cAliasSD1)->D1_FILORI)\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcFilDev := xFilial(\"SD2\")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t   cMsSeek\t:=(cFilDev+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI)\r\n\t\t\t\t\t\tELSE \r\n\t\t\t\t\t\t\tIf (cAliasSD1)->(FieldPos(\"D1_FILORI\")) > 0\r\n\t\t\t\t\t\t\t\tcFilDev := Iif(Empty((cAliasSD1)->D1_FILORI),xFilial(\"SD2\"),(cAliasSD1)->D1_FILORI)\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcFilDev := xFilial(\"SD2\")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tif !(SF4->F4_AJUSTE=='S' .and. ((cAliasSD1)->D1_TIPO == \"D\")) .and. cSpecie <> 'NFCE' .And. !DevCliEntr(cAliasSD1)\r\n\t\t\t\t\t   \t\t\tcMsSeek\t:=(cFilDev+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_ITEMORI)\r\n\t\t\t\t\t   \t\telse  /* Quando for uma devolução de Ajuste não tem necessidade de informar os outros campo para posicionar na SD2. chamado TIANDL*/\r\n\t\t\t\t\t   \t\t\tcMsSeek\t:=(cFilDev+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI)\r\n\t\t\t\t\t   \t\tendif       \r\n\t\t\t\t\t\tEndIF                                                                          \r\n\t\t\t\t\t\t    \r\n\t\t\t\t\t\tIF MsSeek (cMsSeek)\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(cFilDev+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\tIf !SD2->D2_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//Tratamento para os campos do Loja(cNfRefcup = Numero da Nota de complemento sobre cupom /cSerRefcup = Serie da Nota de complemento sobre cupom)\r\n\t\t\t\t\t\t\t\tif SD2->(FieldPos(\"D2_NFCUP\")) <> 0\r\n\t\t\t\t\t\t\t\t\tcNfRefcup := SD2->D2_NFCUP\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tcNfRefcup := \"\"\r\n\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\tcSerRefcup := SD2->D2_SERIORI\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t\t    \t//|                                                             ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\tIf Alltrim(SF2->F2_ESPECIE)==\"CF\" .OR. (LjAnalisaLeg(18)[1] .AND. \"ECF\"$SF2->F2_ESPECIE)\r\n\t\t\t\t\t\t\t\taadd( aRefECF,{ SD2->D2_DOC,SF2->F2_ESPECIE,SF2->F2_PDV } )\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Outros documentos referenciados³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf cChave <> Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taadd(aNfVinc,{SD2->D2_EMISSAO,SD2->D2_SERIE,SD2->D2_DOC,SM0->M0_CGC,SM0->M0_ESTCOB,SF2->F2_ESPECIE,SF2->F2_CHVNFE,SD2->D2_TOTAL-SD2->D2_DESCON,SD2->D2_PEDIDO,SF2->F2_TIPO,iif(SD2->D2_TIPO $ \"DB\",2,1),SD2->D2_CLIENTE,SD2->D2_LOJA})\r\n\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\tcChave := Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tnCountIT += 1\r\n\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF2->F2_CHVNFE, SF2->F2_VALBRUT})\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElseIf (cAliasSD1)->D1_TIPO == \"N\" .And. (cAliasSD1)->D1_FORMUL = \"S\"                                                  \t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\t   \t\tdbSetOrder(4)\r\n\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_NFORI)\r\n\t\t\t\t\t   \t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t   \t\tdbSetOrder(4)\r\n\t\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE)\r\n\t\t\t\t\t\t   \t\t\tIf cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA2->A2_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t   \t\t\t\t\t.or. ( cAliasSD1 )->D1_ITEM <> cItemOr\r\n\t\t\t\t\t   \t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA2->A2_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA2->A2_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\tlVinc := .T. \r\n\t\t\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD1 )->D1_ITEM\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tRestArea(aOldReg)\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Restaura a ordem e recno da SF1\r\n\t\t\t\t\tSF1->( dbSetOrder( nOrderSF1 ) )\r\n\t\t\t\t\tSF1->( dbGoTo( nRecnoSF1 ) )\r\n\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Verifica as notas vinculadas na tabela SF8 - Amarracao NF Orig x NF Imp/Fre     ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\t\tIf Alltrim( (cAliasSD1)->D1_ORIGLAN ) $ \"D-DP-FR\" .And. Alltrim( (cAliasSD1)->D1_TIPO ) == \"C\"\r\n\t\t\t\t\t\tdbSelectArea(\"SF8\")\r\n\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\tIf dbSeek(cChavesf8:=xFilial(\"SF8\")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA)\r\n\t\t\t\t\t\t\taAreaSD1 := SD1->(GetArea())\r\n\t\t\t\t\t\t\taAreaSF1 := SF1->(GetArea())\r\n\t\t\t\t\t\t\tDo While cChavesf8 == SF8->(F8_FILIAL+F8_NFDIFRE+F8_SEDIFRE+F8_TRANSP+F8_LOJTRAN)\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)  \r\n\t\t\t\t\t\t\t\tIf dbSeek(xFilial(\"SD1\")+SF8->F8_NFORIG+SF8->F8_SERORIG+SF8->F8_FORNECE+SF8->F8_LOJA)\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tIf dbSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_TIPO)\r\n\t\t\t\t\t\t\t\t\t\tAADD(aNfVinc,{SF1->F1_EMISSAO,SF1->F1_SERIE,SF1->F1_DOC,SM0->M0_CGC,SM0->M0_ESTCOB,SF1->F1_ESPECIE,SF1->F1_CHVNFE,0,\"\",\"\",0,\"\",\"\"})\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tSF8->(DbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\t\tRestArea(aAreaSD1)\r\n\t\t\t\t\t\t\tRestArea(aAreaSF1)\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndif\t\r\n\t\t\t\tEndIf \r\n\t\t\t\t\r\n\t\t\t\tIf lVinc .and. !Empty(aNfVinc)\r\n\t\t\t\t\taADD(aItemVinc,{ATail(aNfVinc)[1]})\r\n\t\t\t\tElse\r\n\t\t\t\t\taADD(aItemVinc,{})\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Obtem os dados do produto                                               ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SB1\")+(cAliasSD1)->D1_COD)\r\n\t\t\t\t//Veiculos Novos\r\n\t\t\t\tIf AliasIndic(\"CD9\")\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"CD9\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD9\")+cChaveD1)\r\n\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t//Combustivel\r\n\t\t\t\tIf AliasIndic(\"CD6\")\r\n\t\t\t\t\tdbSelectArea(\"CD6\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD6\")+cChaveD1)\r\n\t\t\t\tEndIf\r\n\t\t\t\t//Medicamentos\r\n\t\t\t\tIf AliasIndic(\"CD7\")\r\n\t\t\t\t\tdbSelectArea(\"CD7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD7\")+cChaveD1)\r\n\t\t\t\tEndIf\r\n\t            // Armas de Fogo\r\n\t            If AliasIndic(\"CD8\")\r\n\t\t\t\t\tdbSelectArea(\"CD8\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD8\")+cChaveD1)\r\n\t\t\t\tEndIf\r\n\t\t\t\t//Anfavea\r\n\t\t\t\tIf lAnfavea\r\n\t\t\t\t\tdbSelectArea(\"CDR\")\r\n\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\tMsSeek(xFilial(\"CDR\")+\"S\"+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA)\r\n\r\n\t\t\t\t\tdbSelectArea(\"CDS\")\r\n\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\tMsSeek(xFilial(\"CDS\")+\"S\"+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_ITEM+(cAliasSD1)->D1_COD)\r\n\t\t\t\tEndIf   \r\n\t\t\t\t//RASTREABILIDADDE\r\n\t         \tIf AliasIndic(\"F0A\")\r\n\t\t\t\t\tdbSelectArea(\"F0A\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"F0A\")+cChaveD1)\r\n\t\t\t\tEndIf \r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"SB5\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf MsSeek(xFilial(\"SB5\")+(cAliasSD1)->D1_COD)\r\n\t\t\t\t\tIf SB5->(FieldPos(\"B5_DESCNFE\")) > 0 .And. !Empty(SB5->B5_DESCNFE)\r\n\t\t\t\t\t\tcInfAdic := Alltrim(SB5->B5_DESCNFE)\r\n\t\t\t\t\tElse\t\r\n\t\t\t\t\t\tcInfAdic := \"\"\t\t\t\t\r\n\t\t\t\t\tEndIF\r\n\r\n                    cUmDipi  := SB5->B5_UMDIPI\r\n                    nConvDip := SB5->B5_CONVDIP\r\n\t\t\t\tElse\r\n\t\t\t\t\tcInfAdic := \"\"\r\n                    cUmDipi  := \"\"\r\n                    nConvDip := 0\r\n\t\t\t\tEndIF \r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"DY3\")\r\n\t\t\t   \tdbSetOrder(1)\r\n\t\t\t   \tIf MsSeek(xFilial(\"DY3\")+ (cAliasSB5)->B5_ONU)\r\n\t\t\t\t\tIf !Empty(DY3->DY3_DESCRI) .and. DY3->DY3_INFCPL ==\"S\"\r\n\t\t\t\t\t\tIf !cMensONU $ DY3->DY3_ONU\r\n\t\t\t\t     \t   \tcMensONU\t:= cMensONU +'  ONU '+Alltrim(DY3->DY3_ONU)+' '+Alltrim(DY3->DY3_DESCRI)+'   '   \r\n\t\t\t\t    \tEndIF\r\n\t\t\t   \t\tEndIF  \t\t\r\n\t\t\t\tEndIF\r\n\r\n                //Atualiza a Unid. Medida da DIPI(cUmDipi) e o Fator de Conv. da DIPI(nConvDip) com dados da SBZ caso os parâmetro recebidos estejam vazios\r\n                RetInfoSBZ((cAliasSD1)->D1_COD, @cUmDipi, @nConvDip)\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Conforme Decreto RICM, N 43.080/2002 valido somente em MG deduzir o \t³ \r\n\t\t\t\t//³\timposto dispensado na operação\t\t\t\t  \t\t\t                ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tnDescRed := 0\r\n\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\tdbSetOrder(1)\r\n\r\n\t\t\t\tMsSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_ITEM+(cAliasSD1)->D1_COD) \r\n\t\t\t\tIf SFT->(FieldPos(\"FT_DS43080\")) <> 0 .And. SFT->FT_DS43080 > 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\tnDescRed := SFT->FT_DS43080 \r\n\t\t\t\t\tnDesTotal+= nDescRed\r\n\t\t\t\tEndIF\r\n\t\t\t\t\r\n\t\t\t\tIf SFT->(ColumnPos(\"FT_DESCFIS\")) <> 0 .And. SFT->FT_DESCFIS > 0\r\n\t\t\t\t\tnDescFis := SFT->FT_DESCFIS\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf (SFT->(ColumnPos(\"FT_CRDPRES\")) <> 0 .And. SFT->FT_CRDPRES > 0) .and. ( SF4->F4_AGREGCP $\"1|S\")\r\n\t\t\t\t\tnCrdPres := SFT->FT_CRDPRES\r\n\t\t\t\t\tnTotCrdP += nCrdPres\r\n\t\t\t\tEndIf \r\n\r\n\t\t\t\tIf SD1->(FieldPos(\"D1_DESCICM\"))<>0\r\n\t\t\t\t\tnDescIcm := ( IIF(SF4->F4_AGREG == \"D\",(cAliasSD1)->D1_DESCICM,0) )\r\n\t\t\t\t\tIf cVerAmb >= \"3.10\" .and. SF4->F4_AGREG == \"D\" .and. (!Empty(SF4->F4_MOTICMS) .and. (!AllTrim(SF4->F4_MOTICMS) $ \"8|9\" .or. AllTrim(SF4->F4_MOTICMS) != \"90\")) .and. Empty(SF4->F4_CSOSN)\r\n\t\t\t\t\t\tnDescIcm:=0\r\n\t\t\t\t\tEndIF\t\t\t\t\t\t\r\n\t\t\t\tEndIF\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//Alteração realizada no campo F4_ICMSDIF, foi incluido a opção: 6 – Diferido(Deduz NF e Duplicata)\r\n\t\t\t\t//no combo para deduzir os valores de ICMS diferido na NF e da Duplicata\r\n\t\t\t\t//http://tdn.totvs.com/display/public/PROT/2892815+DSERFIS1-6266+DT+Diferimento+ICMS\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\r\n\t\t\t\tnDescNfDup :=0\r\n\t\t\t\tIf\tSF4->F4_ICMSDIF == \"6\"\r\n\t\t\t\t\tnDescNFDup := IIF(SF1->(F1_STATUS) == 'C', (cAliasSD1)->(D1_ICMSDIF),SFT->FT_ICMSDIF)\r\n\t\t\t\tEndIF \r\n\t\t\t\t\t\t\r\n\t\t\t\t//Tratamento para o Tipo de Frete no documento de entrada\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_TPFRETE\")) > 0 .And. !Empty( SF1->F1_TPFRETE )\t\t\t\t\t\r\n\t\t\t\t\tIf SF1->F1_TPFRETE==\"C\"\r\n\t\t\t\t\t\tcModFrete := \"0\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"F\"\r\n\t\t\t\t\t \tcModFrete := \"1\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"T\"\r\n\t\t\t\t\t \tcModFrete := \"2\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"R\"\r\n\t\t\t\t\t \tcModFrete := \"3\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"D\"\r\n\t\t\t\t\t \tcModFrete := \"4\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"S\"\r\n\t\t\t\t\t \tcModFrete := \"9\"\r\n\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tcModFrete := IIF(SF1->F1_FRETE>0,\"0\",\"1\")\r\n\t\t\t\tEndIf\r\n\t\t\t\taAdd(aInfoItem,{(cAliasSD1)->D1_PEDIDO,(cAliasSD1)->D1_ITEMPC,(cAliasSD1)->D1_TES,(cAliasSD1)->D1_ITEM})\r\n\t\t\t\t\r\n\t\t\t\t//Tratamento para que o valor de ICMS ST venha a compor o valor da tag vOutros quando for uma nota de Devolução, impedindo que seja gerada a rejeição 610.\r\n\t\t       nIcmsST := 0\r\n\t\t       If (!lIcmSTDev .And. (cAliasSD1)->D1_TIPO == \"D\" .And. SubStr((cAliasSD1)->D1_CLASFIS,2,2) $ '10#30#70#90') .Or. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM) .Or. (!lIcmSTDev .And. lComplDev .And. (cAliasSD1)->D1_TIPO == \"I\" )\r\n\t\t       nIcmsST := (cAliasSD1)->D1_ICMSRET\r\n\t\t       EndIf   \t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//Tratamento para verificar se o produto é controlado por terceiros (IDENTB6)³\r\n\t\t\t\t//e a partir do tipo do documento (Cliente ou Fornecedor) verifica  se existe³\r\n\t\t\t\t//amarracao entre Produto X Cliente(SA7) ou Produto X Fornecedor(SA5)       ³  \r\n\t\t\t\t//Caso haja a amarracao, o codigo e descricao do produto, assumem o conteudo  ³\r\n\t\t\t\t//da SA7 ou SA5\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ³ \r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  \r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcCodProd  := (cAliasSD1)->D1_COD\t            \r\n\t\t\t\tcDescProd := SB1->B1_DESC \r\n\t\t\t\t\t \r\n\t\t\t\tIf !Empty((cAliasSD1)->D1_IDENTB6) .And. lNFPTER  \r\n\t\t\t\t\tIf (cAliasSD1)->D1_TIPO == \"N\" \r\n\t\t\t\t\t\t//--A5_FILIAL + A5_FORNECE + A5_LOJA + A5_PRODUTO\r\n\t\t\t\t\t\tSA5->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\tIf SA5->(MsSeek( xFilial(\"SA5\") + (cAliasSD1)->(D1_FORNECE+D1_LOJA+D1_COD) )) .and. !empty(SA5->A5_CODPRF) .and. !empty(SA5->A5_DESREF)\r\n\t\t\t\t\t\t\tcCodProd  := SA5->A5_CODPRF \r\n\t\t\t\t\t\t\tcDescProd := SA5->A5_DESREF \t            \r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElseIf (cAliasSD1)->D1_TIPO == \"B\"\r\n\t\t\t         //--A7_FILIAL + A7_CLIENTE + A7_LOJA + A7_PRODUTO\r\n\t\t\t\t\t\tSA7->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\tIf SA7->(MsSeek( xFilial(\"SA7\") + (cAliasSD1)->(D1_FORNECE+D1_LOJA+D1_COD) )) .and. !empty(SA7->A7_CODCLI) .and. !empty(SA7->A7_DESCCLI) \r\n\t\t\t\t\t\t\tcCodProd  := SA7->A7_CODCLI \r\n\t\t\t\t\t\t\tcDescProd := SA7->A7_DESCCLI\t            \t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcOrigem:= IIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,1,1),'0')\r\n\t\t\t    cCSTrib:= IIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,2,2),'50')\r\n\t\t\t            \r\n\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t//\t\t\tFCI - Ficha de Conteúdo de Importação\r\n\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t//**Operação INTERNA:\r\n\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da importação      (Industrialização)\r\n\t\t\t\t//\r\n\t\t\t\t//**Operação INTERESTADUAL:\r\n\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da parcela importada do exterior, o número da FCI e o Conteúdo de\r\n\t\t\t\t//   Importação expresso percentualmente (Industrialização)\r\n\t\t\t\t//----------------------------------------------------------------------------------------- \r\n\t\t\t\t\t\t\r\n\t\t\t\tIf (cOrigem $\"1-2-3-4-5-6-8\" .And. cCSTrib $ \"00-10-20-30-40-41-50-51-60-70-90\")\r\n\t\t\t\t\tIf (cAliasSD1)->(ColumnPos(\"D1_FCICOD\")) > 0 .And. !Empty((cAliasSD1)->D1_FCICOD)\r\n\t\t\t\t\t\taadd(aFCI,{(cAliasSD1)->D1_FCICOD}) \r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf lFCI\r\n\t\t\t\t\t\t\tcMsgFci\t:= \"Resolucao do Senado Federal nº 13/12\"\r\n\t\t\t\t\t\t\tcInfAdic  += cMsgFci + \", Numero da FCI \" + Alltrim((cAliasSD1)->D1_FCICOD) + \".\"\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse \r\n\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³  ³Código de Benefício Fiscal na UF aplicado ao item\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \r\n\t\t\t\tlCodLan := .F.\r\n\t\t\t\tIf SM0->M0_ESTENT $ \"PR/RJ/RS/\" //TAG cBenef buscar o conteúdo da tabela 5.2 no sistema quando for do PR.\r\n\t\t\t\t\tdbSelectArea(\"CDV\")\r\n\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\tcCodlan :=\"\"\r\n\t\t\t\t\tIf MsSeek(xFilial(\"CDV\") +'E'+PadR('SPED',TamSX3(\"CDV_ESPECI\")[1])+'S'+(cAliasSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_ITEM))\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Tratamento realizado enquanto o fiscal não realiza a criação do campo na CDV\r\n\t\t\t\t\t\tif CDV->(ColumnPos(\"CDV_NFE\")) > 0\r\n\t\t\t\t\t\t\tif CDV->CDV_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDY\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf CDV->(ColumnPos(\"CDV_CODAJU\")) > 0 .and. !Empty(CDV->CDV_CODAJU) .and. MsSeek( xFilial(\"CDY\") + CDV->CDV_CODAJU)\r\n\t\t\t\t\t\t\t\tIf CDY->CDY_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif lCodLan\r\n\t\t\t\t\t\t\tcCodlan:= CDV->CDV_CODAJU\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcCodlan := getCodLan( alltrim(SM0->M0_ESTENT), SF4->F4_SITTRIB, cAmbiente )\r\n\t\t\t\t\tEndIF\r\n\t\t\t\tElse\r\n\t\t\t\t\tcCodlan := \"\"\t\r\n\t\t\t\t\tIf SM0->M0_ESTENT <> \"SP\" .and. CDA->(ColumnPos(\"CDA_CODLAN\")) > 0\r\n\t\t\t\t\t\tdbSelectArea(\"CDA\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tcSeekCDA := xFilial(\"CDA\") +'E'+PadR('SPED',TamSX3(\"CDA_ESPECI\")[1])+'S'+(cAliasSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_ITEM)\r\n\t\t\t\t\t\tIf MsSeek(cSeekCDA) //CDA_FILIAL, CDA_TPMOVI, CDA_ESPECI, CDA_FORMUL, CDA_NUMERO, CDA_SERIE, CDA_CLIFOR, CDA_LOJA, CDA_NUMITE, CDA_SEQ, CDA_CODLAN, CDA_CALPRO\r\n\t\t\t\t\t\t\tWhile alltrim(cSeekCDA) == alltrim(CDA->(CDA_FILIAL + CDA_TPMOVI + CDA_ESPECI + CDA_FORMUL + CDA_NUMERO + CDA_SERIE + CDA_CLIFOR + CDA_LOJA + CDA_NUMITE))\r\n\t\t\t\t\t\t\t\tIf !Empty(CDA->CDA_CODLAN) .And. CDA->CDA_TPLANC == \"2\" .and. Len(AllTrim(CDA->CDA_CODLAN)) == 10\r\n\t\t\t\t\t\t\t\t\tcCodlan := CDA->CDA_CODLAN\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCDA->(dbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³  Indicador de Produção em escala relevante, conforme Cláusula 23 do Convenio ICMS 52/2017\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \t\t\t\t\t\t\r\n\t\t\t\tIf AliasIndic(\"D3E\")\r\n\t\t\t\t\tdbSelectArea(\"D3E\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tcIndEscala :=\"\"\r\n\t\t\t\t\tIf MsSeek(PADR(xFilial(\"D3E\"),TAMSX3(\"D3E_FILIAL\")[1]) +(cAliasSD1)->D1_COD)\r\n\t\t\t\t\t\tIf D3E->(ColumnPos(\"D3E_INDESC\")) > 0\r\n\t\t\t\t\t\t\tIf\t!Empty(D3E->D3E_INDESC)  .AND.  D3E->D3E_INDESC == \"1\"\r\n\t\t\t\t\t\t\t\tcIndEscala:= \"S\"\r\n\t\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\tEndIF\t\t\r\n\t\t\t\tEndIF\t\t\r\n\t\t\t\t\r\n\t\t\t\tcTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,(cAliasSD1)->D1_CF)\r\n\t\t\t\t\r\n\t\t\t\tIf((cAliasSD1)->D1_TIPO <> \"D\") .Or. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM)\r\n\t\t\t\t\tlEIPIOutro := .F.\r\n\t\t\t\tEnd\r\n\t\t\t\t\r\n\t\t\t\tIf ((cAliasSD1)->D1_TIPO <> 'B')\r\n\t\t\t\t\tlIPIOutB :=.F.\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).\r\n\t\t\t\tnValOutr  := 0\r\n\t\t\t\tIf (((cAliasSD1)->D1_TIPO == \"D\" .And. (!lEipiDev .Or. lEIPIOutro)) .Or. ((cAliasSD1)->D1_TIPO == \"B\" .and. lIpiBenef)) \r\n\r\n\t\t\t\t    If ((cAliasSD1)->D1_TIPO == \"D\" .and.  lEIPIOutro ) .or. ((cAliasSD1)->D1_TIPO == \"B\" .and. lIPIOutB)\r\n\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n                    EndIf \t\t            \t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\tnValOutr += 0\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tnValOutr += (cAliasSD1)->D1_VALIPI\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tnValOutr += (cAliasSD1)->D1_DESPESA + (cAliasSD1)->D1_VALPS3 + (cAliasSD2)->D2_VALCF3 + nIcmsST + nCrdPres\r\n\t\t\t\tcTpOrig  := IIF(nCountIT > 0 .And. Len(aNfVinc[nCountIT]) > 9, aNfVinc[nCountIT][10], \"\")\r\n\t\t\t\t\t\t\t\t            \t\t            \t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t/*\r\n\t\t\t\tBruno Sigawie\r\n\t\t\t\tse for a itinga a chamada e orignal \r\n\t\t\t\tse for qualita muda a função U_RETPESOFAT\r\n\t\t\t\t*/\r\n\t\t\t\t\r\n\t\t\t\t//If SubString(CNUMEMP,1,2) == \"05\"\r\n\t\t\t\t\t\t\t\t            \t\t            \t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\taadd(aProd,\t{Len(aProd)+1,;  \r\n\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\tSB1->B1_POSIPI,;\r\n\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_CF,;\r\n\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_QUANT,;\r\n\t\t\t\t\t\tIIF(!((cAliasSD1)->D1_TIPO $\"IP\" .Or. ((cAliasSD1)->D1_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,(IIF(!(lMvNFLeiZF),(cAliasSD1)->D1_TOTAL,(cAliasSD1)->D1_TOTAL - ((cAliasSD1)->D1_DESCZFP+(cAliasSD1)->D1_DESCZFC))),0),;\r\n\t\t\t\t\t\tretUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\tretQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), nConvDip, (cAliasSD1)->D1_QUANT ),;    //retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_CONVDIP, (cAliasSD1)->D1_QUANT ),;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_VALFRE,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_SEGURO,;\r\n\t\t\t\t\t\tnDescRed + nDescIcm + nDescNfDup + (cAliasSD1)->D1_VALDESC + nDescFis -(SFT->FT_DESCZFR),;\r\n\t\t\t\t\t   \tIIF(!((cAliasSD1)->D1_TIPO $\"IP\"),(cAliasSD1)->D1_VUNIT,0),;\r\n\t\t\t\t\t   \tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF  \r\n\t\t\t\t\t\t(cAliasSD1)->D1_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t(cAliasSD1)->D1_NUMLOTE,;//Numero do Lote \r\n\t\t\t\t\t\tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).\r\n\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\tIIF(SF4->F4_AGREG<>'N' .And. SF4->F4_ISS='S',\"1\",IIF(SF4->F4_AGREG='N' .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\")),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_TES,;\r\n\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t0,;  // Da posição 28 a 30 tratamento realizado apenas para documento de saída por este motivo campos estão zerados e vazios.\r\n\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFP\"))<>0,(cAliasSD1)->D1_DESCZFP,0),;\t\t\t//Desconto Zona Franca PIS\r\n\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFC\"))<>0,(cAliasSD1)->D1_DESCZFC,0),;\t\t\t//Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t(cAliasSD1)->D1_PICM,;\t\t// [33] Percentual de ICMS\r\n\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;\t\t// [34]\r\n\t\t\t\t\t\t0,;\t\t// [35]\r\n\t\t\t\t\t\t0,;\t\t// [36]\r\n\t\t\t\t\t\t0,;\t\t// [37]\r\n\t\t\t\t\t\t0,;\t\t// [38]\r\n\t\t\t\t\t\t0,;\t\t// [39]\r\n\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_GRPCST\")) > 0 .and. !Empty((cAliasSD1)->D1_GRPCST),(cAliasSD1)->D1_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //[40]\r\n\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aprod[41] NT2015/003\r\n\t\t\t\t\t\tIIF(SF4->(ColumnPos(\"F4_VENPRES\"))>0,SF4->F4_VENPRES,\"\"),; //aprod[42] utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\tnValIFecp ,; //aprod[43]  Valor do FECP. \r\n\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),; //aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),; //aprod[46] \r\n\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\tSF4->F4_ART274,; //aprod[48]\r\n\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t})\r\n\t\t\t\t/*Else\r\n\t\t\t\t\taadd(aProd,\t{Len(aProd)+1,;  \r\n\t\t\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\t\t\tSB1->B1_POSIPI,;\r\n\t\t\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_CF,;\r\n\t\t\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_QUANT,;\r\n\t\t\t\t\t\t\t\tIIF(!((cAliasSD1)->D1_TIPO $\"IP\" .Or. ((cAliasSD1)->D1_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,(IIF(!(lMvNFLeiZF),(cAliasSD1)->D1_TOTAL,(cAliasSD1)->D1_TOTAL - ((cAliasSD1)->D1_DESCZFP+(cAliasSD1)->D1_DESCZFC))),0),;\r\n\t\t\t\t\t\t\t\tretUn2UM ( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), \"\", SB1->B1_UM            ) ,; // BRUNO retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\t\t\tretQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), 0 , (cAliasSD1)->D1_QUANT ) ,; // BRUNO retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), nConvDip, (cAliasSD1)->D1_QUANT ),;    //retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_CONVDIP, (cAliasSD1)->D1_QUANT ),;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_VALFRE,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_SEGURO,;\r\n\t\t\t\t\t\t\t\tnDescRed + nDescIcm + nDescNfDup + (cAliasSD1)->D1_VALDESC + nDescFis -(SFT->FT_DESCZFR),;\r\n\t\t\t\t\t\t\t   \tIIF(!((cAliasSD1)->D1_TIPO $\"IP\"),(cAliasSD1)->D1_VUNIT,0),;\r\n\t\t\t\t\t\t\t   \tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF  \r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_NUMLOTE,;//Numero do Lote \r\n\t\t\t\t\t\t\t\tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).\r\n\t\t\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\t\t\tIIF(SF4->F4_AGREG<>'N' .And. SF4->F4_ISS='S',\"1\",IIF(SF4->F4_AGREG='N' .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\")),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_TES,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;  // Da posição 28 a 30 tratamento realizado apenas para documento de saída por este motivo campos estão zerados e vazios.\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFP\"))<>0,(cAliasSD1)->D1_DESCZFP,0),;\t\t\t//Desconto Zona Franca PIS\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFC\"))<>0,(cAliasSD1)->D1_DESCZFC,0),;\t\t\t//Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_PICM,;\t\t// [33] Percentual de ICMS\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;\t\t// [34]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [35]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [36]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [37]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [38]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [39]\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_GRPCST\")) > 0 .and. !Empty((cAliasSD1)->D1_GRPCST),(cAliasSD1)->D1_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //[40]\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aprod[41] NT2015/003\r\n\t\t\t\t\t\t\t\tIIF(SF4->(ColumnPos(\"F4_VENPRES\"))>0,SF4->F4_VENPRES,\"\"),; //aprod[42] utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\t\t\tnValIFecp ,; //aprod[43]  Valor do FECP. \r\n\t\t\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),; //aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),; //aprod[46] \r\n\t\t\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\t\t\tSF4->F4_ART274,; //aprod[48]\r\n\t\t\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\tEndIf\t\r\n\t\t\t\t*/\r\n\t\t\t\t\t\r\n\t\t\t\t\t        \r\n\t\t\t\taadd(aCST,{IIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,2,2),'50'),;\r\n\t\t\t\t\tIIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,1,1),'0')})\r\n\t\t\t\taadd(aICMS,{})\r\n\t\t\t\taadd(aIPI,{})\r\n\t\t\t\taadd(aICMSST,{})\r\n\t\t\t\taadd(aPIS,{})\r\n\t\t\t\taadd(aPISST,{})\r\n\t\t\t\taadd(aCOFINS,{})\r\n\t\t\t\taadd(aCOFINSST,{})\r\n\t\t\t\taadd(aISSQN,{})\r\n\t\t\t\taadd(aPisAlqZ,{})\r\n\t\t\t\taadd(aCofAlqZ,{})\r\n\t\t\t\taadd(aCsosn,{})\r\n\t\t\t\taadd(aFCI,{})\r\n\t\t\t\taadd(aICMUFDest,{})\r\n\t\t\t\taadd(aIPIDevol,{})\r\n\r\n\t\t\t\tDbSelectArea(\"SC7\")\r\n\t\t\t\tDbSetOrder(1)\r\n\t\t\t\tIf MsSeek(xFilial(\"SC7\")+(cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEM)\r\n\t\t\t\t\taadd(aPedCom,{SC7->C7_NUM,SC7->C7_ITEM})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aPedCom,{})\r\n\t\t\t\tEndif\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento para TAG Exportação quando existe a integração com a EEC     ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf lEECFAT\r\n\t\t\t\t\t/*Alterações TQXWO2\r\n\t\t\t\t\tNa chamada da função, foram criados dois novos parâmetros: \r\n\t\t\t\t\to 3º referente ao código do produto e o 4º referente ao número da nota fiscal + série (chave).\r\n\t\t\t\t\tGetNfeExp(pProcesso, pPedido, cProduto, cChave)\r\n\t\t\t\t\tNo retorno da função serão devolvidas as informações do legado, conforme leiaute anterior à versão 3.10 , \r\n\t\t\t\t\te as informações dos grupos “I03 - Produtos e Serviços / Grupo de Exportação” e “ZA - Informações de Comércio Exterior”, conforme estrutura da NT20013.005_v1.21.\r\n\t\t\t\t\tAs posições 1 e 2 mantém o retorno das informações ZA02 e ZA03, mantendo o legado para os cliente que utilizam versão 2.00\r\n\t\t\t\t\tNa posição 3 passa a ser enviado o agrupamento do ID I50, tendo como filhos os IDs I51 e I52.\r\n\t\t\t\t\tNa posição 4 passa a ser enviado o agrupamento do ZA01, tendo como filhos os IDs ZA02, ZA03 e ZA04.\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tO array de retorno será multimensional, trazendo na primeira posição o identificador (ID), \r\n\t\t\t\t\tnasegunda posição a tag (o campo) e na terceira posição o conteúdo retornado do processo, \r\n\t\t\t\t\t\tpodendo ser um outro array com a mesma estrutura caso o ID possua abaixo de sua estrutura outros IDs.\t\t\t\t\t\t \t\t\t\t\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf !Empty((cAliasSD2)->D2_PREEMB) .and. ((cAliasSD2)->D2_DOC == (cAliasSD1)->D1_NFORI)\r\n\t\t\t\t\t\taExp:= {}\t\r\n\t\t\t\t\t\taadd(aExp,(GETNFEEXP((cAliasSD2)->D2_PREEMB,,cCodProd,(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE,(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV)))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElseiF AliasIndic(\"CDL\")\r\n\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\tDbSelectArea(\"CDL\")\r\n\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\tDbSeek(xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\t\t\t\t\tWhile !CDL->(Eof()) .And. CDL->CDL_FILIAL+CDL->CDL_DOC+CDL->CDL_SERIE+CDL->CDL_CLIENT+CDL->CDL_LOJA == xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA\r\n\t\t\t\t\t\t\tIf CDL->(FieldPos(\"CDL_PRODNF\")) <> 0 .And. CDL->(FieldPos(\"CDL_ITEMNF\")) <> 0 .And. AllTrim(CDL->CDL_PRODNF)+AllTrim(CDL->CDL_ITEMNF) == AllTrim((cAliasSD2)->D2_COD)+AllTrim((cAliasSD2)->D2_ITEM)\r\n\t\t\t\t\t\t\t\taDados := {}\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"I53\",\"nRE\", IIf(CDL->(ColumnPos(\"CDL_NRREG\"))>0,CDL->CDL_NRREG,\"\") })\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"I54\",\"chNFe\",SF2->F2_CHVNFE,\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"I55\",\"qExport\",(cAliasSD1)->D1_QUANT})\t\t\t\t\t\t\t    \r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t    \t\r\n\t\t\t\t\t\t\t\taAdd(aExp[Len(aExp)],aDados)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\t\t    \tCDL->(DbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\tEndIf\t\t\r\n\t\t\t\t\r\n\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t//|                                                             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\tDbSelectArea(\"SF2\")\r\n\t\t\t\tDbSetOrder(1)\r\n\t\t\t\tIf MsSeek(xFilial(\"SF2\")+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI)\r\n\t\t\t\t\tIf AllTrim(SF2->F2_ESPECIE)==\"CF\"\r\n\t\t\t\t\t\taadd(aRefECF,{SF2->F2_DOC,SF2->F2_ESPECIE,\"\"})\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf lEasy  .And. !Empty((cAliasSD1)->D1_TIPO_NF)\r\n\r\n\t\t\t\t\tcTipoNF \t:= (cAliasSD1)->D1_TIPO\r\n\t\t\t\t\tcDocEnt \t:= (cAliasSD1)->D1_DOC\r\n\t\t\t\t\tcSerEnt \t:= (cAliasSD1)->D1_SERIE\r\n\t\t\t\t\tcFornece\t:= (cAliasSD1)->D1_FORNECE\r\n\t\t\t\t\tcLojaEnt\t:= (cAliasSD1)->D1_LOJA\r\n\t\t\t\t\tcTipoNFEnt\t:= (cAliasSD1)->D1_TIPO_NF\r\n\t\t\t\t\tcPedido \t:= (cAliasSD1)->D1_PEDIDO\r\n\t\t\t\t\tcItemPC \t:= (cAliasSD1)->D1_ITEMPC\r\n\t\t\t\t\tcNFOri  \t:= (cAliasSD1)->D1_NFORI\r\n\t\t\t\t\tcSerOri \t:= (cAliasSD1)->D1_SERIORI\r\n\t\t\t\t\tcItemOri\t:= (cAliasSD1)->D1_ITEMORI\r\n\t\t\t\t\tcProd   \t:= (cAliasSD1)->D1_COD\r\n\t\t\t\t\tcLote\t\t:= (cAliasSD1)->D1_LOTECTL\r\n\t\t\t\t\tcItem\t\t:= (cAliasSD1)->D1_ITEM\r\n\r\n\t\t\t\t\tIf !cTipoNF$\"IPC\" .And. cTipoNFEnt <> \"6\"\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para TAG Importação quando existe a integração com a EIC  (Se a nota for primeira ou unica)|\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\taadd(aDI,(GetNFEIMP(.F.,cDocEnt,cSerEnt,cFornece,cLojaEnt,cTipoNFEnt,cPedido,cItemPC,cLote,cItem)))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para TAG Importação quando existe a integração com a EIC  (Se a nota for complementar)     |\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\taadd(aDI,(GetNFEIMP(.F.,cNFOri,cSerOri,cFornece,cLojaEnt,cTipoNFEnt, ,cItemOri, ,cItem )))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taAdi := aDI\r\n\t\t\t\t// Se não o parâmetro de integração entre o SIGAEIC e o SIGAFAT estiver desabilitado,\r\n\t\t\t\t//   procura as informações da importação da tabela CD5 (complemento de importação).\r\n\t\t\t\tElseIf !lEasy .Or. (lEasy .AND. (cAliasSD1)->D1_TIPO $ \"DCPI\")\r\n\t\t\t\t\tDbSelectArea(\"CD5\")\r\n\t\t\t\t\tDbSetOrder(4)\r\n\t\t\t\t\t// Procura algum registro na CD5 referente a nota que foi complementada\r\n\t\t\t\t\tIf MsSeek(xFilial(\"CD5\")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_ITEM)\r\n\t\t\t\t\t\t\taAdd(aDI,{;\r\n\t\t\t\t\t\t\t\t{\"I04\",\"NCM\",SB1->B1_POSIPI},;\t\t\t\t//1\r\n\t\t\t\t\t\t\t\t{\"I15\",\"vFrete\",0},;\t\t\t\t\t\t\t//2\r\n\t\t\t\t\t\t\t\t{\"I16\",\"vSeg\",0},;\t\t\t\t\t\t\t//3\r\n\t\t\t\t\t\t\t\t{\"I19\",\"nDI\",Iif(!Empty(CD5->CD5_NDI),CD5->CD5_NDI,\"NIHIL\")},;\t\t//4\r\n\t\t\t\t\t\t\t\t{\"I20\",\"dDI\",CD5->CD5_DTDI},;\t\t\t\t//5\r\n\t\t\t\t\t\t\t\t{\"I21\",\"xLocDesemb\",CD5->CD5_LOCDES},;\t\t//6\r\n\t\t\t\t\t\t\t\t{\"I22\",\"UFDesemb\",CD5->CD5_UFDES},;\t\t//7\r\n\t\t\t\t\t\t\t\t{\"I23\",\"dDesemb\",CD5->CD5_DTDES},;\t\t\t//8\r\n\t\t\t\t\t\t\t\t{\"I24\",\"cExportador\",CD5->CD5_CODEXP},;\t//9\r\n\t\t\t\t\t\t\t\t{\"I26\",\"nAdicao\",Val(CD5->CD5_NADIC)},;\t//10\r\n\t\t\t\t\t\t\t\t{\"I27\",\"nSeqAdi\",Val(CD5->CD5_SQADIC)},;\t//11\r\n\t\t\t\t\t\t\t\t{\"I28\",\"cFabricante\",CD5->CD5_CODFAB},;\t//12\r\n\t\t\t\t\t\t\t\t{\"I29\",\"vDescDI\",0},;\t\t\t\t\t\t//13\r\n\t\t\t\t\t\t\t\t{\"N14\",\"pRedBC\",0},;\t\t\t\t\t\t\t//14\r\n\t\t\t\t\t\t\t\t{\"O11\",\"qUnid\",0},;\t\t\t\t\t\t\t//15\r\n\t\t\t\t\t\t\t\t{\"O12\",\"vUnid\",0},;\t\t\t\t\t\t\t//16\r\n\t\t\t\t\t\t\t\t{\"P02\",\"vBC\",CD5->CD5_BCIMP},;\t\t\t\t//17\r\n\t\t\t\t\t\t\t\t{\"P03\",\"vDespAdu\",CD5->CD5_DSPAD},;\t\t\t//18\r\n\t\t\t\t\t\t\t\t{\"P04\",\"vII\",(cAliasSD1)->D1_II},;\t\t\t//19\r\n\t\t\t\t\t\t\t\t{\"P05\",\"vIOF\",CD5->CD5_VLRIOF},;\t\t\t//20\r\n\t\t\t\t\t\t\t\t{\"Q10\",\"qBCProd\",0},;\t\t\t\t\t\t//21\r\n\t\t\t\t\t\t\t\t{\"Q11\",\"vAliqProd\",0},;\t\t\t\t\t\t//22\r\n\t\t\t\t\t\t\t\t{\"S09\",\"qBCProd\",0},;\t\t\t\t\t\t//23\r\n\t\t\t\t\t\t\t\t{\"S10\",\"vAliqProd\",0},;\t\t\t\t\t\t//24\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t{\"X04\",\"CNPJ\",0},;\t\t\t\t\t\t\t//25\r\n\t\t\t\t\t\t\t\t{\"X06\",\"xNome\",0},;\t\t\t\t\t\t\t//26\r\n\t\t\t\t\t\t\t\t{\"X07\",\"IE\",0},;\t\t\t\t\t\t\t\t//27\r\n\t\t\t\t\t\t\t\t{\"X08\",\"xEnder\",0},;\t\t\t\t\t\t\t//28\r\n\t\t\t\t\t\t\t\t{\"X09\",\"xMun\",0},;\t\t\t\t\t\t\t//29\r\n\t\t\t\t\t\t\t\t{\"X10\",\"UF\",0},;\t\t\t\t\t\t\t\t//30\r\n\t\t\t\t\t\t\t\t{\"XXX\",\"Emaildesp\",0},;\t\t\t\t\t\t//31\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t{\"HOU\",\"house\",0},;\t\t\t\t\t\t\t//32\r\n\t\t\t\t\t\t\t\t{\"DES\",\"cDesp\",0},;\t\t\t\t\t\t\t//33\r\n\t\t\t\t\t\t\t\t{\"129A\",\"nDraw\",IIf(CD5->(FieldPos(\"CD5_ACDRAW\")) > 0,CD5->CD5_ACDRAW,\"\")},;\t\t\t//34\r\n\t\t\t\t\t\t\t\t{\"105a\",\"NVE\",0},;\t\t\t\t\t\t\t//35\r\n\t\t\t\t\t\t\t\t{\"I23a\",\"tpViaTransp\",IIf(CD5->(FieldPos(\"CD5_VTRANS\")) > 0,CD5->CD5_VTRANS,\"\")},;\t//36\r\n\t\t\t\t\t\t\t\t{\"I23b\",\"vAFRMM\",IIf(CD5->(FieldPos(\"CD5_VAFRMM\")) > 0,CD5->CD5_VAFRMM,\"\")},;\t\t\t//37\r\n\t\t\t\t\t\t\t\t{\"I23c\",\"tpIntermedio\",IIf(CD5->(FieldPos(\"CD5_INTERM\")) > 0,CD5->CD5_INTERM,\"\")},;\t//38\r\n\t\t\t\t\t\t\t\t{\"I23d\",\"CNPJ\",IIf(CD5->(FieldPos(\"CD5_CNPJAE\")) > 0,CD5->CD5_CNPJAE,\"\")},;\t\t\t//39\r\n\t\t\t\t\t\t\t\t{\"I23e\",\"UFTerceiro\",IIf(CD5->(FieldPos(\"CD5_UFTERC\")) > 0,CD5->CD5_UFTERC,\"\")}})\t//40\r\n\t\t\t\t\t\t// O array aAdi deve ser identico ao aDI para futuro tratamento neste fonte\r\n\t\t\t\t\t\taAdi := aDI\r\n\t\t\t\t\t// Caso nenhum registro de complemento de importação para essa nota exista, coloca os arrays em branco\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aAdi,{})\r\n\t\t\t\t\t\taadd(aDi,{})\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aAdi,{})\r\n\t\t\t\t\taadd(aDi,{})\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf (cAliasSD1)->D1_BASEIRR > 0  .And. (cAliasSD1)->D1_VALIRR > 0 \r\n\t\t\t\t\tnBaseIrrf += (cAliasSD1)->D1_BASEIRR\r\n\t\t\t\t\tnValIrrf  += (cAliasSD1)->D1_VALIRR \r\n\t\t\t\tEndIf\t\r\n\r\n\t\t\t\tIf AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0  .And. CD6->(FieldPos(\"CD6_BCCIDE\")) > 0 .And. CD6->(FieldPos(\"CD6_VALIQ\")) > 0 .And. CD6->(FieldPos(\"CD6_VCIDE\")) > 0\r\n\t\t\t\t\taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t         CD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t         CD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t         CD6->CD6_UFCONS,;\r\n\t\t\t\t\t\t         CD6->CD6_BCCIDE,;\r\n\t\t\t\t\t\t         CD6->CD6_VALIQ,;\r\n\t\t\t\t\t\t         CD6->CD6_VCIDE,;\r\n\t\t\t\t\t\t         IIf(CD6->(FieldPos(\"CD6_MIXGN\")) > 0,CD6->CD6_MIXGN,\"\"),;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_DESANP\")) > 0,CD6->CD6_DESANP,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_PGLP\")) > 0,CD6->CD6_PGLP,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_PGNN\")) > 0,CD6->CD6_PGNN,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_PGNI\")) > 0,CD6->CD6_PGNI,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_VPART\")) > 0,CD6->CD6_VPART,\"\"),;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t     0})\r\n\t\t\t    Elseif AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0 \r\n\t\t\t\t\taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_UFCONS,; \r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,; \r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aComb,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf AliasIndic(\"CD7\")\r\n\t\t\t\t\taadd(aMed,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,CD7->CD7_PRECO,IIf(CD7->(FieldPos(\"CD7_CODANV\")) > 0,CD7->CD7_CODANV,\"\"),IIf(CD7->(ColumnPos(\"CD7_MOTISE\")) > 0,CD7->CD7_MOTISE,\"\")})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aMed,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf AliasIndic(\"CD8\")\r\n\t\t\t\t\taadd(aArma,{CD8->CD8_TPARMA,CD8->CD8_NUMARM,CD8->CD8_DESCR})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aArma,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf AliasIndic(\"CD9\")\r\n\t\t\t\t\taadd(aveicProd,{CD9->CD9_TPOPER,CD9->CD9_CHASSI,CD9->CD9_CODCOR,CD9->CD9_DSCCOR,CD9->CD9_POTENC,CD9->CD9_CM3POT,CD9->CD9_PESOLI,;\r\n\t\t\t\t\t                CD9->CD9_PESOBR,CD9->CD9_SERIAL,CD9->CD9_TPCOMB,CD9->CD9_NMOTOR,CD9->CD9_CMKG,CD9->CD9_DISTEI,CD9->CD9_RENAVA,;\r\n\t\t\t\t\t                CD9->CD9_ANOMOD,CD9->CD9_ANOFAB,CD9->CD9_TPPINT,CD9->CD9_TPVEIC,CD9->CD9_ESPVEI,CD9->CD9_CONVIN,CD9->CD9_CONVEI,;\r\n\t\t\t\t\t                CD9->CD9_CODMOD,;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CILIND\")>0,CD9_CILIND,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_TRACAO\")>0,CD9_TRACAO,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_LOTAC\")>0,CD9_LOTAC,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CORDE\")>0,CD9_CORDE,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_RESTR\")>0,CD9_RESTR,\"\"))})\r\n\t\t\t\tElse\r\n\t\t\t\t    aadd(aveicProd,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento para Rastreamento de Lote - Cabecalho e Itens   \r\n\t\t\t\t// Primeiro busca no compl. de rastreabilidade (F0A) e  depois compl.de medicamento (CD7)                ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\tIf AliasIndic(\"F0A\")  .AND. F0A->(FieldPos(\"F0A_LOTE\")) > 0 .And. !Empty(F0A->F0A_LOTE)\t\r\n\t\t\t\t\taadd(aLote,{IIf(F0A->(FieldPos(\"F0A_LOTE\")) > 0,F0A->F0A_LOTE,\"\"),;\r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_QTDLOT\")) > 0,F0A->F0A_QTDLOT,\"\"),;\r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_FABRIC\")) > 0,F0A->F0A_FABRIC,\"\"),;\r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_VALID\")) > 0,F0A->F0A_VALID ,\"\"),;  \r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_CODAGR\")) > 0,F0A->F0A_CODAGR ,\"\")})  \r\n\t\t\t\tElseIf !Empty(aMed) .And. !Empty(aMed[1][1])\r\n\t\t\t\t\taadd(aLote,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,\"\"})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aLote,{})\r\n\t   \t\t\tEndIf\t\r\n\t   \t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento para Anfavea - Cabecalho e Itens                             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\r\n\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t//Cabecalho\r\n\t\t\t\t\taadd(aAnfC,{CDR->CDR_VERSAO,CDR->CDR_CDTRAN,CDR->CDR_NMTRAN,CDR->CDR_CDRECP,CDR->CDR_NMRECP,;\r\n\t\t\t\t\t\tAModNot(CDR->CDR_ESPEC),CDR->CDR_CDENT,CDR->CDR_DTENT,CDR->CDR_NUMINV}) \r\n\t\t\t\t\t//Itens\r\n\t\t\t\t\taadd(aAnfI,{CDS->CDS_PRODUT,CDS->CDS_PEDCOM,CDS->CDS_SGLPED,CDS->CDS_SEPPEN,CDS->CDS_TPFORN,;\r\n\t\t\t\t\t\tCDS->CDS_UM,CDS->CDS_DTVALI,CDS->CDS_PEDREV,CDS->CDS_CDPAIS,CDS->CDS_PBRUTO,CDS->CDS_PLIQUI,;\r\n\t\t\t\t\t\tCDS->CDS_TPCHAM,CDS->CDS_NUMCHA,CDS->CDS_DTCHAM,CDS->CDS_QTDEMB,CDS->CDS_QTDIT,CDS->CDS_LOCENT,;\r\n\t\t\t\t\t\tCDS->CDS_PTUSO,CDS->CDS_TPTRAN,CDS->CDS_LOTE,CDS->CDS_CPI,CDS->CDS_NFEMB,CDS->CDS_SEREMB,;\r\n\t\t\t\t\t\tCDS->CDS_CDEMB,CDS->CDS_AUTFAT,CDS->CDS_CDITEM})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aAnfC,{})\r\n\t\t\t\t\taadd(aAnfI,{})\r\n\t   \t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\tIf !(cAliasSD1)->D1_TIPO $ \"DB\"\t\t\t\r\n\t\t\t\t\tdbSetOrder(2)\r\n\t\t\t\tElse\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf SFT->(DbSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+D1_ITEM+D1_COD)))\r\n\t\t\t\t   aadd(aCSTIPI,{SFT->FT_CTIPI})\r\n\t\t\t\t   //TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t\t   //PEGA OS VALORES E PERCENTUAL DO INNCENTIVO NOS ITENS NA SFT.\r\n\t\t\t\t   If SFT->(FieldPos(\"FT_PRINCMG\")) > 0 .And. SFT->(FieldPos(\"FT_VLINCMG\")) > 0\r\n\t\t\t\t\t\tIf SFT->FT_VLINCMG > 0\r\n\t\t\t\t\t\t\tnValLeite += SFT->FT_VLINCMG\r\n\t\t\t\t\t\t\taprod[Len(aProd)][49]:=  SFT->FT_VLINCMG\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf nPercLeite == 0 .And. SFT->FT_PRINCMG > 0 \r\n\t\t\t\t\t\t\tnPercLeite := SFT->FT_PRINCMG\r\n\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\tEndIF\r\n\t\t\t\tElseIf substr((cAliasSD1)->D1_CF,1,1) ==\"3\"\r\n\t\t\t\t\taadd(aCSTIPI,{SF4->F4_CTIPI})\t\t\t\t\t\t\t\t\r\n\t\t\t\tEndIf \r\n\t\t\t\t\r\n\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t//Posiciona novente na SF1 do documento que esta sendo processado\t\t\t\t\r\n\t\t\t\tSF1->(MsSeek(xFilial(\"SF1\")+(cAliasSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_TIPO)))\r\n\t\t\t\tCD2->(MsSeek(xFilial(\"CD2\")+\"E\"+SF1->F1_SERIE+SF1->F1_DOC+SF1->F1_FORNECE+SF1->F1_LOJA+PadR((cAliasSD1)->D1_ITEM,4)+(cAliasSD1)->D1_COD))\r\n\t\t\t\tWhile !CD2->(Eof()) .And. xFilial(\"CD2\") == CD2->CD2_FILIAL .And.;\r\n\t\t\t\t\t\"E\" == CD2->CD2_TPMOV .And.;\r\n\t\t\t\t\tSF1->F1_SERIE == CD2->CD2_SERIE .And.;\r\n\t\t\t\t\tSF1->F1_DOC == CD2->CD2_DOC .And.;\r\n\t\t\t\t\tSF1->F1_FORNECE == IIF(!(cAliasSD1)->D1_TIPO $ \"DB\",CD2->CD2_CODFOR,CD2->CD2_CODCLI) .And.;\r\n\t\t\t\t\tSF1->F1_LOJA == IIF(!(cAliasSD1)->D1_TIPO $ \"DB\",CD2->CD2_LOJFOR,CD2->CD2_LOJCLI) .And.;\t\t\t\t\r\n\t\t\t\t\t(cAliasSD1)->D1_ITEM == SubStr(CD2->CD2_ITEM,1,Len((cAliasSD1)->D1_ITEM)) .And.;\r\n\t\t\t\t\t(cAliasSD1)->D1_COD == CD2->CD2_CODPRO\r\n\t\t\t\t\t\r\n\t\t\t\t\tnMargem :=  IiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC == 100,CD2->CD2_PREDBC,IF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC)),IiF(Len(aAdI[1])>0 .And. ConvType(aAdI[1][04][01]) == \"I19\",IiF((aAdi[1][14][03]) > 100,0,aAdi[1][14][03]),CD2->CD2_PREDBC))\r\n\t\t\t\t\t\r\n\t\t\t\t\tSF7->(DbSetOrder(1))\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tSA2->(DbSetOrder(1))\r\n\t\t\t\t\tSA1->(DbSetOrder(1))\r\n\r\n\t\t\t\t\tIF !(cAliasSD1)->D1_TIPO $ \"DB\"\r\n\t\t\t\t\t\tIf SA2->(DbSeek(xFilial(\"SA2\")+SF1->F1_FORNECE+SF1->F1_LOJA))\r\n\t\t\t\t\t\t\tIf SF7->(DbSeek(xFilial(\"SF7\")+SB1->B1_GRTRIB+SA2->A2_GRPTRIB))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf  SF7->F7_BASEICM > 0 .And. SF7->F7_BASEICM < 100\r\n\t\t\t\t\t\t\t\t\tnMargem :=  100 - SF7->F7_BASEICM\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n            \t        EndIf\r\n                    Else\r\n\t\t\t\t\t\tIf SA1->(DbSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA))\r\n\t\t\t\t\t\t\tIf SF7->(DbSeek(xFilial(\"SF7\")+SB1->B1_GRTRIB+SA1->A1_GRPTRIB))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf  SF7->F7_BASEICM > 0 .And. SF7->F7_BASEICM < 100\r\n\t\t\t\t\t\t\t\t\tnMargem :=  100 - SF7->F7_BASEICM\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n            \t        EndIf                    \r\n                    EndIf \r\n                    // Verifica se existe percentual de reducao na SFT referente ao RICMS 43080/2002 MG.\r\n\t\t\t\t\tIf SFT->(FieldPos(\"FT_PR43080\")) <> 0 .And. SFT->FT_PR43080 <> 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\t\tnMargem := SFT->FT_PR43080\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf SubStr((cAliasSD1)->D1_CLASFIS,2,2) $ '51'\t .and. !Empty(SFT->FT_ICMSDIF)           .and. SFT->(ColumnPos(\"FT_VOPDIF\")) > 0  .and. !Empty(SFT->FT_VOPDIF) .or.; // verifica diferimento com bloqueio de movimento\r\n\t\t\t\t\t\tSubStr((cAliasSD1)->D1_CLASFIS,2,2) $ '51' .and. !Empty((cAliasSD1)->(D1_ICMSDIF)) .and. SD1->(ColumnPos(\"D1_VOPDIF\")) > 0  .and. !Empty((cAliasSD1)->(D1_VOPDIF)) .and. SF1->(F1_STATUS) == 'C'\r\n\t\t\t\t\t\tlDifer :=.T.\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tlDifer := .F. //Reinicialização da variável\r\n\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tDo Case\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ICM\"\r\n\t\t\t\t\t\t\taTail(aICMS) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\t\t  CD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\t\t  CD2->CD2_MODBC,; \r\n\t\t\t\t\t\t\t                  nMargem,;// Tratamento para obter o percentual da redução de base do icms nota interna e importacao(integracao com EIC)\t\t\t\t\t\t\t                  \r\n\t\t\t\t\t\t\tCD2->CD2_BC,;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), If(lNfCupZero,0,Iif(CD2->CD2_BC>0,xFisRetFCP('4.0','CD2','CD2_ALIQ'),0)), Iif(CD2->CD2_BC>0,CD2->CD2_ALIQ,0)),;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), iif(!lDifer,xFisRetFCP('4.0','CD2','CD2_VLTRIB'),iif(SF1->(F1_STATUS) == 'C',(cAliasSD1)->(D1_VOPDIF),xFisRetFCP('4.0','SFT','FT_VOPDIF'))),Iif(!lDifer,CD2->CD2_VLTRIB,SFT->FT_VOPDIF)),;//Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), Iif(!lDifer,xFisRetFCP('4.0','CD2','CD2_VLTRIB'),xFisRetFCP('4.0','SFT','FT_VOPDIF')), Iif(!lDifer,CD2->CD2_VLTRIB,SFT->FT_VOPDIF)),; \r\n\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\"),;\r\n\t\t\t\t\t\t\tIIF(SF1->(F1_STATUS) == 'C', (cAliasSD1)->(D1_ICMSDIF),SFT->FT_ICMSDIF),;\r\n\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\tSF4->F4_ICMSDIF,;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,CD2->CD2_BFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,CD2->CD2_PFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,CD2->CD2_VFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BSTANT\")) > 0,SFT->FT_BSTANT,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_VSTANT'),0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_PSTANT'),0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BFCANTS\")) > 0,SFT->FT_BFCANTS,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PFCANTS\")) > 0,SFT->FT_PFCANTS,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VFCANTS\")) > 0,SFT->FT_VFCANTS,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VICPRST\")) > 0,SFT->FT_VICPRST,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,0)}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnCon++\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\tnValICMParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\tnBasICMParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"SOL\"\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taTail(aICMSST) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\tCD2->CD2_PREDBC,;\r\n\t\t\t\t\t\t\tCD2->CD2_BC,;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_ALIQ'),CD2->CD2_ALIQ),;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'),CD2_VLTRIB),;\r\n\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,CD2->CD2_BFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,CD2->CD2_PFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,CD2->CD2_VFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\")}   \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf lConsig .And. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM)  .And. CD2->CD2_VLTRIB > 0\r\n\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\")}\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\tnValSTParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\tnBasSTParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tlCalSol := .T.\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Tratamento CAT04 de 26/02/2010                       ³\r\n\t\t\t\t\t\t\t//³Verifica de deve ser garavado no xml o valor e base  ³\r\n\t\t\t\t\t\t\t//³de calculo do ICMS ST para notas fiscais de devolucao³\r\n\t\t\t\t\t\t\t//³Verifica o parametro MV_ICSTDEV                      ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnValST \t:= Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'), CD2->CD2_VLTRIB)\r\n\t\t\t\t\t\t\t//para a 4.0 devera exibir a informação Valor do ICMS ST não majorado.\r\n\t\t\t\t\t\t\tIf cVerAmb == \"4.00\" .and. nValST > 0 .And. lConsig\r\n\t\t\t\t\t\t\t\tnSTConsig += nValST\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf !lIcmSTDev\r\n\t\t\t\t\t\t\t\tIf ( (cAliasSD1)->D1_TIPO==\"D\" .Or. ( (cAliasSD1)->D1_TIPO==\"I\" .And. lComplDev)) .And. !Empty(nValST) \r\n\t\t\t\t\t\t\t\t\tnValSTAux := nValSTAux + nValST\r\n\t\t\t\t\t\t\t\t\tnBsCalcST := nBsCalcST + CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\tnValST \t  := 0\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\")}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t   \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"IPI\"\r\n\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_QTRIB,CD2->CD2_PAUTA,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_MODBC,CD2->CD2_PREDBC}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnValIPI := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf (((cAliasSD1)->D1_TIPO == \"D\" .and. !lEipiDev))  .Or. ((cAliasSD1)->D1_TIPO == \"B\" .And. lIpiBenef .and. !Empty(nValIPI)) .Or. lEIPIOutro .Or. lIPIOutB\r\n\t\t\t\t   \t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"B\" .And. lIpiBenef .and. !Empty(nValIPI)) .or. lIPIOutB\r\n\t\t\t\t   \t\t\t\t\tnValIpiBene += nValIPI  // Quando lIpiBenef = T leva IPI em vOutro e Inf. Adic.\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t \r\n\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,CD2->CD2_PREDBC}\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t/*Chamado TTVZJG - Grupo impostoDevol - informar o percentual e valor do IPI devolvido, em notas de devolução (finNFe =4)\r\n\t\t\t\t\t\t\tIncluida a verificação do campo F4_PODER3=D para os casos de retorno de beneficiamento*/\r\n\t\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"D\" .Or. SF4->F4_PODER3 == \"D\") .And. ((CD2->(FieldPos(\"CD2_PDEVOL\")) > 0 .And. !Empty(CD2->CD2_PDEVOL) .Or. (SF4->F4_QTDZERO == \"1\")) .And. cTPNota == \"4\")\r\n\t\t\t\t\t\t\t\tIf (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM )\r\n\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}\r\n\t\t\t\t\t\t\t\tElseIf cVerAmb >= \"4.00\" .And. (((cAliasSD1)->D1_TIPO == \"D\" .and. (lEipiDev .Or. lEIPIOutro)) .or.((cAliasSD1)->D1_TIPO == \"B\" .and. (!lIpiBenef .Or. lIPIOutB)))\r\n\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,0}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf        \t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS2\"\r\n\t\t\t\t\t\t\tIf (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\t\taTail(aPIS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\taISS[04]          += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF2\"\r\n\t\t\t\t\t\t\tIf (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\t\taTail(aCOFINS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\taISS[05] += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS3\" .And. (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\taTail(aPISST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF3\" .And. (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\taTail(aCOFINSST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ISS\"\r\n\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\taISS[01] += (cAliasSD1)->D1_TOTAL\r\n\t\t\t\t\t\t\taISS[02] += CD2->CD2_BC\r\n\t\t\t\t\t\t\taISS[03] += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\r\n\t\t\t\t\t\t\t\tIf SF3->F3_RECISS ==\"1\"\r\n\t\t\t\t\t\t\t\t\tcSitTrib := \"R\"\r\n\t\t\t\t\t\t\t\tElseif SF3->F3_RECISS ==\"2\"\r\n\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\tElseif SF4->F4_LFISS ==\"I\"\r\n\t\t\t\t\t\t\t\t\tcSitTrib:= \"I\"\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF SF4->F4_ISSST == \"1\" .or. Empty(SF4->F4_ISSST)\r\n\t\t\t\t\t\t\t\tcIndIss := \"1\" //1-Exigível;\r\n\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"2\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"2\"\t//2-Não incidência\r\n\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"3\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"3\" //3-Isenção\r\n\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"4\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"5\"\t //5-Imunidade\r\n\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"5\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"6\"\t //6-Exigibilidade Suspensa por Decisão Judicial\r\n\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"6\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"7\"\t //7-Exigibilidade Suspensa por Processo Administrativo\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcIndIss := \"4\"//4-Exportação\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Pega as deduções ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSSUB\"))>0\r\n\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSSUB\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSMAT\"))>0\r\n\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSMAT\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Verifica se recolhe ISS Retido ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t\tIf SF3->F3_RECISS $\"1|S\"  \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tnValISSRet := SFT->FT_VALICM // Valor do ISSRET por item\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t// If SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t// \tIf SF3->F3_RECISS $\"1|S\"       \r\n\t\t\t\t\t\t\t// \t\tIf SF3->(dbSeek(xFilial(\"SF3\")+SF1->F1_FORNECE+SF1->F1_LOJA+SF1->F1_DOC+SF1->F1_SERIE))\r\n\t\t\t\t\t\t\t// \t\t\tWhile !SF3->(EOF()) .And. xFilial(\"SF3\")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE==SF1->F1_FILIAL+SF1->F1_FORNECE+SF1->F1_LOJA+SF1->F1_DOC+SF1->F1_SERIE\r\n\t\t\t\t\t\t\t// \t\t\t\tIf SF3->F3_TIPO==\"S\" //Serviço\r\n\t\t\t\t\t\t\t// \t\t\t\t\tnValISSRet+= SF3->F3_VALICM\r\n\t\t\t\t\t\t\t// \t\t\t\tEndIf\r\n\t\t\t\t\t\t\t// \t\t\t\tSF3->(dbSkip())\r\n\t\t\t\t\t\t\t// \t\t\tEndDo\r\n\t\t\t\t\t\t\t// \t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t   \t// \tEndif\r\n\t\t\t\t\t\t\t// EndIf\r\n\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taTail(aISSQN) := {CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,\"\",AllTrim((cAliasSD1)->D1_CODISS),cSitTrib,nDeducao,cIndIss,nValISSRet}\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CMP\" //ICMSUFDEST\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taTail(aICMUFDest) := {IIf(CD2->CD2_BC > 0,CD2->CD2_BC, 0),; //[1]vBCUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PFCP\")) > 0 .and. CD2->CD2_PFCP > 0,CD2->CD2_PFCP,0),;  //[2]pFCPUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->CD2_ALIQ > 0,CD2->CD2_ALIQ,0),;//[3]pICMSUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_ADIF\")) > 0 .and. CD2->CD2_ADIF > 0,CD2->CD2_ADIF,0),;//[4]pICMSInter\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PDDES\")) > 0 .and. CD2->CD2_PDDES > 0,CD2->CD2_PDDES,0),;//[5]pICMSInterPart\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VFCP\")) > 0 .and. CD2->CD2_VFCP > 0,CD2->CD2_VFCP,0),;//[6]vFCPUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VDDES\")) > 0 .and. CD2->CD2_VDDES > 0,CD2->CD2_VDDES,0),;//[7]vICMSUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VLTRIB\")) > 0 .and. CD2->CD2_VLTRIB > 0,CD2->CD2_VLTRIB,0)}//[8]vICMSUFRemet\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ZFM\"\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tcICMSZFM := If(CD2->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,\"\")\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndCase\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf nValSTAux > 0 \r\n\t\t\t\t\t\tcValST  := AllTrim(Str(nValSTAux,15,2))\r\n\t\t\t\t\t\tcBsST   := AllTrim(Str(nBsCalcST,15,2))\r\n\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\tIf lComplDev .And.  nBsCalcST == 0\r\n\t\t\t\t\t\t\tcMensCli += \"(Valor do ICMS ST: R$ \"+cValST+\") \" \t\t\t\t\t\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS ST: R$ \"+cBsST+ \" - \"+\"Valor do ICMS ST: R$ \"+cValST+\") \"\r\n\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\tcValST\t  := \"\"  \r\n\t\t\t\t\t\tcBsST \t  := \"\"   \r\n\t\t\t\t\t\tnBsCalcST := 0\r\n\t\t\t\t\t\tnValSTAux := 0\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\tEndDo\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf SFT->FT_DESCZFR>0  .OR. !Empty(cICMSZFM)\r\n\t\t\t\t\taadd(aICMSZFM,{If(SFT->(ColumnPos(\"FT_DESCZFR\")) > 0,SFT->FT_DESCZFR,\"\"),;\r\n\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\"),;\r\n\t\t\t\t\tcICMSZFM})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aICMSZFM,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"SFT\") //Livro Fiscal Por Item da NF\r\n\t\t\t\tdbSetOrder(1) //FT_FILIAL+FT_TIPOMOV+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM+FT_PRODUTO\r\n\t\t\t\tIf MsSeek(xFilial(\"SFT\")+\"E\"+SF1->F1_SERIE+SF1->F1_DOC+SF1->F1_FORNECE+SF1->F1_LOJA+PadR((cAliasSD1)->D1_ITEM,4)+(cAliasSD1)->D1_COD) .And. ;\r\n\t\t\t\t\tSFT->(FieldPos(\"FT_CSTPIS\")) > 0 .And. SFT->(FieldPos(\"FT_CSTCOF\")) > 0\r\n\t\t\t\t\t\r\n\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SFT->FT_CSTPIS)\r\n\t\t\t\t\t\taTail(aPisAlqZ):= {SF4->F4_CSTPIS}\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SFT->FT_CSTCOF)\r\n\t\t\t\t\t\taTail(aCofAlqZ):= {SF4->F4_CSTCOF}\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tElse\r\n\r\n\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SF4->F4_CSTPIS)\r\n\t\t\t\t\t\taTail(aPisAlqZ):= {SF4->F4_CSTPIS}\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SF4->F4_CSTCOF) \r\n\t\t\t\t\t\taTail(aCofAlqZ):= {SF4->F4_CSTCOF}\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf !Len(aCofAlqZ)>0 .Or. !Len(aPisAlqZ)>0\r\n\t\t\t\t\taadd(aCofAlqZ,{})\r\n\t\t\t\t\taadd(aPisAlqZ,{})\r\n\t\t\t\tEndif\r\n\t\t\t\t\r\n\t\t\t\tIf SF4->(FieldPos(\"F4_CSOSN\"))>0\r\n\t\t\t\t\taTail(aCsosn):= SF4->F4_CSOSN\r\n\t\t\t\tElse\r\n\t\t\t\t\taTail(aCsosn):= \"\"\r\n\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf !Len(aCsosn)>0 \r\n\t\t\t\t\taTail(aCsosn):= \"\"\r\n\t\t\t\tEndIf                \r\n                         \r\n\t           //Tratamento para que o valor de PIS ST e COFINS ST venha a compor o valor total da tag vOutros  (NT 2011/004). E devolução de compra com IPI não tributado apenas para saida\r\n\t\t\t\t//Tratamento para que ao transmitir uma nota de devolução leve o valor do IPI conforme configurado o parametro MV_EIPIDEV.\r\n\t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"D\" .and. !lIpiDev .and. cTipo == \"1\")  .Or. ((cAliasSD1)->D1_TIPO == \"D\" .and. !lEipiDev ) .Or. lConsig .Or. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM ) .OR. ((cAliasSD1)->D1_TIPO == \"B\" .and. lIpiBenef) .OR. ((cAliasSD1)->D1_TIPO==\"P\" .And. lComplDev .And. !lIpiDev) .OR. lEIPIOutro .Or. lIPIOutB\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"D\" .and.  lEIPIOutro ) .or. ((cAliasSD1)->D1_TIPO == \"B\" .and.  lIPIOutB)\r\n\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n\t\t\t\t\tEndIf \r\n\r\n\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\taTotal[01] += 0\t\r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taTotal[01] += (cAliasSD1)->D1_VALIPI\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\taTotal[01] += (cAliasSD1)->D1_DESPESA + (cAliasSD1)->D1_VALPS3 + (cAliasSD1)->D1_VALCF3 + nIcmsST + nCrdPres\r\n\t\t\t\t\t\r\n\t\t\t\tIf (cAliasSD1)->D1_TIPO $ \"I\"\r\n\t\t\t\t\tIf (cAliasSD1)->D1_ICMSRET > 0\r\n\t\t\t\t\t\taTotal[02] += (cAliasSD1)->D1_ICMSRET\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taTotal[02] += 0\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\t\t\t\t\r\n\t\t\t\t\taTotal[02] += ((cAliasSD1)->D1_TOTAL-(cAliasSD1)->D1_VALDESC+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA;\r\n\t\t\t\t\t+ IIF(SD1->(ColumnPos('D1_AFRMIMP'))>0,(cAliasSD1)->D1_AFRMIMP,0);\r\n\t\t\t\t\t+ IIF(((cAliasSD1)->D1_TIPO $\"IP\" .Or. ((cAliasSD1)->D1_TIPO == \"D\" .And. cTpOrig == \"P\")),0,(cAliasSD1)->D1_VALIPI)+(cAliasSD1)->D1_ICMSRET + (cAliasSD1)->D1_VALPS3 + (cAliasSD1)->D1_VALCF3;      \r\n\t\t\t\t\t+ IIF(SF4->F4_AGREG   $ \"IB\",(cAliasSD1)->D1_VALICM,0\t);\r\n\t\t\t\t\t+ IIF(SF4->F4_AGRPIS  $ \"1P\",(cAliasSD1)->D1_VALIMP6,0\t);\r\n\t\t\t\t\t+ IIF(SF4->F4_AGRCOF  $ \"1C\",(cAliasSD1)->D1_VALIMP5,0\t));\r\n\t\t\t\t\t-(IIF(SF4->F4_AGREG  $ \"D\",(cAliasSD1)->D1_DESCICM,0\t));\r\n\t\t\t\t\t-(IIF(SF4->F4_AGREG  $ \"N\",(cAliasSD1)->D1_TOTAL,0\t\t));\r\n\t\t\t\t\t-(IIF(SF4->F4_INCSOL $ \"N\",(cAliasSD1)->D1_ICMSRET,0\t));\r\n\t\t\t\t\t-(IIF(Alltrim(SF4->F4_AGRPIS)  $ \"D\",(cAliasSD1)->D1_VALIMP6,0\t));\r\n\t\t\t\t\t-(IIF(Alltrim(SF4->F4_AGRCOF)  $ \"D\",(cAliasSD1)->D1_VALIMP5,0\t))\r\n\t\t\t\tEndIf\r\n\t\t\t\tdbSelectArea(cAliasSD1)\r\n\t\t\t\tdbSkip()\r\n\t\t    EndDo\t\r\n\r\n\t\t\t\t   \t\r\n\t\t    //Retira o desconto referente ao RICMS 43080/2002\r\n\t\t    If nDesTotal > 0\r\n\t\t    \taTotal[2] -= nDesTotal\r\n\t\t    EndIf\r\n\t\t    \r\n\t\t\tIf nBaseIrrf > 0 .And. nValIrrf > 0\r\n\t\t\t\taadd(aRetido,{\"IRRF\",nBaseIrrf,nValIrrf})\r\n\t\t\tEndIf\r\n\t\t\t//TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t//INSERE MSG EM INFADFISCO E SOMA NO TOTAL DA NOTA.\r\n\t\t\tIf nValLeite > 0 .And. nPercLeite > 0\r\n\t\t\t\tcMensFis += Alltrim(Str(nPercLeite,10,2))+'% Incentivo à produção e à industrialização do leite = R$ '+ Alltrim(Str(nValLeite,10,2))\r\n\t\t\t\taTotal[02] += nValLeite\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t//Operação com diferimento parcial de 66,66% do RICMS/PR\r\n\t\t\tIf nValIcmDev > 0 .And. nValIcmDif > 0\r\n\t\t\t\tcMensFis +=\t\"Operacao com diferimento parcial de 66,66% do imposto no valor de R$ \" + Alltrim(Str(nValIcmDif,10,2)) + \" - \"\r\n\t\t\t\tcMensFis += \"ICMS devido de R$ \" + Alltrim(Str(nValIcmDev,10,2)) + \", \"\r\n\t\t\t\tcMensFis += \"nos termos do Art 459 do DECRETO N.º 7.871/2017 - RICMS/PR\" //ISSUE DSERTSS1-6543 - Decreto 7.871 que revoga o regulamento do ICMS aprovado pelo decreto n 6080 de 28 de setembro de 2012.\r\n\t\t\tEndif\r\n\t\t\t\r\n\t\t\tIf nValSTAux > 0 \r\n\t\t\t\tcValST  := AllTrim(Str(nValSTAux,15,2))\r\n\t\t\t\tcBsST   := AllTrim(Str(nBsCalcST,15,2))\r\n\t\t\t\tcMensCli += \" \"\r\n\t\t\t\tIf lComplDev .And.  nBsCalcST == 0\r\n\t\t\t\t\tcMensCli += \"(Valor do ICMS ST: R$ \"+cValST+\") \" \t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS ST: R$ \"+cBsST+ \" - \"+\"Valor do ICMS ST: R$ \"+cValST+\") \"\r\n\t\t\t\tEndIF\t\r\n\t\t\t\tcValST\t  := \"\"  \r\n\t\t\t\tcBsST \t  := \"\"   \r\n\t\t\t\tnBsCalcST := 0\r\n\t\t\t\tnValSTAux := 0\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017) \r\n\t\t\tIf \tlIcmsPR .And. nToTvBC > 0 .And. nToTvICMS > 0 \t\t\t\t\t\t\t\t   \r\n\t\t\t\tcMensCli += \"(Base de Calculo do ICMS : R$ \"+nToTvBC+ \" - \"+\"Valor do ICMS : R$ \"+nToTvICMS+\") \"\r\n\t\t\tEndif\r\n\t\t    \r\n\t\t    If lQuery\r\n\t\t    \tdbSelectArea(cAliasSD1)\r\n\t\t    \tdbCloseArea()\r\n\t\t    \tdbSelectArea(\"SD1\")\r\n\t\t    EndIf\r\n\t\tEndIf\r\n\t\t//Tratamento para incluir a mensagem em informacoes adicionais do FECP -DF - MG - PR - RJ - RS.\r\n\t\tIf nValTFecp > 0\r\n\t\t\tIf cVerAmb >= \"4.00\"\r\n\t\t\t\tcMensFis += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\tElse\r\n\t\t\t\tcMensCli += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\r\nEndIf\r\n\r\n//Tratamento para que o valor de ValII venha compor o total da nota quando o parametro MV_EIC0064 for = .T. \r\nIf len(aDI)> 0\r\n\tFor nX := 1 To Len(aDI)\r\n\t\tIF  Len(aDI[nX])> 0\r\n\t\t\tIF Len(aDI[nX][19]) > 0 .and. lEIC0064 \r\n\t\t\t\taTotal[02]+= aDI[nX][19][03]   //ValIIaDI\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext\r\nEndIf\t\t\r\n\r\nIf FunName() <> \"SPEDNFSE\"\r\n\tIF cVeramb >= \"4.00\"\r\n\t   //Ajute para alimentar o aDetPag\r\n\t\tcTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,aProd[1,7])\r\n\t\t\r\n\t\t//Indicador da Forma de Pagamento\r\n\t\tcIndPag := IIF((Len(aDupl)==1 .And. aDupl[01][02]<=DataValida(aNota[03]+1,.T.)) .Or. Len(aDupl)==0,\"0\",\"1\")\t\r\n\r\n\t\tIf cTipo == \"1\"\r\n\t\t  cChvPag := SF2->F2_COND\r\n\t\tElse\r\n\t\t  cChvPag := SF1->F1_COND\r\n\t\tEndIf\r\n\r\n\t\tIf\tcTPNota $ '3-4'\r\n\t\t\t\r\n\t\t\tcForma := \"90\"  //90=Sem Pagamento.\r\n\t\t\taadd(aDetPag, {cForma, aTotal[2]+aTotal[03], 0.00, \"\", \"\", \"\", \"\", cIndPag})   \r\n\t\tElseIf (lVLojaDir .OR. !Empty(POSICIONE(\"SL1\",2,xFilial(\"SL1\")+SF2->F2_SERIE+SF2->F2_DOC,\"L1_NUM\"))) .And. cTipo == \"1\" .And. ( aRetPgLoj := GetPagLoja(aDupl, cChvPag, aTotal[2], cIndPag,cVerAmb) )[1]\r\n\t\t\t//Montagem do AdetPag quando venda for advindo do Venda Direta ou SigaLoja e condição de pagamento for = \"CN\"(Condicao Negociada)\r\n\t\t\t//Alem disso verifico se existem o registro na SL4, caso não, mantenho o legado anterior\r\n\t\t\taDetPag := aRetPgLoj[2]\t\r\n\t\tElse\t\t\r\n\t\t\t//caso tenha escolhido a forma de pagamento no cadastro de condição de pagamento.\r\n\t\t\tdbSelectArea(\"SE4\")\r\n\t\t\tdbSetOrder(1)\t\r\n\t\t\tIf DbSeek(xFilial(\"SE4\")+cChvPag)\r\n\t\t\t\tcForma := GetFormPgt(Alltrim(SE4->E4_FORMA), aDupl)\r\n\t\t\tElse\r\n\t\t\t\tcForma := GetFormPgt(\"\", aDupl)\t\r\n\t\t\tEndIf\r\n\t\t\taadd(aDetPag, {cForma, aTotal[2]+aTotal[03], 0.00, \"\", \"\", \"\", \"\", cIndPag})   \r\n\t\tEndIf\t\r\n\t\t\r\n\t\t//Exemplo de como gerar o Grupo Cobrança\r\n\t\t//aadd(aFat,{\"Número da Fatura\",Valor Original da Fatura,Valor do desconto,Valor Líquido da Fatura})   \r\n\t\t\r\n\tEndIf\r\nEndIf\r\n\r\n//Tratamento para que se caso mude o cliente o mesmo busque dados do cliente da nota original.\r\nIf lHistTab .and. !Empty(aNfVinc) .and. aNota[5] == \"D\"\r\n \taDest := AjustaDest(aDest,aNfVinc,cCliefor,cLoja)\r\nendif\r\n\r\nIF lPe01Nfe     \r\n\r\n\r\n\taParam := {aProd,cMensCli,cMensFis,aDest,aNota,aInfoItem,aDupl,aTransp,aEntrega,aRetirada,aVeiculo,aReboque,aNfVincRur,aEspVol,aNfVinc,aDetPag,aObsCont,aProcRef}\r\n\r\n\taParam := ExecBlock(\"PE01NFESEFAZ\",.F.,.F.,aParam)\r\n\t\r\n\tIf ( Len(aParam) >= 5 )\r\n\t\taProd\t\t:= aParam[1]\r\n\t\tcMensCli\t:= aParam[2]\r\n\t\tcMensFis\t:= aParam[3]\r\n\t\taDest \t\t:= aParam[4]\r\n\t\taNota \t\t:= aParam[5]\r\n\t\taInfoItem\t:= aParam[6]  \r\n\t\taDupl\t\t:= aParam[7]\r\n\t\taTransp\t\t:= aParam[8]\r\n\t\taEntrega\t:= aParam[9]\r\n\t\taRetirada\t:= aParam[10]\r\n\t\taVeiculo\t:= aParam[11]\r\n\t\taReboque\t:= aParam[12]\r\n\t\taNfVincRur\t:= aParam[13]\r\n\t\taEspVol     := aParam[14]\r\n\t\taNfVinc\t\t:= aParam[15]\r\n\t\tIf ( Len(aParam) >= 16 )\r\n\t\t\taDetPag\t\t:= aParam[16]\r\n\t\tEndIf\r\n\t\tIf ( Len(aParam) >= 17)\r\n\t\t\taObsCont    := aParam[17]\r\n\t\tEndIf\t\r\n\t\tIf ( Len(aParam) >= 18)\r\n\t\t\taProcRef    := aParam[18]\r\n\t\tEndIf\r\n\t\r\n\tEndIf\r\nEndif \r\n\r\n/* PONTO DE ENTRADA PARA TRATAMENTO SEGMENTO GRANITO BRUNO SIGAWISE */                      \r\nIf ExistBlock(\"PEGRNFESEFAZ\")                        \r\n\tIf AllTrim(aNota[1]) = \"2\"\r\n\t\taParam := {aNota,aProd,aIcms,aIcmsSt,aIpi,aICMUFDest,aPis,aCOFINS,aExp,aEspVol,aICMSZFM,aNfVinc}\r\n\t\taParam := ExecBlock(\"PEGRNFESEFAZ\",.F.,.F.,aParam)\r\n\t\t\r\n\t\taProd      := aParam[1]\r\n\t\taIcms      := aParam[2]\r\n\t\taIcmsSt    := aParam[3]\r\n\t\taIpi       := aParam[4]        \r\n\t\taICMUFDest := aParam[5]\r\n\t\taPis       := aParam[6]\r\n\t\taCOFINS    := aParam[7]\r\n\t\taExp       := aParam[8]\r\n\t\taEspVol    := aParam[9]\r\n\t\taICMSZFM   := aParam[10]\r\n\t\taNfVinc    := aParam[11]\r\n\tEndIf\r\nEndIf\r\n\r\n\r\nnLenaIpi := Len(aCstIpi) // Tratamento para CST IPI.\r\n\r\n//Geracao do arquivo XML\r\nIf !Empty(aNota)\r\n\r\n\tIf !lIcmDevol .And. aNota[5] = \"I\"\r\n\t\tlIcmDevol := .T.\r\n\tEnd If\r\n\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017)\r\n\tIf nToTvBC > 0 .And. nToTvICMS > 0 \r\n\t\tlIcmSTDev\t:= lIcmSTDevOri\r\n\t\tlIcmDevol\t:= lIcmDevolOri\t\r\n\tEndIf\r\n\r\n\tcString := \"\"\r\n\tcString += '<?xml version=\"1.0\" encoding=\"UTF-8\"?>'\r\n\tcString += NfeIde(@cNFe,aNota,cNatOper,aDupl,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cIndPres,aDest,aProd,aExp,aComb)\r\n\tcString += NfeEmit(aIEST,cVerAmb,aDest)\r\n\tcString += NfeDest(aDest,cVerAmb,aTransp,aCST,lBrinde,@cMunDest)\r\n\tIf !Empty(cAutXml)\r\n\t\tcString += NfeAutXml(cAutXml)\r\n\tEndIf\r\n\tcString += NfeLocalRetirada(aRetirada)\r\n\tcString += NfeLocalEntrega(aEntrega)\r\n\taTotICMSST := {0,0,0}\r\n\tFor nX := 1 To Len(aProd)\r\n\t\tIf nLenaIpi > 0\r\n\t\t\tIf  nCstIpi <= nLenaIpi\r\n\t\t\t\tcIpiCst := aCSTIPI[nX][1]\r\n\t\t\t\tnCstIpi += 1\r\n\t\t\tElse\r\n\t\t\t\tcIpiCst := \"\"\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\r\n\t\tcString += \tNfeItem(aProd[nX],aICMS[nX],aICMSST[nX],aIPI[nX],aPIS[nX],aPISST[nX],aCOFINS[nX],aCOFINSST[nX],aISSQN[nX],aCST[nX],;\r\n\t\t\t\t\taMed[nX],aArma[nX],aveicProd[nX],aDI[nX],aAdi[nX],aExp[nX],aPisAlqZ[nX],aCofAlqZ[nX],aAnfI[nX],cTipo,cVerAmb, aComb[Nx],;\r\n\t\t\t\t\t@cMensFis,aCsosn[Nx],aPedCom[nX],aNota,aICMSZFM[nX],aDest,cIpiCst,aFCI[nX],lIcmDevol,@nVicmsDeson,@nVIcmDif,cMunPres,;\r\n\t\t\t\t\taAgrPis[nX],aAgrCofins[nX],nIcmsDif,aICMUFDest[nX],@nvFCPUFDest,@nvICMSUFDest,@nvICMSUFRemet,cAmbiente,aIPIDevol[nX],;\r\n\t\t\t\t\t@nvBCUFDest, aItemVinc[nX], @npFCPUFDest,@npICMSUFDest,@npICMSInter,@npICMSIntP,aLote[nX],@cMensDifal,;\r\n\t\t\t\t\t@aTotICMSST,len(aProd), nX, @nValDifer)\r\n\tNext nX\r\n  \tcString += NfeTotal(aTotal,aRetido,aICMS,aICMSST,lIcmDevol,cVerAmb,aISSQN,nVicmsDeson,aNota,nVIcmDif,aAgrPis,aAgrCofins,nValLeite )\r\n\tcString += NfeTransp(cModFrete,aTransp,aImp,aVeiculo,aReboque,aEspVol,cVerAmb,aReboqu2,cMunDest)\r\n\t\r\n\tIf cVeramb == \"3.10\"\r\n\t\tcString += NfeCob(aDupl)\r\n\tEndIf\r\n\t\r\n\t\r\n\tIF cVeramb >= \"4.00\"\r\n\t\t//Obrigatório o preenchimento do Grupo Informações de Pagamento para NF-e e NFC-e. Para as notas com finalidade de Ajuste ou Devolução o\r\n\t\t//campo Forma de Pagamento deve ser preenchido com 90=Sem Pagamento.\r\n\t\t//Retirado o grupo de duplicata para não ocorrer a Rejeição 867: Grupo duplicata informado e forma de pagamento não é Duplicata Mercantil.\r\n\t\t\r\n       //If aScan( aDetPag,{ |x|x[1] == \"14\"} ) > 0\t\t\t\r\n\t\tIf lGrupCob\r\n\t\t\tcString += NfeCob(aDupl,aFat,(Alltrim(cSerie)+ Alltrim(cNota)))\r\n\t\tEndIf\r\n\t\t//EndIf\r\n\t\tcString += NfePag(aDetPag)\r\n\tEndIf\r\n\t\r\n\tnA := 0\r\n\tFor nA:=1 to Len(aMensAux)\r\n\t\tcMensFis += \" \" + aMensAux[nA] + CRLF\r\n\tNext\r\n\t\r\n\tIf cMensONU <> \"\"\r\n\t\tcMensCli:= cMensCli+\" \"+ Alltrim(cMensONU)\r\n\tEndIf\r\n\t\r\n\tIf nValDifer > 0\r\n\t\tcMensCpl += \"Diferimento do ICMS que exceder 12% - Base Legal Item II da Subseção III da Seção IV do Apêndice II do RICMS/RS. Valor do ICMS Diferido R$ \" + ConvType(nValDifer,15,2) + \".\"\r\n\tEndIf\r\n\t\r\n\t// Tratamento para buscar \r\n\tIf  Empty(aPedido) .and. !Empty(aNfVinc)  .and. aNota[5] == \"D\" .and. Len(aNfVinc[1]) > 8\r\n\t\taPedido := DadNfVinc(aNfVinc)\r\n\tEndIf \r\n\t\r\n\tcString += NfeInfAd(cMensCli,cMensFis,aPedido,aExp,cAnfavea,aMotivoCont,aNota,aNfVinc,aProd,aDI,aNfVincRur,aRetido,cNfRefcup,cSerRefcup,cTipo,nIPIConsig,nSTConsig,lBrinde,cVerAmb,Iif(aNota[5] == \"D\",aRefECF,{}),nVicmsDeson,nvFCPUFDest,nvICMSUFDest,nvICMSUFRemet,nvBCUFDest,aICMUFDest,nValIpiBene,npFCPUFDest,npICMSUFDest,npICMSInter,npICMSIntP,aObsCont,aValTotOpe,cMensDifal,aProcRef,aDest,nTotCrdP,cMensCpl)\r\n\t\r\n\tIf LRespTec .and. lTagProduc .and. FindFunction(\"NfeRespTec\")\r\n\t\tcString += NfeRespTec(\"\")\r\n\tEndIf\r\n\t\r\n\tcString += \"</infNFe>\"\r\nEndIf\r\n\r\ncStringUTF := EncodeUTF8(cString)\r\nif cStringUTF == nil\r\n\tcString := SpecialChar( cString )\r\n\tcStringUTF := EncodeUTF8(cString)\r\nendif\r\n\r\nReturn({cNFe, cStringUTF ,cNotaOri,cSerieOri})\r\n\r\nStatic Function NfeIde(cChave,aNota,cNatOper,aDupl,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cIndPres,aDest,aProd,aExp,aComb)\r\n\r\nLocal cString    \t:= \"\"\r\nLocal cNFVinc    \t:= \"\"\r\nLocal cModNot    \t:= \"\"\r\nLocal cOper\t\t\t:= \"\"\r\nLocal cCFOP\t\t\t:= \"\"\r\nLocal cChaveRef\t\t:= \"\"\r\nLocal cIndicador\t:= \"\"\r\nLocal cTipocli\t\t:= \"\"\r\nLocal cVENPRES\t\t:= \"\"\r\nLocal cChvDupli\t\t:= \"\"\t\t\t\t\t\t\t\t\t\t\t// Não permitido gerar a mesma nota \r\nLocal lAvista    \t:= Len(aDupl)==1 .And. aDupl[01][02]<=DataValida(aNota[03]+1,.T.)\r\nLocal lDSaiEnt   \t:= GetNewPar(\"MV_DSAIENT\", .T.)\r\nLocal lNfVincRur \t:= .F.\r\nLocal lNfVinc    \t:= .F.\r\nLocal lEECFAT\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lRefEcf\t\t:= .F.\r\nLocal nX         \t:= 0\r\nLocal nPos       \t:= 0 \r\nLocal nY\t\t\t:= 0\r\nLocal cTpImp\t \t:=  AllTrim(GetNewPar(\"MV_NFTPIMP\",\"\"))\r\nLocal nZ\t\t\t:= 0\r\nLocal aNfLtExpRf \t:= {}\r\n\r\ncVerAmb := PARAMIXB[2]\r\n\r\ncChave := aUF[aScan(aUF,{|x| x[1] == SM0->M0_ESTCOB})][02]+FsDateConv(aNota[03],\"YYMM\")+SM0->M0_CGC+\"55\"+StrZero(Val(aNota[01]),3)+StrZero(Val(aNota[02]),9)\r\ncChave+=Inverte(StrZero(Val(aNota[02]),8))\r\n\r\ncString += '<infNFe versao=\"T01.00\">'\r\ncString += '<ide>'\r\ncString += '<cUF>'+ConvType(aUF[aScan(aUF,{|x| x[1] == SM0->M0_ESTCOB})][02],02)+'</cUF>'\r\ncString += '<cNF>'+ConvType(Inverte(StrZero(Val(aNota[02]),Len(aNota[02]))),08)+'</cNF>'\r\ncString += '<natOp>'+ConvType(cNatOper)+'</natOp>'\r\n\r\nIf cVeramb <> \"4.00\"  //Retirado o campo indicador da Forma de Pagamento do Grupo B\r\n\tcString += '<indPag>'+IIF(lAVista,\"0\",IIf(Len(aDupl)==0,\"2\",\"1\"))+'</indPag>'\r\nEndif\r\n\r\nIf Empty(aNota[01])\r\n\tcString += '<serie>'+\"000\"+'</serie>'\r\nElse\r\n\tcString += '<serie>'+ConvType(Val(aNota[01]),3)+'</serie>'\r\nEndif\r\ncString += '<nNF>'+ConvType(Val(aNota[02]),9)+'</nNF>'\r\n//Nota Técnica 2013/005 - Data e Hora no formato UTC\r\nIf cVeramb >= \"3.10\"\r\n\tcString += '<dhEmi>'+ConvType(aNota[03])+\"T\"+Iif(Len(AllTrim(aNota[06])) > 5,ConvType(aNota[06]),ConvType(aNota[06])+\":00\")+'</dhEmi>'\r\n\tcString += NfeTag('<dhSaiEnt>',Iif(lDSaiEnt,\"\",ConvType(aNota[03])+\"T\"+Iif(Len(AllTrim(aNota[06])) > 5,ConvType(aNota[06]),ConvType(aNota[06])+\":00\")))\r\nElse\t\r\n\tcString += '<dEmi>'+ConvType(aNota[03])+'</dEmi>'\r\n\tcString += NfeTag('<dSaiEnt>',Iif(lDSaiEnt, \"\", ConvType(aNota[03])))\r\n\tIf !lDSaiEnt .And. !Empty(aNota[06])\r\n\t\tif len(aNota[06]) > 5\r\n\t\t\tcString += '<hSaiEnt>'+ConvType(aNota[06])+'</hSaiEnt>'\r\n\t\telse\r\n\t\t\tcString += '<hSaiEnt>'+ConvType(aNota[06])+\":00\"+'</hSaiEnt>'\t\r\n\t\tendif\r\n\tEndif\r\nEndIf\r\ncString += '<tpNF>'+aNota[04]+'</tpNF>'\r\nIf cVeramb >= \"3.10\"\r\n\t\r\n\tcCFOP:= AllTrim(aProd[1][7]) //Considera somente o CFOP da primeira nota\r\n\t\r\n\tIf SubStr(cCFOP,1,1) == \"2\" .Or. SubStr(cCFOP,1,1) == \"6\" \r\n\t\t cOper:= \"2\" //Operação Interestadual\r\n\tElseIf SubStr(cCFOP,1,1) == \"3\" .Or. SubStr(cCFOP,1,1) == \"7\" \r\n\t\tcOper:= \"3\" //Operação com Exterior\r\n\tElse\r\n\t\tcOper:= \"1\" //Operação Interna CFOP 1 e 5\r\n\tEndIf\r\n\r\n\t//Operação Interna/Interestadual, pois apesar de CFOP 3 ou 7, porem UF de cliente diferente de EX/ Rejeição 731 e 520 (NT 2013/005 v 1.10)/(NT 2010/007)\r\n\t//Conforme entendimento com a equipe, ao analisar o campo de UF da variavel aComb, devo verificar apenas a primeira linha, sendo a mesma tratativa feita anteriormente no tocante ao codigo da CFOP\r\n\tIf cOper == \"3\" .And. Len(aComb) > 0 .And. aDest[9] != \"EX\" .And. aComb[1][4] == \"EX\"\t\t\r\n\t\tIf aDest[9] == IIF(!GetNewPar(\"MV_SPEDEND\",.F.),ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))\r\n\t\t\tcOper:= \"1\" \r\n\t\tElse\r\n\t\t\tcOper:= \"2\"\r\n\t\tEndIf\t\t\r\n\tEndIf\r\n\t\r\n\t//Identificador de Local de Destino da Operação\r\n\tcString += '<idDest>'+cOper+'</idDest>'\t\r\n\tcIdDest:= cOper\r\nEndIf\r\n\r\nIf !Empty(cTpImp)\r\n\tcString += '<TpImp>'+cTpImp+'</TpImp>'\t\r\nEndIf\r\n\r\nIf !(cVerAmb >= \"4.00\") .And. !Empty(aNfVinc)\r\n\t\r\n\tcModNot := AModNot(aNfVinc[1][06])\r\n\t\r\n\tIf cModNot == '02'\r\n\t\taNfVinc   := {}\r\n\tEndIf\r\nEndIf\r\n\r\nIf(!Empty(aNfVinc)\t.And. Empty(aExp[1])) .or.(!Empty(aNfVinc).And. !Empty(aExp[1]) .and. lEECFAT)\r\n\tcString += '<NFRef>'\r\n\tFor nX := 1 To Len(aNfVinc)\r\n\t\tlNfVincRur := aScan(aNfVincRur,{|aX| aX[4]==aNfVinc[nX][6] .And. aX[2]==aNfVinc[nX][2] .And. aX[3]==aNfVinc[nX][3] .And. aX[5]==aNfVinc[nX][4]}) == 0\r\n\t\t// Verifica se ja foi gerada a tag para a mesma nota anteriormente, para não ser gerada novamente\r\n\t\t//   ocasionando em rejeição pela SEFAZ\r\n\t\tnPos       := aScan(aNfVinc, {|aX| aX[2] == aNfVinc[nX][2] .And. aX[3] == aNfVinc[nX][3]})\r\n\t\tlNfVinc    := (nPos > 0 .And. nPos <> nX)\r\n\t\t\r\n\t\tIf cVerAmb >= \"2.00\" .And. lNfVincRur .And. !lNfVinc\r\n\t\t\tIf !Empty(aNfVinc[Nx][7]) // Contem chave de NF-e ou Ct-e\r\n\t\t\t\tIf !(aNfVinc[Nx][7] $ cChvDupli)\r\n\t\t\t\t\tif !Empty(aNfVinc[Nx][6]) .and. \"CTE\" == UPPER(Alltrim(aNfVinc[Nx][6]))\r\n\t\t\t\t\t\tcString += '<refCTe>'+aNfVinc[Nx][7]+'</refCTe>'\t\t\t\t\r\n\t\t\t\t\telse\t\t\t\t\r\n\t\t\t\t\t\tcString += '<refNFe>'+aNfVinc[Nx][7]+'</refNFe>'   \r\n\t\t\t\t\tendif\r\n\t\t\t\tcChvDupli += aNfVinc[Nx][7]+'-'\r\n\t\t\t\tEndIf\r\n\t\t\tElseIf !(ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVinc[nX][05]})][02],02)+;\r\n\t\t\t\tFsDateConv(aNfVinc[nX][01],\"YYMM\")+;\r\n\t\t\t\taNfVinc[nX][04]+;\r\n\t\t\t\tAModNot(aNfVinc[nX][06])+;\r\n\t\t\t\tConvType(Val(aNfVinc[nX][02]),3)+;\r\n\t\t\t\tConvType(Val(aNfVinc[nX][03]),9) $ cNFVinc )\r\n\t\t\t\tcString += '<RefNF>'\r\n\t\t\t\tcString += '<cUF>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVinc[nX][05]})][02],02)+'</cUF>'\r\n\t\t\t\tcString += '<AAMM>'+FsDateConv(aNfVinc[nX][01],\"YYMM\")+'</AAMM>'\r\n\t\t\t\tIf Len(AllTrim(aNfVinc[nX][04]))==14\r\n\t\t\t\t\tcString += '<CNPJ>'+aNfVinc[nX][04]+'</CNPJ>'\r\n\t\t\t\tElseIf Len(AllTrim(aNfVinc[nX][04]))>0\r\n\t\t\t\t\tcString += '<CNPJ>'+Replicate(\"0\",14)+'</CNPJ>'\r\n\t\t\t\t\tcString += '<CPF>'+aNfVinc[nX][04]+'</CPF>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<CNPJ></CNPJ>'\r\n\t\t\t\tEndIf\r\n\t\t\t\tcString += '<mod>'+IIf(Alltrim(aNfVinc[nX][06]) == \"NFA\",\"01\",AModNot(aNfVinc[nX][06]))+'</mod>'\r\n\t\t\t\tcString += '<serie>'+ConvType(Val(aNfVinc[nX][02]),3)+'</serie>'\r\n\t\t\t\tcString += '<nNF>'+ConvType(Val(aNfVinc[nX][03]),9)+'</nNF>'\r\n\t\t\t\tcString += '<cNF>' + strZero( val( convType( inverte( strZero( val( aNfVinc[nX][03] ), len( aNfVinc[nX][03] ) ) ), 8 ) ), 9 ) + '</cNF>'\r\n\t\t\t\tcString += '</RefNF>'\r\n\t\t\r\n\t\t\t\tcNFVinc += ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVinc[nX][05]})][02],02)+;\r\n\t\t\t\t\tFsDateConv(aNfVinc[nX][01],\"YYMM\")+;\r\n\t\t\t\t\taNfVinc[nX][04]+;\r\n\t\t\t\t\tAModNot(aNfVinc[nX][06])+;\r\n\t\t\t\t\tConvType(Val(aNfVinc[nX][02]),3)+;\r\n\t\t\t\t\tConvType(Val(aNfVinc[nX][03]),9)\r\n\t\t\tEndIf\t\t\t\t\t\t\r\n\t\tEndIf                \t\t\r\n\tNext nX                  \r\n\tcString += '</NFRef>'\r\nEndIf\r\n\r\nif SM0->M0_ESTCOB  ==  'RS' .and. anota[5] == 'C' .and. len(aNfVincRur) > 0   // verifica se estado é RS e se nota é complemento\r\n\taNfVincRur := FiltEst(@aNfVincRur, SM0->M0_ESTCOB ) // remove notas referenciadas que não são do RS\r\nendif\r\n\r\nIf !Empty(aNfVincRur)\t\r\n\tIf len(aNfVincRur)>0 .and. cVerAmb >= \"2.00\"       \r\n\t\tcString += '<NFRef>'\r\n\t\tFor nX := 1 To Len(aNfVincRur)\r\n\t\t\tcString +='<refNFP>' \r\n\t\t\tcString += '<cUF>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVincRur[nX][06]})][02],02)+'</cUF>'\r\n\t\t\tcString += '<AAMM>'+FsDateConv(aNfVincRur[nX][01],\"YYMM\")+'</AAMM>'\r\n\t\t\tIf Len(AllTrim(aNfVincRur[nX][05]))==14\r\n\t\t\t\tcString += '<CNPJ>'+AllTrim(aNfVincRur[nX][05])+'</CNPJ>'\r\n\t\t\tElseIf Len(AllTrim(aNfVincRur[nX][05]))<>0\r\n\t\t\t\tcString += '<CPF>' +AllTrim(aNfVincRur[nX][05])+'</CPF>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<CNPJ></CNPJ>'         \r\n\t\t\tEndIf\t               \r\n\t\t\tcString += '<IE>'+ConvType(aNfVincRur[nX][07])+'</IE>'\r\n\t\t\tcString += '<mod>'+IIf(Alltrim(aNfVincRur[nX][04]) == \"NFA\",\"01\",AModNot(aNfVincRur[nX][04]))+'</mod>'\t\r\n\t\t\tcString += '<serie>'+ConvType(Val(aNfVincRur[nX][02]),3)+'</serie>'\r\n\t\t\tcString += '<nNf>'+ConvType(Val(aNfVincRur[nX][03]),9)+'</nNf>'\r\n \t\t\tcString +='</refNFP>'\r\n\t\tExit \t\r\n  \t\tNext nX          \r\n  \t\tcString += '</NFRef>'\r\n\tEndif\r\nEndIF\r\n\r\nIf !Empty(aRefECF)\r\n\tIf len(aRefECF) > 0 .and. cVerAmb >= \"2.00\"        \r\n\t\tcString += '<NFRef>'\t\r\n\r\n\t\tFor nX := 1 To Len(aRefECF)\r\n\t\t\t// Verifica se ja foi gerada a tag para o mesmo ECF / CF, para não ser gerada novamente\r\n\t\t\t// ocasionando em rejeição pela SEFAZ\r\n\t\t\tnPos\t\t:= aScan(aRefECF, {|aX| aX[1] == aRefECF[nX][1] .And. aX[3] == aRefECF[nX][3]})\r\n\t\t\tlRefEcf\t:= (nPos > 0 .And. nPos <> nX)\r\n\t\t\t\r\n\t\t\tif !lRefEcf\r\n\t\t\t\tcString +='<refECF>'\r\n\r\n\t\t\t\tif Alltrim(aRefECF[nX][02]) == \"ECF\" .Or. Alltrim(aRefECF[nX][02])==\"CF\" \r\n\t\t  \t\t\tcString += '<Mod>'+\"2C\"+'</Mod>'\r\n\t  \t\t\telse\r\n\t  \t\t\t\tcString += '<Mod>'+\"2B\"+'</Mod>'\r\n\t  \t\t\tendif\r\n\t\t\t\tcString += '<nECF>'+ConvType(Val(aRefECF[nX][03]),3)+'</nECF>'\r\n\t\t\t\tcString += '<nCOO>'+ConvType(Val(aRefECF[nX][01]),6)+'</nCOO>'\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tcString +='</refECF>'\r\n\t\t\tendif\r\n\t\t\t\r\n\t\t\t//if !Empty(aRefECF[nX][01]) .And.  !Empty(aRefECF[nX][02]) .And.  !Empty(aRefECF[nX][03])  \r\n\t\t\t//\tExit\r\n\t\t\t//endif\t\t\t\r\n\r\n  \t\tNext nX \r\n\t\tcString += '</NFRef>'\r\n\t\r\n\tEndif\t\r\nEndIf \r\n\r\n/*Quando há exportação indireta(I52), deve-se informar as chaves(I54) na tag refNFe.\r\nEEC não consegue preencher campo D2_NFORI pois pode existir mais de um documento de entrada para referenciar em um mesmo item,\r\npor este motivo, as chaves recebidas na tag chNFe do grupo exportInd serão geradas automaticamente na refNFe.\r\n*/\r\n\r\nIf !Empty(aExp[1]) .and. lEECFAT .and. cVerAmb >= \"3.10\"\r\n\tIf Len(aExp) > 0 .and. (aNota[04] == \"1\" .OR.  aNota[5] $ \"D|N\") //Somente se nota de saída ou devolução.\r\n\t\tFor nX := 1 To Len(aExp)\r\n\t\t\tIf Len(aExp[nX][3][3]) > 0\r\n\t\t\t\tFor nY := 1 To Len(aExp[nX][3][3][2])\r\n\t\t\t\t\t//Quando não há exportInd, a posição 3 é retornada vazia\r\n\t\t\t\t\tIf !Empty(aExp[nX][3][3][2][nY][3])\r\n\t\t\t\t\t\tIf !aExp[nX][3][3][2][nY][3][2][3] $ cChaveRef \r\n\t\t\t\t\t\t\tcChaveRef += '<refNFe>'+aExp[nX][3][3][2][nY][3][2][3]+'</refNFe>'\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tNext nY\r\n\t\t\tEndIf \r\n         /*Quando há notas fiscais de formação de lote de exportação associadas, deve-se informar as chaves(BA02) na tag refNFe.\r\n\t\t\t  Estas informações ficarão na posição 6 do array aExp retornado peloa função GETNFEEXP( ) do SIGAEEC - Exportação */\r\n\t\t\tIf Len(aExp[nX]) > 4 .And. Len(aExp[nX][5]) > 2 .And. Len(aExp[nX][5][3]) > 0\r\n\t\t\t\tFor nZ := 1 To Len(aExp[nX][5][3])\r\n\t\t\t\t\tIf !Empty(aExp[nX][5][3][nZ][1])\r\n\t\t\t\t\t   If aScan(aNfLtExpRf,aExp[nX][5][3][nZ][1]) == 0\r\n\t\t\t\t\t      cChaveRef += '<refNFe>'+aExp[nX][5][3][nZ][1]+'</refNFe>'\r\n\t\t\t\t\t\t\taAdd( aNfLtExpRf , aExp[nX][5][3][nZ][1] )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tNext nY\r\n\t\t\tEndIf \r\n\t\tNext Nx\r\n\t\t\r\n\t\tIf !Empty(cChaveRef)\r\n\t\t\tcString += '<NFRef>'\r\n\t\t\tcString += cChaveRef\r\n\t\t\tcString += '</NFRef>'\r\n\t\tEndIf\r\n\r\n\t   aNfLtExpRf := {}\r\n\r\n\tEndIf\t\r\n/*SEM INTEGRAÇÃO COM EEC - Quando há exportação indireta, deve-se informar a chave(I54 - tag chNFe) na tag refNFe.\r\nCaso não seja vinculada a NF original no pedido de venda (C6_NFORI/D2_NFORI), será considerada a chave contida\r\nno campo CDL_CHVEXP na montagem da refNFe.\r\n*/\r\nElseIf !Empty(aExp[1]) .and. !lEECFAT .and. (aNota[04] == \"1\" .or. (aNota[04] == \"0\" .and. aNota[5] $ \"D|N\"))  //.and. Empty(aNfVinc)\r\n\tFor nX := 1 To Len(aExp)\r\n\t\tIf !Empty(aExp[nX])\r\n\t\t\tFor nZ := 1 To Len(aExp[nX])\r\n\t\t\t\tIf !Empty(aExp[nX][nZ][5][3])\r\n\t\t\t\t\tIf !aExp[nX][nZ][5][3] $ cChaveRef\r\n\t\t\t\t\t\tcChaveRef += '<refNFe>'+ConvType(aExp[nX][nZ][5][3],44)+'</refNFe>'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tnext\r\n\t\tEndif\t\r\n\tNext nX\r\n\tIf !Empty(cChaveRef)\r\n\t\tcString += '<NFRef>'\r\n\t\tcString += cChaveRef\r\n\t\tcString += '</NFRef>'\r\n\tEndIf\r\nEndIf\r\n\r\ncTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,aProd[1,7])\r\n\t\r\n/*Verificação do conteudo da tag IndIeDest para atribuir valor 1 na tag indFinal - rej 696-NT2015/003_v1.71*/\r\nIf ConvType(aDest[17]) <> \"2\" .and. !Empty(aDest[14])\r\n\tIf \"ISENT\" $ Upper(Alltrim(aDest[14]))\r\n\t\tcIndicador := \"2\"\r\n\tElse\r\n\t\tcIndicador := \"1\"\t\t\r\n\tEndIf\r\nElse\r\n\tcIndicador := \"9\" //9-Não Contribuinte\r\nEndIf\r\n//Ajuste para considerar o tipo do cliente cadastrado na (C5_TIPOCLI) quando alterado no cabeçalho das NF de Saída\r\n//pois todos os cálculos fiscais são feitos com base nessa informação e não no campo A1_TIPO.\r\nIf !Empty(SF2->F2_TIPOCLI) .and. !Empty(aDest[20]) \r\n\tIf (!Empty(aDest[20]) .and. aDest[20]) <> SF2->F2_TIPOCLI\t\r\n  \t\tcTipocli:= SF2->F2_TIPOCLI\r\n  \tElse\r\n  \t   cTipocli:= aDest[20]\r\n  \tEndIf\r\nElse \r\n\tIf !Empty(aDest[20]) \t\r\n\t\tcTipocli:= aDest[20]\r\n\tEndIf\r\nEndIf\r\n\r\ncString += '<tpNFe>'+cTPNota+'</tpNFe>'\r\nIf cVeramb >= \"3.10\"\r\n\tIf cTipocli  == \"F\"\r\n\t\tcString += '<indFinal>1</indFinal>' //1-Operação com consumidor final\r\n\t\tcIndFinal:= \"1\"\r\n\tElse\r\n\t\tIf cIndicador == \"9\" .and. cIdDest <> \"3\" //(tag indIEDest=9)-Não Contribuinte e operação que não é com exterior (tag idDest <> 3)\r\n\t\t\tcString += '<indFinal>1</indFinal>'//1-Consumidor final\r\n\t\t\tcIndFinal:= \"1\"\r\n\t\tElse\r\n\t\t\tcString += '<indFinal>0</indFinal>'//0-Não\r\n\t\t\tcIndFinal:= \"0\"\r\n\t\tEndIf\r\n\tEndIf\r\n\tIf Empty(cIndPres)\r\n\t\tcVENPRES:= AllTrim(aProd[1][42]) //Considera somente o F4_VENPRES do primeiro item\r\n\t\tIf aNota[5] == \"N\"\r\n\t\t\tcIndPres := \"9\" //Operação não presencial \r\n\t\tElseIf aNota[5] == \"D\" .and. aNota[04] == \"0\" .and. (!Empty(cVENPRES) .and. cVENPRES == \"1\")\r\n\t\t\t/*Manutenção para considerar o conteúdo do campo F4_VENPRES=1 na montagem da tag \r\n\t\t\t\tindPres = 1 – Operação Presencial, em notas de devolução de venda para contribuinte de \r\n\t\t\t\toutro Estado, com CFOP iniciado por 1 e sem frete, a fim de não apresentar a \r\n\t\t\t\trejeição 521 - Operação Interna e UF do emitente difere da UF do destinatário/remetente \r\n\t\t\t\tcontribuinte do ICMS.*/\r\n\t\t\tcIndPres := \"1\"\r\n\r\n\t\tElse\r\n\t\t\tcIndPres := \"0\" //0-Não se Aplica\t\r\n\t\tEndIf\r\n\tEndIf\r\n\tcString += '<indPres>'+cIndPres+'</indPres>' // Presenção do comprador no momento da Operação\r\nEndIf\r\ncString += '</ide>'\r\n\r\nReturn( cString )\r\n\r\nStatic Function NfeEmit(aIEST, cVerAmb, aDest)\r\n\r\nLocal aTelDest \t\t:= {} \r\n\r\nLocal cFoneDest\t\t:= \"\"\r\nLocal cMVCODREG\t\t:= SuperGetMV(\"MV_CODREG\", ,\" \")  \r\n//Local cMVEstado\t\t:= SuperGetMV(\"MV_ESTADO\", ,\" \")\r\n//Local cSTIeUf\t\t:= SuperGetMV(\"MV_STNIEUF\",.F.,\"\")\r\nLocal cString \t\t:= \"\"\r\nLocal cUfDest\t\t:= \"\"\r\nLocal cEndEmit\t:= \"\"\r\n\r\nLocal lEndFis \t\t:= GetNewPar(\"MV_SPEDEND\",.F.)\r\nLocal lUsaGesEmp\t:= IIF(FindFunction(\"FWFilialName\") .And. FindFunction(\"FWSizeFilial\") .And. FWSizeFilial() > 2,.T.,.F.)\r\n\r\nDEFAULT aIEST\t := {}\r\n\r\ncVerAmb     := PARAMIXB[2] \r\ncUfDest\t\t:= ConvType(aDest[09])\r\n\r\ncString := '<emit>'\r\nIf Len(AllTrim(SM0->M0_CGC))==14\r\n\tcString += '<CNPJ>'+AllTrim(SM0->M0_CGC)+'</CNPJ>'\r\nElseIf Len(AllTrim(SM0->M0_CGC))<>0\r\n\tcString += '<CPF>'+AllTrim(SM0->M0_CGC)+'</CPF>'\r\nElse\r\n\tcString += '<CNPJ></CNPJ>'\r\nEndIf\r\ncString += '<Nome>'+ConvType(SM0->M0_NOMECOM)+'</Nome>'\r\n\r\n/*\r\nQuando utilizar Gestao de empresas o M0_NOME guarda o nome do Grupo e não da Filial.\r\nFWFilialName - Pega o nome da Filial Atual,só usar funcao se estiver habilitado \r\ngestao de empresa (FWSizeFilial() > 2)\r\n*/\r\n\r\nIf lUsaGesEmp\r\n\tcString += NfeTag('<Fant>',ConvType(FWFilialName()))\r\nElse\r\n\tcString += NfeTag('<Fant>',ConvType(SM0->M0_NOME))\r\nEndIf\t     \r\n\r\ncString += '<enderEmit>'\r\ncString += '<Lgr>'+IIF(!lEndFis,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[1]),ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1]))+'</Lgr>'\r\n\r\nIf !lEndFis\r\n\tIf FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[2]<>0\r\n\t\tcString += '<nro>'+FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[3]+'</nro>'  \r\n\tElse\r\n\t\tcString += '<nro>'+\"SN\"+'</nro>' \r\n\tEndIf\r\nElse\r\n\tIf FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2]<>0\r\n\t\tcString += '<nro>'+FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3]+'</nro>' \r\n\tElse\r\n\t\tcString += '<nro>'+\"SN\"+'</nro>'\r\n\tEndIf\r\nEndIf\t\r\n\t\r\ncEndEmit :=  IIF(!lEndFis,Iif(!Empty(SM0->M0_COMPCOB),SM0->M0_COMPCOB,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[4]) ) ,;\r\n\t\t\t\t\t\t  Iif(!Empty(SM0->M0_COMPENT),SM0->M0_COMPENT,ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[4]) ) )\r\ncString += NfeTag('<Cpl>',cEndEmit)\r\ncString += '<Bairro>'+IIF(!lEndFis,ConvType(SM0->M0_BAIRCOB),ConvType(SM0->M0_BAIRENT))+'</Bairro>'\r\ncString += '<cMun>'+ConvType(SM0->M0_CODMUN)+'</cMun>'\r\ncString += '<Mun>'+IIF(!lEndFis,ConvType(SM0->M0_CIDCOB),ConvType(SM0->M0_CIDENT))+'</Mun>'\r\ncString += '<UF>'+IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))+'</UF>'\r\ncString += NfeTag('<CEP>',IIF(!lEndFis,ConvType(SM0->M0_CEPCOB),ConvType(SM0->M0_CEPENT)))\r\ncString += NfeTag('<cPais>',\"1058\")\r\ncString += NfeTag('<Pais>',\"BRASIL\")\r\naTelDest:= FisGetTel(SM0->M0_TEL)\r\ncFoneDest := IIF(aTelDest[1] > 0,ConvType(aTelDest[1],3),\"\") // Código do Pais\r\ncFoneDest += IIF(aTelDest[2] > 0,ConvType(aTelDest[2],3),\"\") // Código da Área\r\ncFoneDest += IIF(aTelDest[3] > 0,ConvType(aTelDest[3],9),\"\") // Código do Telefone\r\ncString += NfeTag('<fone>',cFoneDest)\r\ncString += '</enderEmit>'\r\ncString += '<IE>'+ConvType(VldIE(SM0->M0_INSC))+'</IE>'\r\nIf !Empty(aIEST) \r\n\t/*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t  ³ Tratamento para acordo entre os estados preenchidos no parametro MV_STNIEUF, quando em      ³\r\n\t  ³ um movimento com ICMS-ST nao e' necessario ter insccricao estadual, assim esse tratamento   ³\r\n\t  ³ retorna a inscricao \" \" para gerar a guia de recolhimento para o estado destino             ³ \r\n\t  ³ Este tratamento foi feito a partir da necessidade das UF de MG p/ PR,onde existe esse \t    ³\r\n\t  ³ acordo PROTOCOLO ICMS CONSELHO NACIONAL DE POLÍTICA FAZENDÁRIA - CONFAZ Nº 191 DE 11.12.2009³ \r\n\t  ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ*/\r\n\r\n\t/*If !(cMVEstado+cUfDest) $ cSTIeUf\r\n\t\tcString += NfeTag('<IEST>',aIEST[01]) \r\n\tEndIf*/\r\n\t\r\n\t// Preenche a tag quando IE do Emitente diferente do IE do parametro MV_SUBTRIB\r\n\t/*Inserida a verificação do idDest = 2 por conta de rejeição\r\n\t347 Informada IE do substituto tributário em operação que não é interestadual\r\n\t\r\n\tRegra de Validação\r\n\tSe informada a IE do Substituto Tributário para uma operação com Exterior ou Operação Interna (tag:idDest=1 ou 3)\r\n\tExceção: A critério da UF, poderá ser aceita a informação da IE-ST em operação interna.\r\n\t*/\r\n\t/* Adicionado tratativa para destacar em XML I.E. especial, para cliente ST, em operações internas no estado do PR, conforme Art. 176 § 10 do RICMS 2017 */                                                                                                                                                                                                                                                       \r\n\tIf((AllTrim(ConvType(VldIE(SM0->M0_INSC))) <> Alltrim(aIEST[01])) .And. (Alltrim (aIEST[01]) <> Alltrim(aIEST[02])) .And.;\r\n\t\t\t (cIdDest == \"2\" .OR. (cIdDest == \"1\" .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\")))\r\n\t\tcString += NfeTag('<IEST>',aIEST[01]) \r\n\tEndIf\r\nEndIf\r\ncString += NfeTag('<IM>',SM0->M0_INSCM)\r\ncString += NfeTag('<CNAE>',ConvType(SM0->M0_CNAE))\r\ncString += '<CRT>'+cMVCODREG+'</CRT>' \r\ncString += '</emit>'\r\nReturn(cString)\r\n\r\nStatic Function NfeDest(aDest,cVerAmb,aTransp,aCST,lBrinde,cMunDest)\r\n\t\r\n\tLocal aTelDest\t\t:= {}\r\n\tLocal cString\t\t:= \"\"\r\n\tLocal cMailTrans \t:= \"\"\r\n\tLocal cFoneDest\t\t:= \"\"\r\n\tLocal cIndicador\t:= \"\"\r\n\r\n\tDefault cMunDest\t:= \"\"\r\n\t\r\n\tcVerAmb\t:= PARAMIXB[2] \r\n\tcMunDest\t:= iIf(!lBrinde,IIf(Len(aDest[07])>5,aDest[07],aUF[aScan(aUF,{|x| x[1] == aDest[09]})][02]+aDest[07]),SM0->M0_CODMUN)\r\n\t\r\n\tcString := '<dest>'\r\n\tIf cVerAmb >= '3.10'\r\n\t//Estrangeiro não manda a tag de CPFCNPJ\r\n\t\tIf !\"EX\"$aDest[09]\r\n\t\t\tIf Len(AllTrim(aDest[01]))==14\r\n\t\t\t\tcString += '<CNPJ>'+iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CNPJ>'\r\n\t\t\tElseIf Len(AllTrim(aDest[01]))<>0\r\n\t\t\t\tcString += '<CPF>' +iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CPF>'\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\tIf !Empty(aDest[21])\r\n\t\t\t\tcString += '<idEstrangeiro>'+aDest[21]+'</idEstrangeiro>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<idEstrangeiro></idEstrangeiro>'\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tElse\r\n\t\tIf Len(AllTrim(aDest[01]))==14\r\n\t\t\tcString += '<CNPJ>'+iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CNPJ>'\r\n\t\tElseIf Len(AllTrim(aDest[01]))<>0\r\n\t\t\tcString += '<CPF>' +iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CPF>'\r\n\t\tElse\r\n\t\t\tcString += '<CNPJ></CNPJ>'\r\n\t\tEndIf\r\n\tEndIf\r\n\tcString += '<Nome>'+ConvType(iIf(!lBrinde,aDest[02],\"Diversos - Brindes\"))+'</Nome>'\r\n\tcString += '<enderDest>'\r\n\tcString += '<Lgr>'+ConvType(iIf(!lBrinde,aDest[03],(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1])))+'</Lgr>'\r\n\tif lBrinde\r\n\t\t\r\n\t\tif FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2]<>0\r\n\t\t\tcString += '<nro>'+FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3]+'</nro>' \r\n\t\telse\r\n\t\t\tcString += '<nro>'+\"SN\"+'</nro>'\r\n\t\tendif\r\n\t\r\n\telse \r\n\t\t\r\n\t\tIf  ValType(aDest[04]) == \"N\" .and. AT(\".\",Alltrim(Str(aDest[04]))) > 0\r\n\t\t\tcString += '<nro>'+Alltrim(Str(aDest[04]))+'</nro>'\r\n\t\tElse\r\n\t\t\tcString += '<nro>'+ConvType(aDest[04])+'</nro>'\r\n\t\tEndIf\r\n\tendif\r\n\tcString += NfeTag('<Cpl>',ConvType(iIf(!lBrinde,aDest[05],SM0->M0_COMPENT)))\r\n\tcString += '<Bairro>'+ConvType(iIf(!lBrinde,aDest[06],SM0->M0_BAIRENT))+'</Bairro>'\r\n\tcString += '<cMun>'+ConvType(cMunDest)+'</cMun>'\r\n\tcString += '<Mun>'+ConvType(iIf(!lBrinde,aDest[08],SM0->M0_CIDENT))+'</Mun>'\r\n\tcString += '<UF>'+ConvType(iIf(!lBrinde,aDest[09],SM0->M0_ESTENT))+'</UF>'\r\n\tcString += NfeTag('<CEP>',iIf(!lBrinde,aDest[10],SM0->M0_CEPENT))\r\n\tcString += NfeTag('<cPais>',aDest[11])\r\n\tcString += NfeTag('<Pais>',ConvType(aDest[12]))\r\n\tif lBrinde\r\n\t\taTelDest\t:= FisGetTel(SM0->M0_TEL)\r\n\t    cFoneDest\t:= IIF(aTelDest[1] > 0,ConvType(aTelDest[1],3),\"\") // Código do Pais\r\n\t    cFoneDest\t+= IIF(aTelDest[2] > 0,ConvType(aTelDest[2],3),\"\") // Código da Área\r\n\t    cFoneDest\t+= IIF(aTelDest[3] > 0,ConvType(aTelDest[3],9),\"\") // Código do Telefone\r\n\t\tcString\t+= NfeTag('<fone>',cFoneDest)\t\t\t\r\n\telse\r\n\t\tcString += NfeTag('<fone>', ConvType( FisGetTel(aDest[13])[2], 3) + ConvType( FisGetTel(aDest[13])[3], 11)  )\r\n\tendif\r\n\tcString += '</enderDest>'\r\n\t\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tIf ConvType(aDest[17]) <> \"2\" .and. !Empty(aDest[14])\r\n\t\t\tIf \"ISENT\" $ Upper(Alltrim(aDest[14]))\r\n\t\t\t\tcIndicador := \"2\"\r\n\t\t\tElse\r\n\t\t\t\tcIndicador := \"1\"\r\n\t\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\t\tcIndicador := \"9\" //9-Não Contribuinte: a IE do destinatário pode ser informada ou não, já que algumas UF concedem inscrição estadual para não contribuintes.\r\n\t\t\t\t//No caso de operação com o Exterior informar indIEDest=9 e não informar a tag IE do destinatário;\r\n\t\t\t\tIf  !\"EX\" $ aDest[09] .And. ConvType(aDest[14]) <> \"ISENTO\"\r\n\t\t\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\t\tcString += '<indIEDest>'+cIndicador+'</indIEDest>'\r\n\t\tcIndIEDest:= cIndicador\r\n\t\t\r\n\t\t/*\tindIEDest - Indicador da IE do destinatário\r\n\t\t\t1=Contribuinte ICMS (informar a IE do destinatário);\r\n\t\t\t2=Contribuinte isento de Inscrição no cadastro de Contribuintes do ICMS;\r\n\t\t\t9=Não Contribuinte, que pode ou não possuir Inscrição Estadual no Cadastro de Contribuintes do ICMS;\t\r\n\t\t*/\r\n\tElse\r\n\t\t// Conforme legislação, não contribuinte em SP, deve levar a IE se preenchida.\r\n\t\tIf ConvType(aDest[18]) == \"1\" .And. ConvType(aDest[17]) == \"2\"\r\n\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\tElseIf ConvType(aDest[17]) == \"2\" .And. ConvType(aDest[14]) <> \"ISENTO\" .And. SuperGetMV(\"MV_ESTADO\") <> \"SP\"  \r\n\t\t\tcString += '<IE>'+\"\"+'</IE>' \r\n\t\t\r\n\t\t/*---------------------------------------------\r\n\t\t Tratamento realizado Produtor Rural - RS\r\n\t\t \r\n\t\t 1. Cliente     \t\t= Produtor Rural\r\n\t\t 2. Documento tipo\t= Devolucao\r\n\t\t 3. Origem Rotina\t\t= Loja\r\n\t\t 4. Parametro\testado\t= RS (Rio G. Sul)\r\n\t\t \r\n\t\t Obs.: Chamado Consultoria Tributaria: TQCMPM\r\n\t\t---------------------------------------------*/\t\r\n\t\tElseIf Alltrim(SA1->A1_TIPO) == \"L\" .And. Alltrim(SF1->F1_TIPO) == \"D\" .And. Alltrim(SF1->F1_ORIGLAN) == \"LO\" .And. SuperGetMV(\"MV_ESTADO\") == \"RS\" \r\n\t\t\tcString += '<IE>'+\"\"+'</IE>'\t\t\t\r\n\t\t\r\n\t\tElse\r\n\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\tEndif\r\n\tEndIf\r\n\t\r\n\t//Tratamento para atender Manual de Orientação do Contribuinte versão 5.00 onde é Obrigatório, nas operações que se beneficiam de incentivos fiscais existentes nas áreas sob controle da SUFRAMA.\r\n\tcString += NfeTag('<IESUF>',aDest[15])\t\r\n\t\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += NfeTag('<IM>',aDest[19])\r\n\tEndIf\r\n\t//Considera o e-mail do cadastro da transportadora\r\n\tIf Len(aTransp) > 0\r\n\t\tIf !Empty(aDest[16]) .and. !Empty(AllTrim(aTransp[07]))\r\n\t\t\tcMailTrans := \";\"+AllTrim(aTransp[07])\r\n\t\tElse \r\n\t\t\tcMailTrans := AllTrim(aTransp[07])\r\n\t\tEndIf \t\r\n\tElse\r\n\t\tcMailTrans := \"\"\r\n\tEndIf\r\n\tif !lBrinde\r\n\t\tcString += NfeTag('<EMAIL>',AllTrim(aDest[16])+cMailTrans)\r\n\tendif\r\n\t\r\n\tcString += '</dest>'\r\nReturn(cString)\r\n\r\nStatic Function NfeLocalEntrega(aEntrega)\r\n\r\nLocal cString:= \"\"\r\n\r\nIf !Empty(aEntrega) .And. (Len(AllTrim(aEntrega[01]))==14 .Or. Len(AllTrim(aEntrega[01]))==11) \r\n\tcString := '<entrega>'\r\n\tIf Len(AllTrim(aEntrega[01]))==14 .AND. !(\"EX\" $ aEntrega[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<CNPJ>'+AllTrim(aEntrega[01])+'</CNPJ>' \r\n\tElseif Len(AllTrim(aEntrega[01]))<>0 .AND. !(\"EX\" $ aEntrega[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<cpf>' +AllTrim(aEntrega[01])+'</cpf>'\t\r\n\tElse\r\n\t\tcString += '<CNPJ></CNPJ>'\r\n\tEndif\r\n\tIf lTagProduc\r\n\t\tcString += '<Nome>'+ConvType(aEntrega[09])+'</Nome>'\r\n\tEndif\r\n\tcString += '<Lgr>'+ConvType(aEntrega[02])+'</Lgr>'\r\n\tcString += '<nro>'+ConvType(aEntrega[03])+'</nro>'\r\n\tcString += NfeTag('<Cpl>',ConvType(aEntrega[04]))\r\n\tcString += '<Bairro>'+ConvType(aEntrega[05])+'</Bairro>'\r\n\tcString += '<cMun>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aEntrega[08]})][02]+aEntrega[06])+'</cMun>'\r\n\tcString += '<Mun>'+ConvType(aEntrega[07])+'</Mun>'\r\n\tcString += '<UF>'+ConvType(aEntrega[08])+'</UF>'\r\n\tIf lTagProduc\r\n\t\tcString += '<CEP>'+ConvType(aEntrega[11])+'</CEP>'\r\n\t\tcString += '<cPais>'+ConvType(aEntrega[12])+'</cPais>'\r\n\t\tcString += '<Pais>'+ConvType(aEntrega[13])+'</Pais>'\r\n\t\tcString += '<fone>'+ConvType(aEntrega[14])+'</fone>'\r\n\t\tcString += '<email>'+ConvType(aEntrega[15])+'</email>'\r\n\t\tcString += '<IE>'+ConvType(aEntrega[10])+'</IE>'\r\n\tEndif\r\n\t\r\n\tcString += '</entrega>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NfeLocalRetirada(aRetirada)\r\n\r\nLocal cString:= \"\"\r\n\r\nIf !Empty(aRetirada)\r\n\tcString := '<retirada>'\r\n\tIf Len(AllTrim(aRetirada[01]))==14 .AND. !(\"EX\" $ aRetirada[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<CNPJ>'+AllTrim(aRetirada[01])+'</CNPJ>' \r\n\tElseif Len(AllTrim(aRetirada[01]))<>0 .AND. !(\"EX\" $ aRetirada[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<cpf>' +AllTrim(aRetirada[01])+'</cpf>'\t\r\n\tElse\r\n\t\tcString += '<CNPJ></CNPJ>'\r\n\tEndif\r\n\tIf lTagProduc\r\n\t\tcString += '<Nome>'+ConvType(aRetirada[09])+'</Nome>'\r\n\tEndif\r\n\tcString += '<Lgr>'+ConvType(aRetirada[02])+'</Lgr>'\r\n\tcString += '<nro>'+ConvType(aRetirada[03])+'</nro>'\r\n\tcString += NfeTag('<Cpl>',ConvType(aRetirada[04]))\r\n\tcString += '<Bairro>'+ConvType(aRetirada[05])+'</Bairro>'\r\n\tcString += '<cMun>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aRetirada[08]})][02]+aRetirada[06])+'</cMun>'\r\n\tcString += '<Mun>'+ConvType(aRetirada[07])+'</Mun>'\r\n\tcString += '<UF>'+ConvType(aRetirada[08])+'</UF>'\r\n\tIf lTagProduc\r\n\t\tcString += '<CEP>'+ConvType(aRetirada[11])+'</CEP>'\r\n\t\tcString += '<cPais>'+ConvType(aRetirada[12])+'</cPais>'\r\n\t\tcString += '<Pais>'+ConvType(aRetirada[13])+'</Pais>'\r\n\t\tcString += '<fone>'+ConvType(aRetirada[14])+'</fone>'\r\n\t\tcString += '<email>'+ConvType(aRetirada[15])+'</email>'\r\n\t\tcString += '<IE>'+ConvType(aRetirada[10])+'</IE>'\r\n\tEndif\r\n\tcString += '</retirada>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NfeItem(aProd,aICMS,aICMSST,aIPI,aPIS,aPISST,aCOFINS,aCOFINSST,aISSQN,aCST,aMed,aArma,aveicProd,aDI,aAdi,aExp,aPisAlqZ,aCofAlqZ,aAnfI,cTipo,cVerAmb,aComb,cMensFis,cCsosn,aPedCom,aNota,aICMSZFM,aDest,cIpiCst,aFCI,lIcmDevol,nVicmsDeson,nVIcmDif,cMunPres,aAgrPis,aAgrCofins,nIcmsDif,aICMUFDest,nvFCPUFDest,nvICMSUFDest,nvICMSUFRemet,cAmbiente,aIPIDevol,nvBCUFDest, aItemVinc,npFCPUFDest,npICMSUFDest,npICMSInter,npICMSIntP,aLote,cMensDifal, aTotICMSST, nTotProd, nItProd, nValDifer)\r\n\r\nLocal cString \t\t:= \"\"\r\nLocal cMVCODREG\t\t:= AllTrim(SuperGetMV(\"MV_CODREG\", ,\" \"))\r\nLocal cVunCom\t\t:= \"\"\r\nLocal cVunTrib\t\t:= \"\"  \r\nLocal cMotDesICMS\t:= \"\"\r\nLocal cMensDeson\t:= \"\"\r\nLocal cDedIcm\t\t:= \"\"\r\nLocal cCrgTrib\t\t:= \"\"\r\nLocal cPercTrib\t\t:= \"\"\r\nLocal cMVINCEFIS\t:= AllTrim(GetNewPar(\"MV_INCEFIS\",\"2\"))\r\nLocal cMVNumProc\t:= AllTrim(GetNewPar(\"MV_NUMPROC\",\" \"))\r\nLocal cF2Tipo\t\t:= \"\"\r\nLocal cMsgDI\t\t:= \"\"\r\nLocal cMensFecp\t\t:= \"\"\r\nLocal cEan\t\t\t:= \"\"\r\nLocal cEantrib\t\t:= \"\"\r\nLocal lAnfProd\t\t:= SuperGetMV(\"MV_ANFPROD\",,.T.)\r\nLocal lArt186\t    := SuperGetMV(\"MV_ART186\",,.F.)\r\nLocal lIssQn     \t:= .F.\r\nLocal lMvPisCofD \t:= GetNewPar(\"MV_DPISCOF\",.F.)   // Parâmetro para informar os valores de Cofins e Pis nas Informações complementares do Danfe \r\n//Local lSimpNac   \t:= SuperGetMV(\"MV_CODREG\")== \"1\" .Or. SuperGetMV(\"MV_CODREG\")== \"2\" \r\nLocal lUnTribCom\t:= GetNewPar(\"MV_VTRICOM\",.F.) //Parâmetro para informar o valor unitário comercial e valor unitário tributável nas informações complementares do DANFE (quando vuncom e vuntrib forem diferentes)\r\nLocal lNContrICM\t:= .F.  //Define se o cliente não é contribuinte do ICMS no estado.\r\nLocal lPesFisica\t:= .F.\r\nLocal lDInoDanfe\t:= GetNewPar(\"MV_DIDANFE\",.F.) //Parâmetro para informar os dados da DI nas informações complementares do Xml/Danfe\r\nLocal lCalcMed \t\t:= GetNewPar(\"MV_STMEDIA\",.F.) //Define se irá calcular a média do ICMS ST e da BASE do ICMS ST. \r\nLocal lSuframa\t\t:= GetNewPar(\"MV_SUFRAMA\",.F.) // Parâmetro referente a Suframa\r\nLocal lProdItem\t\t:= .F.\t//Define se esta configurado para gerar a mensagem da Lei da Transparencia por Produto ou somente nas informacoes Complementares.\r\nLocal lEECFAT\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lEndFis \t\t:= GetNewPar(\"MV_SPEDEND\",.F.)\r\nlocal lDateRefNf\t:= .T.\r\nLocal aPPDifal\t\t:= &(SuperGetMV(\"MV_PPDIFAL\", ,\"{{2016,40,60},{2017,60,40},{2018,80,20},{2019,100,0}}\"))\r\nLocal aPICMSInter\t:= {}\r\nLocal nX\t\t\t:= 0\r\nLocal nBaseIcm   \t:= 0\r\nLocal nValCof \t\t:= 0\r\nLocal nValICM\t \t:= 0\r\nLocal nValPis\t\t:= 0\r\nLocal nDesonICM\t\t:= 0\r\nLocal nValIcmDif\t:= 0\r\nLocal nA\t\t\t:= 0\r\nLocal nPos\t\t\t:= 0\r\nLocal nUltimo\t\t:= 0\r\nLocal nBfcpant\t\t:= 0\r\nLocal nAfcpant\t\t:= 0\r\nLocal nVfcpant\t\t:= 0\r\nLocal nAlqICM   \t:= 0  \r\nLocal nVICPRST  \t:= 0  \r\nLocal cUltAqui  \t:= AllTrim(SuperGetMv(\"MV_ULTAQUI\",,\"\"))\r\nLocal cArt274\t\t:= \"\"\r\nLocal anDraw\t\t:= {}\r\nLocal aExportInd\t:= {}\r\nLocal nValDeson\t\t:= 0\r\nLocal lRetEfet\t\t:= .T.     //ICMS RETIDO COM ICMS EFETIVO\r\nLocal nPIcmsDif\t\t:= 0\r\n\r\nDEFAULT aICMS    \t\t:= {}\r\nDEFAULT aICMSST  \t\t:= {}\r\nDEFAULT aICMSZFM \t\t:= {}\r\nDEFAULT aIPI     \t\t:= {}\r\nDEFAULT aPIS    \t\t:= {}\r\nDEFAULT aPISST   \t\t:= {}\r\nDEFAULT aCOFINS  \t\t:= {}\r\nDEFAULT aCOFINSST\t\t:= {}\r\nDEFAULT aISSQN   \t\t:= {}\r\nDEFAULT aMed     \t\t:= {}\r\nDEFAULT aArma    \t\t:= {}\r\nDEFAULT aveicProd\t\t:= {}\r\nDEFAULT aDI\t\t \t\t:= {}\r\nDEFAULT aAdi\t \t\t:= {}\r\nDEFAULT aExp\t \t\t:= {}\r\nDEFAULT aAnfI\t \t\t:= {}\r\nDEFAULT aPedCom  \t\t:= {}\r\nDEFAULT aFCI\t\t\t:= {}\r\nDEFAULT aIPIDevol\t\t:= {}\r\nDEFAULT aItemVinc\t\t:= {}\r\nDEFAULT aTotICMSST\t\t:= {}\r\nDEFAULT cMensFis \t\t:= \"\"\r\nDEFAULT cCsosn    \t\t:= \"\"\r\nDEFAULT cMensDifal\t\t:= \"\"\r\nDEFAULT nVicmsDeson\t\t:= 0\r\nDEFAULT nVIcmDif\t\t:= 0\r\nDEFAULT nIcmsDif\t\t:= 0 \r\nDEFAULT nvFCPUFDest\t\t:= 0\r\nDEFAULT nvICMSUFDest\t:= 0\r\nDEFAULT nvICMSUFRemet\t:= 0\r\nDEFAULT nvBCUFDest\t\t:= 0\r\nDEFAULT nTotProd\t\t:= 0\r\nDEFAULT nItProd\t\t\t:= 0\r\nDEFAULT nValDifer\t\t:= 0\r\n\r\ncVerAmb     := PARAMIXB[2]\r\ncAmbiente\t:= PARAMIXB[3]\r\ncF2Tipo\t:= IIF(!Empty(aNota[5]),aNota[5], \"N\")\r\ncArt274 := aProd[48]\r\n//Se o campo B1_CODGTIN estiver preenchido considera ele em promeiro lugar  para levar para nfe.\r\n//Porem se  B1_CODGTIN  ='999999999999999' e levando \"\" sendo tratado pelo tss \"SEM GETIN\"\r\n//Se B1_CODGTIN =  \"\" vaziu continua pegando do legado B1_CODBAR para levar para nfe.\r\ncEan\t\t:= IIF(!Empty(aProd[46]),iif( aProd[46] == \"000000000000000\",\"\",aProd[46]), aProd[03])\r\n\r\n//Se a segunda unidade de medida estiver \"B5_2CODBAR\" estiver preenchido leva ele  para nfe.\r\n//senão verifica se a unidade comercial e diferente da tributaria para considerar o mesmo valor da cEan se for igual.\r\ncEantrib\t:= IIF(!Empty(aProd[45]),aProd[45], iif( aProd[08] <> aProd[11],\"\",cEan))\r\n\r\n//Validação para controle das tags que deverão ser preenchidas apenas nas operações não destinadas a consumidor final RS\r\nlRetEfet := (cMVEstado == \"RS\" .and. cIndFinal == '0') .or. cMVEstado <> \"RS\"\r\n\r\ncString += '<det nItem=\"'+ConvType(aProd[01])+'\">'\r\ncString += '<prod>'\r\ncString += '<cProd>'+ConvType(aProd[02])+'</cProd>'\r\ncString += '<ean>'+ConvType(cEan)+'</ean>'\r\ncString += '<Prod>'+ConvType(aProd[04],120)+'</Prod>'\r\nIf len(aDI)> 0\r\n\tcString +='<NCM>'+ConvType(aDI[01][03])+'</NCM>'\r\n\tIf cVerAmb >= \"3.10\" .and. ConvType(aDI[04][1]) == \"I19\"\r\n\t\tcString += NfeTag('<NVE>',ConvType(aDI[35][03]))\r\n\tElseIf cVerAmb >= \"3.10\" .and. ConvType(aDI[02][1]) == \"I19\" //Nota Complementar EEC/EIC\r\n\t\tcString += NfeTag('<NVE>',ConvType(aDI[17][03]))\t\r\n\tEndIf\r\nElse\r\n\tcString +='<NCM>'+ConvType(aProd[05])+'</NCM>'\r\nEndIf\r\ncString += NfeTag('<CEST>',ConvType(aProd[41]))\r\n\r\nIF cVeramb >= \"4.00\"\r\n\tcString += NfeTag('<indEscala>',ConvType(aProd[47]))\r\n\tcString += NfeTag('<cBenef>',ConvType(aProd[44]))\r\n\r\nEndIf\r\ncString += NfeTag('<EXTIPI>',ConvType(aProd[06]))\r\ncString += '<CFOP>'+ConvType(aProd[07])+'</CFOP>'\r\ncString += '<uCom>'+ConvType(aProd[08])+'</uCom>'\r\ncString += '<qCom>'+ConvType(round(aProd[09],4),15,4 )+'</qCom>' // bruno original = ConvType( aProd[09],15,4 )\r\n\r\n/*\r\nbruno sigawise\r\n-original = cString += '<vUnCom>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[09],21,8))+'</vUnCom>'\r\n-não tem o if\r\n*/\r\nIf aProd[8] <> aProd[11]\r\n\tcString += '<vUnCom>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[09],21,8))+'</vUnCom>'\r\nElse\r\n\tcString += '<vUnCom>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[12],21,8))+'</vUnCom>'\r\nEndIf\r\n\r\ncString += '<vProd>' +ConvType(aProd[10],15,2)+'</vProd>' \r\ncString += '<eantrib>'+ConvType(cEantrib)+'</eantrib>'\r\ncString += '<uTrib>'+ConvType(aProd[11])+'</uTrib>'\r\nIf aProd[8] <> aProd[11]  // aProd[8] = B1_UM  e  aProd[11] = B5_UMDIPI - pega diferente para segunda unidade de medida \r\n\tcString += '<qTrib>' + ConvType(aProd[12], 15, TamSX3(\"B5_CONVDIP\")[2]) + '</qTrib>'\r\nElse\r\n\tcString += '<qTrib>' + ConvType(aProd[12], 15, Min(IIf(cTipo == \"0\", TamSX3(\"D1_QUANT\")[2], TamSX3(\"D2_QUANT\")[2]), 4)) + '</qTrib>'\r\nEndif\r\n\r\ncString += '<vUnTrib>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[12],21,8))+'</vUnTrib>'\t\r\n\r\ncString += NfeTag('<vFrete>',ConvType(aProd[13],15,2))\r\ncString += NfeTag('<vSeg>'  ,ConvType(aProd[14],15,2))\r\n\r\n//Tag <vDesc>\r\n//Quando eh Zona Franca de Manaus\r\nIf cVerAmb >= \"3.10\" .and. Len(aICMSZFM) > 0 .And. Len(aCST) > 0 .And. !Empty(aICMSZFM[1])\r\n\tIf !(lMvNFLeiZF)\t\r\n\t\tcString += NfeTag('<vDesc>' ,ConvType((aProd[31]+aProd[32])+aProd[15],15,2))\t\r\n\tElse\t\r\n\t\tcString += NfeTag('<vDesc>' ,ConvType(aProd[15],15,2))\r\n\tEndif\r\nElse\r\n\t//Versao 2.00\r\n\tcString += NfeTag('<vDesc>' ,ConvType((aProd[15]),15,2))\r\nEndIf\r\n\r\ncString += NfeTag('<vOutro>' ,ConvType(aProd[49]+aProd[21]+Iif(aAgrPis[01],aAgrPis[02],0)+Iif(aAgrCofins[01],aAgrCofins[02],0),15,2))\r\n// Define se o valor do produto <vProd> será agregado ao valor total\r\n//   dos produtos do documento <vProd> dentro de <total>\r\ncString += '<indTot>'+aProd[24]+'</indTot>'\r\n\r\n/* Adequação Nota Técnica 2013/003 (Obs. Tratamento apenas para documento de saída pois refere-se a venda ao consumidor) */\r\nIf cTipo == \"1\" .And. cTpCliente == \"F\"\r\n\tcString += NfeTag('<vTotTrib>' ,ConvType(aProd[30],15,2))\r\nEndIf\r\n\r\n\r\n/*Nas situações em que o valor unitário comercial (vUnCom) for diferente do valor unitário tributável (vUnTrib), \r\nambas as informações deverão estar expressas e identificadas no DANFE - CH:TGCOQA*/\r\n\r\ncVunCom := ConvType(aProd[10]/aProd[09],21,8)\r\ncVunTrib:= ConvType(aProd[10]/aProd[12],21,8)\r\n\r\nIf (cVunCom <> cVunTrib) .and. lUnTribCom\r\n\tcMensFis += \" \"\r\n\tcMensFis += \"(Valor unitario comercial: \"+cVunCom+ \", \"\r\n\tcMensFis += \"Valor unitario tributavel: \"+cVunTrib+ \") \"\t\r\nEndIf\r\n\r\n//³Criação de novo grupo “Rastreabilidade de produto” para permitir a rastreabilidade de qualquer produto sujeito a regulações sanitárias.\r\nIf\tcVeramb >= \"4.00\" .and. !empty(aLote)\r\n    If  !empty(aLote[1])\r\n\t\tcString += '<rastro>'\r\n\t\tcString += '<nLote>'+ConvType(aLote[01])+'</nLote>'\r\n\t\tcString += '<qLote>'+ConvType(aLote[02],12,3)+'</qLote>'\r\n\t\tcString += '<dFab>'+ConvType(aLote[03]) +'</dFab>'\r\n\t\tcString += '<dVal>'+ConvType(aLote[04]) +'</dVal>'\r\n\t\tcString += NfeTag('<cAgreg>',ConvType(aLote[05]))\r\n\t\tcString += '</rastro>'\r\n\tEndIf\r\nEndIf \r\n\r\n//Ver II - Average - Tag da Declaração de Importação aDI\r\nIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\"\r\n\tcString += '<DI>'\r\n\tcString += '<nDI>'+ConvType(aDI[04][03])+'</nDI>'\r\n\tcString += '<dtDi>'+ConvType(aDI[05][03])+ '</dtDi>'      \r\n\tcString += '<LocDesemb>'+ConvType(aDI[06][03])+ '</LocDesemb>'\r\n\tcString += '<UFDesemb>'+ConvType(aDI[07][03])+ '</UFDesemb>'\r\n\tcString += '<dtDesemb>'+ConvType(aDI[08][03])+ '</dtDesemb>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<viaTransp>'+ConvType(aDI[36][03],2)+ '</viaTransp>'\r\n\t\tcString += NfeTag('<AFRMM>',ConvType(aDI[37][3],15,2))\r\n\t\tcString += '<intermedio>'+ConvType(aDI[38][03],1)+ '</intermedio>'\r\n\t\tcString += NfeTag('<CNPJ>',ConvType(aDI[39][3],14))\r\n\t\tcString += NfeTag('<UfTerceiro>',ConvType(aDI[40][3],2))\t\t\r\n\tEndIf\r\n\tcString += '<Exportador>'+ConvType(aDI[09][03])+ '</Exportador>'\r\n\tIf Len(aAdi)>0\r\n\t\tcString += '<adicao>'\r\n\t\tcString += '<Adicao>'+ConvType(aAdi[10][03])+ '</Adicao>'\r\n\t\tcString += '<SeqAdic>'+ConvType(aAdi[11][03])+ '</SeqAdic>'\r\n\t\tcString += '<Fabricante>'+ConvType(aAdi[12][03])+ '</Fabricante>'\r\n\t\tcString += '<vDescDI>'+ConvType(aAdi[13][03])+ '</vDescDI>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += NfeTag('<draw>',ConvType(aAdi[34][3],11))\r\n\t\tEndIf\r\n\t\tcString += '</adicao>'\r\n\tEndIf\r\n\tcString += '</DI>'\r\n\t/*Impressão dos dados da DI nas informações complementares do Danfe - CH:TELKDV*/\r\n\tIf lDInoDanfe\r\n\t\tcMsgDI  := \" \"\r\n\t\tcMsgDI += \"(Numero DI: \"+ConvType(aDI[04][03])+ \", \"\r\n\t\tcMsgDI += \"Local do Desembaraco: \"+ConvType(aDI[06][03])+ \", \"\r\n\t\tcMsgDI += \"UF do Desembaraco: \"+ConvType(aDI[07][03])+\", \"\r\n\t\tcMsgDI += \"Data do Desembaraco: \"+ConvType(aDI[08][03])+ \") \"\t\r\n\r\n\t\tIf !cMsgDI $ cMensFis\r\n\t\t\tcMensFis += cMsgDI\r\n\t\tEndIf\r\n\tEndIf\r\nElseif Len(aDI)>0\r\n\t//Nota Complementar - SIGAEIC estrutura 23X3\r\n\tcString += '<DI>'\r\n\tcString += '<nDI>'+ConvType(aDI[02][03])+'</nDI>'\r\n\tcString += '<dtDi>'+ConvType(aDI[03][03])+ '</dtDi>'      \r\n\tcString += '<LocDesemb>'+ConvType(aDI[04][03])+ '</LocDesemb>'\r\n\tcString += '<UFDesemb>'+ConvType(aDI[05][03])+ '</UFDesemb>'\r\n\tcString += '<dtDesemb>'+ConvType(aDI[06][03])+ '</dtDesemb>'\r\n\t\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<viaTransp>'+ConvType(aDI[18][03],2)+ '</viaTransp>'\r\n\t\tcString += NfeTag('<AFRMM>',ConvType(aDI[19][3],15,2))\r\n\t\tcString += '<intermedio>'+ConvType(aDI[20][03],1)+ '</intermedio>'\r\n\t\tcString += NfeTag('<CNPJ>',ConvType(aDI[21][3],14))\r\n\t\tcString += NfeTag('<UfTerceiro>',ConvType(aDI[22][3],2))\t\t\r\n\tEndIf\r\n\tcString += '<Exportador>'+ConvType(aDI[07][03])+ '</Exportador>'\r\n\tIf Len(aAdi)>0\r\n\t\tcString += '<adicao>'\r\n\t\tcString += '<Adicao>'+ConvType(aAdi[08][03])+ '</Adicao>'\r\n\t\tcString += '<SeqAdic>'+ConvType(aAdi[09][03])+ '</SeqAdic>'\r\n\t\tcString += '<Fabricante>'+ConvType(aAdi[10][03])+ '</Fabricante>'\r\n\t //\tcString += '<vDescDI>'+ConvType(aAdi[13][03])+ '</vDescDI>'\r\n\t \tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += NfeTag('<draw>',ConvType(aAdi[23][3],11))\r\n\t\tEndIf\r\n\t\tcString += '</adicao>'\r\n\tEndIf\r\n\tcString += '</DI>'\r\n\t/*Impressão dos dados da DI nas informações complementares do Danfe - CH:TELKDV*/\r\n\tIf lDInoDanfe\r\n\t\tcMsgDI := \" \"\r\n\t\tcMsgDI += \"(Numero DI: \"+ConvType(aDI[02][03])+ \", \"\r\n\t\tcMsgDI += \"Local do Desembaraco: \"+ConvType(aDI[04][03])+ \", \"\r\n\t\tcMsgDI += \"UF do Desembaraco: \"+ConvType(aDI[05][03])+\", \"\r\n\t\tcMsgDI += \"Data do Desembaraco: \"+ConvType(aDI[06][03])+ \") \"\t\r\n\r\n\t\tIf !cMsgDI $ cMensFis\r\n\t\t\tcMensFis += cMsgDI\r\n\t\tEndIf\r\n\tEndIf\r\nEndIf\r\n\r\n/*Grupo de informações de exportação para o item - versão 3.10*/\r\nIf cVerAmb >= \"3.10\" .and. Len(aExp)>0\r\n\tIf lEECFAT\r\n\t\t/*Quando a terceira posição do array estiver vazia ou possuir tamanho 0 é porque a informação não existe no processo.\r\n\t\t  Quando não houver dados de retorno referente ao ato concessório e a exportação indireta, a posição [3][3] terá tamanho 0.\r\n\t\t  Quando houver ato concessório, a informação será retornada na posição [3][3][1]. O tamanho dessa dimensão corresponde à quantidade de atos concessórios encontrados para o item.\r\n\t\t  Quando houver exportação indireta, a informação será retornada na posição [3][3][2]. O tamanho dessa dimensão corresponde à quantidade de notas fiscais de remessa com fim específico de exportação encontrada para o item.\r\n\t\t*/\r\n\t\tIf ConvType(aExp[03][1]) == \"I50\" .and. Len(aExp[03][3]) > 0\r\n\t\t\t\r\n\t\t\t\tFor nA:= 1 to Len(aExp[03][3][1])\r\n\t\t\t\t\tanDraw:= aExp[03][3][1][nA] //Array (tag nDraw - I51)\r\n\t\t\t\t\taExportInd:= aExp[03][3][2][nA]//Array I52(Grupo - I52)\r\n\t\t\t\t\t\r\n\t\t\t\t\tcString += '<detExport>'\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(anDraw[3])\r\n\t\t\t\t\t\tcString += '<Draw>'+ConvType(anDraw[3],11)+ '</Draw>'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Caso não tenha I52, posição 3 é retornada vazia\r\n\t\t\t\t\tIf !Empty(aExportInd[3])\r\n\t\t\t\t\t\tcString += '<exportInd>'\r\n\t\t\t\t\t\tcString += '<nre>'+ConvType(aExportInd[03][1][3],12)+ '</nre>'\r\n\t\t\t\t\t\tcString += '<chnfe>'+ConvType(aExportInd[03][2][3],44)+ '</chnfe>'\r\n\t\t\t\t\t\tcString += '<qExport>'+ConvType(aExportInd[03][3][3],15,4)+ '</qExport>'\r\n\t\t\t\t\t\tcString += '</exportInd>'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tcString += '</detExport>'\r\n\t\t\t\tNext\r\n\t\t\t\r\n\t\tEndIf\r\n\t// Para nota de devolução de exportação gerar a tag  exportInd para não ocorrer a rejeição:340\r\n\t//340-Rejeicao: Nao informado o grupo de exportacao indireta no item [nItem:1] chamado:TVTAA8                                                                                                                                                                                  \r\n\tElseIf !lEECFAT .and. aNota[04] == \"0\" .and. aNota[5] $ \"D|N\"  \r\n\t\tFor nX := 1 To Len(aExp)\r\n\t\t\t   IF !Empty(aExp[nX][03][03]) .Or. !Empty(aExp[nX][04][03]) \r\n\t\t\t\t\tcString += '<detExport>'\r\n\t\t\t\t\tIf !Empty(aExp[nX][04][03])\r\n\t\t\t\t\t\tcString += '<exportInd>'\r\n\t\t\t\t\t\tcString += '<nre>'+ConvType(aExp[nX][04][03],12)+ '</nre>'\r\n\t\t\t\t\t\tcString += '<chnfe>'+ConvType(aExp[nX][05][03],44)+ '</chnfe>'\r\n\t\t\t\t\t\tcString += '<qExport>'+ConvType(aExp[nX][06][03],15,4)+ '</qExport>'\r\n\t\t\t\t\t\tcString += '</exportInd>'\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcString += '</detExport>'\r\n\t\t\t\tEndif\r\n\t\tNext\t\r\n\tElse\r\n\t\tFor nX := 1 To Len(aExp)\r\n\t\t\tIf ConvType(aExp[nX][03][1]) == \"I51\"\r\n\t\t\t   IF !Empty(aExp[nX][03][03]) .Or. aExp[nX][08][03] == \"1\" .Or. (!Empty(aExp[nX][04][03]) .And. !Empty(aExp[nX][05][03]) .And. !Empty(aExp[nX][06][03]))\r\n\t\t\t\t\tcString += '<detExport>'\r\n\t\t\t\t\tcString += '<Draw>'+ConvType(aExp[nX][03][03],11)+ '</Draw>'\r\n\t\t\t\t\tIf aExp[nX][08][03] == \"1\" .Or. (!Empty(aExp[nX][04][03]) .And. !Empty(aExp[nX][05][03]) .And. !Empty(aExp[nX][06][03]))\r\n\t\t\t\t\t\tcString += '<exportInd>'\r\n\t\t\t\t\t\tcString += '<nre>'+ConvType(aExp[nX][04][03],12)+ '</nre>'\r\n\t\t\t\t\t\tcString += '<chnfe>'+ConvType(aExp[nX][05][03],44)+ '</chnfe>'\r\n\t\t\t\t\t\tcString += '<qExport>'+ConvType(aExp[nX][06][03],15,4)+ '</qExport>'\r\n\t\t\t\t\t\tcString += '</exportInd>'\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcString += '</detExport>'\r\n\t\t\t\tEndif\r\n\t\t\tEndIf\r\n\t\tNext \r\n\tEndIf\r\nEndif\r\n//Combustiveis\r\n\r\nIf Len(aComb) > 0  .And. !Empty(aComb[01])\r\n\tcString += '<comb>'\r\n\tcString += '<cprodanp>'+ConvType(aComb[01])+'</cprodanp>'\r\n\tIf cVeramb >= \"3.10\" .and. Len(aComb) > 4\r\n\t\tcString += NfeTag('<mixGN>',ConvType(aComb[08],7,4))\r\n\tEndIf\r\n\t\r\n\tIf\tcVeramb >= \"4.00\" .and. Len(aComb) > 4\r\n\t\tcString += '<descANP>'+ConvType(aComb[14])+'</descANP>'\r\n\t\tcString += NfeTag('<pGLP>',ConvType(aComb[15],15,4))\r\n\t\tcString += NfeTag('<pGNn>',ConvType(aComb[16],15,4))\r\n\t\tcString += NfeTag('<pGNi>',ConvType(aComb[17],15,4))\r\n\t\tcString += NfeTag('<vPart>',ConvType(aComb[18],13,2))\r\n\tEndif\r\n\t\r\n\tcString += NfeTag('<codif>',ConvType(aComb[02]))\r\n\r\n\tcString += NfeTag('<qTemp>',ConvType(aComb[03],12,4))\r\n\tcString += '<ICMSCONS>'\r\n\tcString += '<UFCons>'+aComb[04]+'</UFCons>'\r\n    cString += '</ICMSCONS>'\t\r\n    If Len(aComb) > 4 .and. !Empty(aComb[05])\r\n\t\tcString += '<CIDE>'\r\n\t\tcString += '<qBCProd>'+ConvType(aComb[05],16,2)+'</qBCProd>'\r\n\t\tcString += '<vAliqProd>'+ConvType(aComb[06],15,4)+'</vAliqProd>'\r\n\t\tcString += '<vCIDE>'+ConvType(aComb[07],15,2)+'</vCIDE>'\r\n\t\tcString += '</CIDE>'\r\n\tEndif\t\r\n\t/*NT 2015/002\r\n\t379 - Rejeição: Grupo de Encerrante na NF-e (modelo 55) para CFOP diferente \r\n\tde venda de combustível para consumidor final (CFOP=5.656, 5.667).\t\r\n\t*/\r\n\tIf Len(aComb) > 4 .and. !Empty(aComb[09])\r\n\t\tcString += '<encerrante>'\r\n\t\tcString += '<nBico>'+ConvType(aComb[09])+'</nBico>'\r\n\t\tcString += NfeTag('<nBomba>',ConvType(aComb[10]))\r\n\t\tcString += '<nTanque>'+ConvType(aComb[11])+'</nTanque>'\r\n\t\tcString += '<vEncIni>'+ConvType(aComb[12],15)+'</vEncIni>'\r\n\t\tcString += '<vEncFin>'+ConvType(aComb[13],15)+'</vEncFin>'\r\n\t\tcString += '</encerrante>'\t\t\r\n\tEndIf\r\n\tcString += '</comb>'\r\n\r\nElseIf !Empty(aProd[17])\r\n\tcString += '<comb>'\r\n\tcString += '<cprodanp>'+ConvType(aProd[17])+'</cprodanp>'\r\n\tcString += NfeTag('<codif>',ConvType(aProd[18]))\r\n\tcString += '</comb>'\r\n\t//Tratamento da CIDE - Ver com a Average\r\n\t//Tratamento de ICMS-ST - Ver com fisco\r\nEndIf\r\n\r\n//Veiculos Novos\r\nIf !Empty(aveicProd) .And. !Empty(aveicProd[02])\r\n\tcString += '<veicProd>'\r\n\tcString += '<tpOp>'+ConvType(aveicProd[01])+'</tpOp>'\r\n\tcString += '<chassi>'+ConvType(aveicProd[02],17)+'</chassi>'\r\n\tcString += '<cCor>'+ConvType(aveicProd[03],4)+'</cCor>'\r\n\tcString += '<xCor>'+ConvType(aveicProd[04],40)+'</xCor>'\r\n\tcString += '<pot>'+ConvType(aveicProd[05],4)+'</pot>'\r\n\tcString += '<Cilin>'+ConvType(aveicProd[23],4)+'</Cilin>'\r\n\t//Alteração efeutada para permitir que de acorodo com o Manual NFE 6.0, \r\n\t//quando peso liquido e bruto forem em toledas que se tenham 4 casas decimais.\r\n\tcString += '<pesol>'+ConvType(aveicProd[07],9,4)+'</pesol>'\r\n\tcString += '<pesob>'+ConvType(aveicProd[08],9,4)+'</pesob>'\t\r\n\tcString += '<nserie>'+ConvType(aveicProd[09],9)+'</nserie>'\r\n\tcString += '<tpcomb>'+ConvType(aveicProd[10],2)+'</tpcomb>'\r\n\tcString += '<nmotor>'+ConvType(aveicProd[11],21)+'</nmotor>'\r\n\tcString += '<CMT>'+ConvType(aveicProd[24],9)+'</CMT>' \r\n\tcString += '<dist>'+ConvType(aveicProd[13],4)+'</dist>'\r\n\tcString += '<anomod>'+ConvType(aveicProd[15],4)+'</anomod>'\r\n\tcString += '<anofab>'+ConvType(aveicProd[16],4)+'</anofab>'\r\n\tcString += '<tppint>'+ConvType(aveicProd[17],1)+'</tppint>'\r\n\tcString += '<tpveic>'+ConvType(aveicProd[18],2)+'</tpveic>'\r\n\tcString += '<espvei>'+SubStr(aveicProd[19],2,1)+'</espvei>'  // Considera apenas a segunda posição do campo CD9_ESPVEI\r\n\tcString += '<vin>'+ConvType(aveicProd[20],1)+'</vin>'\r\n\tcString += '<condvei>'+ConvType(aveicProd[21],1)+'</condvei>'\r\n\tcString += '<cmod>'+ConvType(aveicProd[22],6)+'</cmod>'\r\n\tcString += '<cCorDENATRAN>'+ConvType(aveicProd[26],2)+'</cCorDENATRAN>'\r\n\tcString += '<Lota>'+ConvType(aveicProd[25],3)+'</Lota>'\r\n\tcString += '<tpRest>'+ConvType(aveicProd[27],1)+ '</tpRest>'\r\n\tcString += '</veicProd>'                            \r\nEndIf \r\n\r\n\r\n//Medicamentos\r\nIf !Empty(aMed) .And. !Empty(aMed[01])\r\n\tcString += '<med>'\t\r\n\tcString += '<cProdANVISA>'+ConvType(aMed[06],13)+'</cProdANVISA>'\r\n\tIf lTagProduc .and. !Empty(aMed[07])\r\n\t\tcString += '<MotivoIsencao>'+ConvType(aMed[07],225)+'</MotivoIsencao>'\r\n\tEndIf\r\n\tcString += '<Lote>'+ConvType(aMed[01],20)+'</Lote>'\r\n\tcString += NfeTag('<qLote>',ConvType(aMed[02],11,3))\r\n\tcString += NfeTag('<dtFab>',ConvType(aMed[03]))\r\n\tcString += NfeTag('<dtVal>',ConvType(aMed[04]))\r\n\tcString += '<vPMC>'+ConvType(aMed[05],15,2)+'</vPMC>'\r\n\tcString += '</med>'                            \r\nEndIf \r\n\r\n//Armas de Fogo\r\nIf !Empty(aArma) .And. !Empty(aArma[01])\r\n\tcString += '<arma>'\t\r\n\tcString += '<tpArma>'+ConvType(aArma[01])+'</tpArma>'\r\n\tIf cVeramb >= \"3.10\"\r\n\t\tcString += NfeTag('<nSerie>',ConvType(aArma[02],15))\r\n\t\tcString += NfeTag('<nCano>' ,ConvType(aArma[02],15))\r\n\tElse\r\n\t\tcString += NfeTag('<nSerie>',ConvType(aArma[02],9))\r\n\t\tcString += NfeTag('<nCano>' ,ConvType(aArma[02],9))\r\n\tEndIf\r\n\tcString += NfeTag('<descr>' ,ConvType(aArma[03],256))\r\n\tcString += '</arma>'                            \r\nEndIf \r\n\r\n//RECOPI\r\nIf cVeramb >= \"3.10\" .and. !Empty(cNumRecopi)\r\n\tcString += '<Recopi>'\r\n\tcString += '<nRECOPI>'+cNumRecopi+'</nRECOPI>'\r\n\tcString += '</Recopi>'\r\nEndIf\r\n\r\nIf Len(aPedCom) > 0 .And. !Empty(aPedCom[01])\r\n\tcString += '<xPed>'+ConvType(aPedCom[01])+'</xPed>'\r\n\tcString += '<nItemPed>'+ConvType(aPedCom[02])+'</nItemPed>'\r\nEndif\r\n\r\n//Nota Técnica 2013/006\r\nIf !Empty(aFCI)\r\n\tcString += '<nFCI>'+Alltrim(aFCI[01])+'</nFCI>'\r\nEndIf\r\ncString += '</prod>'\r\nDbSelectArea(\"SF4\")\r\n\r\nlIssQn:=(Len(aISSQN)>0 .and. !Empty(aISSQN[01]))\r\n\r\nIf (aCST[01] = \"60\" .or. cCsosn$ \"500\") .and. !Empty(cUltAqui)  .and. Len(aIcms)>19\r\n\t//novos campos na tabela SFT são: FT_BSTANT (Base) FT_PSTANT (Percentual) FT_VSTANT (Valor) Atenciosamente.\r\n\tnBaseIcm :=  aICMS[20]      //SFT->FT_BSTANT\r\n\tnValICM  :=  aICMS[21]      //SFT->FT_VSTANT\r\n\tnAlqICM  :=  aICMS[22]      //SFT->FT_PSTANT\r\n\t//novos campos do FECP na tabela SFT são: FT_BFCANTS (Base) FT_PFCANTS (Percentual) FT_VFCANTS (Valor) Atenciosamente.\r\n\tnBfcpant := aICMS[23]    //SFT->FT_BFCANTS\r\n\tnAfcpant := aICMS[24]    //SFT->FT_PFCANTS\r\n\tnVfcpant := aICMS[25]    //SFT->FT_VFCANTS\r\n\r\n\tnVICPRST := aICMS[26]   // FT_VICPRST  (Tag vICMSSubstituto)\r\nEndif\r\n\r\nIf  !lIssQn    \r\n\tIf cMVCODREG == \"1\" .and. SF4->(FieldPos(\"F4_CSOSN\"))>0 .And. !Empty(SF4->F4_CSOSN)\r\n\t\r\n\t\tIf Len(aIcms)>0\t\t\t\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>ICMSSN</codigo>'\r\n\t\t \tcString += '<cpl>'\r\n\t\t   \tcString += '<orig>'+ConvType(aICMS[01])+'</orig>'\r\n\t\t   \tcString += '</cpl>' \r\n\t\t   \tcString += '<Tributo>'\r\n\t\t\tcString += '<CSOSN>'+cCsosn+'</CSOSN>'   \r\n\t\tElse\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>ICMSSN</codigo>'\r\n\t\t \tcString += '<cpl>'\r\n\t\t   \tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\r\n\t\t   \tcString += '</cpl>' \r\n\t\t   \tcString += '<Tributo>'\r\n\t\t\tcString += '<CSOSN>'+cCsosn+'</CSOSN>' \t\r\n\t\tEndif\t\r\n\t\t\r\n\t\tIf cCsosn$\"900\" .And. Len(aIcms)>0\t    \r\n\t\t\tcString += '<modBC>'+ConvType(aICMS[03])+'</modBC>'\r\n\t\t\tcString += '<vBC>'+ConvType(aICMS[05],15,2)+'</vBC>'\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\" .And. !Empty(aAdi[14][03])\t\t\t \r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\r\n\t\t   \tElse\r\n\t   \t\t\tcString += '<pRedBC>'+ConvType(aICMS[04],8,4)+'</pRedBC>'\r\n\t\t\tEndIf\r\n\t\t\tcString += '<pICMS>'+ConvType(aICMS[06],5,2)+'</pICMS>'\r\n\t\t\tcString += '<vICMS>'+ConvType(aICMS[07],15,2)+'</vICMS>'\r\n\t\t\t\r\n\t\tElseIf cCsosn$\"900\" .And. Len(aIcms)<=0\t  \r\n\t\t\tcString += '<modBC>'+ConvType(0)+'</modBC>'\r\n\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\" .And. !Empty(aAdi[14][03])\t\t\t \r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\t\t\t \r\n\t\t   \tElse\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\t\t   \t\r\n\t\t\tEndIf\r\n\t\t\tcString += '<pICMS>'+ConvType(0,5,2)+'</pICMS>'\r\n\t\t\tcString += '<vICMS>'+ConvType(0,15,2)+'</vICMS>'\r\n\t\t\t\r\n\t    Endif\r\n\t\t\r\n\t\tIf cCsosn$\"201,202,203,900\" .AND. Len(aICMSST)>0\t\r\n\t\t\tcString += '<modBCST>'+ConvType(aICMSST[03])+'</modBCST>'\r\n\t\t\tIf cVeramb >= \"3.10\"\r\n\t\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],8,4)+'</pmvast>'\r\n\t\t\t\tcString += '<pRedBCST>'+ConvType(aICMSST[04],7,4)+'</pRedBCST>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],6,2)+'</pmvast>'\r\n\t\t\t\tcString += '<pRedBCST>'+ConvType(aICMSST[04],5,2)+'</pRedBCST>'\r\n\t\t\tEndIf\t\t\t\r\n\t\t\tcString += '<vBCST>'+ConvType(aICMSST[05],15,2)+'</vBCST>'\r\n\t\t\tcString += '<pICMSST>'+ConvType(aICMSST[06],5,2)+'</pICMSST>'\r\n\t\t\tcString += '<vICMSST>'+ConvType(aICMSST[07],15,2)+'</vICMSST>'\r\n\t    Elseif cCsosn$\"201,202,203,900\"\r\n\t    \tcString += '<modBCST>0</modBCST>'\r\n\t\t\tcString += '<vBCST>'+ConvType(0,15,2)+'</vBCST>'\r\n\t\t\tcString += '<pICMSST>'+ConvType(0,5,2)+'</pICMSST>'\r\n\t\t\tcString += '<vICMSST>'+ConvType(0,15,2)+'</vICMSST>'\r\n\t\t\t\r\n\t\t\tIF cVeramb >= \"4.00\" .AND. Len(aICMSST)>0 \r\n\t\t\t   IF cCsosn$ \"201\"\r\n\t\t\t\t\tcString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\t\t\t\r\n\t\t\t\t//pCredSN Alíquota aplicável de cálculo do crédito\r\n             // vCredICMSSN Valor crédito do ICMS\t\r\n\t\t\t   elseIf  cCsosn$ \"202,203\"\r\n\t\t\t        cString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\t\t   Endif\t\r\n\t\t\tEndif\r\n\t\tEndif\r\n\t\t\r\n\t\tIf cCsosn$\"500\"   \r\n\t\t\tIf Empty(cUltAqui) \r\n\t\t\t\tSPEDRastro2(aProd[20],aProd[19],aProd[02],@nBaseIcm,@nValICM,,,lCalcMed,@nAlqICM,,,,,,,,,,,@nBfcpant,@nAfcpant,@nVfcpant)        \r\n\t\t\t\r\n\t\t\t\tIf nBaseIcm > 0 .and. nValICM>0\r\n\t\t\t\t\tnBaseIcm := aProd[09]*nBaseIcm\r\n\t\t\t\t\tnValICM  := aProd[09]*nValICM\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t//multiplica o valor facp anterior.\r\n\t\t\t\tIf\tnBfcpant > 0 .and. nVfcpant>0\r\n\t\t\t\t\tnBfcpant  := aProd[09]*nBfcpant\r\n\t\t\t\t\tnVfcpant  := aProd[09]*nVfcpant\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tif lRetEfet\r\n\t\t\t\r\n\t\t\t\tIf nBaseIcm > 0\r\n\t\t\t\t\tcString += '<vBCSTRet>'+ConvType(nBaseIcm,15,2)+'</vBCSTRet>' \r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<vBCSTRet>'+ConvType(0,15,2)+'</vBCSTRet>'\r\n\t\t\t\tEndif\r\n\t\t\t\tIf nValICM > 0\r\n\t\t\t\t\tcString += '<vICMSSTRet>'+ConvType(nValICM,15,2)+'</vICMSSTRet>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<vICMSSTRet>'+ConvType(0,15,2)+'</vICMSSTRet>'\r\n\t\t\t\tEndif \r\n\t\t\t\t\r\n\t\t\t\tIf cVeramb >= \"4.00\" .AND. Len(aICMSST)>0\t\r\n\t\t\t\t\tcString += '<pST>'+ConvType((aICMSST[06]+aICMSST[14]),5,2)+'</pST>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<pST>'+ConvType((nAlqICM),5,2)+'</pST>'\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf lTagProduc \r\n\t\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\t\tEndif\r\n\r\n\t\t\t\tcString += '<vBCFCPSTRet>'+ConvType(nBfcpant,15,2)+'</vBCFCPSTRet>'\r\n\t\t\t\tcString += '<pFCPSTRet>'+ConvType(nAfcpant,5,2)+'</pFCPSTRet>'\r\n\t\t\t\tcString += '<vFCPSTRet>'+ConvType(nVfcpant,15,2)+'</vFCPSTRet>'\r\n\t\t\tendif\r\n\t\t\t\r\n\t\t\t//Tratamento implementado para atender o DECRETO Nº 54.308, DE 6 DE NOVEMBRO DE 2018. (publicado no DOE n.º 212, de 7 de novembro de 2018)\t\t\t\t\t\r\n\t\t\tIf cIndFinal == \"1\"\t.and. Len(aIcms)>0\t\t\t\t \r\n\t\t\t\tcString += '<pRedBCEfet>'+ConvType(aICMS[4],8,4)+'</pRedBCEfet>'\r\n\t\t\t\tcString += '<vBCEfet>'+ConvType( aICMS[5] ,16,2)+'</vBCEfet>'\r\n\t\t\t\tcString += '<pICMSEfet>'+ConvType(aICMS[6],8,4)+'</pICMSEfet>'\r\n\t\t\t\tcString += '<vICMSEfet>'+ConvType(aICMS[7],16,2)+'</vICMSEfet>'\r\n\t\t\tEndif\r\n\t\tEndif\r\n\t\t\r\n\t\tIF cVeramb >= \"4.00\" .AND. cCsosn$\"201,202,900\" .AND. Len(aICMSST)>0\t\r\n\t\t\tcString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\tEndIf\t\r\n\t\t\r\n\t\tIf cCsosn$\"101,201,900,\" .And. Len(aIcms)>0\t   \r\n\t\t\tcString += '<pCredSN>'+ConvType(aICMS[06],5,2)+'</pCredSN>'    \r\n\t\t\tcString += '<vCredICMSSN>'+ConvType(aICMS[07],15,2)+'</vCredICMSSN>'\r\n\t\tElseIf cCsosn$\"101,201,900,\" .And. Len(aIcms)<=0\t  \r\n\t\t\tcString += '<pCredSN>'+ConvType(0,5,2)+'</pCredSN>'\r\n\t\t\tcString += '<vCredICMSSN>'+ConvType(0,15,2)+'</vCredICMSSN>'\r\n\t\tEndif\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\t\r\n\tElseIf ( Len(aIcms) >0 .And. Len(aIcmsST)> 0 ).And. ( aICMSST[11] == \"2\" .And. aIcms[13] == \"2\" ) .And. aCST[01] $ \"10-90\"\r\n\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSPART</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\t\t\r\n\t\t//cString += '<pmvast>'+ConvType(aICMSST[08],6,2)+'</pmvast>'\r\n\t\tcString += '</cpl>'\t\t\t\t\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>' \r\n\t\tcString += '<modBC>'+ConvType(aICMS[03])+'</modBC>'\t\t\r\n\t\tcString += '<vBC>'+ConvType(aICMS[05],15,2)+'</vBC>'\r\n\t\t//cString += '<pRedBC>'+ConvType(aICMS[04],5,2)+'</pRedBC>'\t\t\r\n\t\tIf cVeramb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMS[06],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMS[06],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tcString += '<valor>'+ConvType(aICMS[07],15,2)+'</valor>'\r\n\t\tcString += '<modBCST>'+ConvType(aICMSST[03])+'</modBCST>'\t\t\r\n\t\t//cString += '<pRedBCST>'+ConvType(aICMSST[04],5,2)+'</pRedBCST>'\t\r\n\t\tcString += '<vBCST>'+ConvType(aICMSST[05],15,2)+'</vBCST>'\t\r\n\t\tIf cVeramb >= \"3.10\"\t\r\n\t\t\tcString += '<aliquotaST>'+ConvType(aICMSST[06],7,4)+'</aliquotaST>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquotaST>'+ConvType(aICMSST[06],5,2)+'</aliquotaST>'\r\n\t\tEndif\r\n\t\tcString += '<valorST>'+ConvType(aICMSST[07],15,2)+'</valorST>'\t\t\r\n\t\tIf cVeramb >= \"3.10\"\r\n\t\t\tcString += '<pBCOp>'+ConvType(aICMS[04],7,4)+'</pBCOp>'\r\n\t\tElse\r\n\t\t\tcString += '<pBCOp>'+ConvType(aICMS[04],5,2)+'</pBCOp>'\r\n\t\tEndIf\r\n\t\tcString += '<UFST>'+aDest[09]+'</UFST>'\t\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\t\r\n\tElse\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMS</codigo>'\r\n\t\tIf Len(aIcms)>0\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += '<orig>'+ConvType(aICMS[01])+'</orig>'\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\t\r\n\t\t\t// No caso de diferimento (CST 51) o cliente que deverá escolher a opção 90\r\n\t\t\t//   caso esteja utilizando a versão 2.00 da NF-e, enquanto não houver adequação.\r\n\t\t\t// o sistema não pode forçar o CST 90\r\n\t\t\tcString += '<CST>'+ConvType(aICMS[02])+'</CST>'\r\n\t\t\t\r\n\t   \t\tIf(aCST[1] $ '40,41,50') .Or. ((aCST[1] == '51') .And. lArt186)\r\n\t   \t\t\tcString += '<vBC>'+'0'+'</vBC>'     \r\n\t\t\t\tIf Len(aICMSZFM)>0 .And. aCST[1] $ '40|41|50'\r\n\t\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMSZFM[02])+'</motDesICMS>'\r\n\t\t\t\t\tcMotDesICMS:= ConvType(aICMSZFM[02])\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMS[11])+'</motDesICMS>' \r\n\t\t\t\t\tcMotDesICMS:= ConvType(aICMS[11])\r\n\t\t\t\tEndIf\t\t\r\n\t\t\tElse\r\n\t\t\t\tIf aICMS[04] == 100 .And. aICMS[02] == \"20\"\r\n\t\t\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\t\t\tElse\r\n\t\t    \t\tcString += '<vBC>'+ConvType(iIf(lIcmDevol,aICMS[05],0),15,2)+'</vBC>'\r\n\t\t    \tEndIf\r\n\t\r\n\t   \t\tEndIf\t\r\n\t\t\tcString += '<modBC>'+ConvType(aICMS[03])+'</modBC>'\r\n\t\t\t\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\" .And. !Empty(aAdi[14][03])\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\t\t\t\t\t\r\n\t\t\tElse\r\n    \t\t\tcString += '<pRedBC>'+ConvType(aICMS[04],8,4)+'</pRedBC>'\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf ( aCST[1] == '51' .And. lArt186 )\r\n\t\t\t\tcString += '<aliquota>0</aliquota>'\t\t\r\n\t\t\tElse\r\n\t\t\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\t\t\tcString += '<aliquota>'+ConvType(iIf(lIcmDevol,aICMS[06],0),7,4)+'</aliquota>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<aliquota>'+ConvType(iIf(lIcmDevol,aICMS[06],0),5,2)+'</aliquota>'\r\n\t\t\t\tEndIf\t\t\t\r\n\t\t\tEndIf\t\t\t\t\r\n\t\t\r\n\t\t\tIf aICMS[04] == 100 .And. aICMS[02] == \"20\"\r\n\t\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\t\tElseIf ( aCST[1] == '51' .And. lArt186 )\r\n\t\t\t\tIf !Empty(aICMS[12]) .and. !Empty(aICMS[07]) .and. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) $ \"RS\"\r\n\t\t\t\t\tcString += '<pDif>100.00</pDif>'\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .And. aICMS[03] == \"2\"\r\n\t\t\t\t\tcString += '<vICMSOp>0</vICMSOp>'\r\n\t\t\t\t\tcString += '<pDif>100.00</pDif>'\r\n\t\t\t\t\tcString += '<vICMSDif>0</vICMSDif>'\r\n\t\t\t\tEndIf\t\r\n\t\t\t\tcString += '<valor>0</valor>'\t\t\t\t\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t\tIf cVerAmb >= \"3.10\" .and. aCST[1] $ '51' .and. !Empty(aICMS[12]) .and. !lArt186\r\n\r\n\t\t\t\t\t// Foi retirado o tratamento feito para o diferimento = 3. Pois, apos atualizacao do fiscal, o valor do diferimento e gravado em um campo sem necessidade de fazer calculo\r\n\r\n\t\t\t\t\t/*If\taICMS[14] == \"3\"\t\r\n\t\t\t\t\t\tcString += NfeTag('<vICMSOp>' ,ConvType(iIf(lIcmDevol,aICMS[07],0)+aICMS[12],15,2))\r\n\t\t\t\t  \t\tcString += NfeTag('<pDif>' ,ConvType(aICMS[12]/( aICMS[12]+iIf(lIcmDevol,aICMS[07],0))*100,8,4))\r\n\t\t\t\t  \t\tcString += NfeTag('<vICMSDif>' ,ConvType(aICMS[12],15,2))\r\n\t\t\t\t  \t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,(aICMS[07]+aICMS[12])-aICMS[12],0),15,2)+'</valor>'\r\n\t\t\t\t\tElse*/\r\n\t\t\t\t\t\r\n\t\t\t\t\tcString += NfeTag('<vICMSOp>' ,ConvType(iIf(lIcmDevol,aICMS[07],0),15,2))\r\n\t\t\t\t\t//cString += NfeTag('<pDif>' ,ConvType(aICMS[12]/iIf(lIcmDevol,aICMS[07],0)*100,8,4))\r\n\t\t\t\t\tcString += NfeTag('<pDif>' ,ConvType(aICMS[19],8,4))\r\n\t\t\t\t\tcString += NfeTag('<vICMSDif>' ,ConvType(aICMS[12],15,2))\r\n\t\t\t\t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,aICMS[07]-aICMS[12],0),15,2)+'</valor>'\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tnVIcmDif += iIf(lIcmDevol,aICMS[07]-aICMS[12],0)\r\n\t\t\t\t\t/*Na versão 3.10, para CST=51, O Valor do ICMS(vICMS) deve ser a diferença do Valor do ICMS da Operação (vICMSOp) e o Valor do ICMS diferido (vICMSDif),\r\n\t\t\t\t\tpara não apresentar a rejeição 353-Valor do ICMS no CST=51 não corresponde a diferença do ICMS operação e ICMS diferido*/\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. aCST[1] $ '51' .and. Empty(aICMS[12]) .and. Empty(aICMS[07])\r\n\t\t\t\t\tcString += '<vICMSOp>0</vICMSOp>'\r\n\t\t\t\t\tcString += '<pDif>100.00</pDif>'\r\n\t\t\t\t\tcString += '<vICMSDif>0</vICMSDif>'\r\n\t\t\t\t\tcString += '<valor>0</valor>'\r\n\t\t\t\t\tnVIcmDif += 0\r\n\t\t\t\t//Regra para quando não tiver icms diferido com CST=51 (F4_icmsdif = 2 e F4_picmdif = 0) \r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. aCST[1] $ '51' .and. Empty(aICMS[12]) .and. !Empty(aICMS[07])\r\n\t\t\t\t\tcString += NfeTag('<vICMSOp>' ,ConvType(iIf(lIcmDevol,aICMS[07],0),15,2))\r\n\t\t\t\t\tcString += '<pDif>0</pDif>'\r\n\t\t\t\t\tcString += '<vICMSDif>0</vICMSDif>'\r\n\t\t\t\t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,aICMS[07]-aICMS[12],0),15,2)+'</valor>' \r\n\t\t\t\t\tnVIcmDif += 0\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '40') .and. alltrim(aICMS[11]) == \"8\" // F4_MOTICMS = 8=Venda Orgao Publico\r\n\t\t\t\t\tcString += '<valor>'+ConvType(aICMS[15],15,2)+'</valor>'\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '40') .and. (alltrim(aICMS[11]) == \"9\" .or. alltrim(aICMS[11]) == \"90\") // F4_MOTICMS = 9=Outros. (NT 2011/004)ou 90=Solicitado pelo Fisco.\r\n\t\t\t\t\tIf aICMS[15] > 0\r\n\t\t\t\t\t   cString += '<valor>'+ConvType(aICMS[15],15,2)+'</valor>'\r\n\t\t\t\t\tElse\t\t\t\t\r\n\t\t\t\t\t\tcString += '<valor>'+ConvType(aICMS[07],15,2)+'</valor>'\t\t\r\n\t\t\t\t   EndIf\r\n\t\t\t\tElse\t\t\t\t\r\n\t\t\t\t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,aICMS[07],0),15,2)+'</valor>'\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\tif !empty(cMotDesICMS)\r\n\t\t\t\t\tif  aICMS[15] >\t0 \r\n\t\t\t\t\t\tnDesonICM := ConvType(aICMS[15],15,2)\r\n\t\t\t\t\t\tnVicmsDeson += iIf(lIcmDevol,aICMS[15],0)\r\n\t\t\t\t\tElseiF Len(aICMSZFM)>0 .And. aCST[1] $ '40|41|50'\r\n\t\t\t\t\t\tnDesonICM := ConvType(aICMSZFM[3],15,2)\t\t\t\t\t\t\r\n\t\t\t\t\t\tnVicmsDeson += iIf(lIcmDevol,aICMSZFM[3],0)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tnDesonICM :=   ConvType(aICMS[07],15,2)\t\t\t\t\t\r\n\t\t\t\t\t\tnVicmsDeson += iIf(lIcmDevol,aICMS[07],0)\r\n\t\t\t\t\tendif\r\n\t\t\t\tendif\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '20,70,90') .and. !Empty(aICMS[11])\r\n\t\t\t\tcString += NfeTag('<motDesICMS>' ,ConvType(aICMS[11]))\r\n\t\t\t\tIf aICMS[04] == 100 .And. aICMS[02] == \"20\"\r\n\t\t\t\t\tcString += NfeTag('<vICMSDeson>' ,ConvType(0,15,2))\r\n\t\t\t\t\tnVicmsDeson += 0\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<vICMSDeson>'+ConvType(iIf(lIcmDevol,aICMS[15],0),15,2)+'</vICMSDeson>'\r\n\t\t\t\t\tnVicmsDeson\t+= IIf(lIcmDevol,aICMS[15],0)\r\n\r\n\t\t\t\t\tIf(aCST[1] $ '20') .And. !empty(aICMS[11])\r\n\t\t\t\t\t\tcMotDesICMS := ConvType(aICMS[11])\r\n\t\t\t\t\t\tnDesonICM := ConvType(aICMS[15],15,2)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\t\t\tElseIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '40') .and. alltrim(aICMS[11]) == \"8\" // F4_MOTICMS = 8=Venda Orgao Publico \r\n\t\t\t\tcString\t\t+= NfeTag('<vICMSDeson>',ConvType(aICMS[15],15,2))\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf (aCST[1] $ '10' .and. (IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\") .and. !Empty(aICMS[12]));\r\n\t\t\t\t.Or. (aICMS[12] > 0 .And. aDest[9] == 'RS' .And. SM0->M0_ESTENT == 'RS' .And. aCST[1] $ '51' .And. aICMS[19] > 12)\r\n\t\t\t\tnIcmsDif\t+= aICMS[12]\r\n\t\t\t\tnPIcmsDif\t:= aICMS[19]\r\n\t\t\tEndIf\r\n\r\n\t\t\tcString += '<qtrib>'+ConvType(aICMS[09],16,4)+'</qtrib>'\r\n\t\t\tcString += '<vltrib>'+ConvType(aICMS[10],15,4)+'</vltrib>'\t\r\n\t\t\t//Criação de campos relativos ao FCP (Fundo de Combate à Pobreza) para operações internas ou interestaduais com ST.\r\n\t\t\tIF cVeramb >= \"4.00\" .and. aCST[1] $'00,10,20,41,51,70,90' \r\n\t\t\t   IF  aCST[1] <> '00'\r\n\t\t\t\t\tcString += '<vBCFCP>'+ConvType(aICMS[16],15,2)+'</vBCFCP>'\r\n\t\t\t\tEndIf\r\n\t\t\t\tcString += '<pFCP>'+ConvType(aICMS[17],5,2)+'</pFCP>'\r\n\t\t\t\tcString += '<vFCP>'+ConvType(aICMS[18],15,2)+'</vFCP>'\t\r\n\t\t\tEndIf\t\r\n\t\t\tcString += '</Tributo>'\r\n\t\tElse\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>'\t\r\n\t\t\tcString += '<modBC>'+ConvType(3)+'</modBC>'\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\"\r\n\t\t\t\tIf !Empty(aAdi[14][03])\r\n\t\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\r\n\t\t\t    Else\r\n\t\t\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\t\t\tEndIf\r\n\t\t\tElseif aProd[23]==\"20\" .And. aProd[22]>0\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aProd[22],7,4)+'</pRedBC>'\r\n\t\t\tElseif allTrim(aCST[01]) $ \"51,70,90\"\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aProd[22],7,4)+'</pRedBC>'\r\n\t\t\tEndif\t\r\n\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\t\t\r\n\t\t\tIf Len(aICMSZFM)>0 .And. aCST[1] $ '40|41|50'\r\n\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMSZFM[02])+'</motDesICMS>'  \t\t\t\r\n\t\t\t\tnValDeson := aICMSZFM[01]-aProd[31]-aProd[32]\r\n\t\t\t\tnVicmsDeson += nValDeson\r\n\t\t\t\tcString += '<valor>'+ConvType(nValDeson,15,4)+'</valor>'\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\t\tEndIf\t\r\n\r\n\t\t\tcString += '<qtrib>'+ConvType(0,16,4)+'</qtrib>'\r\n\t\t\tcString += '<vltrib>'+ConvType(0,15,4)+'</vltrib>'\r\n\t\t\tcString += '</Tributo>'\r\n\t\tEndIf\r\n\t\tcString += '</imposto>'\r\n\tEndif\r\n\r\n\tIf Len(aComb) > 0 .And. cVeramb >= \"4.00\" .and. aCST[1] $ \"60\" .And. aComb[01] $ NfeProdANP()\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSST'+ aCST[1] + '</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\r\n\t\tcString += '</cpl>'\t\t\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>'      \r\n\t\t\r\n\t\tIf Empty(cUltAqui)\r\n\t\t\tSPEDRastro2(aProd[20],aProd[19],aProd[02],@nBaseIcm,@nValICM,,,,,,,,,,,,,,,@nBfcpant,@nAfcpant,@nVfcpant)             \r\n\t\tEndIf\r\n\t\t\r\n\t\tif lRetEfet\r\n\r\n\t\t\tIf aComb[19] > 0\t\r\n\t\t\t\tcString += '<vBCSTRet>'+ConvType(aComb[19],15,2)+'</vBCSTRet>' \r\n\t\t\t\tcString += '<vICMSSTRet>'+ConvType(aComb[20],15,2)+'</vICMSSTRet>'\r\n\t\t\t\tnAlqICM := aComb[23]\r\n\t\t\tElseIf nBaseIcm > 0\r\n\t\t\t\tcString += '<vBCSTRet>'+ConvType(nBaseIcm,15,2)+'</vBCSTRet>' \r\n\t\t\t\tcString += '<vICMSSTRet>'+ConvType(nValICM,15,2)+'</vICMSSTRet>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<vBCSTRet>'+ConvType(0,15,2)+'</vBCSTRet>'\r\n\t\t\t\tcString += '<vICMSSTRet>'+ConvType(0,15,2)+'</vICMSSTRet>'\r\n\t\t\tEndif\t\t\r\n\t\t\r\n\t\t\tIf lTagProduc \r\n\t\t\t\t//cString += '<pST>'+ConvType(aICMS[6]+ aICMS[17],5,2)+'</pST>'\r\n\t\t\t\tcString += '<pST>'+ConvType((nAlqICM),5,2)+'</pST>'\r\n\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\tEndif\r\n\r\n\t\t\tcString += '<vBCFCPSTRet>'+ConvType(nBfcpant,15,2)+'</vBCFCPSTRet>'\r\n\t\t\tcString += '<pFCPSTRet>'+ConvType(nAfcpant,5,2)+'</pFCPSTRet>'\r\n\t\t\tcString += '<vFCPSTRet>'+ConvType(nVfcpant,15,2)+'</vFCPSTRet>'\r\n\t\tendif\t\r\n\t\t\r\n\t\t//Tratamento implementado para atender o DECRETO Nº 54.308, DE 6 DE NOVEMBRO DE 2018. (publicado no DOE n.º 212, de 7 de novembro de 2018)\t\r\n\t\t\t\r\n\t\tIf cIndFinal == \"1\"\t.and. Len(aIcms)>0\t\t\t\t\t\t \r\n\t\t\tcString += '<pRedBCEfet>'+ConvType(aICMS[4],8,4)+'</pRedBCEfet>'\r\n\t\t\tcString += '<vBCEfet>'+ConvType( aICMS[5] ,16,2)+'</vBCEfet>'\r\n\t\t\tcString += '<pICMSEfet>'+ConvType(aICMS[6],8,4)+'</pICMSEfet>'\r\n\t\t\tcString += '<vICMSEfet>'+ConvType(aICMS[7],16,2)+'</vICMSEfet>'\r\n\t\tEndif\r\n\t\t\r\n\t\tcString += '<vBCSTDest>'+ConvType(aComb[21],15,2)+'</vBCSTDest>' \t   \t\r\n\t\tcString += '<vICMSSTDest>'+ConvType(aComb[22],15,2)+'</vICMSSTDest>'\r\n\t\t\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\tEndIf\t\r\n\t\r\n\tIf Len(aIcmsST)>0\t\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSST</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],8,4)+'</pmvast>'\r\n\t\tElse\r\n\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],6,2)+'</pmvast>'\r\n\t\tEndIf\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aICMSST[02])+'</CST>'\t\r\n\t\tcString += '<modBC>'+ConvType(aICMSST[03])+'</modBC>'\r\n\t\tcString += '<pRedBC>'+ConvType(aICMSST[04],7,4)+'</pRedBC>'\r\n\t\tcString += '<vBC>'+ConvType(aICMSST[05],15,2)+'</vBC>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMSST[06],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMSST[06],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tIf Len(aICMSZFM)>0 .And. aCST[1] $ '30-40'\r\n\t\t\tif !empty( aICMSZFM[02] )\r\n\t\t\t\tcString += NfeTag('<motDesICMS>' ,ConvType(aICMSZFM[02]))\r\n\t\t\t\tcString\t+= \"<vICMSDeson>\" + ConvType(aICMSZFM[3],15,2) + \"</vICMSDeson>\"\r\n\t\t\tendif\t\r\n\t\t\tnVicmsDeson\t+= IIf(lIcmDevol,aICMSZFM[3],0)\r\n\t\tElse\r\n\t\t\tif !empty( aICMSST[17] )\r\n\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMSST[17])+'</motDesICMS>'\r\n\t\t\t\tcString\t+= \"<vICMSDeson>\" + ConvType(aICMSST[12],15,2) + \"</vICMSDeson>\"\r\n\t\t\tendif\r\n\t\t\tcMotDesICMS:= ConvType(aICMSST[17])\r\n\t\tEndIf\r\n\t\tcString += '<valor>'+ConvType(aICMSST[07],15,2)+'</valor>'\r\n\t\tcString += '<qtrib>'+ConvType(aICMSST[09],16,4)+'</qtrib>'\r\n\t\tcString += '<vltrib>'+ConvType(aICMSST[10],15,4)+'</vltrib>'\r\n\t\t\r\n\t\tIf cVeramb >= \"4.00\" .and. aCST[1] =='60' \r\n\t\t\tif lRetEfet\r\n\t\t\t\tcString += '<pST>'+ConvType((aICMSST[06]+aICMSST[14]),5,2)+'</pST>'\r\n\t\t\t\tIf lTagProduc \r\n\t\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\t\tEndif\r\n\t\t\tendif\t\r\n\t\tEndIf\r\n\t\r\n\t\t//Criação de campos relativos ao FCP (Fundo de Combate à Pobreza) para operações internas ou interestaduais com ST.\r\n\t\tIF cVeramb >= \"4.00\" .and. aCST[1] $'10,30,70,90' //.and. !Empty(aICMS[13])\r\n\t\t\t\tcString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\tEndIf\t\r\n\t\t\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\t\t\r\n\tELse\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSST</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<pmvast>0</pmvast>'\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>'          \r\n\t\tIf (aCST[01] = \"60\" .or. cCsosn$ \"500\")\t\t\r\n\t\t\t//Se o parâmetro  MV_ULTAQUI que trata a última aquisição não estiver preenchido usa o modelo antigo de rastro.\r\n\t\t\tIf Empty(cUltAqui) \r\n\t\t\t\tSPEDRastro2(aProd[20],aProd[19],aProd[02],@nBaseIcm,@nValICM,,,lCalcMed,@nAlqICM,,,,,,,,,,,@nBfcpant,@nAfcpant,@nVfcpant)\r\n\t\t\t\t\r\n\t\t\t\tIf nBaseIcm > 0 .and. nValICM>0\r\n\t\t\t\t\tnBaseIcm := aProd[09]*nBaseIcm\r\n\t\t\t\t\tnValICM  := aProd[09]*nValICM\r\n\t\t\t    EndIf\r\n\t\t\t     //Multiplica o valor facp anterior pela quantidade de item.\r\n\t\t\t    If\tnBfcpant > 0 .and. nVfcpant>0\r\n\t\t\t     \tnBfcpant  := aProd[09]*nBfcpant\r\n\t\t\t     \tnVfcpant  := aProd[09]*nVfcpant\r\n\t\t\t    EndIf\r\n\t\t\tendif\r\n\t\t\t\t\r\n\t\t\tIf nBaseIcm > 0 .and. nValICM > 0\t.and. nAlqICM > 0\r\n\t\t   \t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\tEndIf\r\n\t\t\t    If cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SP\"\r\n\t\t\t\t\t// cMensFis += \"Imposto Recolhido por Substituição - Artigo 274 do RICMS (Lei 6.374/89, art.67,Paragrafo 1o., e Ajuste SINIEF-4/93',cláusa terceira, na redação do Ajuste SINIEF-1/94) 'Cod.Produto:  \" +ConvType(aProd[02])+\" ' Valor da Base de ST: R$ \" +str(nBaseIcm,15,2)+\" Valor de ICMS ST: R$ \"+str(nValICM,15,2)+\" \"\r\n\t\t\t\t\tif Empty(At(\"Artigo 274 do RICMS\", cMensFis))\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Artigo 274 do RICMS (Lei 6.374/89, art.67,Paragrafo 1o., e Ajuste SINIEF-4/93',cláusa terceira, na redação do Ajuste SINIEF-1/94) &|\"+ConvType(aProd[02])+\"|\"+AllTrim(str(nValICM,15,2))+\"|&\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcMensFis := AllTrim(cMensFis) + \"|\"+ConvType(aProd[02])+\"|\"+AllTrim(str(nValICM,15,2))+\"|&\"\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\"  \r\n\t\t\t\t\tif SF4->F4_CODIGO > \"500\"  /* TES de Saída */  \r\n\t\t\t\t\t\t//Decreto 6080/2012 com o Regulamento do ICMS está revogado\r\n\t\t\t\t\t\tcMensFis += \" Imposto Recolhido por Substituição - ART. 5º, II , ANEXO IX ,DO RICMS/PR DECRETO 7871/2017 - DOE PR de 02.10.2017, onde o 'Cod.Produto:  \" +ConvType(aProd[02])+\" '  Valor da Base de ST: R$ \" +Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\telse //entrada\r\n\t\t\t\t\t\tcMensFis += \" Imposto Recolhido por Substituição - ART. 5º, I  , ANEXO IX ,DO RICMS/PR DECRETO 7871/2017 - DOE PR de 02.10.2017, onde o 'Cod.Produto:  \" +ConvType(aProd[02])+\" '  Valor da Base de ST: R$ \" +Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\tendif\r\n\t\t\t\t\t/* Conforme consulta realizado no chamado TIBIKO\r\n\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Artigo 471 do RICMS (Parágrafo 1o, alínea B, inciso II, onde o 'Cod.Produto:  \" +ConvType(aProd[02])+\" ' Valor da Base de ST: R$ \" +str(nBaseIcm,15,2)+\" Valor de ICMS ST: R$ \"+str(nValICM,15,2)+\" \"\r\n\t\t\t\t\t*/\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SC\"  \r\n\t\t\t\t\tlPesFisica := IIF(SA1->A1_PESSOA==\"F\",.T.,.F.)\r\n\t\t\t\t\tlNContrICM := IIf(Empty(SA1->A1_INSCR) .Or. \"ISENT\"$SA1->A1_INSCR .Or. \"RG\"$SA1->A1_INSCR .Or. ( SA1->(FieldPos(\"A1_CONTRIB\"))>0 .And. SA1->A1_CONTRIB == \"2\"),.T.,.F.)\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !lPesFisica .And. !lNContrICM \r\n\t\t\t\t\t\tcMensFis += \"Imposto Retido por Substituição Tributária - RICMS-SC/01 - Anexo 3. 'Cod.Produto: \" +ConvType(aProd[02])+\" '  Valor da Base de ST: R$ \" +str(nBaseIcm,15,2)+\"  Valor de ICMS ST: R$ \"+str(nValICM,15,2)+\" \"\r\n\t\t\t\t\tEndIf\t \t\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"AM\"\r\n\t\t\t\t \tlNContrICM := IIf(Empty(SA1->A1_INSCR) .Or. \"ISENT\"$SA1->A1_INSCR .Or. \"RG\"$SA1->A1_INSCR .Or. ( SA1->(FieldPos(\"A1_CONTRIB\"))>0 .And. SA1->A1_CONTRIB == \"2\"),.T.,.F.)\r\n\t\t\t\t \t\r\n\t\t\t\t \tIf (lNContrICM .And. SA1->A1_EST <> \"AM\") .Or. SA1->A1_EST == \"AM\"  //Conforme consulta (TGVUIP).\r\n\t\t\t\t \t\tcMensFis += \"Mercadoria já tributada nas demais fases de comercialização - Convênio ou Protocolo ICMS nº \"+Alltrim(aProd[28])+ \". Cod.Produto: \" +ConvType(aProd[02])+\".\"\r\n\t\t\t\t \tEndIf\r\n\t\t\t\t\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"RS\"\t\t\t \r\n\t\t\t\t \tif !Empty(aProd[28])\t\t\t\t \t\r\n\t\t\t\t \t\tcMensFis += \"Imposto recolhido por ST nos termos do (Convênio ou Protocolo ICMS nº \"+ Alltrim(aProd[28]) +\") RICMS-RS. Valor da Base de ICMS ST R$\"+ cValToChar(nBaseIcm) +\" e valor do ICMS ST R$ \"+ cValToChar(nValICM) +\". Cod.Produto: \" +ConvType(aProd[02])+\".\" \r\n\t\t\t\t \telse\r\n\t\t\t\t \t\tcMensFis += \"Imposto recolhido por ST nos termos do RICMS-RS. Valor da Base de ICMS ST R$\"+ cValToChar(nBaseIcm) +\" e Valor do ICMS ST R$\"+ cValToChar(nValICM) +\". Cod.Produto: \" +ConvType(aProd[02])+\".\"\r\n\t\t\t\t \tendIf\t\t\t\t\t \t\r\n\t\t\t\tElseIf cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"ES\" .And. Len(aICMS) > 0 .And. ( nBaseIcm+nValICM > 0 )\r\n\t\t\t\t\t\r\n\t\t\t\t\tnValIcmDif := ( (nBaseIcm *  17 )/ 100 ) -  aIcms[7]\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição RICMS. Cod.Produto:  \" +ConvType(aProd[02])+\" Base de cálculo da retenção - R$ \" + Alltrim(str(nBaseIcm,15,2))+\". \" \r\n\t\t\t\t\tcMensFis += \"ICMS da operação própria do contribuinte substituto - R$ \"+Alltrim(str(aIcms[7],15,2))+\". \"\r\n\t\t\t\t\tcMensFis += \"ICMS retido pelo contribuinte substituto - R$ \" +Alltrim(str(nValIcmDif,15,2))+\". \"\r\n\t\t\t\tElseIf cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\" .And. Len(aICMS) > 0 .And. ( nBaseIcm+nValICM > 0 )  // Conforme Chamado TIABCS\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Empty(cUltAqui)\r\n\t\t\t\t\t\tnVICPRST := ( (nBaseIcm * 18 )/ 100 ) - aIcms[7]\r\n\t\t\t\t\tEndif\r\n\t\t\t\t\t\r\n\t\t\t\t\taTotICMSST[1] += nBaseIcm\r\n\t\t\t\t\taTotICMSST[2] += nValICM\r\n\t\t\t\t\taTotICMSST[3] += nVICPRST\r\n\r\n\t\t\t\t\tIf nTotProd == nItProd\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - ICMS retido pelo cliente S.T. DECRETO 43708 19/12/2009.\"\r\n\t\t\t\t\t\tcMensFis += \" Valor da Base de ST: R$ \"+Alltrim(str(aTotICMSST[1],15,2))+\".\"\r\n\t\t\t\t\t\tcMensFis += \" Valor de ICMS ST: R$ \"+Alltrim(str(aTotICMSST[2],15,2))+\".\"\r\n\t\t\t\t\t\tcMensFis += \" Valor de ICMS: R$\"+Alltrim(str(aTotICMSST[3],15,2))+\".\"\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tElseIf IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SP\" \r\n\t\t\t\t\tIf cIndFinal == \"1\"\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Contempla o artigo 313-Z19 do RICMS-SP.\"\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t//Artigo somente para o estado de SP - DSERTSS1-6532\r\n\t\t\t\t\t\t//http://tdn.totvs.com.br/pages/releaseview.action?pageId=267795989\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Contempla os artigos 273, 313 do RICMS. Valor da Base de ST: R$ \"+Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tElseIf IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"RJ\"\r\n\t\t\t\t\tif aComb[01] $ NfeProdANP()\r\n\t\t\t\t\t\t//http://jiraproducao.totvs.com.br/browse/DSERTSS1-11434\r\n\t\t\t\t\t\tcMensFis += \"ICMS a ser repassado nos termos do Capítulo V do Convênio ICMS 110/07. Valor da Base de ST: R$ \"+Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\telseif cArt274 == \"1\"\r\n\t\t\t\t\t\tcMensFis += \"ICMS RECOLHIDO ANTECIPADO POR SUBS. TRIBUTARIA CONF. INC. II ART 27 DO LIVRO II, E ITEM 23 DO ANEXO I DO LIVRO II DO RICMS\"\t\r\n\t\t\t\t\tendif\r\n\t\t\t\tEndIf\r\n\t        \r\n\t        \r\n\t        EndIf\r\n\t        \r\n\t   \t\tcString += '<modBC>0</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\tElse\r\n\t\t\tcString += '<modBC>0</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\t\r\n\t\tEndif\r\n\t\tIf nBaseIcm > 0\r\n\t\t\tcString += '<vBC>'+ConvType(nBaseIcm,15,2)+'</vBC>' \r\n\t\tElse\r\n\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\tEndif\r\n\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\tIf nValICM > 0\r\n\t\t\tcString += '<valor>'+ConvType(nValICM,15,2)+'</valor>'\r\n\t\tElse\r\n\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\tEndif   \r\n\t\r\n\t\tcString += '<qtrib>'+ConvType(0,16,4)+'</qtrib>'\r\n\t\tcString += '<vltrib>'+ConvType(0,15,4)+'</vltrib>'\r\n\t\t\r\n\t\tIf cVeramb >= \"4.00\" .and. aCST[1] =='60'\r\n\t\t\t\r\n\t\t\tif lRetEfet\r\n\t\t\t\tcString += '<pST>'+ConvType((nAlqICM),5,2)+'</pST>'\r\n\t\t\t\t//cString += '<pST>'+ConvType(aICMS[6]+ aICMS[17],5,2)+'</pST>'\r\n\t\t\t\tIf lTagProduc \r\n\t\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\t\tEndif\r\n\t\t\t\t//Tratamento implementado para atender o DECRETO Nº 54.308, DE 6 DE NOVEMBRO DE 2018. (publicado no DOE n.º 212, de 7 de novembro de 2018)\t\r\n\t\t\t\tcString += '<vBCFCPSTRet>'+ConvType(nBfcpant,15,2)+'</vBCFCPSTRet>'\r\n\t\t\t\tcString += '<pFCPSTRet>'+ConvType(nAfcpant,5,2)+'</pFCPSTRet>'\r\n\t\t\t\tcString += '<vFCPSTRet>'+ConvType(nVfcpant,15,2)+'</vFCPSTRet>'\r\n\t\t\tendif\t\r\n\t\t\t\r\n\t\t\tIf cIndFinal == \"1\"\t.and. Len(aIcms)>0\t\t\t\t \r\n\t\t\t\tcString += '<pRedBCEfet>'+ConvType(aICMS[4],8,4)+'</pRedBCEfet>'\r\n\t\t\t\tcString += '<vBCEfet>'+ConvType( aICMS[5] ,16,2)+'</vBCEfet>'\r\n\t\t\t\tcString += '<pICMSEfet>'+ConvType(aICMS[6],8,4)+'</pICMSEfet>'\r\n\t\t\t\tcString += '<vICMSEfet>'+ConvType(aICMS[7],16,2)+'</vICMSEfet>'\r\n\t\t\tEndif\r\n\t\tEndif\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\t\t\r\n\t\t\t\r\n\tEndIf\r\n\t\r\n\t//A sefaz nao permite referenciar nota de difal antes de 2016 da a Rejeiçao 699  \r\n\tIf len(aItemVinc) > 0 \r\n\t\tlDateRefNf := FsDateConv(aItemVinc[01],\"YYYY\") >= \"2016\" \r\n\tElse \r\n\t\tlDateRefNf := .T.\t\t  \t\t\t\r\n\tEndif\r\n\t\r\n\tIf (cIdDest == \"2\" .and. cIndFinal == \"1\" .and. cIndIEDest == \"9\") .and. (Len(aISSQN)== 0) .and. ;\r\n\t   (cAmbiente == \"2\" .or. (cAmbiente == \"1\" .and. FsDateConv(aNota[03],\"YYYY\") >= \"2016\" .and. lDateRefNf)) .and. ;\r\n\t   (iif(Len(aComb) > 0 .And. !Empty(aComb[01]),aComb[01] $ NfeCodANP(),.T.))\r\n\t\t\r\n\t\tIf Len(aICMUFDest) > 0 .And. !(aNota[04] == \"0\" .and. aNota[5] == \"N\" .And. aICMUFDest[05] == 0)\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>ICMSUFDest</codigo>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<VBC>'+ConvType(aICMUFDest[01],15,2)+'</VBC>' //vBCUFDest\r\n\t\t\tIF cVeramb >= \"4.00\"\r\n\t\t\t\tcString += '<vBCFCPUFDest>'+ConvType(aICMUFDest[01],15,2)+'</vBCFCPUFDest>' //vBCFCPUFDest\r\n\t\t\tEndif\r\n\t\t\tcString += '<pFCPUF>'+ConvType(aICMUFDest[02],7,4)+'</pFCPUF>' //pFCPUFDest\r\n\t\t\tcString += '<Aliquota>'+ConvType(aICMUFDest[03],7,4)+'</Aliquota>' //pICMSUFDest\r\n\t\t\tcString += '<AliquotaInter>'+ConvType(aICMUFDest[04],6,2)+'</AliquotaInter>' //pICMSInter\r\n\t\t\tcString += '<pICMSInter>'+ConvType(aICMUFDest[05],8,4)+'</pICMSInter>'//pICMSInterPart\r\n\t\t\tcString += '<ValorFCP>'+ConvType(aICMUFDest[06],15,2)+'</ValorFCP>' //vFCPUFDest\r\n\t\t\tcString += '<ValorICMSDes>'+ConvType(aICMUFDest[07],15,2)+'</ValorICMSDes>' //vICMSUFDest\r\n\t\t\tcString += '<ValorICMSRem>'+ConvType(aICMUFDest[08],15,2)+'</ValorICMSRem>' //vICMSUFRemet\r\n\t\t\tcString += '</Tributo>'\r\n\t\t\tcString += '</imposto>'\r\n\r\n\t\t\tnvBCUFDest    += aICMUFDest[01]\r\n\t\t\tnpFCPUFDest   := aICMUFDest[02]\r\n\t\t\tnpICMSUFDest  := aICMUFDest[03]\t\t\r\n\t\t\tnpICMSIntP    := aICMUFDest[05]\r\n\t\t\tnvFCPUFDest   += aICMUFDest[06]\r\n\t\t\tnvICMSUFDest  += aICMUFDest[07]\r\n\t\t\tnvICMSUFRemet += aICMUFDest[08]\r\n\r\n\t\t\t// <AliquotaInter> padrão 4,7 ou 12. Em caso de pedido com produtos com aliquotas diferentes, as alíquotas serão separadas em vírgula para exibição. (Ex.: 4.00%, 7.00%)\r\n\t\t\tIf (aICMUFDest[04] == 4 .or. aICMUFDest[04] == 7 .or. aICMUFDest[04] == 12) .and. !ConvType(aICMUFDest[04])$cMensDifal\r\n\t\t\t\tIif (empty(cMensDifal),cMensDifal += ConvType(aICMUFDest[04],6,2)+'%',cMensDifal += ', '+ ConvType(aICMUFDest[04],6,2)+'%')\t\r\n\t\t\tEndif\r\n\t\t\t\r\n\t\tElseif Len(aICMUFDest) == 0\r\n\t\t\t\r\n\t\t\t/*Para os casos em que não há calculo de Difal na CD2( ICMS Isento), o grupo ICMSUFDEST deve ser gerado com valores zerados, para\r\n\t\t\tnão apresentar a rejeição 694: Não informado o grupo de ICMS para a UF de destino [nItem:999].\r\n\t\t\tApenas as tags pICMSUInter e pICMSInterPart devem ser geradas com valores para não apresentar erro de schema\r\n\t\t\tTAG pICMSInter - SD2_PICM\r\n\t\t\tTAG pICMSInterPart - MV_PPDIFAL\r\n\t\t\t*/\r\n\t\t\tIf (valType(aPPDifal)== \"A\" .and. Len(aPPDifal)>0 .and. Year(aNota[03]) >= aPPDifal[1][1])\r\n\t\t\t\r\n\t\t\t\tnUltimo := Len(aPPDifal)\r\n\t\t\r\n\t\t\t\tIF !Empty(aItemVinc) .and. (nPos := aScan(aPPDifal,{|x| x[1]== Year(aItemVinc[01])})) > 0 // Verifica o ano da nota vinculada para pegar a aliquota do parâmetro\r\n\t\t\t\t\taPICMSInter:= aPPDifal[nPos][2]\r\n\t\t\t\tElseIf (nPos := aScan(aPPDifal,{|x| x[1]== Year(aNota[03])})) > 0\r\n\t\t\t\t\taPICMSInter:= aPPDifal[nPos][2]\t\t\t\t\r\n\t\t\t\tElseIf Year(aNota[03] ) > aPPDifal[nUltimo][1]\t\t\r\n\t\t\t\t\taPICMSInter:= aPPDifal[nUltimo][2]\t\t\t\t\r\n\t\t\t\tEndif\r\n\t\t\t\r\n\t\t\t\tIf Alltrim(Str(aProd[33])) == \"4\" .Or. Alltrim(Str(aProd[33])) == \"7\" .Or. Alltrim(Str(aProd[33])) == \"12\"\r\n\t\t\t\t\tcString += '<imposto>'\r\n\t\t\t\t\tcString += '<codigo>ICMSUFDest</codigo>'\r\n\t\t\t\t\tcString += '<Tributo>'\r\n\t\t\t\t\tcString += '<VBC>'+ConvType(0,15,2)+'</VBC>' //vBCUFDest\r\n\t\t\t\t\tcString += '<vBCFCPUFDest>'+ConvType(0,15,2)+'</vBCFCPUFDest>' //vBCFCPUFDest\r\n\t\t\t\t\tcString += '<pFCPUF>'+ConvType(0,7,4)+'</pFCPUF>' //pFCPUFDest\r\n\t\t\t\t\tcString += '<Aliquota>'+ConvType(0,7,4)+'</Aliquota>' //pICMSUFDest\r\n\t\t\t\t\tcString += '<AliquotaInter>'+ConvType(aProd[33],6,2)+'</AliquotaInter>' //pICMSInter\r\n\t\t\t\t\tcString += '<pICMSInter>'+ConvType(aPICMSInter,8,4)+'</pICMSInter>'//pICMSInterPart\r\n\t\t\t\t\tcString += '<ValorFCP>'+ConvType(0,15,2)+'</ValorFCP>' //vFCPUFDest\r\n\t\t\t\t\tcString += '<ValorICMSDes>'+ConvType(0,15,2)+'</ValorICMSDes>' //vICMSUFDest\r\n\t\t\t\t\tcString += '<ValorICMSRem>'+ConvType(0,15,2)+'</ValorICMSRem>' //vICMSUFRemet\r\n\t\t\t\t\tcString += '</Tributo>'\r\n\t\t\t\t\tcString += '</imposto>'\r\n\t\t\t\t\t\r\n\t\t\t\t\tnvBCUFDest    += 0 \r\n\t\t\t\t\tnpFCPUFDest   += 0\r\n\t\t\t\t\tnpICMSUFDest  += 0\r\n\t\t\t\t\tnpICMSInter   += 0\r\n\t\t\t\t\tnpICMSIntP    += 0\r\n\t\t\t\t\tnvFCPUFDest\t+= 0\r\n\t\t\t\t\tnvICMSUFDest  += 0\r\n\t\t\t\t\tnvICMSUFRemet += 0\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\t\r\n\t\tEndIf\r\n\tEndIf\t\t\r\n\t\t\t\t\t\t\t\r\n\tIf Len(aIPI)>0 \r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>IPI</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += NfeTag('<clEnq>',ConvType(AIPI[01]))\r\n\t\tcString += NfeTag('<cSelo>',ConvType(AIPI[02]))\r\n\t\tcString += NfeTag('<qSelo>',ConvType(AIPI[03]))\r\n\t\tcString += NfeTag('<cEnq>' ,ConvType(AIPI[04]))\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(AIPI[05])+'</CST>'\r\n\t\tcString += '<modBC>'+ConvType(AIPI[11])+'</modBC>'\r\n\t\tcString += '<pRedBC>'+ConvType(AIPI[12],7,4)+'</pRedBC>'\r\n\t\tcString += '<vBC>'  +ConvType(AIPI[06],15,2)+'</vBC>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tcString += '<vlTrib>'+ConvType(AIPI[08],15,4)+'</vlTrib>'\r\n\t\tcString += '<qTrib>'+ConvType(AIPI[07],16,4)+'</qTrib>'\r\n\t\tcString += '<valor>'+ConvType(AIPI[10],15,2)+'</valor>'\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\tElseIf Len(aCSTIPI) > 0  .And. !Empty(cIpiCst)\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>IPI</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += NfeTag('<cEnq>' ,aprod[40])\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(cIpiCst)+'</CST>'\r\n\t\tcString += '<modBC>'+ConvType(3)+'</modBC>'\r\n\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\tcString += '<vBC>'  +ConvType(0,15,2)+'</vBC>'\r\n\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\t\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\tEndIf\r\nElse\r\n\tIf Len(aISSQN)>0 .and. !Empty(aISSQN[01])\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ISS</codigo>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<vBC>'+ConvType(aISSQN[01],15,2)+'</vBC>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(aISSQN[02],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(aISSQN[02],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tcString += '<Valor>'+ConvType(aISSQN[03],15,4)+'</Valor>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += NfeTag('<deducao>',ConvType(aISSQN[07],15,2))//SF3->F3_ISSSUB + SF3->F3_ISSMAT\r\n\t\t\tcString += NfeTag('<outro>',ConvType(0,15,2))//atualmente nao existe valor de Outras retencoes \r\n\t\t\tcString += NfeTag('<descIncond>',ConvType(0,15,2))//atualmente nao existe valor de Desconto Incondicionado\r\n\t\t\tcString += NfeTag('<descCond>',ConvType(0,15,2))//atualmente nao existe valor de Desconto condicionado\r\n\t\t\tcString += NfeTag('<Issret>',ConvType(aISSQN[09],15,2))\t\t\t\t\r\n\t\tEndIf\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<cmunfg>'+ConvType(SM0->M0_CODMUN)+'</cmunfg>'\t\r\n\t\tcString += '<clistserv>'+aISSQN[05]+'</clistserv>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<Indiss>'+aISSQN[08]+'</Indiss>'\r\n\t\t\tcString += NfeTag('<codserv>',ConvType(aProd[34],20))//B1_TRIBMUN\r\n\t\t\tcString += NfeTag('<cmunInc>',ConvType(cMunPres,7))\r\n\t\t\t//cPais Código do País onde o serviço foi prestado\r\n\t\t\t//Tabela do BACEN. Informar somente se o município da prestação do serviço for \"9999999\".\r\n\t\t\tIF cMunPres == \"9999999\"\r\n\t\t\t\tcString += NfeTag('<codpais>',aDest[11])\r\n\t\t\tEndIf\t\r\n\t\t\tcString += NfeTag('<processo>',ConvType(cMVNumProc,30))\r\n\t\t\tcString += '<incentivo>'+ConvType(cMVINCEFIS,1)+'</incentivo>'\r\n\t\tElse\r\n\t\t\tcString += '<cSitTrib>'+ConvType(aISSQN[06])+'</cSitTrib>'\r\n\t\tEndIf\t\t \t\r\n\t\tcString += '</cpl>'\t\t\r\n\t\tcString += '</imposto>'\r\n\tEndIf\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tIf Len(aIPI)>0 \r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>IPI</codigo>'\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += NfeTag('<clEnq>',ConvType(AIPI[01]))\r\n\t\t\tcString += NfeTag('<cSelo>',ConvType(AIPI[02]))\r\n\t\t\tcString += NfeTag('<qSelo>',ConvType(AIPI[03]))\r\n\t\t\tcString += NfeTag('<cEnq>' ,ConvType(AIPI[04]))\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<CST>'+ConvType(AIPI[05])+'</CST>'\r\n\t\t\tcString += '<modBC>'+ConvType(AIPI[11])+'</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(AIPI[12],7,4)+'</pRedBC>'\r\n\t\t\tcString += '<vBC>'  +ConvType(AIPI[06],15,2)+'</vBC>'\r\n\t\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],7,4)+'</aliquota>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],5,2)+'</aliquota>'\r\n\t\t\tEndIf\r\n\t\t\tcString += '<vlTrib>'+ConvType(AIPI[08],15,4)+'</vlTrib>'\r\n\t\t\tcString += '<qTrib>'+ConvType(AIPI[07],16,4)+'</qTrib>'\r\n\t\t\tcString += '<valor>'+ConvType(AIPI[10],15,2)+'</valor>'\r\n\t\t\tcString += '</Tributo>'\r\n\t\t\tcString += '</imposto>'\r\n\t\tElseIf Len(aCSTIPI) > 0  .And. !Empty(cIpiCst)\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>IPI</codigo>'\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += NfeTag('<cEnq>' ,aprod[40])\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<CST>'+ConvType(cIpiCst)+'</CST>'\r\n\t\t\tcString += '<modBC>'+ConvType(3)+'</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\t\tcString += '<vBC>'  +ConvType(0,15,2)+'</vBC>'\r\n\t\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\t\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\t\t\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\t\tcString += '</Tributo>'\r\n\t\t\tcString += '</imposto>'\r\n\t\tEndIf\r\n\tEndIf\r\nEndIf\r\ncString += '<imposto>'\r\ncString += '<codigo>PIS</codigo>'\r\nIf Len(aPIS)>0\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aPIS[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aPIS[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aPIS[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aPIS[03],5,2)+'</aliquota>'\r\n\tEndif\r\n\tcString += '<vlTrib>'+ConvType(aPIS[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aPIS[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aPIS[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tnValPis += aPIS[04]\r\nElse\r\n\tcString += '<Tributo>'\r\n\t\r\n\tIf len(aPisAlqZ) > 0 .and. !empty(aPisAlqZ[01])\r\n\t\tcString += '<CST>'+ConvType(aPisAlqZ[01])+'</CST>'\r\n\tElse\r\n\t\tcString += '<CST>08</CST>'\r\n\tEndIf\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\nEndIf\r\ncString += '</imposto>'\r\nIf Len(aPISST)>0\r\n\tcString += '<imposto>'\r\n\tcString += '<codigo>PISST</codigo>'\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aPISST[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aPISST[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aPISST[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aPISST[03],5,2)+'</aliquota>'\r\n\tEndIf\r\n\tcString += '<vlTrib>'+ConvType(aPISST[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aPISST[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aPISST[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tcString += '</imposto>'\r\n\tnValPis += aPISST[04]\r\nEndIf\r\ncString += '<imposto>'\r\ncString += '<codigo>COFINS</codigo>'\r\nIf Len(aCOFINS)>0\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aCOFINS[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aCOFINS[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINS[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINS[03],5,2)+'</aliquota>'\r\n\tEndIf\r\n\tcString += '<vlTrib>'+ConvType(aCOFINS[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aCOFINS[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aCOFINS[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tnValCof += aCOFINS[04]\r\nElse\r\n\tcString += '<Tributo>'\r\n\t\r\n\tIf len(aCofAlqZ) > 0 .and. !Empty(aCofAlqZ[01])\r\n\t\tcString += '<CST>'+ConvType(aCofAlqZ[01])+'</CST>'\r\n\tElse\r\n\t\tcString += '<CST>08</CST>'\r\n\tEndIf                       \r\n\t\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\nEndIf\r\ncString += '</imposto>'\r\n\r\nIf Len(aCOFINSST)>0\r\n\tcString += '<imposto>'\r\n\tcString += '<codigo>COFINSST</codigo>'\t\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aCOFINSST[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aCOFINSST[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINSST[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINSST[03],5,2)+'</aliquota>'\r\n\tEndIf\r\n\tcString += '<vlTrib>'+ConvType(aCOFINSST[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aCOFINSST[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aCOFINSST[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tcString += '</imposto>'\r\n\tnValCof += aCOFINSST[04]\r\nEndIf \r\n \tIf lMvPisCofD  .And. aDest[9] == 'PR'  // Lei Est. PR 17.127/12 informar todos os impostos na Danfe\r\n\t\tcMensFis += \" Conforme Lei Estadual PR 17.127/12 segue o Valor Pis / Cofins:\"\r\n\t\tcMensFis += \" Valor Pis R$ \" + ConvType(nValPis,15,2) \r\n\t\tcMensFis += \" Valor Cofins R$ \" + ConvType(nValCof,15,2)\r\nEndIf\r\n\r\nIf nIcmsDif > 0 .And. aDest[9] == 'PR' .And. aCST[1] $ '10' .And. SM0->M0_ESTENT == 'PR'\r\n\tcMensFis += \"Diferimento Parcial conforme Anexo VIII, Art. 28 do RICMS/PR - Decreto 7871/2017. ICMS Diferido em \" + ConvType(nPIcmsDif,6,2) +  \"% no valor de R$\" + ConvType(nIcmsDif,15,2) + \". \"\r\nEndIf\r\n\r\nIf nIcmsDif > 0 .And. aDest[9] == 'RS' .And. SM0->M0_ESTENT == 'RS' .And. aCST[1] $ '51' .And. nPIcmsDif > 12\r\n\tnValDifer += nIcmsDif\r\nEndif\r\n\r\nIf !lIssQn\r\n\t// Tratamento de imposto de importacao quando \r\n\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\"\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>II</codigo>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<vBC>'      +ConvType(aDI[17][03],15,2)+'</vBC>'\r\n\t\tcString += '<Valor>'    +ConvType(aDI[19][03],15,2)+'</Valor>'\r\n\t\tcString += '</Tributo>'\t\t\t\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<vDespAdu>' +ConvType(aDI[18][03],15,2)+'</vDespAdu>'\r\n\t\tcString += '<vIOF>'     +ConvType(aDI[20][03],15,2)+'</vIOF>'\r\n\t\tcString += '</cpl>'\t\t\t\t\t\t\r\n\t\tcString += '</imposto>'\r\n\tElseIf Len(aDI)>0\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>II</codigo>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<vBC>'      +ConvType(aDI[15][03],15,2)+'</vBC>'\r\n\t\tcString += '<Valor>'    +ConvType(aDI[14][03],15,2)+'</Valor>'\r\n\t\tcString += '</Tributo>'\t\t\t\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<vDespAdu>' +ConvType(aDI[13][03],15,2)+'</vDespAdu>'\r\n\t\tcString += '<vIOF>'     +ConvType(aDI[16][03],15,2)+'</vIOF>'\r\n\t\tcString += '</cpl>'\t\t\t\t\t\t\r\n\t\tcString += '</imposto>'\t\r\n\tEndIf\r\nEndIf\r\n\t\r\n//Anfavea Itens\r\nIf lAnfavea\r\n\tIf !Empty(aAnfI) .And. !Empty(aAnfI[01])\r\n\t\tcString += '<AnfaveaProd>'\r\n\t\tcString += \t'<![CDATA[<id'\r\n\t\tIf !Empty(aAnfI[01])\r\n\t\t\tcString += \t' item=\"' \t\t+ convType(Iif(lAnfProd,aAnfI[01],aAnfI[26])) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[02])\r\n\t\t\tcString += \t' ped=\"'\t\t+ convType(aAnfI[02]) + '\"'\r\n\t    Endif\r\n\t\tIf !Empty(aAnfI[03])\r\n\t\t\tcString += \t' sPed=\"'\t\t+ convType(aAnfI[03]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[04])\r\n\t\t\tcString += \t' alt=\"'\t\t+ convType(aAnfI[04]) + '\"'\r\n\t\tEndif\t\r\n\t\tIf !Empty(aAnfI[05])\r\n\t\t\tcString += \t' tpF=\"'\t\t+ convType(aAnfI[05]) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><div'\r\n\t\tIf !Empty(aAnfI[06])\r\n\t\t\tcString += \t' uM=\"'  \t\t+ convType(aAnfI[06]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[07])\r\n\t\t\tcString += \t' dVD=\"'\t\t+ convType(aAnfI[07]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[08])\r\n\t\t\tcString += \t' pedR=\"'\t\t+ convType(aAnfI[08]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[09])\r\n\t\t\tcString += \t' pE=\"'\t\t\t+ convType(aAnfI[09]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[10])\r\n\t\t\tcString += \t' psB=\"'\t\t+ convType(Alltrim(Str(aAnfI[10],TAMSX3(\"B1_PESO\")[1],TAMSX3(\"B1_PESO\")[2]))) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[11])\r\n\t\t\tcString += \t' psL=\"'\t\t+ convType(Alltrim(Str(aAnfI[11],TAMSX3(\"B1_PESO\")[1],TAMSX3(\"B1_PESO\")[2]))) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><entg'\r\n\t\tIf !Empty(aAnfI[12])\r\n\t\t\tcString += \t' tCh=\"'\t\t+ convType(Iif(aAnfI[12]==\"PeA\",'P&A',aAnfI[12])) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[13])\r\n\t\t\tcString += \t' ch=\"'\t\t\t+ convType(aAnfI[13]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[14])\r\n\t\t\tcString += \t' hCh=\"'\t\t+ convType(aAnfI[14]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[15])\r\n\t\t\tcString += \t' qtEm=\"'\t\t+ convType(Alltrim(Str(aAnfI[15],14,2))) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[16])\r\n\t\t\tcString += \t' qtlt=\"'\t\t+ convType(Alltrim(Str(aAnfI[16],14,2))) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><dest'\r\n\t\tIf !Empty(aAnfI[17])\r\n\t\t\tcString += \t' dca=\"'\t\t+ convType(aAnfI[17]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[18])\r\n\t\t\tcString += \t' ptU=\"'\t\t+ convType(aAnfI[18]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[19])\r\n\t\t\tcString += \t' trans=\"'\t\t+ convType(aAnfI[19]) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><ctl'\r\n\t\tIf !Empty(aAnfI[20])\r\n\t\t\tcString += \t' ltP=\"'\t\t+ convType(aAnfI[20]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[21])\r\n\t\t\tcString += \t' cPI=\"'\t\t+ convType(aAnfI[21]) + '\"'\t\r\n\t\tEndif\r\n\t\tcString += \t'/><ref'\r\n\t\tIf !Empty(aAnfI[22])\r\n\t\t\tcString += \t' nFE=\"'\t\t+ convType(aAnfI[22]) + '\"'\t\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[23])\r\n\t\t\tcString += \t' sNE=\"'\t\t+ convType(aAnfI[23]) + '\"'\t\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[24])\r\n\t\t\tcString += \t' cdEm=\"'\t\t+ convType(aAnfI[24]) + '\"'\t\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[25])\r\n\t\t\tcString += \t' aF=\"'\t\t\t+ convType(aAnfI[25]) + '\"'\t\r\n\t\tEndif\r\n\t\tcString += \t'/>]]>'\r\n\t\tcString += '</AnfaveaProd>'\r\n\tEndif\r\nEndif\r\n\r\nif !empty(aProd[15]) .And. !empty(cMotDesICMS) .or. ( !empty(cMotDesICMS).and. lIcmDevol .and. !Empty(nDesonICM) ) /*Conforme chamado TILXYR foi incluido o .OR. para incluir devolução na mensagem*/\r\n\tcMensDeson := 'Valor Dispensado R$ '+ cValtoChar(nDesonICM) + ', Motivo da Desoneracao do ICMS: '+cMotDesICMS+'.(Ajuste SINIEF 25/12, efeitos a partir de 20.12.12)'\r\nendif\r\n\r\n/*Nota Técnica 004 de 2011 conforme chamado - THCTB4 */\r\n/*Nota Técnica 004 de 2011 conforme chamado - THCTB4 e conforme portaria nº 275/2009 do chamado TPIPVV */\r\n\r\nif lSuframa .and. Len(aICMSZFM)>0 \r\n\tIf!(lMvNFLeiZF)\r\n\t\tif aIcmsZFM[1] > 0 .and. empty(aProd[15])\t\r\n\t\t\t\r\n\t\t\t//cMensDeson := 'Valor do ICMS abatido: R$ '+ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( '+Iif(aProd[33] > 0,AllTrim(Str(aProd[33])),'7')+'% sobre R$ ' +ConvType(aProd[10],15,2)+ ' ).'\r\n\t\t\tIf aProd[33] > 0\r\n\t\t\t\tcMensDeson := 'Valor do ICMS abatido: R$ '+ ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( '+AllTrim(Str(aProd[33]))+'% sobre R$ ' +ConvType(aProd[10] + aProd[13] + aProd[14],15,2)+ ' ).'\r\n\t\t\tElse\r\n\t\t\t\tcMensDeson := 'Valor do ICMS abatido: R$ '+ ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( '+'7% sobre R$ ' + ConvType(aProd[10]- IIF(cTipo == '1', aProd[31]+aProd[32], 0),15,2)+ ' ).'\t\r\n\t\t\tEndIf\t\r\n\t\t\t\r\n\t\telse\r\n\t\t\tcMensDeson := 'Valor do ICMS abatido: R$ '+ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( 7% sobre R$ ' +ConvType(aProd[10],15,2)+ ' ). Valor do desconto comercial: R$ '+ConvType(aProd[15],15,2)+'.'\t\r\n\t\tendif\r\n\tElse\r\n\t\tcMensDeson := 'Remessa de Mercadoria para ZFM ou ALC conforme Portaria 275.2009'\r\n\tEndif\r\nEndif\r\n\r\nIf aProd[29] > 0\r\n\tcDedIcm := 'Valor do ICMS deduzido R$ '+ cValtoChar(aProd[29] ) + '. Conforme artigo 55 anexo I do RICMS-SP.'\r\nEndIf \r\n\r\n// Valor dos Tributos por Ente Tributante: Federal, Estadual e Municipal\r\nIf lMvEnteTrb\r\n\r\n\tIf cMvMsgTrib $ \"2-3\" .And. cTpCliente == \"F\" .And. ( ( aProd[35] + aProd[36] + aProd[37] ) > 0 )\r\n\t\r\n\t\tlProdItem\t:= .T.\t\r\n\r\n\t\tcCrgTrib\t:= 'Valor aproximado do(s) Tributo(s): '\r\n\r\n\t\t// Federal\r\n\t\tIf aProd[35] > 0\r\n\t\t\tcPercTrib\t:= PercTrib( aProd, lProdItem, \"1\", aNota )  \r\n\t\t\tcCrgTrib\t+= 'R$ ' + ConvType( aProd[35], 15, 2 ) + \" (\"+cPercTrib+\"%) Federal\"\r\n\t\tEndIf\r\n\r\n\t\t// Estadual\r\n\t\tIf aProd[36] > 0\r\n\t\t\tcPercTrib\t:= PercTrib( aProd, lProdItem, \"2\", aNota )\r\n\t\t\tIf aProd[35] > 0\r\n\t\t\t\tcCrgTrib\t+= \" e \"\r\n\t\t\tEndif\r\n\t\t\tcCrgTrib\t+= \"R$ \" + ConvType( aProd[36], 15, 2 ) + \" (\"+cPercTrib+\"%) Estadual\"\r\n\t\tEndIf\r\n\t\r\n\t\t// Municipal\r\n\t\tIf aProd[37] > 0\r\n\t\t\tcPercTrib\t:= PercTrib( aProd, lProdItem, \"3\", aNota )  \r\n\t\t\tIf aProd[35] > 0 .Or. aProd[36] > 0\r\n\t\t\t\tcCrgTrib\t+= \" e \"\r\n\t\t\tEndif\r\n\t\t\tcCrgTrib\t+= \"R$ \" + ConvType( aProd[37], 15, 2 ) + \" (\"+cPercTrib+\"%) Municipal.\"\r\n\t\tEndIf\r\n\t\t\r\n\t\tIf !Empty( cFntCtrb )\r\n\t\t   cCrgTrib += \"  Fonte: \" + cFntCtrb + \".\"\r\n\t\tEndIf\r\n\t\t\r\n\t\t\r\n\tEndif\r\n\t\r\nElse\r\n\r\n\tIf aProd[30] > 0 .And. cMvMsgTrib $ \"2-3\" .And. cTpCliente == \"F\"\r\n\t\tlProdItem := .T.\t\r\n\t\tcPercTrib := PercTrib(aProd, lProdItem,,aNota)  \r\n\t\r\n\t\tcCrgTrib := 'Valor Aproximado dos Tributos: R$ '+ ConvType(aProd[30],15,2)+ \" (\"+cPercTrib+\"%).\"\t\r\n\tEndIf\r\n\r\nEndif\r\n\r\n// Grupo opcional 'impostoDevol' para informar o valor e percentual do IPI devolvido para notas de Devolução\r\nIf Len(aIPIDevol) > 0 .and. cTPNota == \"4\" \r\n\tcString += '<IPIDEV>'\r\n\tcString += '<pdevol>'+ConvType(aIPIDevol[01],6,2)+'</pdevol>' //Percentual da mercadoria devolvida\r\n\tcString += '<vipidevol>'+ConvType(aIPIDevol[02],15,2)+'</vipidevol>' //Valor do IPI devolvido\r\n\tcString += '</IPIDEV>'\t\r\nEndIf\r\n\r\n\r\n//Tratamento para incluir a mensagem em informacoes adicionais  do Produto (PR)\r\nIf aProd[43] > 0 .and. aDest[9] == \"PR\" .and.  cVerAmb ='3.10'\r\n\tcMensFecp := NfeMFECOP(aProd[43],aDest[9],\"2\")\r\nElseIf aProd[43] > 0  .and. cVerAmb ='4.00'\r\n   cMensFecp := NfeMFECOP(aProd[43],aDest[9],\"2\",aICMS,aICMSST,cVerAmb)\r\nEndIf\r\ncString += '<infadprod>'+ConvType(aProd[25],500)+cMensDeson+cDedIcm+cCrgTrib+cMensFecp+'</infadprod>'\r\n\r\ncString += '</det>' \r\nReturn(cString)\r\n\r\nStatic Function NfeTotal(aTotal,aRet,aICMS,aICMSST,lIcmDevol,cVerAmb,aISSQN,nVicmsDeson,aNota,nVIcmDif,aAgrPis,aAgrCofins,nValLeite )\r\n\r\nLocal cString\t\t:= \"\"\r\nLocal cMVREGIESP\t:= AllTrim(GetNewPar(\"MV_REGIESP\",\"2\"))\r\n/*1 – Microempresa Municipal; 2 – Estimativa; 3 – Sociedade de Profissionais; \r\n4 – Cooperativa; 5 – Microempresário Individual (MEI); \r\n6 – Microempresário e Empresa de Pequeno Porte (ME EPP)*/\r\nLocal nX     := 0\r\nLocal nBicm := 0\r\nLOcal nVicm := 0\r\nLocal nBicmst := 0\r\nLOcal nVicmst := 0\r\nLocal nAgrPis := 0\r\nLocal nAgrCofins := 0\r\n\r\nDefault nVicmsDeson\t:= 0\r\nDefault nVIcmDif\t:= 0\r\nDefault nValLeite   := 0\r\n\r\ncString += '<total>'\r\nIf Len(aICMS)>0 \r\n\tFor nX := 1 To Len(aICMS)\r\n\t\tIf Len(aICMS[NX]) >0\r\n\t\t\tnBicm += iIf(lIcmDevol,aICMS[NX][05],0)\r\n\t\t\tnVicm += iIf(lIcmDevol,aICMS[NX][07],0)\r\n\t\tEndif\t\r\n\tNext nX\r\nEndif\r\n\r\nIf Len(aICMSST)>0 \r\n\tFor nX := 1 To Len(aICMSST)\r\n\t\tIf Len(aICMSST[NX]) >0\r\n\t\t\tnBicmst += aICMSST[NX][05]\r\n\t\t\tnVicmst += aICMSST[NX][07]\r\n\t\tEndif\t\r\n\tNext nX\r\nEndif\r\n\r\nFor nX := 1 to Len(aAgrPis)\r\n\tnAgrPis\t\t+=\taAgrPis[nX][02]\r\n\tnAgrCofins\t+=\taAgrCofins[nX][02]\r\nNext\r\n\r\ncString += '<vBC>'+ConvType(nBicm, 15,2)+'</vBC>' \r\n\r\nIf cVerAmb >= \"3.10\" .and. nVIcmDif > 0\r\n\tcString += '<vICMS>'+ConvType(nVicm-nVIcmDif,15,2)+'</vICMS>'\r\nElse\r\n\tcString += '<vICMS>'+ConvType(nVicm,15,2)+'</vICMS>'\r\nEndIf\r\n\r\ncString += '<vBCST>'+ConvType(nBicmst,15,2)+'</vBCST>'\r\ncString += '<vICMSST>'+ConvType(nVicmst,15,2)+'</vICMSST>'\r\ncString += '<despesa>'+ConvType(aTotal[01]+nAgrPis+nAgrCofins+nValLeite,15,2)+'</despesa>'\r\n//cString += '<vNF>'+ConvType(aTotal[02],15,2)+'</vNF>'\r\n//Alteração para que o valor de PIS ST e COFINS ST venha a compor o valor da nota este valor se encontra na tag vOutros  (NT 2011/004). E devolução de compra com IPI não tributado\r\ncString += '<vNF>'+ConvType(aTotal[02]+aTotal[03],15,2)+'</vNF>'\r\n\r\nIf cVerAmb >= \"3.10\" .and. Len(aISSQN)>0\r\n\tcString += NfeTag('<cRegTrib>',ConvType(cMVREGIESP,1))\r\n\tcString += '<dCompet>'+Strtran(ConvType(aNota[03]),\"-\",\"\")+'</dCompet>'\r\nEndIf\t\r\nIf Len(aRet)>0\r\n\tFor nX := 1 To Len(aRet)\r\n\t\tcString += '<TributoRetido>'\r\n\t\tcString += NfeTag('<codigo>' ,ConvType(aRet[nX,01],15,2))\r\n\t\tcString += NfeTag('<BC>'     ,ConvType(aRet[nX,02],15,2))\r\n\t\tcString += NfeTag('<valor>',ConvType(aRet[nX,03],15,2))\r\n\t\tcString += '</TributoRetido>'\r\n/*\t    If aRet[nX,01] =='PIS'\r\n\t    \tnValPis += ConvType(aRet[nX,03],15,2)\r\n\t    EndIf\r\n\t    If aRet[nX,01] =='COFINS'\r\n\t    \tnValCof += ConvType(aRet[nX,03],15,2)\r\n\t    EndIf\t\t*/\r\n\tNext nX\r\nEndIf\r\ncString += '</total>'\r\n\r\n//Variavel para ter o valor total da nota para ser utilizado na Lei da Transparencia\r\nnTotNota \t:= Val(ConvType((aTotal[02]+aTotal[03]),15,2))\r\n\r\n\r\nReturn(cString)\r\n\r\nStatic Function NfeTransp(cModFrete,aTransp,aImp,aVeiculo,aReboque,aVol,cVerAmb,aReboqu2,cMunDest)\r\n           \r\nLocal nX := 0\r\nLocal cString := \"\"\r\nLocal lMVINTTRAN := SuperGetMV(\"MV_INTTRAN\", ,.T.)  // Parametro que define se as tags <veicTransp> e <reboque>, seram geradas em operações internas.\r\nLocal lGeraTags\t := .T.\r\nDEFAULT cMunDest\t:= \"\"\r\nDEFAULT aTransp := {}\r\nDEFAULT aImp    := {}\r\nDEFAULT aVeiculo:= {}\r\nDEFAULT aReboque:= {}\r\nDEFAULT aReboqu2:= {}\r\nDEFAULT aVol    := {}\r\n\r\ncString += '<transp>'\r\nIf cVerAmb >= \"2.00\"\r\n\tIf cModFrete == \"\"\r\n\t\tcString += '<modFrete>'+\"1\"+'</modFrete>' \r\n\tElse \r\n\t\tcString += '<modFrete>'+cModFrete+'</modFrete>'\r\n\tEndif\r\nEndif\r\n\r\nIf cVerAmb == \"4.00\"\r\n\t//Se operação interestadual(idDest=2), não informar os Grupos Veiculo Transporte (id:X18; veicTransp) e Grupo Reboque (id: X22)\r\n\t//Obs1: a critério de cada UF, a regra de validação acima também pode ser aplicada nas operações internas (idDest=1) se cMun (id:C10) do Emitente <> cMun (id: E10) do Destinatário\r\n\tIf cIdDest == \"2\" .or. (cIdDest == \"1\" .And. SM0->M0_CODMUN <> cMunDest .And. !lMVINTTRAN)\r\n\t\tlGeraTags:= .F.  \r\n\tEndif\r\nEndif\r\n\r\nIf Len(aTransp)>0\r\n\tcString += '<transporta>'\r\n\t\tIf Len(aTransp[01])==14\r\n\t\t\tcString += NfeTag('<CNPJ>',aTransp[01])\r\n\t\tElseIf Len(aTransp[01])<>0\r\n\t\t\tcString += NfeTag('<CPF>',aTransp[01])\r\n\t\tEndIf\r\n\t\tcString += NfeTag('<Nome>' ,ConvType(aTransp[02]))\r\n\t\tcString += NfeTag('<IE>'    ,aTransp[03])\r\n\t\tcString += NfeTag('<Ender>',ConvType(aTransp[04]))\r\n\t\tcString += NfeTag('<Mun>'  ,ConvType(aTransp[05]))\r\n\t\tcString += NfeTag('<UF>'    ,ConvType(aTransp[06]))\r\n\tcString += '</transporta>'\r\n\tIf Len(aImp)>0 //Ver Fisco\r\n\t\tcString += '<retTransp>'\r\n\t\tcString += '<codigo>ICMS</codigo>'\r\n\t\tcString += '<Cpl>'\r\n\t\tcString += '<vServ>'+ConvType(aImp[01],15,2)+'</vServ>'\r\n\t\tcString += '<CFOP>'+ConvType(aImp[02])+'</CFOP>'\r\n\t\tcString += '<cMunFG>'+ConvType(aImp[03],7)+'</cMunFG>'\t\t\r\n\t\tcString += '</Cpl>'\r\n\t\tcString += '<CST>'+ConvType(aImp[04])+'</CST>'\r\n\t\tcString += '<MODBC>'+ConvType(aImp[05])+'</MODBC>'\r\n\t\tcString += '<PREDBC>'+ConvType(aImp[06],7,2)+'</PREDBC>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<VBC>'+ConvType(aImp[07],15,2)+'</VBC>'\r\n\t\tcString += '<aliquota>'+ConvType(aImp[08],7,4)+'</aliquota>'\r\n\t\tcString += '<valor>'+ConvType(aImp[9],15,2)+'</valor>'\r\n\t\tcString += '</Tributo>'\t\t\r\n\t\t// cString += '<vltrib>'+ConvType(aImp[09],15,4)+'</vltrib>'\t\r\n\t\t// cString += '<qtrib>'+ConvType(aImp[10],16,4)+'</qtrib>'\t\t\r\n\t\tcString += '</retTransp>'\r\n\tEndIf\r\n\tIf lGeraTags\r\n\t\tIf Len(aVeiculo)>0\r\n\t\t\tcString += '<veicTransp>'\r\n\t\t\t\tcString += '<placa>'+ConvType(aVeiculo[01])+'</placa>'\r\n\t\t\t\tcString += '<UF>'   +ConvType(aVeiculo[02])+'</UF>'\r\n\t\t\t\tcString += NfeTag('<RNTC>',ConvType(aVeiculo[03]))\r\n\t\t\tcString += '</veicTransp>'\r\n\t\tEndIf\r\n\t\tIf Len(aReboque)>0\r\n\t\t\tcString += '<reboque>'\r\n\t\t\t\tcString += '<placa>'+ConvType(aReboque[01])+'</placa>'\r\n\t\t\t\tcString += '<UF>'   +ConvType(aReboque[02])+'</UF>'\r\n\t\t\t\tcString += NfeTag('<RNTC>',ConvType(aReboque[03]))\r\n\t\t\tcString += '</reboque>'\r\n\t\t\tIf Len(aReboqu2)>0\r\n\t\t\t\tcString += '<reboque>'\r\n\t\t\t\tcString += '<placa>'+ConvType(aReboqu2[01])+'</placa>'\r\n\t\t\t\tcString += '<UF>'   +ConvType(aReboqu2[02])+'</UF>'\r\n\t\t\t\tcString += NfeTag('<RNTC>',ConvType(aReboqu2[03]))\r\n\t\t\t\tcString += '</reboque>'\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\t\t\r\nElseIf lGeraTags .And. Len(aVeiculo)>0\r\n\t\tcString += '<veicTransp>'\r\n\t\t\tcString += '<placa>'+ConvType(aVeiculo[01])+'</placa>'\r\n\t\t\tcString += '<UF>'   +ConvType(aVeiculo[02])+'</UF>'\r\n\t\t\tcString += NfeTag('<RNTC>',ConvType(aVeiculo[03]))\r\n\t\tcString += '</veicTransp>'\r\nEndIf\r\nFor nX := 1 To Len(aVol)\t\t\r\n\tcString += '<vol>'\r\n\t\tcString += NfeTag('<qVol>',ConvType(aVol[nX][02]))\r\n\t\tcString += NfeTag('<esp>' ,ConvType(aVol[nX][01],30,0))\r\n\t\tif len( aVol[nX] ) >= 5 \r\n\t\t\tcString += NfeTag('<marca>' ,ConvType(aVol[nX][05]))\r\n\t\tendif\r\n\t\tif len( aVol[nX] ) >= 6 \r\n\t\t\tcString += NfeTag('<nVol>'  ,ConvType(aVol[nX][06]))\r\n\t\tendif\r\n\t\tcString += NfeTag('<pesoL>' ,ConvType(aVol[nX][03],15,3))\r\n\t\tcString += NfeTag('<pesoB>' ,ConvType(aVol[nX][04],15,3))\r\n\t\t//cString += '<nLacre>'+aVol[07]+'</nLacre>'\r\n\tcString += '</vol>'\r\nNext nX\r\ncString += '</transp>'\r\nReturn(cString)\r\n\r\nStatic Function NfeCob(aDupl,aFat,cFatura)\r\n\r\nLocal cString := \"\"\r\nLocal nX := 0 \r\nLocal nValorfat := 0  \r\nLocal cValorDesc := \"0\"  \r\nlocal lDatDupl\t\t:= SuperGetMV(\"MV_DATDUPL\",.F.,.F.) \r\nDEFAULT cFatura\t:= \"\"\r\nDEFAULT aDupl\t:= {}  \r\nDEFAULT aFat\t:= {}\r\n               \r\n//Ordeno as duplicatas por data de vencimento\r\nIf Len(aDupl) > 1\r\n\taDupl := SortArray(aDupl,,,{|x,y| x[2] < y[2] .and. x[3] > y[3] })\r\nEndIf\t\r\n\r\nIf Len(aDupl)>0\r\n\r\n\tcString += '<cobr>'\r\n\t\r\n\tIf Len(aFat)>0\r\n\t\tcString += '<fat>'\r\n\t\tcString += '<nFatura>'+ConvType(aFat[01][01])+'</nFatura>'\r\n\t\tcString += '<vOriginal>'+ConvType(aFat[01][02],15,2)+'</vOriginal>'\r\n\t\tcString += '<vDesconto>'+ConvType(aFat[01][03],15,2)+'</vDesconto>'\r\n\t\tcString += '<vLiquido>' +ConvType(aFat[01][04],15,2)+'</vLiquido>'\r\n\t\tcString += '</fat>'\r\n\telse\r\n\t\tFor nX := 1 To Len(aDupl)\r\n\t\t\tnValorfat:= nValorfat + aDupl[nX][03]\r\n\t\tNext nX\t\r\n\t\t\r\n\t\tcString += '<fat>'\r\n\t\tcString += '<nFatura>'+ConvType(cFatura)+'</nFatura>'\r\n\t\tcString += '<vOriginal>'+ConvType(nValorfat,15,2)+'</vOriginal>'\r\n\t\tcString += '<vDesconto>'+cValorDesc+'</vDesconto>'\r\n\t\tcString += '<vLiquido>' +ConvType(nValorfat,15,2)+'</vLiquido>'\r\n\t\tcString += '</fat>'\r\n\tEndIf\r\n\t\r\n\t\r\n\tFor nX := 1 To Len(aDupl)\r\n\t\tcString += '<dup>'\r\n\t\tcString += '<Dup>'+ConvType(PADL(nX,3,\"0\"))+'</Dup>'\r\n\t\tIf (aDupl[nX][02] < DATE()) .and. lDatDupl\r\n\t\t\tcString += '<dtVenc>'+ConvType(DATE())+'</dtVenc>'\t\r\n\t\tElse\r\n\t\t\tcString += '<dtVenc>'+ConvType(aDupl[nX][02])+'</dtVenc>'\r\n\t\tEndIf\r\n\t\tcString += '<vDup>'+ConvType(aDupl[nX][03],15,2)+'</vDup>'\r\n\t\tcString += '</dup>'\r\n\tNext nX\t\r\n\tcString += '</cobr>'\r\nEndIf\r\n\r\nReturn(cString)\r\n\r\nStatic Function NfeInfAd(cMsgCli,cMsgFis,aPedido,aExp,cAnfavea,aMotivoCont,aNfSa,aNfVinc,aProd,aDI,aNfVincRur,aRet,cNfRefcup,cSerRefcup,cTipo,nIPIConsig,nSTConsig,lBrinde,cVerAmb,aRefECF,nVicmsDeson,nvFCPUFDest,nvICMSUFDest,nvICMSUFRemet,nvBCUFDest,aICMUFDest,nValIpiBene,npFCPUFDest,npICMSUFDest,npICMSInter,npICMSIntP,aObsCont,aValTotOpe,cMensDifal,aProcRef,aDest,nTotCrdP,cMensCpl)\r\nLocal cString   \t\t:= \"\"\r\nLocal cCfor     \t\t:= \"\"\r\nLocal cLojaEn   \t\t:= \"\"\r\nLocal cCnpjen   \t\t:= \"\"\r\nLocal cDocEn    \t\t:= \"\"\r\nLocal cSerieEn  \t\t:= \"\"\r\nLocal cChave1   \t\t:= \"\"\r\nLocal cValidCh\t\t\t:= \"\"\r\nLocal cInfRem\t\t\t:= \"\"\r\nLocal cNfVinc\t\t\t:= \"\"\r\nLocal cEcfVinc\t\t\t:= \"\"\r\nLocal cChvNFe\t\t\t:= \"\"\r\nLocal cNfVincRur\t\t:= \"\"\r\nLocal cPercTrib \t\t:= \"\"\r\nLocal aEEC     \t\t\t:= {}\r\nLocal aNcm    \t\t\t:= {}\r\nLocal aDadosDest\t\t:= {}\r\nLocal aInfoDest\t\t\t:= {}\r\nLocal nX        \t\t:= 0\r\nLocal nY        \t\t:= 0\r\nLocal nZ\t\t\t\t:= 0\r\nLocal nW\t\t\t\t:= 0\r\nLocal nPos\t\t\t\t:= 0\r\nLocal nValII\t\t\t:= 0\r\nLocal nVlrTotal \t\t:= 0\r\nLocal lEasy\t\t\t\t:= SuperGetMV(\"MV_EASY\") == \"S\"\r\nLocal lImpRet\t\t\t:= GetNewPar(\"MV_IMPRET\",.F.)\r\nLocal lProdItem\t\t\t:= .F.\t//Define se esta configurado para gerar a mensagem da Lei da Transparencia por Produto ou somente nas informacoes Complementares.\r\nLocal lEECFAT\t\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lEIC0064\t\t\t:= GetNewPar(\"MV_EIC0064\",.F.)\r\nLocal lMsnOk    \t\t:= .F.\r\n\r\n\r\nDEFAULT cAnfavea\t\t:= \"\"\r\nDEFAULT aPedido \t\t:= {}\r\nDEFAULT aExp\t\t\t:= {}\r\nDEFAULT aNfSa\t\t\t:= {}\r\nDEFAULT aNfVinc \t\t:= {}\r\nDEFAULT aProd\t\t\t:= {}  \r\nDEFAULT aDI \t\t\t:= {}  \r\nDEFAULT aNfVincRur \t\t:= {}  \r\nDEFAULT aRefECF\t\t\t:= {} \r\nDEFAULT nIPIConsig \t\t:= 0  \r\nDEFAULT nSTConsig \t\t:= 0  \r\nDEFAULT nvFCPUFDest\t\t:= 0\r\nDEFAULT nvICMSUFDest\t:= 0\r\nDEFAULT nvICMSUFRemet\t:= 0\r\nDEFAULT npFCPUFDest   \t:= 0 \r\nDEFAULT npICMSUFDest  \t:= 0 \r\nDEFAULT npICMSInter   \t:= 0 \r\nDEFAULT npICMSIntP    \t:= 0 \t\r\nDEFAULT nValIpiBene\t\t:= 0\r\nDEFAULT nTotCrdP        := 0\r\nDEFAULT cAnfavea\t\t:= \"\"\r\nDEFAULT nvBCUFDest \t\t:= 0\r\nDEFAULT aICMUFDest \t\t:= {} \r\nDEFAULT aObsCont   \t\t:= {}\t\r\nDEFAULT aProcRef   \t\t:= {}\t\r\nDEFAULT aDest      \t\t:= {}\r\n\r\ncString += '<infAdic>'\r\n\r\nIf AliasIndic(\"EYY\")\r\n\taEEC:= AvGetNfRem(aNfSa[2],aNfSa[1])\t \r\nEndif\r\n\r\n//array aEEC:= AvGetNfRem\r\n//documento   1\r\n//serie       2\r\n//fornecedor  3\r\n//loja        4\r\nIf len(aEEC) > 0\r\n\tFor nY := 1 To Len(aEEC)        \r\n\t   \tdbSelectArea(\"SF1\")\r\n\t\tdbSetOrder(1)\r\n\t\tIf DbSeek(xFilial(\"SF1\")+aEEC[ny][2][1]+aEEC[ny][2][2]+aEEC[ny][2][3]+aEEC[ny][2][4])\r\n\t\t\tIf cValidCh <> (xFilial(\"SF1\")+aEEC[ny][2][1]+aEEC[ny][2][2]+aEEC[ny][2][3]+aEEC[ny][2][4])\r\n\t\t\t\tcCfor      := SF1->F1_FORNECE\r\n\t\t\t    cLojaEn    := SF1->F1_LOJA\r\n\t\t\t    dEmisEn    := SF1->F1_EMISSAO  \r\n\t\t\t\tcDocEn\t   := SF1->F1_DOC\r\n\t\t\t\tcSerieEn   := SF1->F1_SERIE\r\n\t\t\t    cValidCh   := (xFilial(\"SF1\")+aEEC[ny][2][1]+aEEC[ny][2][2]+aEEC[ny][2][3]+aEEC[ny][2][4])\r\n\t\t\t    \r\n\t\t\t    dbSelectArea(\"SA2\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf DbSeek(xFilial(\"SA2\")+cCfor+cLojaEn)\r\n\t\t\t\t\tcCnpjen    := SA2->A2_CGC\r\n\t\t\t\tEndIf   \r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea( \"SD1\" )\r\n\t\t\t\tdbSetOrder( 1 )\r\n\t\t\t\tcChave1 := xFilial( \"SD1\" ) + cDocEn + cSerieEn + cCfor + cLojaEn\r\n\r\n\t\t\t\tif( dbSeek( cChave1 ) )\r\n\t\t\t\t\tdbSelectArea( \"SB1\" )\r\n\t\t\t   \t\tdbSetOrder( 1 )\r\n\r\n\t\t\t\t\twhile !SD1->(eof()) .and. cChave1 == xFilial( \"SD1\" ) + SD1->D1_DOC + SD1->D1_SERIE + SD1->D1_FORNECE + SD1->D1_LOJA\r\n\t\t\t\t\t\tif( dbSeek( xFilial( \"SB1\" ) + SD1->D1_COD ) )\r\n\t\t\t\t\t\t\tnPos := aScan( aNcm,{ |x|x[2] == SB1->B1_POSIPI } )\r\n\r\n\t\t\t\t\t\t\tif( nPos > 0 )\r\n\t\t\t\t\t\t\t\taNcm[nPos,03] += SD1->D1_QUANT\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\taadd( aNcm,{ cChave1,SB1->B1_POSIPI,SD1->D1_QUANT,SB1->B1_UM } )\r\n\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\tendIf\r\n\r\n\t\t\t\t\t\tSD1->( dbSkip() )\r\n\t\t\t\t\tendDo\r\n\t\t\t\t\t\r\n\t\t\t\t\tif( nY > 1 )\r\n\t\t\t\t\t\tcInfRem += \"CNPJ-CPF Rem.\"+\": \"+cCnpjen+\"/\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcInfRem := \"CNPJ-CPF Rem.\"+\": \"+cCnpjen+\"/\"\r\n\t\t\t\t\tendIf\r\n\t\t\t\t\t \t\t\t\t\t \r\n\t\t\t\t\tcInfRem += \"Numero NF\"+\": \"+cDocEn+\"/\"+\"Serie\"+\": \"+cSerieEn+\"/\"+\"Data Emissao\"+\": \"+StrZero(Day(dEmisEn),2)+'-'+StrZero(Month(dEmisEn),2)+'-'+StrZero(Year(dEmisEn),4)\r\n\t\t\t\t\t \r\n\t\t\t\t\tfor nX := 1 to len( aNcm )\r\n\t\t\t\t\t\tcInfRem += +\"/\"+\"NCM-SH\"+\": \"+aNcm[nx,02]+\"/\"+\"UM\"+\": \"+aNcm[nx,04]+\"/\"+\"Quantidade\"+\": \"+AllTrim(Str(aNcm[nx,03]))\r\n\t\t\t\t\tnext nX\r\n\t\t\t\tendIf\r\n\t\t\tEndif\r\n\t\tEndIf\r\n\tNext ny\r\nEndIf \r\n\r\n/*\r\nREQUISITO PAF-ECF - Controle de Lojas\r\nEssa função insere o MD-5 do PAFLISTA.TXT\r\nno inicio da mensagem no campo \"Mensagens Adicionais\"\r\n*/\r\nIf ExistFunc(\"STFMMD5Nfe\")\r\n\tSTFMMD5Nfe(@cMsgFis)\r\nEndIf\r\n\r\nIf Len(cMsgFis)>0    \r\n\tcString += '<Fisco>'+ConvType(cMsgFis,Len(cMsgFis))+'</Fisco>'\r\nEndIf\r\n\r\ncString += '<Cpl>[ContrTSS='+StrZero(Year(ddatabase),4)+'-'+StrZero(Month(ddatabase),2)+'-'+StrZero(Day(ddatabase),2)+'#'+AllTrim(Time())+'#'+AllTrim(UsrFullName())+']'\r\n\r\nIf Len(cInfRem)>0\r\n\tcString += ConvType(cInfRem,Len(cInfRem))+\" \"\r\nEndIf\r\n\r\nIf !Empty(cMensCpl)\r\n\tcString += cMensCpl + \" \"\r\nEndIF\r\n\r\nIf Len(aMotivoCont)>0\r\n\t//cString += ConvType(\"DANFE emitida em contingencia devido a problemas técnicos - será necessária a substituição.\",Len(\"DANFE emitida em contingencia devido a problemas técnicos - será necessária a substituição.\"))+\" \"\r\n\tcString += \"Motivo da contingencia: \"+ConvType(aMotivoCont[1],Len(aMotivoCont[1]))+\", com \"\r\n\tcString += ConvType(\"inicío em\",Len(\"inicío em\"))+\" \"+StrZero(Day(aMotivoCont[2]),2)+\"/\"+StrZero(Month(aMotivoCont[2]),2)+\"/\"+StrZero(Year(aMotivoCont[2]),4)+\" \"\r\n\tcString += ConvType(\"às\",2)+\" \"+ConvType(aMotivoCont[3],Len(aMotivoCont[3]))+\".\"\r\nEndIf \r\nIf Len(cMsgCli)>0 .and. !Empty(cMsgCli)\r\n\tcString += ConvType(cMsgCli,Len(cMsgCli))+\" \"  \r\n\t//A Nota Fiscal de devolução deve ser preenchida com a nota e a data Original de acordo com a legislação:\r\n\t//Fundamento: Artigo 136 do RICMS-SP - O contribuinte,  excetuado o produtor,  emitirá Nota Fiscal (Lei nº 6374/89,  art. 67,  \r\n\t//Parágrafo 1º,  e Convênio de 15.12.70 - SINIEF, arts. 54 e 56, na redação do Ajuste SINlEF- 3/94, cláusula primeira, XII):.\r\n\tIF (SM0->M0_ESTENT) $ \"SP\" .AND. cTipo=='0' .And. !Empty(cSerRefcup + cNfRefcup)\r\n\t\tSFT->(dbSetOrder(6))\r\n\t\tIf SFT->(dbSeek(xFilial(\"SFT\")+\"S\"+cNfRefcup+cSerRefcup))\r\n\t\t\tcString += \" Artigo 136 do RICMS-SP Emissao Original NF-e: \"+cSerRefcup+\" \"+cNfRefcup+\" \"+Dtoc(SFT->FT_EMISSAO)+\" \" \r\n\t\tEndIf\t\t\r\n\tEndif\r\nEndIf   \r\n\r\nif SM0->M0_ESTENT == 'SP' .and. Len(aNfVinc) > 0\r\n\taSort(aNfVinc, , , {|x,y| x[4]+x[3] < y[4]+y[3] } ) //Ordena por CNPJ + Doc para aglutinar/totalizar os documentos por CNPJ\r\nEndIf\r\n\r\nIf Len( aNfVinc ) > 0 //Nota de espécie NFE ou NCE ou CTE vinculada\r\n\tFor nZ := 1  to Len( aNfVinc )\r\n\t\tIf !( aNfVinc[nZ][2] + aNfVinc[nZ][3] ) $ cChvNFe\r\n\t\t\tif !Empty(aNfVinc[nZ][6]) .and. \"CTE\" == UPPER(Alltrim(aNfVinc[nZ][6]))\r\n\t\t\t\tcString += \"Emissao Original CT-e: \"\r\n\t\t\telseif !Empty(aNfVinc[nZ][6]) .and. \"NFCE\" == UPPER(Alltrim(aNfVinc[nZ][6]))\r\n\t\t\t\tcString += \"Emissao Original NFC-e: \"\r\n\t\t\tElse\r\n\t\t\t\tif SM0->M0_ESTENT == 'SP' .And. !(aNfSa[5] $ \"I/P/C\") .And. !Empty(aNfVinc[nZ][13])\r\n\t\t\t\t\t//Busca pela chave: Codigo + Loja + Tipo de cadastro (1-cliente/2-fornecedor)\r\n\t\t\t\t\tif (nPos := aScan(aDadosDest,{|x| x[1]+x[2]+x[10] == aNfVinc[nZ][12]+aNfVinc[nZ][13]+AllTrim(Str(aNfVinc[nZ][11])) }) ) == 0\r\n\t\t\t\t\t\tIf At(\"#valor\",cString) > 0 //Verifica se houve uma troca de Cliente/fornecedor para totalizar o anterior\r\n\t\t\t\t\t\t\tcString :=  StrTran( cString, \"#valor\", ConvType(nVlrTotal,15,2))\r\n\t\t\t\t\t\t\tnVlrTotal := 0\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf aNfVinc[nZ][11]==1\r\n\t\t\t\t\t\t\taInfoDest := GetAdvFVal(\"SA1\", { \"A1_COD\",\"A1_LOJA\",\"A1_NOME\", \"A1_MUN\", \"A1_EST\", \"A1_END\", \"A1_BAIRRO\", \"A1_CGC\", \"A1_INSCR\"}, xFilial(\"SA1\")+aNfVinc[nZ][12]+aNfVinc[nZ][13], 1, { \"\", \"\", \"\", \"\", \"\", \"\", \"\" })\r\n\t\t\t\t\t\t\taAdd(aInfoDest, \"1\")\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taInfoDest := GetAdvFVal(\"SA2\", { \"A2_COD\",\"A2_LOJA\",\"A2_NOME\", \"A2_MUN\", \"A2_EST\", \"A2_END\", \"A2_BAIRRO\", \"A2_CGC\", \"A2_INSCR\"}, xFilial(\"SA1\")+aNfVinc[nZ][12]+aNfVinc[nZ][13], 1, { \"\", \"\", \"\", \"\", \"\", \"\", \"\" })\r\n\t\t\t\t\t\t\taAdd(aInfoDest, \"2\")\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\taAdd(aDadosDest,aInfoDest)\r\n\t\t\t\t\t\tnPos := Len(aDadosDest)\r\n\r\n\t\t\t\t\t\tcString += 'Retorno recebidos no Total R$ #valor , '\r\n\t\t\t\t\t\tcString += 'atraves da ' + Alltrim(aDadosDest[nPos,3]) + ', estabelecida na cidade de ' + alltrim(aDadosDest[nPos,4]) + '/' + alltrim(aDadosDest[nPos,5]) + ', na '\r\n\t\t\t\t\t\tcString += alltrim(aDadosDest[nPos,6]) + ', ' + alltrim(aDadosDest[nPos,7]) + ', inscrita no CNPJ sob nº ' + alltrim(aDadosDest[nPos,8]) + ' e Inscricao Estadual '\r\n\t\t\t\t\t\tcString += alltrim(aDadosDest[nPos,9]) + ' atraves das NFs: '\r\n\t\t\t\t\t\tlMsnOk:= .T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcString += \"NF-e: \"\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += \"Emissão Original NF-e: \"\r\n\t\t\t\tendIf\r\n\t\t\tendif\r\n\r\n\t\t\tcChvNFe += aNfVinc[nZ][2] + aNfVinc[nZ][3] + \"|\"\r\n\t\t\tcNfVinc := ( aNfVinc[nZ][2] + \" \" + aNfVinc[nZ][3] + \" \" + StrZero( Day( aNfVinc[nZ][1] ), 2 ) + \"-\" + StrZero( Month( aNfVinc[nZ][1] ), 2 ) + \"-\" + StrZero( Year( aNfVinc[nZ][1] ), 4 ) + \", \" )\r\n\t\t\tcString += ConvType( cNfVinc, Len( cNfVinc ) ) + \" \"\r\n\t\t\tif SM0->M0_ESTENT == 'SP'  \r\n\t\t\t\tIf Len (aNfVinc[nZ] ) >= 8 .and.  !Empty(aNfVinc[nZ][08]) .And. Len(aValTotOpe) > 0\r\n\t\t\t\t\tnW := Ascan( aValTotOpe, { | e | e[1] == aNfVinc[nZ][7] } )\r\n\t\t\t\t\tIf nW > 0\r\n\t\t\t\t\t\tcString += \"Valor da Operacao do Documento de Origem: \" + ConvType(aValTotOpe[nW][2],15,2) +' '\r\n\t\t\t\t\t\tnVlrTotal:= nVlrTotal + aValTotOpe[nW][2]\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tendif\r\n\t\t\tendif \r\n\t\tEndIf\r\n\tNext nZ\r\n\r\n\tIf lMsnOk //Para totalizar o ultimo cliete/fornecedor\r\n\t\tcString :=  StrTran( cString, \"#valor\", ConvType(nVlrTotal,15,2))\r\n\tEndIf\r\n\r\nEndIf\r\n\r\nIf Len( aRefECF ) > 0\t \t//Nota de espécie ECF vinculada\r\n\tcString += \"Emissao Original CF: \"\r\n\tFor nX := 1  to Len( aRefECF )\r\n\t\tIf !( Alltrim(aRefECF[nX][1]) + Alltrim(aRefECF[nX][2]) + Alltrim(aRefECF[nX][3]) ) $ cChvNFe\r\n\t\t\tcChvNFe += Alltrim(aRefECF[nX][1]) + Alltrim(aRefECF[nX][2]) + Alltrim(aRefECF[nX][3]) + \"|\"\r\n\t\t\tcEcfVinc := Alltrim(aRefECF[nX][2]) + \" \" + Alltrim(aRefECF[nX][1]) +\" \"+ Alltrim(aRefECF[nX][3])\r\n\t\t\tcString += ConvType( cEcfVinc, Len( cEcfVinc ) ) + \" \"\r\n\t\tEndIf\r\n\tNext Nx\r\nEndIf\r\n\r\nIf Len( aNfVincRur ) > 0 \t//Nota de espécie NFP vinculada \r\n\tcString += \"Emissao Original NFP: \"\r\n\tFor nX := 1  to Len( aNfVincRur )\r\n\t\tIf !( aNfVincRur[nX][2] + aNfVincRur[nX][3] ) $ cChvNFe\r\n\t\t\tcChvNFe += aNfVincRur[nX][2] + aNfVincRur[nX][3] + \"|\"\r\n\t\t\tcNfVincRur := ( aNfVincRur[nX][2] + \" \" + aNfVincRur[nX][3] + \" \" + StrZero( Day( aNfVincRur[nx][1] ), 2 ) + \"-\" + StrZero( Month( aNfVincRur[Nx][1] ), 2 ) + \"-\" + StrZero( Year( aNfVincRur[Nx][1] ), 4 ) + \", \" )\r\n\t\t\tcString += ConvType( cNfVincRur, Len( cNfVincRur ) ) + \" \"\r\n\t\tEndIf\r\n\tNext Nx\r\nEndIf\r\n\r\nnValII := 0\r\nFor nX := 1 To Len(aProd)\r\n\tIf Substr(ConvType(aProd[nX,7]),1,1) $ \"3\" \r\n\t\tIf Len(aDI[nx]) > 0 \r\n\t\t\tnValII += aDI[nX][19][03]\r\n\t\tEndIf\r\n\tEndIf\r\nNext\r\nIf nValII > 0\r\n\tIf lEasy .And. IIF(!GetNewPar(\"MV_SPEDEND\",.F.),ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SP\" .and. lEIC0064\r\n\t\tcString += (\"Valor total do Imposto de Importacao : R$ \" + ConvType(nValII,15,2))\r\n\t\tcString += (\" .O valor do Imposto de Importacao nao esta embutido no valor dos produtos, somente ao valor total da NF-e.\")\r\n\tElse\r\n\t\tcString += (\"Valor total do Imposto de Importacao : R$ \" + ConvType(nValII,15,2))\r\n\tEndIf\t\r\nEndif\r\n\r\nIf Len(aRet) > 0 .And. lImpRet\r\n\tcString += \"Retencoes: \"\r\n\tFor nX :=1 to Len(aRet)\r\n\t\tDo Case\r\n\t\t\tCase aRet[nX,1] == \"PIS\"\r\n\t\t\t\tcString += \"PIS: \"+ConvType(aRet[nX,3],15,2)+ \"  \"\r\n\t\t\tCase aRet[nX,1] == \"COFINS\"\r\n\t\t\t\tcString += \t\"COFINS: \" + ConvType(aRet[nX,3],15,2) + \"  \"\r\n\t\t\tCase aRet[nX,1] == \"CSLL\"\r\n\t\t\t\tcString += \"CSLL: \" + ConvType(aRet[nX,3],15,2) + \"  \"\r\n\t\t\tCase aRet[nX,1] == \"IRRF\"\r\n\t\t\t\tcString += \"IR: \" + ConvType(aRet[nX,3],15,2) + \"  \"\r\n\t\t\tCase aRet[nX,1] == \"INSS\"\r\n\t\t\t\tcString += \"INSS: \" + ConvType(aRet[nX,3],15,2) \r\n\t\tEndCase\r\n\tNext\r\nEndIf \r\n\r\nIf nIPIConsig > 0\r\n\tcString += \"Valor do IPI: R$ \" + AllTrim(Transform(nIPIConsig, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf \r\nIf nSTConsig > 0\r\n\tcString += \"Valor do ICMS ST: R$ \" + AllTrim(Transform(nSTConsig, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nendIf\t\r\nIf nValIpiBene > 0 // Quando lIpiBenef = T leva IPI em vOutro e Inf. Adic.\r\n\tcString += \"Valor do IPI: R$ \" + AllTrim(Transform(nValIpiBene, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf\r\n\r\nIf nTotCrdP > 0 // valor de crédito Presumido -  Art.75, XXXII do RICMS/MG\r\n\tcString += \"Valor de crédito Presumido: R$ \" + AllTrim(Transform(nTotCrdP, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf\r\n\r\n// Valor dos tributos por Ente Tributante\r\nIf lMvEnteTrb\r\n\r\n\tIf cMvMsgTrib $ \"1-3\" .And. cTpCliente == \"F\" .And. ( ( nTotFedCrg + nTotEstCrg + nTotMunCrg ) > 0 )\r\n\r\n\t\tcString\t\t+= 'Valor Aproximado do(s) Tributo(s): '\r\n\r\n\t\tIf nTotFedCrg > 0\r\n\t\t\tcPercTrib\t:= PercTrib( Nil , .F., \"1\" )\r\n\t\t\tcString\t\t+= 'R$ ' + ConvType( nTotFedCrg, 15, 2 ) + \" (\"+cPercTrib+\"%) Federal\"\r\n\t\tEndIf\r\n\t\r\n\t\tIf nTotEstCrg > 0\r\n\t\t\tcPercTrib\t:= PercTrib( Nil , .F., \"2\" )\r\n\t\t\tIf nTotFedCrg > 0\r\n\t\t\t\tcString\t+= ' e '\r\n\t\t\tEndif\r\n\t\t\tcString\t\t+= 'R$ ' + ConvType( nTotEstCrg, 15, 2 ) + \" (\"+cPercTrib+\"%) Estadual\"\r\n\t\tEndIf\r\n\t\r\n\t\tIf nTotMunCrg > 0\r\n\t\t\tcPercTrib\t:= PercTrib( Nil , .F., \"3\" )\r\n\t\t\tIf ( nTotFedCrg + nTotEstCrg ) > 0\r\n\t\t\t\tcString\t+= ' e '\r\n\t\t\tEndif\r\n\t\t\tcString\t\t+= 'R$ ' + ConvType( nTotMunCrg, 15, 2 ) + \" (\"+cPercTrib+\"%) Municipal.\"\r\n\t\tEndIf\r\n\t                             \r\n\t\tIf !Empty( cFntCtrb )\r\n\t\t\tIf ( nTotFedCrg + nTotEstCrg + nTotMunCrg ) > 0\r\n\t\t\t\tcString += \" \"\r\n\t\t\tEndif\r\n\t\t\tcString += \"Fonte: \" + cFntCtrb + \".\"\r\n\t\tEndif\r\n\r\n\tEndif\r\n\t\t\r\nElse\r\n\r\n\tIf cMvMsgTrib $ \"1-3\" .And. nTotalCrg > 0 .And. cTpCliente == \"F\"\r\n\t\tlProdItem := .F.\r\n\t\tcPercTrib := PercTrib( nil , lProdItem)   \r\n\t\t\r\n\t\tIf !Empty(cFntCtrb)\r\n\t\t\tcString += 'Valor Aproximado dos Tributos: R$ ' +ConvType(nTotalCrg,15,2)+ \" (\"+cPercTrib+\"%). Fonte: \"+cFntCtrb+\".\"\r\n\t\tElse\r\n\t\t\tcString += 'Valor Aproximado dos Tributos: R$ ' +ConvType(nTotalCrg,15,2)+ \" (\"+cPercTrib+\"%).\"\r\n\t\tEndIf \r\n\tEndIf\r\n\r\nEndif\r\n\r\n//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças - TRGTM2\r\nIf lCustoEntr\r\n\tcString += \"ICMS apurado nos termos do Decreto nº 35.679, de 13 de Outubro de 2010.\"\r\nEndIf\r\n\r\n//Tratamento para adcionar o valor do ICMS desonerado para informação complementar da Danfe.\r\nIf nVicmsDeson >0\r\n\tcString += \"Valor do ICMS Desonerado: R$ \" + AllTrim(Transform(nVicmsDeson, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf\r\nIf nvFCPUFDest > 0 .or.  nvICMSUFDest > 0 .or. nvICMSUFRemet > 0 .or. nvBCUFDest  > 0     \r\n \tIF (IIF(!(GetNewPar(\"MV_SPEDEND\",.F.)),ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"BA\" )   \r\n    cString +=\"Valor da BC do ICMS na UF de destino: R$ \"+ConvType(nvBCUFDest,15,2)+\". \"  \r\n \t\tcString +=\"Percentual do ICMS relativo ao Fundo de Combate a Pobreza - FCP na UF de destino: \"+ConvType(npFCPUFDest)+\"%. \"     //2  pFCPUFDest     nao\r\n \t\tcString +=\"Alíquota interna da UF de destino:  \"+ConvType(npICMSUFDest)+\"%. \"                                                  //3  pICMSUFDest    nao\r\n \t\tcString +=\"Alíquota interestadual das UF envolvidas: \"+cMensDifal+ \". \"\r\n \t\tcString +=\"Percentual provisório de partilha do ICMS Interestadual: \" +ConvType(npICMSIntP)+\"%. \"\r\n \tEndIf                                                                                                                             \t //5  pICMSInterPart nao\r\n \t\tcString +=\"Valor do ICMS relativo ao Fundo de Combate a Pobreza - FCP da UF de destino: R$ \"+ConvType(nvFCPUFDest,15,2)+\". \"       //6  vFCPUFDest\r\n \t\tcString +=\"Valor do ICMS Interestadual para a UF de destino: R$ \"+ConvType(nvICMSUFDest,15,2)+\". \"                                 //7  vICMSUFDest\r\n \t\tcString +=\"Valor do ICMS Interestadual para a UF do remetente: R$ \"+ConvType(nvICMSUFRemet,15,2)+\".\"                               //8  vICMSUFRemet\r\nEndIf \r\n\t\r\ncString:=If(Substr(cString,Len(cString)-1,1) $ \",\",Substr(cString,1,Len(cString)-2),cString)\r\ncString += '</Cpl>' \r\nIf !Empty(AllTrim(cAnfavea))\r\n\tcString += \"<AnfaveaCPL>\" + cAnfavea + \"</AnfaveaCPL>\"\r\nEndIf\r\n\r\nFor nX := 1 To Len(aObsCont)\r\n\tcString += '<obsCont>'\r\n\tcString += '<xCampo>'+Substr(aObsCont[nX][1], 1, 20)+ '</xCampo>'\r\n\tcString += '<xTexto>'+Substr(aObsCont[nX][2], 1, 60)+ '</xTexto>'\r\n\tcString += '</obsCont>'\t\r\nNext nX\r\n\r\n//Processo referenciado\r\nFor nX := 1 To Len(aProcRef)\r\n\tcString += '<procRef>'\r\n\tcString += '<nProc>'+aProcRef[nX][1]+ '</nProc>'\r\n\tcString += '<indProc>'+aProcRef[nX][2]+ '</indProc>'\r\n\tcString += '</procRef>'\t\r\nNext nX\r\n\r\ncString += '</infAdic>'\r\n       \r\n// Tratamento TAG Exportação integração com EEC Average \r\nIf Len(aExp)>0 .And. !Empty(aExp[01])\r\n\tIf lEECFAT\r\n\t/*Se versão 2.00 considera o retorno das posições 1 e 2\r\n\t\tSe versão 3.10, considera array da posição 4 do primeiro item\r\n\t*/\r\n\t\tIf cVerAmb == \"2.00\"\r\n\t\t\tcString += '<exporta>'\r\n\t\t\tcString += '<UFEmbarq>'+ConvType(aExp[01][01][03])+ '</UFEmbarq>'\r\n\t\t\tcString += '<locembarq>'+ConvType(aExp[01][02][03])+ '</locembarq>'\r\n\t\t\tcString += '</exporta>'\t\r\n\t\tEndIf\r\n\t\tIf ( cTipo == \"1\") //Somente se nota de saída ou devolução.\r\n\t\t\tIf !Empty(aExp[01][04][03])\r\n\t\t\t\tcString += '<exporta>'\r\n\t\t\t\tcString += '<UFEmbarq>'+ConvType(aExp[01][04][03][01][03])+ '</UFEmbarq>'\r\n\t\t\t\tcString += '<locembarq>'+ConvType(aExp[01][04][03][02][03])+ '</locembarq>'\t\t\t\t\r\n\t\t\t\tcString += NfeTag('<locdespacho>' ,ConvType(aExp[01][04][03][03][03]))\r\n\t\t\t\tcString += '</exporta>'\r\n\t\t\tEndIf\r\n\t\tEndIf\t\t\r\n\tElseIf ( cTipo == \"1\") \r\n\t\tcString += '<exporta>'\r\n\t\tcString += '<UFEmbarq>'+ConvType(aExp[01][01][01][03])+ '</UFEmbarq>'\r\n\t\tcString += '<locembarq>'+ConvType(aExp[01][01][02][03])+ '</locembarq>'\r\n\t\tIf cVerAmb >= \"3.10\" .And. !Empty(aExp[01][01][07][03])\r\n\t\t\tcString += NfeTag('<locdespacho>' ,ConvType(aExp[01][01][07][03]))\r\n\t\tEndIf\r\n\t\tcString += '</exporta>'\t\r\n\tEndIf\r\nEndIf\r\n\r\nIf Len(aPedido)>0\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tIf !Empty(aPedido[01]) .or. !Empty(aPedido[02]) .or. !Empty(aPedido[03])\r\n\t\t\tcString += '<compra>'\r\n\t\t\tcString += NfeTag('<nEmp>',aPedido[01])\r\n\t\t\tcString += NfeTag('<Pedido>',aPedido[02])\r\n\t\t\tcString += NfeTag('<Contrato>',aPedido[03])\r\n\t\t\tcString += '</compra>'\r\n\t\tEndIf\r\n\tElse\r\n\t\tcString += '<compra>'\r\n\t\tcString += '<nEmp>'+aPedido[01]+'</nEmp>'\r\n\t\tcString += '<Pedido>'+aPedido[02]+'</Pedido>'\r\n\t\tcString += '<Contrato>'+aPedido[03]+'</Contrato>'\r\n\t\tcString += '</compra>'\r\n\tEndIf\r\nEndIf\t\r\n\r\naSize(aInfoDest,0)\r\naInfoDest := Nil\r\naSize(aDadosDest,0)\r\naDadosDest := Nil\r\n\r\nReturn(cString)\r\n\r\nStatic Function ConvType(xValor,nTam,nDec)\r\n\r\nLocal cNovo := \"\"\r\nDEFAULT nDec := 0\r\nDo Case\r\n\tCase ValType(xValor)==\"N\"\r\n\t\tIf xValor <> 0\r\n\t\t\tcNovo := AllTrim(Str(xValor,nTam,nDec))\t\r\n\t\tElse\r\n\t\t\tcNovo := \"0\"\r\n\t\tEndIf\r\n\tCase ValType(xValor)==\"D\"\r\n\t\tcNovo := FsDateConv(xValor,\"YYYYMMDD\")\r\n\t\tcNovo := SubStr(cNovo,1,4)+\"-\"+SubStr(cNovo,5,2)+\"-\"+SubStr(cNovo,7)\r\n\tCase ValType(xValor)==\"C\"\r\n\t\tIf nTam==Nil\r\n\t\t\txValor := AllTrim(xValor)\r\n\t\tEndIf\r\n\t\tDEFAULT nTam := 60\r\n\t\tcNovo := AllTrim(NoAcento(SubStr(xValor,1,nTam)))\r\nEndCase\r\nReturn(cNovo)\r\n\r\nStatic Function Inverte(uCpo, nDig)\r\nLocal cRet\t:= \"\"\r\nDefault nDig := 9\r\n/*\r\nLocal cCpo\t:= uCpo\r\nLocal cByte\t:= \"\"\r\nLocal nAsc\t:= 0\r\nLocal nI\t\t:= 0\r\nLocal aChar\t:= {}\r\nLocal nDiv\t:= 0\r\n*/\r\ncRet\t:=\tGCifra(Val(uCpo),nDig)\r\n/*\r\nAadd(aChar,\t{\"0\", \"9\"})\r\nAadd(aChar,\t{\"1\", \"8\"})\r\nAadd(aChar,\t{\"2\", \"7\"})\r\nAadd(aChar,\t{\"3\", \"6\"})\r\nAadd(aChar,\t{\"4\", \"5\"})\r\nAadd(aChar,\t{\"5\", \"4\"})\r\nAadd(aChar,\t{\"6\", \"3\"})\r\nAadd(aChar,\t{\"7\", \"2\"})\r\nAadd(aChar,\t{\"8\", \"1\"})\r\nAadd(aChar,\t{\"9\", \"0\"})\r\n\r\nFor nI:= 1 to Len(cCpo)\r\n   cByte := Upper(Subs(cCpo,nI,1))\r\n   If (Asc(cByte) >= 48 .And. Asc(cByte) <= 57) .Or. ;\t// 0 a 9\r\n   \t\t(Asc(cByte) >= 65 .And. Asc(cByte) <= 90) .Or. ;\t// A a Z\r\n   \t\tEmpty(cByte)\t// \" \"\r\n\t   nAsc\t:= Ascan(aChar,{|x| x[1] == cByte})\r\n   \tIf nAsc > 0\r\n   \t\tcRet := cRet + aChar[nAsc,2]\t// Funcao Inverte e chamada pelo rdmake de conversao\r\n\t   EndIf\r\n\tElse\r\n\t\t// Caracteres <> letras e numeros: mantem o caracter\r\n\t\tcRet := cRet + cByte\r\n\tEndIf\r\nNext\r\n*/\r\nReturn(cRet)\r\n\r\nStatic Function NfeTag(cTag,cConteudo)\r\n\r\nLocal cRetorno := \"\"\r\nIf (!Empty(AllTrim(cConteudo)) .And. IsAlpha(AllTrim(cConteudo))) .Or. Val(AllTrim(cConteudo))<>0\r\n\tcRetorno := cTag+AllTrim(cConteudo)+SubStr(cTag,1,1)+\"/\"+SubStr(cTag,2)\r\nEndIf\r\nReturn(cRetorno)\r\n\r\nStatic Function VldIE(cInsc,lContr,lIsent)\r\n\r\nLocal cRet\t:=\t\"\"\r\nLocal nI\t:=\t1\r\nDEFAULT lContr  :=      .T.\r\nDEFAULT lIsent  :=      .T.\r\nFor nI:=1 To Len(cInsc)\r\n\tIf Isdigit(Subs(cInsc,nI,1)) .Or. IsAlpha(Subs(cInsc,nI,1))\r\n\t\tcRet+=Subs(cInsc,nI,1)\r\n\tEndif\r\nNext\r\ncRet := AllTrim(cRet)\r\nIf \"ISENT\"$Upper(cRet)\r\n\tcRet := \"\"\r\nEndIf\r\nIf lContr .And. Empty(cRet) .And. lIsent\r\n\tcRet := \"ISENTO\"\r\nEndIf\r\nIf !lContr\r\n\tcRet := \"\"\r\nEndIf\r\nReturn(cRet)\r\n\r\n\r\nstatic FUNCTION NoAcento(cString)\r\nLocal cChar  := \"\"\r\nLocal nX     := 0 \r\nLocal nY     := 0\r\nLocal cVogal := \"aeiouAEIOU\"\r\nLocal cAgudo := \"áéíóú\"+\"ÁÉÍÓÚ\"\r\nLocal cCircu := \"âêîôû\"+\"ÂÊÎÔÛ\"\r\nLocal cTrema := \"äëïöü\"+\"ÄËÏÖÜ\"\r\nLocal cCrase := \"àèìòù\"+\"ÀÈÌÒÙ\" \r\nLocal cTio   := \"ãõÃÕ\"\r\nLocal cCecid := \"çÇ\"\r\nLocal cMaior := \"&lt;\"\r\nLocal cMenor := \"&gt;\"\r\n\r\nFor nX:= 1 To Len(cString)\r\n\tcChar:=SubStr(cString, nX, 1)\r\n\tIF cChar$cAgudo+cCircu+cTrema+cCecid+cTio+cCrase\r\n\t\tnY:= At(cChar,cAgudo)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\r\n\t\tnY:= At(cChar,cCircu)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\r\n\t\tnY:= At(cChar,cTrema)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\r\n\t\tnY:= At(cChar,cCrase)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\t\t\r\n\t\tnY:= At(cChar,cTio)\r\n\t\tIf nY > 0          \r\n\t\t\tcString := StrTran(cString,cChar,SubStr(\"aoAO\",nY,1))\r\n\t\tEndIf\t\t\r\n\t\tnY:= At(cChar,cCecid)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(\"cC\",nY,1))\r\n\t\tEndIf\r\n\tEndif\r\nNext\r\n\r\nIf cMaior$ cString \r\n\tcString := strTran( cString, cMaior, \"\" ) \r\nEndIf\r\nIf cMenor$ cString \r\n\tcString := strTran( cString, cMenor, \"\" )\r\nEndIf\r\n\r\ncString := StrTran( cString, CRLF, \" \" )\r\n\r\nReturn cString\r\n\r\n/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³MyGetEnd  ³ Autor ³ Liber De Esteban             ³ Data ³ 19/03/09 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Verifica se o participante e do DF, ou se tem um tipo de endereco ³±±\r\n±±³          ³ que nao se enquadra na regra padrao de preenchimento de endereco  ³±±\r\n±±³          ³ por exemplo: Enderecos de Area Rural (essa verificção e feita     ³±±\r\n±±³          ³ atraves do campo ENDNOT).                                         ³±±\r\n±±³          ³ Caso seja do DF, ou ENDNOT = 'S', somente ira retornar o campo    ³±±\r\n±±³          ³ Endereco (sem numero ou complemento). Caso contrario ira retornar ³±±\r\n±±³          ³ o padrao do FisGetEnd                                             ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Obs.     ³ Esta funcao so pode ser usada quando ha um posicionamento de      ³±±\r\n±±³          ³ registro, pois será verificado o ENDNOT do registro corrente      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ SIGAFIS                                                           ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/\r\nStatic Function MyGetEnd(cEndereco,cAlias)\r\n\r\nLocal cCmpEndN\t:= SubStr(cAlias,2,2)+\"_ENDNOT\"\r\nLocal cCmpEst\t:= SubStr(cAlias,2,2)+\"_EST\"\r\nLocal aRet\t\t:= {\"\",0,\"\",\"\"}\r\n\r\n//Campo ENDNOT indica que endereco participante mao esta no formato <logradouro>, <numero> <complemento>\r\n//Se tiver com 'S' somente o campo de logradouro sera atualizado (numero sera SN)\r\nIf (&(cAlias+\"->\"+cCmpEst) == \"DF\") .Or. ((cAlias)->(FieldPos(cCmpEndN)) > 0 .And. &(cAlias+\"->\"+cCmpEndN) == \"1\")\r\n\taRet[1] := cEndereco\r\n\taRet[3] := \"SN\"\r\nElse\r\n\taRet := FisGetEnd(cEndereco, (&(cAlias+\"->\"+cCmpEst)))\r\nEndIf\r\n\r\nReturn aRet\r\n\r\n\r\nStatic Function NFSeIde(aNotaServ,cNatOper,cTipoRPS,cModXml)\r\nLocal cString  := \"\"\r\nLocal cRegTrib := \"\"\r\nLocal cOptSimp := \"\"\r\nLocal cIncCult := \"\"\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString += '<InfRps>'\r\n\tcString += '<IdentificacaoRps>'\r\n\tcString += '<Numero>'+ConvType(Val(aNotaServ[02]),15)+'</Numero>'\r\n\tcString += '<Serie>'+AllTrim(aNotaServ[01])+'</Serie>'             \r\n\tcString += '<Tipo>'+cTipoRPS+'</Tipo>'\r\n\tcString += '</IdentificacaoRps>' \r\n\tcString += '<DataEmissao>'+ConvType(aNotaServ[03])+\"T\"+Time()+'</DataEmissao>'\r\n\tcString += '<NaturezaOperacao>'+cNatOper+'</NaturezaOperacao>'\r\n\tcString += '<RegimeEspecialTributacao>'+cRegTrib+'</RegimeEspecialTributacao>'\r\n\tcString += '<OptanteSimplesNacional>'+cOptSimp+'</OptanteSimplesNacional>'\r\n\tcString += '<IncentivadorCultural>'+cIncCult+'</IncentivadorCultural>'\r\n\tcString += '<Status>'+\"1\"+'</Status>'\r\n\t//cString += '<RpsSubstituido>'\r\n\t//cString += '<Numero>'+ConvType(Val(aNotaServ[02]),15)+'</Numero>'\r\n\t//cString += '<Serie>'+AllTrim(aNotaServ[01])+'</Serie>'             \r\n\t//cString += '<Tipo>'+cTipoRPS+'</Tipo>'\r\n\t//cString += '</RpsSubstituido>' \r\n\t\r\nElse//ISSNET\r\n\tcString += '<tc:InfRps>'\r\n\tcString += '<tc:IdentificacaoRps>'\r\n\tcString += '<tc:Numero>'+ConvType(Val(aNotaServ[02]),15)+'</tc:Numero>'\r\n\t//cString += '<tc:Serie>'+'8'+'</tc:Serie>'             \r\n\tcString += '<tc:Serie>'+AllTrim(aNotaServ[01])+'</tc:Serie>'             \r\n\tcString += '<tc:Tipo>'+cTipoRPS+'</tc:Tipo>'\r\n\tcString += '</tc:IdentificacaoRps>' \r\n\tcString += '<tc:DataEmissao>'+ConvType(aNotaServ[03])+\"T\"+Time()+'</tc:DataEmissao>'\r\n\tcString += '<tc:NaturezaOperacao>'+cNatOper+'</tc:NaturezaOperacao>'\r\n\tcString += '<tc:RegimeEspecialTributacao>'+cRegTrib+'</tc:RegimeEspecialTributacao>'\r\n\tcString += '<tc:OptanteSimplesNacional>'+cOptSimp+'</tc:OptanteSimplesNacional>'\r\n\tcString += '<tc:IncentivadorCultural>'+cIncCult+'</tc:IncentivadorCultural>'\r\n\tcString += '<tc:Status>'+\"1\"+'</tc:Status>'\r\n\t//cString += '<tc:RpsSubstituido>'\r\n\t//cString += '<tc:Numero>'+ConvType(Val(aNotaServ[02]),15)+'</tc:Numero>'\r\n\t//cString += '<tc:Serie>'+AllTrim(aNotaServ[01])+'</tc:Serie>'             \r\n\t//cString += '<tc:Tipo>'+cTipoRPS+'</tc:Tipo>'\r\n\t//cString += '</tc:RpsSubstituido>' \r\nEndIf\r\nReturn( cString )\r\n\r\nStatic Function NFSeServ(aISSQN,aRet,nDed,nIssRet,cRetIss,cServ,cMunPres,cModXml,cTpPessoa)\r\nLocal cString    := \"\"\r\nLocal nBase      := 0\r\nLocal nValLiq    := 0\r\nLocal nOutRet    := 0\r\n\r\n//Base de Cálculo \r\nnBase      := aISSQN[02]-nDed-aISSQN[06]\r\n//Valor Líquido\r\nIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\"  // Tratamento realizado para o municipio de Belo Horizonte- MG quando o Tomador for Órgão Público\r\n\tnValLiq    := aISSQN[02]-aRet[06]-aISSQN[06]-aISSQN[05]\r\nElse\r\n\tnValLiq    := aISSQN[02]-aRet[06]-aISSQN[06]\r\nEndIf\r\n//Outras retenções\r\nnOutRet    := aRet[06]-aRet[05]-aRet[04]-aRet[03]-aRet[02]-aRet[01]\r\n\r\nIf nOutRet > 0\r\n\tnOutRet:= nOutRet-nIssRet\r\nEndIf\r\n\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString += '<Servico>'\r\n\tcString += '<Valores>'\r\n\tcString += '<ValorServicos>'+ConvType(aISSQN[02],15,2)+'</ValorServicos>'\r\n\tcString += NfeTag('<ValorDeducoes>',ConvType(nDed,15,2))\r\n\tcString += NfeTag('<ValorPis>',ConvType(aRet[03],15,2))\r\n\tcString += NfeTag('<ValorCofins>',ConvType(aRet[04],15,2))\r\n\tcString += NfeTag('<ValorInss>',ConvType(aRet[05],15,2))\r\n\tcString += NfeTag('<ValorIr>',ConvType(aRet[01],15,2))\r\n\tcString += NfeTag('<ValorCsll>',ConvType(aRet[02],15,2))\r\n\tcString += '<IssRetido>'+cRetIss+'</IssRetido>'\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\"\r\n\t\tcString += NfeTag('<ValorIss>0.00</ValorIss>') \r\n\tElse\r\n\t\tcString += NfeTag('<ValorIss>',ConvType((aISSQN[05]),15,2)) \r\n\tEndIf\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\" \r\n\t\tcString += NfeTag('<ValorIssRetido>0.00</ValorIssRetido>') \r\n\tElse\r\n\t\tcString += NfeTag('<ValorIssRetido>',ConvType(nIssRet,15,2)) \r\n\tEndIf\r\n\tcString += NfeTag('<OutrasRetencoes>',ConvType(nOutRet,15,2))\r\n\tcString += '<BaseCalculo>'+ConvType(nBase,15,2)+'</BaseCalculo>'\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\" \r\n\t\tcString += NfeTag('<Aliquota>0.00</Aliquota>')\r\n\tElse\r\n\t\tcString += NfeTag('<Aliquota>',ConvType(aISSQN[04],5,2))\r\n\tEndIf\r\n\tcString += NfeTag('<ValorLiquidoNfse>',ConvType(nValLiq,15,2))\r\n\tcString += NfeTag('<DescontoIncondicionado>',ConvType((aISSQN[06]),15,2))\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\" \r\n\t\tcString += NfeTag('<DescontoCondicionado>',ConvType((aISSQN[05]),15,2))\r\n\tEndIf\r\n\t//cString += '<DescontoCondicionado>'++'</DescontoCondicionado>'\r\n\tcString += '</Valores>'\r\n\t//cString += '<ItemListaServico>'+ConvType(StrTran(aISSQN[01],\".\",\"\"),4)+'</ItemListaServico>'\r\n\tcString += '<ItemListaServico>'+ConvType(aISSQN[01],5)+'</ItemListaServico>'\r\n\tcString += NfeTag('<CodigoCnae>',ConvType(aISSQN[03],7))\r\n\t//cString += '<CodigoTributacaoMunicipio>'+'710'+'</CodigoTributacaoMunicipio>'\r\n\tcString += '<CodigoTributacaoMunicipio>'+ConvType(aISSQN[07],20)+'</CodigoTributacaoMunicipio>'\r\n\tcString += '<Discriminacao>'+ConvType(cServ,2000)+'</Discriminacao>'\r\n\tcString += '<CodigoMunicipio>'+ConvType(cMunPres,7)+'</CodigoMunicipio>'\r\n\tcString += '</Servico>'\r\n\t\r\nElse //ISSNET\r\n\tcString += '<tc:Servico>'\r\n\tcString += '<tc:Valores>'\r\n\tcString += '<tc:ValorServicos>'+ConvType(aISSQN[02],15,2)+'</tc:ValorServicos>'\r\n\tcString += NfeTag('<tc:ValorDeducoes>',ConvType(nDed,15,2))\r\n\tcString += NfeTag('<tc:ValorPis>',ConvType(aRet[03],15,2))\r\n\tcString += NfeTag('<tc:ValorCofins>',ConvType(aRet[04],15,2))\r\n\tcString += NfeTag('<tc:ValorInss>',ConvType(aRet[05],15,2))\r\n\tcString += NfeTag('<tc:ValorIr>',ConvType(aRet[01],15,2))\r\n\tcString += NfeTag('<tc:ValorCsll>',ConvType(aRet[02],15,2))\r\n\tcString += '<tc:IssRetido>'+cRetIss+'</tc:IssRetido>'\r\n\tIf aISSQN[05] > 0\r\n\t\tcString += NfeTag('<tc:ValorIss>',ConvType((aISSQN[05]),15,2))\r\n\tElse\r\n\t\tcString += '<tc:ValorIss>0.00</tc:ValorIss>'\r\n\tEndIf\t\t\r\n\tcString += NfeTag('<tc:ValorIssRetido>',ConvType(nIssRet,15,2))\r\n\tcString += NfeTag('<tc:OutrasRetencoes>',ConvType(nOutRet,15,2))\r\n\tcString += '<tc:BaseCalculo>'+ConvType(nBase,15,2)+'</tc:BaseCalculo>'\r\n\tIf  aISSQN[04] > 0\t\r\n\t\tcString += NfeTag('<tc:Aliquota>',ConvType(aISSQN[04],5,2))\r\n\telse\r\n\t\tcString += '<tc:Aliquota>0.00</tc:Aliquota>'\r\n\tendif\t\t\r\n\tcString += NfeTag('<tc:ValorLiquidoNfse>',ConvType(nValLiq,15,2))\r\n\tcString += '<tc:DescontoIncondicionado>'+ConvType((aISSQN[06]),15,2)+'</tc:DescontoIncondicionado>'\r\n\tcString += '<tc:DescontoCondicionado>0</tc:DescontoCondicionado>'\r\n\tcString += '</tc:Valores>'\r\n\t//cString += '<tc:ItemListaServico>'+ConvType(StrTran(aISSQN[01],\".\",\"\"),4)+'</tc:ItemListaServico>'\r\n\tcString += '<tc:ItemListaServico>'+ConvType(aISSQN[01],4)+'</tc:ItemListaServico>'\r\n\tcString += NfeTag('<tc:CodigoCnae>',ConvType(aISSQN[03],7))\r\n\t//cString += '<tc:CodigoTributacaoMunicipio>'+'710'+'</tc:CodigoTributacaoMunicipio>'\r\n\tcString += '<tc:CodigoTributacaoMunicipio>'+ConvType(aISSQN[07],20)+'</tc:CodigoTributacaoMunicipio>'\r\n\tcString += '<tc:Discriminacao>'+ConvType(cServ,2000)+'</tc:Discriminacao>'\r\n\tcString += '<tc:MunicipioPrestacaoServico>'+Iif(Len(cMunPres) == 9,substr(cMunPres,3,7),ConvType(cMunPres,7))+'</tc:MunicipioPrestacaoServico>'\r\n\t//cString += '<tc:MunicipioPrestacaoServico>999</tc:MunicipioPrestacaoServico>'\r\n\tcString += '</tc:Servico>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NFSePrest(cModXml)\r\nLocal cString    := \"\"\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString +='<Prestador>'\r\n\tcString += '<Cnpj>'+SM0->M0_CGC+'</Cnpj>'\r\n\tcString += NfeTag('<InscricaoMunicipal>',ConvType(SM0->M0_INSCM))\r\n\tcString +='</Prestador>'\r\nElse //ISSNET\r\n\tcString +='<tc:Prestador>'\r\n\tcString +='<tc:CpfCnpj>'\r\n\tcString += '<tc:Cnpj>'+SM0->M0_CGC+'</tc:Cnpj>'\r\n\tcString +='</tc:CpfCnpj>'\r\n\tcString += NfeTag('<tc:InscricaoMunicipal>',ConvType(SM0->M0_INSCM))\r\n\tcString +='</tc:Prestador>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NFSeTom(aDest,cModXml,cMunPres)\r\nLocal cCPFCNPJ :=\"\"\r\nLocal cInscMun :=\"\"\r\nLocal cString  :=\"\"\r\n\r\n//Identifica Tipo\r\nIf RetPessoa(AllTrim(aDest[01]))==\"J\"\r\n\tcCPFCNPJ:=\"2\"\r\nElse\r\n\tcCPFCNPJ:=\"1\"\r\nEndIf\r\n//Identifica Inscricao\r\nIf AllTrim(cMunPres)==AllTrim(SM0->M0_CODMUN)\r\n\tcInscMun:=aDest[11]\r\nEndIf\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString +='<Tomador>'\r\n\tcString +='<IdentificacaoTomador>'\r\n\t//Estrangeiro não manda a tag de CPFCNPJ\r\n\tIf !\"EX\"$aDest[08]\r\n\t\tcString +='<CpfCnpj>'\r\n\t\t\tIf \"2\"$cCPFCNPJ\r\n\t\t\t\tcString += NfeTag('<Cnpj>',ConvType(aDest[01]))\r\n\t\t\tElse\r\n\t\t\t\tcString += NfeTag('<Cpf>',ConvType(aDest[01]))\r\n\t\t\tEndIf\r\n\t\tcString +='</CpfCnpj>'\r\n\tEndIf\r\n\tcString += NfeTag('<InscricaoMunicipal>',ConvType(cInscMun))\r\n\tcString +='</IdentificacaoTomador>'\r\n\tcString += NfeTag('<RazaoSocial>',ConvType(aDest[02],115))\r\n\t\r\n\tcString +='<Endereco>'\r\n\tcString += NfeTag('<Endereco>',ConvType(aDest[03],125))\r\n\tcString += NfeTag('<Numero>',ConvType(aDest[04],10))\r\n\tcString += NfeTag('<Complemento>',ConvType(aDest[05],60))\r\n\tcString += NfeTag('<Bairro>',ConvType(aDest[06],60))\r\n\tcString += NfeTag('<CodigoMunicipio>',ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[08]})][02]+aDest[07]))\r\n\tcString += NfeTag('<Uf>',ConvType(aDest[08]))\r\n\tcString += NfeTag('<Cep>',ConvType(aDest[09]))\r\n\tcString +='</Endereco>'\r\n\t\r\n\tcString +='<Contato>'\r\n\tcString += NfeTag('<Telefone>',AllTrim(ConvType(FisGetTel(aDest[10])[3],11)))\r\n\tcString += NfeTag('<Email>',ConvType(aDest[12],80))\r\n\tcString +='</Contato>'\r\n\tcString +='</Tomador>'\r\n\t\r\n\t//cString +='<Intermediario>'\r\n\t//cString += '<RazaoSocial>'+'</RazaoSocial>'\r\n\t//cString +='<CpfCnpj>'\r\n\t//cString += '<Cpf>'+'</Cpf>'\r\n\t//cString += '<Cnpj>'+'</Cnpj>'\r\n\t//cString +='</CpfCnpj>'\r\n\t//cString += '<InscricaoMunicipal>'+'</InscricaoMunicipal>'\r\n\t//cString +='</Intermediario>'\r\n\t\r\n\t//cString +='<Construcao>'\r\n\t//cString += '<CodigoObra>'+'</CodigoObra>'\r\n\t//cString += '<Art>'+'</Art>'  \r\n\t//cString +='</Construcao>'\r\n\tcString +='</InfRps>'\r\n\t\r\nElse //ISSNET\r\n\tcString +='<tc:Tomador>'\r\n\tcString +='<tc:IdentificacaoTomador>'\r\n\tcString +='<tc:CpfCnpj>'\r\n\tif \"EX\"$aDest[08]\r\n\t    cString += NfeTag('<tc:Cnpj>','99999999999999')\r\n\tElse\r\n\t\tIf \"2\"$cCPFCNPJ\r\n\t\t\tcString += NfeTag('<tc:Cnpj>',ConvType(aDest[01]))\r\n\t\tElse\r\n\t\t\tcString += NfeTag('<tc:Cpf>',ConvType(aDest[01]))\r\n\t\tEndIf\r\n\tEndIf\r\n\tcString +='</tc:CpfCnpj>'\r\n\tcString += NfeTag('<tc:InscricaoMunicipal>',ConvType(cInscMun))\r\n\tcString +='</tc:IdentificacaoTomador>'\r\n\tcString += NfeTag('<tc:RazaoSocial>',ConvType(aDest[02],115))\r\n\t\r\n\tcString +='<tc:Endereco>'\r\n\tcString += NfeTag('<tc:Endereco>',ConvType(aDest[03],125))\r\n\tcString += NfeTag('<tc:Numero>',ConvType(aDest[04],10))\r\n\tcString += NfeTag('<tc:Complemento>',ConvType(aDest[05],60))\r\n\tcString += NfeTag('<tc:Bairro>',ConvType(aDest[06],60))\r\n\tIf \"EX\"$aDest[08]\r\n\t\tcString += NfeTag('<tc:Cidade>','99999')\r\n\tElse\r\n\t\tcString += NfeTag('<tc:Cidade>',ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[08]})][02]+aDest[07]))\r\n\tEndIf\r\n\r\n\tcString += NfeTag('<tc:Estado>',ConvType(aDest[08]))\r\n\tcString += NfeTag('<tc:Cep>',ConvType(aDest[09]))\r\n\tcString +='</tc:Endereco>'\r\n\t\r\n\tcString +='<tc:Contato>'\r\n\tcString += NfeTag('<tc:Telefone>',ConvType(aDest[10],11))\r\n\tcString += NfeTag('<tc:Email>',ConvType(aDest[12],80))\r\n\tcString +='</tc:Contato>'\r\n\tcString +='</tc:Tomador>'\r\n\t\r\n\t//cString +='<tc:Intermediario>'\r\n\t//cString += '<tc:RazaoSocial>'+'</tc:RazaoSocial>'\r\n\t//cString +='<tc:CpfCnpj>'\r\n\t//cString += '<tc:Cpf>'+'</tc:Cpf>'\r\n\t//cString += '<tc:Cnpj>'+'</tc:Cnpj>'\r\n\t//cString +='</tc:CpfCnpj>'\r\n\t//cString += '<tc:InscricaoMunicipal>'+'</tc:InscricaoMunicipal>'\r\n\t//cString +='</tc:Intermediario>'\r\n\t\r\n\t//cString +='<tc:Construcao>'\r\n\t//cString += '<tc:CodigoObra>'+'</tc:CodigoObra>'\r\n\t//cString += '<tc:Art>'+'</tc:Art>'  \r\n\t//cString +='</tc:Construcao>'\r\n\tcString +='</tc:InfRps>'\r\nEndIf\r\nReturn(cString)\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} LgxMsgNfs()\r\nFuncao que verifica os vinculos entre pedidos de venda e realiza o \r\ntratamento do texto do C5_MENNOTA quando a origem do PV é igual a 'LOGIX'\r\n\r\n@author Caio Murakami       \r\n@since 12.12.2012\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function LgxMsgNfs()\r\nLocal aAreaSC5\t:= SC5->( GetArea() )\r\nLocal aAreaSC6 := SC6->( GetArea() )\r\nLocal aArea\t\t:= GetArea()  \r\nLocal aPedVinc\t:= {} \r\nLocal nX \t\t:= 0 \r\nLocal cPedVinc\t:= \"\"  \r\nLocal cChave\t:= \"\"  \r\nLocal lAtuSC5\t:= .F. \r\nLocal cMsgNfs  := SC5->C5_MENNOTA\r\nLocal cNumPed \t:= SC5->C5_NUM \r\n\r\nIf SC6->( FieldPos(\"C6_PEDVINC\") ) > 0 .And. !Empty(SC6->C6_PEDVINC)  \r\n\t\r\n\tcPedVinc := SC6->C6_PEDVINC \r\n\t\t\r\n   SC5->( dbSetOrder(1) ) \r\n\tSC6->( dbSetOrder(1) )      \r\n\t\r\n\tIf SC5->( MsSeek( cChave := xFilial(\"SC5\") + cPedVinc ) )\t\r\n\t   \r\n\t   If SC6->( MsSeek( cChave )  )\r\n\t   \t//-- Percorre itens de pedido de venda relacionado o número do pedido com a NF , Série e Data\r\n\t   \tWhile SC6->( C6_FILIAL+C6_NUM ) == cChave .And.  !SC6->( Eof() ) \r\n\t   \t\t\r\n\t   \t\tIf !Empty(SC6->C6_NOTA)    \t\t\r\n\t   \t\t\tIf Ascan( aPedVinc, { | e | e[1]+e[2] == SC6->(C6_NOTA+C6_SERIE) } ) == 0\r\n\t\t   \t\t\tAadd( aPedVinc, { SC6->C6_NOTA , SC6->C6_SERIE , SC6->C6_DATFAT  }  ) \r\n\t\t   \t\tEndIf\r\n\t\t   \tEndIf\r\n\t\t   \t\t   \t\t\r\n\t   \t\tSC6->( dbSkip() )  \r\n\t   \t\t\r\n\t   \tEndDo\r\n\t   EndIf   \r\n\tEndIf \r\n\t//-- Atualiza mensagem do pedido, @N ( Numero da NF ) ; @S ( Série da NF) ; @D ( Data emissao )\r\n\tFor nX := 1 To Len(aPedVinc)\r\n\t\t\r\n\t\tcMsgNfs := StrTran( cMsgNfs , '@N' , aPedVinc[nX,1] \t\t \t,, 1 )\r\n\t\tcMsgNfs := StrTran( cMsgNfs , '@S' , aPedVinc[nX,2] \t\t \t,, 1 )\r\n\t\tcMsgNfs := StrTran( cMsgNfs , '@D' , dToC(aPedVinc[nX,3])\t,, 1 )\r\n\t\t\r\n\t\tIf At('@N' , cMsgNfs ) == 0\r\n\t\t\tlAtuSC5 := .T.\t \r\n\t\t\tExit\r\n\t\tEndIf\t\t\t\r\n\t\t\t   \r\n\tNext nX  \r\n\t\r\n\t//-- Atualiza C5_MENNOTA do pedido de venda posicionado inicialmente\r\n\tIf lAtuSC5 .And. SC5->( MsSeek( xFilial(\"SC5\") + cNumPed )   ) \r\n\t\tIf AllTrim(SC5->C5_MENNOTA) <> AllTrim(cMsgNfs)\r\n\t\t\tRecLock( \"SC5\" , .F. )\r\n\t\t\tSC5->C5_MENNOTA := cMsgNfs\r\n\t\t\tMsUnLock()\t\r\n\t\tEndIf\r\n\tEndIf\r\n  \r\nEndIf    \r\n \r\nRestArea( aAreaSC5 )\r\nRestArea( aAreaSC6 )\r\nRestArea( aArea    )\r\n\r\nReturn NIL  \r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} RetNfpVinc()\r\nFuncao que verifica se existe nota de NFP vinculada a Nota , e retorna o \r\narrey com as informações da nota de NFP\r\n\r\n@author Fernando Bastos       \r\n@since 03.01.2013\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function RetNfpVinc(cDocNFP,cSerieNFP,cForneceNFP,cLojaNFP)\r\n\r\nlocal nOrderSF1\t:= 0\r\nlocal nRecnoSF1\t:= 0\t\r\nlocal nOrderSD1\t:= 0\t\r\nlocal nRecnoSD1\t:= 0\r\n\r\nLocal aNfViRuNFP:={}\r\n\r\n\t// Realiza o backup do order e recno da SF1 e SD1\r\n\tnOrderSF1\t:= SF1->( indexOrd() )\r\n\tnRecnoSF1\t:= SF1->( recno() ) \r\n\t\r\n\tnOrderSD1\t:= SD1->( indexOrd() )\r\n\tnRecnoSD1\t:= SD1->( recno() )\r\n\t\t\r\n\tSD1->(dbSetOrder(1))\r\n\t\tIf SD1->(dbSeek(xFilial(\"SD1\")+SD1->D1_NFORI+SD1->D1_SERIORI))//D1_NFORI,D1_SERIORI\r\n   \t\t\t\tSF1->(dbSetOrder(1))\r\n   \t\t\t\tIf SF1->(dbSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA) .And. AllTrim(SF1->F1_ESPECIE)==\"NFP\")\r\n\t   \t\t\taadd(aNfViRuNFP,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA2->A2_CGC),; \r\n\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA2->A2_EST),; \r\n\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA2->A2_INSCR)})\t\r\n\t\t\tEndif\r\n\t\tEndif\r\n   \t// Restaura a ordem e recno da SF1 e SD1\r\n\tSF1->( dbSetOrder( nOrderSF1 ) )\r\n\tSF1->( dbGoTo( nRecnoSF1 ) )\r\n\t\t\t        \r\n\tSD1->( dbSetOrder( nOrderSD1 ) )\r\n\tSD1->( dbGoTo( nRecnoSD1 ) )\r\n\t\t\t\t\t\t\t\t\r\nReturn (aNfViRuNFP) \r\n\r\n//------------------------------------------------------------------------\r\n/*/{Protheus.doc} MsgCliRsIcm\r\nFuncao que retorna a mensagem para ser colocada nos dados adicionais da NFe,\r\nreferente ao RICMS do RIO GRANDE do SUL:\r\nLivro II , Art.29 , Inciso VII, Alinea \"a\" numero 1\r\nLivro III, Art. 26 \r\n\r\n@author Rafael Iaquinto    \r\n@since 22.05.2013\r\n@version 1.0  \r\n\r\n@param\t\taICMS\t\tArray com informações referente ao ICMS proprio\r\n@param\t\taICMSST\tArray com informações referente ao ICMS-ST\r\n\t\t\t\r\n@return\tcMsg\t\tRetorna a Mensagem a ser utilizada.\t\r\n\r\n/*/\r\n//------------------------------------------------------------------------                                                        \r\nStatic Function MsgCliRsIcm(aICMS, aICMSST)\r\n\r\nLocal cMsg \t\t:= \"\"\r\n\r\nLocal nX\t\t\t:= \"\"\r\nLocal nValIcm\t\t:= 0\r\nLocal nValST\t\t:= 0 \r\nLocal nBaseIcm\t\t:= 0\r\nLocal nBaseST\t\t:= 0\r\n\r\nLocal lIcmsST\t\t:= .F.\r\nLocal lIcms\t\t:= .F.\r\nLocal lIcmsSemSt\t:= .F.\r\n\r\nFor nX := 1 to Len( aICMS )\r\n\t\r\n\tlIcms := .F.\r\n\t\r\n\tIf Len( aICMS[nX] ) > 0 .And. aICMS[nX][07] > 0\r\n\t\t\r\n\t\tnValIcm \t+= aICMS[nX][07] \r\n\t\tnBaseIcm\t+= aICMS[nX][05]\r\n\t\t\r\n\t\tif len( aICMSSt[nX] ) > 0 .and. aICMSSt[nX][07] > 0 \r\n\t\t\tnValST\t\t+= aICMS[nX][07] \r\n\t\t\tnBaseST\t+= aICMS[nX][05]\r\n\t\tendif\r\n\t\t\r\n\t\tlIcms := .T.\r\n\t\t\t\t\r\n\tEndIf\r\n\t\r\n\tIf Len( aICMSSt[nX] ) > 0 .And. aICMSSt[nX][07] > 0 \t\t\r\n\t\t\r\n\t\tlIcmsST := .T.\r\n\t\t\t\t\t\t\r\n\tElseIf lIcms .And. !lIcmsSemSt  \r\n\t\tlIcmsSemSt := .T.\r\n\tEndIF\r\n\t \t\r\nNext nX\r\n\r\nIf lIcmsSemSt .And. lIcmsST\r\n\r\n\tcMsg += \"Operações não sujeitas a Regime de ST, \"\r\n\tcMsg += \"Base de Cálculo do ICMS próprio: R$ \" + Alltrim( Str(nBaseIcm-nBaseST, 14, 2) )+ \", \"\r\n\tcMsg += \"Valor do ICMS próprio: R$ \" + Alltrim( Str(nValIcm-nValST, 14, 2) )+ \". \"\r\n\tcMsg += \"Operações sujeitas a Regime de ST, \" \t\t\t\r\n\tcMsg += \"Base de cálculo do ICMS próprio : R$ \" + Alltrim( Str(nBaseST, 14, 2) )+ \", \"\r\n\tcMsg += \"Valor do ICMS próprio: R$ \" + Alltrim( Str(nValST, 14, 2) )+ \". \"\r\n\t\r\nEndIf\r\n\r\n\r\nreturn cMsg\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} DocDatOrig\r\nFuncao criada para retornar para a função XmlNfeSef os valores da Nota Original quando houver controle de SubLote\r\n\r\n@param\t\tcNumLote\tNúmero do SubLote.\r\n@param\t\tcLoteClt\tNúmero do lote.\r\n@param \t\tcProduto   Codigo do produto\r\n\r\n\t\t\r\n@return\tnil\r\n\r\n@author\tEduardo Silva\r\n@since\t\t22/01/2014\r\n@version\t11.8\r\n/*/\r\n//-----------------------------------------------------------------------\r\n\r\nStatic Function DocDatOrig(cNumLote,cLoteCtl,cProduto)\r\n\r\nLocal aArea\t\t := GetArea()\r\n\r\nLocal cAliasSFT\t:= GetNextAlias()\r\nLocal cCliFor\t\t:= \"\"\r\nLocal cData\t\t:= \"\"\r\nLocal cLocCQ    \t:= PADR(SuperGetMV(\"MV_CQ\"),TAMSX3(\"D7_LOCAL\")[1])  //adequo o conteudo padrão \"98\" para \"98 \"\r\nLocal cLoja\t\t:= \"\"\r\nLocal cNfiscal\t\t:= \"\"\r\nLocal cNumCQ\t\t:= \"\"\r\nLocal cNfOrig\t\t:= \"\"\r\nLocal cSeek\t\t:= \"\"        \r\nLocal cSeek1\t\t:= \"\"        \r\nLocal cSerie\t\t:= \"\"\r\nLocal cSerieOri\t:= \"\"\r\n                     \r\ndbSelectArea(\"SB8\")\r\ndbSetOrder(2)\r\nif MsSeek(xFilial(\"SB8\")+cNumLote+cLoteCtl+cProduto)      \t\t\r\n\t\t\t\t\r\n\tdbSelectArea(\"SD7\")\r\n\tSD7->(dbSetOrder(1))\r\n\tcNumCQ := PADR(SB8->B8_DOC,LEN(SD7->D7_NUMERO))\t\t\t\t\t \t\t\r\n\tif SD7->(MsSeek(SB8->B8_FILIAL+cNumCQ+cProduto+cLocCQ))      \t\t\t\t\t\r\n\t\tcNfiscal\t:= SD7->D7_DOC\r\n\t\tcSerie \t\t:= SD7->D7_SERIE \r\n\t\tcCliFor\t:= SD7->D7_FORNECE\r\n\t\tcLoja \t\t:= SD7->D7_LOJA\r\n\telse\t\t\t\r\n\t\tcNfiscal\t:= SB8->B8_DOC\r\n\t\tcSerie\t\t:= SB8->B8_SERIE\r\n\t\tcCliFor\t:= SB8->B8_CLIFOR\r\n\t\tcLoja \t\t:= SB8->B8_LOJA \t\t\t\t\t\t\t\t\t\r\n\tendif\t\t\t\t\r\n\t\r\n\tcSeek\t:= cCliFor+cLoja+cSerie+cNfiscal\t\t\r\n\tcSeek1\t:= cNfiscal+cSerie+cCliFor+cLoja+cProduto+cLoteCtl+cNumLote\r\nendif\r\n\t\t\r\nif len (cSeek)>0 \r\n\t\t\t\r\n\tBeginSql Alias cAliasSFT\r\n\t\tSELECT FT_PRODUTO,FT_EMISSAO,FT_NFISCAL,FT_SERIE,FT_BASERET,FT_ICMSRET\r\n\t\t\tFROM %Table:SFT% SFT\r\n\t\t\tWHERE\r\n\t\t\tSFT.FT_FILIAL = %xFilial:SFT% AND\r\n\t\t\tSFT.%NotDel% AND \r\n\t\t\tFT_NFISCAL\t=%Exp:cNfiscal% AND\r\n\t\t\tFT_SERIE  \t=%Exp:cSerie% AND\r\n\t\t\tFT_TIPOMOV\t=%Exp:\"E\" % AND\r\n\t\t\tFT_CLIEFOR\t=%Exp:cCliFor% AND\r\n\t\t\tFT_LOJA\t=%Exp:cLoja% AND\r\n\t\t\tFT_ITEM\t=%Exp:SD1->D1_ITEM% AND \t\t\t\t\t\t\r\n\t\t\tFT_PRODUTO\t=%Exp:cProduto%\r\n\tEndSql\r\n\t\t\r\n\tif (cAliasSFT)->(!Eof()) \r\n\t\tcData \t\t:= (cAliasSFT)->FT_EMISSAO\r\n\t\tcNfOrig\t:= (cAliasSFT)->FT_NFISCAL\r\n\t\tcSerieOri\t:= (cAliasSFT)->FT_SERIE\t\r\n\tendif\r\n\t\t\r\n\t(cAliasSFT)->(DBCLOSEAREA())\r\n\t\r\nendif\r\n\r\nRestArea(aArea)\r\nReturn({dtoc(stod(cData)),cNfOrig,cSerieOri})\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} PercTrib\r\nRetorna a porcentagem a ser impresso no DANFE para a Lei Transparencia (Lei 12.741)\r\n\r\n\r\n@param\taProd\t\tContendo as informacoes do(s) produto(s).\r\n@param\tlProdItem\tIdentifica se a mensagem da Lei da Transparencia sera gerado\r\n\t\t\t\t\tno Produto e/ou informacoes complementares.\r\n@param\tcEnte\t\tEnte Tributante: 1-Federal / 2-Estadual / 3-Municipal\r\n@param  aNota\t\tContendo as informacoes da nota.\r\n\r\n@return cPercTrib Porcentagem do Tributo\r\n\r\n@author Douglas Parreja\r\n@since 26/06/2014\r\n@version 12\r\n/*/\r\n//-----------------------------------------------------------------------\r\n\r\nStatic Function PercTrib( aProd, lProdItem, cEnte, aNota ) \r\n\r\nLocal aArea\t\t\t:= GetArea()\r\nLocal aAreaSB1\t\t:= SB1->( GetArea() )\r\n\r\n//Local nAliquota\t\t:= 0\r\n//Local nTributo\t\t:= 0\r\n//Local nTotTrib\t\t:= 0\r\nLocal cPercTrib\t\t:= \"\"\r\nLocal nPos\t\t\t:= 30\r\nLocal nTotCargaTrib\t:= nTotalCrg\r\nLocal nAliq\t\t\t:= 0\r\n\r\nDefault aProd \t\t:= {}            \r\nDefault lProdItem \t:= .F.\r\nDefault cEnte\t\t:= \"\"\r\nDefault aNota\t\t:= {}\r\n\r\nIf lMvEnteTrb .And. ( cEnte $ \"1-2-3\" )\r\n\t\r\n\tIf cEnte == \"1\"\t// FEDERAL\r\n\r\n\t\tnPos \t\t\t:= 35\r\n\t\tnTotCargaTrib\t:= nTotFedCrg\r\n\r\n\tElseIf cEnte == \"2\"\t// ESTADUAL\r\n\r\n\t\tnPos\t\t\t:= 36\r\n\t\tnTotCargaTrib\t:= nTotEstCrg\r\n\r\n\tElse\r\n\r\n\t\tnPos \t\t\t:= 37\r\n\t\tnTotCargaTrib\t:= nTotMunCrg\r\n\r\n\tEndif\r\n\t\r\nEndif\r\n\r\nIf lProdItem\r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1) // B1_FILIAL+B1_COD\r\n\t\r\n\tIf dbSeek( xFilial(\"SB1\") + AllTrim( aProd[2] ) )\r\n\t\r\n\t\tnAliq\t:= LeiTransp(nPos,aProd, aNota)\r\n\t\tcPercTrib := ConvType( nAliq * 100 , 15, 2 )\r\n\t\t\r\n\t /*\t\r\n\txRetVal := AlqLei2741(aProd[5],aProd[6],SB1->B1_CODISS,SA1->A1_EST,SA1->A1_COD_MUN,aProd[2],aProd[1],SD2->D2_NUMLOTE,SD2->D2_LOTECTL,cMvFisCTrb,cMvFisAlCT,lMvFisFRas)\t\r\n\t\r\n\t\tIf ValType(xRetVal)== \"A\"\r\n\t\t\tcPercTrib := ConvType( xRetVal[1], 15, 2 )\r\n\t\tElseIf ValType(xRetVal)== \"N\"\r\n\t\t\tcPercTrib := ConvType( xRetVal, 15, 2 )\r\n\t\tEndIf\r\n\t\t\r\n\t\tnAliquota\t:= AlqLeiTran( \"SB1\", \"SBZ\" )[1]    \r\n\t\tnTributo\t:= ConvType( ( aProd[nPos] * nAliquota ) / 100, 15, 2 )\r\n\t\tnTotTrib\t:= Val( nTributo )\r\n\t\r\n\t\tcPercTrib\t:= ConvType( ( nTotTrib / aProd[10] ) * 100, 15, 2 )*/\r\n\t\r\n\tEndif\r\n\r\nElse\r\n\r\n\tcPercTrib\t:= ConvType( ( nTotCargaTrib / nTotNota ) * 100, 15, 2 )\r\n\r\nEndIf\t\r\n\t\r\nRestArea( aAreaSB1 )\r\nRestArea( aArea )\t\r\n\r\nReturn cPercTrib\r\n\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} LeiTransp\r\nRetorna a porcentagem a ser impresso no por documento gerado \r\nDANFE para a Lei Transparencia (Lei 12.741) \r\n\r\n\r\n@param\tnPos \tPosição ref. Aliq. Tributante: 30 - Aliquota Total\r\n\t\t\t\t\t\t\t35-Federal / 36-Estadual / 37-Municipal\r\n\r\n@return nAliq\t\tAliquota do Produto\r\n\r\n@author Douglas Parreja\r\n@since 19/12/2014\r\n@version 11.80\r\n/*/\r\n//-----------------------------------------------------------------------\r\n\r\nStatic Function LeiTransp (nPos,aProd,aNota)\r\n\r\nLocal nAliq := 0\r\nLocal aAreaSD2 := SD2->( GetArea() )\r\n\r\nDefault nPos\t:= 30\r\nDefault aProd :={}\r\nDefault aNota :={}\r\n\r\nDbSelectArea(\"SD2\")\r\nDbSetOrder(3) // D2_FILIAL+D2_DOC+D2_SERIE\r\n\r\nIf len(aProd) > 36 .and. len(aNota) > 1 .and. MsSeek( xFilial(\"SD2\") + PADR(aNota[2],TAMSX3(\"D2_DOC\")[1]) + PADR(aNota[1],TAMSX3(\"D2_SERIE\")[1]))\r\n\tnAliq := aProd[nPos] /  (SD2->D2_VALBRUT + SD2->D2_DESCON)\r\nEndif\t\r\n\r\nRestArea(aAreaSD2)\r\n\r\nReturn nAliq\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} DevCliEntr\r\nVerifica se nota de devolução utiliza cliente de entrega da nota de origem.\r\n\r\n@param\tcAliasSD1 Alias corrente do arquivo temp utilizado para a SD1\r\n\r\n@return lRet\t\tVerdadeiro se nota de devolucao utiliza cliente de entrega.\r\n\r\n@author Fabricio Romera\r\n@since 13/11/2015\r\n@version 11.80\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function DevCliEntr(cAliasSD1)\r\nLocal aArea    := GetArea()\r\nLocal aAreaSF2 := SF2->(GetArea())\r\nLocal lRet     := .F.\r\n\r\nDbSelectArea(\"SF2\")\r\nDbSetOrder(1)\r\nIf SF2->( DbSeek(xFilial(\"SF2\")+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI) )\r\n\tIf SF2->F2_CLIENTE <> SF1->F1_FORNECE .And. SF2->F2_CLIENT = SF1->F1_FORNECE\r\n\t\tlRet := .T.\r\n\tEnd If\r\nEnd If\r\n\r\nRestArea(aAreaSF2)\r\nRestArea(aArea)\r\nReturn lRet\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} ComplPreco\r\nVerifica se nota de complemento de preco e se a nota origem está na base\r\n@param\taAreaSDx Alias corrente do arquivo temp utilizado para a SD2/SD1\r\n@param\taAreaSFx Alias corrente do arquivo temp utilizado para a SF2/SF1\r\n@return Valor das tags vUnCom , vUnTrib\r\n@author Cleiton Genuino\r\n@since 24/11/2015\r\n@version 11.80\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function ComplPreco(cTipo,cF2Tipo,aProd)\r\nLocal aArea    := GetArea()\r\nLocal aAreaSDx := iif (cTipo== \"1\",SD2->(GetArea()),SD1->(GetArea()))\r\nLocal aAreaSFx := iif (cTipo== \"1\",SF2->(GetArea()),SF1->(GetArea()))\r\nLocal vComPreco  := \"0\"\r\nDefault cTipo   := \"\"\r\nDefault cF2Tipo := \"\"\r\nDefault aProd   := {}\r\nIF cTipo == \"1\" .And. cF2Tipo == \"C\" .And. len (aProd) > 0 .And. SF2->F2_TPCOMPL <> \"2\"\r\n\tDbSelectArea(\"SD2\")\r\n\tDbSetOrder(3)//D2_FILIAL, D2_DOC, D2_SERIE, D2_CLIENTE, D2_LOJA, D2_COD, D2_ITEM,\r\n\tIf SD2->( DbSeek(xFilial(\"SD2\")+ SD2->D2_DOC + SD2->D2_SERIE ))\r\n\t\tIf !Empty(SD2->D2_NFORI).And. !Empty(SD2->D2_SERIORI) .And. !Empty(SD2->D2_ITEMORI)\r\n\t\t\tDbSelectArea(\"SF2\")\r\n\t\t\tDbSetOrder(1)//F2_FILIAL, F2_DOC, F2_SERIE, F2_CLIENTE, F2_LOJA, F2_FORMUL, F2_TIPO,\r\n\t\t\tIF SF2->( DbSeek(xFilial(\"SF2\")+ SD2->D2_NFORI + SD2->D2_SERIORI ))\r\n\t\t\tIf !Empty(SF2->F2_CHVNFE) .And. len (SF2->F2_CHVNFE)== 44\r\n\t\t\t\tvComPreco  :=ConvType(aProd[10],15,2)\r\n\t\t\t\tEndIF\r\n\t\t\tEndIF\r\n\t\tEndif\r\n\tEndIf\r\nElse\r\n\tvComPreco := ConvType(aProd[10]/aProd[12],21,8)\r\nEndIF\r\nRestArea(aAreaSDx)\r\nRestArea(aAreaSFx)\r\nRestArea(aArea)\r\nReturn vComPreco\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfeAutXml\r\nFunção que monta o grupo autXML da NFe\r\n\r\n@param\t\tcAutXml\t String com os CPFs/CNPJs autorizados a visualizar \r\n\t\t\t\t\t\t o xml\r\n@return\tcString\t String contendo o grupo autXML  \r\n\r\n@author Natalia Sartori\r\n@since 21/12/2015\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeAutXml(cAutXml)\r\n\r\nLocal cString := \"\"\r\nLocal cSeparador := \";\"\r\nLocal cConteudo\t:= \"\"\r\nLocal nAt\t:= 0\r\nLocal nX\t:= 0\r\nLocal aAux :={}\r\n\r\n\r\nIf cSeparador $ cAutXml\r\n\tnAt:= at(cSeparador,cAutXml)\r\n\tWhile nAt > 0\r\n\t\tcConteudo := Substr(cAutXml,1,nAt-1)\r\n\t\taadd(aAux,{cConteudo})\r\n\t\tcAutXml:= Substr(cAutXml,nAt+1)\r\n\t\tnAT := at(cSeparador,cAutXml)\r\n\tEndDo\r\n\tIf !Empty(cAutXml)\r\n\t\taadd(aAux,{cAutXml})\r\n\tEndIf\r\nElse\r\n\taadd(aAux,{cAutXml})\r\nEndIf\r\n\r\nIf Len(aAux) > 0 .and. !Empty(aAux[1][1])\r\n\tFor nX := 1 to Len( aAux )\r\n\t\tcString += '<autXML>'\r\n\t\tIf Len(aAux[nX][1])== 14\r\n\t\t\tcString += '<CNPJ>'+aAux[nX][1]+'</CNPJ>'\r\n\t\tElseIf Len(aAux[nX][1])== 11\r\n\t\t\tcString += '<CPF>'+aAux[nX][1]+'</CPF>'\r\n\t\tEndIf\r\n\t\tcString += '</autXML>'\r\n\tNext nX\t\r\nEndIf\r\n\r\nReturn(cString)\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfeCodANP\r\nFunção que verifica se o código ANP permitido para gerar o grupo ICMSUFDes para\r\nnão ocorrer a  Rejeição. 695 :Informado indevidamente o grupo de ICMS para a UF de destino.\r\n\r\n@param\t\tNil  \r\n@return    cString\tString contendo os codigos ANP permitidos para gerar o grupo ICMSUFDes.\r\n                       \r\n                        Operação com combustível (tag:comb) derivado de petróleo:\r\n                        código ANP diferente de: \r\n                        820101001, 820101010, 810102001,810102004, 810102002, 810102003, 810101002, 810101001,\r\n                        810101003, 220101003, 220101004, 220101002, 220101001,220101005, 220101006, 560101001\r\n@author Valter da silva\r\n@since 11/02/2016\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeCodANP()\r\n\r\nLocal cRetorno \t:= \"\"\r\nLocal cPipe \t\t:= \"-\"\r\n\r\n\tcRetorno += \"820101001\" + cPipe \r\n\tcRetorno += \"820101010\" + cPipe \r\n\tcRetorno += \"810102001\" + cPipe \r\n\tcRetorno += \"810102004\" + cPipe \r\n\tcRetorno += \"810102002\" + cPipe \r\n\tcRetorno += \"810102003\" + cPipe \r\n\tcRetorno += \"810101002\" + cPipe \r\n\tcRetorno += \"810101001\" + cPipe \r\n\tcRetorno += \"810101003\" + cPipe \r\n\tcRetorno += \"220101003\" + cPipe \r\n\tcRetorno += \"220101004\" + cPipe \r\n\tcRetorno += \"220101002\" + cPipe \r\n\tcRetorno += \"220101001\" + cPipe \r\n\tcRetorno += \"220101005\" + cPipe \r\n\tcRetorno += \"220101006\" + cPipe\r\n\tcRetorno += \"560101001\" + cPipe\r\n\t\r\nReturn cRetorno\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfMultCup\r\nRetorna array com cupons relacionados a nota sobre cupom\r\n\r\n@param\taItemCup\tArray com itens separados por cupom referenciado\r\n@param\tcSerie\t\tSerie da nota atual\r\n@param\tcNota\t\tNumero da nota atual\r\n@param\tcClieFor\tCliente/Fornecedor da nota atual\r\n@param\tcLoja\t\tLoja da nota atual\r\n\r\n@return aRet\t\tArray com cupons referenciados na NF\r\n\r\n@author Leonardo Kichitaro\r\n@since 24/06/2015\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfMultCup(aItemCup, cSerie, cNota, cClieFor, cLoja)\r\n\r\nLocal aRet\t\t\t:= {}\r\nLocal nX\t\t\t:= 0\r\n\r\nDefault aItemCup\t:= {}\r\nDefault cSerie\t\t:= \"\"\r\nDefault cNota\t\t:= \"\"\r\nDefault cClieFor\t:= \"\"\r\nDefault cLoja\t\t:= \"\"\r\n\r\nIf Len(aItemCup) == 0\r\n\taAdd(aRet,{cSerie, cNota, cClieFor, cLoja})\r\nElse\r\n\tFor nX := 1 To Len(aItemCup)\r\n\t\tIf Len(aRet) == 0 .Or. aScan(aRet,{|x| x[1]+x[2]+x[3]+x[4] == aItemCup[nX][3]+aItemCup[nX][2]+aItemCup[nX][5]+aItemCup[nX][6]}) == 0\r\n\t\t\taAdd(aRet,{aItemCup[nX][3], aItemCup[nX][2], aItemCup[nX][5], aItemCup[nX][6]})\r\n\t\tEndIf\r\n\tNext\r\nEndIf\r\n\r\nReturn aRet\r\n\r\n//--------------------------------------------------------------------\r\n\r\n/*/{Protheus.doc}NfeMFECOP\r\nFunção  para gerar a mensagem do FECP  por estado -DF - MG - PR - RJ - RS \r\n         utilizado em informacoes complementares da nota\r\n      \r\n@param\t\tnVfecp\t      Valor numérico do FECOP referente ao valor total\r\n@param\t\tnVfecp\t      Estado da Filial Corrente.\r\n@param\t\tcFinalid  //'1' Retorna a mensagem no campo \"Informações Complementares\"\r\n                       //'2' Retorna a mensagem no campo \"Informação Adicional do Produto\"\r\n                     \r\n@return    cString\tString contendo a mensagem  \"Informações Complementares\" \r\n                        ou \"Informação Adicional do Produto Conforme o cFinalid \"\r\n\r\n                       \r\n@author Valter da silva\r\n@since 14/11/2016\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeMFECOP(nVfecp,cEstado,cDestDanf,aICMS,aICMSST,cVerAmb)\r\n\r\nlocal cMensFcop\t:= \"\"\r\nlocal cMensPadr := \"\"\r\nlocal cMensICMS := \"\"\r\nlocal cMensST\t:= \"\"\r\nLocal nX\t\t:= \"\"\r\nLocal nBaseIcm\t:= 0\r\nLocal nBaseST\t:= 0\r\nLocal nPerc\t\t:= 0\r\nLocal nValor\t:= 0\r\n\r\nDefault nVfecp := 0\r\nDefault cDestDanf     := \"1\"\r\nDefault cEstado      := \"\"\r\nDefault aICMS     := {}\r\nDefault aICMSST   := {}\r\nDefault cVerAmb   := \"\"\r\n\r\nDo Case\r\n  // MG: \"Arquivo Decreto nº 46.927, de 29 de dezembro de 2015.docx\", página 3:\r\n  //Art. 6º Nas operações sujeitas ao adicional de alíquota, o contribuinte indicará no campo “Informações \r\n  //Complementares” da nota fiscal a expressão “Adicional de alíquota – Fundo de Erradicação da Miséria\r\n  //” acompanhada do respectivo valor.\r\n\tCase cEstado== \"MG\"   // Tratamento legado de FECP\r\n\t\tIf  cDestDanf =='1'\r\n\t\t\tcMensFcop := \"Adicional de alíquota - Fundo de Erradicação da Miséria - R$ \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t   EndIf\r\n\t   \t\r\n\t//Case cEstado== \"PR\" \r\n\tCase cEstado== \"PR\" \r\n\t\t//PR: Arquivo \"Decreto Nº 3.339, de 20 de janeiro de 2016 - FECOP a partir de 01-02-2016.doc\", página 4:\r\n    \t//Art. 6º - Na Nota Fiscal Eletrônica - NF-e, modelos 55 ou 65, emitida para acobertar as operações com os produtos de que trata o art. 1º, deverá constar:\r\n    \t//I - o valor numérico do FECOP referente a cada item, no campo \"Informação Adicional do Produto\", com o seguinte formato: ##FECOP<N.\r\n    \t//NN>##, onde N.NN é o valor numérico do FECOP referente a cada item, com duas casas decimais, separadas por ponto, sem separador de milhar;\r\n    \t//II - o valor numérico do FECOP referente ao valor total, no campo \"Informações Complementares\", com o seguinte formato: ##FECOP<N.\r\n    \t//NN>##, onde N.NN é o valor numérico do FECOP referente ao valor total, com duas casas decimais, separadas por ponto, sem separador de milhar.  cValToChar(nVfecp)  \r\n\t\tIf  cDestDanf =='1' \r\n\t    \tcMensFcop := \"O valor numerico do FECOP referente ao valor total R$ \" + cValToChar(nVfecp)\r\n\t    ElseIf cDestDanf =='2'\r\n\t       cMensFcop := \"O valor numerico do FECOP referente a cada item R$ \" + cValToChar(nVfecp)\r\n\t    EndIf\r\n\t                \r\n\tCase cEstado== \"RJ\"\r\n    \tIf  cDestDanf =='1'\r\n\t\t\tcMensFcop := \"Adicional de alíquota - Fundo Estadual de Combate à Pobreza e às Desigualdades Sociais (FECP) - \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t    EndIf\r\n\t   \r\n\tCase cEstado== \"RS\" \r\n\t\tIf  cDestDanf =='1'\r\n\t    \tcMensFcop := \"Adicional de alíquota relativo ao AMPARA/RS, criado pela Lei nº 14.742/15 - R$ \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\")) \r\n\t\tEndIf\r\n\t\r\n\tOtherWise     \r\n\t\r\n\t\tIF cDestDanf =='1'\r\n\t\t\tIf\tcVerAmb == \"3.10\"\r\n\t\t\t\tcMensFcop  := \"Adicional de alíquota - Fundo Estadual de Combate à Pobreza e às Desigualdades Sociais (FECP) - \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t\t\tElse\r\n\t\t\t\tcMensFcop  := \"Adicional de alíquota - Fundo Estadual de Combate à Pobreza e às Desigualdades Sociais  - R$\" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t\t\tEndIf\r\n  \t\tEndIf\r\n  \tEndCase\r\n\t\r\n\tIF cVerAmb == \"4.00\" \r\n\t\r\n\t\tcMensPadr:= \"(FCP):\"+ cMensFcop\r\n\r\n\t\tIf cDestDanf =='1' // Informação do fisco <infAdFisco> para fecp\r\n\t\t\tnBaseIcm:=0\r\n\t\t\tnValor  :=0\r\n\t\t\tnPerc   :=0\r\n\t\t\tFor nX := 1 to Len( aICMS )\r\n\t\t\t\tIf Len( aICMS[nX] ) > 0 .And. aICMS[nX][16] > 0 .And.  aICMS[nX][17] > 0 .And. aICMS[nX][18] > 0  \r\n\t\t\t\t\tnBaseIcm\t:= nBaseIcm +  aICMS[nX][16] \r\n\t\t\t\t\tnValor\t\t:= nValor   +  aICMS[nX][18] \r\n\t\t\t\t\tnPerc \t\t:= aICMS[nX][17]\r\n  \t\t\t\tEndIf\r\n  \t\t\tNext nX\r\n  \t\t\t\r\n  \t\t\tIf  nBaseIcm > 0 .and.  nPerc > 0\r\n  \t\t\t\tcMensICMS := AllTrim(\" Base R$ \"+ConvType(nBaseIcm,13,2)+\" Perc.(\"+ConvType(nPerc)+\"%)\")\r\n  \t\t\t\tcMensFcop := cMensPadr +\" \"+cMensICMS\r\n  \t\t\tEndIf  \r\n  \t\t\t\r\n  \t\t\tnBaseST:=0\r\n\t\t\tnValor :=0\r\n\t\t\tnPerc  :=0\r\n  \t\t\tFor nX := 1 to Len( aICMSSt )\r\n\t\t\t\tIf Len( aICMSSt[nX] ) > 0 .And. aICMSSt[nX][13] > 0 .And.  aICMSSt[nX][14] > 0 .And. aICMSSt[nX][15] > 0  \r\n\t\t\t\t\tnBaseST\t:= nBaseST  +  aICMSSt[nX][13]\r\n\t\t\t\t\tnValor\t\t:= nValor   +  aICMSSt[nX][15] \r\n\t\t\t\t\tnPerc     \t:= aICMSSt[nX][14]   \r\n\t\t\t\t\t\r\n  \t\t\t\tEndIf\r\n  \t\t\tNext nX \r\n  \t\t\t\r\n  \t\t\tIf\tnBaseST > 0 .and.  nPerc > 0\r\n  \t\t\t  \tcMensST := \"(FCPST): \"+AllTrim(\"Base R$ \"+ConvType(nBaseST,13,2)+\" Perc.(\"+ConvType(nPerc)+\"%)\")\r\n  \t\t\t\tcMensFcop := \tcMensPadr +\" \"+cMensICMS+\" \"+cMensST\r\n  \t\t\tEndIf\r\n  \t\t\t\t \r\n  \t\telseIf  cDestDanf =='2' // Informação do fisco <indAdProd> para fecp\r\n  \t\t\tIf Len(aICMS) > 0 \r\n      \t\t\tIf  (aICMS[16] > 0 .or. aICMS[17] > 0 .or.  aICMS[18] > 0)\r\n      \t\t\t\tIf cEstado <> \"PR\" \r\n      \t\t\t\t\tcMensICMS := AllTrim(\"Base R$ \"+ConvType(aICMS[16],13,2)+\" Perc.(\"+ConvType(aICMS[17])+\"%) Vlr. R$ \" + ConvType(aICMS[18],13,2))\r\n  \t\t\t\t\t\tcMensFcop := cMensPadr + \" \" + cMensICMS\r\n  \t\t\t\t\tElse\r\n  \t\t\t\t\t\tcMensICMS := AllTrim(\"Base R$ \"+ConvType(aICMS[16],13,2)+\" Perc.(\"+ConvType(aICMS[17])+\"%)\")\r\n  \t\t\t\t\t\tcMensFcop := cMensPadr + \" \" + cMensICMS\r\n  \t\t\t\t\tEndIf \r\n  \t\t\t\tEndIf\r\n  \t\t\tEndIf\r\n  \t\t\t\r\n  \t\t\tIf Len(aICMSSt) > 0 \r\n  \t\t\t\tIf  (aICMSST[13] > 0 .or. aICMSST[14] > 0 .or.  aICMSST[15] > 0)\r\n  \t\t\t\t\tIf cEstado <> \"PR\"  // Para PR. não enviamos o valor \r\n  \t\t\t\t\t\tcMensST := \"(FCPST): \" + AllTrim(\"Base R$ \"+ConvType(aICMSST[13],13,2)+\" Perc.(\"+ConvType(aICMSST[14])+\"%) Vlr. R$ \" + ConvType(aICMSST[15],13,2))\r\n  \t\t\t\t\t\tcMensFcop := \tcMensPadr +\" \"+cMensICMS+\" \"+cMensST\r\n  \t\t\t\t\tElse\r\n  \t\t\t\t\t\tcMensST := \" (FCPST): \" + AllTrim(\"Base R$ \"+ConvType(aICMSST[13],13,2)+\" Perc.(\"+ConvType(aICMSST[14])+\"%)\")\r\n  \t\t\t\t\t\tcMensFcop := cMensPadr +\" \"+cMensICMS+\" \"+cMensST\r\n  \t\t\t\t\tEndIf\r\n  \t\t\t\tEndIf\t\r\n  \t\t\tEndIf\r\n  \t\tEndIf\t  \r\n  \tEndIf\r\n  \t\r\nReturn cMensFcop\r\n\r\n//---------------------------------------------------------------------------\r\n/*/{Protheus.doc} MsgCliDFIcm\r\nFuncao que retorna a mensagem para ser colocada nos dados adicionais da NFe.\r\nTratamento legislacao do DF, quando existir intes com ICMS-ST e intens somente com ICMS  próprio\r\n\r\n@author Valter Da Silva   \r\n@since 14.11.2016\r\n@version 1.0  \r\n\r\n@param\t\taICMS\t\tArray com informações referente ao ICMS proprio\r\n@param\t\taICMSST\tArray com informações referente ao ICMS-ST\r\n\t\t\t\r\n@return\tcMsg\t\tRetorna a Mensagem a ser utilizada.\t\r\n\r\n/*/\r\nStatic Function MsgCliDFIcm(aICMS, aICMSST, lNCMOk)\r\n\r\nLocal cMsg \t\t:= \"\"\r\n\r\nLocal nX\t\t\t:= \"\"\r\nLocal nValIcm\t\t:= 0\r\nLocal nValST\t\t:= 0 \r\nLocal nBaseIcm\t\t:= 0\r\nLocal nBaseST\t\t:= 0\r\n\r\nLocal lIcmsST\t\t:= .F.\r\nLocal lIcms\t\t:= .F.\r\nLocal lIcmsSemSt\t:= .F.\r\nDEFAULT aICMS  \t:= {}\r\nDEFAULT aICMSST \t:= {}\r\n\r\nDEFAULT lNCMOk\t\t:= .F.\r\n\r\nFor nX := 1 to Len( aICMS )\r\n\t\r\n\tlIcms := .F.\r\n\t\r\n\tIf Len( aICMS[nX] ) > 0 .And. aICMS[nX][07] > 0\r\n\t\t\r\n\t\tnValIcm \t+= aICMS[nX][07] \r\n\t\tnBaseIcm\t+= aICMS[nX][05]\r\n\t\t\r\n\t\tif len( aICMSSt[nX] ) > 0 .and. aICMSSt[nX][07] > 0 \r\n\t\t\tnValST\t\t+= aICMSST[nX][07]\r\n\t\t\tnBaseST\t+= aICMSST[nX][05]\r\n\t\tendif\r\n\t\t\r\n\t\tlIcms := .T.\r\n\t\t\t\t\r\n\tEndIf\r\n\t\r\n\tIf Len( aICMSSt[nX] ) > 0 .And. aICMSSt[nX][07] > 0 \t\t\r\n\t\t\r\n\t\tlIcmsST := .T.\r\n\t\t\t\t\t\t\r\n\tElseIf lIcms .And. !lIcmsSemSt  \r\n\t\tlIcmsSemSt := .T.\r\n\tEndIF\r\n\t \t\r\nNext nX\r\n\r\nIf  lIcmsST .And. lNCMOk\r\n\tcMsg +=\"Valor das operações sujeitas ao adicional:: R$  \" + Alltrim( Str(nBaseST, 14, 2) ) \r\n\tcMsg +=\" O valor corresponde à base de cálculo do ICMS ST\"\r\nEndIf\r\n\r\nReturn cMsg\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} retUn2UM\r\nRetorna a unidade da 2a. Unidade de Medida \r\n\r\n@author Sergio S. Fuzinaka\r\n@since 12.07.2017\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\nStatic Function retUn2UM( lNoImp2UM, cCFOPExp, cCFOP, cUMDIPI, cUM)\r\n\r\nLocal cReturn := \"\"\r\n\r\n// Tratamento para operacoes dentro do País\r\nIf lNoImp2UM\r\n   If ( Left(cCFOP,1) $ \"3-7\" ) .Or. ( cCFOP $ cCFOPExp )\r\n      If !Empty( cUMDIPI )\r\n         cReturn := cUMDIPI\r\n      Else\r\n         cReturn := cUM\r\n      Endif\r\n   Else\r\n      cReturn := cUM\r\n   Endif\r\nElse\r\n   If !Empty( cUMDIPI )\r\n      cReturn := cUMDIPI\r\n   Else\r\n      cReturn := cUM\r\n   Endif\r\nEndif\r\n\r\nReturn( cReturn )\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} retQtd2UM\r\nRetorna a quantidade da 2a. Unidade de Medida\r\n\r\n@author Sergio S. Fuzinaka\r\n@since 12.07.2017\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\nStatic Function retQtd2UM( lNoImp2UM, cCFOPExp, cCFOP, nCONVDIP, nQUANT)\r\n\r\nLocal nReturn := 0\r\n\r\n// Tratamento para operacoes dentro do País\r\nIf lNoImp2UM\r\n   If ( Left(cCFOP,1) $ \"3-7\" ) .Or. ( cCFOP $ cCFOPExp )\r\n      If nCONVDIP > 0\r\n         nReturn := ( nCONVDIP * nQUANT )\r\n      Else\r\n         nReturn := nQUANT\r\n      Endif\r\n   Else\r\n      nReturn := nQUANT\r\n   Endif\r\nElse\r\n   If nCONVDIP > 0\r\n      nReturn := ( nCONVDIP * nQUANT )\r\n   Else\r\n      nReturn := nQUANT\r\n   Endif\r\nEndif\r\n\r\n//O valor é limitado a 4 casas deciamais \r\n//porque o Schema(.XSD) da Sefaz nao aceita mais que 4 casas\r\nnReturn := NoRound(nReturn,5) //bruno alterado de 4 para 5\r\n\r\nReturn( nReturn )\r\n\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} NfePag\r\nRetorna o grupo da forma de pagamento.\r\n@author Valter da Silva\r\n@since 26.03.2018\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\n\r\nStatic Function NfePag(aDetPag)\r\nLocal cString    := \"\"\r\nLocal nX         := 0  \r\nLocal nTroco     := 0 \r\nDefault aDetPag  := {}\r\n\r\nIF len(aDetPag) > 0  \r\n\tcString +='<pagamento>'\r\n\tFor nX := 1 To Len(aDetPag)\r\n\t\tcString +='<detPag>'\r\n\t\tcString += '<indForma>'+aDetPag[nX][8]+'</indForma>'\r\n\t\tcString +='<forma>'+aDetPag[nX][1]+'</forma>' \r\n\t\tIf aDetPag[nX][1] == \"90\" //SEM PAGAMENTO\r\n\t\t\tcString +='<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\telse\r\n\t\t\tcString +='<valor>'+ConvType(aDetPag[nX][2],15,2)+'</valor>'\r\n\t\tEndIf\r\n\t\t\r\n\t\tIf Len(aDetPag[nX]) > 3 \r\n\t\t\tIF\t!empty(aDetPag[nX][4]) .and. aDetPag[nX][1] $ '03-04'\r\n\t\t\t\tcString += '<cartoes>'\r\n\t\t\t\tcString += '<tpIntegra>' +aDetPag[nX][4]+ '</tpIntegra>'\r\n\t\t\t\tcString += '<cnpj>'+aDetPag[nX][5]+ '</cnpj>'\r\n\t\t\t\tcString += '<bandeira>'+aDetPag[nX][6]+'</bandeira>'\r\n\t\t\t\tcString += '<autorizacao>'+aDetPag[nX][7]+'</autorizacao>'\r\n\t\t\t\tcString += '</cartoes>'\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\tcString +='</detPag>'\r\n\t\tnTroco  += aDetPag[nX][3]\r\n\tNext    \t\r\n\tcString +='<vTroco>'+ConvType(nTroco,15,2)+'</vTroco>'\r\n\tcString +='</pagamento>'\r\nEndIf\r\nReturn(cString)\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} NfeTpNota\r\nRetorna o tipo da nota.\r\n@author Valter da Silva\r\n@since 26.03.2018\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\nStatic Function NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cCFOP)\r\nLocal cTPNota     \t:= \"\"\r\nLocal cMVCfopTran \t:= SuperGetMV(\"MV_CFOPTRA\", ,\" \")   \t\t// Parametro que define as CFOP´s pra transferência de Crédito/Débito\r\nLocal nPos        \t:= 0 \r\nLocal cMVDevCfop  \t:= AllTrim(GetNewPar(\"MV_DEVCFOP\",\"\"))\r\nLocal aMVDevCfop  \t:= {}\r\n\r\nDefault cVerAmb   \t:= \"3.10\"\r\nDefault cCFOP   \t:= \"\"\r\nDefault aNota\t    := {}\r\nDefault aNfVinc   \t:= {}\r\nDefault aNfVincRur\t:= {}\r\nDefault aRefECF   \t:= {}\r\n\r\nDo Case\r\n\tCase (!Empty(aNfVinc) .And. !(aNota[5]$\"NDB\") .And. SF4->F4_AJUSTE <> \"S\")\r\n  \t\tcTPNota:= \"2\" \r\n \tCase (SubStr(SM0->M0_CODMUN,1,2)=='31' .And. SF4->F4_AJUSTE == \"S\" .And. (aNota[5]) $ \"N\" )\r\n \t\tcTPNota:= \"3\"\r\n\tCase ((aNota[5]) $ \"I-D-C-B\" .And. SF4->F4_AJUSTE == \"S\")\r\n   \t\tcTPNota:= \"3\"\r\n\t/* Referente ao chamado TIDMJV que contempla, nota de transferência de crédito / débito */\t   \t\t\r\n   \tCase ( ( AllTrim( SF4->F4_CF ) $ cMVCfopTran ) .and. ( SF4->F4_SITTRIB == \"90\" ) .and.  ( SF4->F4_AJUSTE == \"S\" ) ) \r\n\t\tcTPNota:= \"3\"\r\n\tCase (cVeramb >= \"3.10\" .and. (!Empty(aNfVinc) .Or. !Empty(aRefECF) .Or. !Empty(aNfVincRur))) .and. ( (aNota[5] $ \"D|B\" .And. SF4->F4_AJUSTE <> \"S\") .or. (aNota[5] $ \"N\" .And. SF4->F4_PODER3 == \"D\") )\r\n   \t\t  \t\t\r\n   \t\t//Retorna um array, de acordo com os dados passados no parametro MV_DEVCFOP\r\n   \t\taMVDevCfop\t:= StrTokArr( cMVDevCfop , \";\" )\t\r\n   \t\t\r\n   \t\t// Verifica a CFOP da NF de Devolucao consta no parametro MV_DEVCFOP \r\n   \t\tIF  !Empty(Alltrim(SFT->FT_CFOP))\r\n   \t\t\tnPos := Ascan( aMVDevCfop , Alltrim(SFT->FT_CFOP) ) \r\n   \t\tElse\r\n   \t\t\tnPos := Ascan( aMVDevCfop , Alltrim(cCFOP)) \r\n   \t\tEndIf \r\n   \t\t\r\n   \t\t// Se achou o conteudo, o Tipo de Nota fica igual a 1 conforme NT 2013.005.v1.03 (Chamado TQMCY6) \r\n   \t\tIf nPos > 0 \r\n   \t\t\tcTPNota:= \"1\" \r\n   \t\tElse\r\n   \t\t\tcTPNota:= \"4\" //Devolução de Mercadoria\r\n   \t\tEndIf\r\n   \t\t\r\n   \t /*Ajuste para emitir notas do tipo devolução Tag< finnfe> =4  sem necessidade de referenciar a nota original \r\n     para os  CFOP  1.201, 1.202, 1.410, 1.411, 5,921 e 6,921 . Evitando a rejeição 321- Rejeição: NF-e de devolução de mercadoria não possui\r\n     documento fiscal referenciado conforme  NT 2013/005 v 1.20.\r\n   \t */\r\n    Case (aNota[5]) $ \"D\" .and. Empty(aNfVinc).and. Alltrim(SFT->FT_CFOP) $ \"1201-1202-1410-1411-5921-6921\"\r\n   \t \tcTPNota:= \"4\" \r\n   \t\t\r\n\r\n\tOtherWise \r\n  \t\tcTPNota:= \"1\"\r\n\tEndCase\r\n\r\nReturn(cTPNota)\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfeProdANP\r\n\r\nGrupo ICMS60 (id:N08) informado indevidamente nas operações\r\ncom os produtos combustíveis sujeitos a repasse interestadual\r\n(tag:cProdANP).\r\n\r\n@param\t\tNil  \r\n@return    cString\tString contendo os codigos de produto ANP não permitidos para gerar o grupo ICMS60 quando cst 60.\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 21/03/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeProdANP()\r\n\r\nLocal cRetorno \t:= \"\"\r\n\r\n\tcRetorno := \"210203001|320101001|320101002|320102002|320102001|320102003|320102005|320201001|\"\r\n\tcRetorno += \"320103001|220102001|320301001|320103002|820101032|820101026|820101027|820101004|\"\r\n\tcRetorno += \"820101005|820101022|820101031|820101030|820101014|820101006|820101016|820101015|\"\r\n\tcRetorno += \"820101025|820101017|820101018|820101019|820101020|820101021|420105001|420101005|\"\r\n\tcRetorno += \"420101004|420102005|420102004|420104001|820101033|820101034|420106001|820101011|\"\r\n\tcRetorno += \"820101003|820101013|820101012|420106002|830101001|420301004|420202001|420301001|\"\r\n\tcRetorno += \"420301002|410103001|410101001|410102001|430101004|510101001|510101002|510102001|\"\r\n\tcRetorno += \"510102002|510201001|510201003|510301003|510103001|510301001|\"\r\n\t\r\nReturn cRetorno\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} GetPagLoja\r\n\r\nRetornar informações de pagamentos feitas via Venda Direta/Sigaloja\r\n\r\n@param\t\taDupl     Duplicatas para o caso de não ser enviada nenhuma forma de pagamento, para entao fazer-se a validação para os tipos  //outros e //14=Duplicata Mercantil \r\n@param\t\tcChvPag   Condição de pagamento\r\n@param\t\tnTotVd    Total da venda\r\n \r\n@return    Array Contendo as formas de pagamentos utilizados no Loja.\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 09/05/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function GetPagLoja(aDupl, cChvPag, nTotVd, cIndPag, cVerAmb)\r\nLocal aRet\t\t := {}\r\nLocal aAreaSL1 \t := SL1->(GetArea())\r\nLocal aAreaSL4 \t := SL4->(GetArea())\r\nLocal aAreaSA1 \t := {}\r\nLocal aAreaSE4 \t := {}\r\nLocal aDetPag \t := {}\r\nLocal lTEF\t\t := .F.\r\nLocal isloja\t := .F.\r\nLocal cForma\t := \"\"\r\nLocal cTpIntegra := \"\"\r\nLocal cAutTef \t := \"\"\r\nLocal cTpBand    := \"\"\r\nLocal nTamA1COD  := TamSX3(\"A1_COD\")[1]\t//tamanho do campo A1_COD\r\nLocal nTamAECOD  := TamSX3(\"AE_COD\")[1]\t//tamanho do campo AE_COD\r\nLocal cA1Cgc\t := \"\"\r\nLocal lCondCN\t := .F.\t//Condição Negociada\r\nLocal nTroco\t := 0\r\n\r\nDefault aDupl \t := {}\r\nDefault cChvPag\t := \"\"\r\nDefault nTotVd\t := 0\r\n\r\nIf ExistFunc(\"LjGetPgNfe\")\r\n\taRet := LjGetPgNfe(cVerAmb)\r\nElse\r\n\tdbselectarea(\"SL1\")\r\n\tSL1->(dbsetorder(2))\t\t\t\r\n\tIf SL1->(dbseek(xFilial('SL1') + SF2->F2_SERIE + SF2->F2_DOC))\r\n\t\r\n\t\tlTEF    := ( (AllTrim(SL1->L1_VENDTEF) == \"S\") .Or. (SL1->L1_CARTAO > 0) .Or. (SL1->L1_VLRDEBI > 0) )\r\n\t\tlCondCN := Alltrim(cChvPag) == \"CN\"\r\n\r\n\t\t//Caso tenha sido utilizada NCC(Nota de Credito na venda)\r\n\t\tIf SL1->L1_CREDITO > 0\r\n\t\t\tisloja\t:= .T.\t\t\t\r\n\t\t\t\t\t    //{cForma          , Valor          , Troco, Tp Integra, CGC Adm Cartao, Cod Bandeira, Autorização TEF}\r\n\t\t\taadd(aDetPag, {GetFormPgt(\"CR\"), SL1->L1_CREDITO, 0.00 , \"2\"       , \"\"            , \"\"          , \"\", cIndPag}) \r\n\t\t\t\r\n\t\t\t//Caso em conjunto com a NCC tenha sido utilizada condição de pagamento cadastrada na SE4 que nao seja negociada, ja trato aqui\r\n\t\t\tIf !Empty(cChvPag) .And. !lCondCN .And. ((nTotVd - SL1->L1_CREDITO) > 0)\r\n\r\n\t\t\t\taAreaSE4 := SE4->(GetArea())\r\n\t\t\t\t\t//caso tenha escolhido a forma de pagamento no cadastro de condição de pagamento.\r\n\t\t\t\t\tdbSelectArea(\"SE4\")\r\n\t\t\t\t\tdbSetOrder(1)\t\r\n\t\t\t\t\tIf DbSeek(xFilial(\"SE4\") + cChvPag)\r\n\t\t\t\t\t\tcForma := GetFormPgt(Alltrim(SE4->E4_FORMA), aDupl)\r\n\t\t\t\t\t\tnTroco := IIF(SL1->L1_TROCO1 > 0, SL1->L1_TROCO1, 0.00)\r\n\t\t\t\t\t\taadd(aDetPag, {cForma, nTotVd - SL1->L1_CREDITO , nTroco, \"2\", \"\", \"\", \"\", cIndPag})   \r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\tRestArea(aAreaSE4)\r\n\t\t\tEndIf\t\r\n\t\tEndIf\t\r\n\r\n\t\tdbselectarea(\"SL4\")\t\t\t\r\n\t\tSL4->(dbsetorder(1))\r\n\t\tIf lCondCN .And. SL4->(dbseek(SL1->L1_FILIAL + SL1->L1_NUM))\r\n\t\t\tisloja\t:= .T.\r\n\t\t\tWhile !SL4->(Eof()) .And. xFilial(\"SL4\") == SL4->L4_FILIAL .And. SL1->L1_NUM == SL4->L4_NUM\r\n\t\t\t\r\n\t\t\t\tcForma     := GetFormPgt(Alltrim(SL4->L4_FORMA), aDupl)\t\t\r\n\t\t\t\tcTpIntegra := IIF(lTEF, \"1\", \"2\")\r\n\t\t\t\t\t\r\n\t\t\t\t////////////////////////////////////\r\n\t\t\t\tcAutTef := AllTrim(SL4->L4_AUTORIZ)\r\n\t\t\t\tIf EmpTy(cAutTef)\r\n\t\t\t\t\tcAutTef := AllTrim(SL4->L4_NSUTEF)\r\n\t\t\t\t\tIf EmpTy(cAutTef)\r\n\t\t\t\t\t\tcAutTef := AllTrim(SL4->L4_DOCTEF)\r\n\t\t\t\t\t\tIf EmpTy(cAutTef)\r\n\t\t\t\t\t\t\tcTpIntegra := \"2\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t/////////////////////////////////////\r\n\r\n\t\t\t\tnTroco :=  IIF(SL4->L4_TROCO > 0, SL4->L4_TROCO, 0.00)\r\n\t\t\t\t\r\n\t\t\t\tIf cTpIntegra == \"1\"\r\n\t\t\t\t\t//obtemos o codigo da administradora financeira conforme cadastrada no SA1\r\n\t\t\t\t\tcAdmFin := PadR( SubStr(SL4->L4_ADMINIS,1,nTamAECOD), nTamA1COD )\r\n\t\t\t\t\tIf !Empty(cAdmFin)\r\n\r\n\t\t\t\t\t\taAreaSA1 \t := SA1->(GetArea())\r\n\t\t\t\t\t\t\tDbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\tSA1->( DbSetOrder(1) )\t//A1_FILIAL + A1_COD + A1_LOJA\r\n\t\t\t\t\t\t\tIf SA1->(MsSeek(xFilial(\"SA1\") + cAdmFin)) .And. !Empty(SA1->A1_CGC)\r\n\t\t\t\t\t\t\t\tcA1Cgc := SA1->A1_CGC\r\n\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\tcA1Cgc := \"\"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tRestArea(aAreaSA1)\r\n\t\t\t\t\tElse\t\r\n\t\t\t\t\t\tcA1Cgc := \"\"\r\n\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcTpBand := GetTBandLo(SL4->L4_INSTITU)\r\n\t\t\t\tElse\r\n\t\t\t\t\tcA1Cgc  := \"\"\r\n\t\t\t\t\tcTpBand := \"\"\r\n\t\t\t\t\tcAutTef := \"\"\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\taadd(aDetPag, {cForma, SL4->L4_VALOR, nTroco, cTpIntegra, cA1Cgc, cTpBand, cAutTef, cIndPag}) \r\n\r\n\t\t\t\tSL4->(DbSkip())\r\n\t\t\tEndDo\t\t\r\n    \tEndIf\t\r\n    EndIf\r\n\tRestArea(aAreaSL1)\r\n\tRestArea(aAreaSL4)\r\n\t\r\n\taRet := {isloja, aDetPag}\r\nEndIf\r\n\r\nReturn \taRet\r\n\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} GetFormPgt\r\n\r\nRetornar codigos de formas de pagamento exigidos pela Sefaz\r\n\r\n@param\t\tcCondPag  Condição de pagamento entre \"R$\"//DINHEIRO, \"CH\"//CHEQUE, \"CC\" //CARTAO DE CREDITO, \"CD\"//CARTAO DE DEBITO AUTOMATICO, \"CR\"//CREDITO LOJA\r\n\t\t\t\t        \t\t\t\t\t\t  \"VA\"//VALE ALIMENTAÇÃO, \"VR\"//VALE REFEIÇÃO, \"VP\"//VALE PRESENTE, \"VC\"//VALE COMBUSTIVEL, \"DM\"//Duplicata Mercantil\r\n\t\t\t\t\t\t\t\t\t\t\t\t  \"BOL\" //BOLETO BANCARIO, \"SPG\" //SEM PAGAMENTO\r\n@param\t\taDupl     Duplicatas para o caso de não ser enviada nenhuma forma de pagamento, para entao fazer-se a validação para os tipos  //outros e //14=Duplicata Mercantil \r\n\r\n@return     String  Contendo o codigo de forma de pagamento exigida epela Sefaz\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 09/05/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function GetFormPgt(cCondPag, aDupl)\r\n\r\nLocal cForma\t:= \"\"\r\n\r\nDefault cCondPag\t:= \"\"\r\nDefault aDupl\t    := {}\r\n\r\n\tIf !Empty(cCondPag)\r\n\t\tDo Case\r\n\t\t\tCase cCondPag == \"R$\"//DINHEIRO\r\n\t\t\t\tcForma := \"01\"\r\n\t\t\tCase cCondPag == \"CH\"//CHEQUE\r\n\t\t\t\tcForma := \"02\"\r\n\t\t\tCase cCondPag == \"CC\" //CARTAO DE CREDITO\r\n\t\t\t\tcForma := \"03\"\r\n\t\t\tCase cCondPag == \"CD\"//CARTAO DE DEBITO AUTOMATICO\r\n\t\t\t\tcForma := \"04\"\r\n\t\t\tCase cCondPag == \"CR\"//CREDITO LOJA\r\n\t\t\t\tcForma := \"05\"\r\n\t\t\tCase cCondPag == \"VA\"//VALE ALIMENTAÇÃO\r\n\t\t\t\tcForma := \"10\"\r\n\t\t\tCase cCondPag == \"VR\"//VALE REFEIÇÃO\r\n\t\t\t\tcForma := \"11\"\r\n\t\t\tCase cCondPag == \"VP\"//VALE PRESENTE\r\n\t\t\t\tcForma := \"12\"\r\n\t\t\tCase cCondPag == \"VC\"//VALE COMBUSTIVEL\r\n\t\t\t\tcForma := \"13\"\r\n\t\t\t//Case cCondPag == \"DM\"//Duplicata Mercantil\r\n\t\t\t//\tcForma := \"14\"\t\r\n\t\t\tCase cCondPag == \"BOL\" //BOLETO BANCARIO\r\n\t\t\t\tcForma := \"15\"\t\r\n\t\t\tCase cCondPag == \"SPG\" //SEM PAGAMENTO\r\n\t\t\t\tcForma := \"90\"\r\n\t\t\tOtherWise\r\n\t\t\t\tcForma := \"99\"\t// OUTROS\r\n\t\tEndCase\r\n\tElse\t\r\n\t\tIf Empty(cForma)\r\n\t\t\tIf Len(aDupl) == 0\r\n\t\t\t\tcForma := \"90\"  //sem pagamento\r\n\t\t\tElseIf Len(aDupl) > 0\r\n\t\t\t\tcForma := \"15\"  //15=Boleto Bancário \r\n\t\t\tEndif\r\n\t\tEndIf\r\n\tEndIf\t\r\n\r\nReturn cForma\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} GetTBandLo\r\n\r\nRetornar codigos do tipo da bandeira conforme cartao de de credito ou debito exigidos pela Sefaz\r\n\r\n@param\t\tcCondPag  Condição de pagamento entre \"R$\"//DINHEIRO, \"CH\"//CHEQUE, \"CC\" //CARTAO DE CREDITO, \"CD\"//CARTAO DE DEBITO AUTOMATICO, \"CR\"//CREDITO LOJA\r\n\t\t\t\t        \t\t\t\t\t\t  \"VA\"//VALE ALIMENTAÇÃO, \"VR\"//VALE REFEIÇÃO, \"VP\"//VALE PRESENTE, \"VC\"//VALE COMBUSTIVEL, \"DM\"//Duplicata Mercantil\r\n\t\t\t\t\t\t\t\t\t\t\t\t  \"BOL\" //BOLETO BANCARIO, \"SPG\" //SEM PAGAMENTO\r\n@param\t\taDupl     Duplicatas para o caso de não ser enviada nenhuma forma de pagamento, para entao fazer-se a validação para os tipos  //outros e //14=Duplicata Mercantil \r\n\r\n@return     String  Contendo o codigo de forma de pagamento exigida epela Sefaz\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 09/05/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function GetTBandLo(cBandeira)\r\n\r\nLocal c_tBand\t\t:= \"\"\t//codigo da bandeira utilizada pelo SEFAZ\r\n\r\nDefault cBandeira\t:= \"\"\r\n\r\n\tcBandeira := AllTrim( cBandeira )\r\n\tDo Case\r\n\t\tCase (\"VISA\" $ cBandeira)              //( (\"VISA\" $ cBandeira) .OR. (\"ELECTRON\" $ cBandeira) )\r\n\t\t\tc_tBand := \"01\"\r\n\t\tCase (\"MASTERCARD\" $ cBandeira)        // ( (\"MAESTRO\" $ cBandeira) .OR. (\"MASTERCARD\" $ cBandeira) )\r\n\t\t\tc_tBand := \"02\"\r\n\t\tCase (\"AMERICAN EXPRESS\" $ cBandeira)  //( (\"AMEX\" $ cBandeira) .OR. (\"EXPRESS\" $ cBandeira) )\r\n\t\t\tc_tBand := \"03\"\r\n\t\tCase (\"SOROCRED\" $ cBandeira)\r\n\t\t\tc_tBand := \"04\"\r\n\t\tCase (\"DINERS CLUB\" $ cBandeira)\r\n\t\t\tc_tBand := \"05\"\t\r\n\t\tCase (\"ELO\" $ cBandeira)\r\n\t\t\tc_tBand := \"06\"\t\r\n\t\tCase (\"HIPERCARD\" $ cBandeira)\r\n\t\t\tc_tBand := \"07\"\t\r\n\t\tCase (\"AURA\" $ cBandeira)\r\n\t\t\tc_tBand := \"08\"\t\t\r\n\t\tCase (\"CABALAURA\" $ cBandeira)\r\n\t\t\tc_tBand := \"09\"\t\t\t\r\n\t\tOtherwise\r\n\t\t\tc_tBand := \"99\"\r\n\tEndCase\r\n\r\nReturn c_tBand\r\n\r\n/*/{Protheus.doc} DadNfVinc()\r\nFuncao que verifica os dados da nota vinculadas ao documento de entrada.\r\n@author Valter Da silva     \r\n@since 02.07.2018\r\n@version 1.0 \r\n/*/\r\nStatic Function DadNfVinc(aNfVinc)\r\nLocal aAreaSC5\t:= SC5->( GetArea() )\r\nLocal aAreaSC6 := SC6->( GetArea() )\r\nLocal aDadNfVi\t:= {} \r\nLocal cNEmp\t:= \"\"  \r\nLocal cPed  \t:= \"\"  \r\nDefault aNfVinc \t:= {}\r\n\t\r\nSC5->( dbSetOrder(1) ) \r\nSC6->( dbSetOrder(1) ) \r\n\t     \r\nIf SC5->(MsSeek(xFilial(\"SC5\")+aNfVinc[1][9]))\r\n\tcNEmp:= Iif(SC5->(FieldPos(\"C5_NTEMPEN\")) > 0,Alltrim(SC5->C5_NTEMPEN),\"\")\r\nEndIf\r\n\t   \r\nIf SC6->(MsSeek(xFilial(\"SC6\")+aNfVinc[1][9]))\r\n\tcPed := AllTrim(SC6->C6_PEDCLI)\r\nEndIf   \r\n\t \r\n\taDadNfVi := {cNEmp,cPed,\"\"}\r\n \r\n\tRestArea( aAreaSC5 )\r\n\tRestArea( aAreaSC6 )\r\n\r\nReturn aDadNfVi\r\n\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} FiltEst\r\n\r\nRemove a citação á nota fiscal complementar que seja diferente do estado do emissor \r\n\r\n@param\t\taRef      Array que contém as notas de referência\r\n\r\n@param\t\tcEst\t   Estado do Emissor (obtido do SM0) \r\n\r\n@return     aRet    Possui notas de referência que podem ser citadas no xml (que são do mesmo estado que o emissor).\r\n                       \r\n@author Bruno Colisse\r\n@since 03/07/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function FiltEst(aRef, cEst)\r\nLocal i := 0\r\n\r\nLocal aRet := {}\r\n\r\nfor i := 1 to len(aRef)\r\n\tif aRef[i][6] == cEst\r\n\t\taAdd(aRet, aRef[i])\r\n\tendif\r\nNext\r\nReturn aRet\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} RetInfoSBZ\r\nRetorna a Unid. Medida da DIPI e o Fator de Conv. da DIPI da SBZ caso os parâmetro recebidos estejam vazios.\r\n\r\n@param  cProduto - Produto que será localizado na SBZ\r\n@param  cUmDipi  - Unid. Medida da DIPI\r\n@param  nConvDip - Fator de Conv. da DIPI\r\n                       \r\n@author  Rafael Tenorio da Costa\r\n@since   11/06/2019\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function RetInfoSBZ(cProduto, cUmDipi, nConvDip)\r\n\r\n    Local aArea := GetArea()\r\n\r\n    DbSelectArea(\"SBZ\")\r\n    SBZ->( DbSetOrder(1) )    //BZ_FILIAL+BZ_COD\r\n    If SBZ->( DbSeek(xFilial(\"SBZ\") + cProduto) )\r\n\r\n        If Empty(cUmDipi) .And. SBZ->( ColumnPos(\"BZ_UMDIPI\") ) > 0\r\n            cUmDipi := SBZ->BZ_UMDIPI\r\n        EndIf\r\n\r\n        If nConvDip == 0 .And. SBZ->( ColumnPos(\"BZ_CONVDIP\") ) > 0\r\n            nConvDip := SBZ->BZ_CONVDIP\r\n        EndIf\r\n    EndIf\r\n    \r\n    RestArea(aArea)\r\n\r\nReturn Nil\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} getCodLan\r\nValidação com a tabela 5.2 para enviar o codigo SEM CBENEF ou NULO de acordo com a UF\r\n\r\n@param  cUF \t- Estado que será validado\r\n@param  cCST \t- CST do produto informado\r\n@author  Bruno Seiji\r\n@since   14/08/2019\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nstatic function getCodLan( cUF, cCST, cAmbiente )\r\n\r\nlocal cCodlan\t\t:= \"\"\r\nlocal lSemCbenef\t:= .F.\r\ndefault cUF \t\t:= \"\"\r\ndefault cCST \t\t:= \"\"\r\ndefault cAmbiente\t:= \"2\"\r\n\r\nif !empty(cUF) .and. !empty(cCST)\r\n\r\n\tlSemCbenef := cAmbiente == \"2\"\r\n\r\n\tdo case\r\n\t\tcase cUF == \"PR\"\r\n\t\t\tif cCST == \"90\"\r\n\t\t\t\tcCodlan := \"SEM CBENEF\"\r\n\t\t\tendif\r\n\t\tcase cUF == \"RS\"\r\n\t\t\tcCodlan := \"SEM CBENEF\"\r\n\t\t\tif cCST <> \"90\" .and. date() > CTOD(\"09/08/2020\")\r\n\t\t\t\tcCodlan := \"\"\r\n\t\t\tendif\r\n\tendCase\r\n\r\nendif\r\n\r\nreturn cCodlan\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} SpecialChar\r\nLimpa os códigos ASCII faixa 127 a 255 que falham os EncodeUTF8\r\n\r\n@param  cString\t- xml\r\n@param  cString\t- Xml sem os os codigos da tabela asci que falham os EncodeUTF8.\r\n@author  Bruno Akyo\r\n@since   28/10/2019\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nstatic Function SpecialChar( cString )\r\nlocal nX     := 0\r\nlocal aChar  := {}\r\n\r\ndefault cString := \"\"\r\n\r\nif !empty( cString )\r\n    aAdd( aChar, 129)\r\n    aAdd( aChar, 141)\r\n    aAdd( aChar, 143)\r\n    aAdd( aChar, 144)\r\n    aAdd( aChar, 157)\r\n    for nX := 1 to len(aChar)\r\n        cString := StrTran( cString, Chr( aChar[nX] ), \".\" )\r\n    next\r\nendif\r\n\r\nreturn cString\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} PosiTriang\r\nVerifica se a operação se trata de uma triangulação\r\n\r\n@author  Felipe Sales Martinez\r\n@since   09/12/2019\r\n@version 1.0\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function PosiTriang(cAliasSD2)\r\nLocal lRet := .F.\r\nSD1->(DBSetOrder(4)) //D1_FILIAL+D1_NUMSEQ\r\nlRet := !Empty((cAliasSD2)->D2_IDENTB6) .And. SD1->(DBSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_IDENTB6)) .And. SD1->(D1_DOC+D1_SERIE+D1_COD) == (cAliasSD2)->(D2_NFORI+D2_SERIORI+D2_COD)\r\nReturn lRet\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} AjustaDest\r\nFunção para que quando mudar o cadastro de cliente referente ao grupo de destinatário na tabela AIF o mesmo busque dados da nota vinculada e retorna no array . \r\n@param  aDest \t - Array com o destinatário\r\n@param  aNfVinc  - Array com a nota vinculada\r\n@param  cCliefor - Fornecedor\r\n@param  cLoja    - Loja\r\n\r\n@return    aDest - Array aDeste contendo os dados da nota vinculada.\r\n\r\n@author  Valter da Silva\r\n@since   04/03/2020\r\n@version 1.0\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function AjustaDest(aDest,aNfVinc,cCliefor,cLoja)\r\n\tLocal   cAliasAIF\t:= getNextAlias()\r\n\tLocal   dDataEmis   := \"\"\r\n\tLocal   aDestVinc \t:= {}\r\n\tLocal   lDestVinc   := .F.\r\n\t\r\n\tDefault cCliefor\t:= \"\"\r\n\tDefault cLoja\t    := \"\"\r\n\tDefault aDest\t    := {}\r\n\tDefault aNfVinc\t    := {}\r\n    \r\n\tif !Empty(aNfVinc)\r\n\t\tdDataEmis:= aNfVinc[1][1]\r\n    \tdDataEmis:= Dtos(dDataEmis)\r\n\tendif\r\n\r\n\tBeginSql Alias cAliasAIF\r\n\tcolumn AIF_DATA as Date\r\n\r\n\tSELECT max(AIF_DATA) AIF_DATA\r\n\t\tFROM %Table:AIF% AIF\r\n\t\tWHERE\r\n\t\t\tAIF.AIF_FILIAL = %xFilial:AIF% AND\r\n\t\t\tAIF.AIF_FILTAB = %Exp:xFilial(\"SA1\")%  AND\r\n\t\t\tAIF.AIF_TABELA = %Exp:\"SA1\" % AND\r\n        \tAIF.AIF_CODIGO = %Exp:cCliefor%  AND\r\n\t\t\tAIF.AIF_LOJA   = %Exp:cLoja%  AND\r\n\t\t\tAIF.AIF_CAMPO  IN ('A1_NOME','A1_END','A1_COMPLEM','A1_BAIRRO',' A1_COD_MUN','A1_MUN','A1_EST','A1_CEP','A1_PAIS','A1_TEL','A1_EST','A1_INSCR','A1_SUFRAMA','A1_INSCRM','A1_CONTRIB','A1_IENCONT','A1_TIPO','A1_PFISICA','A1_EMAIL')  AND\r\n\t\t\tAIF.AIF_DATA >= %Exp:dDataEmis% AND\r\n\t\t\tAIF.%NotDel% \r\n\t\tEndSql\r\n\t\t\r\n\t\tif (cAliasAIF)->(!Eof()) .and. !empty((cAliasAIF)->AIF_DATA)\r\n\t\t\tlDestVinc:=.T.\t\r\n\t\tendif\r\n\t\t\r\n\t\t(cAliasAIF)->(DBCLOSEAREA())\r\n\t\t\r\n\t\tif lDestVinc\r\n    \t\taDestVinc:= NotaVinc(aNfVinc[1][2]+aNfVinc[1][3])\r\n            \r\n\t\t\tIf !Empty(aDestVinc)\r\n\t\t\t\taDest[02]  := aDestVinc[02] // - Nome\r\n\t\t\t\taDest[03]  := aDestVinc[03] // - Logradouro\r\n\t\t\t\taDest[04]  := aDestVinc[04] // - Número\r\n\t\t\t\taDest[05]  := aDestVinc[05] // - Complemento\r\n\t\t\t\taDest[06]  := aDestVinc[06] // - Bairro\r\n\t\t\t\taDest[07]  := aDestVinc[07] // - Código do município\r\n\t\t\t\taDest[08]  := aDestVinc[08] // - Nome do município\r\n\t\t\t\taDest[09]  := aDestVinc[09] // - Sigla da UF\r\n\t\t\t\taDest[10]  := aDestVinc[10] // - Código do CEP\r\n\t\t\t\taDest[11]  := aDestVinc[11] // - Código do País\r\n\t\t\t\taDest[12]  := aDestVinc[12] // - Nome do País\r\n\t\t\t\taDest[13]  := aDestVinc[13] // - Telefone\r\n\t\t\t\taDest[14]  := iif(EMPTY(aDestVinc[15]),'ISENTO',aDestVinc[15]) // - Inscrição Estadual do Destinatário\r\n\t\t\t\taDest[15]  := aDestVinc[16] // - Inscrição na SUFRAMA\r\n\t\t\t\taDest[19]  := aDestVinc[17] // - Inscrição Municipal do Tomador do Serviço\r\n\t\t\t\taDest[16]  := aDestVinc[18] // - Email\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\r\nReturn aDest\r\n\r\nStatic Function SortArray(aArray,nIni,nLen,bCompara)\r\nLocal i\r\nLocal nTam\r\n\r\nIf ValType(aArray) == \"A\" .AND. Len(aArray) > 0\r\n\r\n\tnTam := Int(log(Len(aArray))/log(10))+1\r\n\r\n\tFor i := 1 To Len(aArray)\r\n\t\taArray[i] := {aArray[i],StrZero(i,nTam)}\r\n\tNext i\r\n\r\n\tIf ValType(nAux := Eval(bCompara,aArray[1][1],aArray[1][1])) == \"N\" .AND. nAux == 0\r\n\t\taSort(aArray,nIni,nLen,{|X,Y| nAux := Eval(bCompara,X[1],Y[1]),If(nAux == 0,X[2]<Y[2],nAux > 0)})\r\n\tEndIf\r\n\r\n\tFor i := 1 To Len(aArray)\r\n\t\taArray[i] := aClone(aArray[i][1])\r\n\tNext i\r\n\r\nEndIf\r\n\r\nReturn aArray\r\n"}}}
Content-Length: 171
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO/nfesefaz.prw"}}}
Content-Length: 1463
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/A093ACOD.PRW","languageId":"advpl","version":1,"text":"#include 'TopConn.CH'\r\n#include 'RWMAKE.CH'\r\n#include 'TbiConn.CH'\r\n#INCLUDE \"PROTHEUS.CH\"    \r\n  \r\n/*                                          \r\nPrograma ...: A093ACOD.Prw\r\nUso ........: PROGRAMA PARA VALIDACAO DO CODIGO INTELIGENTE\r\nData .......: 14/01/19\r\nFeito por ..: Bruno Lage Ferreira \r\n*/\r\n\r\nUser Function A093ACOD()\r\n***********************************************************************************************************\r\n*  validacao do codigo inteligente\r\n*\r\n*** \r\n\r\nLocal cCodPrd := PARAMIXB[1]\r\nLocal cDesPrd := PARAMIXB[2]\r\nLocal aCod    := PARAMIXB[3]\r\nLocal aCodGrd := PARAMIXB[4]\r\nLocal lGera   := PARAMIXB[5]\r\nLocal aArea   := GetArea()\r\nLocal cNewCod := Nil       \r\nLocal cQuery  := \"\"\r\n\r\ncQuery := \" SELECT ISNULL(MAX(B1_COD),'\"+Substr(cCodPrd,1,4)+\"0000') AS B1_COD\r\ncQuery += \"   FROM SB1010\r\ncQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\ncQuery += \"    AND LEFT(B1_COD,4) = '\"+Substr(cCodPrd,1,4) +\"'\r\n         \r\nTcQuery cQuery Alias TRB_COD New\r\n\r\ndbSelectArea(\"TRB_COD\")\r\ndbGoTop()\r\n\r\ncNewCod := Soma1(alltrim(TRB_COD->B1_COD))\r\n\r\ndbSelectArea(\"TRB_COD\")\r\ndbCloseArea()\r\n     \r\nRestArea(aArea)\r\n\r\nReturn(cNewCod)\r\n\r\n\r\n\r\n"}}}
Content-Length: 167
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/A093ACOD.PRW"}}}
Content-Length: 230805
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/analise.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"PROTHEUS.CH\"\r\n#INCLUDE \"RWMAKE.CH\"\r\n#INCLUDE \"TOPCONN.CH\"\r\n#INCLUDE \"COLORS.CH\"\r\n#INCLUDE \"FONT.CH\"  \r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³ANALISE   ºAutor  ³Reinaldo Dias       º Data ³  19/08/2005 º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³ Rotina analisar movimentacao e saldo em estoque.           º±±\r\n±±º          ³ Controle de lote e localizacao ativo.                      º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ AP8                                                        º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nUser Function ANALISEST()            \r\nLocal oDlgMain    \r\nLocal aArea          := GetArea()\r\nLocal oNoMarked      := LoaDBitmap( GetResources(), \"LBNO\" )\r\nLocal oMarked        := LoaDBitmap( GetResources(), \"LBOK\" )\r\nPrivate cPict        := PesqPict('SB2','B2_QATU')\r\nPrivate cPict2UM     := PesqPict('SB2','B2_QTSEGUM')\r\nPrivate cPictD5      := PesqPict('SD5','D5_QUANT')\r\nPrivate cPictDB      := PesqPict('SDB','DB_QUANT')\r\nPrivate cPictB1      := PesqPict('SB1','B1_CONV')\r\nPrivate aDetSB8      := {}\r\nPrivate aDetSD5      := {}\r\nPrivate aDetSBF      := {}\r\nPrivate aDetSDB      := {}\r\nPrivate aDetSBJ      := {}\r\nPrivate aAnaSBJ      := {}\r\nPrivate aDetSBK      := {}\r\nPrivate aAnaSBK      := {}\r\nPrivate aDetDASDA    := {}\r\nPrivate aDetDASB8    := {}\r\nPrivate aDet01B8BF   := {}\r\nPrivate aDet02B8BF   := {}\r\nPrivate aKarLocal    := {}\r\nPrivate aKarLote     := {}\r\nPrivate aKarEnde     := {}                                               \r\n//Private aDocto       := {}\r\nPrivate aNumSeq      := {}\r\nPrivate cLocal       := Space(02)                                \r\nPrivate dDtProces    := dDataBase\r\nPrivate dUltFech     := dDataI := dDataF := CTOD(\"  /  /  \")\r\nPrivate nSB9         := 0\r\nPrivate nSBJ         := 0\r\nPrivate nSBK         := 0\r\nPrivate nKAR         := 0\r\nPrivate nSD5         := 0\r\nPrivate nSDB         := 0\r\nPrivate nSB2         := 0\r\nPrivate nSB8         := 0\r\nPrivate nSBF         := 0\r\nPrivate nSDA         := 0\r\nPrivate nDASB2       := 0\r\nPrivate nDASB8       := 0\r\nPrivate nSldKarLocal := nSldKarLote := nSldKarEnde := 0\r\nPrivate cProduto     := Space( TamSx3(\"B1_COD\")[1] )    \r\nPrivate cDescr       := Space( TamSx3(\"B1_DESC\")[1] )\r\nPrivate nOpSB8       := 1\r\nPrivate nOpSBF       := 1\r\nPrivate cMensagem    := \"\"\r\nPrivate cMensSB8     := \"\"\r\nPrivate cMensSBF     := \"\"        \r\nPrivate cCrlLot      := \"\"        \r\nPrivate cCrlEnd      := \"\"        \r\nPrivate c1UM         := \"\"\r\nPrivate c2UM         := \"\"\r\nPrivate nFatConv     := 0\r\nPrivate cTipConv     := \"\"\r\nPrivate cZona        := \"\"\r\nPrivate aSx3Box      := RetSx3Box(Posicione('SX3',2,'BE_STATUS','X3CBox()'),,,1)\r\nPrivate cMensB8BF    := \"\"\r\nPrivate cMensBJBK    := \"\"\r\nPrivate cMensDocto   := \"\"\r\nPrivate cMensNumSeq  := \"\"\r\nPrivate cMensDAB8    := \"\"\r\nPrivate _lReturn     := .F.\r\nPrivate oSB9    \r\nPrivate oSBJ    \r\nPrivate oSBK    \r\nPrivate oKAR    \r\nPrivate oSD5    \r\nPrivate oSDB    \r\nPrivate oSB2    \r\nPrivate oSB8    \r\nPrivate oSBF    \r\nPrivate oSDA    \r\nPrivate oDASB2  \r\nPrivate oDASB8  \r\nPrivate lNumLote := SuperGetMV('MV_LOTEUNI', .F., .F.)\r\n//Aadd(aDocto    ,{Space(06),Space(03),Space(06),Space(02),0,0,0,0,0,0,0,0,Space(03),Space(08),Space(03),Space(01),Space(01)})\r\n\r\n               //Data            ,Lote     ,Num.Lote ,Validade        ,Saldo,Qtde.Original,Status   ,Empenho,Qtde.2UM,Empenho 2UM\r\nAadd(aDetSB8   ,{CTOD(\"  /  /  \"),Space(10),Space(06),CTOD(\"  /  /  \"),0    ,0            ,Space(08),0      ,0       ,0})\r\n               //Data            ,TM       ,Lote     ,Num.Lote ,Validade        ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja\r\nAadd(aDetSD5   ,{CTOD(\"  /  /  \"),Space(03),Space(10),Space(06),CTOD(\"  /  /  \"),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n               //Localização,Lote    ,Quantidade,Status   ,Empenho,Estrutura,Status End,Zona     ,Qtde.2UM,Empenho 2UM\"\r\nAadd(aDetSBF   ,{Space(15)  ,Space(10),0        ,Space(08),0      ,Space(01),Space(01) ,Space(01),0       ,0          ,Space(01)})\r\n               //Origem   ,Data            ,TM       ,Localização,Lote     ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja \r\nAadd(aDetSDB   ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(15)  ,Space(10),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n               //Lote     ,Qtde.,Empenho,A Classificar,Qtde.2UM,Empenho 2UM,A Classificar 2UM,Status\r\nAadd(aDet01B8BF,{Space(10),0    ,0      ,0            ,0       ,0          ,0                ,Space(08)})\r\n               //Lote     ,Qtde.,Empenho,Qtde.2UM,Empenho 2UM,Status\r\nAadd(aDet02B8BF,{Space(10),0    ,0      ,0       ,0          ,Space(08)})\r\n\t           //Lote     ,Qtde.,Qtde.2UM,Status\r\nAadd(aDetSBJ   ,{Space(10),0    ,0       ,Space(08)})\r\n\t           //Lote     ,Nunlote  ,Validade        ,Quantidade\r\nAadd(aAnaSBJ   ,{Space(10),Space(06),CTOD(\"  /  /  \"),0         ,Space(08)})\r\n               //Lote     ,Qtde.,Qtde.2UM,Status\r\nAadd(aDetSBK   ,{Space(10),0    ,0       ,Space(08)})\r\n               //Endereco ,Lote     ,Quantidade\r\nAadd(aAnaSBK   ,{Space(15),Space(10),0         ,Space(08)})\r\n               //Data             ,Lote    ,A Classificar,Saldo,Qtde.Original,Num.Seq. ,Origem   ,Documento,Serie    ,Clie.For ,Loja     ,Status\r\nAadd(aDetDASDA ,{CTOD(\"  /  /  \"),Space(10),0            ,0    ,0            ,Space(06),Space(03),Space(06),Space(03),Space(06),Space(02),Space(08)})\r\n               //Data            ,Lote     ,Num.Lote,A Classificar,Qtde.Original,Origem   ,Documento,Serie    ,Clie.For ,Loja     ,Status\r\nAadd(aDetDASB8 ,{CTOD(\"  /  /  \"),Space(10),Space(06),0           ,0            ,Space(03),Space(06),Space(03),Space(06),Space(02),Space(08),Space(01)})\r\n               //Num.Seq. ,SD1,SD2,SD3_E,SD3_S,SD5_E,SD5_S,SDB_E,SDB_S,Origem   ,Status   ,Data            ,Documento,Serie    ,Clie.Forn,Loja     ,Serviço  ,Status Serviço,Serviço Pendente\r\nAadd(aNumSeq   ,{Space(06),0  ,0  ,0    ,0    ,0    ,0    ,0    ,0    ,Space(03),Space(08),CTOD(\"  /  /  \"),Space(06),Space(03),Space(06),Space(02),Space(03),Space(01)     ,Space(01)})\r\n               //Origem   ,Data            ,TES/TM   ,CFO      ,Documento,Quantidade,Saldo,Num.Seq.\r\nAAdd(aKarLocal ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(03),Space(06),0         ,0    ,Space(06)})\r\n               //Origem   ,Data            ,TM       ,Documento,Lote     ,Num.Lote ,Validade        ,Quantidade,Saldo,Num.Seq.\r\nAAdd(aKarLote  ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(06),Space(06),Space(08),CTOD(\"  /  /  \"),0         ,0    ,Space(30),Space(01)})\r\n               //Origem   ,Data            ,TM       ,Documento,Localização,Lote     ,Quantidade,Saldo,Num.Seq.\r\nAAdd(aKarEnde  ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(06),Space(15)  ,Space(10),0         ,0    ,Space(06),Space(01)})\r\n                                                                                                                 \r\nIF !fDigSenha()\r\n   Return\r\nEndif\r\n\r\nDEFINE MSDIALOG oDlgMain TITLE \"Analise de Saldos\"  OF oMainWnd PIXEL FROM 040,040 TO 650,1017\r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\nDEFINE FONT oBold2  NAME \"Arial\" SIZE 0, -40 BOLD\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\n@ 060,006 FOLDER oFolder OF oDlgMain PROMPT \"&Saldo\",\"SB8 x SD5\",\"SBF x SDB\",\"SB8 x SBF\",\"SBJ x SBK\",\"SBJ\",\"SBK\",\"SDA x SB2 x SB8\",\"Kardex por Local\",\"Kardex por Lote\",\"Kardex por Endereço\",\"Num.Seq.\" PIXEL SIZE 478,241\r\n//                                           01       02         03          04           05          06    07    08                09                 10                11                   12\r\n@ 014,010 SAY \"Produto\"                                 SIZE 040,10 PIXEL OF oDlgMain FONT oBold \r\n@ 010,040 MSGET oVar   VAR cProduto Picture \"@!\"        SIZE 060,10 PIXEL OF oDlgMain F3 \"SB1\" VALID(GetDescProd())\r\n@ 010,105 MSGET oVar   VAR cDescr   Picture \"@!\"        SIZE 176,10 PIXEL OF oDlgMain When .F.\r\n@ 032,010 SAY \"Local\"                                   SIZE 040,10 PIXEL OF oDlgMain FONT oBold \r\n@ 028,040 MSGET oVar   VAR cLocal Picture \"!!\"          SIZE 010,10 PIXEL OF oDlgMain VALID(GetDatas()) \r\n@ 049,010 SAY \"Limite\"                                  SIZE 070,10 PIXEL OF oDlgMain FONT oBold \r\n@ 045,040 MSGET oVar   VAR dDtProces Picture \"99/99/99\" SIZE 040,10 PIXEL OF oDlgMain VALID(GetDatas()) \r\n\r\n@ 032,095 SAY \"1 UM\"                                    SIZE 070,10 PIXEL OF oDlgMain FONT oBold\r\n@ 028,114 MSGET oVar   VAR c1UM      Picture \"@!\"       SIZE 015,10 PIXEL OF oDlgMain When .F.\r\n@ 032,150 SAY \"2 UM\"                                    SIZE 070,10 PIXEL OF oDlgMain FONT oBold\r\n@ 028,190 MSGET oVar   VAR c2UM      Picture \"@!\"       SIZE 015,10 PIXEL OF oDlgMain When .F.\r\n@ 032,210 SAY \"Fat.Conv.\"                               SIZE 070,10 PIXEL OF oDlgMain FONT oBold\r\n@ 028,240 MSGET oVar   VAR cTipConv  Picture \"!\"        SIZE 008,10 PIXEL OF oDlgMain When .F.\r\n@ 028,251 MSGET oVar   VAR nFatConv  Picture cPictB1    SIZE 030,10 PIXEL OF oDlgMain When .F.\r\n\r\n@ 014,300 SAY \"Ultimo Fechamento\"                       SIZE 070,10 PIXEL OF oDlgMain FONT oBold \r\n@ 010,365 MSGET oVar   VAR dUltFech  Picture \"99/99/99\" SIZE 040,10 PIXEL OF oDlgMain When .F.\r\n@ 029,300 SAY \"Data Inicial\"                            SIZE 070,10 PIXEL OF oDlgMain FONT oBold \r\n@ 025,365 MSGET oVar   VAR dDataI    Picture \"99/99/99\" SIZE 040,10 PIXEL OF oDlgMain When .F.\r\n@ 044,300 SAY \"Data Final\"                              SIZE 070,10 PIXEL OF oDlgMain FONT oBold \r\n@ 040,365 MSGET oVar   VAR dDataF    Picture \"99/99/99\" SIZE 040,10 PIXEL OF oDlgMain When .F.\r\n\r\n@ 049,095 SAY \"Lote\"                                    SIZE 040,10 PIXEL OF oDlgMain FONT oBold \r\n@ 045,114 MSGET oVar   VAR cCrlLot   Picture \"@!\"       SIZE 025,10 PIXEL OF oDlgMain When .F.\r\n@ 049,150 SAY \"Localização\"                             SIZE 040,10 PIXEL OF oDlgMain FONT oBold \r\n@ 045,190 MSGET oVar   VAR cCrlEnd   Picture \"@!\"       SIZE 015,10 PIXEL OF oDlgMain When .F.\r\n@ 049,210 SAY \"Zona\"                                    SIZE 040,10 PIXEL OF oDlgMain FONT oBold \r\n@ 045,240 MSGET oVar   VAR cZona     Picture \"@!\"       SIZE 041,10 PIXEL OF oDlgMain When .F.\r\n\r\n@ 022,015 TO 087, 095 PROMPT \"Saldo Inicial\"             PIXEL OF oFolder:aDialogs[1]\r\n@ 034,020 SAY \"SB9\"                          SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 030,035 MSGET oSB9  VAR nSB9 Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F. \r\n@ 054,020 SAY \"SBJ\"                          SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 050,035 MSGET oSBJ  VAR nSBJ Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F.\r\n@ 074,020 SAY \"SBK\"                          SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 070,035 MSGET oSBK  VAR nSBK Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F.\r\n\r\n@ 022,115 TO 087, 195 PROMPT \"Saldo Movimentação\"        PIXEL OF oFolder:aDialogs[1]\r\n@ 034,120 SAY \"KAR\"                          SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 030,135 MSGET oKAR  VAR nKAR Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F. \r\n@ 054,120 SAY \"SD5\"                          SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 050,135 MSGET oSD5  VAR nSD5 Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F.\r\n@ 074,120 SAY \"SDB\"                          SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 070,135 MSGET oSDB  VAR nSDB Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F.\r\n  \r\n@ 022,215 TO 087, 295 PROMPT \"Saldo Atual\"               PIXEL OF oFolder:aDialogs[1] \r\n@ 034,220 SAY \"SB2\"                          SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 030,235 MSGET oSB2  VAR nSB2 Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F. \r\n@ 054,220 SAY \"SB8\"                          SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 050,235 MSGET oSB8  VAR nSB8 Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F.\r\n@ 074,220 SAY \"SBF\"                          SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 070,235 MSGET oSBF  VAR nSBF Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F.\r\n\r\n@ 022,315 TO 167, 440 PROMPT \"Divergencias\"              PIXEL OF oFolder:aDialogs[1] \r\n@ 034,320 SAY cMensBJBK                      SIZE 120,10 PIXEL OF oFolder:aDialogs[1] FONT oBold  COLOR CLR_HRED\r\n@ 054,320 SAY cMensB8BF                      SIZE 120,10 PIXEL OF oFolder:aDialogs[1] FONT oBold  COLOR CLR_HRED\r\n@ 074,320 SAY cMensDAB8                      SIZE 120,10 PIXEL OF oFolder:aDialogs[1] FONT oBold  COLOR CLR_HRED\r\n@ 094,320 SAY cMensDocto                     SIZE 120,10 PIXEL OF oFolder:aDialogs[1] FONT oBold  COLOR CLR_HRED\r\n@ 114,320 SAY cMensNumSeq                    SIZE 120,10 PIXEL OF oFolder:aDialogs[1] FONT oBold  COLOR CLR_HRED\r\n@ 134,320 SAY cMensSB8                       SIZE 120,10 PIXEL OF oFolder:aDialogs[1] FONT oBold  COLOR CLR_HRED\r\n@ 154,320 SAY cMensSBF                       SIZE 120,10 PIXEL OF oFolder:aDialogs[1] FONT oBold  COLOR CLR_HRED\r\n\r\n//@ 220,002 SAY \"Sugestões e melhorias para Reinaldo Dias e-mail: rdias@totvs.com.br\"   SIZE 200,10 PIXEL OF oFolder:aDialogs[1] FONT oBold  COLOR CLR_HBLUE\r\n//@ 220,410 SAY \"Versão: 25/06/2009\"                                                    SIZE 200,10 PIXEL OF oFolder:aDialogs[1] FONT oBold  COLOR CLR_HBLUE\r\n                                                                          \r\n@ 102,015 TO 167, 095 PROMPT \"Saldo a Classificar\"         PIXEL OF oFolder:aDialogs[1] \r\n@ 114,020 SAY \"SB2\"                             SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 110,035 MSGET oDASB2 VAR nDASB2 Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F. \r\n@ 134,020 SAY \"SB8\"                             SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 130,035 MSGET oDASB8 VAR nDASB8 Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F.\r\n@ 154,020 SAY \"SDA\"                             SIZE 015,10 PIXEL OF oFolder:aDialogs[1] FONT oBold \r\n@ 150,035 MSGET oSDA   VAR nSDA   Picture cPict SIZE 050,10 PIXEL OF oFolder:aDialogs[1] When .F.\r\n\r\n@ 102,115 TO 167, 295 PROMPT \"Status do Saldo\"             PIXEL OF oFolder:aDialogs[1]                                      \r\n\r\n@ 120,134 SAY oSay VAR cMensagem                       SIZE 200,50 PIXEL OF oFolder:aDialogs[1] FONT oBold2 COLOR CLR_HBLUE \r\n\r\n/*\r\n@ 022,315 LISTBOX oBox Var cFolder FIELDS HEADER \" \", \"Folder\") SIZE 090,120 ON DBLCLICK (TrocaTip()) PIXEL OF oFolder:aDialogs[1] \r\noBox:nFreeze := 1\r\noBox:SetArray(aFolder)\r\noBox:bLine:={ ||{IIF(aFolder[oBox:nAT,1],oMarked,oNoMarked),aFolder[oBox:nAT,2]}}\r\n\r\n@ 030,410 BUTTON  \"Marcar Todos\")    SIZE 50,12 ACTION MarcaTodos(.T.) PIXEL OF oFolder:aDialogs[1]\r\n@ 050,410 BUTTON  \"Desmarcar Todos\") SIZE 50,12 ACTION MarcaTodos(.F.) PIXEL OF oFolder:aDialogs[1]\r\n*/\r\n\r\n@ 005,015 BUTTON  \"Alterar SB9\" SIZE 50,12 ACTION fAjustSB9(\"SALDO_SB9\") PIXEL OF oFolder:aDialogs[1]\r\n@ 005,115 BUTTON  \"Saldo Atual\" SIZE 50,12 ACTION fSaldoAtual()          PIXEL OF oFolder:aDialogs[1]\r\n@ 005,215 BUTTON  \"Alterar SB2\" SIZE 50,12 ACTION fAjustSB2(\"SALDO_SB2\") PIXEL OF oFolder:aDialogs[1]\r\n\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 02\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SB8            \r\ncB8xD5 := \"B8=>D5\"\r\n@ 003,005 SAY \"SB8\"                SIZE 200,50                                                     PIXEL OF oFolder:aDialogs[2] FONT oBold\r\n@ 001,030 BUTTON \"SB8 => SD5\"      SIZE 30,10 ACTION (cB8xD5 := \"B8=>D5\",Processa({||fDetaSB8()})) PIXEL OF oFolder:aDialogs[2]\r\n@ 001,075 BUTTON \"Incluir\"         SIZE 30,10 ACTION (fAjustSB8(\"B8_I\"))                           PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 001,120 BUTTON \"Alterar\"         SIZE 30,10 ACTION (fAjustSB8(\"B8_A\"))                           PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 001,165 BUTTON \"Excluir\"         SIZE 30,10 ACTION (fAjustSB8(\"B8_E\"))                           PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 001,320 BUTTON \"Lote e Num.Lote\"  SIZE 40,10 ACTION (nOpSB8:= 1,Processa({||fDetaSB8()}))         PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=2,.T.,.F.)\r\n@ 001,375 BUTTON \"Lote\"            SIZE 30,10 ACTION (nOpSB8:= 2,Processa({||fDetaSB8()}))         PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 001,420 BUTTON \"Pesquisar\"       SIZE 30,10 ACTION (fPesquisa(\"SB8\",oDetSB8))                    PIXEL OF oFolder:aDialogs[2]\r\n@ 010,005 LISTBOX oDetSB8 Var cModelo FIELDS HEADER; \r\n     \"Data\"   ,;\r\n     \"Lote\"   ,;\r\n\t \"Num.Lote\" ,;\r\n\t \"Validade\" ,;\r\n\t \"Saldo\" ,;\r\n\t \"Qtde.Original\" ,; \r\n\t \"Status\" ,;\r\n\t \"Empenho\" ,;\t\t\t\r\n\t \"Qtde.2UM\" ,;\t\r\n\t \"Empenho 2UM\" FIELDSIZES 30,40,30,30,40,40,35,40,40,40 SIZE 467,110 ON DBLCLICK () PIXEL OF oFolder:aDialogs[2]\r\n   \t oDetSB8:SetArray(aDetSB8)\r\n     oDetSB8:bLDblClick := {|| Processa({||fMontaSD5()})} \r\n\t oDetSB8:bLine:={ ||{aDetSB8[oDetSB8:nAT,1],aDetSB8[oDetSB8:nAT,2],aDetSB8[oDetSB8:nAT,3],aDetSB8[oDetSB8:nAT,4],aDetSB8[oDetSB8:nAT,5],aDetSB8[oDetSB8:nAT,6],aDetSB8[oDetSB8:nAT,7],aDetSB8[oDetSB8:nAT,8],aDetSB8[oDetSB8:nAT,9],aDetSB8[oDetSB8:nAT,10]}}\r\n\t oDetSB8:Refresh()\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SD5\r\n@ 123,005 SAY \"SD5\"                 SIZE 200,50                                                     PIXEL OF oFolder:aDialogs[2] FONT oBold\r\n@ 121,030 BUTTON \"SD5 => SB8\"       SIZE 30,10 ACTION (cB8xD5 := \"D5=>B8\",Processa({||fDetaSD5()})) PIXEL OF oFolder:aDialogs[2]\r\n@ 121,075 BUTTON \"Incluir D5\"       SIZE 30,10 ACTION (fAjustSD5(\"D5_I\",\"02\"))                      PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 121,120 BUTTON \"Alterar D5\"       SIZE 30,10 ACTION (fAjustSD5(\"D5_A\",\"02\"))                      PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 121,165 BUTTON \"Excluir D5\"       SIZE 30,10 ACTION (fAjustSD5(\"D5_E\",\"02\"))                      PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 121,210 BUTTON \"Incluir D5+B8\"    SIZE 40,10 ACTION (fAjustSD5(\"D5+B8_I\",\"02\"))                   PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 121,265 BUTTON \"Subtrair D5+B8\"   SIZE 40,10 ACTION (fAjustSD5(\"D5+B8_S\",\"02\"))                   PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 121,320 BUTTON \"Estornar D5+B8\"   SIZE 40,10 ACTION (fAjustSD5(\"D5+B8_E\",\"02\"))                   PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 121,375 BUTTON \"Analisar\"         SIZE 30,10 ACTION (Processa({||fMontaSB8(.F.)}))                PIXEL OF oFolder:aDialogs[2] When IF(nOpSB8=1,.T.,.F.)\r\n@ 121,420 BUTTON \"Pesquisar\"        SIZE 30,10 ACTION (fPesquisa(\"SD5\",oDetSD5))                    PIXEL OF oFolder:aDialogs[2]\r\n\r\n@ 130,005 LISTBOX oDetSD5 Var cDetSD5 FIELDS HEADER; \r\n     \"Data\" ,;\r\n\t \"TM\" ,;\r\n     \"Lote\" ,;\r\n\t \"Num.Lote\" ,;\r\n\t \"Validade\" ,;\r\n\t \"Quantidade\" ,;\t\r\n\t \"Saldo\" ,;\r\n\t \"Num.Seq.\" ,;\r\n\t \"Status\" ,;\r\n     \"Documento\" ,;\r\n     \"Serie\" ,;\r\n     \"Clie.For\" ,;\r\n     \"Loja\" FIELDSIZES 30,15,40,30,30,40,40,30,35,32,20,30,20 SIZE 467,095 ON DBLCLICK () PIXEL OF oFolder:aDialogs[2]\r\n\t oDetSD5:SetArray(aDetSD5)\r\n     oDetSD5:bLDblClick := {|| Processa({||fMontaSB8(.T.)})} \r\n\t oDetSD5:bLine:={ ||{aDetSD5[oDetSD5:nAT,1],aDetSD5[oDetSD5:nAT,2],aDetSD5[oDetSD5:nAT,3],aDetSD5[oDetSD5:nAT,4],aDetSD5[oDetSD5:nAT,5],aDetSD5[oDetSD5:nAT,6],aDetSD5[oDetSD5:nAT,7],aDetSD5[oDetSD5:nAT,8],aDetSD5[oDetSD5:nAT,9],aDetSD5[oDetSD5:nAT,10],aDetSD5[oDetSD5:nAT,11],aDetSD5[oDetSD5:nAT,12],aDetSD5[oDetSD5:nAT,13]}}\r\n\t oDetSD5:Refresh()\r\n\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 03\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SBF\r\ncBFxDB := \"BF=>DB\"\r\n@ 003,005 SAY \"SBF\"                SIZE 200,50                                                     PIXEL OF oFolder:aDialogs[3] FONT oBold\r\n@ 001,030 BUTTON \"SBF => SDB\"      SIZE 30,10 ACTION (cBFxDB := \"BF=>DB\",Processa({||fDetaSBF()})) PIXEL OF oFolder:aDialogs[3]\r\n@ 001,075 BUTTON \"Incluir\"         SIZE 30,10 ACTION (fAjustSBF(\"BF_I\"))                           PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 001,120 BUTTON \"Alterar\"         SIZE 30,10 ACTION (fAjustSBF(\"BF_A\"))                           PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 001,165 BUTTON \"Excluir\"         SIZE 30,10 ACTION (fAjustSBF(\"BF_E\"))                           PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 001,420 BUTTON \"Pesquisar\"       SIZE 30,10 ACTION (fPesquisa(\"SBF\",oDetSBF))                    PIXEL OF oFolder:aDialogs[3]\r\n@ 010,005 LISTBOX oDetSBF Var cModelo FIELDS HEADER; \r\n     \"Localização\",;\r\n\t \"Lote\" ,;\r\n\t \"Quantidade\" ,;\r\n\t \"Status\" ,;\r\n\t \"Empenho\" ,;\t\t\t\r\n\t \"Estrutura\" ,;\r\n\t \"Status End\" ,;\r\n\t \"Zona\" ,;\r\n\t \"Qtde.2UM\" ,;\t\r\n\t \"Empenho 2UM\" FIELDSIZES 50,40,40,35,40,60,40,30,40,40 SIZE 467,110 ON DBLCLICK () PIXEL OF oFolder:aDialogs[3]\r\n  \t oDetSBF:SetArray(aDetSBF)\r\n    oDetSBF:bLDblClick := {|| Processa({||fMontaSDB()})} \r\n\t oDetSBF:bLine:={ ||{aDetSBF[oDetSBF:nAT,1],aDetSBF[oDetSBF:nAT,2],aDetSBF[oDetSBF:nAT,3],aDetSBF[oDetSBF:nAT,4],aDetSBF[oDetSBF:nAT,5],aDetSBF[oDetSBF:nAT,6],aDetSBF[oDetSBF:nAT,7],aDetSBF[oDetSBF:nAT,8],aDetSBF[oDetSBF:nAT,9],aDetSBF[oDetSBF:nAT,10]}}\r\n\t oDetSBF:Refresh()\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SDB\r\n@ 123,005 SAY \"SDB\"                 SIZE 200,50                                                     PIXEL OF oFolder:aDialogs[3] FONT oBold\r\n@ 121,030 BUTTON \"SDB => SBF\"       SIZE 30,10 ACTION (cBFxDB := \"DB=>BF\",Processa({||fDetaSDB()})) PIXEL OF oFolder:aDialogs[3]\r\n@ 121,075 BUTTON \"Incluir DB\"       SIZE 30,10 ACTION (fAjustSDB(\"DB_I\",\"03\"))                      PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 121,120 BUTTON \"Alterar DB\"       SIZE 30,10 ACTION (fAjustSDB(\"DB_A\",\"03\"))                      PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 121,165 BUTTON \"Excluir DB\"       SIZE 30,10 ACTION (fAjustSDB(\"DB_E\",\"03\"))                      PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 121,210 BUTTON \"Incluir DB+BF\"    SIZE 40,10 ACTION (fAjustSDB(\"DB+BF_I\",\"03\"))                   PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 121,265 BUTTON \"Subtrair DB+BF\"   SIZE 40,10 ACTION (fAjustSDB(\"DB+BF_S\",\"03\"))                   PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 121,320 BUTTON \"Estornar DB+BF\"   SIZE 40,10 ACTION (fAjustSDB(\"DB+BF_E\",\"03\"))                   PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 121,375 BUTTON \"Analisar\"         SIZE 30,10 ACTION (Processa({||fMontaSBF(.F.)}))                PIXEL OF oFolder:aDialogs[3] When IF(nOpSBF=1,.T.,.F.)\r\n@ 121,420 BUTTON \"Pesquisar\"        SIZE 30,10 ACTION (fPesquisa(\"SDB\",oDetSDB))                    PIXEL OF oFolder:aDialogs[3]\r\n@ 130,005 LISTBOX oDetSDB Var cDetSDB FIELDS HEADER; \r\n\t \"Origem\" ,;\r\n     \"Data\" ,;\r\n\t \"TM\" ,;\r\n\t \"Localização\" ,;\r\n     \"Lote\" ,;\r\n\t \"Quantidade\" ,;\t\r\n\t \"Saldo\" ,;\r\n\t \"Num.Seq.\" ,;\r\n     \"Status\" ,;\t\r\n     \"Documento\" ,;\r\n     \"Serie\" ,;\r\n     \"Clie.For\" ,;\r\n     \"Loja\" FIELDSIZES 25,30,15,50,40,40,40,30,35,32,20,30,20 SIZE 467,095 ON DBLCLICK () PIXEL OF oFolder:aDialogs[3]\r\n\t oDetSDB:SetArray(aDetSDB)\r\n     oDetSDB:bLDblClick := {|| Processa({||fMontaSBF(.T.)})} \r\n\t oDetSDB:bLine:={ ||{aDetSDB[oDetSDB:nAT,1],aDetSDB[oDetSDB:nAT,2],aDetSDB[oDetSDB:nAT,3],aDetSDB[oDetSDB:nAT,4],aDetSDB[oDetSDB:nAT,5],aDetSDB[oDetSDB:nAT,6],aDetSDB[oDetSDB:nAT,7],aDetSDB[oDetSDB:nAT,8],aDetSDB[oDetSDB:nAT,9],aDetSDB[oDetSDB:nAT,10],aDetSDB[oDetSDB:nAT,11],aDetSDB[oDetSDB:nAT,12],aDetSDB[oDetSDB:nAT,13]}}\r\n \t oDetSDB:Refresh()\r\n\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 04\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SB8\r\n@ 003,005 SAY \"SB8\"                SIZE 200,50                                          PIXEL OF oFolder:aDialogs[4] FONT oBold\r\n@ 001,420 BUTTON \"Processar\"       SIZE 30,10 ACTION (Processa({||fDetaB8BF()}))        PIXEL OF oFolder:aDialogs[4]\r\n@ 010,005 LISTBOX oDet01B8BF Var cModelo FIELDS HEADER; \r\n\t \"Lote\" ,;\r\n\t \"Qtde.\" ,;\r\n\t \"Empenho\" ,;\r\n\t \"A Classificar\" ,;\r\n\t \"Qtde.2UM\" ,;\r\n\t \"Empenho 2UM\" ,;\r\n\t \"A Classificar 2UM\" ,;\r\n\t \"Status\" FIELDSIZES 40,40,40,40,40,40,40,35 SIZE 467,110 ON DBLCLICK () PIXEL OF oFolder:aDialogs[4]\r\n   \t oDet01B8BF:SetArray(aDet01B8BF)\r\n\t oDet01B8BF:bLine:={ ||{aDet01B8BF[oDet01B8BF:nAT,1],aDet01B8BF[oDet01B8BF:nAT,2],aDet01B8BF[oDet01B8BF:nAT,3],aDet01B8BF[oDet01B8BF:nAT,4],aDet01B8BF[oDet01B8BF:nAT,5],aDet01B8BF[oDet01B8BF:nAT,6],aDet01B8BF[oDet01B8BF:nAT,7],aDet01B8BF[oDet01B8BF:nAT,8]}}\r\n\t oDet01B8BF:Refresh()\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SBF\r\n@ 123,005 SAY \"SBF\"                   SIZE 200,50 PIXEL OF oFolder:aDialogs[4] FONT oBold\r\n@ 130,005 LISTBOX oDet02B8BF Var cDet02B8BF FIELDS HEADER; \r\n     \"Lote\" ,;\r\n\t \"Qtde.\" ,;\r\n\t \"Empenho\" ,;\r\n\t \"Qtde.2UM\" ,;\r\n\t \"Empenho 2UM\" ,;\r\n     \"Status\" FIELDSIZES 40,40,40,40,40,35 SIZE 467,095 ON DBLCLICK () PIXEL OF oFolder:aDialogs[4]\r\n\t oDet02B8BF:SetArray(aDet02B8BF)\r\n\t oDet02B8BF:bLine:={ ||{aDet02B8BF[oDet02B8BF:nAT,1],aDet02B8BF[oDet02B8BF:nAT,2],aDet02B8BF[oDet02B8BF:nAT,3],aDet02B8BF[oDet02B8BF:nAT,4],aDet02B8BF[oDet02B8BF:nAT,5],aDet02B8BF[oDet02B8BF:nAT,6]}}\r\n\t oDet02B8BF:Refresh()\r\n\r\n\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 05\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SBJ\r\n@ 003,005 SAY \"SBJ\"                 SIZE 200,50                                                         PIXEL OF oFolder:aDialogs[5] FONT oBold\r\n@ 001,420 BUTTON \"Processar\"        SIZE 30,10 ACTION (Processa({||fDetaBJBK(),fDetaSBJ(),fDetaSBK()})) PIXEL OF oFolder:aDialogs[5]\r\n@ 010,005 LISTBOX oDetSBJ Var cModelo FIELDS HEADER; \r\n\t \"Lote\" ,;\r\n\t \"Qtde.\" ,;\r\n\t \"Qtde.2UM\" ,;\r\n\t \"Status\" FIELDSIZES 40,40,40,35 SIZE 467,110 ON DBLCLICK () PIXEL OF oFolder:aDialogs[5]\r\n\t oDetSBJ:SetArray(aDetSBJ)\r\n\t oDetSBJ:bLine:={ ||{aDetSBJ[oDetSBJ:nAT,1],aDetSBJ[oDetSBJ:nAT,2],aDetSBJ[oDetSBJ:nAT,3],aDetSBJ[oDetSBJ:nAT,4]}}\r\n\t oDetSBJ:Refresh()\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SBK\r\n@ 123,005 SAY \"SBK\"                   SIZE 200,50 PIXEL OF oFolder:aDialogs[5] FONT oBold\r\n@ 130,005 LISTBOX oDetSBK Var cDet02B8BK FIELDS HEADER; \r\n     \"Lote\" ,;\r\n\t \"Qtde.\" ,;\r\n\t \"Qtde.2UM\" ,;\r\n\t \"Status\" FIELDSIZES 40,40,40,35 SIZE 467,095 ON DBLCLICK () PIXEL OF oFolder:aDialogs[5]\r\n\t oDetSBK:SetArray(aDetSBK)\r\n\t oDetSBK:bLine:={ ||{aDetSBK[oDetSBK:nAT,1],aDetSBK[oDetSBK:nAT,2],aDetSBK[oDetSBK:nAT,3],aDetSBK[oDetSBK:nAT,4]}}\r\n\t oDetSBK:Refresh()\r\n\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 06\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SBJ\r\n@ 003,005 SAY \"SBJ\"                SIZE 200,50                                  PIXEL OF oFolder:aDialogs[6] FONT oBold\r\n@ 001,210 BUTTON \"Incluir\"         SIZE 30,10 ACTION (fAjustSBJ(\"BJ_I\"))        PIXEL OF oFolder:aDialogs[6]\r\n@ 001,265 BUTTON \"Alterar\"         SIZE 30,10 ACTION (fAjustSBJ(\"BJ_A\"))        PIXEL OF oFolder:aDialogs[6]\r\n@ 001,320 BUTTON \"Excluir\"         SIZE 30,10 ACTION (fAjustSBJ(\"BJ_E\"))        PIXEL OF oFolder:aDialogs[6]\r\n@ 001,375 BUTTON \"Processar\"       SIZE 30,10 ACTION (Processa({||fDetaSBJ()})) PIXEL OF oFolder:aDialogs[6]\r\n@ 001,420 BUTTON \"Pesquisar\"       SIZE 30,10 ACTION (fPesquisa(\"SBJ\",oAnaSBJ)) PIXEL OF oFolder:aDialogs[6]\r\n@ 010,005 LISTBOX oAnaSBJ Var cModelo FIELDS HEADER; \r\n\t \"Lote\" ,;\r\n\t \"Nunlote\" ,;\r\n\t \"Validade\" ,;\r\n\t \"Quantidade\" FIELDSIZES 40,30,30,40 SIZE 467,215 ON DBLCLICK () PIXEL OF oFolder:aDialogs[6]\r\n\t oAnaSBJ:SetArray(aAnaSBJ)\r\n\t oAnaSBJ:bLine:={ ||{aAnaSBJ[oAnaSBJ:nAT,1],aAnaSBJ[oAnaSBJ:nAT,2],aAnaSBJ[oAnaSBJ:nAT,3],aAnaSBJ[oAnaSBJ:nAT,4]}}\r\n     oAnaSBJ:Refresh()\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 07\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SBK\r\n@ 123,005 SAY \"SBK\"                SIZE 200,50                                  PIXEL OF oFolder:aDialogs[7] FONT oBold\r\n@ 001,210 BUTTON \"Incluir\"         SIZE 30,10 ACTION (fAjustSBK(\"BK_I\"))        PIXEL OF oFolder:aDialogs[7]\r\n@ 001,265 BUTTON \"Alterar\"         SIZE 30,10 ACTION (fAjustSBK(\"BK_A\"))        PIXEL OF oFolder:aDialogs[7]\r\n@ 001,320 BUTTON \"Excluir\"         SIZE 30,10 ACTION (fAjustSBK(\"BK_E\"))        PIXEL OF oFolder:aDialogs[7]\r\n@ 001,375 BUTTON \"Processar\"       SIZE 30,10 ACTION (Processa({||fDetaSBK()})) PIXEL OF oFolder:aDialogs[7] \r\n@ 001,420 BUTTON \"Pesquisar\"       SIZE 30,10 ACTION (fPesquisa(\"SBK\",oAnaSBK)) PIXEL OF oFolder:aDialogs[7]\r\n@ 010,005 LISTBOX oAnaSBK Var cDet02B8BK FIELDS HEADER; \r\n     \"Endereco\" ,;\r\n     \"Lote\" ,;\r\n\t \"Quantidade\" FIELDSIZES 50,40,40 SIZE 467,215 ON DBLCLICK () PIXEL OF oFolder:aDialogs[7]\r\n\t oAnaSBK:SetArray(aAnaSBK)\r\n\t oAnaSBK:bLine:={ ||{aAnaSBK[oAnaSBK:nAT,1],aAnaSBK[oAnaSBK:nAT,2],aAnaSBK[oAnaSBK:nAT,3]}}\r\n     oAnaSBK:Refresh()\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 08\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SDAxsSB2xSB8\r\n@ 003,005 SAY \"SDA\"                                SIZE 200,50                                    PIXEL OF oFolder:aDialogs[8] FONT oBold\r\n@ 003,070 SAY \"Saldo a Classificar no SB2 : \"+Trans(nDASB2,cPict)   SIZE 200,50                   PIXEL OF oFolder:aDialogs[8] FONT oBold\r\n@ 001,220 BUTTON \"Alterar no SB2\"                  SIZE 45,10 ACTION (fAjustSB2(\"CLASS_SB2\"))     PIXEL OF oFolder:aDialogs[8] \r\n@ 001,320 BUTTON \"Alterar no SDA\"                  SIZE 45,10 ACTION (fAjustSDA(\"SDA\"))           PIXEL OF oFolder:aDialogs[8] \r\n@ 001,420 BUTTON \"Processar\"                       SIZE 30,10 ACTION (Processa({||fDetaSDA(),fDetaDASB8()})) PIXEL OF oFolder:aDialogs[8] \r\n@ 010,005 LISTBOX oDetDASDA Var cModelo FIELDS HEADER; \r\n     \"Data\" ,;\r\n     \"Lote\" ,;\r\n\t \"A Classificar\" ,;\t\r\n\t \"Saldo\" ,;\r\n\t \"Qtde.Original\" ,;\t\r\n\t \"Num.Seq.\" ,;\r\n\t \"Origem\" ,;\r\n     \"Documento\" ,;\r\n     \"Serie\" ,;\r\n     \"Clie.For\" ,;\r\n     \"Loja\" ,; \r\n     \"Status\" FIELDSIZES 30,40,40,40,40,30,25,32,20,30,20,35 SIZE 467,110 ON DBLCLICK () PIXEL OF oFolder:aDialogs[8]\r\n\t oDetDASDA:SetArray(aDetDASDA)\r\n\t oDetDASDA:bLine:={ ||{aDetDASDA[oDetDASDA:nAT,1],aDetDASDA[oDetDASDA:nAT,2],aDetDASDA[oDetDASDA:nAT,3],aDetDASDA[oDetDASDA:nAT,4],aDetDASDA[oDetDASDA:nAT,5],aDetDASDA[oDetDASDA:nAT,6],aDetDASDA[oDetDASDA:nAT,7],aDetDASDA[oDetDASDA:nAT,8],aDetDASDA[oDetDASDA:nAT,9],aDetDASDA[oDetDASDA:nAT,10],aDetDASDA[oDetDASDA:nAT,11],aDetDASDA[oDetDASDA:nAT,12]}}\r\n\t oDetDASDA:Refresh()\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Detalhe do SDAxsSB2xSB8\r\n@ 123,005 SAY \"SB8\"            SIZE 200,50                              PIXEL OF oFolder:aDialogs[8] FONT oBold\r\n@ 121,420 BUTTON \"Alterar\"     SIZE 30,10 ACTION (fAjustDAB8(\"DAxB8\"))  PIXEL OF oFolder:aDialogs[8]\r\n@ 130,005 LISTBOX oDetDASB8 Var cDet02B8BK FIELDS HEADER; \r\n     \"Data\" ,;\r\n     \"Lote\" ,;\r\n     \"Num.Lote\" ,;\r\n\t \"A Classificar\" ,;\t\r\n\t \"Qtde.Original\" ,;\t\r\n\t \"Origem\" ,;\r\n     \"Documento\" ,;\r\n     \"Serie\" ,;\r\n     \"Clie.For\" ,;\r\n     \"Loja\" ,; \r\n     \"Status\" FIELDSIZES 30,40,30,40,40,25,32,20,30,20,35  SIZE 467,095 ON DBLCLICK () PIXEL OF oFolder:aDialogs[8]\r\n\t oDetDASB8:SetArray(aDetDASB8)\r\n\t oDetDASB8:bLine:={ ||{aDetDASB8[oDetDASB8:nAT,1],aDetDASB8[oDetDASB8:nAT,2],aDetDASB8[oDetDASB8:nAT,3],aDetDASB8[oDetDASB8:nAT,4],aDetDASB8[oDetDASB8:nAT,5],aDetDASB8[oDetDASB8:nAT,6],aDetDASB8[oDetDASB8:nAT,7],aDetDASB8[oDetDASB8:nAT,8],aDetDASB8[oDetDASB8:nAT,9],aDetDASB8[oDetDASB8:nAT,10],aDetDASB8[oDetDASB8:nAT,11]}}\r\n     oDetDASB8:Refresh()\r\n\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 09\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Kardex - Almoxarifado\r\n@ 003,005 SAY \"Saldo Final : \"+Trans(nSldKarLocal,cPict) SIZE 200,50                                    PIXEL OF oFolder:aDialogs[9] FONT oBold\r\n@ 001,420 BUTTON \"Processar\"                             SIZE 30,10 ACTION (Processa({||fKardLocal()})) PIXEL OF oFolder:aDialogs[9]\r\n@ 010,005 LISTBOX oKarLocal Var cModelo FIELDS HEADER; \r\n     \"Origem\" ,;\r\n\t \"Data\" ,;\r\n\t \"TES/TM\" ,;\r\n\t \"CFO\" ,;\r\n\t \"Documento\" ,;\r\n\t \"Quantidade\" ,;\t\r\n\t \"Saldo\" ,;   \r\n\t \"Num.Seq.\" FIELDSIZES 25,40,30,20,32,40,40,30 SIZE 467,215 ON DBLCLICK () PIXEL OF oFolder:aDialogs[9]\r\n\t oKarLocal:SetArray(aKarLocal)\r\n\t oKarLocal:bLine:={ ||{aKarLocal[oKarLocal:nAT,1],aKarLocal[oKarLocal:nAT,2],aKarLocal[oKarLocal:nAT,3],aKarLocal[oKarLocal:nAT,4],aKarLocal[oKarLocal:nAT,5],aKarLocal[oKarLocal:nAT,6],aKarLocal[oKarLocal:nAT,7],aKarLocal[oKarLocal:nAT,8]}}\r\n     oKarLocal:Refresh()\r\n    \r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 10\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Kardex - Lote\r\n@ 003,005 SAY \"Saldo Final : \"+Trans(nSldKarLote,cPict) SIZE 200,50                                                PIXEL OF oFolder:aDialogs[10] FONT oBold\r\n@ 001,100 BUTTON \"Pesquisa Diferença - Próxima\"         SIZE 080,10 ACTION (fPesqDifLote(\"Prox\"))                  PIXEL OF oFolder:aDialogs[10]\r\n@ 001,200 BUTTON \"Pesquisa Diferença - Anterior\"        SIZE 080,10 ACTION (fPesqDifLote(\"Ante\"))                  PIXEL OF oFolder:aDialogs[10]\r\n@ 001,420 BUTTON \"Processar\"                            SIZE 030,10 ACTION (Processa({||fDetaSB8(),fKardLote()}))  PIXEL OF oFolder:aDialogs[10]\r\n@ 010,005 LISTBOX oKarLote Var cModelo FIELDS HEADER; \r\n     \"Origem\" ,;\r\n\t \"Data\" ,;\r\n\t \"TM\" ,;\r\n\t \"Documento\" ,;\r\n\t \"Lote\" ,;\t\r\n\t \"Num.Lote\" ,;\t\r\n\t \"Validade\" ,;\r\n\t \"Quantidade\" ,;   \t\t\t\r\n\t \"Saldo\" ,;   \r\n\t \"Num.Seq.\" FIELDSIZES 25,30,15,32,40,30,30,40,40,40 SIZE 467,215 ON DBLCLICK () PIXEL OF oFolder:aDialogs[10]\r\n\t oKarLote:bLDblClick := {|| Processa({||fPesqNumSeq(\"Lote\")})} \r\n\t oKarLote:SetArray(aKarLote)\r\n\t oKarLote:bLine:={ ||{aKarLote[oKarLote:nAT,1],aKarLote[oKarLote:nAT,2],aKarLote[oKarLote:nAT,3],aKarLote[oKarLote:nAT,4],aKarLote[oKarLote:nAT,5],aKarLote[oKarLote:nAT,6],aKarLote[oKarLote:nAT,7],aKarLote[oKarLote:nAT,8],aKarLote[oKarLote:nAT,9],aKarLote[oKarLote:nAT,10]}}\r\n     oKarLote:Refresh()\r\n    \r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 11\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Kardex - Localizacao\r\n@ 003,005 SAY \"Saldo Final : \"+Trans(nSldKarEnde,cPict) SIZE 200,50                                              PIXEL OF oFolder:aDialogs[11] FONT oBold\r\n@ 001,100 BUTTON \"Pesquisa Diferença - Próxima\"         SIZE 080,10 ACTION (fPesqDifEnde(\"Prox\"))                PIXEL OF oFolder:aDialogs[11]\r\n@ 001,200 BUTTON \"Pesquisa Diferença - Anterior\"        SIZE 080,10 ACTION (fPesqDifEnde(\"Ante\"))                PIXEL OF oFolder:aDialogs[11]\r\n@ 001,420 BUTTON \"Processar\"                            SIZE 030,10 ACTION (Processa({||fDetaSBF(),fKardEnde()})) PIXEL OF oFolder:aDialogs[11]\r\n@ 010,005 LISTBOX oKarEnde Var cModelo FIELDS HEADER; \r\n     \"Origem\" ,;\r\n\t \"Data\" ,;\r\n\t \"TM\" ,;\r\n\t \"Documento\" ,;\r\n\t \"Localização\" ,;\t\t\r\n\t \"Lote\" ,;\t\r\n\t \"Quantidade\" ,;   \t\t\t\r\n\t \"Saldo\" ,;   \r\n\t \"Num.Seq.\" FIELDSIZES 25,30,15,32,50,40,40,40,40 SIZE 467,215 ON DBLCLICK () PIXEL OF oFolder:aDialogs[11]\r\n     oKarEnde:bLDblClick := {|| Processa({||fPesqNumSeq(\"Ende\")})} \r\n\t oKarEnde:SetArray(aKarEnde)\r\n\t oKarEnde:bLine:={ ||{aKarEnde[oKarEnde:nAT,1],aKarEnde[oKarEnde:nAT,2],aKarEnde[oKarEnde:nAT,3],aKarEnde[oKarEnde:nAT,4],aKarEnde[oKarEnde:nAT,5],aKarEnde[oKarEnde:nAT,6],aKarEnde[oKarEnde:nAT,7],aKarEnde[oKarEnde:nAT,8],aKarEnde[oKarEnde:nAT,9]}}\r\n     oKarEnde:Refresh()\r\n    \r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 12\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Documento\r\n/*\r\n@ 001,040 BUTTON \"Somente Movimento Com Diferença\"     SIZE 100,10 ACTION (Processa({||fSoDocto()})) PIXEL OF oFolder:aDialogs[12]\r\n@ 001,375 BUTTON \"Processar\"        SIZE 30,10 ACTION (Processa({||fAnaliseDoc(),fDetaSDA()}))       PIXEL OF oFolder:aDialogs[12]\r\n@ 001,420 BUTTON \"Pesquisar\"        SIZE 30,10 ACTION (fPesquisa(\"DOCTO\",oDocto))                    PIXEL OF oFolder:aDialogs[12]\r\n@ 010,005 LISTBOX oDocto Var cModelo FIELDS HEADER; \r\n     \"Documento\" ,;\r\n     \"Serie\" ,;\r\n     \"Cli/For\" ,;\r\n     \"Loja\" ,;\r\n\t \"SD1\" ,;\r\n\t \"SD2\" ,;\r\n     \"SD3_E\" ,;\r\n\t \"SD3_S\" ,;\r\n\t \"SD5_E\" ,;\r\n\t \"SD5_S\" ,;\t\r\n\t \"SDB_E\" ,;\r\n     \"SDB_S\" ,;    \r\n\t \"Origem\" ,;\r\n\t \"Status\" ,;  \r\n\t \"Serviço\" ,;\r\n\t \"Status Serviço\" ,;\r\n     \"Serviço Pendente\"  SIZE 467,215 ON DBLCLICK () PIXEL OF oFolder:aDialogs[12]\r\n\t oDocto:SetArray(aDocto)\r\n     oDocto:bLine:={ ||{aDocto[oDocto:nAT,1],aDocto[oDocto:nAT,2],aDocto[oDocto:nAT,3],aDocto[oDocto:nAT,4],aDocto[oDocto:nAT,5],aDocto[oDocto:nAT,6],aDocto[oDocto:nAT,7],aDocto[oDocto:nAT,8],aDocto[oDocto:nAT,9],aDocto[oDocto:nAT,10],aDocto[oDocto:nAT,11],aDocto[oDocto:nAT,12],aDocto[oDocto:nAT,13],aDocto[oDocto:nAT,14],aDocto[oDocto:nAT,15],aDocto[oDocto:nAT,16],aDocto[oDocto:nAT,17]}}\r\n     oDocto:Refresh()\r\n*/    \r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// FOLDER 12\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// NumSeq\r\n@ 001,040 BUTTON \"Somente Movimento Com Diferença\"     SIZE 100,10 ACTION (Processa({||fSoNumSeq()})) PIXEL OF oFolder:aDialogs[12]\r\n@ 001,180 BUTTON \"Incluir SD5\"     SIZE 30,10 ACTION (fAjustSD5(\"D5_I\",\"13\"))                         PIXEL OF oFolder:aDialogs[12]\r\n@ 001,240 BUTTON \"Incluir SDB\"     SIZE 30,10 ACTION (fAjustSDB(\"DB_I\",\"13\"))                         PIXEL OF oFolder:aDialogs[12]\r\n@ 001,300 BUTTON \"Alterar\"         SIZE 30,10 ACTION (fAjustD5DB(\"D5DB_A\"))                           PIXEL OF oFolder:aDialogs[12]\r\n@ 001,375 BUTTON \"Processar\"       SIZE 30,10 ACTION (Processa({||fNumSeq(),fDetaSDA()}))             PIXEL OF oFolder:aDialogs[12]\r\n@ 001,420 BUTTON \"Pesquisar\"       SIZE 30,10 ACTION (fPesquisa(\"NUMSEQ\",oNumSeq))                    PIXEL OF oFolder:aDialogs[12]\r\n@ 010,005 LISTBOX oNumSeq Var cModelo FIELDS HEADER; \r\n     \"Num.Seq.\" ,;\r\n\t \"SD1\" ,;\r\n\t \"SD2\" ,;\r\n\t \"SD3_E\" ,;\r\n\t \"SD3_S\" ,;\r\n\t \"SD5_E\" ,;\r\n\t \"SD5_S\" ,;\t\r\n\t \"SDB_E\" ,;\r\n\t \"SDB_S\" ,;\t\r\n\t \"Origem\" ,;\r\n\t \"Status\" ,;  \r\n\t \"Data\" ,;       \r\n\t \"Documento\" ,;  \r\n\t \"Serie\" ,;  \r\n\t \"Clie.Forn\" ,;  \r\n\t \"Loja\" ,;  \r\n\t \"Serviço\" ,;\r\n\t \"Status Serviço\" ,;\r\n     \"Serviço Pendente\"  SIZE 467,215 ON DBLCLICK () PIXEL OF oFolder:aDialogs[12]\r\n   oNumSeq:bLDblClick := {|| Processa({||fPesqKarEnd()})}      \r\n\toNumSeq:SetArray(aNumSeq)\r\n\toNumSeq:bLine:={ ||{aNumSeq[oNumSeq:nAT,1],aNumSeq[oNumSeq:nAT,2],aNumSeq[oNumSeq:nAT,3],aNumSeq[oNumSeq:nAT,4],aNumSeq[oNumSeq:nAT,5],aNumSeq[oNumSeq:nAT,6],aNumSeq[oNumSeq:nAT,7],aNumSeq[oNumSeq:nAT,8],aNumSeq[oNumSeq:nAT,9],aNumSeq[oNumSeq:nAT,10],aNumSeq[oNumSeq:nAT,11],aNumSeq[oNumSeq:nAT,12],aNumSeq[oNumSeq:nAT,13],aNumSeq[oNumSeq:nAT,14],aNumSeq[oNumSeq:nAT,15],aNumSeq[oNumSeq:nAT,16],aNumSeq[oNumSeq:nAT,17],aNumSeq[oNumSeq:nAT,18],aNumSeq[oNumSeq:nAT,19]}}\r\n   oNumSeq:Refresh()\r\n    \r\n@ 010,420 BUTTON \"&Processar\"   SIZE 36,16 PIXEL ACTION Processa({||fProcessa()})\r\n@ 040,420 BUTTON \"&Sair\"        SIZE 36,16 PIXEL ACTION oDlgMain:End()\r\n\r\nACTIVATE MSDIALOG oDlgMain  CENTERED\r\n\r\nRestArea(aArea)        \r\n\r\nReturn(.T.)\r\n\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function TrocaTip()\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\naFolder[oBox:nAt,1] := IIF(aFolder[oBox:nAt,1],.F.,.T. )\r\noBox:Refresh()\r\nReturn\r\n\r\n\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function MarcaTodos(lMark)\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nFor nI:= 1 To Len(aFolder)\r\n  aFolder[nI,1] := IIF(lMark,.T.,.F.)\r\nNext\r\noBox:Refresh()\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fProcessa()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nnSB9        := 0\r\nnSBJ        := 0\r\nnSBK        := 0\r\nnKAR        := 0\r\nnSD5        := 0\r\nnSDB        := 0\r\nnSB2        := 0\r\nnSB8        := 0\r\nnSBF        := 0\r\nnSDA        := 0\r\nnDASB2      := 0\r\nnDASB8      := 0\r\ncMensagem   := \"\"\r\ncMensSB8    := \"\"\r\ncMensSBF    := \"\"        \r\ncMensB8BF   := \"\"\r\ncMensBJBK   := \"\"\r\ncMensDocto  := \"\"\r\ncMensNumSeq := \"\"\r\ncMensDAB8   := \"\"\r\n\r\nIF Empty(dDataI) .OR. Empty(dDataF)\r\n   MsgStop(\"Datas de Processamento Invalidas !!!\")\r\n   Return\r\nEndif\r\n\r\nDBSelectArea(\"SB1\")\r\nDBSetOrder(1)\r\nDBSeek(xFilial(\"SB1\")+cProduto)\r\n\r\nProcRegua(15)\r\n\r\nIncProc(\"Processando Saldo Inicial\")\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nDBSelectArea(\"SB9\")\r\nDBSetOrder(1) \r\nIF DBSeek(xFilial(\"SB9\")+cProduto+cLocal+DTOS(dUltFech))\r\n   nSB9 := SB9->B9_QINI\r\nEndif  \r\n\r\n// Saldo Inicial\r\ncQuery := \"SELECT SUM(BJ_QINI) AS BJ_QINI FROM \"+RETSQLNAME('SBJ')+\" WHERE BJ_FILIAL='\"+xFilial(\"SBJ\")+\"' AND BJ_LOCAL='\"+cLocal+\"' AND D_E_L_E_T_ <> '*' AND BJ_DATA = '\"+DTOS(dUltFech)+\"'AND BJ_COD = '\"+cProduto+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBJ\",.F.,.T.)\r\nnSBJ := QrySBJ->BJ_QINI\r\nDBCloseArea()\r\n\r\ncQuery := \"SELECT SUM(BK_QINI) AS BK_QINI FROM \"+RETSQLNAME('SBK')+\" WHERE BK_FILIAL='\"+xFilial(\"SBK\")+\"' AND BK_LOCAL='\"+cLocal+\"' AND D_E_L_E_T_ <> '*' AND BK_DATA = '\"+DTOS(dUltFech)+\"'AND BK_COD = '\"+cProduto+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBK\",.F.,.T.)\r\nnSBK := QrySBK->BK_QINI\r\nDBCloseArea()\r\n\r\nIncProc(\"Processando Saldo Atual\")\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Saldo Atual\r\nDBSelectArea(\"SB2\")\r\nDBSetOrder(1) \r\nIF DBSeek(xFilial(\"SB2\")+cProduto+cLocal)\r\n   nSB2   := SB2->B2_QATU\r\n   nDASB2 := SB2->B2_QACLASS\r\nEndif  \r\n\r\ncQuery := \"SELECT SUM(B8_SALDO) AS B8_SALDO, SUM(B8_QACLASS) AS B8_QACLASS FROM \"+RETSQLNAME('SB8')+\" WHERE B8_FILIAL='\"+xFilial(\"SB8\")+\"' AND B8_LOCAL='\"+cLocal+\"' AND B8_SALDO <> 0 AND D_E_L_E_T_ <> '*' AND B8_PRODUTO = '\"+cProduto+\"' AND B8_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySB8\",.F.,.T.)\r\nnSB8   := QrySB8->B8_SALDO\r\nnDASB8 := QrySB8->B8_QACLASS\r\nDBCloseArea()\r\n\r\ncQuery := \"SELECT SUM(BF_QUANT) AS BF_QUANT FROM \"+RETSQLNAME('SBF')+\" WHERE BF_FILIAL='\"+xFilial(\"SBF\")+\"' AND BF_LOCAL='\"+cLocal+\"' AND BF_QUANT <> 0 AND D_E_L_E_T_ <> '*' AND BF_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBF\",.F.,.T.)\r\nnSBF := QrySBF->BF_QUANT\r\nDBCloseArea()\r\n\r\ncQuery := \"SELECT SUM(DA_SALDO) AS DA_SALDO  FROM \"+RETSQLNAME('SDA')+\" WHERE DA_FILIAL='\"+xFilial(\"SDA\")+\"' AND DA_LOCAL='\"+cLocal+\"' AND DA_SALDO <> 0 AND D_E_L_E_T_ <> '*' AND DA_PRODUTO = '\"+cProduto+\"' AND DA_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySDA\",.F.,.T.)\r\nnSDA   := QrySDA->DA_SALDO\r\nDBCloseArea()\r\n\r\nIncProc(\"Processando Movimento\")\r\n///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\n// Saldo Movimentacao\r\nDBSelectArea('SB1')\r\naSaldos := CalcEst(cProduto, cLocal, dDtProces+1)\r\nIF aSaldos <> Nil .AND. Len(aSaldos) > 0\r\n   nKAR  := aSaldos[1]                        \r\nEndif   \r\n\r\nfDetaSB8()    // Detalhe do SB8 x SD5\r\nfDetaSBF()    // Detalhe do SBF x SDB\r\nfDetaB8BF()   // Detalhe do SB8 x SBF\r\nfDetaBJBK()   // Detalhe do SBJ x SBK   \r\nfDetaSBJ()    // Detalhe do SBJ     \r\nfDetaSBK()    // Detalhe do SBK        \r\n//fAnaliseDoc() // Analisa Documento\r\nfNumSeq()     // Analisa NumSeq\r\nfKardLocal()  // Kardex por Almoxarifado\r\nfKardLote()   // Kardex por Lote\r\nfKardEnde()   // Kardex por Endereco\r\n\r\nnSDB += nSDA\r\nnSBF += nSDA\r\n\r\nfDetaSDA()    // Detalhe SDA\r\nfDetaDASB8()  // Detalhe SDAxSB8\r\n\r\nIF Empty(cMensagem)\r\n   cMensagem := \"OK\"  \r\nEndif   \r\n\r\nDo Case\r\n   Case SB1->B1_LOCALIZ == \"S\" .AND. SB1->B1_RASTRO == \"L\"  \r\n      IF nKAR <> nSB8 .OR. nKAR <> nSD5 .OR. nKAR <> nSDB .OR. nKAR <> nSBF .OR. nKAR <> nSB2 .OR. nSB8 <> nSD5 .OR. nSBF <> nSDB .OR. nSB8 <> nSBF .OR. nSB2 <> nSB8 .OR. nSB2 <> nSBF \r\n         cMensagem := \"DIVERG.SL 1\"\r\n      Endif\r\n      IF nSB9 <> nSBJ\r\n         cMensagem := \"DIVERG.SL 2\"\r\n      Endif\r\n      IF nSDA <> nDASB2 .OR. nSDA <> nDASB8\r\n         cMensagem := \"DIVERG.SL 3\"\r\n      Endif\r\n      IF nSBJ = 0 .AND.  nSBK = 0 .AND. nKAR = nSB8 .AND. nKAR = nSD5 .AND. nKAR = nSDB .AND. nKAR = nSBF .AND. nKAR = nSB2 .AND. nSB8 = nSD5 .AND. nSBF = nSDB .AND. nSB8 = nSBF .AND. nSB2 = nSB8 .AND. nSB2 = nSBF \r\n         cMensagem := \"OK\"  \r\n      Endif\r\n   Case SB1->B1_LOCALIZ == \"S\"\r\n      IF nKAR <> nSDB .OR. nKAR <> nSBF .OR. nKAR <> nSB2 .OR. nSBF <> nSDB .OR. nSB2 <> nSBF \r\n         cMensagem := \"DIVERG.SN 1\"\r\n      Endif\r\n      IF nSDA <> nDASB2 \r\n         cMensagem := \"DIVERG.SN 2\"\r\n      Endif\r\n      IF nSBK = 0 .AND. nKAR = nSDB .AND. nKAR = nSBF .AND. nKAR = nSB2 .AND. nSBF = nSDB .AND. nSB2 = nSBF \r\n         cMensagem := \"OK\"  \r\n      Endif\r\n   Case SB1->B1_RASTRO == \"L\"\r\n      IF nKAR <> nSB8 .OR. nKAR <> nSD5 .OR. nKAR <> nSB2 .OR. nSB8 <> nSD5 .OR. nSB2 <> nSB8\r\n         cMensagem := \"DIVERG.NL 1\"\r\n      Endif\r\n      IF nSB9 <> nSBJ\r\n         cMensagem := \"DIVERG.NL 2\"\r\n      Endif\r\n      IF nSBJ = 0 .AND. nKAR = nSB8 .AND. nKAR = nSD5 .AND. nKAR = nSB2 .AND. nSB8 = nSD5 .AND. nSB2 = nSB8 \r\n         cMensagem := \"OK\"  \r\n      Endif\r\n   OtherWise   \r\n      IF nKAR <> nSB2 \r\n         cMensagem := \"DIVERGENCIA\"\r\n      Endif\r\nEndCase\r\n           \r\nIF nSD5 == nSDB .AND. nSB8 == nSBF\r\n  cMensBJBK := \"\"\r\nEndif  \r\n\r\noSB9:Refresh()\r\noSBJ:Refresh()\r\noSBK:Refresh()\r\noKAR:Refresh()\r\noSD5:Refresh()\r\noSDB:Refresh()\r\noSB2:Refresh()\r\noSB8:Refresh()\r\noSBF:Refresh()\r\noSDA:Refresh()\r\noDASB2:Refresh()\r\noDASB8:Refresh()\r\n \r\nDBSelectArea('SB1')\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function GetDescProd()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal aArea  := GetArea()\r\n\r\nDBSelectArea(\"SB1\")\r\nDBSetOrder(1)\r\nIF !Empty(cProduto) .AND. !DBSeek(xFilial(\"SB1\")+cProduto)\r\n   MsgStop(\"Produto não cadastrado !!!\")\r\n   Return (.F.)\r\nEndif\r\n\r\ncDescr   := SB1->B1_DESC\r\ncCrlLot  := If(SB1->B1_RASTRO =\"L\",\"Lote\",If(SB1->B1_RASTRO =\"S\",\"Sub-Lote\",\"Não\"))\r\ncCrlEnd  := If(SB1->B1_LOCALIZ=\"S\",\"Sim\",\"Não\")\r\ncLocal   := IF(Empty(cLocal),SB1->B1_LOCPAD,cLocal)\r\nc1UM     := SB1->B1_UM\r\nc2UM     := SB1->B1_SEGUM\r\nnFatConv := SB1->B1_CONV\r\ncTipConv := SB1->B1_TIPCONV\r\n\r\nDBSelectArea(\"SB5\")\r\nDBSetOrder(1)\r\nDBSeek(xFilial(\"SB5\")+cProduto)\r\ncZona := SB5->B5_CODZON   \r\n\r\nIF !Empty(cProduto)\r\n   If File(\"ANALISE.LOG\")\r\n      hdl := FOpen(\"ANALISE.LOG\", 1)\r\n      FSeek(hdl,0,2)\r\n   Else\r\n      hdl := FCreate(\"ANALISE.LOG\", 0)\r\n   Endif\r\n   FWrite(hdl,\"Produto: \"+cProduto+\"    Usuario:  \"+cUserName+\"    Data: \"+Dtoc(Date())+\"    Hora: \"+Time()+CHR(13)+CHR(10))\r\n   FClose(hdl)\r\nEndif\r\nRestArea(aArea)\r\n\r\nReturn(.T.)\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function GetDatas()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal aArea  := GetArea()\r\n\r\ncQuery := \"SELECT MAX(B9_DATA) AS B9_DATA FROM \"+RETSQLNAME('SB9')+\" WHERE B9_FILIAL='\"+xFilial(\"SB9\")+\"' AND B9_LOCAL='\"+cLocal+\"' AND D_E_L_E_T_ <> '*' AND B9_COD = '\"+cProduto+\"' AND B9_DATA < '\"+DTOS(dDtProces)+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySB9\",.F.,.T.)\r\nTCSETFIELD( \"QrySB9\",\"B9_DATA\",\"D\")\r\ndUltFech := QrySB9->B9_DATA\r\nDBCloseArea()\r\n\r\ndDataI := (dUltFech + 1)\r\ndDataF := dDtProces\r\n\r\nRestArea(aArea)\r\nReturn(.T.)\r\n\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaSB8()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SB8\")\r\n\r\naSize(aDetSB8, 0)\r\naSize(aDetSD5, 0)\r\n\r\n// Movimento do SB8\r\nIF nOpSB8 == 1 // Num.Lote\r\n   cQuery := \" SELECT B8_DATA,B8_LOTECTL,B8_NUMLOTE,B8_DTVALID,B8_QTDORI,B8_SALDO,B8_EMPENHO,B8_SALDO2,B8_EMPENH2 FROM \"+RETSQLNAME(\"SB8\")   \r\n   cQuery += \" WHERE B8_FILIAL='\"+xFilial(\"SB8\")+\"' AND B8_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SB8\")+\".D_E_L_E_T_ <> '*' AND B8_PRODUTO = '\"+cProduto+\"'\"\r\n   cQuery += \" AND B8_SALDO <> 0 AND B8_DATA <= '\"+DTOS(dDataF)+\"' ORDER BY B8_LOTECTL,B8_NUMLOTE\"   \r\nElse\r\n   cQuery := \" SELECT B8_LOTECTL,B8_DTVALID,SUM(B8_QTDORI) AS B8_QTDORI,SUM(B8_SALDO) AS B8_SALDO,SUM(B8_EMPENHO) AS B8_EMPENHO,SUM(B8_SALDO2) AS B8_SALDO2,SUM(B8_EMPENH2) AS B8_EMPENH2 FROM \"+RETSQLNAME(\"SB8\")\r\n   cQuery += \" WHERE B8_FILIAL='\"+xFilial(\"SB8\")+\"' AND B8_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SB8\")+\".D_E_L_E_T_ <> '*' AND B8_PRODUTO = '\"+cProduto+\"'\"\r\n   cQuery += \" AND B8_SALDO <> 0 AND B8_DATA <= '\"+DTOS(dDataF)+\"'\"\r\n   cQuery += \" GROUP BY B8_LOTECTL,B8_DTVALID ORDER BY B8_LOTECTL\"\r\nEndif   \r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySB8\",.F.,.T.)\r\nTCSETFIELD( \"QrySB8\",\"B8_DATA\",\"D\")\r\nTCSETFIELD( \"QrySB8\",\"B8_DTVALID\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aDetSB8,{IF(nOpSB8==2,Space(06),B8_DATA),B8_LOTECTL,IF(nOpSB8==2,Space(06),B8_NUMLOTE),B8_DTVALID,B8_SALDO,B8_QTDORI,SPACE(06),B8_EMPENHO,B8_SALDO2,B8_EMPENH2})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nIF Len(aDetSB8) == 0  \r\n                  //Data            ,Lote     ,Num.Lote ,Validade        ,Saldo,Qtde.Original,Status   ,Empenho,Qtde.2UM,Empenho 2UM\r\n   Aadd(aDetSB8   ,{CTOD(\"  /  /  \"),Space(10),Space(06),CTOD(\"  /  /  \"),0    ,0            ,Space(08),0      ,0       ,0})\r\n   oDetSB8:nAT := 1\r\nEndif\r\n\r\nIF Len(aDetSD5) == 0\r\n                  //Data            ,TM       ,Lote     ,Num.Lote ,Validade        ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja\r\n   Aadd(aDetSD5   ,{CTOD(\"  /  /  \"),Space(03),Space(10),Space(06),CTOD(\"  /  /  \"),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n   oDetSD5:nAT := 1\r\nEndif\r\n\r\noDetSB8:Refresh()\r\noDetSD5:Refresh()\r\n   \r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaSD5()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SD5\")\r\n\r\naSize(aDetSB8, 0)\r\naSize(aDetSD5, 0)\r\n\r\n// Movimento do SD5\r\nIF nOpSB8 == 2 // Lote\r\n   cQuery := \" SELECT D5_DATA,D5_ORIGLAN,D5_LOTECTL,D5_DTVALID,SUM(D5_QUANT) AS D5_QUANT FROM \"+RETSQLNAME(\"SD5\")\r\n   cQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\n   cQuery += \" AND D5_ESTORNO= ' ' AND D5_DATA <= '\"+DTOS(dDataF)+\"'\"\r\n   cQuery += \" GROUP BY D5_DATA,D5_ORIGLAN,D5_LOTECTL,D5_DTVALID\"\r\nElse // Lote e Num.Lote\r\n   cQuery := \" SELECT D5_DATA,D5_ORIGLAN,D5_LOTECTL,D5_NUMLOTE,D5_DTVALID,D5_NUMSEQ,D5_QUANT,D5_DOC,D5_SERIE,D5_CLIFOR,D5_LOJA,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SD5\")\r\n   cQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\n   cQuery += \" AND D5_ESTORNO= ' ' AND D5_DATA <= '\"+DTOS(dDataF)+\"'\"\r\nEndif\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySD5\",.F.,.T.)\r\nTCSETFIELD( \"QrySD5\",\"D5_DATA\",\"D\")\r\nTCSETFIELD( \"QrySD5\",\"D5_DTVALID\",\"D\")\r\nWhile !Eof() \r\n  IF nOpSB8 == 2 // Lote\r\n     AAdd(aDetSD5,{D5_DATA,D5_ORIGLAN,D5_LOTECTL,SPACE(06) ,D5_DTVALID,D5_QUANT,0,Space(06),Space(06),Space(06),Space(01),Space(01),Space(01),Space(01)})\r\n  Else\r\n     AAdd(aDetSD5,{D5_DATA,D5_ORIGLAN,D5_LOTECTL,D5_NUMLOTE,D5_DTVALID,D5_QUANT,0,D5_NUMSEQ,Space(01),D5_DOC  ,D5_SERIE ,D5_CLIFOR ,D5_LOJA,QrySD5->RECNO})\r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\nIF nOpSB8 == 2 // Lote\r\n   aSort(aDetSD5,,, { |x,y| DTOS(y[1])+y[3]+y[2] > DTOS(x[1])+x[3]+x[2]} )      \r\nElse\r\n   aSort(aDetSD5,,, { |x,y| y[3]+y[4]+y[8]+y[2] > x[3]+x[4]+x[8]+x[2]} )      \r\nEndif   \r\n\r\nIF Len(aDetSD5) == 0                   \r\n                  //Data            ,TM       ,Lote     ,Num.Lote ,Validade        ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja\r\n   Aadd(aDetSD5   ,{CTOD(\"  /  /  \"),Space(03),Space(10),Space(06),CTOD(\"  /  /  \"),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n   oDetSD5:nAT := 1\r\nEndif\r\n\r\nIF Len(aDetSB8) == 0\r\n                  //Data            ,Lote     ,Num.Lote ,Validade        ,Saldo,Qtde.Original,Status   ,Empenho,Qtde.2UM,Empenho 2UM\r\n   Aadd(aDetSB8   ,{CTOD(\"  /  /  \"),Space(10),Space(06),CTOD(\"  /  /  \"),0    ,0            ,Space(08),0      ,0       ,0})\r\n   oDetSB8:nAT := 1\r\nEndif\r\n\r\noDetSD5:Refresh()\r\noDetSB8:Refresh()\r\n   \r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fMontaSB8(lFiltro)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIF Len(aDetSD5) = 0 .OR. Empty(aDetSD5[1,1])\r\n   Return\r\nEndif\r\n\r\nIncProc(\"Processando Detalhe - SB8\")\r\n\r\naSize(aDetSB8, 0)\r\n\r\n// Movimento do SB8\r\nIF nOpSB8 == 2 // Lote\r\n   cQuery := \" SELECT B8_LOTECTL,B8_DTVALID,SUM(B8_QTDORI) AS B8_QTDORI,SUM(B8_SALDO) AS B8_SALDO,SUM(B8_EMPENHO) AS B8_EMPENHO,SUM(B8_SALDO2) AS B8_SALDO2,SUM(B8_EMPENH2) AS B8_EMPENH2 FROM \"+RETSQLNAME(\"SB8\")\r\n   cQuery += \" WHERE B8_FILIAL='\"+xFilial(\"SB8\")+\"' AND B8_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SB8\")+\".D_E_L_E_T_ <> '*' AND B8_PRODUTO = '\"+cProduto+\"'\"\r\n   IF lFiltro\r\n      cQuery += \" AND B8_LOTECTL = '\"+aDetSD5[oDetSD5:nAT][3]+\"'\"\r\n//    cQuery += \" AND B8_LOTECTL = '\"+aDetSD5[oDetSD5:nAT][3]+\"' AND B8_DATA <= '\"+DTOS(dDataF)+\"'\"   \r\n   Endif\r\n   cQuery += \" GROUP BY B8_LOTECTL,B8_DTVALID\"\r\nElse\r\n   cQuery := \" SELECT B8_DATA,B8_LOTECTL,B8_NUMLOTE,B8_DTVALID,B8_QTDORI,B8_SALDO,B8_EMPENHO,B8_SALDO2,B8_EMPENH2 FROM \"+RETSQLNAME(\"SB8\")   \r\n   cQuery += \" WHERE B8_FILIAL='\"+xFilial(\"SB8\")+\"' AND B8_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SB8\")+\".D_E_L_E_T_ <> '*' AND B8_PRODUTO = '\"+cProduto+\"'\"\r\n   IF lFiltro\r\n      cQuery += \" AND B8_LOTECTL = '\"+aDetSD5[oDetSD5:nAT][3]+\"' AND B8_NUMLOTE = '\"+aDetSD5[oDetSD5:nAT][4]+\"'\"\r\n//    cQuery += \" AND B8_LOTECTL = '\"+aDetSD5[oDetSD5:nAT][3]+\"' AND B8_NUMLOTE = '\"+aDetSD5[oDetSD5:nAT][4]+\"' AND B8_DATA <= '\"+DTOS(dDataF)+\"'\"   \r\n   Endif\r\nEndif   \r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySB8\",.F.,.T.)\r\nTCSETFIELD( \"QrySB8\",\"B8_DATA\",\"D\")\r\nTCSETFIELD( \"QrySB8\",\"B8_DTVALID\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aDetSB8  ,{IF(nOpSB8==2,Space(06),B8_DATA),B8_LOTECTL,IF(nOpSB8==2,SPACE(06),B8_NUMLOTE),B8_DTVALID,B8_SALDO,B8_QTDORI,SPACE(06),B8_EMPENHO,B8_SALDO2,B8_EMPENH2})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nIF Len(aDetSB8) == 0\r\n   For J:= 1 To Len(aDetSD5)\r\n     IF aDetSD5[oDetSD5:nAT][3]+aDetSD5[oDetSD5:nAT][4] == aDetSD5[J,3]+aDetSD5[J,4]\r\n        aDetSD5[J,09] := \"Analisar\"\r\n     Endif   \r\n   Next\r\nElse\r\n   For I:= 1 To Len(aDetSB8)  \r\n     nSaldo := 0\r\n     For J:= 1 To Len(aDetSD5)\r\n       IF aDetSB8[I,2]+aDetSB8[I,3] == aDetSD5[J,3]+aDetSD5[J,4]\r\n          nSaldo += IF(aDetSD5[J,2] <= \"500\" .OR. Substr(aDetSD5[J,2],1,2) $ 'DE/PR/MA' .OR. aDetSD5[J,2] = \"SBJ\" ,aDetSD5[J,6],aDetSD5[J,6]*-1)\r\n          aDetSD5[J,07] := nSaldo      \r\n          aDetSD5[J,09] := \"OK\"\r\n       Endif   \r\n     Next\r\n     aDetSB8[I,7] := \"OK\"\r\n     IF aDetSB8[I,5] <> nSaldo\r\n        aDetSB8[I,7] := \"Problema\"\r\n        For J:= 1 To Len(aDetSD5)\r\n           IF aDetSB8[I,2]+aDetSB8[I,3] == aDetSD5[J,3]+aDetSD5[J,4]\r\n              aDetSD5[J,09] := \"Problema\"\r\n           Endif   \r\n        Next\r\n      Endif           \r\n   Next\r\nEndif\r\n\r\nIF Len(aDetSB8) == 0\r\n                  //Data            ,Lote     ,Num.Lote ,Validade        ,Saldo,Qtde.Original,Status   ,Empenho,Qtde.2UM,Empenho 2UM\r\n   Aadd(aDetSB8   ,{CTOD(\"  /  /  \"),Space(10),Space(06),CTOD(\"  /  /  \"),0    ,0            ,Space(08),0      ,0       ,0})\r\n   oDetSB8:nAT := 1\r\nEndif\r\n\r\nIF Len(aDetSD5) == 0\r\n                  //Data            ,TM       ,Lote     ,Num.Lote ,Validade        ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja\r\n   Aadd(aDetSD5   ,{CTOD(\"  /  /  \"),Space(03),Space(10),Space(06),CTOD(\"  /  /  \"),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n   oDetSD5:nAT := 1\r\nEndif\r\n\r\noDetSB8:Refresh()\r\noDetSD5:Refresh()\r\n  \r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fMontaSD5()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIF Len(aDetSB8) = 0 .OR. Empty(aDetSB8[1,1])\r\n   Return\r\nEndif\r\n\r\nIncProc(\"Processando Detalhe - SD5\")\r\n\r\naSize(aDetSD5, 0)\r\n\r\n// Identifica os Lotes               \r\nIF nOpSB8 == 2 // Lote\r\n   cQuery := \" SELECT DISTINCT BJ_LOTECTL AS LOTECTL,BJ_NUMLOTE AS NUMLOTE FROM \"+RETSQLNAME(\"SBJ\")\r\n   cQuery += \" WHERE BJ_FILIAL='\"+xFilial(\"SBJ\")+\"' AND BJ_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBJ\")+\".D_E_L_E_T_ <> '*' AND BJ_COD = '\"+cProduto+\"'\"\r\n   cQuery += \" AND BJ_DATA = '\"+DTOS(dUltFech)+\"' AND BJ_QINI <> 0 AND BJ_LOTECTL  = '\"+aDetSB8[oDetSB8:nAT][2]+\"'\"\r\n   cQuery += \" UNION\"\r\n   cQuery += \" SELECT DISTINCT D5_LOTECTL AS LOTECTL,D5_NUMLOTE AS NUMLOTE FROM \"+RETSQLNAME(\"SD5\")\r\n   cQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\n   cQuery += \" AND D5_ESTORNO= ' ' AND D5_DATA >= '\"+DTOS(dDataI)+\"' AND D5_DATA <= '\"+DTOS(dDataF)+\"' AND D5_LOTECTL  = '\"+aDetSB8[oDetSB8:nAT][2]+\"'\"\r\nElse // Lote e Num.Lote                                                                            \r\n   cQuery := \" SELECT DISTINCT BJ_LOTECTL AS LOTECTL,BJ_NUMLOTE AS NUMLOTE FROM \"+RETSQLNAME(\"SBJ\")\r\n   cQuery += \" WHERE BJ_FILIAL='\"+xFilial(\"SBJ\")+\"' AND BJ_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBJ\")+\".D_E_L_E_T_ <> '*' AND BJ_COD = '\"+cProduto+\"'\"\r\n   cQuery += \" AND BJ_DATA = '\"+DTOS(dUltFech)+\"' AND BJ_QINI <> 0 AND BJ_LOTECTL  = '\"+aDetSB8[oDetSB8:nAT][2]+\"'\"\r\n   cQuery += \" AND BJ_NUMLOTE  = '\"+aDetSB8[oDetSB8:nAT][3]+\"'\"\r\n   cQuery += \" UNION\"\r\n   cQuery += \" SELECT DISTINCT D5_LOTECTL AS LOTECTL,D5_NUMLOTE AS NUMLOTE FROM \"+RETSQLNAME(\"SD5\")\r\n   cQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\n   cQuery += \" AND D5_ESTORNO= ' ' AND D5_DATA >= '\"+DTOS(dDataI)+\"' AND D5_DATA <= '\"+DTOS(dDataF)+\"' AND D5_LOTECTL  = '\"+aDetSB8[oDetSB8:nAT][2]+\"'\"\r\n   cQuery += \" AND D5_NUMLOTE = '\"+aDetSB8[oDetSB8:nAT][3]+\"'\"\r\nEndif\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n  // Movimento do SBJ \r\n  IF nOpSB8 == 2 // Lote\r\n     cQuery := \" SELECT BJ_LOTECTL,BJ_NUMLOTE,BJ_DATA,BJ_DTVALID,SUM(BJ_QINI) AS BJ_QINI FROM \"+RETSQLNAME(\"SBJ\")\r\n     cQuery += \" WHERE BJ_FILIAL='\"+xFilial(\"SBJ\")+\"' AND BJ_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBJ\")+\".D_E_L_E_T_ <> '*' AND BJ_COD = '\"+cProduto+\"'\"\r\n     cQuery += \" AND BJ_DATA = '\"+DTOS(dUltFech)+\"' AND BJ_LOTECTL  = '\"+QryTRB->LOTECTL+\"'\"\r\n     cQuery += \" GROUP BY BJ_LOTECTL,,BJ_DATA,BJ_DTVALID\"\r\n  Else // Lote e Num.Lote\r\n     cQuery := \" SELECT BJ_LOTECTL,BJ_NUMLOTE,BJ_DATA,BJ_DTVALID,SUM(BJ_QINI) AS BJ_QINI FROM \"+RETSQLNAME(\"SBJ\")\r\n     cQuery += \" WHERE BJ_FILIAL='\"+xFilial(\"SBJ\")+\"' AND BJ_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBJ\")+\".D_E_L_E_T_ <> '*' AND BJ_COD = '\"+cProduto+\"'\"\r\n     cQuery += \" AND BJ_DATA = '\"+DTOS(dUltFech)+\"' AND BJ_LOTECTL  = '\"+QryTRB->LOTECTL+\"' AND BJ_NUMLOTE  = '\"+QryTRB->NUMLOTE+\"'\"\r\n     cQuery += \" GROUP BY BJ_LOTECTL,BJ_NUMLOTE,BJ_DATA,BJ_DTVALID\"\r\n  Endif\r\n  cQuery := ChangeQuery(cQuery)\r\n  DBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBJ\",.F.,.T.)\r\n  TCSETFIELD( \"QrySBJ\",\"BJ_DTVALID\",\"D\")\r\n  IF nOpSB8 == 2 // Lote\r\n     AAdd(aDetSD5,{BJ_DATA,\"SBJ\",BJ_LOTECTL,SPACE(06) ,D5_DTVALID,BJ_QINI,0,Space(06),Space(01),Space(06),Space(01),Space(01),Space(01),Space(01)})\r\n  Else // Lote e Num.Lote\r\n     AAdd(aDetSD5,{BJ_DATA,\"SBJ\",BJ_LOTECTL,BJ_NUMLOTE,BJ_DTVALID,BJ_QINI,0,Space(06),Space(01),Space(06),Space(01),Space(01),Space(01),Space(01)})\r\n  Endif   \r\n  DBCloseArea()\r\n  DBSelectArea(\"QryTRB\")\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// Movimento do SD5\r\nIF nOpSB8 == 2 // Lote\r\n   cQuery := \" SELECT D5_DATA,D5_ORIGLAN,D5_LOTECTL,D5_DTVALID,SUM(D5_QUANT) AS D5_QUANT FROM \"+RETSQLNAME(\"SD5\")\r\n   cQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\n   cQuery += \" AND D5_ESTORNO= ' ' AND D5_LOTECTL = '\"+aDetSB8[oDetSB8:nAT][2]+\"'\"\r\n   cQuery += \" AND D5_DATA >= '\"+DTOS(dDataI)+\"' AND D5_DATA <= '\"+DTOS(dDataF)+\"'\"\r\n   cQuery += \" GROUP BY D5_DATA,D5_ORIGLAN,D5_LOTECTL,D5_DTVALID\"\r\nElse // Lote e Num.Lote\r\n   cQuery := \" SELECT D5_DATA,D5_ORIGLAN,D5_LOTECTL,D5_NUMLOTE,D5_DTVALID,D5_NUMSEQ,D5_QUANT,D5_DOC,D5_SERIE,D5_CLIFOR,D5_LOJA,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SD5\")\r\n   cQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\n   cQuery += \" AND D5_ESTORNO= ' ' AND D5_LOTECTL = '\"+aDetSB8[oDetSB8:nAT][2]+\"' AND D5_NUMLOTE = '\"+aDetSB8[oDetSB8:nAT][3]+\"'\"\r\n   cQuery += \" AND D5_DATA >= '\"+DTOS(dDataI)+\"' AND D5_DATA <= '\"+DTOS(dDataF)+\"'\"\r\nEndif\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySD5\",.F.,.T.)\r\nTCSETFIELD( \"QrySD5\",\"D5_DATA\",\"D\")   \r\nTCSETFIELD( \"QrySD5\",\"D5_DTVALID\",\"D\")\r\nWhile !Eof() \r\n  IF nOpSB8 == 2 // Lote\r\n     AAdd(aDetSD5,{D5_DATA,D5_ORIGLAN,D5_LOTECTL,SPACE(06) ,D5_DTVALID,D5_QUANT,0,Space(06),Space(01),Space(06),Space(01),Space(01),Space(01),Space(01)})\r\n  Else\r\n     AAdd(aDetSD5,{D5_DATA,D5_ORIGLAN,D5_LOTECTL,D5_NUMLOTE,D5_DTVALID,D5_QUANT,0,D5_NUMSEQ,Space(01),D5_DOC  ,D5_SERIE  ,D5_CLIFOR,D5_LOJA ,QrySD5->RECNO})\r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\nIF nOpSB8 == 1 // Lote e Num.Lote\r\n   aSort(aDetSD5,,, { |x,y| y[8]+y[2] > x[8]+y[2]} )      \r\nEndif   \r\nnSaldo := 0\r\nFor I:= 1 To Len(aDetSD5)\r\n   IF !Empty(aDetSD5[I,1])\r\n      nSaldo += IF(aDetSD5[I,2] <= \"500\" .OR. Substr(aDetSD5[I,2],1,2) $ 'DE/PR/MA' .OR. aDetSD5[I,2] = \"SBJ\",aDetSD5[I,6],aDetSD5[I,6]*-1)\r\n      aDetSD5[I,07] := nSaldo     \r\n      aDetSD5[I,09] := \"OK\"\r\n   Else\r\n      nSaldo := 0\r\n   Endif   \r\nNext\r\n\r\naDetSB8[oDetSB8:nAT][7] := \"OK\"\r\nIF nSaldo <> aDetSB8[oDetSB8:nAT][5]\r\n   aDetSB8[oDetSB8:nAT][7] := \"Problema\"\r\n   For I:= 1 To Len(aDetSD5)\r\n      aDetSD5[I,09] := \"Problema\"\r\n   Next\r\nEndif\r\n\r\nIF Len(aDetSB8) == 0\r\n                  //Data            ,Lote     ,Num.Lote ,Validade        ,Saldo,Qtde.Original,Status   ,Empenho,Qtde.2UM,Empenho 2UM\r\n   Aadd(aDetSB8   ,{CTOD(\"  /  /  \"),Space(10),Space(06),CTOD(\"  /  /  \"),0    ,0            ,Space(08),0      ,0       ,0})\r\n   oDetSB8:nAT := 1\r\nEndif\r\n\r\nIF Len(aDetSD5) == 0\r\n                  //Data            ,TM       ,Lote     ,Num.Lote ,Validade        ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja\r\n   Aadd(aDetSD5   ,{CTOD(\"  /  /  \"),Space(03),Space(10),Space(06),CTOD(\"  /  /  \"),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n   oDetSD5:nAT := 1\r\nElse                          \r\n   oDetSD5:nAT := Len(aDetSD5)\r\nEndif\r\n\r\noDetSB8:Refresh()\r\noDetSD5:Refresh()\r\n   \r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaSBF()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SBF\")\r\n\r\naSize(aDetSBF, 0)\r\naSize(aDetSDB, 0)\r\n\r\n// Movimento do SBF\r\ncQuery := \" SELECT BF_LOCALIZ,BF_LOTECTL,BF_QUANT,BF_QTSEGUM,BF_EMPENHO,BF_EMPEN2,BF_ESTFIS,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SBF\")\r\ncQuery += \" WHERE BF_FILIAL='\"+xFilial(\"SBF\")+\"' AND BF_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBF\")+\".D_E_L_E_T_ <> '*' AND BF_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND BF_QUANT <> 0 ORDER BY BF_LOCALIZ,BF_LOTECTL\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBF\",.F.,.T.)\r\nWhile !Eof()                                        \r\n  DBSelectArea(\"SBE\")\r\n  DBSetOrder(1) //BE_FILIAL+BE_LOCAL+BE_LOCALIZ\r\n  DBSeek(xFilial(\"SBE\")+cLocal+QrySBF->BF_LOCALIZ)\r\n  \r\n  cEndStatus := \"\"\r\n  IF (nSeek := Ascan(aSx3Box, { |x| x[ 2 ] == SBE->BE_STATUS })) > 0\r\n     cEndStatus := AllTrim( aSx3Box[ nSeek, 3 ] )\r\n  Endif\r\n\r\n  DBSelectArea(\"DC8\")\r\n  DBSetOrder(1) \r\n  DBSeek(xFilial(\"DC8\")+QrySBF->BF_ESTFIS)\r\n    \r\n  AAdd(aDetSBF,{QrySBF->BF_LOCALIZ,QrySBF->BF_LOTECTL,QrySBF->BF_QUANT,SPACE(06),QrySBF->BF_EMPENHO,QrySBF->BF_ESTFIS+\" - \"+Substr(DC8->DC8_DESEST,1,15),cEndStatus,SBE->BE_CODZON,QrySBF->BF_QTSEGUM,QrySBF->BF_EMPEN2,QrySBF->RECNO})\r\n\r\n  DBSelectArea(\"QrySBF\")\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nIF Len(aDetSBF) == 0\r\n                  //Localização,Lote    ,Quantidade,Status   ,Empenho,Estrutura,Status End,Zona     ,Qtde.2UM,Empenho 2UM\"\r\n   Aadd(aDetSBF   ,{Space(15)  ,Space(10),0        ,Space(08),0      ,Space(01),Space(01) ,Space(01),0       ,0          ,Space(01)})\r\n   oDetSBF:nAT := 1\r\nEndif\r\n\r\nIF Len(aDetSDB) == 0\r\n                  //Origem   ,Data            ,TM       ,Localização,Lote     ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja \r\n   Aadd(aDetSDB   ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(15)  ,Space(10),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n   oDetSDB:nAT := 1\r\nEndif\r\n\r\noDetSBF:Refresh()\r\noDetSDB:Refresh()   \r\n\r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaSDB()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SDB\")\r\n\r\naSize(aDetSDB, 0)\r\naSize(aDetSBF, 0)\r\n\r\ncQuery := \" SELECT DB_ORIGEM,DB_DATA,DB_TM,DB_LOCALIZ,DB_LOTECTL,DB_QUANT,DB_NUMSEQ,DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SDB\")\r\ncQuery += \" WHERE DB_FILIAL='\"+xFilial(\"SDB\")+\"' AND DB_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDB\")+\".D_E_L_E_T_ <> '*' AND DB_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DB_ESTORNO= ' ' AND DB_ATUEST='S'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySDB\",.F.,.T.)\r\nTCSETFIELD( \"QrySDB\",\"DB_DATA\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aDetSDB,{DB_ORIGEM,DB_DATA,DB_TM,DB_LOCALIZ,DB_LOTECTL,DB_QUANT,0,DB_NUMSEQ,Space(06),DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,QrySDB->RECNO})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\naSort(aDetSDB,,, { |x,y| y[4]+y[5]+y[8]+y[3] > x[4]+x[5]+x[8]+x[3]} )      \r\n\r\nIF Len(aDetSBF) == 0\r\n                  //Localização,Lote    ,Quantidade,Status   ,Empenho,Estrutura,Status End,Zona     ,Qtde.2UM,Empenho 2UM\"\r\n   Aadd(aDetSBF   ,{Space(15)  ,Space(10),0        ,Space(08),0      ,Space(01),Space(01) ,Space(01),0       ,0          ,Space(01)})\r\n   oDetSBF:nAT := 1\r\nEndif\r\nIF Len(aDetSDB) == 0\r\n                  //Origem   ,Data            ,TM       ,Localização,Lote     ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja \r\n   Aadd(aDetSDB   ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(15)  ,Space(10),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n   oDetSDB:nAT := 1\r\nEndif\r\n\r\noDetSDB:Refresh()\r\noDetSBF:Refresh()\r\n   \r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fMontaSBF(lFiltro)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIF Len(aDetSDB) = 0 .OR. Empty(aDetSDB[1,1])\r\n   Return\r\nEndif\r\n\r\nIncProc(\"Processando Detalhe - SBF\")\r\n\r\naSize(aDetSBF, 0)\r\n\r\n// Movimento do SBF\r\ncQuery := \" SELECT BF_LOCALIZ,BF_LOTECTL,BF_QUANT,BF_QTSEGUM,BF_EMPENHO,BF_EMPEN2,BF_ESTFIS,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SBF\")\r\ncQuery += \" WHERE BF_FILIAL='\"+xFilial(\"SBF\")+\"' AND BF_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBF\")+\".D_E_L_E_T_ <> '*' AND BF_PRODUTO = '\"+cProduto+\"'\"\r\nIF lFiltro\r\n   cQuery += \" AND BF_QUANT <> 0 AND BF_LOCALIZ = '\"+aDetSDB[oDetSDB:nAT][4]+\"' AND BF_LOTECTL = '\"+aDetSDB[oDetSDB:nAT][5]+\"' ORDER BY BF_LOCALIZ,BF_LOTECTL\"\r\nEndif   \r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBF\",.F.,.T.)\r\nWhile !Eof() \r\n  DBSelectArea(\"SBE\")\r\n  DBSetOrder(1) //BE_FILIAL+BE_LOCAL+BE_LOCALIZ\r\n  DBSeek(xFilial(\"SBE\")+cLocal+QrySBF->BF_LOCALIZ)\r\n  \r\n  cEndStatus := \"\"\r\n  IF (nSeek := Ascan(aSx3Box, { |x| x[ 2 ] == SBE->BE_STATUS })) > 0\r\n     cEndStatus := AllTrim( aSx3Box[ nSeek, 3 ] )\r\n  Endif\r\n\r\n  DBSelectArea(\"DC8\")\r\n  DBSetOrder(1) \r\n  DBSeek(xFilial(\"DC8\")+QrySBF->BF_ESTFIS)\r\n    \r\n  AAdd(aDetSBF,{QrySBF->BF_LOCALIZ,QrySBF->BF_LOTECTL,QrySBF->BF_QUANT,SPACE(06),QrySBF->BF_EMPENHO,QrySBF->BF_ESTFIS+\" - \"+Substr(DC8->DC8_DESEST,1,15),cEndStatus,SBE->BE_CODZON,QrySBF->BF_QTSEGUM,QrySBF->BF_EMPEN2,QrySBF->RECNO})\r\n\r\n  DBSelectArea(\"QrySBF\")\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nIF Len(aDetSBF) == 0\r\n   nSaldo := 0\r\n   For J:= 1 To Len(aDetSDB)\r\n     IF aDetSDB[oDetSDB:nAT][4]+aDetSDB[oDetSDB:nAT][5] == aDetSDB[J,4]+aDetSDB[J,5]\r\n        nSaldo += IF(aDetSDB[J,3] <= \"500\" .OR. Substr(aDetSDB[J,3],1,2) $ 'DE/PR/MA' .OR. aDetSDB[J,3] = \"SBK\" ,aDetSDB[J,6],aDetSDB[J,6]*-1)\r\n        aDetSDB[J,7] := nSaldo\r\n        aDetSDB[J,9] := \"OK\"\r\n     Endif   \r\n   Next\r\n   IF nSaldo <> 0\r\n      For J:= 1 To Len(aDetSDB)\r\n        IF aDetSDB[oDetSDB:nAT][4]+aDetSDB[oDetSDB:nAT][5] == aDetSDB[J,4]+aDetSDB[J,5]\r\n           aDetSDB[J,9] := \"Problema\"\r\n        Endif   \r\n      Next\r\n   Endif\r\nElse\r\n   For I:= 1 To Len(aDetSBF)  \r\n     nSaldo := 0\r\n     For J:= 1 To Len(aDetSDB)\r\n       IF aDetSBF[I,1]+aDetSBF[I,2] == aDetSDB[J,4]+aDetSDB[J,5]\r\n          nSaldo += IF(aDetSDB[J,3] <= \"500\" .OR. Substr(aDetSDB[J,3],1,2) $ 'DE/PR/MA' .OR. aDetSDB[J,3] = \"SBK\",aDetSDB[J,6],aDetSDB[J,6]*-1)\r\n          aDetSDB[J,7] := nSaldo\r\n          aDetSDB[J,9] := \"OK\"\r\n       Endif   \r\n     Next\r\n     aDetSBF[I,4] := \"OK\"\r\n     IF aDetSBF[I,3] <> nSaldo\r\n        aDetSBF[I,4] := \"Problema\"\r\n        For J:= 1 To Len(aDetSDB)\r\n           IF aDetSBF[I,1]+aDetSBF[I,2] == aDetSDB[J,4]+aDetSDB[J,5]\r\n              aDetSDB[J,9] := \"Problema\"\r\n           Endif   \r\n        Next\r\n      Endif           \r\n   Next\r\nEndif               \r\n\r\nIF Len(aDetSBF) == 0\r\n                  //Localização,Lote    ,Quantidade,Status   ,Empenho,Estrutura,Status End,Zona     ,Qtde.2UM,Empenho 2UM\"\r\n   Aadd(aDetSBF   ,{Space(15)  ,Space(10),0        ,Space(08),0      ,Space(01),Space(01) ,Space(01),0       ,0          ,Space(01)})\r\n   oDetSBF:nAT := 1\r\nEndif  \r\n\r\nIF Len(aDetSDB) == 0\r\n                  //Origem   ,Data            ,TM       ,Localização,Lote     ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja \r\n   Aadd(aDetSDB   ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(15)  ,Space(10),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n   oDetSDB:nAT := 1\r\nEndif\r\n\r\noDetSBF:Refresh()\r\noDetSDB:Refresh()   \r\n\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fMontaSDB()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIF Len(aDetSBF) = 0 .OR. Empty(aDetSBF[1,1])\r\n   Return\r\nEndif\r\n\r\nIncProc(\"Processando Detalhe - SDB\")\r\n\r\naSize(aDetSDB, 0)    \r\n\r\ncQuery := \" SELECT DISTINCT BK_LOCALIZ AS LOCALIZ,BK_LOTECTL AS LOTECTL FROM \"+RETSQLNAME(\"SBK\")\r\ncQuery += \" WHERE BK_FILIAL='\"+xFilial(\"SBK\")+\"' AND BK_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBK\")+\".D_E_L_E_T_ <> '*' AND BK_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND BK_DATA = '\"+DTOS(dUltFech)+\"' AND BK_QINI <> 0 \"\r\ncQuery += \" AND BK_LOCALIZ = '\"+aDetSBF[oDetSBF:nAT][1]+\"' AND BK_LOTECTL = '\"+aDetSBF[oDetSBF:nAT][2]+\"'\"\r\ncQuery += \" UNION\"\r\ncQuery += \" SELECT DISTINCT DB_LOCALIZ AS LOCALIZ,DB_LOTECTL AS LOTECTL FROM \"+RETSQLNAME(\"SDB\")\r\ncQuery += \" WHERE DB_FILIAL='\"+xFilial(\"SDB\")+\"' AND DB_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDB\")+\".D_E_L_E_T_ <> '*' AND DB_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DB_ESTORNO=' ' AND DB_ATUEST='S' AND DB_DATA >= '\"+DTOS(dDataI)+\"' AND DB_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" AND DB_LOCALIZ = '\"+aDetSBF[oDetSBF:nAT][1]+\"' AND DB_LOTECTL = '\"+aDetSBF[oDetSBF:nAT][2]+\"'\"\r\ncQuery += \" UNION\"\r\ncQuery += \" SELECT DISTINCT BF_LOCALIZ AS LOCALIZ,BF_LOTECTL AS LOTECTL FROM \"+RETSQLNAME(\"SBF\")\r\ncQuery += \" WHERE BF_FILIAL='\"+xFilial(\"SBF\")+\"' AND BF_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBF\")+\".D_E_L_E_T_ <> '*' AND BF_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND BF_QUANT <> 0 AND BF_LOCALIZ = '\"+aDetSBF[oDetSBF:nAT][1]+\"' AND BF_LOTECTL = '\"+aDetSBF[oDetSBF:nAT][2]+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n  // Movimento do SBK\r\n  cQuery := \" SELECT BK_LOCALIZ,BK_LOTECTL,SUM(BK_QINI) AS BK_QINI FROM \"+RETSQLNAME(\"SBK\")\r\n  cQuery += \" WHERE BK_FILIAL='\"+xFilial(\"SBK\")+\"' AND BK_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBK\")+\".D_E_L_E_T_ <> '*' AND BK_COD = '\"+cProduto+\"'\"\r\n  cQuery += \" AND BK_DATA = '\"+DTOS(dUltFech)+\"' AND BK_LOCALIZ  = '\"+QryTRB->LOCALIZ+\"' AND BK_LOTECTL  = '\"+QryTRB->LOTECTL+\"'\"\r\n  cQuery += \" GROUP BY BK_LOCALIZ,BK_LOTECTL\"           \r\n  cQuery := ChangeQuery(cQuery)\r\n  DBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBK\",.F.,.T.)\r\n  AAdd(aDetSDB,{\"SBK\",dUltFech,Space(03),BK_LOCALIZ,BK_LOTECTL,BK_QINI,0,Space(06),Space(6),Space(6),Space(3),Space(6),Space(2),0})\r\n  DBCloseArea()\r\n  DBSelectArea(\"QryTRB\")\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\ncQuery := \" SELECT DB_ORIGEM,DB_DATA,DB_TM,DB_LOCALIZ,DB_LOTECTL,DB_QUANT,DB_NUMSEQ,DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SDB\")\r\ncQuery += \" WHERE DB_FILIAL='\"+xFilial(\"SDB\")+\"' AND DB_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDB\")+\".D_E_L_E_T_ <> '*' AND DB_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DB_ESTORNO= ' ' AND DB_ATUEST='S' AND DB_LOCALIZ = '\"+aDetSBF[oDetSBF:nAT][1]+\"' AND DB_LOTECTL = '\"+aDetSBF[oDetSBF:nAT][2]+\"'\"\r\ncQuery += \" AND DB_DATA >= '\"+DTOS(dDataI)+\"' AND DB_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySDB\",.F.,.T.)\r\nTCSETFIELD( \"QrySDB\",\"DB_DATA\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aDetSDB,{DB_ORIGEM,DB_DATA,DB_TM,DB_LOCALIZ,DB_LOTECTL,DB_QUANT,0,DB_NUMSEQ,Space(6),DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,QrySDB->RECNO})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\naSort(aDetSDB,,, { |x,y| y[8]+STR(y[14]) > x[8]+STR(x[14])} )      \r\n\r\nnSaldo := 0\r\nFor I:= 1 To Len(aDetSDB)\r\n   IF !Empty(aDetSDB[I,1])\r\n      nSaldo += IF(aDetSDB[I,3] <= \"500\" .OR. Substr(aDetSDB[I,3],1,2) $ 'DE/PR/MA' .OR. aDetSDB[I,3] = \"SBK\",aDetSDB[I,6],aDetSDB[I,6]*-1)\r\n      aDetSDB[I,7] := nSaldo\r\n   Else\r\n      nSaldo := 0\r\n   Endif   \r\nNext\r\n\r\naDetSBF[oDetSBF:nAT][4] := \"OK\"\r\nIF nSaldo <> aDetSBF[oDetSBF:nAT][3]\r\n   aDetSBF[oDetSBF:nAT][4] := \"Problema\"\r\nEndif\r\n\r\nIF Len(aDetSBF) == 0\r\n                  //Localização,Lote    ,Quantidade,Status   ,Empenho,Estrutura,Status End,Zona     ,Qtde.2UM,Empenho 2UM\"\r\n   Aadd(aDetSBF   ,{Space(15)  ,Space(10),0        ,Space(08),0      ,Space(01),Space(01) ,Space(01),0       ,0          ,Space(01)})\r\n   oDetSBF:nAT := 1\r\nEndif\r\n\r\nIF Len(aDetSDB) == 0\r\n                  //Origem   ,Data            ,TM       ,Localização,Lote     ,Quantidade,Saldo,Num.Seq. ,Status   ,Documento,Serie    ,Clie.For ,Loja \r\n   Aadd(aDetSDB   ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(15)  ,Space(10),0         ,0    ,Space(06),Space(08),Space(06),Space(03),Space(06),Space(02),Space(01)})\r\n   oDetSDB:nAT := 1\r\nElse\r\n   oDetSDB:nAT := Len(aDetSDB)   \r\nEndif\r\n\r\noDetSDB:Refresh()\r\noDetSBF:Refresh()\r\n   \r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaB8BF()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SB8xSBF\")\r\ncMensB8BF   := \"\"\r\n\r\naSize(aDet01B8BF, 0)\r\naSize(aDet02B8BF, 0)\r\n\r\n// Movimento do SB8\r\ncQuery := \" SELECT B8_LOTECTL,SUM(B8_SALDO) AS B8_SALDO,SUM(B8_SALDO2) AS B8_SALDO2,SUM(B8_EMPENHO) AS B8_EMPENHO,SUM(B8_EMPENH2) AS B8_EMPENH2,SUM(B8_QACLASS) AS B8_QACLASS,SUM(B8_QACLAS2) AS B8_QACLAS2 FROM \"+RETSQLNAME(\"SB8\")\r\ncQuery += \" WHERE B8_FILIAL='\"+xFilial(\"SB8\")+\"' AND B8_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SB8\")+\".D_E_L_E_T_ <> '*' AND B8_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND B8_SALDO <> 0  GROUP BY B8_LOTECTL\"\r\n//cQuery += \" AND B8_SALDO <> 0 AND B8_DATA <= '\"+DTOS(dDataF)+\"' GROUP BY B8_LOTECTL\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySB8\",.F.,.T.)\r\nWhile !Eof() \r\n  AAdd(aDet01B8BF,{B8_LOTECTL,B8_SALDO,B8_EMPENHO,B8_QACLASS,B8_SALDO2,B8_EMPENH2,B8_QACLAS2,\"OK\"})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// Movimento do SBF\r\ncQuery := \" SELECT BF_LOTECTL,SUM(BF_QUANT) AS BF_QUANT,SUM(BF_QTSEGUM) AS BF_QTSEGUM,SUM(BF_EMPENHO) AS BF_EMPENHO,SUM(BF_EMPEN2) AS BF_EMPEN2 FROM \"+RETSQLNAME(\"SBF\")\r\ncQuery += \" WHERE BF_FILIAL='\"+xFilial(\"SBF\")+\"' AND BF_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBF\")+\".D_E_L_E_T_ <> '*' AND BF_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND BF_QUANT <> 0 GROUP BY BF_LOTECTL\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBF\",.F.,.T.)\r\nWhile !Eof() \r\n  AAdd(aDet02B8BF,{BF_LOTECTL,BF_QUANT,BF_EMPENHO,BF_QTSEGUM,BF_EMPEN2,\"OK\"})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nIF  SB1->B1_RASTRO == \"L\"  .AND. SB1->B1_LOCALIZ == \"S\"\r\n   For I:= 1 To Len(aDet01B8BF)\r\n     nPos := Ascan(aDet02B8BF,{ |x| x[1] == aDet01B8BF[I,1] })\r\n     IF nPos == 0 .AND. (aDet01B8BF[I,2] - aDet01B8BF[I,4]) <> 0\r\n        aDet01B8BF[I,8] := \"Analisar\"\r\n        cMensB8BF       := \"Entre o SB8 x SBF\"\r\n     ElseIF nPos > 0 .AND. (aDet01B8BF[I,2]- aDet01B8BF[I,4]) <> aDet02B8BF[nPos,2]\r\n        aDet01B8BF[I,8] := \"Analisar\"\r\n        cMensB8BF       := \"Entre o SB8 x SBF\"\r\n     Endif\r\n   Next\r\n\r\n   For I:= 1 To Len(aDet02B8BF)\r\n     nPos := Ascan(aDet01B8BF,{ |x| x[1] == aDet02B8BF[I,1] })\r\n     IF nPos == 0 .OR. aDet02B8BF[I,2] <> (aDet01B8BF[nPos,2]-aDet01B8BF[nPos,4])\r\n        aDet02B8BF[I,6] := \"Analisar\"\r\n        cMensB8BF       := \"Entre o SB8 x SBF\"\r\n     Endif\r\n   Next\r\nEndif\r\n\r\nIF Len(aDet01B8BF) == 0\r\n                  //Lote     ,Qtde.,Empenho,A Classificar,Qtde.2UM,Empenho 2UM,A Classificar 2UM,Status\r\n   Aadd(aDet01B8BF,{Space(10),0    ,0      ,0            ,0       ,0          ,0                ,Space(08)})\r\n   oDet01B8BF:nAT := 1\r\nEndif\r\n\r\nIF Len(aDet02B8BF) == 0\r\n                  //Lote     ,Qtde.,Empenho,Qtde.2UM,Empenho 2UM,Status\r\n   Aadd(aDet02B8BF,{Space(10),0    ,0      ,0       ,0          ,Space(08)})\r\n   oDet02B8BF:nAT := 1\r\nEndif\r\n\r\noDet01B8BF:Refresh()\r\noDet02B8BF:Refresh()\r\n   \r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaBJBK()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SBJxSBK\")\r\n\r\ncMensBJBK   := \"\"\r\n\r\naSize(aDetSBJ, 0)\r\naSize(aDetSBK, 0)\r\n\r\n// Movimento do SBJ\r\ncQuery := \" SELECT BJ_LOTECTL,SUM(BJ_QINI) AS BJ_QINI,SUM(BJ_QISEGUM) AS BJ_QISEGUM FROM \"+RETSQLNAME(\"SBJ\")\r\ncQuery += \" WHERE BJ_FILIAL='\"+xFilial(\"SBJ\")+\"' AND BJ_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBJ\")+\".D_E_L_E_T_ <> '*' AND BJ_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND BJ_QINI <> 0  AND BJ_DATA = '\"+DTOS(dUltFech)+\"' GROUP BY BJ_LOTECTL\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBJ\",.F.,.T.)\r\nWhile !Eof() \r\n  AAdd(aDetSBJ,{BJ_LOTECTL,BJ_QINI,BJ_QISEGUM,\"OK\"})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// Movimento do SBK\r\ncQuery := \" SELECT BK_LOTECTL,SUM(BK_QINI) AS BK_QINI,SUM(BK_QISEGUM) AS BK_QISEGUM FROM \"+RETSQLNAME(\"SBK\")\r\ncQuery += \" WHERE BK_FILIAL='\"+xFilial(\"SBK\")+\"' AND BK_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBK\")+\".D_E_L_E_T_ <> '*' AND BK_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND BK_QINI <> 0  AND BK_DATA = '\"+DTOS(dUltFech)+\"' GROUP BY BK_LOTECTL\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBK\",.F.,.T.)\r\nWhile !Eof() \r\n  AAdd(aDetSBK,{BK_LOTECTL,BK_QINI,BK_QISEGUM,\"OK\"})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nIF SB1->B1_LOCALIZ == \"S\"  .AND. SB1->B1_RASTRO=\"L\"\r\n   For I:= 1 To Len(aDetSBJ)\r\n     nPos := Ascan(aDetSBK,{ |x| x[1] == aDetSBJ[I,1] })\r\n     IF nPos == 0 .OR. aDetSBJ[I,2] <> aDetSBK[nPos,2]\r\n        IF nPos == 0 .OR. aDetSBJ[I,2] < aDetSBK[nPos,2]\r\n           aDetSBJ[I,4] := \"Analisar\"            \r\n           cMensBJBK    := \"Entre o SBJ x SBK\"\r\n        Endif   \r\n     Endif\r\n   Next\r\n\r\n   For I:= 1 To Len(aDetSBK)\r\n     nPos := Ascan(aDetSBJ,{ |x| x[1] == aDetSBK[I,1] })\r\n     IF nPos == 0 .OR. aDetSBK[I,2] <> aDetSBJ[nPos,2]\r\n        IF nPos == 0 .OR. aDetSBK[I,2] > aDetSBJ[nPos,2]\r\n           aDetSBK[I,4] := \"Analisar\"\r\n           cMensBJBK    := \"Entre o SBJ x SBK\"\r\n        Endif   \r\n      Endif\r\n   Next\r\nEndif\r\n\r\nIF Len(aDetSBK) == 0\r\n                  //Lote     ,Qtde.,Qtde.2UM,Status\r\n   Aadd(aDetSBK   ,{Space(10),0    ,0       ,Space(08)})\r\n   oDetSBK:nAT := 1\r\nEndif\r\nIF Len(aDetSBJ) == 0\r\n      \t           //Lote     ,Qtde.,Qtde.2UM,Status\r\n   Aadd(aDetSBJ   ,{Space(10),0    ,0       ,Space(08)})\r\n   oDetSBJ:nAT := 1\r\nEndif   \r\n\r\noDetSBJ:Refresh()\r\noDetSBK:Refresh()\r\n   \r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaSBJ()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SBJ\")\r\n\r\naSize(aAnaSBJ, 0)\r\n\r\n// Movimento do SBJ\r\ncQuery := \" SELECT BJ_LOTECTL,BJ_NUMLOTE,BJ_DTVALID,BJ_QINI,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SBJ\")\r\ncQuery += \" WHERE BJ_FILIAL='\"+xFilial(\"SBJ\")+\"' AND BJ_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBJ\")+\".D_E_L_E_T_ <> '*' AND BJ_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND BJ_DATA = '\"+DTOS(dUltFech)+\"' ORDER BY BJ_LOTECTL,BJ_NUMLOTE\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBJ\",.F.,.T.)\r\nTCSETFIELD( \"QrySBJ\",\"BF_DTVALID\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aAnaSBJ,{BJ_LOTECTL,BJ_NUMLOTE,BJ_DTVALID,BJ_QINI,QrySBJ->RECNO})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nIF Len(aDetSBJ) == 0\r\n     \t           //Lote     ,Qtde.,Qtde.2UM,Status\r\n   Aadd(aDetSBJ   ,{Space(10),0    ,0       ,Space(08)})\r\n   oDetSBJ:nAT := 1\r\nEndif   \r\nIF Len(aAnaSBJ) == 0\r\n      \t           //Lote     ,Nunlote  ,Validade        ,Quantidade\r\n   Aadd(aAnaSBJ   ,{Space(10),Space(06),CTOD(\"  /  /  \"),0         ,Space(08)})\r\n   oAnaSBJ:nAT := 1\r\nEndif\r\n\r\noAnaSBJ:Refresh()\r\n   \r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaSBK()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SBK\")\r\n\r\naSize(aAnaSBK, 0)\r\n\r\n// Movimento do SBK\r\ncQuery := \" SELECT BK_LOCALIZ,BK_LOTECTL,BK_QINI,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SBK\")\r\ncQuery += \" WHERE BK_FILIAL='\"+xFilial(\"SBK\")+\"' AND BK_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBK\")+\".D_E_L_E_T_ <> '*' AND BK_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND BK_DATA = '\"+DTOS(dUltFech)+\"' ORDER BY BK_LOCALIZ,BK_LOTECTL\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBK\",.F.,.T.)\r\nWhile !Eof() \r\n  AAdd(aAnaSBK,{BK_LOCALIZ,BK_LOTECTL,BK_QINI,QrySBK->RECNO})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nIF Len(aDetSBK) == 0\r\n                  //Lote     ,Qtde.,Qtde.2UM,Status\r\n   Aadd(aDetSBK   ,{Space(10),0    ,0       ,Space(08)})\r\n   oDetSBK:nAT := 1\r\nEndif\r\nIF Len(aAnaSBK) == 0\r\n                  //Endereco ,Lote     ,Quantidade\r\n   Aadd(aAnaSBK   ,{Space(15),Space(10),0         ,Space(08)})\r\n   oAnaSBK:nAT := 1\r\nEndif\r\n\r\noAnaSBK:Refresh()\r\n   \r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaSDA()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SDA\")\r\n\r\ncMensDocto  := \"\"\r\ncMensNumSeq := \"\"\r\n\r\naSize(aDetDASDA,0)\r\n\r\ncQuery := \" SELECT DA_DATA,DA_QTDORI,DA_SALDO,DA_LOTECTL,DA_NUMSEQ,DA_ORIGEM,DA_DOC,DA_SERIE,DA_CLIFOR,DA_LOJA,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SDA\")\r\ncQuery += \" WHERE DA_FILIAL='\"+xFilial(\"SDA\")+\"' AND DA_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDA\")+\".D_E_L_E_T_ <> '*' AND DA_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DA_SALDO <> 0 AND DA_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySDA\",.F.,.T.)\r\nTCSETFIELD( \"QrySDA\",\"DA_DATA\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aDetDASDA,{DA_DATA,DA_LOTECTL,DA_SALDO,0,DA_QTDORI,DA_NUMSEQ,DA_ORIGEM,DA_DOC,DA_SERIE,DA_CLIFOR,DA_LOJA,\"OK\",QrySDA->RECNO})\r\n/*\r\n  nPos := Ascan(aDocto,{|x|x[1]== DA_DOC })\r\n  IF nPos == 0\r\n     AAdd(aDocto,{DA_DOC,DA_SERIE,DA_CLIFOR,DA_LOJA,0 ,0 ,0   ,0   ,0   ,0   ,DA_SALDO,0,\"SDA\",\"OK\",Space(01),Space(01),Space(01)})\r\n//                                                  D1,D2,D3_E,D3_S,D5_E,D5_S,DB_E    ,DB_S\r\n  Else\r\n     aDocto[nPos,11] += DA_SALDO\r\n  Endif   \r\n*/\r\n  nPos := Ascan(aNumSeq,{|x|x[1]== DA_NUMSEQ })\r\n  IF nPos == 0\r\n     AAdd(aNumSeq,{DA_NUMSEQ,0 ,0 ,0   ,0   ,0   ,0   ,DA_SALDO,0,\"SDA\",\"OK\",DA_DATA,DA_DOC,DA_SERIE,DA_CLIFOR,DA_LOJA,Space(01),Space(01),Space(01)})\r\n//                           D1,D2,D3_E,D3_S,D5_E,D5_S,DB_E    ,DB_S\r\n  Else                                    \r\n     aNumSeq[nPos,8] += DA_SALDO\r\n  Endif   \r\n \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\naSort(aDetDASDA,,, { |x,y| y[6] > x[6]} )      \r\naSort(aNumSeq  ,,, { |x,y| y[1] > x[1]} )      \r\n//aSort(aDocto   ,,, { |x,y| y[1] > x[1]} )      \r\n\r\nnSaldo := 0\r\nFor I:= 1 To Len(aDetDASDA)\r\n   nSaldo += aDetDASDA[I,3]\r\n   aDetDASDA[I,4] := nSaldo\r\nNext\r\n\r\n//                           D1,D2,D3_E,D3_S,D5_E,D5_S,DB_E,DB_S\r\n//                           5  6  7    8    9    10   11   12\r\n/* Desabilitado por nao ter muita funcionalidade\r\nFor I:= 1 To Len(aDocto)\r\n  IF SB1->B1_LOCALIZ = \"S\" .AND. SB1->B1_RASTRO = \"L\"\r\n     IF aDocto[I,13] = \"SD1\" .AND. (aDocto[I,5] <> aDocto[I,9] .OR. aDocto[I,5] <> aDocto[I,11] .OR. aDocto[I,9] <> aDocto[I,11])\r\n        aDocto[I,14] := \"Analisar\"\r\n        cMensDocto   := \"No Documento\"\r\n     Endif  \r\n     // SD2\r\n     IF aDocto[I,13] = \"SD2\" .AND. (aDocto[I,6] <> aDocto[I,10] .OR. aDocto[I,6] <> aDocto[I,12] .OR. aDocto[I,10] <> aDocto[I,12])\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif\r\n     // SD3\r\n     IF aDocto[I,13] = \"SD3\" .AND. (aDocto[I,7] <> aDocto[I,9] .OR. aDocto[I,7] <> aDocto[I,11] .OR. aDocto[I,9] <> aDocto[I,11])\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif\r\n     // SD3\r\n     IF aDocto[I,13] = \"SD3\" .AND. (aDocto[I,8] <> aDocto[I,10] .OR. aDocto[I,8] <> aDocto[I,12] .OR. aDocto[I,10] <> aDocto[I,12])\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif \r\n     IF aDocto[I,13] = \"SD5\" .OR. aDocto[I,13] = \"SDB\" .OR. aDocto[I,13] = \"SDA\"\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif \r\n  ElseIF SB1->B1_LOCALIZ = \"S\"\r\n       IF aDocto[I,13] = \"SD1\" .AND. (aDocto[I,5] <> aDocto[I,11])\r\n        aDocto[I,14] := \"Analisar\"\r\n        cMensDocto   := \"No Documento\"\r\n     Endif  \r\n     // SD2\r\n     IF aDocto[I,13] = \"SD2\" .AND. (aDocto[I,6] <> aDocto[I,12])\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif\r\n     // SD3\r\n     IF aDocto[I,13] = \"SD3\" .AND. (aDocto[I,7] <> aDocto[I,11])\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif\r\n     // SD3\r\n     IF aDocto[I,13] = \"SD3\" .AND. (aDocto[I,8] <> aDocto[I,12])\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif \r\n     IF aDocto[I,13] = \"SDB\" .OR. aDocto[I,13] = \"SDA\"\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif \r\n   ElseIF SB1->B1_RASTRO = \"L\"\r\n     IF aDocto[I,13] = \"SD1\" .AND. (aDocto[I,5] <> aDocto[I,9])\r\n        aDocto[I,14] := \"Analisar\"\r\n        cMensDocto   := \"No Documento\"\r\n     Endif  \r\n     // SD2\r\n     IF aDocto[I,13] = \"SD2\" .AND. (aDocto[I,6] <> aDocto[I,10])\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif\r\n     // SD3\r\n     IF aDocto[I,13] = \"SD3\" .AND. (aDocto[I,7] <> aDocto[I,9])\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif\r\n     // SD3\r\n     IF aDocto[I,13] = \"SD3\" .AND. (aDocto[I,8] <> aDocto[I,10])\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif \r\n     IF aDocto[I,13] = \"SD5\"\r\n        aDocto[I,14] := \"Analisar\"    \r\n        cMensDocto   := \"No Documento\"\r\n     Endif \r\n  Endif   \r\nNext\r\n*/\r\n\r\n//                           D1,D2,D3_E,D3_S,D5_E,D5_S,DB_E,DB_S     \r\n//                           2  3  4    5    6    7    8    9\r\nFor I:= 1 To Len(aNumSeq)                            \r\n  IF SB1->B1_LOCALIZ = \"S\" .AND. SB1->B1_RASTRO = \"L\"\r\n     IF aNumSeq[I,10] = \"SD1\" .AND. (aNumSeq[I,2] <> aNumSeq[I,6] .OR. aNumSeq[I,2] <> aNumSeq[I,8] .OR. aNumSeq[I,6] <> aNumSeq[I,8])\r\n        aNumSeq[I,11] := \"Analisar\" \r\n        cMensNumSeq  := \"No NumSeq\"\r\n     Endif  \r\n     // SD2\r\n     IF aNumSeq[I,10] = \"SD2\" .AND. (aNumSeq[I,3] <> aNumSeq[I,7] .OR. aNumSeq[I,3] <> aNumSeq[I,9] .OR. aNumSeq[I,7] <> aNumSeq[I,9])\r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif\r\n     // SD3\r\n     IF aNumSeq[I,10] = \"SD3\" .AND. (aNumSeq[I,4] <> aNumSeq[I,6] .OR. aNumSeq[I,4] <> aNumSeq[I,8] .OR. aNumSeq[I,6] <> aNumSeq[I,8])\r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif\r\n     // SD3\r\n     IF aNumSeq[I,10] = \"SD3\" .AND. (aNumSeq[I,5] <> aNumSeq[I,7] .OR. aNumSeq[I,5] <> aNumSeq[I,9] .OR. aNumSeq[I,7] <> aNumSeq[I,9])\r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif \r\n     IF aNumSeq[I,10] = \"SD5\" .OR. aNumSeq[I,10] = \"SDB\" .OR. aNumSeq[I,10] = \"SDA\" \r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif \r\n  ElseIF SB1->B1_LOCALIZ = \"S\"\r\n     IF aNumSeq[I,10] = \"SD1\" .AND. (aNumSeq[I,2] <> aNumSeq[I,8])\r\n        aNumSeq[I,11] := \"Analisar\" \r\n        cMensNumSeq  := \"No NumSeq\"\r\n     Endif  \r\n     // SD2\r\n     IF aNumSeq[I,10] = \"SD2\" .AND. (aNumSeq[I,3] <> aNumSeq[I,9])\r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif\r\n     // SD3\r\n     IF aNumSeq[I,10] = \"SD3\" .AND. (aNumSeq[I,4] <> aNumSeq[I,8])\r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif\r\n     // SD3\r\n     IF aNumSeq[I,10] = \"SD3\" .AND. (aNumSeq[I,5] <> aNumSeq[I,9])\r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif \r\n     IF aNumSeq[I,10] = \"SDB\" .OR. aNumSeq[I,10] = \"SDA\" \r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif \r\n  ElseIF SB1->B1_RASTRO = \"L\"\r\n     IF aNumSeq[I,10] = \"SD1\" .AND. (aNumSeq[I,2] <> aNumSeq[I,6])\r\n        aNumSeq[I,11] := \"Analisar\" \r\n        cMensNumSeq  := \"No NumSeq\"\r\n     Endif  \r\n     // SD2\r\n     IF aNumSeq[I,10] = \"SD2\" .AND. (aNumSeq[I,3] <> aNumSeq[I,7])\r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif\r\n     // SD3\r\n     IF aNumSeq[I,10] = \"SD3\" .AND. (aNumSeq[I,4] <> aNumSeq[I,6])\r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif\r\n     // SD3\r\n     IF aNumSeq[I,10] = \"SD3\" .AND. (aNumSeq[I,5] <> aNumSeq[I,7])\r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif \r\n     IF aNumSeq[I,10] = \"SD5\" \r\n        aNumSeq[I,11] := \"Analisar\"\r\n        cMensNumSeq   := \"No NumSeq\"\r\n     Endif \r\n  Endif  \r\n  IF !Empty(cMensNumSeq)\r\n     IF nKAR = nSD5 .AND. nKAR = nSDB .AND. nSD5 = nSDB .AND.;\r\n        aNumSeq[I,2] = 0 .AND. aNumSeq[I,3] = 0 .AND. aNumSeq[I,4] = 0 .AND. aNumSeq[I,5] = 0 .AND. aNumSeq[I,6] = 0 .AND. aNumSeq[I,7] = 0 \r\n        aNumSeq[I,11] := \"OK\"\r\n        cMensNumSeq   := \"\"\r\n     Endif\r\n  Endif \r\nNext\r\n\r\nIF Len(aNumSeq) == 0   \r\n                  //Num.Seq. ,SD1,SD2,SD3_E,SD3_S,SD5_E,SD5_S,SDB_E,SDB_S,Origem   ,Status   ,Data            ,Documento,Serie    ,Clie.Forn,Loja     ,Serviço  ,Status Serviço,Serviço Pendente\r\n   Aadd(aNumSeq   ,{Space(06),0  ,0  ,0    ,0    ,0    ,0    ,0    ,0    ,Space(03),Space(08),CTOD(\"  /  /  \"),Space(06),Space(03),Space(06),Space(02),Space(03),Space(01)     ,Space(01)})\r\n   oNumSeq:nAT := 1\r\nEndif\r\n/*\r\nIF Len(aDocto) == 0    \r\n   Aadd(aDocto    ,{Space(06),Space(03),Space(06),Space(02),0,0,0,0,0,0,0,0,Space(03),Space(08),Space(03),Space(01),Space(01)})\r\n   oDocto:nAT := 1\r\nEndif\r\n*/\r\nIF Len(aDetDASDA) == 0\r\n                  //Data             ,Lote    ,A Classificar,Saldo,Qtde.Original,Num.Seq. ,Origem   ,Documento,Serie    ,Clie.For ,Loja     ,Status\r\n   Aadd(aDetDASDA ,{CTOD(\"  /  /  \"),Space(10),0            ,0    ,0            ,Space(06),Space(03),Space(06),Space(03),Space(06),Space(02),Space(08)})\r\n   oDetDASDA:nAT := 1\r\nEndif\r\n  \r\noNumSeq:Refresh()\r\n//oDocto:Refresh()\r\noDetDASDA:Refresh()\r\n   \r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDetaDASB8()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe - SDAxSB8\")\r\n\r\ncMensDAB8   := \"\"\r\n\r\naSize(aDetDASB8, 0)\r\n  \r\ncQuery := \" SELECT B8_DATA,B8_LOTECTL,B8_NUMLOTE,B8_QACLASS,B8_QTDORI,B8_ORIGLAN,B8_DOC,B8_SERIE,B8_CLIFOR,B8_LOJA,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SB8\")   \r\ncQuery += \" WHERE B8_FILIAL='\"+xFilial(\"SB8\")+\"' AND B8_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SB8\")+\".D_E_L_E_T_ <> '*' AND B8_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND B8_QACLASS <> 0  AND B8_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySB8\",.F.,.T.)\r\nTCSETFIELD( \"QrySB8\",\"B8_DATA\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aDetDASB8,{B8_DATA,B8_LOTECTL,B8_NUMLOTE,B8_QACLASS,B8_QTDORI,B8_ORIGLAN,B8_DOC,B8_SERIE,B8_CLIFOR,B8_LOJA,\"OK\",QrySB8->RECNO})\r\n//                1       2          3          4          5         6          7      8        9         10\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nnDASB8 := 0\r\nnDASDa := 0\r\n\r\nIF SB1->B1_LOCALIZ = \"S\" .AND. SB1->B1_RASTRO = \"L\"                \r\n   For I:= 1 To Len(aDetDASB8)\r\n     nDASB8 += aDetDASB8[I,4]\r\n   Next\r\n\r\n   For I:= 1 To Len(aDetDASDA)\r\n     nDASDA += aDetDASDA[I,3]\r\n   Next\r\n   \r\n   IF nDASDA <> nDASB8\r\n      cMensDAB8 := \"Entre DA x B8\"\r\n      For I:= 1 To Len(aDetDASB8)\r\n        aDetDASB8[I,11] := \"Analisar\"\r\n      Next\r\n      For I:= 1 To Len(aDetDASDA)\r\n        aDetDASDA[I,12] := \"Analisar\"     \r\n      Next\r\n   Endif\r\n   \r\nEndif\r\n\r\nIF Len(aDetDASB8) == 0\r\n                  //Data            ,Lote     ,Num.Lote,A Classificar,Qtde.Original,Origem   ,Documento,Serie    ,Clie.For ,Loja     ,Status\r\n   Aadd(aDetDASB8 ,{CTOD(\"  /  /  \"),Space(10),Space(06),0           ,0            ,Space(03),Space(06),Space(03),Space(06),Space(02),Space(08),Space(01)})\r\n   oDetDASB8:nAT := 1\r\nEndif\r\n\r\nIF Len(aDetDASDA) == 0\r\n                  //Data             ,Lote    ,A Classificar,Saldo,Qtde.Original,Num.Seq. ,Origem   ,Documento,Serie    ,Clie.For ,Loja     ,Status\r\n   Aadd(aDetDASDA ,{CTOD(\"  /  /  \"),Space(10),0            ,0    ,0            ,Space(06),Space(03),Space(06),Space(03),Space(06),Space(02),Space(08)})\r\n   oDetDASDA:nAT := 1\r\nEndif\r\n\r\noDetDASB8:Refresh()\r\noDetDASDA:Refresh()        \r\n\r\nReturn\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fKardLocal()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Kardex - Almoxarifado\")\r\n\r\naSize(aKarLocal, 0)\r\n\r\nDBSelectArea(\"SB9\")\r\nDBSetOrder(1) \r\nDBSeek(xFilial(\"SB9\")+cProduto+cLocal+DTOS(dUltFech))\r\n\r\n// Saldo Inicial\r\nAAdd(aKarLocal,{\"SB9\",SB9->B9_DATA,Space(3),Space(3),Space(6),SB9->B9_QINI,SB9->B9_QINI,Space(6)})\r\n\r\n// Movimento do SD1\r\ncQuery := \" SELECT D1_DTDIGIT,D1_TES,D1_CF,D1_DOC,D1_QUANT,D1_NUMSEQ FROM \"+RETSQLNAME(\"SD1\")+\", \"+RETSQLNAME(\"SF4\")\r\ncQuery += \" WHERE D1_FILIAL='\"+xFilial(\"SD1\")+\"' AND D1_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD1\")+\".D_E_L_E_T_ <> '*' AND D1_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND D1_ORIGLAN <> 'LF' AND D1_DTDIGIT >= '\"+DTOS(dDataI)+\"' AND D1_DTDIGIT <= '\"+DTOS(dDataF)+\"'\"                                      \r\ncQuery += \" AND \"+IF(Empty(xFilial(\"SF4\")),\"D1_TES=F4_CODIGO\",\"D1_FILIAL=F4_FILIAL AND D1_TES=F4_CODIGO\")+\" AND F4_ESTOQUE = 'S' AND \"+RETSQLNAME(\"SF4\")+\".D_E_L_E_T_ <> '*'\"\r\ncQuery += \" ORDER BY D1_DTDIGIT,D1_NUMSEQ\"  \r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySD1\",.F.,.T.)\r\nTCSETFIELD( \"QrySD1\",\"D1_DTDIGIT\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aKarLocal,{\"SD1\",D1_DTDIGIT,D1_TES,D1_CF,D1_DOC,D1_QUANT,0,D1_NUMSEQ})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// Movimento do SD2\r\ncQuery := \" SELECT D2_EMISSAO,D2_TES,D2_CF,D2_DOC,D2_QUANT,D2_NUMSEQ FROM \"+RETSQLNAME(\"SD2\")+\", \"+RETSQLNAME(\"SF4\")\r\ncQuery += \" WHERE D2_FILIAL='\"+xFilial(\"SD2\")+\"' AND D2_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD2\")+\".D_E_L_E_T_ <> '*' AND D2_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND D2_ORIGLAN <> 'LF' AND D2_EMISSAO >= '\"+DTOS(dDataI)+\"' AND D2_EMISSAO <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" AND \"+IF(Empty(xFilial(\"SF4\")),\"D2_TES=F4_CODIGO\",\"D2_FILIAL=F4_FILIAL AND D2_TES=F4_CODIGO\")+\" AND F4_ESTOQUE = 'S' AND \"+RETSQLNAME(\"SF4\")+\".D_E_L_E_T_ <> '*'\"\r\ncQuery += \" ORDER BY D2_EMISSAO,D2_NUMSEQ\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySD2\",.F.,.T.)\r\nTCSETFIELD( \"QrySD2\",\"D2_EMISSAO\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aKarLocal,{\"SD2\",D2_EMISSAO,D2_TES,D2_CF,D2_DOC,D2_QUANT,0,D2_NUMSEQ})\r\n  DBSkip()\r\nEnddo    \r\nDBCloseArea()\r\n\r\n// Movimento do SD3\r\ncQuery := \" SELECT D3_EMISSAO,D3_TM,D3_CF,D3_DOC,D3_QUANT,D3_NUMSEQ,R_E_C_N_O_ AS RECNO FROM \"+RETSQLNAME(\"SD3\")\r\ncQuery += \" WHERE D3_FILIAL='\"+xFilial(\"SD3\")+\"' AND D3_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD3\")+\".D_E_L_E_T_ <> '*' AND D3_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND D3_ESTORNO=' ' AND D3_EMISSAO >= '\"+DTOS(dDataI)+\"' AND D3_EMISSAO <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY D3_EMISSAO,D3_NUMSEQ\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySD3\",.F.,.T.)\r\nTCSETFIELD( \"QrySD3\",\"D3_EMISSAO\",\"D\")\r\nWhile !Eof()\r\n  DBSelectArea(\"SD3\")\r\n  DBGoto(QrySD3->RECNO)\r\n  If D3Valido()         \r\n     AAdd(aKarLocal,{\"SD3\",D3_EMISSAO,D3_TM,D3_CF,D3_DOC,D3_QUANT,0,D3_NUMSEQ})\r\n  Endif              \r\n  DBSelectArea(\"QrySD3\")\r\n  DBSkip()\r\nEnddo \r\nDBCloseArea()\r\n\r\naSort(aKarLocal,,, { |x,y| y[8] > x[8] } )   \r\n\r\nnSldKarLocal := aKarLocal[1,6]\r\nFor I:= 2 To Len(aKarLocal)\r\n   nSldKarLocal += IF(aKarLocal[I,3] <= \"500\",aKarLocal[I,6],aKarLocal[I,6]*-1)\r\n   aKarLocal[I,7] := nSldKarLocal\r\nNext\r\n\r\nIF Len(aKarLocal) == 0      \r\n                  //Origem   ,Data            ,TES/TM   ,CFO      ,Documento,Quantidade,Saldo,Num.Seq.\r\n   AAdd(aKarLocal ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(03),Space(06),0         ,0    ,Space(06)})\r\n   oKarLocal:nAT := 1\r\nEndif\r\n\r\noKarLocal:Refresh()\r\n   \r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fKardLote()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Kardex - Lote\")\r\n\r\naSize(aKarLote, 0)\r\n\r\n// Identifica os Lotes               \r\ncQuery := \" SELECT DISTINCT BJ_LOTECTL AS LOTECTL,BJ_NUMLOTE AS NUMLOTE FROM \"+RETSQLNAME(\"SBJ\")\r\ncQuery += \" WHERE BJ_FILIAL='\"+xFilial(\"SBJ\")+\"' AND BJ_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBJ\")+\".D_E_L_E_T_ <> '*' AND BJ_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND BJ_DATA = '\"+DTOS(dUltFech)+\"' AND BJ_QINI <> 0\"\r\ncQuery += \" UNION\"\r\ncQuery += \" SELECT DISTINCT D5_LOTECTL AS LOTECTL,D5_NUMLOTE AS NUMLOTE FROM \"+RETSQLNAME(\"SD5\")\r\ncQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND D5_ESTORNO= ' ' AND D5_DATA >= '\"+DTOS(dDataI)+\"' AND D5_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n  // Movimento do SBJ\r\n  cQuery := \" SELECT BJ_LOTECTL,BJ_NUMLOTE,BJ_DTVALID,SUM(BJ_QINI) AS BJ_QINI FROM \"+RETSQLNAME(\"SBJ\")\r\n  cQuery += \" WHERE BJ_FILIAL='\"+xFilial(\"SBJ\")+\"' AND BJ_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBJ\")+\".D_E_L_E_T_ <> '*' AND BJ_COD = '\"+cProduto+\"'\"\r\n  cQuery += \" AND BJ_DATA = '\"+DTOS(dUltFech)+\"' AND BJ_LOTECTL  = '\"+QryTRB->LOTECTL+\"' AND BJ_NUMLOTE  = '\"+QryTRB->NUMLOTE+\"'\"\r\n  cQuery += \" GROUP BY BJ_LOTECTL,BJ_NUMLOTE,BJ_DTVALID\"\r\n  cQuery := ChangeQuery(cQuery)\r\n  DBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBJ\",.F.,.T.)\r\n  TCSETFIELD( \"QrySBJ\",\"BJ_DTVALID\",\"D\")\r\n  AAdd(aKarLote,{\"SBJ\"  ,dUltFech ,Space(3),Space(6),QryTRB->LOTECTL,QryTRB->NUMLOTE,BJ_DTVALID,BJ_QINI,0        ,Space(30),QryTRB->LOTECTL+QryTRB->NUMLOTE+\"A\"+Space(6)})\r\n  AAdd(aKarLote,{\"SALDO\",dDataF   ,Space(3),Space(6),QryTRB->LOTECTL,QryTRB->NUMLOTE,SPACE(06) ,SPACE(06),0           ,Space(30),QryTRB->LOTECTL+QryTRB->NUMLOTE+\"C\"+Space(6)})\r\n  AAdd(aKarLote,{\"     \",Space(08),Space(3),Space(6),SPACE(06)      ,SPACE(06)      ,SPACE(06) ,SPACE(06),SPACE(06)   ,Space(30),QryTRB->LOTECTL+QryTRB->NUMLOTE+\"D\"+Space(6)})\r\n  DBCloseArea()\r\n  DBSelectArea(\"QryTRB\")\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// Movimento do SD5\r\ncQuery := \" SELECT D5_DATA,D5_ORIGLAN,D5_DOC,D5_LOTECTL,D5_NUMLOTE,D5_DTVALID,D5_QUANT,D5_NUMSEQ FROM \"+RETSQLNAME(\"SD5\")\r\ncQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND D5_ESTORNO= ' ' AND D5_DATA >= '\"+DTOS(dDataI)+\"' AND D5_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY D5_DATA,D5_NUMSEQ\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySD5\",.F.,.T.)\r\nTCSETFIELD( \"QrySD5\",\"D5_DATA\",\"D\")\r\nTCSETFIELD( \"QrySD5\",\"D5_DTVALID\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aKarLote,{\"SD5\",D5_DATA,D5_ORIGLAN,D5_DOC,D5_LOTECTL,D5_NUMLOTE,D5_DTVALID,D5_QUANT,0,D5_NUMSEQ,D5_LOTECTL+D5_NUMLOTE+\"B\"+D5_NUMSEQ})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\naSort(aKarLote,,, { |x,y| y[11]+y[3] > x[11]+x[3] } )   \r\n\r\nnSldKarLote := 0\r\nnSaldo      := 0\r\nnSD5        := 0\r\ncMensSB8    := \"\"                          \r\n\r\nFor I:= 1 To Len(aKarLote)   \r\n  Do Case\r\n    Case aKarLote[I,1] == \"SBJ\"\r\n       nSaldo        := aKarLote[I,8]\r\n       aKarLote[I,9] := nSaldo\r\n    Case aKarLote[I,1] == \"SD5\"\r\n       nSaldo        += IF(aKarLote[I,3] <= \"500\" .OR. Substr(aKarLote[I,3],1,2) $ 'DE/PR/MA',aKarLote[I,8],aKarLote[I,8]*-1)\r\n       aKarLote[I,9] := nSaldo      \r\n    Case aKarLote[I,1] == \"SALDO\"\r\n       aKarLote[I,9] := nSaldo\r\n       nSldKarLote   += nSaldo\r\n       nSD5          += nSaldo\r\n       nSalSB8       := 0     \r\n       nPos := Ascan(aDetSB8,{ |x| x[2]+x[3] == aKarLote[I,5]+aKarLote[I,6] })\r\n       If nPos <> 0  \r\n          nSalSB8 += aDetSB8[nPos,5]\r\n       Endif   \r\n       IF nSaldo <> nSalSB8\r\n          aKarLote[I,10] := \"Saldo SB8:  \"+Alltrim(Str(nSalSB8))+\"     Diferença: \"+Alltrim(Str(ABS(nSalSB8-nSaldo)))\r\n          cMensSB8       := \"SB8 diferente do Kardex por Lote\"\r\n          cMensagem      := \"Execute Saldo Atual\"\r\n       Endif\r\n  EndCase\r\nNext\r\n\r\nIF Len(aKarLote) == 0\r\n                  //Origem   ,Data            ,TM       ,Documento,Lote     ,Num.Lote ,Validade        ,Quantidade,Saldo,Num.Seq.\r\n   AAdd(aKarLote  ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(06),Space(06),Space(08),CTOD(\"  /  /  \"),0         ,0    ,Space(30),Space(01)})\r\n   oKarLote:nAT := 1\r\nEndif\r\n\r\noKarLote:Refresh()\r\n   \r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fKardEnde()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Kardex - Endereco\")\r\n\r\naSize(aKarEnde, 0)\r\n\r\n// Identifica os Enderecos\r\ncQuery := \" SELECT DISTINCT BK_LOCALIZ AS LOCALIZ,BK_LOTECTL AS LOTECTL FROM \"+RETSQLNAME(\"SBK\")\r\ncQuery += \" WHERE BK_FILIAL='\"+xFilial(\"SBK\")+\"' AND BK_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBK\")+\".D_E_L_E_T_ <> '*' AND BK_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND BK_DATA = '\"+DTOS(dUltFech)+\"' AND BK_QINI <> 0\"\r\ncQuery += \" UNION\"\r\ncQuery += \" SELECT DISTINCT DB_LOCALIZ AS LOCALIZ,DB_LOTECTL AS LOTECTL FROM \"+RETSQLNAME(\"SDB\")\r\ncQuery += \" WHERE DB_FILIAL='\"+xFilial(\"SDB\")+\"' AND DB_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDB\")+\".D_E_L_E_T_ <> '*' AND DB_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DB_ESTORNO=' ' AND DB_ATUEST='S' AND DB_DATA >= '\"+DTOS(dDataI)+\"' AND DB_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" UNION\"\r\ncQuery += \" SELECT DISTINCT BF_LOCALIZ AS LOCALIZ,BF_LOTECTL AS LOTECTL FROM \"+RETSQLNAME(\"SBF\")\r\ncQuery += \" WHERE BF_FILIAL='\"+xFilial(\"SBF\")+\"' AND BF_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBF\")+\".D_E_L_E_T_ <> '*' AND BF_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND BF_QUANT <> 0\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n  // Movimento do SBK\r\n  cQuery := \" SELECT BK_LOCALIZ,BK_LOTECTL,SUM(BK_QINI) AS BK_QINI FROM \"+RETSQLNAME(\"SBK\")\r\n  cQuery += \" WHERE BK_FILIAL='\"+xFilial(\"SBK\")+\"' AND BK_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SBK\")+\".D_E_L_E_T_ <> '*' AND BK_COD = '\"+cProduto+\"'\"\r\n  cQuery += \" AND BK_DATA = '\"+DTOS(dUltFech)+\"' AND BK_LOCALIZ  = '\"+QryTRB->LOCALIZ+\"' AND BK_LOTECTL  = '\"+QryTRB->LOTECTL+\"'\"\r\n  cQuery += \" GROUP BY BK_LOCALIZ,BK_LOTECTL\"           \r\n  cQuery := ChangeQuery(cQuery)\r\n  DBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySBK\",.F.,.T.)\r\n  AAdd(aKarEnde,{\"SBK\"  ,dUltFech ,Space(3),Space(6),QryTRB->LOCALIZ,QryTRB->LOTECTL,BK_QINI  ,0        ,Space(6),QryTRB->LOCALIZ+QryTRB->LOTECTL+\"A\"+Space(6)})\r\n  AAdd(aKarEnde,{\"SALDO\",dDataF   ,Space(3),Space(6),QryTRB->LOCALIZ,QryTRB->LOTECTL,SPACE(06),0        ,Space(6),QryTRB->LOCALIZ+QryTRB->LOTECTL+\"C\"+Space(6)})\r\n  AAdd(aKarEnde,{\"     \",Space(08),Space(3),Space(6),SPACE(06)      ,SPACE(06)      ,SPACE(06),SPACE(06),Space(6),QryTRB->LOCALIZ+QryTRB->LOTECTL+\"D\"+Space(6)})\r\n  DBCloseArea()\r\n  DBSelectArea(\"QryTRB\")\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// Movimento do SDB\r\ncQuery := \" SELECT DB_DATA,DB_TM,DB_DOC,DB_LOCALIZ,DB_LOTECTL,DB_QUANT,DB_NUMSEQ FROM \"+RETSQLNAME(\"SDB\")\r\ncQuery += \" WHERE DB_FILIAL='\"+xFilial(\"SDB\")+\"' AND DB_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDB\")+\".D_E_L_E_T_ <> '*' AND DB_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DB_ESTORNO=' ' AND DB_ATUEST='S' AND DB_DATA >= '\"+DTOS(dDataI)+\"' AND DB_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY DB_DATA,DB_NUMSEQ\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QrySDB\",.F.,.T.)\r\nTCSETFIELD( \"QrySDB\",\"DB_DATA\",\"D\")\r\nWhile !Eof() \r\n  AAdd(aKarEnde,{\"SDB\",DB_DATA,DB_TM,DB_DOC,DB_LOCALIZ,DB_LOTECTL,DB_QUANT,0,DB_NUMSEQ,DB_LOCALIZ+DB_LOTECTL+\"B\"+DB_NUMSEQ})\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\naSort(aKarEnde,,, { |x,y| y[10]+y[3] > x[10]+x[3] } )   \r\n\r\nnSldKarEnde := 0\r\nnSaldo      := 0\r\nnSDB        := 0  \r\ncMensSBF    := \"\"\r\n\r\nFor I:= 1 To Len(aKarEnde)   \r\n  Do Case\r\n    Case aKarEnde[I,1] == \"SBK\"\r\n       nSaldo        := aKarEnde[I,7]\r\n       aKarEnde[I,8] := nSaldo\r\n    Case aKarEnde[I,1] == \"SDB\"\r\n       nSaldo        += IF(aKarEnde[I,3] <= \"500\" .OR. Substr(aKarEnde[I,3],1,2) $ 'DE/PR/MA',aKarEnde[I,7],aKarEnde[I,7]*-1)\r\n       aKarEnde[I,8] := nSaldo      \r\n    Case aKarEnde[I,1] == \"SALDO\"\r\n       aKarEnde[I,8] := nSaldo\r\n       nSldKarEnde   += nSaldo\r\n       nSDB          += nSaldo\r\n       nSalSBF       := 0\r\n       nPos := Ascan(aDetSBF,{ |x| x[1]+x[2] == aKarEnde[I,5]+aKarEnde[I,6] })\r\n       If nPos <> 0 \r\n          nSalSBF += aDetSBF[nPos,3]\r\n       Endif   \r\n       IF nSaldo <> nSalSBF\r\n          aKarEnde[I,9] := \"Saldo SBF:  \"+Alltrim(Str(nSalSBF))+\"     Diferença: \"+Alltrim(Str(ABS(nSalSBF-nSaldo)))\r\n          cMensSBF      := \"SBF diferente do Kardex por Endereço\"\r\n          cMensagem     := \"Execute Saldo Atual\"\r\n       Endif\r\n  EndCase\r\nNext\r\n\r\nIF Len(aKarEnde) = 0\r\n                  //Origem   ,Data            ,TM       ,Documento,Localização,Lote     ,Quantidade,Saldo,Num.Seq.\r\n   AAdd(aKarEnde  ,{Space(03),CTOD(\"  /  /  \"),Space(03),Space(06),Space(15)  ,Space(10),0         ,0    ,Space(06),Space(01)})\r\n   oKarEnde:nAT := 1\r\nEndif\r\n\r\noKarEnde:Refresh()\r\n   \r\nReturn\r\n\r\n/*\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAnaliseDoc()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe Documento\")\r\naSize(aDocto,0)\r\n\r\n// SD1\r\ncQuery := \" SELECT D1_DOC AS DOC,D1_SERIE AS SERIE, D1_FORNECE AS CLIEFOR, D1_LOJA AS LOJA,D1_SERVIC AS SERVIC,D1_STSERV AS STSERV,SUM(D1_QUANT) AS QUANT FROM \"+RETSQLNAME(\"SD1\")+\", \"+RETSQLNAME(\"SF4\")\r\ncQuery += \" WHERE D1_FILIAL='\"+xFilial(\"SD1\")+\"' AND D1_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD1\")+\".D_E_L_E_T_ <> '*' AND D1_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND D1_ORIGLAN <> 'LF' AND D1_DTDIGIT >= '\"+DTOS(dDataI)+\"' AND D1_DTDIGIT <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" AND \"+IF(Empty(xFilial(\"SF4\")),\"D1_TES=F4_CODIGO\",\"D1_FILIAL=F4_FILIAL AND D1_TES=F4_CODIGO\")+\" AND F4_ESTOQUE = 'S' AND \"+RETSQLNAME(\"SF4\")+\".D_E_L_E_T_ <> '*'\"\r\ncQuery += \" GROUP BY D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_SERVIC,D1_STSERV\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n  Do Case\r\n     Case !Empty(QryTRB->SERVIC) .AND. QryTRB->STSERV = \"1\"; cStServ := \"A Executar\"\r\n     Case !Empty(QryTRB->SERVIC) .AND. QryTRB->STSERV = \"2\"; cStServ := \"Interrompido\"\r\n     Case !Empty(QryTRB->SERVIC) .AND. QryTRB->STSERV = \"3\"; cStServ := \"Ja Executado\"   \r\n     OtherWise;                                              cStServ := Space(1)     \r\n  EndCase   \r\n  AAdd(aDocto,{QryTRB->DOC,QryTRB->SERIE,QryTRB->CLIEFOR,QryTRB->LOJA,QryTRB->QUANT,0 ,0   ,0   ,0   ,0   ,0   ,0   ,\"SD1\",\"OK\",QryTRB->SERVIC,cStServ,Space(1)})\r\n //                                                                   D1           ,D2,D3_E,D3_S,D5_E,D5_S,DB_E,DB_S\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// SD2\r\ncQuery := \" SELECT D2_DOC AS DOC,D2_SERIE AS SERIE, D2_CLIENTE AS CLIEFOR, D2_LOJA AS LOJA,SUM(D2_QUANT) AS QUANT FROM \"+RETSQLNAME(\"SD2\")+\", \"+RETSQLNAME(\"SF4\")\r\ncQuery += \" WHERE D2_FILIAL='\"+xFilial(\"SD2\")+\"' AND D2_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD2\")+\".D_E_L_E_T_ <> '*' AND D2_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND D2_ORIGLAN <> 'LF' AND D2_EMISSAO >= '\"+DTOS(dDataI)+\"' AND D2_EMISSAO <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" AND \"+IF(Empty(xFilial(\"SF4\")),\"D2_TES=F4_CODIGO\",\"D2_FILIAL=F4_FILIAL AND D2_TES=F4_CODIGO\")+\" AND F4_ESTOQUE = 'S' AND \"+RETSQLNAME(\"SF4\")+\".D_E_L_E_T_ <> '*'\"\r\ncQuery += \" GROUP BY D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n  AAdd(aDocto,{QryTRB->DOC,QryTRB->SERIE,QryTRB->CLIEFOR,QryTRB->LOJA,0 ,QryTRB->QUANT,0   ,0   ,0   ,0   ,0   ,0   ,\"SD2\",\"OK\",Space(01),Space(01),Space(01)})\r\n  //                                                                  D1,D2           ,D3_E,D3_S,D5_E,D5_S,DB_E,DB_S\r\n\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// SD3\r\ncQuery := \" SELECT D3_DOC,D3_SERVIC,D3_STSERV,D3_TM,D3_QUANT FROM \"+RETSQLNAME(\"SD3\")\r\ncQuery += \" WHERE D3_FILIAL='\"+xFilial(\"SD3\")+\"' AND D3_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD3\")+\".D_E_L_E_T_ <> '*' AND D3_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND D3_ESTORNO = ' ' AND D3_EMISSAO >= '\"+DTOS(dDataI)+\"' AND D3_EMISSAO <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY D3_DOC\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n  Do Case\r\n     Case !Empty(D3_SERVIC) .AND. D3_STSERV = \"1\"; cStServ := \"A Executar\"\r\n     Case !Empty(D3_SERVIC) .AND. D3_STSERV = \"2\"; cStServ := \"Interrompido\"\r\n     Case !Empty(D3_SERVIC) .AND. D3_STSERV = \"3\"; cStServ := \"Ja Executado\"   \r\n     OtherWise;                                    cStServ := Space(1)     \r\n  EndCase   \r\n  nPos := Ascan(aDocto,{|x|x[1]== D3_DOC })\r\n  IF nPos == 0\r\n     IF D3_TM <= \"500\"\r\n        AAdd(aDocto,{D3_DOC,Space(03),Space(06),Space(02),0 ,0 ,D3_QUANT,0   ,0   ,0   ,0   ,0   ,\"SD3\",\"OK\",D3_SERVIC,cStServ,Space(01)})\r\n//                                                        D1,D2,D3_E    ,D3_S,D5_E,D5_S,DB_E,DB_S\r\n     Else\r\n        AAdd(aDocto,{D3_DOC,Space(03),Space(06),Space(02),0 ,0 ,0   ,D3_QUANT,0   ,0   ,0   ,0   ,\"SD3\",\"OK\",D3_SERVIC,cStServ,Space(01)})\r\n//                                                        D1,D2,D3_E,D3_S    ,D5_E,D5_S,DB_E,DB_S\r\n     Endif\r\n  Else\r\n     IF D3_TM <= \"500\"\r\n        aDocto[nPos,7] += D3_QUANT\r\n     Else\r\n        aDocto[nPos,8] += D3_QUANT\r\n     Endif    \r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// SD5\r\ncQuery := \" SELECT D5_DOC,D5_SERIE,D5_CLIFOR,D5_LOJA,D5_ORIGLAN,D5_QUANT FROM \"+RETSQLNAME(\"SD5\")\r\ncQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND D5_ESTORNO = ' ' AND D5_DATA >= '\"+DTOS(dDataI)+\"' AND D5_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY D5_DOC,D5_SERIE,D5_CLIFOR,D5_LOJA\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n//  nPos := Ascan(aDocto,{|x|x[1]+x[2]+x[3]+x[4] == D5_DOC+D5_SERIE+D5_CLIFOR+D5_LOJA })\r\n  nPos := Ascan(aDocto,{|x|x[1] == D5_DOC })\r\n  IF nPos == 0\r\n     IF D5_ORIGLAN <= \"500\" .OR. Substr(D5_ORIGLAN,1,2) $ 'DE/PR/MA'\r\n        AAdd(aDocto,{D5_DOC,D5_SERIE,D5_CLIFOR,D5_LOJA,0 ,0 ,0  ,0   ,D5_QUANT,0   ,0   ,0   ,\"SD5\",\"OK\",Space(01),Space(01),Space(01)})\r\n//                                                     D1,D2,D3_E,D3_S,D5_E    ,D5_S,DB_E,DB_S\r\n     Else\r\n        AAdd(aDocto,{D5_DOC,D5_SERIE,D5_CLIFOR,D5_LOJA,0 ,0 ,0  ,0   ,0   ,D5_QUANT,0   ,0   ,\"SD5\",\"OK\",Space(01),Space(01),Space(01)})\r\n//                                                     D1,D2,D3_E,D3_S,D5_E,D5_S    ,DB_E,DB_S\r\n     Endif\r\n  Else                                    \r\n     IF D5_ORIGLAN <= \"500\" .OR. Substr(D5_ORIGLAN,1,2) $ 'DE/PR/MA'\r\n        aDocto[nPos,09] += D5_QUANT\r\n     Else\r\n        aDocto[nPos,10] += D5_QUANT\r\n     Endif    \r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// SDB\r\ncQuery := \" SELECT DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,DB_TM,DB_QUANT FROM \"+RETSQLNAME(\"SDB\")\r\ncQuery += \" WHERE DB_FILIAL='\"+xFilial(\"SDB\")+\"' AND DB_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDB\")+\".D_E_L_E_T_ <> '*' AND DB_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DB_ESTORNO = ' ' AND DB_ATUEST='S' AND DB_DATA >= '\"+DTOS(dDataI)+\"' AND DB_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n//  nPos := Ascan(aDocto,{|x|x[1]+x[2]+x[3]+x[4] == DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA })\r\n  nPos := Ascan(aDocto,{|x|x[1] == DB_DOC })\r\n  IF nPos == 0\r\n     IF DB_TM <= \"500\" .OR. Substr(DB_TM,1,2) $ 'DE/PR/MA'\r\n        AAdd(aDocto,{DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,0 ,0 ,0   ,0   ,0   ,0   ,DB_QUANT,0   ,\"SDB\",\"OK\",Space(01),Space(01),Space(01)})\r\n//                                                     D1,D2,D3_E,D3_S,D5_E,D5_S,DB_E    ,DB_S\r\n     Else\r\n        AAdd(aDocto,{DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,0 ,0 ,0   ,0   ,0   ,0   ,0   ,DB_QUANT,\"SDB\",\"OK\",Space(01),Space(01),Space(01)})\r\n//                                                     D1,D2,D3_E,D3_S,D5_E,D5_S,DB_E,DB_S\r\n     Endif\r\n  Else                                    \r\n     IF DB_TM <= \"500\" .OR. Substr(DB_TM,1,2) $ 'DE/PR/MA'\r\n        aDocto[nPos,11] += DB_QUANT\r\n     Else\r\n        aDocto[nPos,12] += DB_QUANT\r\n     Endif    \r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// SDB - Servicos Pendentes\r\ncQuery := \" SELECT DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,DB_TM,DB_QUANT FROM \"+RETSQLNAME(\"SDB\")\r\ncQuery += \" WHERE DB_FILIAL='\"+xFilial(\"SDB\")+\"' AND DB_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDB\")+\".D_E_L_E_T_ <> '*' AND DB_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DB_ESTORNO = ' ' AND DB_ATUEST='N' AND DB_STATUS IN ('2','3','4') AND DB_DATA >= '\"+DTOS(dDataI)+\"' AND DB_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n  nPos := Ascan(aDocto,{|x|x[1]+x[2]+x[3]+x[4] == DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA })\r\n  IF nPos <> 0\r\n     aDocto[nPos,17] := \"Sim\"\r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nReturn\r\n*/\r\n\r\n/*\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fSoDocto()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal aArray := {}\r\nFor I:= 1 To Len(aDocto)\r\n   IF aDocto[I,14] = \"Analisar\"\r\n      AAdd(aArray,aDocto[I])\r\n  Endif \r\nNext\r\naSize(aDocto,0)\r\nFor I:= 1 To Len(aArray)\r\n   AAdd(aDocto,aArray[I])\r\nNext\r\noDocto:Refresh()\r\nReturn\r\n*/\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fSoNumseq()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal aArray := {}\r\nFor I:= 1 To Len(aNumseq)\r\n   IF aNumseq[I,11] = \"Analisar\"\r\n      AAdd(aArray,aNumseq[I])\r\n  Endif \r\nNext\r\naSize(aNumseq,0)\r\nFor I:= 1 To Len(aArray)\r\n   AAdd(aNumseq,aArray[I])\r\nNext\r\noNumseq:Refresh()\r\nReturn\r\n                  \r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fNumSeq()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIncProc(\"Processando Detalhe NumSeq\")\r\n\r\naSize(aNumSeq, 0)\r\n\r\n// SD1\r\ncQuery := \" SELECT D1_NUMSEQ AS NUMSEQ,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_DTDIGIT,D1_SERVIC AS SERVIC,D1_STSERV AS STSERV,SUM(D1_QUANT) AS QUANT FROM \"+RETSQLNAME(\"SD1\")+\", \"+RETSQLNAME(\"SF4\")\r\ncQuery += \" WHERE D1_FILIAL='\"+xFilial(\"SD1\")+\"' AND D1_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD1\")+\".D_E_L_E_T_ <> '*' AND D1_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND D1_ORIGLAN <> 'LF' AND D1_DTDIGIT >= '\"+DTOS(dDataI)+\"' AND D1_DTDIGIT <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" AND \"+IF(Empty(xFilial(\"SF4\")),\"D1_TES=F4_CODIGO\",\"D1_FILIAL=F4_FILIAL AND D1_TES=F4_CODIGO\")+\" AND F4_ESTOQUE = 'S' AND \"+RETSQLNAME(\"SF4\")+\".D_E_L_E_T_ <> '*'\"\r\ncQuery += \" GROUP BY D1_NUMSEQ,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_DTDIGIT,D1_SERVIC,D1_STSERV\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nTCSETFIELD( \"QryTRB\",\"D1_DTDIGIT\",\"D\")\r\nWhile !Eof()\r\n  Do Case\r\n     Case !Empty(QryTRB->SERVIC) .AND. QryTRB->STSERV = \"1\"; cStServ := \"A Executar\"\r\n     Case !Empty(QryTRB->SERVIC) .AND. QryTRB->STSERV = \"2\"; cStServ := \"Interrompido\"\r\n     Case !Empty(QryTRB->SERVIC) .AND. QryTRB->STSERV = \"3\"; cStServ := \"Ja Executado\"   \r\n     OtherWise;                                              cStServ := Space(1)     \r\n  EndCase   \r\n  AAdd(aNumSeq,{QryTRB->NUMSEQ,QryTRB->QUANT,0 ,0   ,0   ,0   ,0   ,0   ,0   ,\"SD1\",\"OK\",QryTRB->D1_DTDIGIT,QryTRB->D1_DOC,QryTRB->D1_SERIE,QryTRB->D1_FORNECE,QryTRB->D1_LOJA,QryTRB->SERVIC,cStServ,Space(01)})\r\n  //                           D1           ,D2,D3_E,D3_S,D5_E,D5_S,DB_E,DB_S\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()                                                                                                       \r\n\r\n// SD2\r\ncQuery := \" SELECT D2_NUMSEQ AS NUMSEQ,D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA,D2_EMISSAO,SUM(D2_QUANT) AS QUANT FROM \"+RETSQLNAME(\"SD2\")+\", \"+RETSQLNAME(\"SF4\")\r\ncQuery += \" WHERE D2_FILIAL='\"+xFilial(\"SD2\")+\"' AND D2_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD2\")+\".D_E_L_E_T_ <> '*' AND D2_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND D2_ORIGLAN <> 'LF' AND D2_EMISSAO >= '\"+DTOS(dDataI)+\"' AND D2_EMISSAO <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" AND \"+IF(Empty(xFilial(\"SF4\")),\"D2_TES=F4_CODIGO\",\"D2_FILIAL=F4_FILIAL AND D2_TES=F4_CODIGO\")+\" AND F4_ESTOQUE = 'S' AND \"+RETSQLNAME(\"SF4\")+\".D_E_L_E_T_ <> '*'\"\r\ncQuery += \" GROUP BY D2_NUMSEQ,D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA,D2_EMISSAO\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nTCSETFIELD( \"QryTRB\",\"D2_EMISSAO\",\"D\")\r\nWhile !Eof()\r\n  AAdd(aNumSeq,{QryTRB->NUMSEQ,0 ,QryTRB->QUANT,0   ,0   ,0   ,0   ,0   ,0   ,\"SD2\",\"OK\",QryTRB->D2_EMISSAO,QryTRB->D2_DOC,QryTRB->D2_SERIE,QryTRB->D2_CLIENTE,QryTRB->D2_LOJA,Space(01),Space(01),Space(01)})\r\n  //                           D1,D2           ,D3_E,D3_S,D5_E,D5_S,DB_E,DB_S\r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// SD3\r\ncQuery := \" SELECT D3_NUMSEQ,D3_DOC,D3_EMISSAO,D3_SERVIC,D3_STSERV,D3_TM,D3_QUANT FROM \"+RETSQLNAME(\"SD3\")\r\ncQuery += \" WHERE D3_FILIAL='\"+xFilial(\"SD3\")+\"' AND D3_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD3\")+\".D_E_L_E_T_ <> '*' AND D3_COD = '\"+cProduto+\"'\"\r\ncQuery += \" AND D3_ESTORNO = ' ' AND D3_EMISSAO >= '\"+DTOS(dDataI)+\"' AND D3_EMISSAO <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY D3_NUMSEQ,D3_DOC\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nTCSETFIELD( \"QryTRB\",\"D3_EMISSAO\",\"D\")\r\nWhile !Eof()\r\n  Do Case\r\n     Case !Empty(D3_SERVIC) .AND. D3_STSERV = \"1\"; cStServ := \"A Executar\"\r\n     Case !Empty(D3_SERVIC) .AND. D3_STSERV = \"2\"; cStServ := \"Interrompido\"\r\n     Case !Empty(D3_SERVIC) .AND. D3_STSERV = \"3\"; cStServ := \"Ja Executado\"   \r\n     OtherWise;                                    cStServ := Space(1)     \r\n  EndCase   \r\n  nPos := Ascan(aNumSeq,{|x|x[1]== D3_NUMSEQ })\r\n  IF nPos == 0\r\n     IF D3_TM <= \"500\"\r\n        AAdd(aNumSeq,{D3_NUMSEQ,0 ,0 ,D3_QUANT,0   ,0   ,0   ,0   ,0   ,\"SD3\",\"OK\",QryTRB->D3_EMISSAO,D3_DOC,Space(01),Space(01),Space(01),D3_SERVIC,cStServ,Space(01)})\r\n//                              D1,D2,D3_E    ,D3_S,D5_E,D5_S,DB_E,DB_S\r\n     Else\r\n        AAdd(aNumSeq,{D3_NUMSEQ,0 ,0 ,0   ,D3_QUANT,0   ,0   ,0   ,0   ,\"SD3\",\"OK\",QryTRB->D3_EMISSAO,D3_DOC,Space(01),Space(01),Space(01),D3_SERVIC,cStServ,Space(01)})\r\n//                             D1,D2,D3_E,D3_S    ,D5_E,D5_S,DB_E,DB_S\r\n     Endif\r\n  Else\r\n     IF D3_TM <= \"500\"\r\n        aNumSeq[nPos,4] += D3_QUANT\r\n     Else\r\n        aNumSeq[nPos,5] += D3_QUANT\r\n     Endif    \r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n// SD5\r\ncQuery := \" SELECT D5_NUMSEQ,D5_DATA,D5_ORIGLAN,D5_DOC,D5_SERIE,D5_CLIFOR,D5_LOJA,D5_QUANT FROM \"+RETSQLNAME(\"SD5\")\r\ncQuery += \" WHERE D5_FILIAL='\"+xFilial(\"SD5\")+\"' AND D5_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SD5\")+\".D_E_L_E_T_ <> '*' AND D5_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND D5_ESTORNO = ' ' AND D5_DATA >= '\"+DTOS(dDataI)+\"' AND D5_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY D5_NUMSEQ\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nTCSETFIELD( \"QryTRB\",\"D5_DATA\",\"D\")\r\nWhile !Eof()\r\n  nPos := Ascan(aNumSeq,{|x|x[1]== D5_NUMSEQ })\r\n  IF nPos == 0\r\n     IF D5_ORIGLAN <= \"500\" .OR. Substr(D5_ORIGLAN,1,2) $ 'DE/PR/MA'\r\n        AAdd(aNumSeq,{D5_NUMSEQ,0 ,0 ,0  ,0   ,D5_QUANT,0   ,0   ,0   ,\"SD5\",\"OK\",D5_DATA,D5_DOC,D5_SERIE,D5_CLIFOR,D5_LOJA,Space(01),Space(01),Space(01)})\r\n//                             D1,D2,D3_E,D3_S,D5_E    ,D5_S,DB_E,DB_S\r\n     Else\r\n        AAdd(aNumSeq,{D5_NUMSEQ,0 ,0 ,0  ,0   ,0   ,D5_QUANT,0   ,0   ,\"SD5\",\"OK\",D5_DATA,D5_DOC,D5_SERIE,D5_CLIFOR,D5_LOJA,Space(01),Space(01),Space(01)})\r\n//                             D1,D2,D3_E,D3_S,D5_E,D5_S    ,DB_E,DB_S\r\n     Endif\r\n  Else                                    \r\n     IF D5_ORIGLAN <= \"500\" .OR. Substr(D5_ORIGLAN,1,2) $ 'DE/PR/MA'\r\n        aNumSeq[nPos,6] += D5_QUANT\r\n     Else\r\n        aNumSeq[nPos,7] += D5_QUANT\r\n     Endif    \r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// SDB\r\ncQuery := \" SELECT DB_NUMSEQ,DB_DATA,DB_TM,DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,DB_QUANT FROM \"+RETSQLNAME(\"SDB\")\r\ncQuery += \" WHERE DB_FILIAL='\"+xFilial(\"SDB\")+\"' AND DB_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDB\")+\".D_E_L_E_T_ <> '*' AND DB_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DB_ESTORNO = ' ' AND DB_ATUEST='S' AND DB_DATA >= '\"+DTOS(dDataI)+\"' AND DB_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY DB_NUMSEQ\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nTCSETFIELD( \"QryTRB\",\"DB_DATA\",\"D\")\r\nWhile !Eof()\r\n  nPos := Ascan(aNumSeq,{|x|x[1]== DB_NUMSEQ })\r\n  IF nPos == 0\r\n     IF DB_TM <= \"500\" .OR. Substr(DB_TM,1,2) $ 'DE/PR/MA'\r\n        AAdd(aNumSeq,{DB_NUMSEQ,0 ,0 ,0   ,0   ,0   ,0   ,DB_QUANT,0   ,\"SDB\",\"OK\",DB_DATA,DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,Space(01),Space(01),Space(01)})\r\n//                              D1,D2,D3_E,D3_S,D5_E,D5_S,DB_E    ,DB_S\r\n     Else\r\n        AAdd(aNumSeq,{DB_NUMSEQ,0 ,0 ,0   ,0   ,0   ,0   ,0   ,DB_QUANT,\"SDB\",\"OK\",DB_DATA,DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA,Space(01),Space(01),Space(01)})\r\n//                              D1,D2,D3_E,D3_S,D5_E,D5_S,DB_E,DB_S\r\n     Endif\r\n  Else                                    \r\n     IF DB_TM <= \"500\" .OR. Substr(DB_TM,1,2) $ 'DE/PR/MA'\r\n        aNumSeq[nPos,8] += DB_QUANT\r\n     Else\r\n        aNumSeq[nPos,9] += DB_QUANT\r\n     Endif    \r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\n// SDB - Servicos Pendentes\r\ncQuery := \" SELECT DB_NUMSEQ,DB_TM,DB_DOC,DB_QUANT FROM \"+RETSQLNAME(\"SDB\")\r\ncQuery += \" WHERE DB_FILIAL='\"+xFilial(\"SDB\")+\"' AND DB_LOCAL='\"+cLocal+\"' AND \"+RETSQLNAME(\"SDB\")+\".D_E_L_E_T_ <> '*' AND DB_PRODUTO = '\"+cProduto+\"'\"\r\ncQuery += \" AND DB_ESTORNO = ' ' AND DB_ATUEST='N' AND DB_STATUS IN ('2','3','4') AND DB_DATA >= '\"+DTOS(dDataI)+\"' AND DB_DATA <= '\"+DTOS(dDataF)+\"'\"\r\ncQuery += \" ORDER BY DB_DOC,DB_SERIE,DB_CLIFOR,DB_LOJA\"\r\ncQuery := ChangeQuery(cQuery)\r\nDBUseArea(.T.,\"TOPCONN\",TCGENQRY(,,cQuery),\"QryTRB\",.F.,.T.)\r\nWhile !Eof()\r\n  nPos := Ascan(aNumSeq,{|x|x[1]== DB_NUMSEQ })\r\n  IF nPos <> 0\r\n     aNumSeq[nPos,19] := \"Sim\"\r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\nDBCloseArea()\r\n\r\nIF Len(aNumSeq) == 0 \r\n                  //Num.Seq. ,SD1,SD2,SD3_E,SD3_S,SD5_E,SD5_S,SDB_E,SDB_S,Origem   ,Status   ,Data            ,Documento,Serie    ,Clie.Forn,Loja     ,Serviço  ,Status Serviço,Serviço Pendente\r\n   Aadd(aNumSeq   ,{Space(06),0  ,0  ,0    ,0    ,0    ,0    ,0    ,0    ,Space(03),Space(08),CTOD(\"  /  /  \"),Space(06),Space(03),Space(06),Space(02),Space(03),Space(01)     ,Space(01)})\r\n   oNumSeq:nAT := 1\r\nEndif\r\n\r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustSB2(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSB2\r\nLocal aArea    := GetArea()\r\nLocal nQuant   := IF(cOpcao=\"SALDO_SB2\",nSB2,nDASB2)\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSB2 TITLE \"Ajuste no SB2\"  OF oDlgSB2 PIXEL FROM 010,010 TO 200,265 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 024,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSB2 FONT oBold \r\n@ 020,043 MSGET oVar  VAR  nQuant  Picture cPict        SIZE 050,10 PIXEL OF oDlgSB2 \r\n                                                     //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\n@ 075,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,        ,    ,     ,nQuant),oDlgSB2:End())\r\n@ 075,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSB2:End()\r\n\r\nACTIVATE MSDIALOG oDlgSB2  CENTERED\r\n\r\nRestArea(aArea)          \r\n\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustSB9(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSB9\r\nLocal aArea    := GetArea()\r\nLocal nQuant   := nSB9\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSB9 TITLE \"Ajuste no SB9\"  OF oDlgSB9 PIXEL FROM 010,010 TO 200,265 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 024,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSB9 FONT oBold \r\n@ 020,043 MSGET oVar  VAR  nQuant  Picture cPict        SIZE 050,10 PIXEL OF oDlgSB9 \r\n                                                     //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\n@ 075,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,        ,    ,     ,nQuant),oDlgSB9:End())\r\n@ 075,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSB9:End()\r\n\r\nACTIVATE MSDIALOG oDlgSB9  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustSB8(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSB8\r\nLocal aArea    := GetArea()\r\nLocal dData    := IF(Len(aDetSB8)>0,aDetSB8[oDetSB8:nAT][01],dDataBase)\r\nLocal cLoteCtl := IF(Len(aDetSB8)>0,aDetSB8[oDetSB8:nAT][02],SPACE(10))\r\nLocal cNumLote := IF(Len(aDetSB8)>0,aDetSB8[oDetSB8:nAT][03],SPACE(06))\r\nLocal nQuant   := IF(Len(aDetSB8)>0,aDetSB8[oDetSB8:nAT][05],0)\r\nLocal cDoc     :=  \"AJ\"+Substr(DTOC(dDataBase),4,2)+Substr(DTOC(dDataBase),7,2)\r\nLocal lVisLote := lVisDoc := lVisData := lVisNumLote := lVisQuant := .T.\r\n\r\nIF cOpcao = \"B8_A\" //Alterar\r\n   lVisLote  := lVisDoc := lVisData := lVisNumLote := .F.\r\nElseIF cOpcao = \"B8_E\" //Excluir\r\n   lVisLote := lVisDoc := lVisData := lVisNumLote := lVisQuant := .F.\r\nEndif\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSB8 TITLE \"Ajuste no SB8\"  OF oDlgSB8 PIXEL FROM 010,010 TO 215,295 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 009,005 SAY \"Num.Lote\"                                SIZE 040,10 PIXEL OF oDlgSB8 FONT oBold \r\n@ 005,043 MSGET oVar   VAR cNumLote Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSB8 When lVisNumLote\r\n@ 024,005 SAY \"Lote\"                                    SIZE 040,10 PIXEL OF oDlgSB8 FONT oBold \r\n@ 020,043 MSGET oVar   VAR cLoteCtl Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSB8 When lVisLote\r\n@ 039,005 SAY \"Documento\"                               SIZE 040,10 PIXEL OF oDlgSB8 FONT oBold \r\n@ 035,043 MSGET oVar   VAR cDoc     Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSB8 When lVisDoc\r\n@ 054,005 SAY \"Data\"                                    SIZE 040,10 PIXEL OF oDlgSB8 FONT oBold  \r\n@ 050,043 MSGET oVar   VAR dData    Picture \"99/99/99\"  SIZE 040,10 PIXEL OF oDlgSB8 When lVisData \r\n@ 069,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSB8 FONT oBold \r\n@ 065,043 MSGET oVar   VAR nQuant   Picture cPict       SIZE 050,10 PIXEL OF oDlgSB8 When lVisQuant\r\n                                                     //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\n@ 085,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,Nil      ,Nil    ,Nil     ,cNumLote),oDlgSB8:End())\r\n@ 085,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSB8:End()\r\n\r\nACTIVATE MSDIALOG oDlgSB8  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustSD5(cOpcao,cFolder)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSD5\r\nLocal aArea    := GetArea()\r\nLocal lVisLote := lVisDoc := lVisSerie := lVisCliFor := lVisLoja := lVisData := lVisQuant := lVisNumSeq := lVisNumLote := .T.\r\nLocal dData    \r\nLocal cDoc     \r\nLocal cSerie\r\nLocal cCliFor\r\nLocal cLoja\r\nLocal cLoteCtl \r\nLocal cNumSeq  \r\nLocal cNumLote\r\nLocal nQuant  \r\nLocal dDtValid       \r\n\r\nIF cFolder = \"02\"\r\n   dData    := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][01],dDataBase)\r\n   cDoc     := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][10],Space(06))\r\n   cSerie   := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][11],Space(03))\r\n   cCliFor  := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][12],Space(06))\r\n   cLoja    := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][13],Space(03))\r\n   cLoteCtl := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][03],SPACE(10))\r\n   cNumSeq  := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][08],SPACE(06))\r\n   cNumLote := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][04],SPACE(06))\r\n   nQuant   := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][06],0)\r\n   dDtValid := IF(Len(aDetSD5)>0,aDetSD5[oDetSD5:nAT][05],CTOD(\"  /  /  \"))\r\nElseIF cFolder = \"13\"                  \r\n   cNumSeq  := aNumSeq[oNumSeq:nAT][01]\r\n   dData    := dDataBase\r\n   cDoc     := Space(06)\r\n   cSerie   := Space(03)\r\n   cCliFor  := Space(06)\r\n   cLoja    := Space(03)\r\n   cLoteCtl := SPACE(10)\r\n   cNumLote := SPACE(06)\r\n   nQuant   := 0\r\n   dDtValid := CTOD(\"  /  /  \")\r\n   DBSelectArea(\"SD5\")\r\n   DBSetOrder(3) //-- D5_FILIAL+D5_NUMSEQ+D5_PRODUTO+D5_LOCAL+D5_LOTECTL+D5_NUMLOTE\r\n   IF DBSeek(xFilial(\"SD5\")+cNumSeq)\r\n      cNumLote := D5_NUMLOTE\r\n      dDtValid := D5_DTVALID\r\n   Else\r\n      cNumLote := Space(6)  \r\n      dDtValid := CTOD(\"  /  /  \")\r\n   Endif\r\n   Do Case\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][02])\r\n       DBSelectArea(\"SD1\")\r\n       DBSetOrder(4) //--D1_FILIAL+D1_NUMSEQ\r\n       IF DBSeek(xFilial(\"SD1\")+cNumSeq)\r\n          dData    := D1_DTDIGIT\r\n          cDoc     := D1_DOC\r\n          cSerie   := D1_SERIE\r\n          cCliFor  := D1_FORNECE\r\n          cLoja    := D1_LOJA\r\n          cLoteCtl := D1_LOTECTL\r\n          nQuant   := D1_QUANT\r\n       Endif\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][03])\r\n       DBSelectArea(\"SD2\")\r\n       DBSetOrder(4) //--D2_FILIAL+D2_NUMSEQ\r\n       IF DBSeek(xFilial(\"SD2\")+cNumSeq)\r\n          dData    := D2_EMISSAO\r\n          cDoc     := D2_DOC\r\n          cSerie   := D2_SERIE\r\n          cCliFor  := D2_CLIENTE\r\n          cLoja    := D2_LOJA\r\n          cLoteCtl := D2_LOTECTL\r\n          nQuant   := D2_QUANT\r\n       Endif\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][04]) .Or. !Empty(aNumSeq[oNumSeq:nAT][05])\r\n       DBSelectArea(\"SD3\")\r\n       DBSetOrder(7) //--D3_FILIAL+D3_COD+D3_LOCAL+DTOS(D3_EMISSAO)+D3_NUMSEQ \r\n       IF DBSeek(xFilial(\"SD3\")+cProduto+cLocal+DTOS(aNumSeq[oNumSeq:nAT][12])+cNumSeq)\r\n          dData    := D3_EMISSAO\r\n          cDoc     := D3_DOC\r\n          cSerie   := Space(03)\r\n          cCliFor  := Space(06)\r\n          cLoja    := Space(02)\r\n          cLoteCtl := D3_LOTECTL\r\n          nQuant   := D3_QUANT\r\n       Endif\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][06]) .Or. !Empty(aNumSeq[oNumSeq:nAT][07])\r\n       DBSelectArea(\"SD5\")\r\n       DBSetOrder(3) //-- D5_FILIAL+D5_NUMSEQ+D5_PRODUTO+D5_LOCAL+D5_LOTECTL+D5_NUMLOTE\r\n       IF DBSeek(xFilial(\"SD5\")+cNumSeq)\r\n          dData    := D5_DATA\r\n          cDoc     := D5_DOC\r\n          cSerie   := D5_SERIE\r\n          cCliFor  := D5_CLIFOR\r\n          cLoja    := D5_LOJA\r\n          cLoteCtl := D5_LOTECTL\r\n          nQuant   := D5_QUANT\r\n       Endif\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][08]) .Or. !Empty(aNumSeq[oNumSeq:nAT][09])\r\n       DBSelectArea(\"SDB\")\r\n       DBSetOrder(1) //--DB_FILIAL+DB_PRODUTO+DB_LOCAL+DB_NUMSEQ+DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA+DB_ITEM\r\n       IF DBSeek(xFilial(\"SDB\")+cProduto+cLocal+cNumSeq)\r\n          dData    := DB_DATA\r\n          cDoc     := DB_DOC\r\n          cSerie   := DB_SERIE\r\n          cCliFor  := DB_CLIFOR\r\n          cLoja    := DB_LOJA\r\n          cLoteCtl := DB_LOTECTL\r\n          nQuant   := DB_QUANT\r\n       Endif\r\n   EndCase\r\nEndif\r\n\r\nIF cOpcao $ \"D5_A\" //Alterar\r\n   lVisLote := lVisDoc := lVisSerie := lVisCliFor := lVisLoja := lVisData := lVisNumSeq := lVisNumLote := .F.\r\nElseIF cOpcao $ \"D5_E/D5+B8_E\" //Excluir\r\n   lVisLote := lVisDoc := lVisSerie := lVisCliFor := lVisLoja := lVisData := lVisNumSeq := lVisNumLote := lVisQuant := .F.\r\nEndif\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSD5 TITLE \"Ajuste no SD5\"  OF oDlgSD5 PIXEL FROM 010,010 TO 340,295 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 009,005 SAY \"Data\"                                    SIZE 040,10 PIXEL OF oDlgSD5 FONT oBold  \r\n@ 005,043 MSGET oVar   VAR dData    Picture \"99/99/99\"  SIZE 040,10 PIXEL OF oDlgSD5 When lVisData\r\n@ 024,005 SAY \"Documento\"                               SIZE 040,10 PIXEL OF oDlgSD5 FONT oBold \r\n@ 020,043 MSGET oVar   VAR cDoc     Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSD5 When lVisDoc\r\n@ 039,005 SAY \"Serie\"                                   SIZE 040,10 PIXEL OF oDlgSD5 FONT oBold \r\n@ 035,043 MSGET oVar   VAR cSerie   Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSD5 When lVisSerie\r\n@ 054,005 SAY \"Clie.Forn\"                               SIZE 040,10 PIXEL OF oDlgSD5 FONT oBold \r\n@ 050,043 MSGET oVar   VAR cCliFor  Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSD5 When lVisCliFor\r\n@ 069,005 SAY \"Loja\"                                    SIZE 040,10 PIXEL OF oDlgSD5 FONT oBold \r\n@ 065,043 MSGET oVar   VAR cLoja    Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSD5 When lVisLoja\r\n@ 084,005 SAY \"Lote\"                                    SIZE 040,10 PIXEL OF oDlgSD5 FONT oBold \r\n@ 080,043 MSGET oVar   VAR cLoteCtl Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSD5 When lVisLote\r\n@ 099,005 SAY \"Num.Seq.\"                                SIZE 040,10 PIXEL OF oDlgSD5 FONT oBold \r\n@ 095,043 MSGET oVar   VAR cNumSeq  Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSD5 When lVisNumSeq\r\n@ 114,005 SAY \"Num.Lote\"                                SIZE 040,10 PIXEL OF oDlgSD5 FONT oBold \r\n@ 110,043 MSGET oVar   VAR cNumLote Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSD5 When lVisNumLote\r\n@ 129,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSD5 FONT oBold \r\n@ 125,043 MSGET oVar   VAR nQuant   Picture cPictD5     SIZE 050,10 PIXEL OF oDlgSD5 When lVisQuant Valid(nQuant >= 0)\r\n                                                     //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\nIF cOpcao $ \"D5_I\" //Incluir                                                                                                   \r\n  @ 145,005 BUTTON \"&Entrada\" SIZE 25,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,Nil      ,cNumSeq,\"499\"   ,cNumLote,cSerie,cCliFor,cLoja,dDtValid,cFolder),oDlgSD5:End())\r\n  @ 145,040 BUTTON \"&Saida\"   SIZE 25,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,Nil      ,cNumSeq,\"999\"   ,cNumLote,cSerie,cCliFor,cLoja,dDtValid,cFolder),oDlgSD5:End())\r\n  @ 145,075 BUTTON \"&Transf.\" SIZE 25,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,Nil      ,cNumSeq,\"499/999\",cNumLote,cSerie,cCliFor,cLoja,dDtValid,cFolder),oDlgSD5:End())  \r\n  @ 145,110 BUTTON \"&Sair\"    SIZE 25,14 PIXEL ACTION oDlgSD5:End()  \r\nElse\r\n   @ 145,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,Nil   ,cNumSeq,Nil     ,cNumLote,cSerie,cCliFor,cLoja,dDtValid,cFolder),oDlgSD5:End())\r\n   @ 145,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSD5:End()\r\nEndif\r\n\r\n\r\nACTIVATE MSDIALOG oDlgSD5  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustSBF(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSBF\r\nLocal aArea     := GetArea()\r\nLocal cEndereco := IF(Len(aDetSBF)>0,aDetSBF[oDetSBF:nAT][01],SPACE(15))\r\nLocal cLoteCtl  := IF(Len(aDetSBF)>0,aDetSBF[oDetSBF:nAT][02],SPACE(10))\r\nLocal nQuant    := IF(Len(aDetSBF)>0,aDetSBF[oDetSBF:nAT][03],0)\r\nLocal cDoc      :=  \"AJ\"+Substr(DTOC(dDataBase),4,2)+Substr(DTOC(dDataBase),7,2)\r\nLocal lVisLote  := lVisDoc := lVisEndereco := lVisQuant := .T.\r\n\r\nIF cOpcao = \"BF_A\" //Alterar\r\n   lVisLote  := lVisDoc := lVisEndereco  := .F.\r\nElseIF cOpcao = \"BF_E\" //Excluir\r\n   lVisLote := lVisDoc := lVisEndereco := lVisQuant := .F.\r\nEndif\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSBF TITLE \"Ajuste no SBF\"  OF oDlgSBF PIXEL FROM 010,010 TO 200,265 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 009,005 SAY \"Endereço\"                                SIZE 040,10 PIXEL OF oDlgSBF FONT oBold  \r\n@ 005,043 MSGET oVar   VAR cEndereco Picture \"@!\"       SIZE 040,10 PIXEL OF oDlgSBF When lVisEndereco\r\n@ 024,005 SAY \"Lote\"                                    SIZE 040,10 PIXEL OF oDlgSBF FONT oBold \r\n@ 020,043 MSGET oVar   VAR cLoteCtl Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSBF When lVisLote\r\n@ 039,005 SAY \"Documento\"                               SIZE 040,10 PIXEL OF oDlgSBF FONT oBold \r\n@ 035,043 MSGET oVar   VAR cDoc     Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSBF When lVisDoc\r\n@ 054,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSBF FONT oBold \r\n@ 050,043 MSGET oVar   VAR nQuant   Picture cPict       SIZE 050,10 PIXEL OF oDlgSBF When lVisQuant \r\n                                                     //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\n@ 075,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,Nil  ,nQuant,cEndereco),oDlgSBF:End())\r\n@ 075,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSBF:End()\r\n\r\nACTIVATE MSDIALOG oDlgSBF  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustSDB(cOpcao,cFolder)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSDB\r\nLocal aArea     := GetArea()\r\nLocal lVisLote := lVisDoc := lVisSerie := lVisCliFor := lVisLoja := lVisLocaliz :=lVisData := lVisQuant := lVisNumSeq := .T.\r\nLocal dData    := CTOD(\"  /  /  \")\r\nLocal cDoc     := Space(06)\r\nLocal cSerie   := Space(03)\r\nLocal cCliFor  := Space(06)\r\nLocal cLoja    := Space(02)\r\nLocal cLoteCtl := Space(10)\r\nLocal cNumSeq  := Space(06)\r\nLocal cLocaliz := Space(15)\r\nLocal nQuant   := 0\r\nLocal cNumLote \r\n\r\nIF cFolder = \"03\" .AND. Len(aDetSDB) > 0 .AND. aDetSDB[oDetSDB:nAT][01] = \"SBK\"\r\n   MsgStop(\"A Origem SBK não permite essa opção !\")\r\n   Return\r\nEndif\r\n\r\nIF cFolder = \"03\"\r\n   dData    := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][02],dDataBase)\r\n   cDoc     := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][10],\"AJ\"+Substr(DTOC(dDataBase),4,2)+Substr(DTOC(dDataBase),7,2))\r\n   cSerie   := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][11],SPACE(03))\r\n   cCliFor  := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][12],SPACE(06))\r\n   cLoja    := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][13],SPACE(02))\r\n   cLoteCtl := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][05],SPACE(10))\r\n   cNumSeq  := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][08],SPACE(06))\r\n   cLocaliz := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][04],SPACE(15))\r\n   nQuant   := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][06],0)\r\n   dDtValid := IF(Len(aDetSDB)>0,aDetSDB[oDetSDB:nAT][04],CTOD(\"  /  /  \"))\r\nElseIF cFolder = \"13\"                  \r\n   cNumSeq  := aNumSeq[oNumSeq:nAT][01]\r\n   dData    := dDataBase\r\n   cDoc     := \"AJ\"+Substr(DTOC(dDataBase),4,2)+Substr(DTOC(dDataBase),7,2)\r\n   cSerie   := SPACE(03)\r\n   cCliFor  := SPACE(06)\r\n   cLoja    := SPACE(02)\r\n   cLoteCtl := SPACE(10)\r\n   cLocaliz := SPACE(15)\r\n   nQuant   := 0\r\n   dDtValid := CTOD(\"  /  /  \")\r\n   DBSelectArea(\"SDB\")\r\n   DBSetOrder(1) //--DB_FILIAL+DB_PRODUTO+DB_LOCAL+DB_NUMSEQ+DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA+DB_ITEM\r\n   IF DBSeek(xFilial(\"SDB\")+cProduto+cLocal+cNumSeq)\r\n      cLocaliz := DB_LOCALIZ\r\n   Endif\r\n   Do Case\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][02])\r\n       DBSelectArea(\"SD1\")\r\n       DBSetOrder(4) //--D1_FILIAL+D1_NUMSEQ\r\n       IF DBSeek(xFilial(\"SD1\")+cNumSeq)\r\n          dData    := D1_DTDIGIT\r\n          cDoc     := D1_DOC\r\n          cSerie   := D1_SERIE\r\n          cCliFor  := D1_FORNECE\r\n          cLoja    := D1_LOJA\r\n          cLoteCtl := D1_LOTECTL\r\n          nQuant   := D1_QUANT\r\n       Endif\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][03])\r\n       DBSelectArea(\"SD2\")\r\n       DBSetOrder(4) //--D2_FILIAL+D2_NUMSEQ\r\n       IF DBSeek(xFilial(\"SD2\")+cNumSeq)\r\n          dData    := D2_EMISSAO\r\n          cDoc     := D2_DOC\r\n          cSerie   := D2_SERIE\r\n          cCliFor  := D2_CLIENTE\r\n          cLoja    := D2_LOJA\r\n          cLoteCtl := D2_LOTECTL\r\n          nQuant   := D2_QUANT\r\n       Endif\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][04]) .Or. !Empty(aNumSeq[oNumSeq:nAT][05])\r\n       DBSelectArea(\"SD3\")\r\n       DBSetOrder(4) //--D3_FILIAL+D3_NUMSEQ+D3_CHAVE+D3_COD\r\n       IF DBSeek(xFilial(\"SD3\")+cNumSeq)\r\n          dData    := D3_EMISSAO\r\n          cDoc     := D3_DOC\r\n          cSerie   := Space(03)\r\n          cCliFor  := Space(06)\r\n          cLoja    := Space(02)\r\n          cLoteCtl := D3_LOTECTL\r\n          nQuant   := D3_QUANT\r\n          cLocaliz := IIF(Empty(cLocaliz),D3_LOCALIZ,cLocaliz)\r\n       Endif\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][06]) .Or. !Empty(aNumSeq[oNumSeq:nAT][07])\r\n       DBSelectArea(\"SD5\")\r\n       DBSetOrder(3) //-- D5_FILIAL+D5_NUMSEQ+D5_PRODUTO+D5_LOCAL+D5_LOTECTL+D5_NUMLOTE\r\n       IF DBSeek(xFilial(\"SD5\")+cNumSeq)\r\n          dData    := D5_DATA\r\n          cDoc     := D5_DOC\r\n          cSerie   := D5_SERIE\r\n          cCliFor  := D5_CLIFOR\r\n          cLoja    := D5_LOJA\r\n          cLoteCtl := D5_LOTECTL\r\n          nQuant   := D5_QUANT\r\n       Endif\r\n     Case !Empty(aNumSeq[oNumSeq:nAT][08]) .Or. !Empty(aNumSeq[oNumSeq:nAT][09])\r\n       DBSelectArea(\"SDB\")\r\n       DBSetOrder(1) //--DB_FILIAL+DB_PRODUTO+DB_LOCAL+DB_NUMSEQ+DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA+DB_ITEM\r\n       IF DBSeek(xFilial(\"SDB\")+cProduto+cLocal+cNumSeq)\r\n          dData    := DB_DATA\r\n          cDoc     := DB_DOC\r\n          cSerie   := DB_SERIE\r\n          cCliFor  := DB_CLIFOR\r\n          cLoja    := DB_LOJA\r\n          cLoteCtl := DB_LOTECTL\r\n          cLocaliz := DB_LOCALIZ\r\n          nQuant   := DB_QUANT                    \r\n       Endif\r\n   EndCase\r\nEndif\r\n\r\nIF cOpcao = \"DB_A\"  //Alterar\r\n   lVisLote := lVisDoc := lVisSerie := lVisCliFor := lVisLoja := lVisLocaliz := lVisData :=  lVisNumSeq := .F.\r\nElseIF cOpcao $ \"DB_E/DB+BF_E\" //Excluir\r\n   lVisLote := lVisDoc := lVisSerie := lVisCliFor := lVisLoja := lVisLocaliz := lVisData :=  lVisNumSeq := lVisQuant := .F.\r\nEndif\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSDB TITLE \"Ajuste no SDB\"  OF oDlgSDB PIXEL FROM 010,010 TO 340,295 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 009,005 SAY \"Data\"                                    SIZE 040,10 PIXEL OF oDlgSDB FONT oBold  \r\n@ 005,043 MSGET oVar   VAR dData    Picture \"99/99/99\"  SIZE 040,10 PIXEL OF oDlgSDB When lVisData\r\n@ 024,005 SAY \"Documento\"                               SIZE 040,10 PIXEL OF oDlgSDB FONT oBold \r\n@ 020,043 MSGET oVar   VAR cDoc     Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSDB When lVisDoc\r\n@ 039,005 SAY \"Serie\"                                   SIZE 040,10 PIXEL OF oDlgSDB FONT oBold \r\n@ 035,043 MSGET oVar   VAR cSerie   Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSDB When lVisSerie\r\n@ 054,005 SAY \"Clie.Forn\"                               SIZE 040,10 PIXEL OF oDlgSDB FONT oBold \r\n@ 050,043 MSGET oVar   VAR cCliFor  Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSDB When lVisCliFor\r\n@ 069,005 SAY \"Loja\"                                    SIZE 040,10 PIXEL OF oDlgSDB FONT oBold \r\n@ 065,043 MSGET oVar   VAR cLoja    Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSDB When lVisLoja\r\n@ 084,005 SAY \"Lote\"                                    SIZE 040,10 PIXEL OF oDlgSDB FONT oBold \r\n@ 080,043 MSGET oVar   VAR cLoteCtl Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSDB When lVisLote\r\n@ 099,005 SAY \"Num.Seq.\"                                SIZE 040,10 PIXEL OF oDlgSDB FONT oBold \r\n@ 095,043 MSGET oVar   VAR cNumSeq  Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSDB When lVisNumSeq\r\n@ 114,005 SAY \"Localização\"                             SIZE 040,10 PIXEL OF oDlgSDB FONT oBold \r\n@ 110,043 MSGET oVar   VAR cLocaliz Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSDB When lVisLocaliz\r\n@ 129,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSDB FONT oBold \r\n@ 125,043 MSGET oVar   VAR nQuant   Picture cPictDB     SIZE 050,10 PIXEL OF oDlgSDB When lVisQuant Valid(nQuant >= 0)\r\n                                                      //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\nIF cOpcao $ \"DB_I\" //Incluir                                                                                                   \r\n   @ 145,005 BUTTON \"&Entrada\" SIZE 25,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cLocaliz,cNumSeq,\"499\"   ,cNumLote,cSerie,cCliFor,cLoja,,cFolder),oDlgSDB:End())\r\n   @ 145,040 BUTTON \"&Saida\"   SIZE 25,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cLocaliz,cNumSeq,\"999\"   ,cNumLote,cSerie,cCliFor,cLoja,,cFolder),oDlgSDB:End())\r\n   @ 145,075 BUTTON \"&Transf.\" SIZE 25,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cLocaliz,cNumSeq,\"499/999\",cNumLote,cSerie,cCliFor,cLoja,,cFolder),oDlgSDB:End())  \r\n   @ 145,110 BUTTON \"&Sair\"    SIZE 25,14 PIXEL ACTION oDlgSDB:End()  \r\nElse\r\n   @ 145,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cLocaliz,cNumSeq,Nil   ,cNumLote,cSerie,cCliFor,cLoja,,cFolder),oDlgSDB:End())\r\n   @ 145,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSDB:End()\r\nEndif\r\n\r\nACTIVATE MSDIALOG oDlgSDB  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustDAB8(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSDA\r\nLocal aArea    := GetArea()\r\nLocal dData    := IF(Len(aDetDASB8)>0,aDetDASB8[oDetDASB8:nAT][01],dDataBase)\r\nLocal cLoteCtl := IF(Len(aDetDASB8)>0,aDetDASB8[oDetDASB8:nAT][02],SPACE(10))\r\nLocal nQuant   := IF(Len(aDetDASB8)>0,aDetDASB8[oDetDASB8:nAT][04],0)\r\nLocal cDoc     := IF(Len(aDetDASB8)>0,aDetDASB8[oDetDASB8:nAT][07],SPACE(06))\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSDA TITLE \"Ajuste no SB8\"  OF oDlgSDA PIXEL FROM 010,010 TO 200,265 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 009,005 SAY \"Lote\"                                    SIZE 040,10 PIXEL OF oDlgSDA FONT oBold \r\n@ 005,043 MSGET oVar   VAR cLoteCtl Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSDA When .F.\r\n@ 024,005 SAY \"Documento\"                               SIZE 040,10 PIXEL OF oDlgSDA FONT oBold \r\n@ 020,043 MSGET oVar   VAR cDoc     Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSDA When .F.\r\n@ 039,005 SAY \"Data\"                                    SIZE 040,10 PIXEL OF oDlgSDA FONT oBold  \r\n@ 035,043 MSGET oVar   VAR dData    Picture \"99/99/99\"  SIZE 040,10 PIXEL OF oDlgSDA When .F.\r\n@ 054,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSDA FONT oBold \r\n@ 050,043 MSGET oVar   VAR nQuant   Picture cPict       SIZE 050,10 PIXEL OF oDlgSDA When .T.\r\n                                                     //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\n@ 075,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant),oDlgSDA:End())\r\n@ 075,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSDA:End()\r\n\r\nACTIVATE MSDIALOG oDlgSDA  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustSDA(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSDA\r\nLocal aArea    := GetArea()\r\nLocal dData    := IF(Len(aDetDASDA)>0,aDetDASDA[oDetDASDA:nAT][01],dDataBase)\r\nLocal cLoteCtl := IF(Len(aDetDASDA)>0,aDetDASDA[oDetDASDA:nAT][02],SPACE(10))\r\nLocal nQuant   := IF(Len(aDetDASDA)>0,aDetDASDA[oDetDASDA:nAT][03],0)\r\nLocal cDoc     := IF(Len(aDetDASDA)>0,aDetDASDA[oDetDASDA:nAT][08],SPACE(06))\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSDA TITLE \"Ajuste no SDA\"  OF oDlgSDA PIXEL FROM 010,010 TO 200,265 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 009,005 SAY \"Lote\"                                    SIZE 040,10 PIXEL OF oDlgSDA FONT oBold \r\n@ 005,043 MSGET oVar   VAR cLoteCtl Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSDA When .F.\r\n@ 024,005 SAY \"Documento\"                               SIZE 040,10 PIXEL OF oDlgSDA FONT oBold \r\n@ 020,043 MSGET oVar   VAR cDoc     Picture \"@!\"        SIZE 030,10 PIXEL OF oDlgSDA When .F.\r\n@ 039,005 SAY \"Data\"                                    SIZE 040,10 PIXEL OF oDlgSDA FONT oBold  \r\n@ 035,043 MSGET oVar   VAR dData    Picture \"99/99/99\"  SIZE 040,10 PIXEL OF oDlgSDA When .F.\r\n@ 054,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSDA FONT oBold \r\n@ 050,043 MSGET oVar   VAR nQuant   Picture cPict       SIZE 050,10 PIXEL OF oDlgSDA When .T.\r\n                                                     //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\n@ 075,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant),oDlgSDA:End())\r\n@ 075,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSDA:End()\r\n\r\nACTIVATE MSDIALOG oDlgSDA  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustSBJ(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSBJ\r\nLocal aArea     := GetArea()\r\nLocal cLoteCtl  := IF(Len(aAnaSBJ)>0,aAnaSBJ[oAnaSBJ:nAT][01],Space(10))\r\nLocal cNumLote  := IF(Len(aAnaSBJ)>0,aAnaSBJ[oAnaSBJ:nAT][02],Space(06))\r\nLocal nQuant    := IF(Len(aAnaSBJ)>0,aAnaSBJ[oAnaSBJ:nAT][04],0        )\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSBJ TITLE \"Ajuste no SBJ\"  OF oDlgSBJ PIXEL FROM 010,010 TO 200,265 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 009,005 SAY \"Lote\"                                    SIZE 040,10 PIXEL OF oDlgSBJ FONT oBold  \r\n@ 005,043 MSGET oVar   VAR cLoteCtl Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSBJ \r\n@ 024,005 SAY \"Num.Lote\"                                SIZE 040,10 PIXEL OF oDlgSBJ FONT oBold \r\n@ 020,043 MSGET oVar   VAR cNumLote Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSBJ \r\n@ 039,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSBJ FONT oBold \r\n@ 035,043 MSGET oVar   VAR nQuant   Picture cPict       SIZE 050,10 PIXEL OF oDlgSBJ \r\n                                                     //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\n@ 075,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,Nil ,Nil  ,nQuant,Nil      ,Nil    ,Nil     ,cNumLote),oDlgSBJ:End())\r\n@ 075,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSBJ:End()\r\n\r\nACTIVATE MSDIALOG oDlgSBJ  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustSBK(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgSBK\r\nLocal aArea     := GetArea()\r\nLocal cEndereco := IF(Len(aAnaSBK)>0,aAnaSBK[oAnaSBK:nAT][01],Space(15))\r\nLocal cLoteCtl  := IF(Len(aAnaSBK)>0,aAnaSBK[oAnaSBK:nAT][02],Space(10))\r\nLocal nQuant    := IF(Len(aAnaSBK)>0,aAnaSBK[oAnaSBK:nAT][03],0        )\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgSBK TITLE \"Ajuste no SBK\"  OF oDlgSBK PIXEL FROM 010,010 TO 200,265 \r\nDEFINE FONT oBold   NAME \"Arial\" SIZE 0, -12 BOLD\r\n\r\n@ 009,005 SAY \"Endereço\"                                SIZE 040,10 PIXEL OF oDlgSBK FONT oBold  \r\n@ 005,043 MSGET oVar   VAR cEndereco Picture \"@!\"       SIZE 040,10 PIXEL OF oDlgSBK \r\n@ 024,005 SAY \"Lote\"                                    SIZE 040,10 PIXEL OF oDlgSBK FONT oBold \r\n@ 020,043 MSGET oVar   VAR cLoteCtl Picture \"@!\"        SIZE 040,10 PIXEL OF oDlgSBK \r\n@ 039,005 SAY \"Quantidade\"                              SIZE 040,10 PIXEL OF oDlgSBK FONT oBold \r\n@ 035,043 MSGET oVar   VAR nQuant   Picture cPict       SIZE 050,10 PIXEL OF oDlgSBK \r\n                                                     //fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja)\r\n@ 075,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao,cLoteCtl,Nil ,Nil  ,nQuant,cEndereco),oDlgSBK:End())\r\n@ 075,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgSBK:End()\r\n\r\nACTIVATE MSDIALOG oDlgSBK  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjusta(cOpcao,cLoteCtl,cDoc,dData,nQuant,cEndereco,cNumSeq,cTipoMov,cNumLote,cSerie,cCliFor,cLoja,dDtValid,cFolder)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal aArea  := GetArea()\r\n/*Do Case\r\n  Case cOpcao == \"SALDO_SB2\"  // Saldo do SB2\r\n     DBSelectArea(\"SB2\")\r\n     DBSetOrder(1) //B2_FILIAL+B2_COD+B2_LOCAL\r\n     IF DBSeek(xFilial(\"SB2\")+cProduto+cLocal)\r\n        RecLock(\"SB2\",.F.)\r\n        SB2->B2_QATU    := nQuant\r\n        SB2->B2_QTSEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n        MsUnlock()\r\n        nSB2 := SB2->B2_QATU\r\n     Endif\r\n  Case cOpcao == \"CLASS_SB2\"  // Saldo A Classificar do SB2\r\n     DBSelectArea(\"SB2\")\r\n     DBSetOrder(1) //B2_FILIAL+B2_COD+B2_LOCAL\r\n     IF DBSeek(xFilial(\"SB2\")+cProduto+cLocal)\r\n        RecLock(\"SB2\",.F.)\r\n        SB2->B2_QACLASS := nQuant\r\n        MsUnlock()\r\n        nDASB2 := SB2->B2_QACLASS\r\n     Endif\r\n  Case cOpcao == \"SALDO_SB9\"  // Saldo do SB9\r\n     DBSelectArea(\"SB9\")\r\n     DBSetOrder(1) //B9_FILIAL+B9_COD+B9_LOCAL+DTOS(B9_DATA)\r\n     IF DBSeek(xFilial(\"SB9\")+cProduto+cLocal+DTOS(dUltFech))\r\n        RecLock(\"SB9\",.F.)\r\n        SB9->B9_QINI    := nQuant\r\n        SB9->B9_QISEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n        MsUnlock()          \r\n        nSB9 := SB9->B9_QINI\r\n     Endif\r\n  Case cOpcao == \"DAxB8\" // Altera Saldo a Classificar\r\n     IF !Empty(aDetDASB8[oDetDASB8:nAT][12])\r\n        DBSelectArea(\"SB8\")\r\n        DBGoto(aDetDASB8[oDetDASB8:nAT][12])\r\n        IF !Eof()\r\n           RecLock(\"SB8\",.F.)\r\n           SB8->B8_QACLASS := nQuant\r\n           SB8->B8_QACLAS2 := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n           MsUnlock()\r\n        Endif   \r\n     Endif   \r\n  Case cOpcao == \"SDA\"   // Altera Saldo a Classificar no SDA\r\n     IF !Empty(aDetDASDA[oDetDASDA:nAT][13])\r\n        DBSelectArea(\"SDA\")\r\n        DBGoto(aDetDASDA[oDetDASDA:nAT][13])\r\n        IF !Eof()\r\n           RecLock(\"SDA\",.F.)\r\n           SDA->DA_SALDO   := nQuant\r\n           SDA->DA_QTSEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n           MsUnlock()\r\n        Endif   \r\n     Endif    \r\n  Case cOpcao == \"B8_I\"  // Inclusao\r\n     cLoteFor  := Nil\r\n     cSerie    := Nil                                                         \r\n     cCliFor   := Nil\r\n     cLoja     := Nil\r\n     cTm       := Nil \r\n     cOrigLan  := \"MI\"\r\n     cChave    := Nil\r\n     cOp       := Nil\r\n     nQuant2UM := Nil\r\n     cNumSeq   := Nil\r\n     dDtValid  := Nil\r\n     fMovto(.T.,.F.,cProduto,cLocal,cLoteCtl,cNumLote,cLoteFor,cCliFor,cLoja,cTm,cOrigLan,cChave,cNumSeq,cDoc,cSerie,cOp,nQuant,nQuant2UM,dData,dDtValid)\r\n  Case cOpcao == \"B8_A\" // Alteracao\r\n     DBSelectArea(\"SB8\")\r\n     DBSetOrder(3) // B8_FILIAL+B8_PRODUTO+B8_LOCAL+B8_LOTECTL+B8_NUMLOTE+DTOS(B8_DTVALID)\r\n     IF DBSeek(xFilial(\"SB8\")+cProduto+cLocal+cLoteCtl+cNumLote+DTOS(aDetSB8[oDetSB8:nAT][4]))\r\n        RecLock(\"SB8\",.F.)\r\n        SB8->B8_SALDO  := nQuant\r\n        SB8->B8_SALDO2 := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n        MsUnlock()\r\n     Endif\r\n  Case cOpcao == \"B8_E\" // Exclusao\r\n     dDtValid  := aDetSB8[oDetSB8:nAT][4]\r\n     DBSelectArea(\"SB8\")\r\n     DBSetOrder(3) // B8_FILIAL+B8_PRODUTO+B8_LOCAL+B8_LOTECTL+B8_NUMLOTE+DTOS(B8_DTVALID)\r\n     IF DBSeek(xFilial(\"SB8\")+cProduto+cLocal+cLoteCtl+cNumLote+DTOS(dDtValid))\r\n        RecLock(\"SB8\",.F.)\r\n        DBDelete()\r\n        MsUnlock()\r\n     Endif\r\n  Case cOpcao $ \"D5_I\" // Inclusao\r\n     cLoteFor  := Nil                                                         \r\n     cOrigLan  := \"MI\"\r\n     cChave    := Nil\r\n     cOp       := Nil\r\n     nQuant2UM := Nil\r\n     IF \"499\" $ cTipoMov\r\n       cTm := \"499\"\r\n       fMovto(.F.,.T.,cProduto,cLocal,cLoteCtl,cNumLote,cLoteFor,cCliFor,cLoja,cTm,cOrigLan,cChave,cNumSeq,cDoc,cSerie,cOp,nQuant,nQuant2UM,dData,dDtValid)\r\n     Endif  \r\n     IF \"999\" $ cTipoMov\r\n       cTm := \"999\"\r\n       fMovto(.F.,.T.,cProduto,cLocal,cLoteCtl,cNumLote,cLoteFor,cCliFor,cLoja,cTm,cOrigLan,cChave,cNumSeq,cDoc,cSerie,cOp,nQuant,nQuant2UM,dData,dDtValid)\r\n     Endif  \r\n  Case cOpcao $ \"D5_A\" // Alterar \r\n    IF !Empty(aDetSD5[oDetSD5:nAT][14])\r\n       DBSelectArea(\"SD5\")\r\n       DBGoto(aDetSD5[oDetSD5:nAT][14])\r\n       IF !Eof()\r\n          RecLock(\"SD5\",.F.)\r\n          SD5->D5_QUANT   := nQuant\r\n          SD5->D5_QTSEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n          MsUnlock()\r\n       Endif   \r\n    Endif   \r\n  Case cOpcao $ \"D5_E\" // Excluir\r\n    IF !Empty(aDetSD5[oDetSD5:nAT][14])\r\n       DBSelectArea(\"SD5\")\r\n       DBGoto(aDetSD5[oDetSD5:nAT][14])\r\n       IF !Eof()\r\n          RecLock(\"SD5\",.F.)\r\n          DBDelete()\r\n          MsUnlock() \r\n       Endif   \r\n    Endif   \r\n  Case cOpcao $ \"D5+B8_I\" // Inclusao\r\n     cLoteFor  := Nil                                                         \r\n     cOrigLan  := \"MI\"\r\n     cChave    := Nil\r\n     cOp       := Nil\r\n     nQuant2UM := Nil\r\n     cTm       := \"499\"\r\n     fMovto(.T.,.T.,cProduto,cLocal,cLoteCtl,cNumLote,cLoteFor,cCliFor,cLoja,cTm,cOrigLan,cChave,cNumSeq,cDoc,cSerie,cOp,nQuant,nQuant2UM,dData,dDtValid)\r\n  Case cOpcao $ \"D5+B8_S\" // Subtrair\r\n     cLoteFor  := Nil                                                         \r\n     cOrigLan  := \"MI\"\r\n     cChave    := Nil\r\n     cOp       := Nil\r\n     cSerie    := Nil                                                         \r\n     cTm       := \"999\"\r\n     nQuant2UM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n     nPotencia := 0\r\n     DBSelectArea(\"SB8\")\r\n     DBSetOrder(3) // B8_FILIAL+B8_PRODUTO+B8_LOCAL+B8_LOTECTL+B8_NUMLOTE+DTOS(B8_DTVALID)\r\n     IF DBSeek(xFilial(\"SB8\")+cProduto+cLocal+cLoteCtl+cNumLote+DTOS(dDtValid))\r\n        RecLock(\"SB8\",.F.)\r\n        SB8->B8_SALDO  -= nQuant\r\n        SB8->B8_SALDO2 -= nQuant2UM\r\n        MsUnlock()\r\n     Endif\r\n     fMovto(.F.,.T.,cProduto,cLocal,cLoteCtl,cNumLote,cLoteFor,cCliFor,cLoja,cTm,cOrigLan,cChave,cNumSeq,cDoc,cSerie,cOp,nQuant,nQuant2UM,dData,dDtValid)\r\n  Case cOpcao == \"D5+B8_E\" // Estornar\r\n     cTipoLote := If(Rastro(cProduto),If(Rastro(cProduto,\"S\"),\"S\",\"L\"),\"N\")\r\n     cOrigLan  := aDetSD5[oDetSD5:nAT][02]                                   \r\n     EstornaSD5(cTipoLote,cProduto,cLocal,cLoteCtl,cNumLote,cNumSeq,.F.,NIL,cOrigLan,NIL,nQuant,Nil,cCliFor,cLoja,cDoc,cSerie)\r\n  Case cOpcao == \"BF_I\" // Inclusao\r\n     cNumLote  := Nil                 \r\n     cNumSeq   := IF(Empty(cNumSeq),ProxNum(),cNumSeq)\r\n     nQuant2UM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n     cTm       := \"499\"\r\n     fGravaSBF(cTM,cProduto,cLocal,cLoteCtl,cNumLote,cNumSeq,cEndereco,nQuant,nQuant2UM)\r\n  Case cOpcao == \"BF_A\" // Alteracao\r\n     IF !Empty(aDetSBF[oDetSBF:nAT][11]) \r\n        DBSelectArea(\"SBF\")\r\n        DBGoto(aDetSBF[oDetSBF:nAT][11])       \r\n        IF !Eof()\r\n           RecLock(\"SBF\",.F.)\r\n           SBF->BF_QUANT   := nQuant\r\n           SBF->BF_QTSEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n           MsUnlock()\r\n           If SBF->BF_QUANT <= 0\r\n              DeletSBF()\r\n           Endif \r\n        Endif   \r\n     Endif   \r\n  Case cOpcao == \"BF_E\" // Exclusao\r\n     IF !Empty(aDetSBF[oDetSBF:nAT][11])\r\n        DBSelectArea(\"SBF\")\r\n        DBGoto(aDetSBF[oDetSBF:nAT][11])\r\n        IF !Eof()\r\n           RecLock(\"SBF\",.F.)\r\n           SBF->BF_QUANT   := 0\r\n           SBF->BF_QTSEGUM := 0\r\n           MsUnlock()\r\n           If SBF->BF_QUANT <= 0\r\n              DeletSBF()\r\n           Endif \r\n        Endif   \r\n     Endif  \r\n  Case cOpcao $ \"DB_I\" // Inclusao\r\n     cNumLote  := Nil\r\n     cNumSeq   := IF(Empty(cNumSeq),ProxNum(),cNumSeq)\r\n     cNumSerie := Nil\r\n     cTipoNf   := Nil\r\n     cOrigem   := \"SD3\"\r\n     cItem     := \"0001\"\r\n     nQuant2UM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n     IF \"499\" $ cTipoMov\r\n        cTm   := \"499\"\r\n        cTipo := \"D\"                                                                                                                          \r\n        CriaSDB(cProduto,cLocal,nQuant,cEndereco,cNumSerie,cDoc,cSerie,cCliFor,cLoja,cTipoNf,cOrigem,dData,cLoteCtl,cNumLote,cNumSeq,cTm,cTipo,cItem,.F.,0,nQuant2UM,0)\r\n     Endif   \r\n     IF \"999\" $ cTipoMov\r\n       cTm := \"999\"\r\n       cTipo := \"M\"                                                                                                                          \r\n       CriaSDB(cProduto,cLocal,nQuant,cEndereco,cNumSerie,cDoc,cSerie,cCliFor,cLoja,cTipoNf,cOrigem,dData,cLoteCtl,cNumLote,cNumSeq,cTm,cTipo,cItem,.F.,0,nQuant2UM,0)\r\n     Endif               \r\n  Case cOpcao $ \"DB_A\" // Alterar \r\n    IF !Empty(aDetSDB[oDetSDB:nAT][14])\r\n       DBSelectArea(\"SDB\")\r\n       DBGoto(aDetSDB[oDetSDB:nAT][14])\r\n       IF !Eof()\r\n          RecLock(\"SDB\",.F.)\r\n          SDB->DB_QUANT   := nQuant\r\n          SDB->DB_QTSEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n          MsUnlock()\r\n       Endif   \r\n    Endif   \r\n  Case cOpcao $ \"DB_E\" // Excluir\r\n    IF !Empty(aDetSDB[oDetSDB:nAT][14])\r\n       DBSelectArea(\"SDB\")\r\n       DBGoto(aDetSDB[oDetSDB:nAT][14])\r\n       IF !Eof()\r\n          RecLock(\"SDB\",.F.)\r\n          DBDelete()\r\n          MsUnlock() \r\n       Endif   \r\n    Endif   \r\n  Case cOpcao $ \"DB+BF_I\" // Inclusao\r\n     cNumLote  := Nil\r\n     cNumSerie := Nil\r\n     cNumSeq   := IF(Empty(cNumSeq),ProxNum(),cNumSeq)\r\n     cTipoNf   := Nil\r\n     cOrigem   := \"SD3\"\r\n     cTm       := \"499\"\r\n     cTipo     := \"D\"                                                                                                                  \r\n     cItem     := \"0001\"\r\n     nQuant2UM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n     CriaSDB(cProduto,cLocal,nQuant,cEndereco,cNumSerie,cDoc,cSerie,cCliFor,cLoja,cTipoNf,cOrigem,dData,cLoteCtl,cNumLote,cNumSeq,cTm,cTipo,cItem,.F.,0,nQuant2UM,0)\r\n     GravaSBF('SDB')\r\n  Case cOpcao $ \"DB+BF_S\" // Subtrair\r\n     cNumLote  := Nil\r\n     cNumSerie := Nil\r\n     cNumSeq   := IF(Empty(cNumSeq),ProxNum(),cNumSeq)\r\n     cTipoNf   := Nil\r\n     cOrigem   := \"SD3\"\r\n     cTm       := \"999\"\r\n     cTipo     := \"M\"                                                                                                                  \r\n     cItem     := \"0001\"\r\n     nQuant2UM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n     CriaSDB(cProduto,cLocal,nQuant,cEndereco,cNumSerie,cDoc,cSerie,cCliFor,cLoja,cTipoNf,cOrigem,dData,cLoteCtl,cNumLote,cNumSeq,cTm,cTipo,cItem,.F.,0,nQuant2UM,0)\r\n     GravaSBF('SDB')\r\n  Case cOpcao $ \"DB+BF_E\" // Estorno\r\n     IF !Empty(aDetSDB[oDetSDB:nAT][14])\r\n        DBSelectArea(\"SDB\")\r\n        DBGoto(aDetSDB[oDetSDB:nAT][14])\r\n        IF !Eof()\r\n           nQuant2UM := SDB->DB_QTSEGUM\r\n           cNumLote  := IF(!lNumLote,SDB->DB_NUMLOTE,Space(06))\r\n           cDoc      := SDB->DB_DOC\r\n           cSerie    := SDB->DB_SERIE\r\n           cCliFor   := SDB->DB_CLIFOR\r\n           cLoja     := SDB->DB_LOJA\r\n           cNumSerie := SDB->DB_NUMSERI\r\n           cNumSeq   := SDB->DB_NUMSEQ\r\n           cTipoNf   := SDB->DB_TIPONF\r\n           cOrigem   := SDB->DB_ORIGEM\r\n           cTm       := \"999\"\r\n           cTipo     := SDB->DB_TIPO\r\n           cItem     := SDB->DB_ITEM\r\n           CriaSDB(cProduto,cLocal,nQuant,cEndereco,cNumSerie,cDoc,cSerie,cCliFor,cLoja,cTipoNf,cOrigem,dData,cLoteCtl,cNumLote,cNumSeq,cTm,cTipo,cItem,.T.,0,nQuant2UM,0)\r\n           GravaSBF('SDB')\r\n        Endif   \r\n     Endif   \r\n  Case cOpcao $ \"BJ_I\" // Incluir\r\n     dDataValid := CTOD(\"  /  /  \")\r\n     DBSelectArea(\"SB8\")\r\n     DBSetOrder(3) //B8_FILIAL+B8_PRODUTO+B8_LOCAL+B8_LOTECTL+B8_NUMLOTE+DTOS(B8_DTVALID)\r\n     IF DBSeek(xFilial(\"SB8\")+cProduto+cLocal+cLoteCtl)\r\n        dDataValid := SB8->B8_DTVALID\r\n     Endif     \r\n     DBSelectArea(\"SBJ\")     \r\n     DBSetOrder(1) // BJ_FILIAL+BJ_COD+BJ_LOCAL+BJ_LOTECTL+BJ_NUMLOTE+DTOS(BJ_DATA)\r\n     IF DBSeek(xFilial(\"SBJ\")+cProduto+cLocal+cLoteCtl+cNumLote+DTOS(dUltFech))\r\n        MsgStop(\"Movimento já existe !!!\")\r\n        Return\r\n     Endif     \r\n     RecLock(\"SBJ\",.T.)\r\n     SBJ->BJ_FILIAL  := xFilial(\"SBJ\")\r\n     SBJ->BJ_COD     := cProduto\r\n     SBJ->BJ_LOCAL   := cLocal        \r\n     SBJ->BJ_DATA    := dUltFech\r\n     SBJ->BJ_DTVALID := dDataValid\r\n     SBJ->BJ_LOTECTL := cLoteCtl\r\n     SBJ->BJ_NUMLOTE := IF(!lNumLote,cNumLote,Space(06))\r\n     SBJ->BJ_QINI    := nQuant\r\n     SBJ->BJ_QISEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n     MsUnlock()\r\n  Case cOpcao $ \"BJ_A\" // Alterar\r\n     IF !Empty(aAnaSBJ[oAnaSBJ:nAT][05])\r\n        DBSelectArea(\"SBJ\")\r\n        DBGoto(aAnaSBJ[oAnaSBJ:nAT][05])\r\n        IF !Eof()\r\n           RecLock(\"SBJ\",.F.)\r\n           SBJ->BJ_LOTECTL := cLoteCtl\r\n           SBJ->BJ_NUMLOTE := IF(!lNumLote,cNumLote,Space(06))\r\n           SBJ->BJ_QINI    := nQuant\r\n           SBJ->BJ_QISEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n           MsUnlock()\r\n        Endif   \r\n     Endif   \r\n  Case cOpcao $ \"BJ_E\" // Excluir\r\n     IF !Empty(aAnaSBJ[oAnaSBJ:nAT][05])\r\n        DBSelectArea(\"SBJ\")\r\n        DBGoto(aAnaSBJ[oAnaSBJ:nAT][05])\r\n        IF !Eof()\r\n           RecLock(\"SBJ\",.F.)\r\n           DBDelete()\r\n           MsUnlock() \r\n        Endif   \r\n     Endif   \r\n  Case cOpcao $ \"BK_I\" // Incluir\r\n     RecLock(\"SBK\",.T.)\r\n     SBK->BK_FILIAL  := xFilial(\"SBK\")\r\n     SBK->BK_COD     := cProduto\r\n     SBK->BK_LOCAL   := cLocal        \r\n     SBK->BK_DATA    := dUltFech\r\n     SBK->BK_LOCALIZ := cEndereco\r\n     SBK->BK_LOTECTL := cLoteCtl\r\n//   SBK->BK_NUMLOTE := cNumLote\r\n     SBK->BK_QINI    := nQuant\r\n     SBK->BK_QISEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n     MsUnlock()\r\n  Case cOpcao $ \"BK_A\" // Alterar\r\n     IF !Empty(aAnaSBK[oAnaSBK:nAT][04])\r\n        DBSelectArea(\"SBK\")\r\n        DBGoto(aAnaSBK[oAnaSBK:nAT][04])\r\n        IF !Eof()\r\n           RecLock(\"SBK\",.F.)\r\n           SBK->BK_LOTECTL := cLoteCtl\r\n           SBK->BK_LOCALIZ := cEndereco\r\n           SBK->BK_QINI    := nQuant\r\n           SBK->BK_QISEGUM := ConvUM(cProduto,nQuant,0,2) // 2UM\r\n           MsUnlock()           \r\n        Endif   \r\n     Endif   \r\n  Case cOpcao $ \"BK_E\" // Excluir\r\n     IF !Empty(aAnaSBK[oAnaSBK:nAT][04])\r\n        DBSelectArea(\"SBK\")\r\n        DBGoto(aAnaSBK[oAnaSBK:nAT][04])\r\n        IF !Eof()\r\n           RecLock(\"SBK\",.F.)\r\n           DBDelete()\r\n           MsUnlock() \r\n        Endif   \r\n     Endif   \r\n  Case cOpcao $ \"D5DB_A\" // Alterar Movimento - NumSeq\r\n     For I:= 1 To Len(ACols)\r\n        Do Case\r\n           Case aCols[I,1] = \"SD1\"\r\n             DBSelectArea(\"SD1\")\r\n             DBGoto(aCols[I,14])\r\n             IF !Eof()\r\n                IF aCols[I,15] // Deletar\r\n                   RecLock(\"SD1\",.F.)\r\n                   DBDelete()\r\n                   MsUnlock()\r\n                Else  \r\n                   IF aCols[I,02] <> SD1->D1_DTDIGIT .OR.;\r\n                      aCols[I,03] <> SD1->D1_DOC     .OR.;\r\n                      aCols[I,04] <> SD1->D1_SERIE   .OR.;\r\n                      aCols[I,05] <> SD1->D1_FORNECE .OR.;\r\n                      aCols[I,06] <> SD1->D1_LOJA    .OR.;\r\n                      aCols[I,09] <> SD1->D1_LOTECTL .OR.;\r\n                      aCols[I,10] <> SD1->D1_NUMLOTE .OR.;\r\n                      aCols[I,12] <> SD1->D1_QUANT   .OR.;\r\n                      aCols[I,13] <> SD1->D1_QTSEGUM\r\n                      RecLock(\"SD1\",.F.)\r\n                      SD1->D1_DTDIGIT := aCols[I,02]\r\n                      SD1->D1_DOC     := aCols[I,03]\r\n                      SD1->D1_SERIE   := aCols[I,04]\r\n                      SD1->D1_FORNECE := aCols[I,05]\r\n                      SD1->D1_LOJA    := aCols[I,06]\r\n                      SD1->D1_LOTECTL := aCols[I,09]\r\n                      SD1->D1_NUMLOTE := IF(!lNumLote,aCols[I,10],Space(06))\r\n                      SD1->D1_QUANT   := aCols[I,12]\r\n                      SD1->D1_QTSEGUM := aCols[I,13]\r\n                      MsUnlock()\r\n                   Endif\r\n                Endif\r\n             Endif   \r\n           Case aCols[I,1] = \"SD2\"\r\n             DBSelectArea(\"SD2\")\r\n             DBGoto(aCols[I,14])\r\n             IF !Eof()\r\n                IF aCols[I,15] // Deletar\r\n                   RecLock(\"SD2\",.F.)\r\n                   DBDelete()\r\n                   MsUnlock()\r\n                Else  \r\n                   IF aCols[I,02] <> D2_EMISSAO .OR.;\r\n                      aCols[I,03] <> D2_DOC     .OR.;\r\n                      aCols[I,04] <> D2_SERIE   .OR.;\r\n                      aCols[I,05] <> D2_CLIENTE .OR.;\r\n                      aCols[I,06] <> D2_LOJA    .OR.;\r\n                      aCols[I,09] <> D2_LOTECTL .OR.;\r\n                      aCols[I,10] <> D2_NUMLOTE .OR.;\r\n                      aCols[I,11] <> D2_LOCALIZ .OR.;\r\n                      aCols[I,12] <> D2_QUANT   .OR.;\r\n                      aCols[I,13] <> D2_QTSEGUM\r\n                      RecLock(\"SD2\",.F.)\r\n                      SD2->D2_EMISSAO := aCols[I,02]\r\n                      SD2->D2_DOC     := aCols[I,03]\r\n                      SD2->D2_SERIE   := aCols[I,04]\r\n                      SD2->D2_CLIENTE := aCols[I,05]\r\n                      SD2->D2_LOJA    := aCols[I,06]\r\n                      SD2->D2_LOTECTL := aCols[I,09]\r\n                      SD2->D2_NUMLOTE := IF(!lNumLote,aCols[I,10],Space(06))\r\n                      SD2->D2_LOCALIZ := aCols[I,11]\r\n                      SD2->D2_QUANT   := aCols[I,12]\r\n                      SD2->D2_QTSEGUM := aCols[I,13]\r\n                      MsUnlock()\r\n                   Endif\r\n                Endif \r\n             Endif  \r\n           Case aCols[I,1] = \"SD3\"\r\n             DBSelectArea(\"SD3\")\r\n             DBGoto(aCols[I,14])\r\n             IF !Eof()\r\n                IF aCols[I,15] // Deletar\r\n                   RecLock(\"SD3\",.F.)\r\n                   DBDelete()\r\n                   MsUnlock()\r\n                Else  \r\n                   IF aCols[I,02] <> D3_EMISSAO .OR.;\r\n                      aCols[I,03] <> D3_DOC     .OR.;\r\n                      aCols[I,09] <> D3_LOTECTL .OR.;\r\n                      aCols[I,10] <> D3_NUMLOTE .OR.;\r\n                      aCols[I,11] <> D3_LOCALIZ .OR.;\r\n                      aCols[I,12] <> D3_QUANT   .OR.;\r\n                      aCols[I,13] <> D3_QTSEGUM\r\n                      RecLock(\"SD3\",.F.)\r\n                      SD3->D3_EMISSAO := aCols[I,02]\r\n                      SD3->D3_DOC     := aCols[I,03]\r\n                      SD3->D3_LOTECTL := aCols[I,09]\r\n                      SD3->D3_NUMLOTE := IF(!lNumLote,aCols[I,10],Space(06))\r\n                      SD3->D3_LOCALIZ := aCols[I,11]\r\n                      SD3->D3_QUANT   := aCols[I,12]\r\n                      SD3->D3_QTSEGUM := aCols[I,13]\r\n                      MsUnlock()\r\n                   Endif\r\n                Endif\r\n             Endif   \r\n           Case aCols[I,1] = \"SD5\"\r\n             IF !Empty(aCols[I,14])\r\n                DBSelectArea(\"SD5\")\r\n                DBGoto(aCols[I,14])\r\n                IF !Eof()\r\n                   IF aCols[I,15] // Deletar\r\n                      RecLock(\"SD5\",.F.)\r\n                      DBDelete()\r\n                      MsUnlock()\r\n                   Else  \r\n                      IF aCols[I,02] <> D5_DATA    .OR.;\r\n                         aCols[I,03] <> D5_DOC     .OR.;\r\n                         aCols[I,04] <> D5_SERIE   .OR.;\r\n                         aCols[I,05] <> D5_CLIFOR  .OR.;\r\n                         aCols[I,06] <> D5_LOJA    .OR.;\r\n                         aCols[I,09] <> D5_LOTECTL .OR.;\r\n                         aCols[I,10] <> D5_NUMLOTE .OR.;\r\n                         aCols[I,12] <> D5_QUANT   .OR.;\r\n                         aCols[I,13] <> D5_QTSEGUM\r\n                         RecLock(\"SD5\",.F.)\r\n                         SD5->D5_DATA    := aCols[I,02]\r\n                         SD5->D5_DOC     := aCols[I,03]\r\n                         SD5->D5_SERIE   := aCols[I,04]\r\n                         SD5->D5_CLIFOR  := aCols[I,05]\r\n                         SD5->D5_LOJA    := aCols[I,06]\r\n                         SD5->D5_LOTECTL := aCols[I,09]\r\n                         SD5->D5_NUMLOTE := IF(!lNumLote,aCols[I,10],Space(06))\r\n                         SD5->D5_QUANT   := aCols[I,12]\r\n                         SD5->D5_QTSEGUM := aCols[I,13]\r\n                         MsUnlock()\r\n                      Endif\r\n                   Endif \r\n                Endif   \r\n             Endif   \r\n           Case aCols[I,1] = \"SDB\"\r\n             IF !Empty(aCols[I,14])\r\n                DBSelectArea(\"SDB\")\r\n                DBGoto(aCols[I,14])\r\n                IF !Eof()\r\n                   IF aCols[I,15] // Deletar\r\n                      RecLock(\"SDB\",.F.)\r\n                      DBDelete()\r\n                      MsUnlock()\r\n                   Else  \r\n                      IF aCols[I,02] <> DB_DATA    .OR.;\r\n                         aCols[I,03] <> DB_DOC     .OR.;\r\n                         aCols[I,04] <> DB_SERIE   .OR.;\r\n                         aCols[I,05] <> DB_CLIFOR  .OR.;\r\n                         aCols[I,06] <> DB_LOJA    .OR.;\r\n                         aCols[I,09] <> DB_LOTECTL .OR.;\r\n                         aCols[I,10] <> DB_NUMLOTE .OR.;\r\n                         aCols[I,11] <> DB_LOCALIZ .OR.;\r\n                         aCols[I,12] <> DB_QUANT   .OR.;\r\n                         aCols[I,13] <> DB_QTSEGUM\r\n                         RecLock(\"SDB\",.F.)\r\n                         SDB->DB_DATA    := aCols[I,02]\r\n                         SDB->DB_DOC     := aCols[I,03]\r\n                         SDB->DB_SERIE   := aCols[I,04]\r\n                         SDB->DB_CLIFOR  := aCols[I,05]\r\n                         SDB->DB_LOJA    := aCols[I,06]\r\n                         SDB->DB_LOTECTL := aCols[I,09]\r\n                         SDB->DB_NUMLOTE := IF(!lNumLote,aCols[I,10],Space(06))\r\n                         SDB->DB_LOCALIZ := aCols[I,11]\r\n                         SDB->DB_QUANT   := aCols[I,12]\r\n                         SDB->DB_QTSEGUM := aCols[I,13]\r\n                         MsUnlock()\r\n                      Endif\r\n                   Endif   \r\n                Endif \r\n             Endif   \r\n        EndCase\r\n     Next         \r\nEndCase  \r\n\r\nDo Case\r\n  Case Substr(cOpcao,1,2) == \"B8\"\r\n    Processa({||fDetaSB8()})  // Detalhe do SB8 x SD5\r\n  Case Substr(cOpcao,1,2) == \"D5\" .AND. cFolder <> \"13\"\r\n    IF cB8xD5 = \"B8=>D5\"\r\n       Processa({||fDetaSB8()})   // Detalhe do SB8 x SD5\r\n       Processa({||fMontaSD5()})  // Detalhe do SB8 x SD5\r\n    Else\r\n       Processa({||fDetaSD5()})      // Detalhe do SB8 x SD5\r\n       Processa({||fMontaSB8(.T.)})  // Detalhe do SB8 x SD5\r\n    Endif   \r\n  Case Substr(cOpcao,1,2) == \"BF\"\r\n    Processa({||fDetaSBF()})  // Detalhe do SB8 x SD5\r\n  Case Substr(cOpcao,1,2) == \"DB\" .AND. cFolder <> \"13\"\r\n    IF cBFxDB = \"BF=>DB\"\r\n       Processa({||fDetaSBF()})   // Detalhe do SBF x SDB\r\n       Processa({||fMontaSDB()})  // Detalhe do SBF x SDB\r\n    Else\r\n       Processa({||fDetaSDB()})   // Detalhe do SBF x SDB\r\n       Processa({||fMontaSBF(.T.)})  // Detalhe do SBF x SDB\r\n    Endif \r\n  Case cOpcao == \"DAxB8\"\r\n    Processa({||fDetaDASB8()})      \r\n  Case cOpcao == \"SDA\"  \r\n    Processa({||fDetaSDA()})      \r\n  Case cOpcao $ \"BJ_I/BJ_A/BJ_E\"\r\n    Processa({||fDetaSBJ()})  \r\n  Case cOpcao $ \"BK_I/BK_A/BK_E\"\r\n    Processa({||fDetaSBK()})    \r\nEndCase\r\n  */\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fMovto(lSB8,lSD5,cProduto,cLocal,cLoteCtl,cNumLote,cLoteFor,cCliFor,cLoja,cTm,cOrigLan,cChave,cNumSeq,cDoc,cSerie,cOp,nQuant,nQuant2UM,dData,dDtValid,lCrialote,nPotencia)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal nRegistro := 0\r\nLocal aArea    := GetArea()\r\nLocal aAreaSB1 := SB1->(GetArea())\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Preenche parametros nao recebidos pela funcao         ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\ndData     := IF(dData == NIL .Or. !(ValType(dData) == \"D\") .Or. Empty(dData),dDataBase,dData)\r\ncChave    := IF(cChave == NIL,\"\",cChave)\r\ncLoteFor  := IF(cLoteFor == NIL,\"\",cLoteFor)\r\nnQuant2UM := If(nQuant2UM == NIL, ConvUM(cProduto, nQuant, 0, 2),ConvUM(cProduto, nQuant, nQuant2UM,2))\r\nlCriaLote := If(ValType(lCriaLote) # \"L\",.F.,lCrialote)\r\nnPotencia := If(nPotencia == NIL, 0,nPotencia)\r\ncNumSeq   := IF(Empty(cNumSeq),ProxNum(),cNumSeq)\r\n\r\nDBSelectArea(\"SB1\")\r\nDBSetOrder(1)\r\nDBSeek(xFilial(\"SB1\")+cProduto)\r\n// Descobre a data de validade\r\nIf !(ValType(dDtValid) == \"D\") .Or. Empty(dDtValid)\r\n\tIf SB1->B1_FILIAL+SB1->B1_COD == xFilial(\"SB1\")+cProduto\r\n\t\tdDtValid:=dData+SB1->B1_PRVALID\r\n\tElse\r\n\t\tdDtValid:=dData\r\n\tEndIf\r\nEndIf\r\nRestArea(aAreaSB1)\r\n\r\n// Descobre o NumLote\r\nIF !lNumLote\r\n   cNumLote := If(cNumLote == Nil,NextLote(cProduto,\"S\"),IF(Empty(cNumLote),NextLote(cProduto,\"S\"),cNumLote))\r\nElse          \r\n   cNumLote := Space(6)       \r\nEndif                      \r\n\r\n// Descobre o lote\r\ncLoteCtl := If(Empty(cLoteCtl),NextLote(cProduto,\"L\",cNumLote),cLoteCtl)\r\ncLoteCtl := If(Empty(cLoteCtl),\"AUTO\"+cNumLote,cLoteCtl)\r\n/*\r\nIF lSB8\r\n  DBSelectArea(\"SB8\")\r\n  RecLock(\"SB8\",.T.)\r\n  Replace\tB8_FILIAL  with cFilial,;\r\n  \tB8_NUMLOTE with cNumLote,;\r\n\tB8_PRODUTO with cProduto,;\r\n\tB8_LOCAL   with cLocal,;\r\n\tB8_DATA    with dData,;\r\n\tB8_DTVALID with dDtValid,;\r\n\tB8_SALDO   with nQuant,;\r\n\tB8_SALDO2  with nQuant2UM,;\r\n\tB8_ORIGLAN with cOrigLan,;\r\n\tB8_LOTEFOR with cLoteFor,;\r\n\tB8_DOC     with cDoc,;\r\n\tB8_SERIE   with cSerie,;\r\n\tB8_CLIFOR  with cCliFor,;\r\n\tB8_LOJA    with cLoja,;\r\n\tB8_PRODUTO with cProduto,;\r\n\tB8_QTDORI  with nQuant,;\r\n\tB8_QTDORI2 with nQuant2UM,;\r\n\tB8_LOTECTL with cLoteCtl,;\r\n\tB8_POTENCI with nPotencia\r\n  MsUnlock()\r\n\r\n  // Verifica se a data de validade pode ser utilizada\r\n  nRegistro:=Recno()\r\n  If DBSeek(xFilial(\"SB8\")+cProduto+cLocal+cLoteCtl+IF(Rastro(cProduto,\"S\"),cNumLote,\"\"))\r\n     If\tdDtValid # SB8->B8_DTVALID\r\n  \t\tHelpAutoma(\" \",1,\"A240DTVALI\")\r\n    \tdDtValid:=SB8->B8_DTVALID\r\n\t\t// Grava no registro o Lote e a Data de Validade\r\n\t\tDBGoto(nRegistro)\r\n        RecLock(\"SB8\",.F.)\r\n\t\tReplace\tB8_DTVALID with dDtValid\r\n\t \tMsUnlock()\r\n  \t EndIf\r\n  EndIf\r\n  DBGoto(nRegistro)\r\nEndif\r\n\r\nIF lSD5\r\n   GravaSD5(\"SD5\",cProduto,cLocal,cLoteCtl,cNumLote,cNumSeq,cDoc,cSerie,cOp,cTm,cCliFor,cLoja,cLoteFor,nQuant,nQuant2UM,dData,dDtValid,nPotencia)\r\nEndIf\r\n*/\r\nRestArea(aArea)\r\n\r\nReturn NIL\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fGravaSBF(cTM,cProduto,cLocal,cLoteCtl,cNumLote,cNumSeq,cEndereco,nQuant,nQuant2UM)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal aAreaAnt   := GetArea()\r\nLocal aAreaSBE   := SBE->(GetArea())\r\nLocal nMultiplic := 1\r\nLocal cEstFis    := ''\r\ncNumSeq  := IF(cNumSeq  == Nil,Space(20),cNumSeq)\r\n\r\nIF !lNumLote\r\n   cNumLote := If(cNumLote == Nil,Space(06),cNumLote)\r\nElse                                        \r\n   cNumLote := Space(06)\r\nEndif   \r\n\r\nIf cTM > \"500\"\r\n   nMultiplic:=-1\r\nEndIf\r\n\r\nDBSelectArea(\"SBE\")\r\nDBSetOrder(1)\r\nIf DBSeek(xFilial('SBE')+cLocal+cEndereco, .F.)\r\n   cEstFis := SBE->BE_ESTFIS\r\nEndIf\r\n\r\nDBSelectArea(\"SBF\")\r\nDBSetOrder(6)\r\n/*\r\nIf DBSeek(xFilial(\"SBF\")+cLocal+cEndereco+cEstFis+cProduto+cNumSeq+cLoteCtl+cNumLote, .F.)\r\n   RecLock(\"SBF\",.F.)\r\nElse\r\n   RecLock(\"SBF\",.T.)\r\n   SBF->BF_FILIAL   := xFilial(\"SBF\")\r\n   SBF->BF_PRODUTO  := cProduto\r\n   SBF->BF_LOCAL    := cLocal\r\n   SBF->BF_LOCALIZ  := cEndereco\r\n   If Rastro(BF_PRODUTO,\"S\")\r\n \t  SBF->BF_NUMLOTE := cNumLote\r\n   EndIf\r\n   SBF->BF_LOTECTL  := cLoteCtl\r\n   SBF->BF_PRIOR    := If(Empty(SBE->BE_PRIOR),\"\",SBE->BE_PRIOR)\r\nEndIf\r\nSBF->BF_QUANT   := BF_QUANT   + (nQuant * nMultiplic)\r\nSBF->BF_QTSEGUM := BF_QTSEGUM + (nQuant2UM * nMultiplic)\r\nSBF->BF_ESTFIS  := cEstFis\r\nMsUnlock()\r\n\r\nIf SBF->BF_QUANT <= 0\r\n   If lDelZero \r\n      DeletSBF()\r\n   Endif\r\nElse\t\r\n    //ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Altera o Status do Endereco no SBE para Ocupado caso este possua saldo no SBF ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tDBSelectArea('SBE')\t\r\n\tDBSetOrder(1)\r\n\tIf MsSeek(xFilial('SBE')+SBF->BF_LOCAL+SBF->BF_LOCALIZ, .F.) .And. !(SBE->BE_STATUS=='2') .And. !(SBE->BE_STATUS=='3')\r\n\t   If !IsCrossDoc(SBE->BE_ESTFIS)\r\n\t\t  RecLock('SBE', .F.)\r\n\t\t  SBE->BE_STATUS := '2'\r\n\t\t  MsUnlock()\t\t\t\r\n\t   EndIf\t\r\n\tEndIf\r\nEndIf\r\n*/\r\nRestArea(aAreaSBE)\r\nRestArea(aAreaAnt)\r\nReturn Nil\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fAjustD5DB(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgDados\r\nLocal aArea   := GetArea()\r\nLocal cNumSeq := aNumSeq[oNumSeq:nAT][01]\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\naHeader := {}                                                                                                          \r\n//             X3_TITULO          , X3_CAMPO  , X3_PICTURE        ,X3_TAMANHO, X3_DECIMAL, X3_VALID, X3_USADO, X3_TIPO, X3_ARQUIVO, X3_CONTEXT\r\naadd(aHeader, {\"Origem\"           , \"ORIGEM\"  , \"@!\"              , 03       , 0         ,\"U_VldACols()\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"Data\"             , \"DATA\"    , \"99/99/99\"        , 08       , 0         ,\"\"       , \"\"      , \"D\"    , \"\"        ,,})\r\naadd(aHeader, {\"Docto.\"           , \"DOCTO\"   , \"@!\"              , 06       , 0         ,\"\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"Serie\"            , \"SERIE\"   , \"@!\"              , 03       , 0         ,\"\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"Clie.For\"         , \"CLIEFOR\" , \"@!\"              , 06       , 0         ,\"\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"Loja\"             , \"LOJA\"    , \"@!\"              , 02       , 0         ,\"\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"TES\"              , \"TES\"     , \"@!\"              , 03       , 0         ,\"U_VldACols()\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"CF\"               , \"CF\"      , \"@!\"              , 03       , 0         ,\"U_VldACols()\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"Lote\"             , \"LOTE\"    , \"@!\"              , 10       , 0         ,\"\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"Num.Lote\"         , \"NUMLOTE\" , \"@!\"              , 06       , 0         ,\"\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"Endereço\"         , \"ENDERECO\", \"@!\"              , 15       , 0         ,\"\"       , \"\"      , \"C\"    , \"\"        ,,})\r\naadd(aHeader, {\"Qtde.\"            , \"QTDE\"    , cPict             , 18       , 2         ,\"U_VldACols()\"       , \"\"      , \"N\"    , \"\"        ,,})\r\naadd(aHeader, {\"Qtde.UM2\"         , \"QTDE2UM\" , cPict2UM          , 18       , 2         ,\"U_VldACols()\"       , \"\"      , \"N\"    , \"\"        ,,})\r\n\r\naCols   := {}\r\n\r\n// SD1\r\nDBSelectArea(\"SD1\")\r\nDBSetOrder(4) //--D1_FILIAL+D1_NUMSEQ\r\nDBSeek(xFilial(\"SD1\")+cNumSeq)\r\nWhile !Eof() .AND. xFilial(\"SD1\")+cNumSeq == D1_FILIAL+D1_NUMSEQ\r\n  IF D1_COD = cProduto .AND. D1_LOCAL = cLocal\r\n     Aadd(aCols, {})\r\n     Aadd(aCols[Len(aCols)], \"SD1\"     )\r\n     Aadd(aCols[Len(aCols)], D1_DTDIGIT)\r\n     Aadd(aCols[Len(aCols)], D1_DOC    )\r\n     Aadd(aCols[Len(aCols)], D1_SERIE  )\r\n     Aadd(aCols[Len(aCols)], D1_FORNECE)\r\n     Aadd(aCols[Len(aCols)], D1_LOJA   )\r\n     Aadd(aCols[Len(aCols)], D1_TES    )\r\n     Aadd(aCols[Len(aCols)], D1_CF     )\r\n     Aadd(aCols[Len(aCols)], D1_LOTECTL)\r\n     Aadd(aCols[Len(aCols)], D1_NUMLOTE)\r\n     Aadd(aCols[Len(aCols)], Space(15) )  \r\n     Aadd(aCols[Len(aCols)], D1_QUANT  )\r\n     Aadd(aCols[Len(aCols)], D1_QTSEGUM)  \r\n     Aadd(aCols[Len(aCols)], RECNO()   )    \r\n     Aadd(aCols[Len(aCols)],.F.)\r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\n\r\n// SD2\r\nDBSelectArea(\"SD2\")\r\nDBSetOrder(4) //--D2_FILIAL+D2_NUMSEQ\r\nDBSeek(xFilial(\"SD2\")+cNumSeq)\r\nWhile !Eof() .AND. xFilial(\"SD2\")+cNumSeq == D2_FILIAL+D2_NUMSEQ\r\n  IF D2_COD = cProduto .AND. D2_LOCAL = cLocal\r\n     Aadd(aCols, {})\r\n     Aadd(aCols[Len(aCols)], \"SD2\"     )\r\n     Aadd(aCols[Len(aCols)], D2_EMISSAO)\r\n     Aadd(aCols[Len(aCols)], D2_DOC    )\r\n     Aadd(aCols[Len(aCols)], D2_SERIE  )\r\n     Aadd(aCols[Len(aCols)], D2_CLIENTE)\r\n     Aadd(aCols[Len(aCols)], D2_LOJA   )\r\n     Aadd(aCols[Len(aCols)], D2_TES    )\r\n     Aadd(aCols[Len(aCols)], D2_CF     )\r\n     Aadd(aCols[Len(aCols)], D2_LOTECTL)\r\n     Aadd(aCols[Len(aCols)], D2_NUMLOTE)\r\n     Aadd(aCols[Len(aCols)], D2_LOCALIZ)  \r\n     Aadd(aCols[Len(aCols)], D2_QUANT  )\r\n     Aadd(aCols[Len(aCols)], D2_QTSEGUM)  \r\n     Aadd(aCols[Len(aCols)], RECNO()   )    \r\n     Aadd(aCols[Len(aCols)],.F.)\r\n  Endif\r\n  DBSkip()\r\nEnddo\r\n\r\n// SD3\r\nDBSelectArea(\"SD3\")\r\nDBSetOrder(4) //--D3_FILIAL+D3_NUMSEQ+D3_CHAVE+D3_COD\r\nDBSeek(xFilial(\"SD3\")+cNumSeq)\r\nWhile !Eof() .AND. xFilial(\"SD3\")+cNumSeq == D3_FILIAL+D3_NUMSEQ\r\n  IF D3_ESTORNO <> \"S\" .AND. D3_COD = cProduto .AND. D3_LOCAL = cLocal\r\n     Aadd(aCols, {})\r\n     Aadd(aCols[Len(aCols)], \"SD3\"     )\r\n     Aadd(aCols[Len(aCols)], D3_EMISSAO)\r\n     Aadd(aCols[Len(aCols)], D3_DOC    )\r\n     Aadd(aCols[Len(aCols)], Space(03) )\r\n     Aadd(aCols[Len(aCols)], Space(06) )\r\n     Aadd(aCols[Len(aCols)], Space(02) )\r\n     Aadd(aCols[Len(aCols)], D3_TM     )\r\n     Aadd(aCols[Len(aCols)], D3_CF     )\r\n     Aadd(aCols[Len(aCols)], D3_LOTECTL)\r\n     Aadd(aCols[Len(aCols)], D3_NUMLOTE)\r\n     Aadd(aCols[Len(aCols)], D3_LOCALIZ)  \r\n     Aadd(aCols[Len(aCols)], D3_QUANT  )\r\n     Aadd(aCols[Len(aCols)], D3_QTSEGUM)  \r\n     Aadd(aCols[Len(aCols)], RECNO()   )    \r\n     Aadd(aCols[Len(aCols)],.F.)\r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\n\r\nAadd(aCols, {})\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], CTOD(\"  /  /  \"))\r\nAadd(aCols[Len(aCols)], Space(06) )\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], Space(06) )\r\nAadd(aCols[Len(aCols)], Space(02) )\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], Space(10) )\r\nAadd(aCols[Len(aCols)], Space(06) )\r\nAadd(aCols[Len(aCols)], Space(15) )  \r\nAadd(aCols[Len(aCols)], 0         )\r\nAadd(aCols[Len(aCols)], 0         )  \r\nAadd(aCols[Len(aCols)], 0         )    \r\nAadd(aCols[Len(aCols)],.F.)\r\n\r\n// SD5\r\nDBSelectArea(\"SD5\")\r\nDBSetOrder(3) //-- D5_FILIAL+D5_NUMSEQ+D5_PRODUTO+D5_LOCAL+D5_LOTECTL+D5_NUMLOTE\r\nDBSeek(xFilial(\"SD5\")+cNumSeq)\r\nWhile !Eof() .AND. xFilial(\"SD5\")+cNumSeq == D5_FILIAL+D5_NUMSEQ\r\n  IF D5_ESTORNO <> \"S\" .AND. D5_PRODUTO = cProduto .AND. D5_LOCAL = cLocal\r\n     Aadd(aCols, {})\r\n     Aadd(aCols[Len(aCols)], \"SD5\"     )\r\n     Aadd(aCols[Len(aCols)], D5_DATA   )\r\n     Aadd(aCols[Len(aCols)], D5_DOC    )\r\n     Aadd(aCols[Len(aCols)], D5_SERIE  )\r\n     Aadd(aCols[Len(aCols)], D5_CLIFOR )\r\n     Aadd(aCols[Len(aCols)], D5_LOJA   )\r\n     Aadd(aCols[Len(aCols)], D5_ORIGLAN)\r\n     Aadd(aCols[Len(aCols)], Space(03) )\r\n     Aadd(aCols[Len(aCols)], D5_LOTECTL)\r\n     Aadd(aCols[Len(aCols)], D5_NUMLOTE)\r\n     Aadd(aCols[Len(aCols)], Space(15) )  \r\n     Aadd(aCols[Len(aCols)], D5_QUANT  )\r\n     Aadd(aCols[Len(aCols)], D5_QTSEGUM)  \r\n     Aadd(aCols[Len(aCols)], RECNO()   )    \r\n     Aadd(aCols[Len(aCols)],.F.)\r\n  Endif\r\n  DBSkip()\r\nEnddo\r\n\r\nAadd(aCols, {})\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], CTOD(\"  /  /  \"))\r\nAadd(aCols[Len(aCols)], Space(06) )\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], Space(06) )\r\nAadd(aCols[Len(aCols)], Space(02) )\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], Space(10) )\r\nAadd(aCols[Len(aCols)], Space(06) )\r\nAadd(aCols[Len(aCols)], Space(15) )  \r\nAadd(aCols[Len(aCols)], 0         )\r\nAadd(aCols[Len(aCols)], 0         )  \r\nAadd(aCols[Len(aCols)], 0         )    \r\nAadd(aCols[Len(aCols)],.F.)\r\n\r\n// SDB\r\nDBSelectArea(\"SDB\")\r\nDBSetOrder(1) //--DB_FILIAL+DB_PRODUTO+DB_LOCAL+DB_NUMSEQ+DB_DOC+DB_SERIE+DB_CLIFOR+DB_LOJA+DB_ITEM\r\nDBSeek(xFilial(\"SDB\")+cProduto+cLocal+cNumSeq)\r\nWhile !Eof() .AND. xFilial(\"SDB\")+cProduto+cLocal+cNumSeq == DB_FILIAL+DB_PRODUTO+DB_LOCAL+DB_NUMSEQ\r\n  IF DB_ESTORNO <> \"S\" .AND. DB_ATUEST <> \"N\" .AND. DB_PRODUTO = cProduto .AND. DB_LOCAL = cLocal\r\n     Aadd(aCols, {})\r\n     Aadd(aCols[Len(aCols)], \"SDB\"     )\r\n     Aadd(aCols[Len(aCols)], DB_DATA   )\r\n     Aadd(aCols[Len(aCols)], DB_DOC    )\r\n     Aadd(aCols[Len(aCols)], DB_SERIE  )\r\n     Aadd(aCols[Len(aCols)], DB_CLIFOR )\r\n     Aadd(aCols[Len(aCols)], DB_LOJA   )\r\n     Aadd(aCols[Len(aCols)], DB_TM     )\r\n     Aadd(aCols[Len(aCols)], Space(03) )\r\n     Aadd(aCols[Len(aCols)], DB_LOTECTL)\r\n     Aadd(aCols[Len(aCols)], DB_NUMLOTE)\r\n     Aadd(aCols[Len(aCols)], DB_LOCALIZ)  \r\n     Aadd(aCols[Len(aCols)], DB_QUANT  )\r\n     Aadd(aCols[Len(aCols)], DB_QTSEGUM)  \r\n     Aadd(aCols[Len(aCols)], RECNO()   )    \r\n     Aadd(aCols[Len(aCols)],.F.)\r\n  Endif\r\n  DBSkip()\r\nEnddo\r\n\r\nAadd(aCols, {})\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], CTOD(\"  /  /  \"))\r\nAadd(aCols[Len(aCols)], Space(06) )\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], Space(06) )\r\nAadd(aCols[Len(aCols)], Space(02) )\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], Space(03) )\r\nAadd(aCols[Len(aCols)], Space(10) )\r\nAadd(aCols[Len(aCols)], Space(06) )\r\nAadd(aCols[Len(aCols)], Space(15) )  \r\nAadd(aCols[Len(aCols)], 0         )\r\nAadd(aCols[Len(aCols)], 0         )  \r\nAadd(aCols[Len(aCols)], 0         )    \r\nAadd(aCols[Len(aCols)],.F.)\r\n\r\n// SDA\r\nDBSelectArea(\"SDA\")\r\nDBSetOrder(1) //--DA_FILIAL+DA_PRODUTO+DA_LOCAL+DA_NUMSEQ+DA_DOC+DA_SERIE+DA_CLIFOR+DA_LOJA\r\nDBSeek(xFilial(\"SDA\")+cProduto+cLocal+cNumSeq)\r\nWhile !Eof() .AND. xFilial(\"SDA\")+cProduto+cLocal+cNumSeq == DA_FILIAL+DA_PRODUTO+DA_LOCAL+DA_NUMSEQ\r\n  IF DA_SALDO <> 0  .AND. DA_PRODUTO = cProduto .AND. DA_LOCAL = cLocal\r\n     Aadd(aCols, {})\r\n     Aadd(aCols[Len(aCols)], \"SDA\"     )\r\n     Aadd(aCols[Len(aCols)], DA_DATA   )\r\n     Aadd(aCols[Len(aCols)], DA_DOC    )\r\n     Aadd(aCols[Len(aCols)], DA_SERIE  )\r\n     Aadd(aCols[Len(aCols)], DA_CLIFOR )\r\n     Aadd(aCols[Len(aCols)], DA_LOJA   )\r\n     Aadd(aCols[Len(aCols)], DA_ORIGEM )\r\n     Aadd(aCols[Len(aCols)], Space(03) )\r\n     Aadd(aCols[Len(aCols)], DA_LOTECTL)\r\n     Aadd(aCols[Len(aCols)], DA_NUMLOTE)\r\n     Aadd(aCols[Len(aCols)], Space(15) )  \r\n     Aadd(aCols[Len(aCols)], DA_SALDO  )\r\n     Aadd(aCols[Len(aCols)], DA_QTSEGUM)  \r\n     Aadd(aCols[Len(aCols)], RECNO()   )    \r\n     Aadd(aCols[Len(aCols)],.F.)\r\n  Endif   \r\n  DBSkip()\r\nEnddo\r\n\r\n@ 010,010 To 400,820 DIALOG oDlgDados TITLE \"Alterar Dados\" \r\n@ 003,005  To 170,400 MULTILINE MODIFY DELETE \r\n@ 175,050 BUTTON \"&Confirmar\" SIZE 30,14 PIXEL ACTION (fAjusta(cOpcao),oDlgDados:End())\r\n@ 175,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgDados:End()\r\nACTIVATE DIALOG oDlgDados  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn                                  \r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nUser Function VldACols()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal cCampo  := ReadVar()\r\nLocal _Return := .T.\r\nIF cCampo $ \"M->ORIGEM/M->TES/M->CF\"\r\n   MsgStop(\"Este campo não pode ser alterado.\",\"Atenção\")\r\n   _Return := .F.\r\nElseIF cCampo == \"M->QTDE2UM\"\r\n   nQuant     := &(cCampo)\r\n   aCols[n, aScan(aHeader, {|x| Upper(AllTrim(x[2])) == \"QTDE\"})]    := ConvUM(cProduto,0,nQuant,1) // 1UM\r\nElseIF cCampo == \"M->QTDE\"\r\n   nQuant     := &(cCampo)\r\n   aCols[n, aScan(aHeader, {|x| Upper(AllTrim(x[2])) == \"QTDE2UM\"})] := ConvUM(cProduto,nQuant,0,2) // 2UM\r\nEndif      \r\nReturn (_Return)\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fPesquisa(cOpcao,oBrowse)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal oDlgPesq\r\nLocal aArea   := GetArea()\r\nLocal cCampos := Space(20)          \r\nLocal cSeek   := Space(20)   \r\nLocal aCampos := {}\r\n\r\nFor I:= 1 To Len(oBrowse:AHEADERS)\r\n   IF Valtype(oBrowse:AARRAY[1,I]) = \"C\" .AND. !UPPER(Alltrim(oBrowse:AHEADERS[I])) $ \"STATUS/TM/SERIE/LOJA/CLIE.FOR/ORIGEM\"\r\n      AAdd(aCampos,oBrowse:AHEADERS[I])\r\n   Endif   \r\nNext\r\n\r\nDBSelectArea(\"SB1\")\r\n\r\nDEFINE MSDIALOG oDlgPesq TITLE \"Pesquisar no \"+cOpcao  OF oDlgPesq PIXEL FROM 010,010 TO 150,265 \r\n\r\n@ 010,005 COMBOBOX cCampos ITEMS aCampos       SIZE 100,10 PIXEL OF oDlgPesq \r\n@ 030,005 MSGET oVar  VAR  cSeek Picture \"@!\"  SIZE 100,10 PIXEL OF oDlgPesq \r\n                                                 \r\n@ 050,050 BUTTON \"&Pesquisar\" SIZE 30,14 PIXEL ACTION (Processa({|| fPesq(cOpcao,cCampos,cSeek)}),oDlgPesq:End())\r\n@ 050,090 BUTTON \"&Sair\"      SIZE 30,14 PIXEL ACTION oDlgPesq:End()\r\n\r\nACTIVATE MSDIALOG oDlgPesq  CENTERED\r\n\r\nRestArea(aArea)\r\n\r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fPesq(cOpcao,cCampos,cSeek)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nDo Case\r\n   Case cOpcao = \"SBJ\"\r\n     nSeek := Ascan(oAnaSBJ:AHEADERS,cCampos)\r\n     IF (nPos := Ascan(aAnaSBJ, { |x| Alltrim(x[nSeek]) == Alltrim(cSeek) })) > 0\r\n       oAnaSBJ:nAT := nPos\r\n     Endif      \r\n   Case cOpcao = \"SBK\"\r\n     nSeek := Ascan(oAnaSBK:AHEADERS,cCampos)\r\n     IF (nPos := Ascan(aAnaSBK, { |x| Alltrim(x[nSeek]) == Alltrim(cSeek) })) > 0\r\n       oAnaSBK:nAT := nPos\r\n     Endif      \r\n   Case cOpcao = \"SB8\"\r\n     nSeek := Ascan(oDetSB8:AHEADERS,cCampos)\r\n     IF (nPos := Ascan(aDetSB8, { |x| Alltrim(x[nSeek]) == Alltrim(cSeek) })) > 0\r\n       oDetSB8:nAT := nPos\r\n     Endif      \r\n   Case cOpcao = \"SD5\" \r\n     nSeek := Ascan(oDetSD5:AHEADERS,cCampos)\r\n     IF (nPos := Ascan(aDetSD5, { |x| Alltrim(x[nSeek]) == Alltrim(cSeek) })) > 0\r\n       oDetSD5:nAT := nPos\r\n     Endif      \r\n   Case cOpcao = \"SBF\" \r\n     nSeek := Ascan(oDetSBF:AHEADERS,cCampos)\r\n     IF (nPos := Ascan(aDetSBF, { |x| Alltrim(x[nSeek]) == Alltrim(cSeek) })) > 0\r\n       oDetSBF:nAT := nPos\r\n     Endif      \r\n   Case cOpcao = \"SDB\" \r\n     nSeek := Ascan(oDetSDB:AHEADERS,cCampos)\r\n     IF (nPos := Ascan(aDetSDB, { |x| Alltrim(x[nSeek]) == Alltrim(cSeek) })) > 0\r\n       oDetSDB:nAT := nPos\r\n     Endif  \r\n/*   Case cOpcao = \"DOCTO\"\r\n     nSeek := Ascan(oDocto:AHEADERS,cCampos)\r\n     IF (nPos := Ascan(aDocto, { |x| Alltrim(x[nSeek]) == Alltrim(cSeek) })) > 0\r\n       oDocto:nAT := nPos\r\n     Endif      */\r\n   Case cOpcao = \"NUMSEQ\" \r\n     nSeek := Ascan(oNumSeq:AHEADERS,cCampos)\r\n     IF (nPos := Ascan(aNumSeq, { |x| Alltrim(x[nSeek]) == Alltrim(cSeek) })) > 0\r\n       oNumSeq:nAT := nPos\r\n     Endif       \r\nEndCase\r\nReturn (nPos)\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fDigSenha()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nPrivate cSenha   := Space(10)         \r\nPrivate cSenhAce := \"admin@12\"\r\n@ 067,020 To 169,312 Dialog Senhadlg Title OemToAnsi(\"Liberação de Acesso\")\r\n@ 015,005 Say OemToAnsi(\"Informe a senha para o acesso ?\") Size 80,8\r\n@ 015,089 Get cSenha Size 50,10 Password\r\n@ 037,106 BmpButton Type 1 Action fOK()\r\n@ 037,055 BmpButton Type 2 Action Close(Senhadlg)\r\nActivate Dialog Senhadlg CENTERED\r\nReturn(_lReturn)                     \r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fOK()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nIf ALLTRIM(cSenha)<> cSenhAce\r\n   MsgStop(\"Senha não Confere !!!\")\r\n   cSenha  := Space(10)\r\n   dlgRefresh(Senhadlg)\r\nElse\r\n   _lReturn  := .T.\r\n   Close(Senhadlg)\r\nEndif\r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fPesqDifLote(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal lAchou := .F.       \r\nIF cOpcao = \"Prox\"\r\n   nIni := (oKarLote:nAT + 1)\r\n   For nPos := nIni To Len(aKarLote)\r\n     IF Substr(aKarLote[nPos,10],1,10) = \"Saldo SB8:\"\r\n        lAchou := .T. \r\n        Exit\r\n     Endif\r\n   Next\r\nElseIF cOpcao = \"Ante\"\r\n   nIni := (oKarLote:nAT - 1)\r\n   For nPos := nIni To 1 STEP -1\r\n    IF Substr(aKarLote[nPos,10],1,10) = \"Saldo SB8:\"\r\n       lAchou := .T. \r\n       Exit\r\n    Endif\r\n   Next\r\nEndif  \r\nIF lAchou \r\n   oKarLote:nAT := nPos\r\nElse\r\n   MsgAlert(\"Não Existe Diferença !\")\r\nEndif   \r\n\r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fPesqDifEnde(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nLocal lAchou := .F.       \r\nIF cOpcao = \"Prox\"\r\n   nIni := (oKarEnde:nAT + 1)\r\n   For nPos := nIni To Len(aKarEnde)\r\n     IF Substr(aKarEnde[nPos,09],1,10) = \"Saldo SBF:\"\r\n        lAchou := .T. \r\n        Exit\r\n     Endif\r\n   Next\r\nElseIF cOpcao = \"Ante\"\r\n   nIni := (oKarEnde:nAT - 1)\r\n   For nPos := nIni To 1 STEP -1\r\n    IF Substr(aKarEnde[nPos,09],1,10) = \"Saldo SBF:\"\r\n       lAchou := .T. \r\n       Exit\r\n    Endif\r\n   Next\r\nEndif  \r\nIF lAchou \r\n   oKarEnde:nAT := nPos\r\nElse\r\n   MsgAlert(\"Não Existe Diferença !\")\r\nEndif   \r\nReturn  \r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fPesqNumSeq(cOpcao)\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nDo Case\r\n  Case cOpcao = \"Lote\"\r\n    cNumSeq :=  aKarLote[oKarLote:nAT,10]\r\n    IF fPesq(\"NUMSEQ\",\"Num.Seq.\",cNumSeq) > 0\r\n       oFolder:nOption := 12\r\n       oNumSeq:Refresh()\r\n    Endif   \r\n  Case cOpcao = \"Ende\"\r\n    cNumSeq :=  aKarEnde[oKarEnde:nAT,09]\r\n    IF fPesq(\"NUMSEQ\",\"Num.Seq.\",cNumSeq) > 0\r\n       oFolder:nOption := 12\r\n       oNumSeq:Refresh()\r\n    Endif   \r\nEndCase    \r\nReturn\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fPesqKarEnd()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\ncNumSeq := aNumSeq[oNumSeq:nAT,01]\r\nnSeek   := Ascan(oKarEnde:AHEADERS,\"Num.Seq.\")\r\nIF (nPos := Ascan(aKarEnde, { |x| Alltrim(x[nSeek]) == Alltrim(cNumSeq) })) > 0\r\n   oKarEnde:nAT := nPos\r\n   oFolder:nOption := 11\r\n   oKarEnde:Refresh()\r\nEndif       \r\nReturn\r\n\r\n\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nStatic Function fSaldoAtual()\r\n//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////\r\nDBSelectArea(\"SX1\")\r\nDBSetOrder(1)\r\n/*\r\nIf DbSeek(\"MTA30001\")\r\n   RecLock(\"SX1\",.F.)\r\n   SX1->X1_CNT01 := cLocal\r\n   MsUnlock()\r\nEndif\r\nIf DbSeek(\"MTA30002\")\r\n   RecLock(\"SX1\",.F.)\r\n   SX1->X1_CNT01 := cLocal\r\n   MsUnlock()\r\nEndif\r\nIf DbSeek(\"MTA30003\")\r\n   RecLock(\"SX1\",.F.)\r\n   SX1->X1_CNT01 := cProduto\r\n   MsUnlock()\r\nEndif\r\nIf DbSeek(\"MTA30004\")\r\n   RecLock(\"SX1\",.F.)\r\n   SX1->X1_CNT01 := cProduto\r\n   MsUnlock()\r\nEndif\r\n                             \r\nMATA300(.T.,{{.T.,cFilant}}) \r\n\r\nProcessa({||fProcessa()})\r\n*/\r\nReturn\r\n/*\r\n5.2\r\nInclusao da alteracao no SDA\r\n5.3\r\nCorrecao do erro na confirmacao da alteracao da pasta numseq\r\n5.4\r\nAlteracao para contemplar o parametro MV_LOTEUNI\r\n5.5\r\nCorreção para validar movimentacao de SB2 e SBF e algums melhorias de pesquisa entre a pasta de kardex por endereco e a pasta numseq\r\n5.6\r\nCorreção na composicao de saldo na pasta SBFXSDB e SB8xSD5\r\nRotina de Saldo Atual no programa\r\n12/06/2008\r\nCorreção na composição do saldo do kardex por endereco\r\nAjusta para compor o saldo do lote.\r\nMelhoria para zerar os browse na troca de produto\r\n25/03/2009\r\nMelhoria na incluscao do SD5 e SDB na pasta NumSeq\r\nCorrecao do problema quando ao clicar no movimento do kardex por endereco ou lote ele nao esta direcionando para pasta numseq.\r\n14/04/2009\r\nMelhoria na incluscao do SD5 e SDB na pasta NumSeq.\r\nDocumentacao das matrizes.\r\n04/05/2009\r\nCorrigido erro da matriz aNumSeq\r\n25/06/2009\r\nVerificacao se quando utilizar o DBgoto é fim de arquivo.\r\n*/"}}}
Content-Length: 166
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/analise.prw"}}}
Content-Length: 243727
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/Matr910.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"MATR910.CH\"\r\n#INCLUDE \"PROTHEUS.CH\"\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ MATR910  ³ Autor ³ Nereu Humberto Junior ³ Data ³ 11.07.06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Kardex fisico - financeiro                                 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Generico                                                   ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nUser Function Matr910()\r\n\tLocal oReport\r\n\r\n\t//If FindFunction(\"TRepInUse\") .And. TRepInUse()\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Interface de impressao                                                  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t//\toReport:= ReportDef()\r\n\t//\toReport:PrintDialog()\r\n\t//Else\r\n\tMATR910R3()\r\n\t//EndIf\r\n\r\nReturn\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³ReportDef ³ Autor ³Nereu Humberto Junior  ³ Data ³11.07.2006³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³A funcao estatica ReportDef devera ser criada para todos os ³±±\r\n±±³          ³relatorios que poderao ser agendados pelo usuario.          ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³ExpO1: Objeto do relatório                                  ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³Nenhum                                                      ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ReportDef()\r\n\r\n\tLocal oReport \r\n\tLocal oSection1\r\n\tLocal oSection2\r\n\tLocal oSection3\r\n\tLocal oCell         \r\n\tLocal aOrdem    := {}\r\n\tLocal aSB1Cod   := {}\r\n\tLocal aSB1Ite   := {}\r\n\tLocal cPicB2Qt  := PesqPictQt(\"B2_QATU\" ,18)\r\n\tLocal cTamB2Qt  := TamSX3('B2_QATU')[1]\r\n\tLocal cPicB2Cust:= PesqPict(\"SB2\",\"B2_CM1\",18)\r\n\tLocal cTamB2Cust:= TamSX3('B2_CM1')[1]\r\n\tLocal cPicD1Qt  := PesqPict(\"SD1\",\"D1_QUANT\" ,18)\r\n\tLocal cTamD1Qt  := TamSX3('D1_QUANT')[1]\r\n\tLocal cPicD1Cust:= PesqPict(\"SD1\",\"D1_CUSTO\",18)\r\n\tLocal cTamD1Cust:= TamSX3('D1_CUSTO')[1]\r\n\tLocal cPicD2Qt  := PesqPict(\"SD2\",\"D2_QUANT\" ,18)\r\n\tLocal cTamD2Qt  := TamSX3('D2_QUANT')[1]\r\n\tLOCAL cPicD2Cust:= PesqPict(\"SD2\",\"D2_CUSTO1\",18)\r\n\tLocal cTamD2Cust:= TamSX3('D2_CUSTO1')[1]\r\n\tLocal lVEIC \t:= UPPER(GETMV(\"MV_VEICULO\"))==\"S\"\r\n\tLocal nTamSX1 \t:= Len(SX1->X1_GRUPO)\r\n\tLocal cTamD1CF  := TamSX3('D1_CF')[1]\r\n\tLocal nTamData \t:= IIF(__SetCentury(),10,8)\r\n\tLocal lVer116   := (VAL(GetVersao(.F.)) == 11 .And. GetRpoRelease() >= \"R6\" .Or. VAL(GetVersao(.F.))  > 11)\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Verifica se utiliza custo unificado por Empresa/Filial       ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLocal lCusUnif := IIf(FindFunction(\"A330CusFil\"),A330CusFil(),GetMV(\"MV_CUSFIL\",.F.))\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Ajusta perguntas no SX1 a fim de preparar o relatorio p/     ³\r\n\t//³ custo unificado por empresa                                  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf lCusUnif\r\n\t\tMTR910CUnf(lCusUnif)\r\n\tEndIf\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Ajusta perguntas no SX1 \t\t\t\t\t\t\t\t\t ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tAjustaSX1()\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Remove grupo de perguntas incluido                           ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tdbSelectArea(\"SX1\")\r\n\tdbSetOrder(1)\r\n\tIf dbSeek(PADR(\"MTR910\",nTamSX1)+\"22\")\r\n\t\tRecLock(\"SX1\",.F.)\r\n\t\tdbDelete()\r\n\t\tMsUnlock()\r\n\tEndIf\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Ajustar o SX1 para SIGAVEI, SIGAPEC e SIGAOFI                ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\taSB1Cod\t:= TAMSX3(\"B1_COD\")\r\n\taSB1Ite\t:= TAMSX3(\"B1_CODITE\")\r\n\r\n\tIf lVEIC\r\n\r\n\t\tdbSelectArea(\"SX1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(PADR(\"MTR910\",nTamSX1))\r\n\t\tDo While SX1->X1_GRUPO == PADR(\"MTR910\",nTamSX1) .And. !SX1->(Eof())\r\n\t\t\tIf \"PRODU\" $ Upper(SX1->X1_PERGUNT) .And. Upper(SX1->X1_TIPO) == \"C\" .And. ;\r\n\t\t\t(SX1->X1_TAMANHO <> aSB1Ite[1] .Or. Upper(SX1->X1_F3) <> \"VR4\")\r\n\r\n\t\t\t\tRecLock(\"SX1\",.F.)\r\n\t\t\t\tSX1->X1_TAMANHO := aSB1Ite[1]\r\n\t\t\t\tSX1->X1_F3 := \"VR4\"\r\n\t\t\t\tdbCommit()\r\n\t\t\t\tmsUnLock()\r\n\t\t\tEndIf\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\t\tdbCommitAll()\r\n\tElse\r\n\t\tdbSelectArea(\"SX1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(PADR(\"MTR910\",nTamSX1))\r\n\t\tDo While SX1->X1_GRUPO == PADR(\"MTR910\",nTamSX1) .And. !SX1->(Eof())\r\n\t\t\tIf \"PRODU\" $ Upper(SX1->X1_PERGUNT) .And. Upper(SX1->X1_TIPO) == \"C\" .And. ;\r\n\t\t\t(SX1->X1_TAMANHO <> aSB1Cod[1] .Or. Upper(SX1->X1_F3) <> \"SB1\")\r\n\r\n\t\t\t\tRecLock(\"SX1\",.F.)\r\n\t\t\t\tSX1->X1_TAMANHO := aSB1Cod[1]\r\n\t\t\t\tSX1->X1_F3 := \"SB1\"\r\n\t\t\t\tdbCommit()\r\n\t\t\t\tmsUnLock()\r\n\t\t\tEndIf\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\t\tdbCommitAll()\r\n\tEndIf\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Criacao do componente de impressao                                      ³\r\n\t//³                                                                        ³\r\n\t//³TReport():New                                                           ³\r\n\t//³ExpC1 : Nome do relatorio                                               ³\r\n\t//³ExpC2 : Titulo                                                          ³\r\n\t//³ExpC3 : Pergunte                                                        ³\r\n\t//³ExpB4 : Bloco de codigo que sera executado na confirmacao da impressao  ³\r\n\t//³ExpC5 : Descricao                                                       ³\r\n\t//³                                                                        ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\toReport:= TReport():New(\"MATR910\",STR0003,\"MTR910\", {|oReport| ReportPrint(oReport,oSection1)},STR0001+\" \"+STR0002) //\"Kardex Fisico-Financeiro (DIA)\"##\"Este programa emitir  uma rela‡„o com as movimenta‡”es\"##\"dos produtos Selecionados,Ordenados por Dia.\"\r\n\toReport:SetLandscape()    \r\n\toReport:SetTotalInLine(.F.)\r\n\r\n\tPergunte(\"MTR910\",.F.)\r\n\r\n\tAadd( aOrdem, STR0004 ) // \" Codigo Produto \"\r\n\tAadd( aOrdem, STR0005 ) // \" Tipo do Produto\"\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Definicao da Secao 1 - Dados do Produto                      ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\toSection1 := TRSection():New(oReport,STR0062,{\"SB1\",\"SB2\"},aOrdem) //\"Produto (Parte 1)\"\r\n\toSection1 :SetTotalInLine(.F.)\r\n\toSection1 :SetReadOnly()\r\n\toSection1 :SetLineStyle()\r\n\r\n\tIf lVeic\r\n\t\tTRCell():New(oSection1,\"B1_CODITE\",\"SB1\",/*Titulo*/,/*Picture*/,/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tEndif\r\n\tTRCell():New(oSection1,\"cProduto\",\"   \",/*Titulo*/,/*Picture*/,/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\toSection1:Cell(\"cProduto\"):GetFieldInfo(\"B1_COD\")\r\n\tTRCell():New(oSection1,\"B1_DESC\",\"SB1\",/*Titulo*/,/*Picture*/,30,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection1,\"B1_UM\",\"SB1\",STR0056,/*Picture*/,/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection1,\"cTipo\",\"   \",STR0057,\"@!\",2,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection1,\"B1_GRUPO\",\"SB1\",STR0058,/*Picture*/,/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection1,\"nCusMed\",\"   \",STR0059,cPicB2Cust,cTamB2Cust,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection1,\"nQtdSal\",\"   \",STR0054,cPicB2Qt,cTamB2Qt,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection1,\"nVlrSal\",\"   \",STR0055,cPicB2Cust,cTamB2Cust,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Definicao da Secao 2 - Cont. dos dados do Produto            ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\toSection2 := TRSection():New(oSection1,STR0063,{\"SB1\",\"SB2\",\"NNR\"}) //\"Produto (Parte 2)\"\r\n\toSection2 :SetTotalInLine(.F.)\r\n\toSection2 :SetReadOnly()\r\n\toSection2 :SetLineStyle()\r\n\r\n\tIf lVeic\r\n\t\tTRCell():New(oSection2,\"cProduto\",\"   \",/*Titulo*/,/*Picture*/,/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\t\toSection2:Cell(\"cProduto\"):GetFieldInfo(\"B1_COD\")\r\n\t\tTRCell():New(oSection2,\"B1_UM\",\"SB1\",STR0056,/*Picture*/,/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\t\tTRCell():New(oSection2,\"cTipo\",\"   \",STR0057,\"@!\",2,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\t\tTRCell():New(oSection2,\"B1_GRUPO\",\"SB1\",STR0058,/*Picture*/,/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tEndif\t\r\n\tIf cPaisLoc<>\"CHI\"\r\n\t\tTRCell():New(oSection2,\"B1_POSIPI\",\"SB1\",STR0060,/*Picture*/,/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tEndif\t\r\n\r\n\tIf lVer116\r\n\t\tTRCell():New(oSection2,\"NNR_DESCRI\",\"NNR\",STR0061,/*Picture*/,/*Tamanho*/,/*lPixel*/, {|| If(lCusUnif , MV_PAR08 , Posicione(\"NNR\",1,xFilial(\"NNR\")+MV_PAR08,\"NNR_DESCRI\")) })\r\n\tElse\r\n\t\tTRCell():New(oSection2,\"B2_LOCALIZ\",\"SB2\",STR0061,/*Picture*/,/*Tamanho*/,/*lPixel*/, {|| If(lCusUnif , MV_PAR08 , SB2->B2_LOCALIZ) })\r\n\tEndIf\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Definicao da Secao 3 - Movimentos                            ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\toSection3 := TRSection():New(oSection2,STR0064,{\"SD1\",\"SD2\",\"SD3\"}) //\"Movimentação dos Produtos\"\r\n\toSection3 :SetHeaderPage()\r\n\toSection3 :SetTotalInLine(.F.)\r\n\toSection3 :SetTotalText(STR0017) //\"T O T A I S  :\"\r\n\toSection3 :SetReadOnly()\r\n\r\n\tTRCell():New(oSection3,\"dDtMov\",\"   \",STR0038+CRLF+STR0039,/*Picture*/,nTamData,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"cTES\",\"   \",STR0040,\"@!\",/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"cCF\",\"   \",STR0041,\"@!\",cTamD1CF,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"cDoc\",\"   \",STR0042+CRLF+STR0043,\"@!\",/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"nENTQtd\",\"   \",STR0044+CRLF+STR0045,cPicD1Qt,cTamD1Qt,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"nENTCus\",\"   \",STR0044+CRLF+STR0046,cPicD1Cust,cTamD1Cust,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"nCusMov\",\"   \",STR0047+CRLF+STR0048,cPicB2Cust,cTamB2Cust,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"nSAIQtd\",\"   \",STR0049+CRLF+STR0045,cPicD2Qt,cTamD2Qt,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"nSAICus\",\"   \",STR0049+CRLF+STR0046,cPicD2Cust,cTamD2Cust,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"nSALDQtd\",\"   \",STR0050+CRLF+STR0045,cPicB2Qt,cTamB2Qt,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"nSALDCus\",\"   \",STR0050+CRLF+STR0051,cPicB2Cust,cTamB2Cust,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\tTRCell():New(oSection3,\"cCCPVPJOP\",\"   \",STR0052+CRLF+STR0053,\"@!\",/*Tamanho*/,/*lPixel*/,/*{|| code-block de impressao }*/)\r\n\r\n\t// Definir o formato de valores negativos (para o caso de devolucoes)\r\n\toSection3:Cell(\"nENTQtd\"):SetNegative(\"PARENTHESES\")\r\n\toSection3:Cell(\"nENTCus\"):SetNegative(\"PARENTHESES\")\r\n\toSection3:Cell(\"nSAIQtd\"):SetNegative(\"PARENTHESES\")\r\n\toSection3:Cell(\"nSAICus\"):SetNegative(\"PARENTHESES\")\r\n\r\n\tTRFunction():New(oSection3:Cell(\"nENTQtd\")\t,NIL,\"SUM\"\t\t,/*oBreak*/,\"\",cPicD1Qt\t\t,{|| oSection3:Cell(\"nENTQtd\"):GetValue(.T.) },.T.,.F.) \r\n\tTRFunction():New(oSection3:Cell(\"nENTCus\")\t,NIL,\"SUM\"\t\t,/*oBreak*/,\"\",cPicD1Cust\t,{|| oSection3:Cell(\"nENTCus\"):GetValue(.T.) },.T.,.F.) \r\n\r\n\tTRFunction():New(oSection3:Cell(\"nSAIQtd\")\t,NIL,\"SUM\"\t\t,/*oBreak*/,\"\",cPicD2Qt\t\t,{|| oSection3:Cell(\"nSAIQtd\"):GetValue(.T.) },.T.,.F.) \r\n\tTRFunction():New(oSection3:Cell(\"nSAICus\")\t,NIL,\"SUM\"\t\t,/*oBreak*/,\"\",cPicD2Cust\t,{|| oSection3:Cell(\"nSAICus\"):GetValue(.T.) },.T.,.F.) \r\n\r\n\tTRFunction():New(oSection3:Cell(\"nSALDQtd\")\t,NIL,\"ONPRINT\"\t,/*oBreak*/,\"\",cPicB2Qt\t\t,{|| oSection3:Cell(\"nSALDQtd\"):GetValue(.T.) },.T.,.F.) \r\n\tTRFunction():New(oSection3:Cell(\"nSALDCus\")\t,NIL,\"ONPRINT\"\t,/*oBreak*/,\"\",cPicB2Cust\t,{|| oSection3:Cell(\"nSALDCus\"):GetValue(.T.) },.T.,.F.) \r\n\r\n\toSection3:SetNoFilter(\"SD1\")\r\n\toSection3:SetNoFilter(\"SD2\")\r\n\toSection3:SetNoFilter(\"SD3\")\r\nReturn(oReport)\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³ReportPrin³ Autor ³Nereu Humberto Junior  ³ Data ³21.06.2006³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³A funcao estatica ReportDef devera ser criada para todos os ³±±\r\n±±³          ³relatorios que poderao ser agendados pelo usuario.          ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³Nenhum                                                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ExpO1: Objeto Report do Relatório                           ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ReportPrint(oReport,oSection)\r\n\r\n\tStatic lIxbConTes := NIL\r\n\tLocal oSection1:= oReport:Section(1) \r\n\tLocal oSection2:= oReport:Section(1):Section(1)  \r\n\tLocal oSection3:= oReport:Section(1):Section(1):Section(1)  \r\n\tLocal nOrdem   := oReport:Section(1):GetOrder() \r\n\tLocal cSelectD1 := '', cWhereD1 := ''\r\n\tLocal cSelectD2 := '', cWhereD2 := ''\r\n\tLocal cSelectD3 := '', cWhereD3 := ''\r\n\tLocal cSelectVe := '', cUnion := '%%'\r\n\tLocal aDadosTran:={},lContinua := .F.\r\n\tLocal cProdAnt  := \"\"\r\n\tLocal cLocalAnt := \"\"\r\n\tLocal nCusMed   := 0\r\n\tLocal lFirst1   := .T.\r\n\tLocal aSalAtu   := { 0,0,0,0,0,0,0 }\r\n\tLocal aSalAlmox := {}\r\n\tLocal nGEntrada := 0, nGSaida :=0\r\n\tLocal nRec1,nRec2,nRec3,nSavRec,dCntData\r\n\tLocal cPicB2Cust:= PesqPict(\"SB2\",\"B2_CM\"+Str(mv_par11,1),18)\r\n\tLocal cPicD1Cust:= PesqPict(\"SD1\",\"D1_CUSTO\"+IIF(mv_par11 == 1 ,\"\",Str(mv_par11,1)),18)\r\n\tLocal cPicD2Cust:= PesqPict(\"SD2\",\"D2_CUSTO\"+Str(mv_par11,1),18)\r\n\tLocal cPicB2Qt  := PesqPictQt(\"B2_QATU\" ,18)\r\n\tLocal cPicB2Qt2 := PesqPictQt(\"B2_QTSEGUM\" ,18)\r\n\tLocal cCusto, lImpLivro, lImpTermos, cCond1, cCond2\r\n\tLocal nAcho,i,aGrupos:={},cAlias\r\n\tLocal cTRBSD1\t:= CriaTrab(,.f.)\r\n\tLocal cTRBSD2\t:= Subs(cTrbSD1,1,7)+\"A\"\r\n\tLocal cTRBSD3\t:= Subs(cTrbSD1,1,7)+\"B\"\r\n\tLocal nInd,cIndice\t:=\"\",cCampo1,cCampo2,cCampo3,cCampo4\r\n\tLocal cNumSeqTr := \"\" , nRegTr := 0\r\n\tLocal cSeqIni \t:= Replicate(\"z\",6)\r\n\tLocal nTotRegs  := 0\r\n\tLocal nTamSX1 := Len(SX1->X1_GRUPO)\r\n\t// Indica se esta listando relatorio do almox. de processo\r\n\tLocal lLocProc:= mv_par08 == GetMv(\"MV_LOCPROC\")\r\n\t// Indica se deve imprimir movimento invertido (almox. de processo)\r\n\tLocal lInverteMov :=.F.\r\n\tLocal lPriApropri :=.T.\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Verifica se existe ponto de entrada                          ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLocal lTesNEst := .F.\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Codigo do produto importado - NAO DEVE SER LISTADO           ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLocal cProdImp := GETMV(\"MV_PRODIMP\")\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis tipo Local para SIGAVEI, SIGAPEC e SIGAOFI         ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLocal cArq1 := \"\"\r\n\tLocal nInd1 := 0\r\n\r\n\tLocal nRecTrf1 := 0\r\n\tLocal nRecTrf2 := 0\r\n\tLocal aRecTRF  := {}\r\n\r\n\tLocal cWhereB1A:= \" \" \r\n\tLocal cWhereB1B:= \" \" \r\n\tLocal cWhereB1C:= \" \" \r\n\tLocal cWhereB1D:= \" \" \r\n\r\n\tLocal cQueryB1A:= \" \" \r\n\tLocal cQueryB1B:= \" \" \r\n\tLocal cQueryB1C:= \" \" \r\n\tLocal cQueryB1D:= \" \" \r\n\tLocal bBloco  := { |nV,nX| Trim(nV)+IIf(Valtype(nX)='C',\"\",Str(nX,1)) }\r\n\tLocal lVEIC := UPPER(GETMV(\"MV_VEICULO\"))==\"S\"\r\n\tLocal lImpSMov := .F.\r\n\tLocal lImpS3   := .F.\r\n\tLocal cFilUser := oSection:GetAdvplExp()\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variavel utilizada para inicar a pagina do relatorio³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLocal n_pag     := mv_par12   \r\n\t#IFNDEF TOP\r\n\tLocal cCondicao := \"\"\r\n\t#ELSE\r\n\tLocal cAliasTop := \"\"\r\n\t#ENDIF\r\n\r\n\tLocal cProdMNT := GetMv(\"MV_PRODMNT\")\r\n\tLocal cProdTER := GetMv(\"MV_PRODTER\")\r\n\tLocal aProdsMNT := {}\r\n\tLocal nX\r\n\r\n\tcProdMNT := cProdMNT + Space(15-Len(cProdMNT))\r\n\tcProdTER := cProdTER  + Space(15-Len(cProdTER))\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Verifica se utiliza custo unificado por Empresa/Filial       ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tPrivate lCusUnif := IIf(FindFunction(\"A330CusFil\"),A330CusFil(),GetMV(\"MV_CUSFIL\",.F.))\r\n\tlCusUnif:=lCusUnif .And. mv_par08 == Repl(\"*\",TamSX3(\"B2_LOCAL\")[1])\r\n\tPrivate lDev := .F. // Flag que indica se nota ‚ devolu‡ao (.T.) ou nao (.F.)\r\n\tPrivate aDriver := ReadDriver()\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Impressao de Termo / Livro                                   ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tDo Case\r\n\t\tCase mv_par15==1 ; lImpLivro:=.t. ; lImpTermos:=.f.\r\n\t\tCase mv_par15==2 ; lImpLivro:=.t. ; lImpTermos:=.t.\r\n\t\tCase mv_par15==3 ; lImpLivro:=.f. ; lImpTermos:=.t.\r\n\tEndCase\r\n\toReport:SetPageNumber(n_pag)     \r\n\toReport:SetTitle(STR0013+mv_par08)\r\n\tIf nOrdem == 1\r\n\t\toReport:SetTitle( oReport:Title()+Alltrim(STR0014+STR0004+STR0015+AllTrim(GetMv(\"MV_SIMB\"+Ltrim(Str(mv_par11))))+\")\"))\r\n\tElse\r\n\t\toReport:SetTitle( oReport:Title()+Alltrim(STR0014+STR0005+STR0015+AllTrim(GetMv(\"MV_SIMB\"+Ltrim(Str(mv_par11))))+\")\"))\t\r\n\tEndif\t\r\n\toReport:SetTitle( oReport:Title()+AllTrim(IIf(mv_par16==1,OemToAnsi(STR0030),OemToAnsi(STR0031))))\r\n\r\n\tIf lVeic\r\n\t\toSection1:Cell(\"cProduto\"):Disable()\r\n\t\toSection1:Cell(\"B1_UM\"):Disable()\r\n\t\toSection1:Cell(\"cTipo\"):Disable()\r\n\t\toSection1:Cell(\"B1_GRUPO\"):Disable()\r\n\tEndif\r\n\r\n\tdbSelectArea(\"SD1\")   // Itens de Entrada\r\n\tnTotRegs += LastRec()\r\n\r\n\tdbSelectArea(\"SD2\")   // Itens de Saida\r\n\tnTotRegs += LastRec()\r\n\r\n\tdbSelectArea(\"SD3\")   // movimentacoes internas (producao/requisicao/devolucao)\r\n\tnTotRegs += LastRec()\r\n\r\n\tdbSelectArea(\"SB2\")  // Saldos em estoque\r\n\tdbSetOrder(1)\r\n\tnTotRegs += LastRec()\r\n\r\n\tlIxbConTes := IF(lIxbConTes == NIL,ExistBlock(\"MTAAVLTES\"),lIxbConTes)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Filtragem do relatório                                                  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t#IFDEF TOP\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Transforma parametros Range em expressao SQL                            ³\t\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tMakeSqlExpr(oReport:uParam)\r\n\r\n\tcAliasTop := GetNextAlias()    \r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Query do relatório da secao 1                                           ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\toReport:Section(1):BeginQuery()\t\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Complemento do SELECT da tabela SD1                                     ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tcSelectD1 := \"% D1_CUSTO\"\r\n\tIf mv_par11 > 1\r\n\t\tcSelectD1 += Str(mv_par11,1,0) // Coloca a Moeda do Custo\r\n\tEndIf\r\n\tcSelectD1 += \" CUSTO,\"\r\n\tcSelectD1 += \"%\"\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Complemento do SELECT da tabela SB1 para MV_VEICULO                     ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\tcSelectVe := \"%\" \r\n\tcSelectVe += \",\"\r\n\tIF lVEIC\r\n\t\tcSelectVe += \"SB1.B1_CODITE B1_CODITE,\"\t\r\n\tENDIF\r\n\tcSelectVe += \"%\" \r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Complemento do Where da tabela SD1                                      ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\tcWhereD1 := \"%\" \r\n\tcWhereD1 += \"AND\" \r\n\tIf !lCusUnif\r\n\t\tcWhereD1 += \" D1_LOCAL = '\" + mv_par08 + \"' AND\"\r\n\tEndIf\r\n\tcWhereD1 += \"%\" \r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Complemento do SELECT da tabela SD2                                     ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tcSelectD2 := \"% D2_CUSTO\"\r\n\tcSelectD2 += Str(mv_par11,1,0) // Coloca a Moeda do Custo\r\n\tcSelectD2 += \" CUSTO,\"\r\n\tcSelectD2 += \"%\"\t\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Complemento do Where da tabela SD1                                      ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\tcWhereD2 := \"%\" \r\n\tcWhereD2 += \"AND\" \r\n\tIf !lCusUnif\r\n\t\tcWhereD2 += \" D2_LOCAL = '\" + mv_par08 + \"' AND\"\r\n\tEndIf\r\n\tcWhereD2 += \"%\"    \r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Complemento do SELECT da tabelas SD3                                    ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tcSelectD3 := \"% D3_CUSTO\"\r\n\tcSelectD3 += Str(mv_par11,1,0) // Coloca a Moeda do Custo\r\n\tcSelectD3 +=\t\" CUSTO,\" \r\n\tcSelectD3 += \"%\"    \r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Complemento do WHERE da tabela SD3                                      ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tcWhereD3 := \"%\"\r\n\tIf SuperGetMV('MV_D3ESTOR', .F., 'N') == 'N'\r\n\t\tcWhereD3 += \" D3_ESTORNO <> 'S' AND\"\r\n\tEndIf\r\n\tIf SuperGetMV('MV_D3SERVI', .F., 'N') == 'N' .And. IntDL()\r\n\t\tcWhereD3 += \" ( (D3_SERVIC = '   ') OR (D3_SERVIC <> '   ' AND D3_TM <= '500')  \"\r\n\t\tcWhereD3 += \" OR  (D3_SERVIC <> '   ' AND D3_TM > '500' AND D3_LOCAL ='\"+SuperGetMV('MV_CQ', .F., '98')+\"') ) AND\"\r\n\tEndIf\r\n\tIf !lCusUnif .And. !lLocProc\r\n\t\tcWhereD3 += \" D3_LOCAL = '\"+mv_par08+\"' AND\" \r\n\tEndIf\r\n\tIf\t!lVEIC\r\n\t\tcWhereD3+= \" SB1.B1_COD >= '\"+mv_par01+\"' AND SB1.B1_COD <= '\"+mv_par02+\"' AND\"\r\n\tElse\r\n\t\tcWhereD3+= \" SB1.B1_CODITE >= '\"+mv_par01+\"' AND SB1.B1_CODITE <= '\"+mv_par02+\"' AND\"\r\n\tEndIf\t\r\n\tcWhereD3 += \" SB1.B1_FILIAL = '\"+xFilial(\"SB1\")+\"' AND SB1.B1_TIPO >= '\"+mv_par03+\"' AND SB1.B1_TIPO <= '\"+mv_par04+\"' AND\"\r\n\tcWhereD3 += \" SB1.B1_GRUPO >= '\"+mv_par18+\"' AND SB1.B1_GRUPO <= '\"+mv_par19+\"' AND SB1.B1_COD <> '\"+cProdimp+\"' AND \"\r\n\tcWhereD3 += \" SB1.D_E_L_E_T_=' ' AND\"\r\n\tcWhereD3 += \"%\"\t\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Complemento do WHERE da tabela SB1 para todos os selects                ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tcWhereB1A:= \"%\" \r\n\tcWhereB1B:= \"%\" \r\n\tcWhereB1C:= \"%\" \r\n\tcWhereB1D:= \"%\" \t\r\n\tIf\t!lVEIC\r\n\t\tcWhereB1A+= \" AND SB1.B1_COD >= '\"+mv_par01+\"' AND SB1.B1_COD <= '\"+mv_par02+\"'\"\r\n\t\tcWhereB1B+= \" AND SB1.B1_COD = SB1EXS.B1_COD\"\r\n\t\tcWhereB1C+= \" SB1.B1_FILIAL = '\"+xFilial(\"SB1\")+\"' AND SB1.B1_TIPO >= '\"+mv_par03+\"' AND SB1.B1_TIPO <= '\"+mv_par04+\"' AND\"\r\n\t\tcWhereB1D+= \" SB1EXS.B1_FILIAL = '\"+xFilial(\"SB1\")+\"' AND SB1EXS.B1_COD >= '\"+mv_par01+\"' AND SB1EXS.B1_COD <= '\"+mv_par02+\"' AND SB1EXS.B1_TIPO >= '\"+mv_par03+\"' AND SB1EXS.B1_TIPO <= '\"+mv_par04+\"' AND\"\r\n\tElse\r\n\t\tcWhereB1A+= \" AND SB1.B1_CODITE >= '\"+mv_par01+\"' AND SB1.B1_CODITE <= '\"+mv_par02+\"'\"\r\n\t\tcWhereB1B+= \" AND SB1.B1_COD = SB1EXS.B1_COD\"\r\n\t\tcWhereB1C+= \" SB1.B1_FILIAL = '\"+xFilial(\"SB1\")+\"' AND SB1.B1_TIPO >= '\"+mv_par03+\"' AND SB1.B1_TIPO <= '\"+mv_par04+\"' AND\"\r\n\t\tcWhereB1D+= \" SB1EXS.B1_FILIAL = '\"+xFilial(\"SB1\")+\"' AND SB1EXS.B1_CODITE >= '\"+mv_par01+\"' AND SB1EXS.B1_CODITE <= '\"+mv_par02+\"' AND SB1EXS.B1_TIPO >= '\"+mv_par03+\"' AND SB1EXS.B1_TIPO <= '\"+mv_par04+\"' AND\"\r\n\tEndIf\t\r\n\tcWhereB1C += \" SB1.B1_GRUPO >= '\"+mv_par18+\"' AND SB1.B1_GRUPO <= '\"+mv_par19+\"' AND SB1.B1_COD <> '\"+cProdimp+\"' AND \"\r\n\tcWhereB1C += \" SB1.D_E_L_E_T_=' '\"\r\n\tcWhereB1D += \" SB1EXS.B1_GRUPO >= '\"+mv_par18+\"' AND SB1EXS.B1_GRUPO <= '\"+mv_par19+\"' AND SB1EXS.B1_COD <> '\"+cProdimp+\"' AND \"\r\n\tcWhereB1D += \" SB1EXS.D_E_L_E_T_=' '\"\t\r\n\r\n\tcQueryB1A:= Subs(cWhereB1A,2)\r\n\tcQueryB1B:= Subs(cWhereB1B,2)\r\n\tcQueryB1C:= Subs(cWhereB1C,2)\r\n\tcQueryB1D:= Subs(cWhereB1D,2)\r\n\r\n\tcWhereB1A+= \"%\" \r\n\tcWhereB1B+= \"%\" \r\n\tcWhereB1C+= \"%\" \r\n\tcWhereB1D+= \"%\" \t\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ So inclui as condicoes a seguir qdo lista produtos sem ³\r\n\t//³ movimento                                              ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tcQueryD1 := \" FROM \"\r\n\tcQueryD1 += RetSqlName(\"SB1\") + \" SB1\"\r\n\tcQueryD1 += (\", \" + RetSqlName(\"SD1\")+ \" SD1 \")\r\n\tcQueryD1 += (\", \" + RetSqlName(\"SF4\")+ \" SF4 \")\r\n\tcQueryD1 += \" WHERE SB1.B1_COD = D1_COD\"\r\n\tcQueryD1 += (\" AND D1_FILIAL = '\"+xFilial(\"SD1\")+\"'\")\r\n\tcQueryD1 += (\" AND F4_FILIAL = '\" + xFilial(\"SF4\") + \"'\")\r\n\tcQueryD1 += (\" AND SD1.D1_TES = F4_CODIGO AND F4_ESTOQUE = 'S'\")\r\n\tcQueryD1 += (\" AND D1_DTDIGIT >= '\" + DTOS(mv_par05) + \"'\")\r\n\tcQueryD1 += (\" AND D1_DTDIGIT <= '\" + DTOS(mv_par06) + \"'\")\r\n\tcQueryD1 +=  \" AND D1_ORIGLAN <> 'LF'\"\r\n\tIf !lCusUnif\r\n\t\tcQueryD1 += \" AND D1_LOCAL = '\" + mv_par08 + \"'\"\r\n\tEndIf\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Não imprimir o produto MANUTENCAO (MV_PRDMNT) qdo integrado com MNT.       ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf MTR910IsMNT() \r\n\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\taProdsMNT := aClone(NGProdMNT())\r\n\t\t\tFor nX := 1 To Len(aProdsMNT)\r\n\t\t\t\tcQueryD1 += \" AND SB1.B1_COD <> '\" + aProdsMNT[nX] + \"'\"\r\n\t\t\tNext nX\r\n\t\tElse\r\n\t\t\tcQueryD1 += \" AND SB1.B1_COD <> '\" + cProdMNT + \"'\"\r\n\t\t\tcQueryD1 += \" AND SB1.B1_COD <> '\" + cProdTER + \"'\"\r\n\t\tEndIf\r\n\tEndIf\t\r\n\tcQueryD1 += \" AND SD1.D_E_L_E_T_=' ' AND SF4.D_E_L_E_T_=' '\"\r\n\r\n\tcQueryD2 := \" FROM \"\r\n\tcQueryD2 += RetSqlName(\"SB1\") + \" SB1 , \"+ RetSqlName(\"SD2\")+ \" SD2 , \"+ RetSqlName(\"SF4\")+\" SF4 \"\r\n\tcQueryD2 += \" WHERE SB1.B1_COD = D2_COD AND D2_FILIAL = '\"+xFilial(\"SD2\")+\"'\"\r\n\tcQueryD2 += \" AND F4_FILIAL = '\"+xFilial(\"SF4\")+\"' AND SD2.D2_TES = F4_CODIGO AND F4_ESTOQUE = 'S'\"\r\n\tcQueryD2 += \" AND D2_EMISSAO >= '\"+DTOS(mv_par05)+\"' AND D2_EMISSAO <= '\"+DTOS(mv_par06)+\"'\"\r\n\tcQueryD2 += \" AND D2_ORIGLAN <> 'LF'\"\r\n\tIf !lCusUnif\r\n\t\tcQueryD2 += \" AND D2_LOCAL = '\"+mv_par08+\"'\"\r\n\tEndIf\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Não imprimir o produto MANUTENCAO (MV_PRDMNT) qdo integrado com MNT.       ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf MTR910IsMNT() \r\n\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\taProdsMNT := aClone(NGProdMNT())\r\n\t\t\tFor nX := 1 To Len(aProdsMNT)\r\n\t\t\t\tcQueryD2 += \" AND SB1.B1_COD <> '\" + aProdsMNT[nX] + \"'\"\r\n\t\t\tNext nX\r\n\t\tElse\r\n\t\t\tcQueryD2 += \" AND SB1.B1_COD <> '\" + cProdMNT + \"'\"\r\n\t\t\tcQueryD2 += \" AND SB1.B1_COD <> '\" + cProdTER + \"'\"\r\n\t\tEndIf\r\n\tEndIf\t\r\n\tcQueryD2 += \" AND SD2.D_E_L_E_T_=' ' AND SF4.D_E_L_E_T_=' '\"\t\r\n\r\n\tcQueryD3 := \" FROM \"\r\n\tcQueryD3 += RetSqlName(\"SB1\") + \" SB1 , \"+ RetSqlName(\"SD3\")+ \" SD3 \"\r\n\tcQueryD3 += \" WHERE SB1.B1_COD = D3_COD AND D3_FILIAL = '\"+xFilial(\"SD3\")+\"' \"\r\n\tcQueryD3 += \" AND D3_EMISSAO >= '\"+DTOS(mv_par05)+\"' AND D3_EMISSAO <= '\"+DTOS(mv_par06)+\"'\"\r\n\tIf SuperGetMV('MV_D3ESTOR', .F., 'N') == 'N'\r\n\t\tcQueryD3 += \" AND D3_ESTORNO <> 'S'\"\r\n\tEndIf\r\n\tIf SuperGetMV('MV_D3SERVI', .F., 'N') == 'N' .And. IntDL()\r\n\t\tcQueryD3 += \" AND ( (D3_SERVIC = '   ') OR (D3_SERVIC <> '   ' AND D3_TM <= '500')  \"\r\n\t\tcQueryD3 += \" OR  (D3_SERVIC <> '   ' AND D3_TM > '500' AND D3_LOCAL ='\"+SuperGetMV('MV_CQ', .F., '98')+\"') )\"\r\n\tEndIf\t\t\t\t\t\r\n\tIf !lCusUnif .And. !lLocProc\r\n\t\tcQueryD3 += \" AND D3_LOCAL = '\"+mv_par08+\"'\"\r\n\tEndIf\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Não imprimir o produto MANUTENCAO (MV_PRDMNT) qdo integrado com MNT.       ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf MTR910IsMNT() \r\n\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\taProdsMNT := aClone(NGProdMNT())\r\n\t\t\tFor nX := 1 To Len(aProdsMNT)\r\n\t\t\t\tcQueryD3 += \" AND SB1.B1_COD <> '\" + aProdsMNT[nX] + \"'\"\r\n\t\t\tNext nX\r\n\t\tElse\r\n\t\t\tcQueryD3 += \" AND SB1.B1_COD <> '\" + cProdMNT + \"'\"\r\n\t\t\tcQueryD3 += \" AND SB1.B1_COD <> '\" + cProdTER + \"'\"\r\n\t\tEndIf\r\n\tEndIf\t\r\n\tcQueryD3 += \" AND SD3.D_E_L_E_T_=' '\"\t\r\n\r\n\tcQuerySub:= \"SELECT 1 \"\r\n\r\n\tIf mv_par07 == 1\r\n\t\tcQuery2 := \" AND NOT EXISTS (\" + cQuerySub + cQueryD1\r\n\t\tcQuery2 += cQueryB1B\r\n\t\tcQuery2 += \" AND \"\r\n\t\tcQuery2 += cQueryB1C\r\n\t\tcQuery2 += \") AND NOT EXISTS (\"\r\n\t\tcQuery2 += cQuerySub + cQueryD2\r\n\t\tcQuery2 += cQueryB1B\r\n\t\tcQuery2 += \" AND \"\r\n\t\tcQuery2 += cQueryB1C\r\n\t\tcQuery2 += \") AND NOT EXISTS (\"\r\n\t\tcQuery2 += cQuerySub + cQueryD3\r\n\t\tcQuery2 += cQueryB1B\r\n\t\tcQuery2 += \" AND \"\r\n\t\tcQuery2 += cQueryB1C + \")\"\r\n\r\n\t\tcUnion := \"%\"\r\n\t\tcUnion += \" UNION SELECT 'SB1'\"\t\t// 01\r\n\t\tcUnion += \", SB1EXS.B1_COD\"\t\t\t// 02\r\n\t\tcUnion += \", SB1EXS.B1_TIPO\"\t\t// 03\r\n\t\tcUnion += \", SB1EXS.B1_UM\"\t\t\t// 04\r\n\t\tcUnion += \", SB1EXS.B1_GRUPO\"\t\t// 05\r\n\t\tcUnion += \", SB1EXS.B1_DESC\"\t\t// 06\r\n\t\tcUnion += \", SB1EXS.B1_POSIPI\"\t\t// 07\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 08\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 09\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 10\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 11\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 12\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 13\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 14\r\n\t\tcUnion += \", 0\"\t\t\t\t\t\t// 15\r\n\t\tcUnion += \", 0\"\t\t\t\t\t\t// 16\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 17\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 18\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 19\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 20\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 21\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 22\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 23\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 24\r\n\t\tcUnion += \", 0\"\t\t\t\t\t\t// 25\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 26\r\n\t\tIf lVEIC\r\n\t\t\tcUnion += \", SB1EXS.B1_CODITE CODITE\"\t// 27\r\n\t\tEndIf\r\n\t\tcUnion += \", ''\"\t\t\t\t\t// 28\r\n\t\tcUnion += \", 0\"\t\t\t\t\t\t// 29\r\n\t\tcUnion += \" FROM \"+RetSqlName(\"SB1\") + \" SB1EXS WHERE\"\r\n\t\tcUnion += cQueryB1D\r\n\t\tcUnion += cQuery2\r\n\t\tcUnion += \"%\"\r\n\tEndIf\r\n\r\n\tcOrder := \"%\"\r\n\tIf nOrdem == 1\r\n\t\tIf ! lVEIC\r\n\t\t\tcOrder += \" 2,9,\"\r\n\t\tElse\r\n\t\t\tcOrder += \" 27, 9,\"\r\n\t\tEndIf\t\r\n\tElseIf nOrdem == 2\r\n\t\tIf ! lVEIC\r\n\t\t\tcOrder += \" 3,2,9,\"\r\n\t\tElse\r\n\t\t\tcOrder += \" 3, 27, 9,\"\r\n\t\tEndIf\t\r\n\tEndIf\r\n\tIf mv_par16 == 1\r\n\t\t//\t\tcOrder += \"17,12\"+IIf(lVEIC,',29',',28')\r\n\t\tcOrder += \"12\"+IIf(lVEIC,',29',',28')\r\n\tElse\r\n\t\tIf lCusUnif\r\n\t\t\tcOrder += \"8,12\"+IIf(lVEIC,',29',',28')\r\n\t\tElse\r\n\t\t\t//\t\t\tcOrder += \"17,8,12\"+IIf(lVEIC,',29',',28')\r\n\t\t\tcOrder += \"8\"+IIf(lVEIC,',29',',28')\r\n\t\tEndIf\r\n\tEndIf\t\r\n\tcOrder += \"%\"\r\n\r\n\tBeginSql Alias cAliasTop\r\n\r\n\t\tSELECT \t'SD1' ARQ, \t\t\t\t//-- 01 ARQ\r\n\t\tSB1.B1_COD PRODUTO, \t//-- 02 PRODUTO\r\n\t\tSB1.B1_TIPO TIPO, \t\t//-- 03 TIPO\r\n\t\tSB1.B1_UM,   \t\t\t//-- 04 UM\r\n\t\tSB1.B1_GRUPO,      \t//-- 05 GRUPO\r\n\t\tSB1.B1_DESC,      \t\t//-- 06 DESCR\r\n\t\tSB1.B1_POSIPI, \t\t//-- 07\r\n\t\tD1_SEQCALC SEQCALC,    //-- 08\r\n\t\tD1_DTDIGIT DATA,\t\t//-- 09 DATA\r\n\t\tD1_TES TES,\t\t\t//-- 10 TES\r\n\t\tD1_CF CF,\t\t\t\t//-- 11 CF\r\n\t\tD1_NUMSEQ SEQUENCIA,\t//-- 12 SEQUENCIA\r\n\t\tD1_DOC DOCUMENTO,\t\t//-- 13 DOCUMENTO\r\n\t\tD1_SERIE SERIE,\t\t//-- 14 SERIE\r\n\t\tD1_QUANT QUANTIDADE,\t//-- 15 QUANTIDADE\r\n\t\tD1_QTSEGUM QUANT2UM,\t//-- 16 QUANT2UM\r\n\t\tD1_LOCAL ARMAZEM,\t\t//-- 17 ARMAZEM\r\n\t\t' ' PROJETO,\t\t\t//-- 18 PROJETO\r\n\t\t' ' OP,\t\t\t\t//-- 19 OP\r\n\t\t' ' CC,\t\t\t\t//-- 20 OP\r\n\t\tD1_FORNECE FORNECEDOR,\t//-- 21 FORNECEDOR\r\n\t\tD1_LOJA LOJA,\t\t\t//-- 22 LOJA\r\n\t\t' ' PEDIDO,            //-- 23 PEDIDO\r\n\t\tD1_TIPO TIPONF,\t\t//-- 24 TIPO NF\r\n\t\t%Exp:cSelectD1%\t\t//-- 25 CUSTO \r\n\t\t' ' TRT \t\t\t\t//-- 26 TRT\r\n\t\t%Exp:cSelectVe%        //-- 27 CODITE\r\n\t\tD1_LOTECTL LOTE, \t    //-- 28 LOTE\t\t\t\t\t \r\n\t\tSD1.R_E_C_N_O_ NRECNO  //-- 29 RECNO\r\n\r\n\t\tFROM %table:SB1% SB1,%table:SD1% SD1,%table:SF4% SF4\r\n\r\n\t\tWHERE SB1.B1_COD     =  SD1.D1_COD\t\tAND  \tSD1.D1_FILIAL  =  %xFilial:SD1%\t\tAND\r\n\t\tSF4.F4_FILIAL  =  %xFilial:SF4%  \tAND \tSD1.D1_TES     =  SF4.F4_CODIGO\t\tAND\r\n\t\tSF4.F4_ESTOQUE =  'S'\t\t\t\tAND \tSD1.D1_DTDIGIT >= %Exp:mv_par05%   AND\r\n\t\tSD1.D1_DTDIGIT <= %Exp:mv_par06%\tAND\t\tSD1.D1_ORIGLAN <> 'LF'\t\t\t\t   \r\n\t\t%Exp:cWhereD1%\r\n\t\tSD1.%NotDel%\t\t\t\t\t\tAND \tSF4.%NotDel%                           \r\n\t\t%Exp:cWhereB1A%                   AND\r\n\t\t%Exp:cWhereB1C%\r\n\r\n\t\tUNION\r\n\r\n\t\tSELECT 'SD2',\t     \t\t\t\r\n\t\tSB1.B1_COD,\t        \t\r\n\t\tSB1.B1_TIPO,\t\t    \r\n\t\tSB1.B1_UM,\t\t\t\t\r\n\t\tSB1.B1_GRUPO,\t\t    \r\n\t\tSB1.B1_DESC,\t\t    \r\n\t\tSB1.B1_POSIPI,\r\n\t\tD2_SEQCALC,\r\n\t\tD2_EMISSAO,\t\t\t\t\r\n\t\tD2_TES,\t\t\t\t\t\r\n\t\tD2_CF,\t\t\t\t\t\r\n\t\tD2_NUMSEQ,\t\t\t\t\r\n\t\tD2_DOC,\t\t\t\t\t\r\n\t\tD2_SERIE,\t\t\t\t\r\n\t\tD2_QUANT,\t\t\t\t\r\n\t\tD2_QTSEGUM,\t\t\t\t\r\n\t\tD2_LOCAL,\t\t\t\t\r\n\t\t' ',\t\t\t\t\t\r\n\t\t' ',\t\t\t\t\t\r\n\t\t' ',\t\t\t\t\t\r\n\t\tD2_CLIENTE,\t\t\t\t\r\n\t\tD2_LOJA,\t\t\t\t\r\n\t\tD2_PEDIDO,\r\n\t\tD2_TIPO,\t\t\t\t\r\n\t\t%Exp:cSelectD2%\t\t\t\r\n\t\t' ' \t\t\t\t\t\r\n\t\t%Exp:cSelectVe%\r\n\t\tD2_LOTECTL,\r\n\t\tSD2.R_E_C_N_O_ SD2RECNO \t// 29\r\n\r\n\t\tFROM %table:SB1% SB1,%table:SD2% SD2,%table:SF4% SF4\r\n\r\n\t\tWHERE\tSB1.B1_COD     =  SD2.D2_COD\t\tAND\tSD2.D2_FILIAL  = %xFilial:SD2%\t\tAND\r\n\t\tSF4.F4_FILIAL  = %xFilial:SF4% \t\tAND\tSD2.D2_TES     =  SF4.F4_CODIGO\t\tAND\r\n\t\tSF4.F4_ESTOQUE =  'S'\t\t\t\tAND\tSD2.D2_EMISSAO >= %Exp:mv_par05%\tAND\r\n\t\tSD2.D2_EMISSAO <= %Exp:mv_par06%\tAND\tSD2.D2_ORIGLAN <> 'LF'\t\t\t\t   \r\n\t\t%Exp:cWhereD2%\r\n\t\tSD2.%NotDel%\t\t\t\t\t\tAND SF4.%NotDel%\t\t\t\t\t\t   \r\n\t\t%Exp:cWhereB1A%                     AND\r\n\t\t%Exp:cWhereB1C%\r\n\r\n\t\tUNION\t\t\r\n\r\n\t\tSELECT \t'SD3',\t    \t\t\t\r\n\t\tSB1.B1_COD,\t    \t    \r\n\t\tSB1.B1_TIPO,\t\t    \r\n\t\tSB1.B1_UM,\t\t\t\t\r\n\t\tSB1.B1_GRUPO,\t     \t\r\n\t\tSB1.B1_DESC,\t\t    \r\n\t\tSB1.B1_POSIPI,\r\n\t\tD3_SEQCALC,\r\n\t\tD3_EMISSAO,\t\t\t\t\r\n\t\tD3_TM,\t\t\t\t\t\r\n\t\tD3_CF,\t\t\t\t\t\r\n\t\tD3_NUMSEQ,\t\t\t\t\r\n\t\tD3_DOC,\t\t\t\t\t\r\n\t\t' ',\t\t\t\t\t\r\n\t\tD3_QUANT,\t\t\t\t\r\n\t\tD3_QTSEGUM,\t\t\t\t\r\n\t\tD3_LOCAL,\t\t\t\t\r\n\t\tD3_PROJPMS,\r\n\t\tD3_OP,\t\t\t\t\t\r\n\t\tD3_CC,\r\n\t\t' ',\t\t\t\t\t\r\n\t\t' ',\t\t\t\t\t\r\n\t\t' ',\t\t\t\t\t\r\n\t\t' ',\t\t\t\t\t\t\t\t\t\r\n\t\t%Exp:cSelectD3%\t\t\t\r\n\t\tD3_TRT \r\n\t\t%Exp:cSelectVe%\r\n\t\tD3_LOTECTL,\r\n\t\tSD3.R_E_C_N_O_ SD3RECNO \t// 29\r\n\r\n\t\tFROM %table:SB1% SB1,%table:SD3% SD3\r\n\r\n\t\tWHERE\tSB1.B1_COD     =  SD3.D3_COD \t\tAND SD3.D3_FILIAL  =  %xFilial:SD3%\t\tAND\r\n\t\tSD3.D3_EMISSAO >= %Exp:mv_par05%\tAND\tSD3.D3_EMISSAO <= %Exp:mv_par06%\tAND\r\n\t\t%Exp:cWhereD3% \t\r\n\t\tSD3.%NotDel% \r\n\r\n\r\n\t\t%Exp:cUnion%\t\t\t\r\n\r\n\t\tORDER BY %Exp:cOrder%\r\n\r\n\tEndSql \r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Metodo EndQuery ( Classe TRSection )                                    ³\r\n\t//³                                                                        ³\r\n\t//³Prepara o relatório para executar o Embedded SQL.                       ³\r\n\t//³                                                                        ³\r\n\t//³ExpA1 : Array com os parametros do tipo Range                           ³\r\n\t//³                                                                        ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\toReport:Section(1):EndQuery(/*Array com os parametros do tipo Range*/)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Inicio da impressao do fluxo do relatório                               ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tdbSelectArea(cAliasTop)\r\n\toReport:SetMeter(nTotRegs)\r\n\r\n\tTcSetField(cAliasTop,DATA ,\"D\", TamSx3(\"D1_DTDIGIT\")[1], TamSx3(\"D1_DTDIGIT\")[2] )\r\n\r\n\tWhile !oReport:Cancel() .And. !(cAliasTop)->(Eof()) .And. lImpLivro\r\n\r\n\t\tIf oReport:Cancel()\r\n\t\t\tExit\r\n\t\tEndIf\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³ Considera filtro escolhido                                   ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tIf !Empty(cFilUser) .And. SUBSTR(cFilUser,2,2) == \"B1\"\r\n\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\tSB1->(dbSetOrder(1))\r\n\t\t\tSB1->(dbSeek(xFilial(\"SB1\")+(cAliasTop)->PRODUTO))\r\n\t\t\tIf !(&(cFilUser))\r\n\t\t\t\tdbSelectArea(cAliasTop)\t \t    \r\n\t\t\t\tdbSkip()\r\n\t\t\t\tLoop\r\n\t\t\tEndIf  \r\n\t\tElseIf !Empty(cFilUser) .And. SUBSTR(cFilUser,2,2) == \"B2\"\r\n\t\t\tdbSelectArea(\"SB2\")\r\n\t\t\tSB2->(dbSetOrder(1))\r\n\t\t\tSB2->(dbSeek(xFilial(\"SB2\")+(cAliasTop)->PRODUTO))\r\n\t\t\tIf !(&(cFilUser))\r\n\t\t\t\tdbSelectArea(cAliasTop)\t \t    \r\n\t\t\t\tdbSkip()\r\n\t\t\t\tLoop\r\n\t\t\tEndIf    \r\n\t\tEndIf\r\n\r\n\t\tdbSelectArea(cAliasTop)\r\n\t\toReport:IncMeter()\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³ Se nao encontrar no arquivo de saldos ,nao lista ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tdbSelectArea(\"SB2\")\r\n\t\tIf !dbSeek(xFilial(\"SB2\")+(cAliasTop)->PRODUTO+If(lCusUnif,\"\",mv_par08))\r\n\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\tdbSkip()\r\n\t\t\tLoop\r\n\t\tEndIf\r\n\t\t// Nao lista de saldo for igual a zero\r\n\t\tIf mv_par20 == 2 .And. SB2->B2_QATU == 0\r\n\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\tdbSkip()\r\n\t\t\tLoop\r\n\t\tEndIf\r\n\t\t// Nao lista de saldo for negativo\r\n\t\tIf mv_par21 == 2 .And. SB2->B2_QATU < 0\r\n\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\tdbSkip()\r\n\t\t\tLoop\r\n\t\tEndIf\r\n\r\n\t\tdbSelectArea(cAliasTop)\r\n\t\tcProdAnt  := (cAliasTop)->PRODUTO\r\n\t\tcLocalAnt := SB2->B2_LOCAL\r\n\t\tlFirst:=.F.\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³ Calcula o Saldo Inicial do Produto             ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tIf lCusUnif\r\n\t\t\taArea:=GetArea()\r\n\t\t\taSalAtu  := { 0,0,0,0,0,0,0 }\r\n\t\t\tdbSelectArea(\"SB2\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSeek(cSeek:=xFilial(\"SB2\")+(cAliasTOP)->PRODUTO)\r\n\t\t\tWhile !Eof() .And. B2_FILIAL+B2_COD == cSeek\r\n\t\t\t\taSalAlmox := CalcEst((cAliasTOP)->PRODUTO,SB2->B2_LOCAL,mv_par05)\r\n\t\t\t\tFor i:=1 to Len(aSalAtu)\r\n\t\t\t\t\taSalAtu[i] += aSalAlmox[i]\r\n\t\t\t\tNext i\r\n\t\t\t\tdbSkip()\r\n\t\t\tEnd\r\n\t\t\tRestArea(aArea)\r\n\t\tElse\r\n\t\t\taSalAtu := CalcEst((cAliasTOP)->PRODUTO,mv_par08,mv_par05)\r\n\t\tEndIf\r\n\r\n\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\taGrupos[nAcho][4] += aSalAtu[mv_par11+1]\r\n\t\tElse\r\n\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,0,aSalAtu[mv_par11+1]})\r\n\t\tEndIf\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³ Calcula o Custo Medio do Produto               ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tIf AsalAtu[1] > 0\r\n\t\t\tnCusmed := aSalAtu[mv_par11+1]/aSalAtu[1]\r\n\t\tElseIf AsalAtu[1] == 0 .and. AsalAtu[mv_par11+1] == 0\r\n\t\t\tnCusMed := 0\r\n\t\tElse\r\n\t\t\tSB2->(dbSeek(xFilial(\"SB2\") + (cAliasTOP)->PRODUTO + (cAliasTOP)->ARMAZEM))\r\n\t\t\tnCusmed := &(\"SB2->B2_CM\" + Str(mv_par11,1))\r\n\t\tEndIf\r\n\t\tMR910ImpS1(aSalAtu,nCusMed,cAliasTop,lVEIC,lCusUnif,oSection1,oSection2)\r\n\t\tlFirst1 := .F.\r\n\r\n\t\toSection3:Init() \r\n\t\tWhile !oReport:Cancel() .And. !(cAliasTop)->(Eof()) .And. (cAliasTop)->PRODUTO = cProdAnt\r\n\t\t\toReport:IncMeter()\r\n\t\t\tlContinua := .F.\r\n\t\t\tlImpSMov  := .F.\r\n\t\t\tlImpS3    := .F.\r\n\t\t\tIf Alltrim((cAliasTop)->ARQ) $ \"SD1/SD2\"\r\n\t\t\t\tlFirst:=.T.\r\n\t\t\t\tSF4->(dbSeek(xFilial(\"SF4\")+(cAliasTop)->TES))\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Despreza Notas Fiscais Lancadas Pelo Modulo do Livro Fiscal  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Executa ponto de entrada para verificar se considera TES que ³\r\n\t\t\t\t//³ NAO ATUALIZA saldos em estoque.                              ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf lIxbConTes .And. SF4->F4_ESTOQUE != \"S\"\r\n\t\t\t\t\tlTesNEst := ExecBlock(\"MTAAVLTES\",.F.,.F.)\r\n\t\t\t\t\tlTesNEst := If(ValType(lTesNEst) # \"L\",.F.,lTesNEst)\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF4->F4_ESTOQUE != \"S\" .And. !lTesNEst\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\tElseIf Alltrim((cAliasTop)->ARQ) == \"SD3\"\r\n\t\t\t\tlFirst:=.T.\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Quando movimento ref apropr. indireta, so considera os         ³\r\n\t\t\t\t//³ movimentos com destino ao almoxarifado de apropriacao indireta.³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tlInverteMov:=.F.\r\n\t\t\t\tIf (cAliasTop)->ARMAZEM != cLocalAnt .Or. lCusUnif\r\n\t\t\t\t\tIf !(Substr((cAliasTop)->CF,3,1) == \"3\")\r\n\t\t\t\t\t\tIf !lCusUnif\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElseIf lPriApropri\r\n\t\t\t\t\t\tlInverteMov:=.T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Caso seja uma transferencia de localizacao verifica se lista   ³\r\n\t\t\t\t//³ o movimento ou nao                                             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf mv_par17 == 2 .And. Substr((cAliasTop)->CF,3,1) == \"4\"\r\n\t\t\t\t\tcNumSeqTr := (cAliasTOP)->(PRODUTO+SEQUENCIA+ARMAZEM)\r\n\t\t\t\t\taDadosTran:={(cAliasTOP)->TES,(cAliasTOP)->QUANTIDADE,(cAliasTOP)->CUSTO,(cAliasTOP)->QUANT2UM,(cAliasTOP)->TIPO,;\r\n\t\t\t\t\t(cAliasTOP)->DATA,(cAliasTOP)->CF,(cAliasTOP)->SEQUENCIA,(cAliasTOP)->DOCUMENTO,(cAliasTOP)->PRODUTO,;\r\n\t\t\t\t\t(cAliasTOP)->OP,(cAliasTOP)->PROJETO,(cAliasTOP)->CC,(cAliasTOP)->ARQ}\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tIf (cAliasTOP)->(PRODUTO+SEQUENCIA+ARMAZEM) == cNumSeqTr\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tlContinua := .T.\r\n\t\t\t\t\t\tIf lFirst\r\n\t\t\t\t\t\t\toSection3:Cell(\"dDtMov\"):SetValue(STOD(aDadosTran[6]))\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"cTES\"):SetValue(aDadosTran[1])\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf ( cPaisLoc==\"BRA\" )\r\n\t\t\t\t\t\t\t\toSection3:Cell(\"cCF\"):Show()\r\n\t\t\t\t\t\t\t\toSection3:Cell(\"cCF\"):SetValue(aDadosTran[7])\r\n\t\t\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t\t\tIf\tlInverteMov\r\n\t\t\t\t\t\t\t\t@Li , 018 PSay \"*\"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\toSection3:Cell(\"cCF\"):Hide()\r\n\t\t\t\t\t\t\t\toSection3:Cell(\"cCF\"):SetValue(\"   \")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf mv_par09 $ \"Ss\"\r\n\t\t\t\t\t\t\t\toSection3:Cell(\"cDoc\"):SetValue(aDadosTran[8])\t\t\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\toSection3:Cell(\"cDoc\"):SetValue(aDadosTran[9])\t\t\t\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf aDadosTran[1] <= \"500\"\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(aDadosTran[2])\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(aDadosTran[3])\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(aDadosTran[3] / aDadosTran[2])\t\t\t\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(0)\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(0)\t\t\t\r\n\r\n\t\t\t\t\t\t\taSalAtu[1] += aDadosTran[2]\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] += aDadosTran[3]\r\n\t\t\t\t\t\t\taSalAtu[7] += aDadosTran[4]\r\n\r\n\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| aDadosTran[5] == x[1]})) > 0\r\n\t\t\t\t\t\t\t\taGrupos[nAcho][2]+=aDadosTran[3]\r\n\t\t\t\t\t\t\t\taGrupos[nAcho][4]+=aDadosTran[3]\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tAADD(aGrupos,{aDadosTran[5],aDadosTran[3],0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(0)\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Show()\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(aDadosTran[3] / aDadosTran[2])\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(aDadosTran[2])\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(aDadosTran[3])\t\t\t\r\n\r\n\t\t\t\t\t\t\taSalAtu[1] -= aDadosTran[2]\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= aDadosTran[3]\r\n\t\t\t\t\t\t\taSalAtu[7] -= aDadosTran[4]\r\n\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| aDadosTran[5] == x[1]})) > 0\r\n\t\t\t\t\t\t\t\taGrupos[nAcho][3]+=aDadosTran[3]\r\n\t\t\t\t\t\t\t\taGrupos[nAcho][4]-=aDadosTran[3]\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tAADD(aGrupos,{aDadosTran[5],0,aDadosTran[3],-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\r\n\t\t\tIf lFirst .And. !lContinua\r\n\t\t\t\toSection3:Cell(\"dDtMov\"):SetValue(STOD(DATA))\t\t\t\r\n\t\t\t\toSection3:Cell(\"cTES\"):SetValue(TES)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf ( cPaisLoc==\"BRA\" )\r\n\t\t\t\t\toSection3:Cell(\"cCF\"):Show()\r\n\t\t\t\t\toSection3:Cell(\"cCF\"):SetValue(CF)\t\t\t\t\t\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tIf\tlInverteMov\r\n\t\t\t\t\t@Li , 018 PSay \"*\"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t*/\r\n\t\t\t\tElse\r\n\t\t\t\t\toSection3:Cell(\"cCF\"):Hide()\r\n\t\t\t\t\toSection3:Cell(\"cCF\"):SetValue(\"   \")\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf mv_par09 $ \"Ss\"\r\n\t\t\t\t\toSection3:Cell(\"cDoc\"):SetValue(SEQUENCIA)\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\toSection3:Cell(\"cDoc\"):SetValue(DOCUMENTO)\t\t\t\t\t\t\r\n\t\t\t\tEndif\t\r\n\t\t\tEndIf\r\n\r\n\t\t\tDo Case\r\n\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD1\" .And. !lContinua\r\n\t\t\t\tlDev:=MTR910Dev(cAliasTop)\r\n\t\t\t\tIf (cAliasTOP)->TES <= \"500\" .And. !lDev\r\n\t\t\t\t\tIf (cAliasTOP)->TIPONF != \"C\"\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE)\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Hide()\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\r\n\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue((cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue((cAliasTOP)->CUSTO)\t\t\t\r\n\r\n\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Hide()\r\n\t\t\t\t\toSection3:Cell(\"nSAICus\"):Hide()\t\t\t\t\t\t\r\n\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(0)\r\n\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(0)\r\n\r\n\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\taGrupos[nAcho][2]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,(cAliasTOP)->CUSTO,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\tIf (cAliasTOP)->TIPONF != \"C\"\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(0)\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Hide()\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Hide()\r\n\t\t\t\t\toSection3:Cell(\"nENTCus\"):Hide()\r\n\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(0)\r\n\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(0)\r\n\r\n\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Show()\r\n\t\t\t\t\toSection3:Cell(\"nSAICus\"):Show()\r\n\r\n\t\t\t\t\tIf lDev\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue((cAliasTOP)->QUANTIDADE * -1)\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue((cAliasTOP)->CUSTO * -1)\r\n\r\n\t\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][3]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,-((cAliasTOP)->CUSTO),aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue((cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue((cAliasTOP)->CUSTO)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][3]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,(cAliasTOP)->CUSTO,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tCase Alltrim((cAliasTop)->ARQ) = \"SD2\" .And. !lContinua\r\n\t\t\t\tlDev:=MTR910Dev(cAliasTop)\r\n\t\t\t\tIf (cAliasTOP)->TES <= \"500\" .Or. lDev\r\n\t\t\t\t\tIf lDev\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue((cAliasTOP)->QUANTIDADE * -1)\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue((cAliasTOP)->CUSTO * -1)\r\n\r\n\t\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][2]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,-((cAliasTOP)->CUSTO),0,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue((cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue((cAliasTOP)->CUSTO)\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][2]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,(cAliasTOP)->CUSTO,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf (cAliasTOP)->TIPONF != \"C\"\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Hide()\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Hide()\r\n\t\t\t\t\toSection3:Cell(\"nSAICus\"):Hide()\r\n\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(0)\r\n\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(0)\r\n\t\t\t\tElse\r\n\t\t\t\t\tIf (cAliasTOP)->TIPONF != \"C\"\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Hide()\r\n\t\t\t\t\tEndIf\t\t\t\t\t\t\r\n\r\n\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Hide()\r\n\t\t\t\t\toSection3:Cell(\"nENTCus\"):Hide()\r\n\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(0)\r\n\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(0)\r\n\r\n\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Show()\r\n\t\t\t\t\toSection3:Cell(\"nSAICus\"):Show()\r\n\r\n\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue((cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue((cAliasTOP)->CUSTO)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\taGrupos[nAcho][3]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,(cAliasTOP)->CUSTO,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD3\" .And. !lContinua\r\n\t\t\t\tlDev := .F.\r\n\t\t\t\tIf\tlInverteMov\r\n\t\t\t\t\tIf (cAliasTOP)->TES > \"500\"\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue((cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue((cAliasTOP)->CUSTO)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE)\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Hide()\t\t\t\t\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][2]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,(cAliasTOP)->CUSTO,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Show()\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue((cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue((cAliasTOP)->CUSTO)\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][3]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,(cAliasTOP)->CUSTO,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf \r\n\t\t\t\t\tIf lCusUnif\r\n\t\t\t\t\t\tlPriApropri:=.F.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\tIf (cAliasTOP)->TES <= \"500\"\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue((cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue((cAliasTOP)->CUSTO)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Hide()\t\t\t\t\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][2]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,(cAliasTOP)->CUSTO,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Show()\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue((cAliasTOP)->QUANTIDADE)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue((cAliasTOP)->CUSTO)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][3]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,(cAliasTOP)->CUSTO,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIf lCusUnif\r\n\t\t\t\t\t\tlPriApropri:=.T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndCase\r\n\t\t\tIf lFirst\r\n\t\t\t\toSection3:Cell(\"nSALDQtd\"):SetValue(aSalAtu[1])\t\t\t\r\n\t\t\t\toSection3:Cell(\"nSALDCus\"):SetValue(aSalAtu[mv_par11+1])\t\t\t\r\n\t\t\tEndIf\r\n\t\t\tDo Case\r\n\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD3\" .And. !lContinua\r\n\t\t\t\tIf Empty((cAliasTOP)->OP) .And. Empty((cAliasTOP)->PROJETO)\r\n\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('CC'+(cAliasTOP)->CC)\t\t\t\r\n\t\t\t\tElseIf !Empty((cAliasTOP)->PROJETO)\r\n\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('PJ'+(cAliasTOP)->PROJETO)\r\n\t\t\t\tElseIf !Empty((cAliasTOP)->OP)\r\n\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('OP'+(cAliasTOP)->OP)\r\n\t\t\t\tEndIf\r\n\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD1\" .And. !lContinua\r\n\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('F-'+(cAliasTOP)->FORNECEDOR)\r\n\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD2\" .And. !lContinua\r\n\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('P-'+(cAliasTOP)->PEDIDO)\t\t\t\t\t\r\n\t\t\t\tCase lContinua .And. aDadosTran[14] == \"SD3\"\r\n\t\t\t\tIf Empty(aDadosTran[11]) .And. Empty(aDadosTran[12])\r\n\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('CC'+aDadosTran[13])\t\r\n\t\t\t\tElseIf !Empty(aDadosTran[12])\r\n\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('PJ'+aDadosTran[12])\r\n\t\t\t\tElseIf !Empty(aDadosTran[11])\r\n\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('OP'+aDadosTran[11])\r\n\t\t\t\tEndIf\r\n\t\t\tEndCase\r\n\r\n\t\t\tIf lFirst\r\n\t\t\t\toSection3:PrintLine()\r\n\t\t\tEndif\t\r\n\r\n\t\t\tIf !lInverteMov .Or. (lInverteMov .And. lPriApropri)\r\n\t\t\t\tIf !lContinua //Acerto para utilizar o Array aDadosTran[]\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tEndDo\r\n\r\n\t\tIf lFirst\r\n\t\t\toReport:PrintText(STR0018+TransForm(aSalAtu[7],cPicB2Qt2),,oSection3:Cell('nSAICus'):ColPos()) //\"QTD. NA SEGUNDA UM: \"\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\tlImpS3 := .T.\r\n\t\tElse\r\n\t\t\tIf !MTR910IsMNT()\r\n\t\t\t\toReport:PrintText(STR0019)\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\toReport:ThinLine()\r\n\t\t\t\tlImpSMov := .T.\r\n\t\t\tElse\r\n\t\t\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\t\t\taProdsMNT := aClone(NGProdMNT())\r\n\t\t\t\t\tIf aScan(aProdsMNT, {|x| AllTrim(x) == AllTrim(SB1->B1_COD) }) == 0\r\n\t\t\t\t\t\toReport:PrintText(STR0019)\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\toReport:ThinLine()\r\n\t\t\t\t\t\tlImpSMov := .T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElseIf SB1->B1_COD <> cProdMNT .and. SB1->B1_COD <> cProdTER\r\n\t\t\t\t\toReport:PrintText(STR0019)\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\toReport:ThinLine()\r\n\t\t\t\t\tlImpSMov := .T.\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\r\n\t\tEndIf\r\n\r\n\t\toSection1:Finish()\r\n\t\toSection2:Finish()\r\n\t\tIf !lImpSMov .And. lImpS3\r\n\t\t\toSection3:Finish()\t\t\t\t\r\n\t\tEndif\t\r\n\tEndDo\r\n\tdbSelectArea(cAliasTop)\r\n\r\n\tIf !Empty(aGrupos)\r\n\t\toReport:SkipLine()    \r\n\t\toReport:PrintText(STR0020) //\"R E S U M O\"\r\n\t\toReport:SkipLine()    \r\n\t\tdbSelectArea(\"SX5\")\r\n\t\tFor i:=1 to Len(aGrupos)\r\n\t\t\tdbSeek(xFilial(\"SX5\")+\"02\"+aGrupos[i][1])\r\n\t\t\toReport:PrintText(X5Descri(),oReport:Row())\r\n\t\t\toReport:PrintText(TransForm(aGrupos[i][2],cPicD1Cust),oReport:Row(),oSection3:Cell('nENTCus'):ColPos())\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\toReport:PrintText(TransForm(aGrupos[i][3],cPicD2Cust),oReport:Row(),oSection3:Cell('nSAICus'):ColPos())\r\n\t\t\toReport:PrintText(TransForm(aGrupos[i][4],cPicB2Cust),oReport:Row(),oSection3:Cell('nSALDCus'):ColPos())\t\t\t\r\n\t\t\toReport:SkipLine()    \r\n\t\tNext i\r\n\tEndIf\t\r\n\r\n\t#ELSE\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Seta ordens dos arquivos de movimentos e monta IndRegua      ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf mv_par16 == 1\r\n\t\tIf lCusUnif\r\n\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\tcIndice:=\"D1_FILIAL+D1_COD+DTOS(D1_DTDIGIT)+D1_NUMSEQ\"\r\n\t\t\tIndRegua(\"SD1\",cTrbSD1,cIndice,,DBFilter())\r\n\t\t\tnInd := RetIndex(\"SD1\")\r\n\t\t\t#IFNDEF TOP\r\n\t\t\tdbSetIndex(cTrbSD1+OrdBagExt())\r\n\t\t\t#ENDIF\r\n\t\t\tdbSetOrder(nInd+1)\r\n\r\n\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\tcIndice:=\"D2_FILIAL+D2_COD+DTOS(D2_EMISSAO)+D2_NUMSEQ\"\r\n\t\t\tIndRegua(\"SD2\",cTrbSD2,cIndice,,DBFilter())\r\n\t\t\tnInd := RetIndex(\"SD2\")\r\n\t\t\t#IFNDEF TOP\r\n\t\t\tdbSetIndex(cTrbSD2+OrdBagExt())\r\n\t\t\t#ENDIF\r\n\t\t\tdbSetOrder(nInd+1)\r\n\r\n\t\t\tdbSelectArea(\"SD3\")\r\n\t\t\tcIndice:=\"D3_FILIAL+D3_COD+DTOS(D3_EMISSAO)+D3_NUMSEQ\"\r\n\t\t\tIndRegua(\"SD3\",cTrbSD3,cIndice,,DBFilter())\r\n\t\t\tnInd := RetIndex(\"SD3\")\r\n\t\t\t#IFNDEF TOP\r\n\t\t\tdbSetIndex(cTrbSD3+OrdBagExt())\r\n\t\t\t#ENDIF\r\n\t\t\tdbSetOrder(nInd+1)\r\n\t\tElse\r\n\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\tdbSetOrder(7)\r\n\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\tdbSetOrder(6)\r\n\t\t\tdbSelectArea(\"SD3\")\r\n\t\t\tdbSetOrder(7)\r\n\t\t\tIf lLocProc\r\n\t\t\t\tcIndice:=\"D3_FILIAL+D3_COD+DTOS(D3_EMISSAO)+D3_NUMSEQ\"\r\n\t\t\t\tIndRegua(\"SD3\",cTrbSD3,cIndice,,DBFilter(),STR0029)\t//\"Selecionando Registros\"\r\n\t\t\t\tnInd := RetIndex(\"SD3\")\r\n\t\t\t\t#IFNDEF TOP\r\n\t\t\t\tdbSetIndex(cTrbSD3+OrdBagExt())\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tdbSetOrder(nInd+1)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tElse\r\n\t\tdbSelectArea(\"SD1\")\r\n\t\tIf lCusUnif\r\n\t\t\tcIndice:=\"D1_FILIAL+D1_COD+DTOS(D1_DTDIGIT)+D1_SEQCALC+D1_NUMSEQ\"\r\n\t\tElse\r\n\t\t\tcIndice:=\"D1_FILIAL+D1_COD+D1_LOCAL+DTOS(D1_DTDIGIT)+D1_SEQCALC+D1_NUMSEQ\"\r\n\t\tEndIf\r\n\t\tIndRegua(\"SD1\",cTrbSD1,cIndice,,DBFilter(),STR0029)\t//\"Selecionando Registros\"\r\n\t\tnInd := RetIndex(\"SD1\")\r\n\t\t#IFNDEF TOP\r\n\t\tdbSetIndex(cTrbSD1+OrdBagExt())\r\n\t\t#ENDIF\r\n\t\tdbSetOrder(nInd+1)\r\n\r\n\t\tdbSelectArea(\"SD2\")\r\n\t\tIf lCusUnif\r\n\t\t\tcIndice:=\"D2_FILIAL+D2_COD+DTOS(D2_EMISSAO)+D2_SEQCALC+D2_NUMSEQ\"\r\n\t\tElse\r\n\t\t\tcIndice:=\"D2_FILIAL+D2_COD+D2_LOCAL+DTOS(D2_EMISSAO)+D2_SEQCALC+D2_NUMSEQ\"\r\n\t\tEndIf\r\n\t\tIndRegua(\"SD2\",cTrbSD2,cIndice,,DBFilter(),STR0029)\t//\"Selecionando Registros\"\r\n\t\tnInd := RetIndex(\"SD2\")\r\n\t\t#IFNDEF TOP\r\n\t\tdbSetIndex(cTrbSD2+OrdBagExt())\r\n\t\t#ENDIF\r\n\t\tdbSetOrder(nInd+1)\r\n\r\n\t\tdbSelectArea(\"SD3\")\r\n\t\tIf lCusUnif\r\n\t\t\tcIndice:=\"D3_FILIAL+D3_COD+DTOS(D3_EMISSAO)+D3_SEQCALC+D3_NUMSEQ\"\r\n\t\tElse\r\n\t\t\tIf lLocProc\r\n\t\t\t\tcIndice:=\"D3_FILIAL+D3_COD+DTOS(D3_EMISSAO)+D3_SEQCALC+D3_NUMSEQ\"\r\n\t\t\tElse\r\n\t\t\t\tcIndice:=\"D3_FILIAL+D3_COD+D3_LOCAL+DTOS(D3_EMISSAO)+D3_SEQCALC+D3_NUMSEQ\"\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\tIndRegua(\"SD3\",cTrbSD3,cIndice,,DBFilter(),STR0029)\t//\"Selecionando Registros\"\r\n\t\tnInd := RetIndex(\"SD3\")\r\n\t\t#IFNDEF TOP\r\n\t\tdbSetIndex(cTrbSD3+OrdBagExt())\r\n\t\t#ENDIF\r\n\t\tdbSetOrder(nInd+1)\r\n\tEndIf\r\n\r\n\tdbSelectArea(\"SB1\")\r\n\tIf ! lVEIC\r\n\t\tIf nOrdem == 1\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tcOrder := IndexKey()\r\n\t\tElseIf nOrdem == 2\r\n\t\t\tdbSetOrder(2)\r\n\t\t\tcOrder := IndexKey()\r\n\t\tEndIf\r\n\tElse\r\n\t\tIf nOrdem == 1\r\n\t\t\tcOrder := \"B1_FILIAL+B1_CODITE\"\r\n\t\tElseIf nOrdem == 2\r\n\t\t\tcOrder := \"B1_FILIAL+B1_TIPO+B1_CODITE\"\r\n\t\tEndIf\t\r\n\tEndIf\t\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Transforma parametros Range em expressao Advpl                          ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tMakeAdvplExpr(oReport:uParam)\r\n\r\n\tcCondicao := 'B1_FILIAL == \"'+xFilial(\"SB1\")+'\".And.' \r\n\tcCondicao += 'B1_TIPO >= \"'+mv_par03+'\".And.B1_TIPO <=\"'+mv_par04+'\".And.'\r\n\tIf ! lVEIC\r\n\t\tcCondicao += 'B1_COD >= \"'+mv_par01+'\".And.B1_COD <=\"'+mv_par02+'\".And.'\r\n\tElse\r\n\t\tcCondicao += 'B1_CODITE >= \"'+mv_par01+'\".And.B1_CODITE <=\"'+mv_par02+'\".And.'\r\n\tEndif\t\r\n\tcCondicao += 'B1_GRUPO >= \"'+mv_par18+'\".And.B1_GRUPO <=\"'+mv_par19+'\".And.'\t\r\n\tcCondicao += 'B1_COD <> \"'+Substr(cProdImp,1,Len(B1_COD))+'\"'\r\n\r\n\toReport:Section(1):SetFilter(cCondicao,cOrder)\r\n\r\n\tdbSelectArea(\"SB1\")\r\n\toReport:SetMeter(nTotRegs)\r\n\r\n\tWhile !oReport:Cancel() .And. SB1->(!Eof()) .And. lImpLivro\r\n\r\n\t\tIf oReport:Cancel()\r\n\t\t\tExit\r\n\t\tEndIf\r\n\r\n\t\toReport:IncMeter()\r\n\r\n\t\tdbSelectArea(\"SB2\")\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³ Se nao encontrar no arquivo de saldos ,nao lista ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tIf !dbSeek(xFilial(\"SB2\")+SB1->B1_COD+IF(lCusUnif,\"\",mv_par08))\r\n\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\tdbSkip()\r\n\t\t\tLoop\r\n\t\tEndIf\r\n\r\n\t\t// Nao lista de saldo for igual a zero\r\n\t\tIf mv_par20 == 2 .And. SB2->B2_QATU == 0\r\n\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\tdbSkip()\r\n\t\t\tLoop\r\n\t\tEndIf\r\n\r\n\t\t// Nao lista de saldo for negativo\r\n\t\tIf mv_par21 == 2 .And. SB2->B2_QATU < 0\r\n\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\tdbSkip()\r\n\t\t\tLoop\r\n\t\tEndIf\r\n\r\n\t\taSalAtu   := { 0,0,0,0,0,0,0 }\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³ Calcula o Saldo Inicial do Produto             ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tIf lCusUnif\r\n\t\t\taArea:=GetArea()\r\n\t\t\tdbSelectArea(\"SB2\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSeek(xFilial(\"SB2\")+SB1->B1_COD)\r\n\t\t\tWhile !Eof() .And. B2_FILIAL+B2_COD == xFilial(\"SB2\")+SB1->B1_COD\r\n\t\t\t\taSalAlmox := CalcEst(SB1->B1_COD,SB2->B2_LOCAL,mv_par05)\r\n\t\t\t\tFor i:=1 to Len(aSalAtu)\r\n\t\t\t\t\taSalAtu[i] += aSalAlmox[i]\r\n\t\t\t\tNext i\r\n\t\t\t\tdbSkip()\r\n\t\t\tEnd\r\n\t\t\tRestArea(aArea)\r\n\t\tElse\r\n\t\t\taSalAtu := CalcEst(SB1->B1_COD,mv_par08,mv_par05)\r\n\t\tEndIf\r\n\r\n\t\tcProdAnt  := SB1->B1_COD\r\n\t\tcLocalAnt := mv_par08\r\n\t\tdCntData  := mv_par05\r\n\t\tnRec1 := nRec2 := nRec3 := 0\r\n\t\tnCusMed   := 0\r\n\t\tlFirst1   := .T.\r\n\r\n\t\tdbSelectArea(\"SF1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSelectArea(\"SF2\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSelectArea(\"SD1\")\r\n\t\tdbSeek(xFilial(\"SD1\")+SB1->B1_COD+If(lCusUnif,\"\",mv_par08)+dtos(dcntData),.T.)\r\n\t\tdbSelectArea(\"SD2\")\r\n\t\tdbSeek(xFilial(\"SD2\")+SB1->B1_COD+If(lCusUnif,\"\",mv_par08)+dtos(dcntData),.T.)\r\n\t\tdbSelectArea(\"SD3\")\r\n\t\tdbSeek(xFilial(\"SD3\")+SB1->B1_COD+If(lCusUnif.Or.lLocProc,\"\",mv_par08)+dtos(dcntData),.T.)\r\n\r\n\t\toSection3:Init() \r\n\t\tWhile .T.\r\n\t\t\tlImpSMov := .F.\r\n\t\t\tlImpS3   := .F.\r\n\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\tIf !Eof() .And. D1_FILIAL == xFilial(\"SD1\") .And. D1_DTDIGIT == dCntData .And. D1_COD == cProdAnt .And. If(lCusUnif,.T.,D1_LOCAL == cLocalAnt)\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Despreza Notas Fiscais Lancadas Pelo Modulo do Livro Fiscal  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf D1_ORIGLAN $ \"LF\"\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Verifica se o TES atualiza estoque             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\tdbSeek(xFilial(\"SF4\")+SD1->D1_TES)\r\n\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Executa ponto de entrada para verificar se considera TES que ³\r\n\t\t\t\t//³ NAO ATUALIZA saldos em estoque.                              ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf lIxbConTes .And. SF4->F4_ESTOQUE != \"S\"\r\n\t\t\t\t\tlTesNEst := ExecBlock(\"MTAAVLTES\",.F.,.F.)\r\n\t\t\t\t\tlTesNEst := If(ValType(lTesNEst) # \"L\",.F.,lTesNEst)\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf (SF4->F4_ESTOQUE != \"S\" .And. !lTesNEst)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\t\tcSeqIni := IIF(mv_par16==1,D1_NUMSEQ,D1_SEQCALC+D1_NUMSEQ)\r\n\t\t\t\tcAlias := Alias()\r\n\t\t\tEndIf\r\n\r\n\t\t\tdbSelectArea(\"SD3\")\r\n\t\t\tIf !Eof() .And. D3_FILIAL == xFilial(\"SD3\") .And. D3_EMISSAO == dCntData .And. D3_COD == cProdAnt .And. If(lCusUnif.Or.lLocProc,.T.,D3_LOCAL == cLocalAnt)\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Quando movimento ref apropr. indireta, so considera os         ³\r\n\t\t\t\t//³ movimentos com destino ao almoxarifado de apropriacao indireta.³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tlInverteMov:=.F.\r\n\t\t\t\tIf !D3Valido()\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf D3_LOCAL != cLocalAnt .Or. lCusUnif\r\n\t\t\t\t\tIf !(Substr(D3_CF,3,1) == \"3\")\r\n\t\t\t\t\t\tIf !lCusUnif\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElseIf lPriApropri\r\n\t\t\t\t\t\tlInverteMov:=.T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Caso seja uma transferencia de localizacao verifica se lista   ³\r\n\t\t\t\t//³ o movimento ou nao                                             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tnRecTrf1 := 0\r\n\t\t\t\tnRecTrf2 := 0\r\n\t\t\t\tIf mv_par17 == 2 .And. Substr(D3_CF,3,1) == \"4\"\r\n\t\t\t\t\tIf Len(aRecTRF)>0 .And. (aScan(aRecTRF, SD3->(Recno()))>0)\r\n\t\t\t\t\t\tSD3->(dbSkip())\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcNumSeqTr := SD3->D3_COD+SD3->D3_NUMSEQ+SD3->D3_LOCAL//\"E9\"\r\n\t\t\t\t\tnRegTr    := Recno()\r\n\t\t\t\t\taAreaSD3  := GetArea()\r\n\t\t\t\t\tSD3->(dbSetOrder(4))\r\n\t\t\t\t\tSD3->(dbGoTo(nRegTr))\r\n\t\t\t\t\tnRecTrf1 := SD3->(Recno())\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tIf SD3->D3_COD+SD3->D3_NUMSEQ+SD3->D3_LOCAL == cNumSeqTr//SD3->D3_CHAVE == cNumSeqTr\r\n\t\t\t\t\t\tnRecTrf2 := SD3->(Recno())\r\n\t\t\t\t\t\taAdd(aRecTRF, nRecTrf1)\r\n\t\t\t\t\t\taAdd(aRecTRF, nRecTrf2)\r\n\t\t\t\t\t\tRestArea(aAreaSD3)\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tRestArea(aAreaSD3)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf mv_par16 == 1\r\n\t\t\t\t\tIf D3_NUMSEQ < cSeqIni\r\n\t\t\t\t\t\tcSeqIni := D3_NUMSEQ\r\n\t\t\t\t\t\tcAlias := Alias()\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\tIf D3_SEQCALC+D3_NUMSEQ < cSeqIni\r\n\t\t\t\t\t\tcSeqIni := D3_SEQCALC+D3_NUMSEQ\r\n\t\t\t\t\t\tcAlias := Alias()\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\r\n\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\tIf !Eof() .And. D2_FILIAL == xFilial(\"SD2\") .And. D2_EMISSAO == dCntData .And. D2_COD == cProdAnt .And. If(lCusUnif,.T.,D2_LOCAL == cLocalAnt)\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Despreza Notas Fiscais Lancadas Pelo Modulo do Livro Fiscal  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf D2_ORIGLAN == \"LF\"\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Verifica se o TES atualiza estoque             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\tdbSeek(xFilial(\"SF4\")+SD2->D2_TES)\r\n\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Executa ponto de entrada para verificar se considera TES que ³\r\n\t\t\t\t//³ NAO ATUALIZA saldos em estoque.                              ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf lIxbConTes .And. SF4->F4_ESTOQUE != \"S\"\r\n\t\t\t\t\tlTesNEst := ExecBlock(\"MTAAVLTES\",.F.,.F.)\r\n\t\t\t\t\tlTesNEst := If(ValType(lTesNEst) # \"L\",.F.,lTesNEst)\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf (SF4->F4_ESTOQUE != \"S\" .And. !lTesNEst)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf mv_par16 == 1\r\n\t\t\t\t\tIf D2_NUMSEQ < cSeqIni\r\n\t\t\t\t\t\tcSeqIni := D2_NUMSEQ\r\n\t\t\t\t\t\tcAlias := Alias()\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\tIf D2_SEQCALC+D2_NUMSEQ < cSeqIni\r\n\t\t\t\t\t\tcSeqIni := D2_SEQCALC+D2_NUMSEQ\r\n\t\t\t\t\t\tcAlias := Alias()\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf !Empty(cAlias)\r\n\t\t\t\tdbSelectArea(cAlias)\r\n\t\t\t\tcCampo1 := Subs(cAlias,2,2)+IIF(cAlias==\"SD1\",\"_DTDIGIT\",\"_EMISSAO\")\r\n\t\t\t\tcCampo2 := Subs(cAlias,2,2)+\"_TES\"\r\n\t\t\t\tcCampo3 := Subs(cAlias,2,2)+\"_CF\"\r\n\t\t\t\tcCampo4 := Subs(cAlias,2,2)+IIF(mv_par09 $ \"Ss\",\"_NUMSEQ\",\"_DOC\" )\r\n\r\n\t\t\t\tIf lFirst1\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Calcula o Custo Medio do Produto               ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf aSalAtu[1] > 0 .And. aSalAtu[mv_par11+1] > 0\r\n\t\t\t\t\t\tnCusMed := aSalAtu[mv_par11+1]/aSalAtu[1]\r\n\t\t\t\t\tElseIf aSalAtu[1] == 0 .And. aSalAtu[mv_par11+1] == 0\r\n\t\t\t\t\t\tnCusMed := 0\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tnCusMed := &(Eval(bBloco,\"SB2->B2_CM\",mv_par11))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tMR910ImpS1(aSalAtu,nCusMed,\"\",lVEIC,lCusUnif,oSection1,oSection2)\r\n\t\t\t\t\tlFirst1 := .F.\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\toSection3:Cell(\"dDtMov\"):SetValue(&cCampo1)\t\t\t\r\n\t\t\t\tIf cAlias == \"SD3\"\r\n\t\t\t\t\toSection3:Cell(\"cTES\"):SetValue(D3_TM)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\toSection3:Cell(\"cTES\"):SetValue(&cCampo2)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf ( cPaisLoc==\"BRA\" )\r\n\t\t\t\t\toSection3:Cell(\"cCF\"):Show()\r\n\t\t\t\t\toSection3:Cell(\"cCF\"):SetValue(&cCampo3)\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\toSection3:Cell(\"cCF\"):Hide()\r\n\t\t\t\t\toSection3:Cell(\"cCF\"):SetValue(\"   \")\t\t\t\t\r\n\t\t\t\tEndIf\t\t\t\t\r\n\r\n\t\t\t\toSection3:Cell(\"cDoc\"):SetValue(&cCampo4)\t\t\t\t\t\t\t\r\n\r\n\t\t\t\tDo Case\r\n\t\t\t\t\tCase cAlias = \"SD1\"\r\n\t\t\t\t\tlDev:=MTR910Dev()\r\n\t\t\t\t\tIf D1_TES <= \"500\" .And. !lDev\r\n\t\t\t\t\t\tIf SF1->F1_TIPO != \"C\"\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((&(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))) / D1_QUANT))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Hide()\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(D1_QUANT)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(&(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))))\t\t\t\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Hide()\t\t\t\t\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\taSalAtu[1] += D1_QUANT\r\n\t\t\t\t\t\tnGEntrada += &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\taSalAtu[7] += D1_QTSEGUM\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf SF1->F1_TIPO != \"C\"\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((&(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))) / D1_QUANT))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Hide()\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Hide()\t\t\t\t\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Show()\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\tIf lDev\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(D1_QUANT * -1)\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(&(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))) * -1)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(D1_QUANT)\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(&(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf !lDev\r\n\t\t\t\t\t\t\taSalAtu[1] -= D1_QUANT\r\n\t\t\t\t\t\t\tnGSaida+= &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\taSalAtu[7] -= D1_QTSEGUM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taSalAtu[1] += D1_QUANT\r\n\t\t\t\t\t\t\tnGSaida-= &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\taSalAtu[7] += D1_QTSEGUM\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tnRec1++\r\n\r\n\t\t\t\t\tCase cAlias = \"SD2\"\r\n\t\t\t\t\tlDev:=MTR910Dev()\r\n\t\t\t\t\tIf D2_TES <= \"500\" .Or. lDev\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\t\t\t\t\t\tIf lDev\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(D2_QUANT * -1)\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(&(Eval(bBloco,\"D2_CUSTO\",mv_par11)) * -1)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(D2_QUANT)\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(&(Eval(bBloco,\"D2_CUSTO\",mv_par11)))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf SF2->F2_TIPO != \"C\"\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((&(Eval(bBloco,\"D2_CUSTO\",mv_par11)) / D2_QUANT))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Hide()\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !lDev\r\n\t\t\t\t\t\t\taSalAtu[1] += D2_QUANT\r\n\t\t\t\t\t\t\tnGEntrada+= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[7] += D2_QTSEGUM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Se for devolucao, subtrai nos valores de entrada³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\taSalAtu[1] -= D2_QUANT\r\n\t\t\t\t\t\t\tnGEntrada-= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[7] -= D2_QTSEGUM\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Hide()\r\n\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(0)\r\n\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Show()\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Show()\r\n\r\n\t\t\t\t\t\tIf SF2->F2_TIPO != \"C\"\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((&(Eval(bBloco,\"D2_CUSTO\",mv_par11)) / D2_QUANT))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue(0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Hide()\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(D2_QUANT)\t\t\t\r\n\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(&(Eval(bBloco,\"D2_CUSTO\",mv_par11)))\r\n\r\n\t\t\t\t\t\taSalAtu[1] -= D2_QUANT\r\n\t\t\t\t\t\tnGSaida+=  &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\taSalAtu[7] -= D2_QTSEGUM\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tnRec2++\r\n\r\n\t\t\t\t\tOtherwise\r\n\t\t\t\t\tIf !D3Valido()\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Caso seja uma transferencia de localizacao verifica se lista   ³\r\n\t\t\t\t\t//³ o movimento ou nao                                             ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf mv_par17 == 2 .And. Substr(D3_CF,3,1) == \"4\"\r\n\t\t\t\t\t\tcNumSeqTr := SD3->D3_COD+SD3->D3_NUMSEQ+SD3->D3_LOCAL\r\n\t\t\t\t\t\tnRegTr    := Recno()\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tIf SD3->D3_COD+SD3->D3_NUMSEQ+SD3->D3_LOCAL == cNumSeqTr\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tdbGoto(nRegTr)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tlDev := .F.\r\n\t\t\t\t\tIf\tlInverteMov\r\n\t\t\t\t\t\tIf D3_TM > \"500\"\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(D3_QUANT)\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(&(Eval(bBloco,\"D3_CUSTO\",mv_par11)))\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((&(Eval(bBloco,\"D3_CUSTO\",mv_par11)) / D3_QUANT))\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Hide()\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(0)\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\taSalAtu[1] += D3_QUANT\r\n\t\t\t\t\t\t\tnGEntrada  += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[7] += D3_QTSEGUM\r\n\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(0)\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Show()\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((&(Eval(bBloco,\"D3_CUSTO\",mv_par11)) / D3_QUANT))\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(D3_QUANT)\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(&(Eval(bBloco,\"D3_CUSTO\",mv_par11)))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\taSalAtu[1] -= D3_QUANT\r\n\t\t\t\t\t\t\tnGSaida\t  += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[7] -= D3_QTSEGUM\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf lCusUnif\r\n\t\t\t\t\t\t\tlPriApropri:=.F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf D3_TM <= \"500\"\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(D3_QUANT)\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(&(Eval(bBloco,\"D3_CUSTO\",mv_par11)))\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((&(Eval(bBloco,\"D3_CUSTO\",mv_par11)) / D3_QUANT))\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Hide()\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(0)\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\taSalAtu[1] += D3_QUANT\r\n\t\t\t\t\t\t\tnGEntrada+= &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[7] += D3_QTSEGUM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):Hide()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTQtd\"):SetValue(0)\r\n\t\t\t\t\t\t\toSection3:Cell(\"nENTCus\"):SetValue(0)\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):Show()\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):Show()\r\n\r\n\t\t\t\t\t\t\toSection3:Cell(\"nCusMov\"):SetValue((&(Eval(bBloco,\"D3_CUSTO\",mv_par11)) / D3_QUANT))\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAIQtd\"):SetValue(D3_QUANT)\t\t\t\r\n\t\t\t\t\t\t\toSection3:Cell(\"nSAICus\"):SetValue(&(Eval(bBloco,\"D3_CUSTO\",mv_par11)))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\taSalAtu[1] -= D3_QUANT\r\n\t\t\t\t\t\t\tnGSaida+=  &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[7] -= D3_QTSEGUM\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf lCusUnif\r\n\t\t\t\t\t\t\tlPriApropri:=.T.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tnRec3++\r\n\t\t\t\tEndCase\r\n\r\n\t\t\t\toSection3:Cell(\"nSALDQtd\"):SetValue(aSalAtu[1])\t\t\t\r\n\t\t\t\toSection3:Cell(\"nSALDCus\"):SetValue(aSalAtu[mv_par11+1])\t\t\t\t\t\t\t\r\n\r\n\t\t\t\tIf cPaisLoc <> \"CHI\"\r\n\t\t\t\t\tDo Case\r\n\t\t\t\t\t\tCase cAlias = \"SD3\"  && movimentos (SD3)\r\n\t\t\t\t\t\tIf Empty(D3_OP) .And. Empty(D3_PROJPMS)\r\n\t\t\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('CC'+D3_CC)\t\t\t\r\n\t\t\t\t\t\tElseIf !Empty(D3_PROJPMS)\r\n\t\t\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('PJ'+D3_PROJPMS)\t\t\t\r\n\t\t\t\t\t\tElseIf !Empty(D3_OP)\r\n\t\t\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('OP'+D3_OP)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase cAlias = \"SD1\"  && compras    (SD1)\r\n\t\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('F-'+D1_FORNECE)\r\n\t\t\t\t\t\tCase cAlias = \"SD2\"  && vendas     (SD2)\r\n\t\t\t\t\t\tIf D2_TIPO == \"B\"\r\n\t\t\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('F-'+D2_CLIENTE)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\toSection3:Cell(\"cCCPVPJOP\"):SetValue('C-'+D2_CLIENTE)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndCase\r\n\t\t\t\tEndIf\r\n\t\t\t\tcSeqIni := Replicate(\"z\",6)\r\n\t\t\t\tcAlias := \"\"\r\n\r\n\t\t\t\tIf !lImpSMov \r\n\t\t\t\t\toSection3:PrintLine()\r\n\t\t\t\tEndif\t\r\n\r\n\t\t\t\tIf !lInverteMov .Or. (lInverteMov .And. lPriApropri)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\tEndIf\r\n\t\t\tElse\r\n\t\t\t\tdCntData++\r\n\t\t\tEndIf\r\n\r\n\t\t\tnAcho:=ASCAN(aGrupos,{|x| SB1->B1_TIPO == x[1]})\r\n\t\t\tIf nAcho > 0\r\n\t\t\t\taGrupos[nAcho][2]+=nGEntrada\r\n\t\t\t\taGrupos[nAcho][3]+=nGSaida\r\n\t\t\tElse\r\n\t\t\t\tAADD(aGrupos,{SB1->B1_TIPO,nGEntrada,nGSaida,0})\r\n\t\t\t\tnAcho := Len(aGrupos)\r\n\t\t\tEndIf\r\n\r\n\t\t\tnGEntrada := 0\r\n\t\t\tnGSaida   := 0\r\n\r\n\t\t\tIf dCntData > mv_par06\r\n\t\t\t\tIf nRec1 > 0 .or. nRec2 > 0 .or. nRec3 > 0\r\n\t\t\t\t\tnAcho:=ASCAN(aGrupos,{|x| SB1->B1_TIPO == x[1]})\r\n\t\t\t\t\tIf nAcho > 0\r\n\t\t\t\t\t\taGrupos[nAcho][4]+=aSalAtu[mv_par11+1]\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tAADD(aGrupos,{SB1->B1_TIPO,0,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\tnAcho := Len(aGrupos)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\toReport:PrintText(STR0018+AllTrim(TransForm(aSalAtu[7],cPicB2Qt2)),,oSection3:Cell('nSAICus'):ColPos()) //\"QTD. NA SEGUNDA UM: \"\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tlImpS3   := .T.\r\n\t\t\t\tElse\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Verifica se deve ou nao listar os produtos s/movimento ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf mv_par07 == 1\r\n\t\t\t\t\t\tnAcho:=ASCAN(aGrupos,{|x| SB1->B1_TIPO == x[1]})\r\n\t\t\t\t\t\tIf nAcho > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]+=aSalAtu[mv_par11+1]\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{SB1->B1_TIPO,0,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\tnAcho := Len(aGrupos)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³ Calcula o Custo Medio do Produto               ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf aSalAtu[1] > 0 .And. aSalAtu[mv_par11+1] > 0\r\n\t\t\t\t\t\t\tnCusMed := aSalAtu[mv_par11+1]/aSalAtu[1]\r\n\t\t\t\t\t\tElseIf aSalAtu[1] == 0 .And. aSalAtu[mv_par11+1] == 0\r\n\t\t\t\t\t\t\tnCusMed := 0\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tnCusMed := &(Eval(bBloco,\"SB2->B2_CM\",mv_par11))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tMR910ImpS1(aSalAtu,nCusMed,\"\",lVEIC,lCusUnif,oSection1,oSection2)\r\n\r\n\t\t\t\t\t\tIf !MTR910IsMNT()\r\n\t\t\t\t\t\t\toReport:PrintText(STR0019)\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\t\toReport:ThinLine()\r\n\t\t\t\t\t\t\tlImpSMov := .T.\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\t\t\t\t\t\taProdsMNT := aClone(NGProdMNT())\r\n\t\t\t\t\t\t\t\tIf aScan(aProdsMNT, {|x| AllTrim(x) == AllTrim(SB1->B1_COD) }) == 0\r\n\t\t\t\t\t\t\t\t\toReport:PrintText(STR0019)\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\t\t\t\toReport:ThinLine()\r\n\t\t\t\t\t\t\t\t\tlImpSMov := .T.\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElseIf SB1->B1_COD <> cProdMNT .and. SB1->B1_COD <> cProdTER\r\n\t\t\t\t\t\t\t\toReport:PrintText(STR0019)\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\t\t\toReport:ThinLine()\r\n\t\t\t\t\t\t\t\tlImpSMov := .T.\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tExit\r\n\t\t\tEndIf\r\n\r\n\t\tEndDo\r\n\r\n\t\toSection1:Finish()\r\n\t\toSection2:Finish()\r\n\t\tIf !lImpSMov .And. lImpS3\r\n\t\t\toSection3:Finish()\t\t\t\t\t\t\t\r\n\t\tEndif\t\r\n\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSkip()\r\n\r\n\tEndDo\r\n\r\n\tIf !Empty(aGrupos)\r\n\r\n\t\toReport:SkipLine()    \r\n\t\toReport:PrintText(STR0020) //\"R E S U M O\"\r\n\t\toReport:SkipLine()    \t\t\r\n\r\n\t\tcAlias:=Alias()\r\n\t\tdbSelectArea(\"SX5\")\r\n\t\tFor i:=1 to Len(aGrupos)\r\n\t\t\tdbSeek(xFilial(\"SX5\")+\"02\"+aGrupos[i][1])\r\n\t\t\toReport:PrintText(X5Descri(),oReport:Row())\r\n\t\t\toReport:PrintText(TransForm(aGrupos[i][2],cPicD1Cust),oReport:Row(),oSection3:Cell('nENTCus'):ColPos())\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\toReport:PrintText(TransForm(aGrupos[i][3],cPicD2Cust),oReport:Row(),oSection3:Cell('nSAICus'):ColPos())\r\n\t\t\toReport:PrintText(TransForm(aGrupos[i][4],cPicB2Cust),oReport:Row(),oSection3:Cell('nSALDCus'):ColPos())\t\t\t\t\t\t\r\n\t\t\toReport:SkipLine()    \r\n\t\tNext i\r\n\t\tdbSelectArea(cAlias)\r\n\tEndIf\r\n\r\n\t#ENDIF\t\t\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Impressao de Termos Abertura e Encerramento                  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\n\tIf lImpTermos // Impressao dos Termos\r\n\r\n\t\tIf !lImpLivro \r\n\t\t\toReport:HideHeader() \r\n\t\t\toReport:HideFooter() \r\n\t\t\toReport:HideParamPage()\r\n\t\tEndif\r\n\r\n\t\tcArqAbert:=GetMv(\"MV_LMOD3AB\")\r\n\t\tcArqEncer:=GetMv(\"MV_LMOD3EN\")\r\n\r\n\t\tdbSelectArea(\"SM0\")\r\n\t\taVariaveis:={}\r\n\r\n\t\tFor i:=1 to FCount()\r\n\t\t\tIf FieldName(i)==\"M0_CGC\"\r\n\t\t\t\tAADD(aVariaveis,{FieldName(i),Transform(FieldGet(i),\"@R 99.999.999/9999-99\")})\r\n\t\t\tElse\r\n\t\t\t\tIf FieldName(i)==\"M0_NOME\"\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\t\tAADD(aVariaveis,{FieldName(i),FieldGet(i)})\r\n\t\t\tEndIf\r\n\t\tNext\r\n\r\n\t\tdbSelectArea(\"SX1\")\r\n\t\tdbSeek(PADR(\"MTR910\",nTamSX1)+\"01\")\r\n\r\n\t\tWhile SX1->X1_GRUPO==PADR(\"MTR910\",nTamSX1)\r\n\t\t\tAADD(aVariaveis,{Rtrim(Upper(X1_VAR01)),&(X1_VAR01)})\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\r\n\t\tIf !File(cArqAbert)\r\n\t\t\taSavSet:=__SetSets()\r\n\t\t\t//Editor de Termos de Livros\r\n\t\t\tcArqAbert:=CFGX024(,OemToAnsi(STR0021))\t\t//\" Edi‡„o do Termo de Abertura \"\r\n\t\t\t__SetSets(aSavSet)\r\n\t\t\tSet(24,Set(24),.t.)\r\n\t\tEndIf\r\n\r\n\t\tIf !File(cArqEncer)\r\n\t\t\taSavSet:=__SetSets()\r\n\t\t\t// Editor de Termos de Livros\r\n\t\t\tcArqEncer:=CFGX024(,OemToAnsi(STR0022)) \t\t//\" Edi‡„o do Termo de Encerramento \"\r\n\t\t\t__SetSets(aSavSet)\r\n\t\t\tSet(24,Set(24),.t.)\r\n\t\tEndIf\r\n\r\n\t\tcDriver:=aDriver[4]\r\n\t\toReport:HideHeader()\r\n\t\tIf cArqAbert#NIL\r\n\t\t\toReport:EndPage()\r\n\t\t\tImpTerm(cArqAbert,aVariaveis,&cDriver,,,.T.,oReport)\r\n\t\tEndIf\r\n\r\n\t\tIf cArqEncer#NIL\r\n\t\t\toReport:EndPage()\r\n\t\t\tImpTerm(cArqEncer,aVariaveis,&cDriver,,,.T.,oReport)\r\n\t\tEndIf\r\n\r\n\tEndIf\r\n\r\nReturn NIL\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³MATR910R3 ³ Autor ³ Paulo Boschetti       ³ Data ³ 11.11.92 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Kardex fisico - financeiro (Antigo)                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Generico                                                   ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³         ATUALIZACOES SOFRIDAS DESDE A CONSTRU€AO INICIAL.             ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Programador ³ Data   ³ BOPS ³  Motivo da Alteracao                     ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Rodrigo     ³24/06/98³XXXXXX³Acerto no tamanho do documento para 12    ³±±\r\n±±³            ³        ³      ³posicoes                                  ³±±\r\n±±³Rodrigo Sart³05/11/98³XXXXXX³ Acerto p/ Bug Ano 2000                   ³±±\r\n±±³Bruno Sobies³18/12/98³Melhor³Exclucao impressao do CF nas localizacoes ³±±\r\n±±³Rodrigo Sart³18/01/99³08994A³Inclusao da pergunta Lista p/ NumSeq/Calc ³±±\r\n±±³Cesar       ³25/03/99³20051A³Alteracao do Lay-Out p/ Sair #OP Completa ³±±\r\n±±³Patricia Sal|24/11/99³25325A³Acerto das pictures.                      ³±±\r\n±±³Paulo August³07/12/99³Melhor³Acerto do Lay-Out para o Chile            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Marcos Hirak³17/05/04³XXXXXX³Imprimir B1_CODITE quando for gestao de   ³±±\r\n±±³            ³        ³      ³Concessionarias ( MV_VEICULO = \"S\").      ³±±\r\n±±³            ³        ³      ³                                          ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Descri‡…o ³ PLANO DE MELHORIA CONTINUA                                 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ITEM PMC  ³ Responsavel              ³ Data                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³      01  ³Marcos V. Ferreira        ³09/08/2006 - Bops: 00000094182   ³±±\r\n±±³      02  ³Erike Yuri da Silva       ³21/12/2005                       ³±±\r\n±±³      03  ³Marcos V. Ferreira        ³23/05/2006 - Bops: 00000100000   ³±±\r\n±±³      04  ³Marcos V. Ferreira        ³23/05/2006 - Bops: 00000100000   ³±±\r\n±±³      05  ³                          ³                                 ³±±\r\n±±³      06  ³Marcos V. Ferreira        ³09/08/2006 - Bops: 00000094182   ³±±\r\n±±³      07  ³                          ³                                 ³±±\r\n±±³      08  ³                          ³                                 ³±±\r\n±±³      09  ³                          ³                                 ³±±\r\n±±³      10  ³Erike Yuri da Silva       ³21/12/2005                       ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function Matr910R3()\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Define Variaveis                                             ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLOCAL cDesc1    := STR0001\t//\"Este programa emitir  uma rela‡„o com as movimenta‡”es\"\r\n\tLOCAL cDesc2    := STR0002\t//\"dos produtos Selecionados,Ordenados por Dia.\"\r\n\tLOCAL cDesc3    := \"\"\r\n\tLOCAL titulo    := OemToAnsi(STR0003)\t//\"Kardex Fisico-Financeiro (DIA)\"\r\n\tLOCAL wnrel     := \"MATR910\"\r\n\tLOCAL Tamanho   := \"G\"\r\n\tLOCAL cString   := \"SB1\"\r\n\tLOCAL lRet\t\t:= .T.\r\n\tLOCAL nTamSX1   := Len(SX1->X1_GRUPO)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis tipo Local para SIGAVEI, SIGAPEC e SIGAOFI         ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLOCAL aArea1\t:= Getarea()\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis tipo Private para SIGAVEI, SIGAPEC e SIGAOFI       ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tPRIVATE lVEIC   := UPPER(GETMV(\"MV_VEICULO\"))==\"S\"\r\n\tPRIVATE aSB1Cod := {}\r\n\tPRIVATE aSB1Ite := {}\r\n\tPRIVATE nCOL1\t:= 0\r\n\r\n\tPRIVATE aOrd    := {OemToAnsi(STR0004),OemToAnsi(STR0005)}\t\t//\" Codigo Produto \"###\" Tipo do Produto\"\r\n\tPRIVATE aReturn := { OemToAnsi(STR0006), 1,OemToAnsi(STR0007), 1, 2, 1, \"\",1 }\t\t//\"Zebrado\"###\"Administracao\"\r\n\tPRIVATE aLinha  := { },nLastKey := 0\r\n\tPRIVATE cPerg   := \"MTR910\"\r\n\tPRIVATE bBloco  := { |nV,nX| Trim(nV)+IIf(Valtype(nX)='C',\"\",Str(nX,1)) }\r\n\tPRIVATE aDriver := ReadDriver()\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Verifica se utiliza custo unificado por Empresa/Filial       ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tPRIVATE lCusUnif := IIf(FindFunction(\"A330CusFil\"),A330CusFil(),GetMV(\"MV_CUSFIL\",.F.))\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Ajusta perguntas no SX1 a fim de preparar o relatorio p/     ³\r\n\t//³ custo unificado por empresa                                  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf lCusUnif\r\n\t\tMTR910CUnf(lCusUnif)\r\n\tEndIf\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Ajusta perguntas no SX1 \t\t\t\t\t\t\t\t\t ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tAjustaSX1()\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Remove grupo de perguntas incluido                           ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tdbSelectArea(\"SX1\")\r\n\tdbSetOrder(1)\r\n\tIf dbSeek(PADR(\"MTR910\",nTamSX1)+\"22\")\r\n\t\tRecLock(\"SX1\",.F.)\r\n\t\tdbDelete()\r\n\t\tMsUnlock()\r\n\tEndIf\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Ajustar o SX1 para SIGAVEI, SIGAPEC e SIGAOFI                ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\taSB1Cod\t:= TAMSX3(\"B1_COD\")\r\n\taSB1Ite\t:= TAMSX3(\"B1_CODITE\")\r\n\r\n\tIf lVEIC\r\n\r\n\t\tdbSelectArea(\"SX1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(PADR(cPerg,nTamSX1))\r\n\t\tDo While SX1->X1_GRUPO == PADR(cPerg,nTamSX1) .And. !SX1->(Eof())\r\n\t\t\tIf \"PRODU\" $ Upper(SX1->X1_PERGUNT) .And. Upper(SX1->X1_TIPO) == \"C\" .And. ;\r\n\t\t\t(SX1->X1_TAMANHO <> aSB1Ite[1] .Or. Upper(SX1->X1_F3) <> \"VR4\")\r\n\r\n\t\t\t\tRecLock(\"SX1\",.F.)\r\n\t\t\t\tSX1->X1_TAMANHO := aSB1Ite[1]\r\n\t\t\t\tSX1->X1_F3 := \"VR4\"\r\n\t\t\t\tdbCommit()\r\n\t\t\t\tmsUnLock()\r\n\r\n\t\t\tEndIf\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\t\tdbCommitAll()\r\n\t\tRestArea(aArea1)\r\n\tElse\r\n\t\tdbSelectArea(\"SX1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(PADR(cPerg,nTamSX1))\r\n\t\tDo While SX1->X1_GRUPO == PADR(cPerg,nTamSX1) .And. !SX1->(Eof())\r\n\t\t\tIf \"PRODU\" $ Upper(SX1->X1_PERGUNT) .And. Upper(SX1->X1_TIPO) == \"C\" .And. ;\r\n\t\t\t(SX1->X1_TAMANHO <> aSB1Cod[1] .Or. Upper(SX1->X1_F3) <> \"SB1\")\r\n\r\n\t\t\t\tRecLock(\"SX1\",.F.)\r\n\t\t\t\tSX1->X1_TAMANHO := aSB1Cod[1]\r\n\t\t\t\tSX1->X1_F3 := \"SB1\"\r\n\t\t\t\tdbCommit()\r\n\t\t\t\tmsUnLock()\r\n\r\n\t\t\tEndIf\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\t\tdbCommitAll()\r\n\t\tRestArea(aArea1)\r\n\tEndIf\r\n\r\n\tPergunte(\"MTR910\",.F.)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis utilizadas para parametros                         ³\r\n\t//³ mv_par01        // Do produto                                ³\r\n\t//³ mv_par02        // Ate o produto                             ³\r\n\t//³ mv_par03        // Do tipo                                   ³\r\n\t//³ mv_par04        // Ate o tipo                                ³\r\n\t//³ mv_par05        // Da data                                   ³\r\n\t//³ mv_par06        // Ate a data                                ³\r\n\t//³ mv_par07        // Lista produtos s/movim                    ³\r\n\t//³ mv_par08        // Qual Local (almoxarifado)                 ³\r\n\t//³ mv_par09        // (D)ocumento/(S)equencia                   ³\r\n\t//³ mv_par10        // Saldo a considerar : Atual / Fechamento   ³\r\n\t//³ mv_par11        // Moeda Selecionada (1 a 5)                 ³\r\n\t//³ mv_par12        // Pagina Inicial                            ³\r\n\t//³ mv_par13        // Qtd de Paginas                            ³\r\n\t//³ mv_par14        // Nr do Livro                               ³\r\n\t//³ mv_par15        // Livro/Livro+termos/Termos                 ³\r\n\t//³ mv_par16        // Seq.de Digitacao /Calculo                 ³\r\n\t//³ mv_par17        // Lista Transf Locali (Sim/Nao)             ³\r\n\t//³ mv_par18        // Do Grupo                                  ³\r\n\t//³ mv_par19        // Ate o Grupo                               ³\r\n\t//³ mv_par20        // Prods com Saldo Zero - (Lista/Nao Lista)  ³\r\n\t//³ mv_par21        // Prods com Saldo Neg. - (Lista/Nao Lista)  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Envia controle para a funcao SETPRINT                        ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\n\twnrel:=SetPrint(cString,wnrel,cPerg,@titulo,cDesc1,cDesc2,cDesc3,.F.,aOrd,.f.,Tamanho)\r\n\r\n\tIf nLastKey = 27\r\n\t\tdbClearFilter()\r\n\t\tlRet := .F.\r\n\tEndIf\r\n\r\n\tIf lRet\r\n\r\n\t\tSetDefault(aReturn,cString)\r\n\r\n\t\tIf nLastKey = 27\r\n\t\t\tdbClearFilter()\r\n\t\t\tlRet := .F.\r\n\t\tEndIf\r\n\r\n\t\tIf lRet\r\n\t\t\tRptStatus({|lEnd| R910Imp(@lEnd,wnRel,tamanho,titulo)},titulo)\r\n\t\tEndIf\r\n\r\n\tEndIf\t\t\r\n\r\nReturn NIL\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ R910IMP  ³ Autor ³ Rodrigo de A. Sartorio³ Data ³ 16.11.95 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Chamada do Relatorio                                       ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe   ³ R910Imp(ExpL1,ExpC1,ExpC2,ExpC3)\t\t                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ ExpL1 = var. p/ controle de interrupcao pelo usuario \t    ³±±\r\n±±³          ³ ExpC1 = codigo do relatorio                                ³±±\r\n±±³          ³ ExpC2 = codigo ref. ao tamanho do relatorio (P/M/G)        ³±±\r\n±±³          ³ ExpC3 = titulo do relatorio                                ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ MATR910\t\t\t                                              ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function R910Imp(lEnd,WnRel,tamanho,titulo)\r\n\tStatic lIxbConTes   := NIL\r\n\tLOCAL aDadosTran:={},lContinua := .F.\r\n\tLOCAL nTipo     := 0\r\n\tLOCAL nTam      :=18\r\n\tLOCAL cProdAnt  := \"\"\r\n\tLOCAL cLocalAnt := \"\"\r\n\tLOCAL nCusMed   := 0\r\n\tLOCAL lFirst1   := .T.\r\n\tLOCAL aSalAtu   := { 0,0,0,0,0,0,0 }\r\n\tLocal aSalAlmox := {}\r\n\tLOCAL nEntrada  := 0, nSaida  :=0\r\n\tLOCAL nCEntrada := 0, nCSaida :=0\r\n\tLOCAL nGEntrada := 0, nGSaida :=0\r\n\tLOCAL nRec1,nRec2,nRec3,nSavRec,dCntData\r\n\tLOCAL cPicB2Qt  := PesqPictQt(\"B2_QATU\" ,18)\r\n\tLOCAL cPicB2Qt2 := PesqPictQt(\"B2_QTSEGUM\" ,18)\r\n\tLOCAL cPicD1Qt  := PesqPict(\"SD1\",\"D1_QUANT\" ,18)\r\n\tLOCAL cPicD2Qt  := PesqPict(\"SD2\",\"D2_QUANT\" ,18)\r\n\tLOCAL cPicD3Qt  := PesqPict(\"SD3\",\"D3_QUANT\" ,18)\r\n\tLOCAL cPicB2Cust:= PesqPict(\"SB2\",\"B2_CM\"+Str(mv_par11,1),18)\r\n\tLOCAL cPicD1Cust:= PesqPict(\"SD1\",\"D1_CUSTO\"+IIF(mv_par11 == 1 ,\"\",Str(mv_par11,1)),18)\r\n\tLOCAL cPicD2Cust:= PesqPict(\"SD2\",\"D2_CUSTO\"+Str(mv_par11,1),18)\r\n\tLOCAL cPicD3Cust:= PesqPict(\"SD3\",\"D3_CUSTO\"+Str(mv_par11,1),18)\r\n\tLOCAL lDev  // Flag que indica se nota ‚ devolu‡ao (.T.) ou nao (.F.)\r\n\tLOCAL cCusto, lImpLivro, lImpTermos, cCond1, cCond2\r\n\tLOCAL nAcho,i,aGrupos:={},cAlias\r\n\tLOCAL cTRBSD1\t:= CriaTrab(,.f.)\r\n\tLOCAL cTRBSD2\t:= Subs(cTrbSD1,1,7)+\"A\"\r\n\tLOCAL cTRBSD3\t:= Subs(cTrbSD1,1,7)+\"B\"\r\n\tLOCAL nInd,cIndice\t:=\"\",cCampo1,cCampo2,cCampo3,cCampo4\r\n\tLOCAL cNumSeqTr := \"\" , nRegTr := 0\r\n\tLOCAL cSeqIni \t:= Replicate(\"z\",6)\r\n\tLOCAL nTotRegs  := 0\r\n\t// Indica se esta listando relatorio do almox. de processo\r\n\tLOCAL lLocProc:= mv_par08 == GetMv(\"MV_LOCPROC\")\r\n\t// Indica se deve imprimir movimento invertido (almox. de processo)\r\n\tLOCAL lInverteMov :=.F.\r\n\tLOCAL lPriApropri :=.T.\r\n\r\n\tLocal nTamSX1 := Len(SX1->X1_GRUPO)\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Verifica se existe ponto de entrada                          ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLOCAL lTesNEst := .F.\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Codigo do produto importado - NAO DEVE SER LISTADO           ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLOCAL cProdImp := GETMV(\"MV_PRODIMP\")\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis tipo Local para SIGAVEI, SIGAPEC e SIGAOFI         ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLOCAL cArq1 := \"\"\r\n\tLOCAL nInd1 := 0\r\n\r\n\tLOCAL cAliasTop:=\"KARDEXSQL\"\r\n\r\n\tLOCAL nRecTrf1 := 0\r\n\tLOCAL nRecTrf2 := 0\r\n\tLOCAL aRecTRF  := {}\r\n\r\n\tLOCAL cQueryB1A:= \"\" \r\n\tLOCAL cQueryB1B:= \"\" \r\n\tLOCAL cQueryB1C:= \"\" \r\n\tLOCAL cQueryB1D:= \"\" \r\n\r\n\tLOCAL cProdMNT := GetMv(\"MV_PRODMNT\")\r\n\tLOCAL cProdTER := GetMv(\"MV_PRODTER\")\r\n\tLocal aProdsMNT := {}\r\n\tLocal nX\r\n\r\n\tcProdMNT := cProdMNT + Space(15-Len(cProdMNT))\r\n\tcProdTER := cProdTER + Space(15-Len(cProdTER))\r\n\r\n\tIf\t!lVEIC\r\n\t\tcQueryB1A:= \" AND SB1.B1_COD >= '\"+mv_par01+\"' AND SB1.B1_COD <= '\"+mv_par02+\"'\"\r\n\t\tcQueryB1B:= \" AND SB1.B1_COD = SB1EXS.B1_COD\"\r\n\t\tcQueryB1C:= \" SB1.B1_FILIAL = '\"+xFilial(\"SB1\")+\"' AND SB1.B1_TIPO >= '\"+mv_par03+\"' AND SB1.B1_TIPO <= '\"+mv_par04+\"' AND\"\r\n\t\tcQueryB1D:= \" SB1EXS.B1_FILIAL = '\"+xFilial(\"SB1\")+\"' AND SB1EXS.B1_COD >= '\"+mv_par01+\"' AND SB1EXS.B1_COD <= '\"+mv_par02+\"' AND SB1EXS.B1_TIPO >= '\"+mv_par03+\"' AND SB1EXS.B1_TIPO <= '\"+mv_par04+\"' AND\"\r\n\tElse\r\n\t\tcQueryB1A:= \" AND SB1.B1_CODITE >= '\"+mv_par01+\"' AND SB1.B1_CODITE <= '\"+mv_par02+\"'\"\r\n\t\tcQueryB1B:= \" AND SB1.B1_COD = SB1EXS.B1_COD\"\r\n\t\tcQueryB1C:= \" SB1.B1_FILIAL = '\"+xFilial(\"SB1\")+\"' AND SB1.B1_TIPO >= '\"+mv_par03+\"' AND SB1.B1_TIPO <= '\"+mv_par04+\"' AND\"\r\n\t\tcQueryB1D:= \" SB1EXS.B1_FILIAL = '\"+xFilial(\"SB1\")+\"' AND SB1EXS.B1_CODITE >= '\"+mv_par01+\"' AND SB1EXS.B1_CODITE <= '\"+mv_par02+\"' AND SB1EXS.B1_TIPO >= '\"+mv_par03+\"' AND SB1EXS.B1_TIPO <= '\"+mv_par04+\"' AND\"\r\n\tEndIf\t\r\n\r\n\tcQueryB1C      += \" SB1.B1_GRUPO >= '\"+mv_par18+\"' AND SB1.B1_GRUPO <= '\"+mv_par19+\"' AND SB1.B1_COD <> '\"+cProdimp+\"' AND \"\r\n\tcQueryB1C      += \" SB1.D_E_L_E_T_=' '\"\r\n\tcQueryB1D      += \" SB1EXS.B1_GRUPO >= '\"+mv_par18+\"' AND SB1EXS.B1_GRUPO <= '\"+mv_par19+\"' AND SB1EXS.B1_COD <> '\"+cProdimp+\"' AND \"\r\n\tcQueryB1D      += \" SB1EXS.D_E_L_E_T_=' '\"\r\n\r\n\tlIxbConTes := IF(lIxbConTes == NIL,ExistBlock(\"MTAAVLTES\"),lIxbConTes)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Verifica se utiliza custo unificado por empresa              ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tlCusUnif:=lCusUnif .And. mv_par08 == Repl(\"*\",TamSX3(\"B2_LOCAL\")[1])\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis utilizadas para Impressao do Cabecalho e Rodape    ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tPRIVATE cbtxt := SPACE(10)\r\n\tPRIVATE cbcont:= 0\r\n\tPRIVATE li    := 80\r\n\tPRIVATE m_pag := mv_par12\r\n\r\n\tPRIVATE cabec1  := STR0008+IIF(mv_par09 $ \"Dd\", STR0009,STR0010) +iif(cPaisLoc<>\"CHI\",STR0011,STR0033)\t\t//\"    OPERACAO      \"###\"   DOCUMENTO   \"###\"   SEQUENCIA   \"###\" |               E  N  T  R  A  D  A  S             |         CUSTO MEDIO   |                  S  A  I  D  A  S                |                   S   A   L   D   O             |P.V.,FOR,\"\r\n\tPRIVATE cabec2  := IIF(cPaisLoc == \"CHI\",STR0032,STR0012)\r\n\ttitulo  := STR0013+mv_par08\t\t//\"KARDEX FISICO-FINANCEIRO (DIA) L O C A L :\"\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Inicializa os codigos de caracter Comprimido/Normal da impressora ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tnTipo  := IIF(aReturn[4]==1,15,18)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Adiciona a ordem escolhida ao titulo do relatorio          ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf Type(\"NewHead\")#\"U\"\r\n\t\tNewHead += STR0014+AllTrim(aOrd[aReturn[8]])+STR0015+AllTrim(GetMv(\"MV_SIMB\"+Ltrim(Str(mv_par11))))+\")\"\t\t//\" (Por \"###\" ,em \"\r\n\tElse\r\n\t\tTitulo  += STR0014+AllTrim(aOrd[aReturn[8]])+STR0015+AllTrim(GetMv(\"MV_SIMB\"+Ltrim(Str(mv_par11))))+\")\"\t\t//\" (Por \"###\" ,em \"\r\n\tEndIf\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Adiciona seq de impressao escolhida ao titulo do relatorio ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\ttitulo  +=IIf(mv_par16==1,OemToAnsi(STR0030),OemToAnsi(STR0031))\t// \"(SEQUENCIA)\"###\"(CALCULO)\"\r\n\r\n\tdbSelectArea(\"SB2\")\r\n\tdbSetOrder(1)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Impressao de Termo / Livro                                   ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tDo Case\r\n\t\tCase mv_par15==1 ; lImpLivro:=.t. ; lImpTermos:=.f.\r\n\t\tCase mv_par15==2 ; lImpLivro:=.t. ; lImpTermos:=.t.\r\n\t\tCase mv_par15==3 ; lImpLivro:=.f. ; lImpTermos:=.t.\r\n\tEndCase\r\n\r\n\t#IFDEF TOP\r\n\tIf !(TcSrvType()==\"AS/400\") .And. !(\"POSTGRES\" $ TCGetDB())\r\n\t\tIf lImpLivro\r\n\r\n\t\t\tdbSelectArea(\"SD1\")           // Itens de Entrada\r\n\t\t\tnTotRegs += LastRec()\r\n\r\n\t\t\tdbSelectArea(\"SD2\")           // Itens de Saida\r\n\t\t\tnTotRegs += LastRec()\r\n\r\n\t\t\tdbSelectArea(\"SD3\")           // movimentacoes internas (producao/requisicao/devolucao)\r\n\t\t\tnTotRegs += LastRec()\r\n\r\n\t\t\tdbSelectArea(\"SB2\")\t\t\t  // Saldos em estoque\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tnTotRegs += LastRec()\r\n\r\n\t\t\t//                            1,                 2,               3,        4,           5,          6,            7,                 8,              9,        10,      11,                 12,              13,            14,                 15,                 16,              17,   18,   19                    20,          21,       22,            23,      24\r\n\t\t\t// cQueryD1:= \"SELECT 'SD1' ARQ,SB1.B1_COD PRODUTO,SB1.B1_TIPO TIPO,SB1.B1_UM,SB1.B1_GRUPO,SB1.B1_DESC,SB1.B1_POSIPI,D1_SEQCALC SEQCALC,D1_DTDIGIT DATA,D1_TES TES,D1_CF CF,D1_NUMSEQ SEQUENCIA,D1_DOC DOCUMENTO,D1_SERIE SERIE,D1_QUANT QUANTIDADE,D1_QTSEGUM QUANT2UM,D1_LOCAL ARMAZEM,'' PROJETO,'' OP,'' CC,D1_FORNECE FORNECEDOR,D1_LOJA LOJA,'' PEDIDO,D1_TIPO TIPONF,D1_CUSTO\"\r\n\r\n\t\t\tcQuerySub:= \"SELECT 1 \"\r\n\r\n\t\t\tcQueryD1P := \"SELECT 'SD1' ARQ\"\t\t\t\t// 01\r\n\t\t\tcQueryD1P += \", SB1.B1_COD PRODUTO\"\t\t\t// 02\r\n\t\t\tcQueryD1P += \", SB1.B1_TIPO TIPO\"\t\t\t// 03\r\n\t\t\tcQueryD1P += \", SB1.B1_UM\"\t\t\t\t\t// 04\r\n\t\t\tcQueryD1P += \", SB1.B1_GRUPO\"\t\t\t\t// 05\r\n\t\t\tcQueryD1P += \", SB1.B1_DESC\"\t\t\t\t// 06\r\n\t\t\tcQueryD1P += \", SB1.B1_POSIPI\"\t\t\t\t// 07\r\n\t\t\tcQueryD1P += \", D1_SEQCALC SEQCALC\"\t\t\t// 08\r\n\t\t\tcQueryD1P += \", D1_DTDIGIT DATA\"\t\t\t// 09\r\n\t\t\tcQueryD1P += \", D1_TES TES\"\t\t\t\t\t// 10\r\n\t\t\tcQueryD1P += \", D1_CF CF\"\t\t\t\t\t// 11\r\n\t\t\tcQueryD1P += \", D1_NUMSEQ SEQUENCIA\"\t\t// 12\r\n\t\t\tcQueryD1P += \", D1_DOC DOCUMENTO\"\t\t\t// 13\r\n\t\t\tcQueryD1P += \", D1_SERIE SERIE\"\t\t\t\t// 14\r\n\t\t\tcQueryD1P += \", D1_QUANT QUANTIDADE\"\t\t// 15\r\n\t\t\tcQueryD1P += \", D1_QTSEGUM QUANT2UM\"\t\t// 16\r\n\t\t\tcQueryD1P += \", D1_LOCAL ARMAZEM\"\t\t\t// 17\r\n\t\t\tcQueryD1P += \", '' PROJETO\"\t\t\t\t\t// 18\r\n\t\t\tcQueryD1P += \", '' OP\"\t\t\t\t\t\t// 19\r\n\t\t\tcQueryD1P += \", '' CC\"\t\t\t\t\t\t// 20\r\n\t\t\tcQueryD1P += \", D1_FORNECE FORNECEDOR\"\t\t// 21\r\n\t\t\tcQueryD1P += \", D1_LOJA LOJA\"\t\t\t\t// 22\r\n\t\t\tcQueryD1P += \", '' PEDIDO\"\t\t\t\t\t// 23\r\n\t\t\tcQueryD1P += \", D1_TIPO TIPONF\"\t\t\t\t// 24\r\n\t\t\tcQueryD1P += \", D1_CUSTO\"\t\t\t\t\t// 25\r\n\t\t\t// COLOCA A MOEDA DO CUSTO\r\n\t\t\tIf mv_par11 > 1\r\n\t\t\t\tcQueryD1P += Str(mv_par11,1,0)\t\t\t// 25\r\n\t\t\tEndIf\r\n\t\t\tcQueryD1P += \" CUSTO\"\r\n\t\t\tcQueryD1P += \", '' TRT\" \t\t\t\t\t// 26\r\n\t\t\tIF lVEIC\r\n\t\t\t\tcQueryD1P += \", SB1.B1_CODITE B1_CODITE\"\t// 27\r\n\t\t\tENDIF\r\n\t\t\tcQueryD1P += \", D1_LOTECTL LOTE\"\t    \t// 28\r\n\t\t\tcQueryD1P += \", SD1.R_E_C_N_O_ NRECNO\"\t\t// 29\r\n\r\n\t\t\tcQueryD1 := \" FROM \"\r\n\t\t\t// cQueryD1 += RetSqlName(\"SB1\") + \" SB1 , \"+ RetSqlName(\"SD1\")+ \" SD1 , \"+ RetSqlName(\"SF4\")+\" SF4 \"\r\n\t\t\tcQueryD1 += RetSqlName(\"SB1\") + \" SB1\"\r\n\t\t\tcQueryD1 += (\", \" + RetSqlName(\"SD1\")+ \" SD1 \")\r\n\t\t\tcQueryD1 += (\", \" + RetSqlName(\"SF4\")+ \" SF4 \")\r\n\t\t\tcQueryD1 += \" WHERE SB1.B1_COD = D1_COD\"\r\n\t\t\tcQueryD1 += (\" AND D1_FILIAL = '\"+xFilial(\"SD1\")+\"'\")\r\n\t\t\t// cQueryD1 += \" AND F4_FILIAL = '\"+xFilial(\"SF4\")+\"' AND SD1.D1_TES = F4_CODIGO AND F4_ESTOQUE = 'S'\"\r\n\t\t\tcQueryD1 += (\" AND F4_FILIAL = '\" + xFilial(\"SF4\") + \"'\")\r\n\t\t\tcQueryD1 += (\" AND SD1.D1_TES = F4_CODIGO AND F4_ESTOQUE = 'S'\")\r\n\t\t\t// cQueryD1 += \" AND D1_DTDIGIT >= '\"+DTOS(mv_par05)+\"' AND D1_DTDIGIT <= '\"+DTOS(mv_par06)+\"'\"\r\n\t\t\tcQueryD1 += (\" AND D1_DTDIGIT >= '\" + DTOS(mv_par05) + \"'\")\r\n\t\t\tcQueryD1 += (\" AND D1_DTDIGIT <= '\" + DTOS(mv_par06) + \"'\")\r\n\t\t\tcQueryD1 +=  \" AND D1_ORIGLAN <> 'LF'\"\r\n\t\t\tIf !lCusUnif\r\n\t\t\t\tcQueryD1 += \" AND D1_LOCAL = '\" + mv_par08 + \"'\"\r\n\t\t\tEndIf\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³ Não imprimir o produto MANUTENCAO (MV_PRDMNT) qdo integrado com MNT.       ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf MTR910IsMNT() \r\n\t\t\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\t\t\taProdsMNT := (NGProdMNT())\r\n\t\t\t\t\tFor nX := 1 To Len(aProdsMNT)\r\n\t\t\t\t\t\tcQueryD1 += \" AND SB1.B1_COD <> '\" + aProdsMNT[nX] + \"'\"\r\n\t\t\t\t\tNext nX\r\n\t\t\t\tElse\r\n\t\t\t\t\tcQueryD1 += \" AND SB1.B1_COD <> '\" + cProdMNT + \"'\"\r\n\t\t\t\t\tcQueryD1 += \" AND SB1.B1_COD <> '\" + cProdTER + \"'\"\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\r\n\t\t\tcQueryD1 += \" AND SD1.D_E_L_E_T_=' ' AND SF4.D_E_L_E_T_=' '\"\r\n\r\n\t\t\t// cQueryD2 := \" SELECT 'SD2',SB1.B1_COD,SB1.B1_TIPO,SB1.B1_UM,SB1.B1_GRUPO,SB1.B1_DESC,SB1.B1_POSIPI,D2_SEQCALC,D2_EMISSAO,D2_TES,D2_CF,D2_NUMSEQ,D2_DOC,D2_SERIE,D2_QUANT,D2_QTSEGUM,D2_LOCAL,'','',D2_CLIENTE,D2_LOJA,D2_PEDIDO,D2_TIPO,D2_CUSTO\"\r\n\t\t\tcQueryD2P := \" SELECT 'SD2'\"\r\n\t\t\tcQueryD2P += \", SB1.B1_COD\"\r\n\t\t\tcQueryD2P += \", SB1.B1_TIPO\"\r\n\t\t\tcQueryD2P += \", SB1.B1_UM\"\r\n\t\t\tcQueryD2P += \", SB1.B1_GRUPO\"\r\n\t\t\tcQueryD2P += \", SB1.B1_DESC\"\r\n\t\t\tcQueryD2P += \", SB1.B1_POSIPI\"\r\n\t\t\tcQueryD2P += \", D2_SEQCALC\"\r\n\t\t\tcQueryD2P += \", D2_EMISSAO\"\r\n\t\t\tcQueryD2P += \", D2_TES\"\r\n\t\t\tcQueryD2P += \", D2_CF\"\r\n\t\t\tcQueryD2P += \", D2_NUMSEQ\"\r\n\t\t\tcQueryD2P += \", D2_DOC\"\r\n\t\t\tcQueryD2P += \", D2_SERIE\"\r\n\t\t\tcQueryD2P += \", D2_QUANT\"\r\n\t\t\tcQueryD2P += \", D2_QTSEGUM\"\r\n\t\t\tcQueryD2P += \", D2_LOCAL\"\r\n\t\t\tcQueryD2P += \", ''\"\r\n\t\t\tcQueryD2P += \", ''\"\r\n\t\t\tcQueryD2P += \", ''\"\r\n\t\t\tcQueryD2P += \", D2_CLIENTE\"\r\n\t\t\tcQueryD2P += \", D2_LOJA\"\r\n\t\t\tcQueryD2P += \", D2_PEDIDO\"\r\n\t\t\tcQueryD2P += \", D2_TIPO\"\r\n\t\t\tcQueryD2P += \", D2_CUSTO\"\r\n\t\t\t// COLOCA A MOEDA DO CUSTO\r\n\t\t\tcQueryD2P += Str(mv_par11,1,0)\r\n\t\t\tcQueryD2P += \", ''\"\r\n\t\t\tIf lVEIC\r\n\t\t\t\tcQueryD2P += \", SB1.B1_CODITE\"\t\r\n\t\t\tEndIf\r\n\t\t\tcQueryD2P += \", D2_LOTECTL\"\t\r\n\t\t\tcQueryD2P += \", SD2.R_E_C_N_O_ SD2RECNO\"\t// 29\r\n\r\n\t\t\tcQueryD2 := \" FROM \"\r\n\t\t\tcQueryD2 += RetSqlName(\"SB1\") + \" SB1 , \"+ RetSqlName(\"SD2\")+ \" SD2 , \"+ RetSqlName(\"SF4\")+\" SF4 \"\r\n\t\t\tcQueryD2 += \" WHERE SB1.B1_COD = D2_COD AND D2_FILIAL = '\"+xFilial(\"SD2\")+\"'\"\r\n\t\t\tcQueryD2 += \" AND F4_FILIAL = '\"+xFilial(\"SF4\")+\"' AND SD2.D2_TES = F4_CODIGO AND F4_ESTOQUE = 'S'\"\r\n\t\t\tcQueryD2 += \" AND D2_EMISSAO >= '\"+DTOS(mv_par05)+\"' AND D2_EMISSAO <= '\"+DTOS(mv_par06)+\"'\"\r\n\t\t\tcQueryD2 += \" AND D2_ORIGLAN <> 'LF'\"\r\n\t\t\tIf !lCusUnif\r\n\t\t\t\tcQueryD2 += \" AND D2_LOCAL = '\"+mv_par08+\"'\"\r\n\t\t\tEndIf\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³ Não imprimir o produto MANUTENCAO (MV_PRDMNT) qdo integrado com MNT.       ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf MTR910IsMNT() \r\n\t\t\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\t\t\taProdsMNT := aClone(NGProdMNT())\r\n\t\t\t\t\tFor nX := 1 To Len(aProdsMNT)\r\n\t\t\t\t\t\tcQueryD2 += \" AND SB1.B1_COD <> '\" + aProdsMNT[nX] + \"'\"\r\n\t\t\t\t\tNext nX\r\n\t\t\t\tElse\r\n\t\t\t\t\tcQueryD2 += \" AND SB1.B1_COD <> '\" + cProdMNT + \"'\"\r\n\t\t\t\t\tcQueryD2 += \" AND SB1.B1_COD <> '\" + cProdTER + \"'\"\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\r\n\t\t\tcQueryD2 += \" AND SD2.D_E_L_E_T_=' ' AND SF4.D_E_L_E_T_=' '\"\r\n\r\n\t\t\t// cQueryD3 := \" SELECT 'SD3',SB1.B1_COD,SB1.B1_TIPO,SB1.B1_UM,SB1.B1_GRUPO,SB1.B1_DESC,SB1.B1_POSIPI,D3_SEQCALC,D3_EMISSAO,D3_TM,D3_CF,D3_NUMSEQ,D3_DOC,'',D3_QUANT,D3_QTSEGUM,D3_LOCAL,D3_OP,D3_CC,'','','','',D3_CUSTO\"\r\n\t\t\tcQueryD3P := \" SELECT 'SD3'\"\r\n\t\t\tcQueryD3P += \", SB1.B1_COD\"\r\n\t\t\tcQueryD3P += \", SB1.B1_TIPO\"\r\n\t\t\tcQueryD3P += \", SB1.B1_UM\"\r\n\t\t\tcQueryD3P += \", SB1.B1_GRUPO\"\r\n\t\t\tcQueryD3P += \", SB1.B1_DESC\"\r\n\t\t\tcQueryD3P += \", SB1.B1_POSIPI\"\r\n\t\t\tcQueryD3P += \", D3_SEQCALC\"\r\n\t\t\tcQueryD3P += \", D3_EMISSAO\"\r\n\t\t\tcQueryD3P += \", D3_TM\"\r\n\t\t\tcQueryD3P += \", D3_CF\"\r\n\t\t\tcQueryD3P += \", D3_NUMSEQ\"\r\n\t\t\tcQueryD3P += \", D3_DOC\"\r\n\t\t\tcQueryD3P += \", ''\"\r\n\t\t\tcQueryD3P += \", D3_QUANT\"\r\n\t\t\tcQueryD3P += \", D3_QTSEGUM\"\r\n\t\t\tcQueryD3P += \", D3_LOCAL\"\r\n\t\t\tcQueryD3P += \", D3_PROJPMS\"\r\n\t\t\tcQueryD3P += \", D3_OP\"\r\n\t\t\tcQueryD3P += \", D3_CC\"\r\n\t\t\tcQueryD3P += \", ''\"\r\n\t\t\tcQueryD3P += \", ''\"\r\n\t\t\tcQueryD3P += \", ''\"\r\n\t\t\tcQueryD3P += \", ''\"\r\n\t\t\tcQueryD3P += \", D3_CUSTO\"\r\n\t\t\t// COLOCA A MOEDA DO CUSTO\r\n\t\t\tcQueryD3P += Str(mv_par11,1,0)\r\n\t\t\tcQueryD3P += \", D3_TRT\"\r\n\t\t\tIf lVEIC\r\n\t\t\t\tcQueryD3P += \", SB1.B1_CODITE\"\t\r\n\t\t\tEndIf\r\n\t\t\tcQueryD3P += \", D3_LOTECTL\"\t\r\n\t\t\tcQueryD3P += \", SD3.R_E_C_N_O_ SD3RECNO\"\t\t// 29\r\n\r\n\t\t\tcQueryD3 := \" FROM \"\r\n\t\t\tcQueryD3 += RetSqlName(\"SB1\") + \" SB1 , \"+ RetSqlName(\"SD3\")+ \" SD3 \"\r\n\t\t\tcQueryD3 += \" WHERE SB1.B1_COD = D3_COD AND D3_FILIAL = '\"+xFilial(\"SD3\")+\"' \"\r\n\t\t\tcQueryD3 += \" AND D3_EMISSAO >= '\"+DTOS(mv_par05)+\"' AND D3_EMISSAO <= '\"+DTOS(mv_par06)+\"'\"\r\n\t\t\tIf SuperGetMV('MV_D3ESTOR', .F., 'N') == 'N'\r\n\t\t\t\tcQueryD3 += \" AND D3_ESTORNO <> 'S'\"\r\n\t\t\tEndIf\r\n\t\t\tIf SuperGetMV('MV_D3SERVI', .F., 'N') == 'N' .And. IntDL()\r\n\t\t\t\tcQueryD3 += \" AND ( (D3_SERVIC = '   ') OR (D3_SERVIC <> '   ' AND D3_TM <= '500')  \"\r\n\t\t\t\tcQueryD3 += \" OR  (D3_SERVIC <> '   ' AND D3_TM > '500' AND D3_LOCAL ='\"+SuperGetMV('MV_CQ', .F., '98')+\"') )\"\r\n\t\t\tEndIf\t\t\t\t\t\r\n\t\t\tIf !lCusUnif .And. !lLocProc\r\n\t\t\t\tcQueryD3 += \" AND D3_LOCAL = '\"+mv_par08+\"'\"\r\n\t\t\tEndIf\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³ Não imprimir o produto MANUTENCAO (MV_PRDMNT) qdo integrado com MNT.       ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf MTR910IsMNT() \r\n\t\t\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\t\t\taProdsMNT := (NGProdMNT())\r\n\t\t\t\t\tFor nX := 1 To Len(aProdsMNT)\r\n\t\t\t\t\t\tcQueryD3 += \" AND SB1.B1_COD <> '\" + aProdsMNT[nX] + \"'\"\r\n\t\t\t\t\tNext nX\r\n\t\t\t\tElse\r\n\t\t\t\t\tcQueryD3 += \" AND SB1.B1_COD <> '\" + cProdMNT + \"'\"\r\n\t\t\t\t\tcQueryD3 += \" AND SB1.B1_COD <> '\" + cProdTER + \"'\"\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\r\n\t\t\tcQueryD3 += \" AND SD3.D_E_L_E_T_=' '\"\r\n\r\n\t\t\t// cQuery := cQueryD1 + cQueryB1A + \" AND \" + cQueryB1C + \" UNION \" + cQueryD2 + cQueryB1A + \" AND \" + cQueryB1C+\" UNION \"+cQueryD3+cQueryB1A+\" AND \"+cQueryB1C\r\n\t\t\tcQuery := cQueryD1P + cQueryD1\r\n\t\t\tcQuery += cQueryB1A\r\n\t\t\tcQuery += \" AND \"\r\n\t\t\tcQuery += cQueryB1C\r\n\t\t\tcQuery += \" UNION \"\r\n\t\t\tcQuery += cQueryD2P + cQueryD2\r\n\t\t\tcQuery += cQueryB1A\r\n\t\t\tcQuery += \" AND \"\r\n\t\t\tcQuery += cQueryB1C\r\n\t\t\tcQuery += \" UNION \"\r\n\t\t\tcQuery += cQueryD3P + cQueryD3\r\n\t\t\tcQuery += cQueryB1A\r\n\t\t\tcQuery += \" AND \"\r\n\t\t\tcQuery += cQueryB1C\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³ So inclui as condicoes a seguir qdo lista produtos sem ³\r\n\t\t\t//³ movimento                                              ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf mv_par07 == 1\r\n\t\t\t\t// cQuery2:= cQueryD1+cQueryB1B+\" AND \"+cQueryB1C+\" UNION \"+cQueryD2+cQueryB1B+\" AND \"+cQueryB1C+\" UNION \"+cQueryD3+cQueryB1B+\" AND \"+cQueryB1C\r\n\t\t\t\tcQuery2 := \" AND NOT EXISTS (\" + cQuerySub + cQueryD1\r\n\t\t\t\tcQuery2 += cQueryB1B\r\n\t\t\t\tcQuery2 += \" AND \"\r\n\t\t\t\tcQuery2 += cQueryB1C\r\n\t\t\t\tcQuery2 += \") AND NOT EXISTS (\"\r\n\t\t\t\tcQuery2 += cQuerySub + cQueryD2\r\n\t\t\t\tcQuery2 += cQueryB1B\r\n\t\t\t\tcQuery2 += \" AND \"\r\n\t\t\t\tcQuery2 += cQueryB1C\r\n\t\t\t\tcQuery2 += \") AND NOT EXISTS (\"\r\n\t\t\t\tcQuery2 += cQuerySub + cQueryD3\r\n\t\t\t\tcQuery2 += cQueryB1B\r\n\t\t\t\tcQuery2 += \" AND \"\r\n\t\t\t\tcQuery2 += cQueryB1C + \")\"\r\n\t\t\t\t//                                       1,            2,             3,           4,              5,             6,               7, 8, 9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24\r\n\t\t\t\t// cQuery += \" UNION SELECT 'SB1',SB1EXS.B1_COD,SB1EXS.B1_TIPO,SB1EXS.B1_UM,SB1EXS.B1_GRUPO,SB1EXS.B1_DESC,SB1EXS.B1_POSIPI,'','','','','','','',0 , 0,'','','','','','','',0 \"\r\n\t\t\t\tcQuery += \" UNION SELECT 'SB1'\"\t\t// 01\r\n\t\t\t\tcQuery += \", SB1EXS.B1_COD\"\t\t\t// 02\r\n\t\t\t\tcQuery += \", SB1EXS.B1_TIPO\"\t\t// 03\r\n\t\t\t\tcQuery += \", SB1EXS.B1_UM\"\t\t\t// 04\r\n\t\t\t\tcQuery += \", SB1EXS.B1_GRUPO\"\t\t// 05\r\n\t\t\t\tcQuery += \", SB1EXS.B1_DESC\"\t\t// 06\r\n\t\t\t\tcQuery += \", SB1EXS.B1_POSIPI\"\t\t// 07\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 08\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 09\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 10\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 11\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 12\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 13\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 14\r\n\t\t\t\tcQuery += \", 0\"\t\t\t\t\t\t// 15\r\n\t\t\t\tcQuery += \", 0\"\t\t\t\t\t\t// 16\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 17\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 18\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 19\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 20\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 21\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 22\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 23\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 24\r\n\t\t\t\tcQuery += \", 0\"\t\t\t\t\t\t// 25\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 26\r\n\t\t\t\tIf lVEIC\r\n\t\t\t\t\tcQuery += \", SB1EXS.B1_CODITE CODITE\"\t// 27\r\n\t\t\t\tEndIf\r\n\t\t\t\tcQuery += \", ''\"\t\t\t\t\t// 28\r\n\t\t\t\tcQuery += \", 0\"\t\t\t\t\t\t// 29\r\n\r\n\t\t\t\tcQuery += \" FROM \"+RetSqlName(\"SB1\") + \" SB1EXS WHERE\"\r\n\t\t\t\tcQuery += cQueryB1D\r\n\t\t\t\tcQuery += cQuery2\r\n\t\t\tEndIf\r\n\t\t\tIf aReturn[8]==1\r\n\t\t\t\tIf ! lVEIC\r\n\t\t\t\t\tcQuery += \" ORDER BY 2,9,\"\r\n\t\t\t\tElse\r\n\t\t\t\t\tcQuery += \" ORDER BY 27, 9,\"\r\n\t\t\t\tEndIf\t\r\n\t\t\tElseIf aReturn[8] == 2\r\n\t\t\t\tIf ! lVEIC\r\n\t\t\t\t\tcQUery += \" ORDER BY 3,2,9,\"\r\n\t\t\t\tElse\r\n\t\t\t\t\tcQuery += \" ORDER BY 3, 27, 9,\"\r\n\t\t\t\tEndIf\t\r\n\t\t\tEndIf\r\n\t\t\tIf mv_par16 == 1\r\n\t\t\t\t//\t\t\t\tcQuery += \"17,12\"+IIf(lVEIC,',29',',28')\r\n\t\t\t\tcQuery += \"12\"+IIf(lVEIC,',29',',28')\r\n\t\t\tElse\r\n\t\t\t\tIf lCusUnif\r\n\t\t\t\t\tcQuery+=\"8,12\"+IIf(lVEIC,',29',',28')\r\n\t\t\t\tElse\r\n\t\t\t\t\t//\t\t\t\t\tcQuery+=\"17,8,12\"+IIf(lVEIC,',29',',28')\r\n\t\t\t\t\tcQuery+=\"8\"+IIf(lVEIC,',29',',28')\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\tcQuery:=ChangeQuery(cQuery)\r\n\t\t\tMsAguarde({|| dbUseArea(.T.,\"TOPCONN\",TCGenQry(,,cQuery),cAliasTOP,.F.,.T.)},STR0029)\r\n\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\tSetRegua(nTotRegs)\r\n\t\t\tWhile !Eof()\r\n\t\t\t\tIf lEnd\r\n\t\t\t\t\t@PROW()+1,001 PSay STR0016\t\t//\"CANCELADO PELO OPERADOR\"\r\n\t\t\t\t\tExit\r\n\t\t\t\tEndIf\r\n\t\t\t\tIncRegua()\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Se nao encontrar no arquivo de saldos ,nao lista ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tdbSelectArea(\"SB2\")\r\n\t\t\t\tIf !dbSeek(xFilial(\"SB2\")+(cAliasTop)->PRODUTO+If(lCusUnif,\"\",mv_par08))\r\n\t\t\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\t\t// Nao lista de saldo for igual a zero\r\n\t\t\t\tIf mv_par20 == 2 .And. SB2->B2_QATU == 0\r\n\t\t\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\t\t// Nao lista de saldo for negativo\r\n\t\t\t\tIf mv_par21 == 2 .And. SB2->B2_QATU < 0\r\n\t\t\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\t\tcProdAnt  := (cAliasTop)->PRODUTO\r\n\t\t\t\tcLocalAnt := SB2->B2_LOCAL\r\n\t\t\t\tnEntrada:=nSaida:=0\r\n\t\t\t\tnCEntrada:=nCSaida:=0\r\n\t\t\t\tlFirst:=.F.\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Filtra Registros de Acordo com a Pasta  Filtro da Janela de Impressao  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf !Empty(aReturn[7])\r\n\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(xFilial(\"SB1\")+alltrim(cProdAnt))\r\n\t\t\t\t\t\tIf !&(aReturn[7])\r\n\t\t\t\t\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\t\t\t\t\t(cAliasTop)->(dbSkip())\r\n\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\t\t\t\t(cAliasTop)->(dbSkip())\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf li > 58\r\n\t\t\t\t\tcabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Calcula o Saldo Inicial do Produto             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf lCusUnif\r\n\t\t\t\t\taArea:=GetArea()\r\n\t\t\t\t\taSalAtu  := { 0,0,0,0,0,0,0 }\r\n\t\t\t\t\tdbSelectArea(\"SB2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tdbSeek(cSeek:=xFilial(\"SB2\")+(cAliasTOP)->PRODUTO)\r\n\t\t\t\t\tWhile !Eof() .And. B2_FILIAL+B2_COD == cSeek\r\n\t\t\t\t\t\taSalAlmox := CalcEst((cAliasTOP)->PRODUTO,SB2->B2_LOCAL,mv_par05)\r\n\t\t\t\t\t\tFor i:=1 to Len(aSalAtu)\r\n\t\t\t\t\t\t\taSalAtu[i] += aSalAlmox[i]\r\n\t\t\t\t\t\tNext i\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tEnd\r\n\t\t\t\t\tRestArea(aArea)\r\n\t\t\t\tElse\r\n\t\t\t\t\taSalAtu := CalcEst((cAliasTOP)->PRODUTO,mv_par08,mv_par05)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\taGrupos[nAcho][4] += aSalAtu[mv_par11+1]\r\n\t\t\t\tElse\r\n\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Calcula o Custo Medio do Produto               ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf AsalAtu[1] > 0\r\n\t\t\t\t\tnCusmed := aSalAtu[mv_par11+1]/aSalAtu[1]\r\n\t\t\t\tElseIf AsalAtu[1] == 0 .and. AsalAtu[mv_par11+1] == 0\r\n\t\t\t\t\tnCusMed := 0\r\n\t\t\t\tElse\r\n\t\t\t\t\tSB2->(dbSeek(xFilial(\"SB2\") + (cAliasTOP)->PRODUTO + (cAliasTOP)->ARMAZEM))\r\n\t\t\t\t\tnCusmed := &(\"SB2->B2_CM\" + Str(mv_par11,1))\r\n\t\t\t\tEndIf\r\n\t\t\t\tMR910ImpCb(aSalAtu,nCusMed,@Li,cPicB2Qt,cPicB2Cust, cAliasTop)\r\n\t\t\t\tlFirst1 := .F.\r\n\r\n\t\t\t\tWhile !Eof() .And. (cAliasTop)->PRODUTO = cProdAnt\r\n\t\t\t\t\tIncRegua()\r\n\t\t\t\t\tlContinua := .F.\r\n\t\t\t\t\tIf Alltrim((cAliasTop)->ARQ) $ \"SD1/SD2\"\r\n\t\t\t\t\t\tlFirst:=.T.\r\n\t\t\t\t\t\tSF4->(dbSeek(xFilial(\"SF4\")+(cAliasTop)->TES))\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³ Despreza Notas Fiscais Lancadas Pelo Modulo do Livro Fiscal  ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³ Executa ponto de entrada para verificar se considera TES que ³\r\n\t\t\t\t\t\t//³ NAO ATUALIZA saldos em estoque.                              ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf lIxbConTes .And. SF4->F4_ESTOQUE != \"S\"\r\n\t\t\t\t\t\t\tlTesNEst := ExecBlock(\"MTAAVLTES\",.F.,.F.)\r\n\t\t\t\t\t\t\tlTesNEst := If(ValType(lTesNEst) # \"L\",.F.,lTesNEst)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf SF4->F4_ESTOQUE != \"S\" .And. !lTesNEst\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElseIf Alltrim((cAliasTop)->ARQ) == \"SD3\"\r\n\t\t\t\t\t\tlFirst:=.T.\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³ Quando movimento ref apropr. indireta, so considera os         ³\r\n\t\t\t\t\t\t//³ movimentos com destino ao almoxarifado de apropriacao indireta.³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tlInverteMov:=.F.\r\n\t\t\t\t\t\tIf (cAliasTop)->ARMAZEM != cLocalAnt .Or. lCusUnif\r\n\t\t\t\t\t\t\tIf !(Substr((cAliasTop)->CF,3,1) == \"3\")\r\n\t\t\t\t\t\t\t\tIf !lCusUnif\r\n\t\t\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElseIf lPriApropri\r\n\t\t\t\t\t\t\t\tlInverteMov:=.T.\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³ Caso seja uma transferencia de localizacao verifica se lista   ³\r\n\t\t\t\t\t\t//³ o movimento ou nao                                             ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf mv_par17 == 2 .And. Substr((cAliasTop)->CF,3,1) == \"4\"\r\n\t\t\t\t\t\t\tcNumSeqTr := (cAliasTOP)->(PRODUTO+SEQUENCIA+ARMAZEM)\r\n\t\t\t\t\t\t\taDadosTran:={(cAliasTOP)->TES,(cAliasTOP)->QUANTIDADE,(cAliasTOP)->CUSTO,(cAliasTOP)->QUANT2UM,(cAliasTOP)->TIPO,;\r\n\t\t\t\t\t\t\t(cAliasTOP)->DATA,(cAliasTOP)->CF,(cAliasTOP)->SEQUENCIA,(cAliasTOP)->DOCUMENTO,(cAliasTOP)->PRODUTO,;\r\n\t\t\t\t\t\t\t(cAliasTOP)->OP,(cAliasTOP)->PROJETO,(cAliasTOP)->CC,(cAliasTOP)->ARQ}\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\tIf (cAliasTOP)->(PRODUTO+SEQUENCIA+ARMAZEM) == cNumSeqTr\r\n\t\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tlContinua := .T.\r\n\t\t\t\t\t\t\t\tIf li > 58\r\n\t\t\t\t\t\t\t\t\tcabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tIf lFirst\r\n\t\t\t\t\t\t\t\t\t@Li ,000 PSay STOD(aDadosTran[6])\r\n\t\t\t\t\t\t\t\t\t@Li ,011 PSay aDadosTran[1]\r\n\t\t\t\t\t\t\t\t\tIf ( cPaisLoc==\"BRA\" )\r\n\t\t\t\t\t\t\t\t\t\t@Li ,015 PSay allTrim(aDadosTran[7])\r\n\t\t\t\t\t\t\t\t\t\tIf\tlInverteMov\r\n\t\t\t\t\t\t\t\t\t\t\t@Li , 018 PSay \"*\"\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t@Li , 020 PSay PadR(IIf(mv_par09 $ \"Ss\",aDadosTran[8],aDadosTran[9]),12)+\" |\"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tIf aDadosTran[1] <= \"500\"\r\n\t\t\t\t\t\t\t\t\t@Li ,038 PSay aDadosTran[2] Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t\t@Li ,062 PSay aDadosTran[3] Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t\t@Li ,085 PSay aDadosTran[3] / aDadosTran[2] Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\t\tnEntrada\t  += aDadosTran[2]\r\n\t\t\t\t\t\t\t\t\taSalAtu[1] += aDadosTran[2]\r\n\t\t\t\t\t\t\t\t\tnCEntrada  += aDadosTran[3]\r\n\t\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] += aDadosTran[3]\r\n\t\t\t\t\t\t\t\t\taSalAtu[7] += aDadosTran[4]\r\n\t\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| aDadosTran[5] == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\t\taGrupos[nAcho][2]+=aDadosTran[3]\r\n\t\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]+=aDadosTran[3]\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tAADD(aGrupos,{aDadosTran[5],aDadosTran[3],0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t\t@Li ,085 PSay aDadosTran[3] / aDadosTran[2] Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\t\t@Li ,108 PSay aDadosTran[2] Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t\t@Li ,132 PSay aDadosTran[3] Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\t\tnSaida\t  += aDadosTran[2]\r\n\t\t\t\t\t\t\t\t\taSalAtu[1] -= aDadosTran[2]\r\n\t\t\t\t\t\t\t\t\tnCSaida\t  += aDadosTran[3]\r\n\t\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= aDadosTran[3]\r\n\t\t\t\t\t\t\t\t\taSalAtu[7] -= aDadosTran[4]\r\n\t\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| aDadosTran[5] == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\t\taGrupos[nAcho][3]+=aDadosTran[3]\r\n\t\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]-=aDadosTran[3]\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tAADD(aGrupos,{aDadosTran[5],0,aDadosTran[3],-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tIf li > 58 .And. !lContinua\r\n\t\t\t\t\t\tcabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIf lFirst .And. !lContinua\r\n\t\t\t\t\t\t@Li ,000 PSay STOD(DATA)\r\n\t\t\t\t\t\t@Li ,011 PSay TES\r\n\t\t\t\t\t\tIf ( cPaisLoc==\"BRA\" )\r\n\t\t\t\t\t\t\t@Li ,015 PSay allTrim(CF)\r\n\t\t\t\t\t\t\tIf\tlInverteMov\r\n\t\t\t\t\t\t\t\t@Li , 018 PSay \"*\"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t@Li , 020 PSay PadR(IIF(mv_par09 $ \"Ss\",SEQUENCIA,DOCUMENTO),12)+\" |\"\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tDo Case\r\n\t\t\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD1\" .And. !lContinua\r\n\t\t\t\t\t\tlDev:=MTR910Dev(cAliasTop)\r\n\t\t\t\t\t\tIf (cAliasTOP)->TES <= \"500\" .And. !lDev\r\n\t\t\t\t\t\t\t@Li ,038 PSay (cAliasTOP)->QUANTIDADE Picture cPicD1Qt\r\n\t\t\t\t\t\t\t@Li ,062 PSay (cAliasTOP)->CUSTO Picture cPicD1Cust\r\n\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\tIf (cAliasTOP)->TIPONF != \"C\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE Picture cPicB2Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\tnEntrada   += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\tnCEntrada  += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\taGrupos[nAcho][2]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,(cAliasTOP)->CUSTO,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\tIf (cAliasTOP)->TIPONF != \"C\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE Picture cPicB2Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\tIf lDev\r\n\t\t\t\t\t\t\t\t@Li ,108 PSay Space((nTam-1)-Len(Alltrim(Transform((cAliasTOP)->QUANTIDADE,cPicD1Qt))))+\"(\"+Alltrim(Transform((cAliasTOP)->QUANTIDADE,cPicD1Qt))+\")\"\r\n\t\t\t\t\t\t\t\tcCusto:=Transform((cAliasTOP)->CUSTO,cPicD1Cust)\r\n\t\t\t\t\t\t\t\t@Li ,132 PSay Space((nTam-1)-Len(Alltrim(cCusto)))+\"(\"+Alltrim(cCusto)+\")\"\r\n\t\t\t\t\t\t\t\tnSaida \t  -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\tnCSaida\t  -=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][3]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,-((cAliasTOP)->CUSTO),aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t@Li\t,108 PSay (cAliasTOP)->QUANTIDADE Picture cPicD1Qt\r\n\t\t\t\t\t\t\t\t@Li ,132 PSay (cAliasTOP)->CUSTO Picture cPicD1Cust\r\n\t\t\t\t\t\t\t\tnSaida \t  += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\tnCSaida\t  +=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][3]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,(cAliasTOP)->CUSTO,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase Alltrim((cAliasTop)->ARQ) = \"SD2\" .And. !lContinua\r\n\t\t\t\t\t\tlDev:=MTR910Dev(cAliasTop)\r\n\t\t\t\t\t\tIf (cAliasTOP)->TES <= \"500\" .Or. lDev\r\n\t\t\t\t\t\t\tIf lDev\r\n\t\t\t\t\t\t\t\t@Li ,038 PSay Space((nTam-1)-Len(Alltrim(Transform((cAliasTOP)->QUANTIDADE,cPicD2Qt))))+\"(\"+Alltrim(Transform((cAliasTOP)->QUANTIDADE,cPicD2Qt))+\")\"\r\n\t\t\t\t\t\t\t\tcCusto:=Transform((cAliasTOP)->CUSTO,cPicD2Cust)\r\n\t\t\t\t\t\t\t\t@Li ,062 PSay Space((nTam-1)-Len(Alltrim(cCusto)))+\"(\"+Alltrim(cCusto)+\")\"\r\n\t\t\t\t\t\t\t\tnEntrada   -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\tnCEntrada  -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][2]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,-((cAliasTOP)->CUSTO),0,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t@Li ,038 PSay (cAliasTOP)->QUANTIDADE Picture cPicD2Qt\r\n\t\t\t\t\t\t\t\t@Li ,062 PSay (cAliasTOP)->CUSTO Picture cPicD2Cust\r\n\t\t\t\t\t\t\t\tnEntrada   += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\tnCEntrada  += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][2]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,(cAliasTOP)->CUSTO,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\tIf (cAliasTOP)->TIPONF != \"C\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE Picture cPicB2Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\tIf (cAliasTOP)->TIPONF != \"C\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE Picture cPicB2Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\t@Li ,108 PSay (cAliasTOP)->QUANTIDADE Picture cPicD2Qt\r\n\t\t\t\t\t\t\t@Li ,132 PSay (cAliasTOP)->CUSTO Picture cPicD2Cust\r\n\t\t\t\t\t\t\tnSaida     += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\tnCSaida\t  +=  (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\taGrupos[nAcho][3]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,(cAliasTOP)->CUSTO,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD3\" .And. !lContinua\r\n\t\t\t\t\t\tIf\tlInverteMov\r\n\t\t\t\t\t\t\tIf (cAliasTOP)->TES > \"500\"\r\n\t\t\t\t\t\t\t\t@Li ,038 PSay (cAliasTOP)->QUANTIDADE Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t@Li ,062 PSay (cAliasTOP)->CUSTO Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\tnEntrada  += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\tnCEntrada  +=  (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][2]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,(cAliasTOP)->CUSTO,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@Li ,108 PSay (cAliasTOP)->QUANTIDADE Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t@Li ,132 PSay (cAliasTOP)->CUSTO Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\tnSaida\t  += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\tnCSaida\t  += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][3]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,(cAliasTOP)->CUSTO,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\tIf lCusUnif\r\n\t\t\t\t\t\t\t\tlPriApropri:=.F.\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tIf (cAliasTOP)->TES <= \"500\"\r\n\t\t\t\t\t\t\t\t@Li ,038 PSay (cAliasTOP)->QUANTIDADE Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t@Li ,062 PSay (cAliasTOP)->CUSTO Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\tnEntrada\t  += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\taSalAtu[1] += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\tnCEntrada  +=  (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[7] += (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][2]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,(cAliasTOP)->CUSTO,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (cAliasTOP)->CUSTO / (cAliasTOP)->QUANTIDADE Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@Li ,108 PSay (cAliasTOP)->QUANTIDADE Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t@Li ,132 PSay (cAliasTOP)->CUSTO Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\tnSaida\t  += (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\taSalAtu[1] -= (cAliasTOP)->QUANTIDADE\r\n\t\t\t\t\t\t\t\tnCSaida\t  += (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= (cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\taSalAtu[7] -= (cAliasTOP)->QUANT2UM\r\n\t\t\t\t\t\t\t\tIf (nAcho := ASCAN(aGrupos,{|x| (cAliasTOP)->TIPO == x[1]})) > 0\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][3]+=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\t\taGrupos[nAcho][4]-=(cAliasTOP)->CUSTO\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tAADD(aGrupos,{(cAliasTOP)->TIPO,0,(cAliasTOP)->CUSTO,-(aSalAtu[mv_par11+1])})\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf lCusUnif\r\n\t\t\t\t\t\t\t\tlPriApropri:=.T.\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndCase\r\n\t\t\t\t\tIf lFirst\r\n\t\t\t\t\t\t@ Li,153 PSay \"|\"\r\n\t\t\t\t\t\t@ Li,157 PSay aSalAtu[1] Picture cPicB2Qt\r\n\t\t\t\t\t\t@ Li,177 PSay aSalAtu[mv_par11+1] Picture cPicB2Cust\r\n\t\t\t\t\t\t@ Li,195 PSay \"|\"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tDo Case\r\n\t\t\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD3\" .And. !lContinua\r\n\t\t\t\t\t\tIf Empty((cAliasTOP)->OP) .And. Empty((cAliasTOP)->PROJETO)\r\n\t\t\t\t\t\t\t@ LI,197 PSay 'CC'+(cAliasTOP)->CC\r\n\t\t\t\t\t\tElseIf !Empty((cAliasTOP)->PROJETO)\r\n\t\t\t\t\t\t\t@ LI,197 PSay 'PJ'+(cAliasTOP)->PROJETO\r\n\t\t\t\t\t\tElseIf !Empty((cAliasTOP)->OP)\r\n\t\t\t\t\t\t\t@ LI,207 PSay 'OP'+(cAliasTOP)->OP\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD1\" .And. !lContinua\r\n\t\t\t\t\t\t@ LI,207 PSay 'F-'+(cAliasTOP)->FORNECEDOR\r\n\t\t\t\t\t\tCase Alltrim((cAliasTop)->ARQ) == \"SD2\" .And. !lContinua\r\n\t\t\t\t\t\t@ LI,207 PSay 'P-'+(cAliasTOP)->PEDIDO\r\n\t\t\t\t\t\tCase lContinua .And. aDadosTran[14] == \"SD3\"\r\n\t\t\t\t\t\tIf Empty(aDadosTran[11]) .And. Empty(aDadosTran[12])\r\n\t\t\t\t\t\t\t@ LI,197 PSay 'CC'+aDadosTran[13]\r\n\t\t\t\t\t\tElseIf !Empty(aDadosTran[12])\r\n\t\t\t\t\t\t\t@ LI,197 PSay 'PJ'+aDadosTran[12]\r\n\t\t\t\t\t\tElseIf !Empty(aDadosTran[11])\r\n\t\t\t\t\t\t\t@ LI,207 PSay 'OP'+aDadosTran[11]\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndCase\r\n\t\t\t\t\tLi++\r\n\r\n\t\t\t\t\tIf !lInverteMov .Or. (lInverteMov .And. lPriApropri)\r\n\t\t\t\t\t\tIf !lContinua //Acerto para utilizar o Array aDadosTran[]\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndDo\r\n\r\n\t\t\t\tIf lFirst\r\n\t\t\t\t\tLi ++\r\n\t\t\t\t\t@ li,000 PSay STR0017\t//\"T O T A I S  :\"\r\n\t\t\t\t\t@ Li,038 PSay nEntrada\tPicture cPicD1Qt\r\n\t\t\t\t\t@ Li,062 PSay nCEntrada\tPicture cPicD1Cust\r\n\t\t\t\t\t@ Li,108 PSay nSaida\tPicture cPicD2Qt\r\n\t\t\t\t\t@ Li,132 PSay nCSaida\tPicture cPicD2Cust\r\n\t\t\t\t\t@ Li,157 PSay aSalAtu[1] Picture cPicB2Qt\r\n\t\t\t\t\t@ Li,177 PSay aSalAtu[mv_par11+1] Picture cPicB2Cust\r\n\t\t\t\t\tLi++\r\n\t\t\t\t\t@ Li,135 PSay STR0018\t//\"QTD. NA SEGUNDA UM: \"\r\n\t\t\t\t\t@ Li,157 PSay aSalAtu[7] Picture cPicB2Qt2\r\n\t\t\t\t\tLi++\r\n\t\t\t\t\t@Li ,  0 PSay __PrtThinLine()\r\n\t\t\t\t\tLi++\r\n\t\t\t\tElse\r\n\t\t\t\t\tIf !MTR910IsMNT()\r\n\t\t\t\t\t\tLi--\r\n\t\t\t\t\t\t@Li ,  0 PSay STR0019\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t@Li ,  0 PSay __PrtThinLine()\r\n\t\t\t\t\t\tLi++\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\t\t\t\t\taProdsMNT := aClone(NGProdMNT())\r\n\t\t\t\t\t\t\tIf aScan(aProdsMNT, {|x| AllTrim(x) == AllTrim(SB1->B1_COD) }) == 0\r\n\t\t\t\t\t\t\t\tLi--\r\n\t\t\t\t\t\t\t\t@Li ,  0 PSay STR0019\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t\t\t@Li ,  0 PSay __PrtThinLine()\r\n\t\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElseIf SB1->B1_COD <> cProdMNT .and. SB1->B1_COD <> cProdTER\r\n\t\t\t\t\t\t\tLi--\r\n\t\t\t\t\t\t\t@Li ,  0 PSay STR0019\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t\t@Li ,  0 PSay __PrtThinLine()\r\n\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\tEndIf\r\n\t\t\tEndDo\r\n\t\t\tdbSelectArea(cAliasTop)\r\n\t\t\tdbCloseArea()\r\n\r\n\t\t\tIf !Empty(aGrupos)\r\n\t\t\t\tLi++\r\n\t\t\t\t@ Li,005 PSay STR0020\t\t//\"R E S U M O\"\r\n\t\t\t\tLi++\r\n\t\t\t\tLi++\r\n\t\t\t\tdbSelectArea(\"SX5\")\r\n\t\t\t\tFor i:=1 to Len(aGrupos)\r\n\t\t\t\t\tIf li > 53\r\n\t\t\t\t\t\tcabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tdbSeek(xFilial(\"SX5\")+\"02\"+aGrupos[i][1])\r\n\t\t\t\t\t@ Li,000 PSay X5Descri()\r\n\t\t\t\t\t@ Li,063 PSay aGrupos[i][2] Picture cPicD1Cust\r\n\t\t\t\t\t@ Li,132 PSay aGrupos[i][3] Picture cPicD2Cust\r\n\t\t\t\t\t@ Li,177 PSay aGrupos[i][4] Picture cPicB2Cust\r\n\t\t\t\t\tLi++\r\n\t\t\t\tNext i\r\n\t\t\tEndIf\r\n\t\tEndIf // lImpLivro\r\n\tElse\r\n\t\t#ENDIF\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³ Seta ordens dos arquivos de movimentos e monta IndRegua      ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tIf mv_par16 == 1\r\n\t\t\tIf lCusUnif\r\n\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\tcIndice:=\"D1_FILIAL+D1_COD+DTOS(D1_DTDIGIT)+D1_NUMSEQ\"\r\n\t\t\t\tIndRegua(\"SD1\",cTrbSD1,cIndice,,DBFilter())\r\n\t\t\t\tnInd := RetIndex(\"SD1\")\r\n\t\t\t\t#IFNDEF TOP\r\n\t\t\t\tdbSetIndex(cTrbSD1+OrdBagExt())\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tdbSetOrder(nInd+1)\r\n\r\n\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\tcIndice:=\"D2_FILIAL+D2_COD+DTOS(D2_EMISSAO)+D2_NUMSEQ\"\r\n\t\t\t\tIndRegua(\"SD2\",cTrbSD2,cIndice,,DBFilter())\r\n\t\t\t\tnInd := RetIndex(\"SD2\")\r\n\t\t\t\t#IFNDEF TOP\r\n\t\t\t\tdbSetIndex(cTrbSD2+OrdBagExt())\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tdbSetOrder(nInd+1)\r\n\r\n\t\t\t\tdbSelectArea(\"SD3\")\r\n\t\t\t\tcIndice:=\"D3_FILIAL+D3_COD+DTOS(D3_EMISSAO)+D3_NUMSEQ\"\r\n\t\t\t\tIndRegua(\"SD3\",cTrbSD3,cIndice,,DBFilter())\r\n\t\t\t\tnInd := RetIndex(\"SD3\")\r\n\t\t\t\t#IFNDEF TOP\r\n\t\t\t\tdbSetIndex(cTrbSD3+OrdBagExt())\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tdbSetOrder(nInd+1)\r\n\t\t\tElse\r\n\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\tdbSetOrder(7)\r\n\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\tdbSetOrder(6)\r\n\t\t\t\tdbSelectArea(\"SD3\")\r\n\t\t\t\tdbSetOrder(7)\r\n\t\t\t\tIf lLocProc\r\n\t\t\t\t\tcIndice:=\"D3_FILIAL+D3_COD+DTOS(D3_EMISSAO)+D3_NUMSEQ\"\r\n\t\t\t\t\tIndRegua(\"SD3\",cTrbSD3,cIndice,,DBFilter(),STR0029)\t//\"Selecionando Registros\"\r\n\t\t\t\t\tnInd := RetIndex(\"SD3\")\r\n\t\t\t\t\t#IFNDEF TOP\r\n\t\t\t\t\tdbSetIndex(cTrbSD3+OrdBagExt())\r\n\t\t\t\t\t#ENDIF\r\n\t\t\t\t\tdbSetOrder(nInd+1)\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\tIf lCusUnif\r\n\t\t\t\tcIndice:=\"D1_FILIAL+D1_COD+DTOS(D1_DTDIGIT)+D1_SEQCALC+D1_NUMSEQ\"\r\n\t\t\tElse\r\n\t\t\t\tcIndice:=\"D1_FILIAL+D1_COD+D1_LOCAL+DTOS(D1_DTDIGIT)+D1_SEQCALC+D1_NUMSEQ\"\r\n\t\t\tEndIf\r\n\t\t\tIndRegua(\"SD1\",cTrbSD1,cIndice,,DBFilter(),STR0029)\t//\"Selecionando Registros\"\r\n\t\t\tnInd := RetIndex(\"SD1\")\r\n\t\t\t#IFNDEF TOP\r\n\t\t\tdbSetIndex(cTrbSD1+OrdBagExt())\r\n\t\t\t#ENDIF\r\n\t\t\tdbSetOrder(nInd+1)\r\n\r\n\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\tIf lCusUnif\r\n\t\t\t\tcIndice:=\"D2_FILIAL+D2_COD+DTOS(D2_EMISSAO)+D2_SEQCALC+D2_NUMSEQ\"\r\n\t\t\tElse\r\n\t\t\t\tcIndice:=\"D2_FILIAL+D2_COD+D2_LOCAL+DTOS(D2_EMISSAO)+D2_SEQCALC+D2_NUMSEQ\"\r\n\t\t\tEndIf\r\n\t\t\tIndRegua(\"SD2\",cTrbSD2,cIndice,,DBFilter(),STR0029)\t//\"Selecionando Registros\"\r\n\t\t\tnInd := RetIndex(\"SD2\")\r\n\t\t\t#IFNDEF TOP\r\n\t\t\tdbSetIndex(cTrbSD2+OrdBagExt())\r\n\t\t\t#ENDIF\r\n\t\t\tdbSetOrder(nInd+1)\r\n\r\n\t\t\tdbSelectArea(\"SD3\")\r\n\t\t\tIf lCusUnif\r\n\t\t\t\tcIndice:=\"D3_FILIAL+D3_COD+DTOS(D3_EMISSAO)+D3_SEQCALC+D3_NUMSEQ\"\r\n\t\t\tElse\r\n\t\t\t\tIf lLocProc\r\n\t\t\t\t\tcIndice:=\"D3_FILIAL+D3_COD+DTOS(D3_EMISSAO)+D3_SEQCALC+D3_NUMSEQ\"\r\n\t\t\t\tElse\r\n\t\t\t\t\tcIndice:=\"D3_FILIAL+D3_COD+D3_LOCAL+DTOS(D3_EMISSAO)+D3_SEQCALC+D3_NUMSEQ\"\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\tIndRegua(\"SD3\",cTrbSD3,cIndice,,DBFilter(),STR0029)\t//\"Selecionando Registros\"\r\n\t\t\tnInd := RetIndex(\"SD3\")\r\n\t\t\t#IFNDEF TOP\r\n\t\t\tdbSetIndex(cTrbSD3+OrdBagExt())\r\n\t\t\t#ENDIF\r\n\t\t\tdbSetOrder(nInd+1)\r\n\t\tEndIf\r\n\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tIf ! lVEIC\r\n\r\n\t\t\tIf aReturn[8]==1\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tdbseek(xFilial(\"SB1\")+mv_par01,.T.)\r\n\t\t\t\tcCond1:=\"B1_COD\"\r\n\t\t\t\tcCond2:=\"mv_par02\"\r\n\t\t\tElseIf aReturn[8] == 2\r\n\t\t\t\tdbSetOrder(2)\r\n\t\t\t\tdbseek(xFilial(\"SB1\")+mv_par03,.T.)\r\n\t\t\t\tcCond1:=\"B1_TIPO\"\r\n\t\t\t\tcCond2:=\"mv_par04\"\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\tcArq1\t:= CriaTrab( nil,.F. )\r\n\t\t\tIf aReturn[8]==1\r\n\t\t\t\tIndRegua('SB1',cArq1,\"B1_FILIAL+B1_CODITE\")\r\n\t\t\t\tnInd1\t:= RetIndex('SB1')\r\n\t\t\t\t#IFNDEF TOP\r\n\t\t\t\tdbSetIndex(cArq1 + OrdBagExt())\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tdbSetOrder(nInd1 + 1)\r\n\t\t\t\tdbseek(xFilial(\"SB1\")+mv_par01,.T.)\r\n\t\t\t\tcCond1:=\"B1_CODITE\"\r\n\t\t\t\tcCond2:=\"mv_par02\"\r\n\t\t\tElseIf aReturn[8] == 2\r\n\t\t\t\tIndRegua('SB1',cArq1,\"B1_FILIAL+B1_TIPO+B1_CODITE\")\r\n\t\t\t\tnInd1\t:= RetIndex('SB1')\r\n\t\t\t\t#IFNDEF TOP\r\n\t\t\t\tdbSetIndex(cArq1 + OrdBagExt())\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tdbSetOrder(nInd1 + 1)\r\n\t\t\t\tdbseek(xFilial(\"SB1\")+mv_par03,.T.)\r\n\t\t\t\tcCond1:=\"B1_TIPO\"\r\n\t\t\t\tcCond2:=\"mv_par04\"\r\n\t\t\tEndIf\t\r\n\t\tEndIf\t\r\n\t\tSetRegua(Lastrec()) // Cria Regua\r\n\r\n\t\tWhile !Eof() .and. B1_FILIAL == xFilial(\"SB1\") .and. &cCond1 <= &cCond2 .And. lImpLivro\r\n\r\n\t\t\tIf lEnd\r\n\t\t\t\t@PROW()+1,001 PSay STR0016\t\t//\"CANCELADO PELO OPERADOR\"\r\n\t\t\t\tEXIT\r\n\t\t\tEndIf\r\n\r\n\t\t\tIncRegua()\r\n\r\n\t\t\t// Filtra por Tipo\r\n\t\t\tIf B1_TIPO < mv_par03 .or. B1_TIPO > mv_par04\r\n\t\t\t\tdbSkip()\r\n\t\t\t\tLoop\r\n\t\t\tEndif\r\n\r\n\t\t\tIf ! lVEIC\r\n\t\t\t\tIf B1_COD < mv_par01 .or. B1_COD > mv_par02\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\tElse\r\n\t\t\t\tIf B1_CODITE < mv_par01 .or. B1_CODITE > mv_par02\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\r\n\r\n\t\t\t// Nao lista produto de importacao\r\n\t\t\tIf B1_COD == Substr(cProdImp,1,Len(B1_COD))\r\n\t\t\t\tdbSkip()\r\n\t\t\t\tLoop\r\n\t\t\tEndIf\r\n\r\n\t\t\t// Filtra por Grupo\r\n\t\t\tIf B1_GRUPO < mv_par18 .or. B1_GRUPO > mv_par19\r\n\t\t\t\tdbSkip()\r\n\t\t\t\tLoop\r\n\t\t\tEndIf\r\n\r\n\t\t\tdbSelectArea(\"SB2\")\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³ Se nao encontrar no arquivo de saldos ,nao lista ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf !dbSeek(xFilial(\"SB2\")+SB1->B1_COD+IF(lCusUnif,\"\",mv_par08))\r\n\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\tdbSkip()\r\n\t\t\t\tLoop\r\n\t\t\tEndIf\r\n\r\n\t\t\t// Nao lista de saldo for igual a zero\r\n\t\t\tIf mv_par20 == 2 .And. SB2->B2_QATU == 0\r\n\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\tdbSkip()\r\n\t\t\t\tLoop\r\n\t\t\tEndIf\r\n\r\n\t\t\t// Nao lista de saldo for negativo\r\n\t\t\tIf mv_par21 == 2 .And. SB2->B2_QATU < 0\r\n\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\tdbSkip()\r\n\t\t\t\tLoop\r\n\t\t\tEndIf\r\n\r\n\t\t\tnEntrada:=nSaida:=0\r\n\t\t\tnCEntrada:=nCSaida:=0\r\n\t\t\taSalAtu   := { 0,0,0,0,0,0,0 }\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³ Calcula o Saldo Inicial do Produto             ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf lCusUnif\r\n\t\t\t\taArea:=GetArea()\r\n\t\t\t\tdbSelectArea(\"SB2\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tdbSeek(xFilial(\"SB2\")+SB1->B1_COD)\r\n\t\t\t\tWhile !Eof() .And. B2_FILIAL+B2_COD == xFilial(\"SB2\")+SB1->B1_COD\r\n\t\t\t\t\taSalAlmox := CalcEst(SB1->B1_COD,SB2->B2_LOCAL,mv_par05)\r\n\t\t\t\t\tFor i:=1 to Len(aSalAtu)\r\n\t\t\t\t\t\taSalAtu[i] += aSalAlmox[i]\r\n\t\t\t\t\tNext i\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\tEnd\r\n\t\t\t\tRestArea(aArea)\r\n\t\t\tElse\r\n\t\t\t\taSalAtu := CalcEst(SB1->B1_COD,mv_par08,mv_par05)\r\n\t\t\tEndIf\r\n\r\n\t\t\tcProdAnt  := SB1->B1_COD\r\n\t\t\tcLocalAnt := mv_par08\r\n\t\t\tdCntData  := mv_par05\r\n\t\t\tnRec1 := nRec2 := nRec3 := 0\r\n\t\t\tnCusMed   := 0\r\n\t\t\tlFirst1   := .T.\r\n\r\n\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\tdbSeek(xFilial(\"SD1\")+SB1->B1_COD+If(lCusUnif,\"\",mv_par08)+dtos(dcntData),.T.)\r\n\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\tdbSeek(xFilial(\"SD2\")+SB1->B1_COD+If(lCusUnif,\"\",mv_par08)+dtos(dcntData),.T.)\r\n\t\t\tdbSelectArea(\"SD3\")\r\n\t\t\tdbSeek(xFilial(\"SD3\")+SB1->B1_COD+If(lCusUnif.Or.lLocProc,\"\",mv_par08)+dtos(dcntData),.T.)\r\n\r\n\t\t\tWhile .T.\r\n\t\t\t\tdbSelectArea(\"SD1\")\r\n\r\n\t\t\t\tIf !Eof() .And. D1_FILIAL == xFilial(\"SD1\") .And. D1_DTDIGIT == dCntData .And. D1_COD == cProdAnt .And. If(lCusUnif,.T.,D1_LOCAL == cLocalAnt)\r\n\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Despreza Notas Fiscais Lancadas Pelo Modulo do Livro Fiscal  ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf D1_ORIGLAN $ \"LF\"\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Verifica se o TES atualiza estoque             ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\tdbSeek(xFilial(\"SF4\")+SD1->D1_TES)\r\n\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Executa ponto de entrada para verificar se considera TES que ³\r\n\t\t\t\t\t//³ NAO ATUALIZA saldos em estoque.                              ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf lIxbConTes .And. SF4->F4_ESTOQUE != \"S\"\r\n\t\t\t\t\t\tlTesNEst := ExecBlock(\"MTAAVLTES\",.F.,.F.)\r\n\t\t\t\t\t\tlTesNEst := If(ValType(lTesNEst) # \"L\",.F.,lTesNEst)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIf (SF4->F4_ESTOQUE != \"S\" .And. !lTesNEst)\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcSeqIni := IIF(mv_par16==1,D1_NUMSEQ,D1_SEQCALC+D1_NUMSEQ)\r\n\t\t\t\t\tcAlias := Alias()\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(\"SD3\")\r\n\t\t\t\tIf !Eof() .And. D3_FILIAL == xFilial(\"SD3\") .And. D3_EMISSAO == dCntData .And. D3_COD == cProdAnt .And. If(lCusUnif.Or.lLocProc,.T.,D3_LOCAL == cLocalAnt)\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Quando movimento ref apropr. indireta, so considera os         ³\r\n\t\t\t\t\t//³ movimentos com destino ao almoxarifado de apropriacao indireta.³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tlInverteMov:=.F.\r\n\t\t\t\t\tIf !D3Valido()\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIf D3_LOCAL != cLocalAnt .Or. lCusUnif\r\n\t\t\t\t\t\tIf !(Substr(D3_CF,3,1) == \"3\")\r\n\t\t\t\t\t\t\tIf !lCusUnif\r\n\t\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElseIf lPriApropri\r\n\t\t\t\t\t\t\tlInverteMov:=.T.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Caso seja uma transferencia de localizacao verifica se lista   ³\r\n\t\t\t\t\t//³ o movimento ou nao                                             ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tnRecTrf1 := 0\r\n\t\t\t\t\tnRecTrf2 := 0\r\n\t\t\t\t\tIf mv_par17 == 2 .And. Substr(D3_CF,3,1) == \"4\"\r\n\t\t\t\t\t\tIf Len(aRecTRF)>0 .And. (aScan(aRecTRF, SD3->(Recno()))>0)\r\n\t\t\t\t\t\t\tSD3->(dbSkip())\r\n\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tcNumSeqTr := SD3->D3_COD+SD3->D3_NUMSEQ+SD3->D3_LOCAL//\"E9\"\r\n\t\t\t\t\t\tnRegTr    := Recno()\r\n\t\t\t\t\t\taAreaSD3  := GetArea()\r\n\t\t\t\t\t\tSD3->(dbSetOrder(4))\r\n\t\t\t\t\t\tSD3->(dbGoTo(nRegTr))\r\n\t\t\t\t\t\tnRecTrf1 := SD3->(Recno())\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tIf SD3->D3_COD+SD3->D3_NUMSEQ+SD3->D3_LOCAL == cNumSeqTr//SD3->D3_CHAVE == cNumSeqTr\r\n\t\t\t\t\t\t\tnRecTrf2 := SD3->(Recno())\r\n\t\t\t\t\t\t\taAdd(aRecTRF, nRecTrf1)\r\n\t\t\t\t\t\t\taAdd(aRecTRF, nRecTrf2)\r\n\t\t\t\t\t\t\tRestArea(aAreaSD3)\r\n\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tRestArea(aAreaSD3)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIf mv_par16 == 1\r\n\t\t\t\t\t\tIf D3_NUMSEQ < cSeqIni\r\n\t\t\t\t\t\t\tcSeqIni := D3_NUMSEQ\r\n\t\t\t\t\t\t\tcAlias := Alias()\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf D3_SEQCALC+D3_NUMSEQ < cSeqIni\r\n\t\t\t\t\t\t\tcSeqIni := D3_SEQCALC+D3_NUMSEQ\r\n\t\t\t\t\t\t\tcAlias := Alias()\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\tIf !Eof() .And. D2_FILIAL == xFilial(\"SD2\") .And. D2_EMISSAO == dCntData .And. D2_COD == cProdAnt .And. If(lCusUnif,.T.,D2_LOCAL == cLocalAnt)\r\n\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Despreza Notas Fiscais Lancadas Pelo Modulo do Livro Fiscal  ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf D2_ORIGLAN == \"LF\"\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Verifica se o TES atualiza estoque             ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\tdbSeek(xFilial(\"SF4\")+SD2->D2_TES)\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³ Executa ponto de entrada para verificar se considera TES que ³\r\n\t\t\t\t\t//³ NAO ATUALIZA saldos em estoque.                              ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf lIxbConTes .And. SF4->F4_ESTOQUE != \"S\"\r\n\t\t\t\t\t\tlTesNEst := ExecBlock(\"MTAAVLTES\",.F.,.F.)\r\n\t\t\t\t\t\tlTesNEst := If(ValType(lTesNEst) # \"L\",.F.,lTesNEst)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIf (SF4->F4_ESTOQUE != \"S\" .And. !lTesNEst)\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tLoop\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIf mv_par16 == 1\r\n\t\t\t\t\t\tIf D2_NUMSEQ < cSeqIni\r\n\t\t\t\t\t\t\tcSeqIni := D2_NUMSEQ\r\n\t\t\t\t\t\t\tcAlias := Alias()\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf D2_SEQCALC+D2_NUMSEQ < cSeqIni\r\n\t\t\t\t\t\t\tcSeqIni := D2_SEQCALC+D2_NUMSEQ\r\n\t\t\t\t\t\t\tcAlias := Alias()\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\r\n\r\n\t\t\t\tIf !Empty(cAlias)\r\n\t\t\t\t\tdbSelectArea(cAlias)\r\n\t\t\t\t\tcCampo1 := Subs(cAlias,2,2)+IIF(cAlias==\"SD1\",\"_DTDIGIT\",\"_EMISSAO\")\r\n\t\t\t\t\tcCampo2 := Subs(cAlias,2,2)+\"_TES\"\r\n\t\t\t\t\tcCampo3 := Subs(cAlias,2,2)+\"_CF\"\r\n\t\t\t\t\tcCampo4 := Subs(cAlias,2,2)+IIF(mv_par09 $ \"Ss\",\"_NUMSEQ\",\"_DOC\" )\r\n\r\n\t\t\t\t\tIf li > 53\r\n\t\t\t\t\t\tcabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf lFirst1\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³ Calcula o Custo Medio do Produto               ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf aSalAtu[1] > 0 .And. aSalAtu[mv_par11+1] > 0\r\n\t\t\t\t\t\t\tnCusMed := aSalAtu[mv_par11+1]/aSalAtu[1]\r\n\t\t\t\t\t\tElseIf aSalAtu[1] == 0 .And. aSalAtu[mv_par11+1] == 0\r\n\t\t\t\t\t\t\tnCusMed := 0\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tnCusMed := &(Eval(bBloco,\"SB2->B2_CM\",mv_par11))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tMR910ImpCb(aSalAtu,nCusMed,@Li,cPicB2Qt,cPicB2Cust)\r\n\t\t\t\t\t\tlFirst1 := .F.\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t@Li ,   0 PSay &cCampo1\r\n\t\t\t\t\tIf cAlias == \"SD3\"\r\n\t\t\t\t\t\t@Li ,011 PSay D3_TM\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t@Li ,011 PSay &cCampo2\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIf ( cPaisLoc==\"BRA\" )\r\n\t\t\t\t\t\t@Li , 015 PSay &cCampo3\r\n\t\t\t\t\t\tIf\tlInverteMov\r\n\t\t\t\t\t\t\t@Li , 018 PSay \"*\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t@Li , 020 PSay PadR(&cCampo4,12)+\" |\"\r\n\t\t\t\t\tDo Case\r\n\t\t\t\t\t\tCase cAlias = \"SD1\"\r\n\t\t\t\t\t\tlDev:=MTR910Dev(cAliasTop)\r\n\t\t\t\t\t\tIf D1_TES <= \"500\" .And. !lDev\r\n\t\t\t\t\t\t\t@ Li,038 PSay D1_QUANT Picture cPicD1Qt\r\n\t\t\t\t\t\t\t@ Li,062 PSay &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))) Picture cPicD1Cust\r\n\t\t\t\t\t\t\t@ Li,083 PSay \"|\"\r\n\t\t\t\t\t\t\tIf SF1->F1_TIPO != \"C\"\r\n\t\t\t\t\t\t\t\t@ Li,085 PSay (&(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))) / D1_QUANT) Picture cPicB2Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@ Li,104 PSay \"|\"\r\n\t\t\t\t\t\t\tnEntrada\t+= D1_QUANT\r\n\t\t\t\t\t\t\taSalAtu[1] += D1_QUANT\r\n\t\t\t\t\t\t\tnCEntrada += &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\tnGEntrada += &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\taSalAtu[7] += D1_QTSEGUM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t@ Li,083 PSay \"|\"\r\n\t\t\t\t\t\t\tIf SF1->F1_TIPO != \"C\"\r\n\t\t\t\t\t\t\t\t@ Li,085 PSay (&(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))) / D1_QUANT) Picture cPicB2Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@ Li,104 PSay \"|\"\r\n\t\t\t\t\t\t\tIf lDev\r\n\t\t\t\t\t\t\t\t@ Li,108 PSay Space(17-Len(Alltrim(Transform(D1_QUANT,cPicD1Qt))))+\"(\"+Alltrim(Transform(D1_QUANT,cPicD1Qt))+\")\"\r\n\t\t\t\t\t\t\t\tcCusto:=Transform(&(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))),cPicD1Cust)\r\n\t\t\t\t\t\t\t\t@ Li,132 PSay Space(17-Len(Alltrim(cCusto)))+\"(\"+Alltrim(cCusto)+\")\"\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t@ Li,108 PSay D1_QUANT Picture cPicD1Qt\r\n\t\t\t\t\t\t\t\t@ Li,132 PSay &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11))) Picture cPicD1Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf !lDev\r\n\t\t\t\t\t\t\t\tnSaida+= D1_QUANT\r\n\t\t\t\t\t\t\t\taSalAtu[1] -= D1_QUANT\r\n\t\t\t\t\t\t\t\tnCSaida+= &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\t\tnGSaida+= &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\t\taSalAtu[7] -= D1_QTSEGUM\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tnSaida-= D1_QUANT\r\n\t\t\t\t\t\t\t\taSalAtu[1] += D1_QUANT\r\n\t\t\t\t\t\t\t\tnCSaida-= &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\t\tnGSaida-= &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D1_CUSTO\",iif(mv_par11==1,\" \",mv_par11)))\r\n\t\t\t\t\t\t\t\taSalAtu[7] += D1_QTSEGUM\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tnRec1++\r\n\r\n\t\t\t\t\t\tCase cAlias = \"SD2\"\r\n\t\t\t\t\t\tlDev:=MTR910Dev(cAliasTop)\r\n\t\t\t\t\t\tIf D2_TES <= \"500\" .Or. lDev\r\n\t\t\t\t\t\t\tIf lDev\r\n\t\t\t\t\t\t\t\t@ Li,038 PSay Space(17-Len(Alltrim(Transform(D2_QUANT,cPicD2Qt))))+\"(\"+Alltrim(Transform(D2_QUANT,cPicD2Qt))+\")\"\r\n\t\t\t\t\t\t\t\tcCusto:=Transform(&(Eval(bBloco,\"D2_CUSTO\",mv_par11)),cPicD2Cust)\r\n\t\t\t\t\t\t\t\t@ Li,062 PSay Space(17-Len(Alltrim(cCusto)))+\"(\"+Alltrim(cCusto)+\")\"\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t@ Li,038 PSay D2_QUANT Picture cPicD2Qt\r\n\t\t\t\t\t\t\t\t@ Li,062 PSay &(Eval(bBloco,\"D2_CUSTO\",mv_par11)) Picture cPicD2Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@ Li,083 PSay \"|\"\r\n\t\t\t\t\t\t\tIf SF2->F2_TIPO != \"C\"\r\n\t\t\t\t\t\t\t\t@ Li,085 PSay (&(Eval(bBloco,\"D2_CUSTO\",mv_par11)) / D2_QUANT) Picture cPicB2Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@ Li,104 PSay \"|\"\r\n\t\t\t\t\t\t\tIf !lDev\r\n\t\t\t\t\t\t\t\tnEntrada+= D2_QUANT\r\n\t\t\t\t\t\t\t\taSalAtu[1] += D2_QUANT\r\n\t\t\t\t\t\t\t\tnCEntrada+= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\tnGEntrada+= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[7] += D2_QTSEGUM\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t//³Se for devolucao, subtrai nos valores de entrada³\r\n\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\tnEntrada-= D2_QUANT\r\n\t\t\t\t\t\t\t\taSalAtu[1] -= D2_QUANT\r\n\t\t\t\t\t\t\t\tnCEntrada-= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\tnGEntrada-= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[7] -= D2_QTSEGUM\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t@ Li,083 PSay \"|\"\r\n\t\t\t\t\t\t\tIf SF2->F2_TIPO != \"C\"\r\n\t\t\t\t\t\t\t\t@ Li,085 PSay (&(Eval(bBloco,\"D2_CUSTO\",mv_par11)) / D2_QUANT) Picture cPicB2Cust\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t@ Li,104 PSay \"|\"\r\n\t\t\t\t\t\t\t@ Li,108 PSay D2_QUANT Picture cPicD2Qt\r\n\t\t\t\t\t\t\t@ Li,132 PSay &(Eval(bBloco,\"D2_CUSTO\",mv_par11)) Picture cPicD2Cust\r\n\t\t\t\t\t\t\tnSaida+= D2_QUANT\r\n\t\t\t\t\t\t\taSalAtu[1] -= D2_QUANT\r\n\t\t\t\t\t\t\tnCSaida+=  &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\tnGSaida+=  &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D2_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\taSalAtu[7] -= D2_QTSEGUM\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tnRec2++\r\n\r\n\t\t\t\t\t\tOtherwise\r\n\t\t\t\t\t\tIf !D3Valido()\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³ Caso seja uma transferencia de localizacao verifica se lista   ³\r\n\t\t\t\t\t\t//³ o movimento ou nao                                             ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf mv_par17 == 2 .And. Substr(D3_CF,3,1) == \"4\"\r\n\t\t\t\t\t\t\tcNumSeqTr := SD3->D3_COD+SD3->D3_NUMSEQ+SD3->D3_LOCAL\r\n\t\t\t\t\t\t\tnRegTr    := Recno()\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\tIf SD3->D3_COD+SD3->D3_NUMSEQ+SD3->D3_LOCAL == cNumSeqTr\r\n\t\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\t\t\tLoop\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tdbGoto(nRegTr)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf\tlInverteMov\r\n\t\t\t\t\t\t\tIf D3_TM > \"500\"\r\n\t\t\t\t\t\t\t\t@Li ,038 PSay D3_QUANT Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t@Li ,062 PSay &(Eval(bBloco,\"D3_CUSTO\",mv_par11)) Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (&(Eval(bBloco,\"D3_CUSTO\",mv_par11)) / D3_QUANT) Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\tnEntrada\t  += D3_QUANT\r\n\t\t\t\t\t\t\t\taSalAtu[1] += D3_QUANT\r\n\t\t\t\t\t\t\t\tnCEntrada  += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\tnGEntrada  += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[7] += D3_QTSEGUM\r\n\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\t@Li ,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@Li ,085 PSay (&(Eval(bBloco,\"D3_CUSTO\",mv_par11)) / D3_QUANT) Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t@Li ,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@Li ,108 PSay D3_QUANT Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t@Li ,132 PSay &(Eval(bBloco,\"D3_CUSTO\",mv_par11)) Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\tnSaida\t  += D3_QUANT\r\n\t\t\t\t\t\t\t\taSalAtu[1] -= D3_QUANT\r\n\t\t\t\t\t\t\t\tnCSaida\t  += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\tnGSaida\t  += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[7] -= D3_QTSEGUM\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf lCusUnif\r\n\t\t\t\t\t\t\t\tlPriApropri:=.F.\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tIf D3_TM <= \"500\"\r\n\t\t\t\t\t\t\t\t@ Li,038 PSay D3_QUANT  Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t@ Li,062 PSay &(Eval(bBloco,\"D3_CUSTO\",mv_par11)) Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\t@ Li,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@ Li,085 PSay (&(Eval(bBloco,\"D3_CUSTO\",mv_par11)) / D3_QUANT) Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t@ Li,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\tnEntrada+= D3_QUANT\r\n\t\t\t\t\t\t\t\taSalAtu[1] += D3_QUANT\r\n\t\t\t\t\t\t\t\tnCEntrada+= &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\tnGEntrada+= &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] += &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[7] += D3_QTSEGUM\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t@ Li,083 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@ Li,085 PSay (&(Eval(bBloco,\"D3_CUSTO\",mv_par11)) / D3_QUANT) Picture cPicB2Cust\r\n\t\t\t\t\t\t\t\t@ Li,104 PSay \"|\"\r\n\t\t\t\t\t\t\t\t@ Li,108 PSay D3_QUANT  Picture cPicD3Qt\r\n\t\t\t\t\t\t\t\t@ Li,132 PSay &(Eval(bBloco,\"D3_CUSTO\",mv_par11)) Picture cPicD3Cust\r\n\t\t\t\t\t\t\t\tnSaida+= D3_QUANT\r\n\t\t\t\t\t\t\t\taSalAtu[1] -= D3_QUANT\r\n\t\t\t\t\t\t\t\tnCSaida+=  &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\tnGSaida+=  &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[mv_par11+1] -= &(Eval(bBloco,\"D3_CUSTO\",mv_par11))\r\n\t\t\t\t\t\t\t\taSalAtu[7] -= D3_QTSEGUM\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf lCusUnif\r\n\t\t\t\t\t\t\t\tlPriApropri:=.T.\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tnRec3++\r\n\t\t\t\t\tEndCase\r\n\t\t\t\t\t@ Li,153 PSay \"|\"\r\n\t\t\t\t\t@ Li,157 PSay aSalAtu[1] Picture cPicB2Qt\r\n\t\t\t\t\t@ Li,177 PSay aSalAtu[mv_par11+1] Picture cPicB2Cust\r\n\t\t\t\t\t@ Li,195 PSay \"|\"\r\n\t\t\t\t\tIf cPaisLoc <> \"CHI\"\r\n\t\t\t\t\t\tDo Case\r\n\t\t\t\t\t\t\tCase cAlias = \"SD3\"  && movimentos (SD3)\r\n\t\t\t\t\t\t\tIf Empty(D3_OP) .And. Empty(D3_PROJPMS)\r\n\t\t\t\t\t\t\t\t@ LI,197 PSay 'CC'+D3_CC\r\n\t\t\t\t\t\t\tElseIf !Empty(D3_PROJPMS)\r\n\t\t\t\t\t\t\t\t@ LI,197 PSay 'PJ'+D3_PROJPMS\r\n\t\t\t\t\t\t\tElseIf !Empty(D3_OP)\r\n\t\t\t\t\t\t\t\t@ LI,207 PSay 'OP'+D3_OP\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tCase cAlias = \"SD1\"  && compras    (SD1)\r\n\t\t\t\t\t\t\t@ LI,207 PSay 'F-'+D1_FORNECE\r\n\t\t\t\t\t\t\tCase cAlias = \"SD2\"  && vendas     (SD2)\r\n\t\t\t\t\t\t\tIf D2_TIPO == \"B\"\r\n\t\t\t\t\t\t\t\t@ LI,207 PSay 'F-'+D2_CLIENTE\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t@ LI,207 PSay 'C-'+D2_CLIENTE\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndCase\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tLi++\r\n\t\t\t\t\tcSeqIni := Replicate(\"z\",6)\r\n\t\t\t\t\tcAlias := \"\"\r\n\t\t\t\t\tIf !lInverteMov .Or. (lInverteMov .And. lPriApropri)\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\tdCntData++\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tnAcho:=ASCAN(aGrupos,{|x| SB1->B1_TIPO == x[1]})\r\n\t\t\t\tIf nAcho > 0\r\n\t\t\t\t\taGrupos[nAcho][2]+=nGEntrada\r\n\t\t\t\t\taGrupos[nAcho][3]+=nGSaida\r\n\t\t\t\tElse\r\n\t\t\t\t\tAADD(aGrupos,{SB1->B1_TIPO,nGEntrada,nGSaida,0})\r\n\t\t\t\t\tnAcho := Len(aGrupos)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tnGEntrada := 0\r\n\t\t\t\tnGSaida   := 0\r\n\r\n\t\t\t\tIf dCntData > mv_par06\r\n\t\t\t\t\tIf nRec1 > 0 .or. nRec2 > 0 .or. nRec3 > 0\r\n\t\t\t\t\t\tnAcho:=ASCAN(aGrupos,{|x| SB1->B1_TIPO == x[1]})\r\n\t\t\t\t\t\tIf nAcho > 0\r\n\t\t\t\t\t\t\taGrupos[nAcho][4]+=aSalAtu[mv_par11+1]\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tAADD(aGrupos,{SB1->B1_TIPO,0,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\tnAcho := Len(aGrupos)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tLi ++\r\n\t\t\t\t\t\t@ li,000 PSay STR0017\t//\"T O T A I S  :\"\r\n\t\t\t\t\t\t@ Li,038 PSay nEntrada  Picture cPicD1Qt\r\n\t\t\t\t\t\t@ Li,062 PSay nCEntrada Picture cPicD1Cust\r\n\t\t\t\t\t\t@ Li,108 PSay nSaida    Picture cPicD2Qt\r\n\t\t\t\t\t\t@ Li,132 PSay nCSaida   Picture cPicD2Cust\r\n\t\t\t\t\t\t@ Li,157 PSay aSalAtu[1] Picture cPicB2Qt\r\n\t\t\t\t\t\t@ Li,177 PSay aSalAtu[mv_par11+1] Picture cPicB2Cust\r\n\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t@ Li,135 PSay STR0018   //\"QTD. NA SEGUNDA UM: \"\r\n\t\t\t\t\t\t@ Li,157 PSay aSalAtu[7] Picture cPicB2Qt2\r\n\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t@ Li,000 PSay __PrtThinLine()\r\n\t\t\t\t\t\tLi++\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³ Verifica se deve ou nao listar os produtos s/movimento ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf mv_par07 == 1\r\n\t\t\t\t\t\t\tnAcho:=ASCAN(aGrupos,{|x| SB1->B1_TIPO == x[1]})\r\n\t\t\t\t\t\t\tIf nAcho > 0\r\n\t\t\t\t\t\t\t\taGrupos[nAcho][4]+=aSalAtu[mv_par11+1]\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tAADD(aGrupos,{SB1->B1_TIPO,0,0,aSalAtu[mv_par11+1]})\r\n\t\t\t\t\t\t\t\tnAcho := Len(aGrupos)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf li > 53\r\n\t\t\t\t\t\t\t\tcabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³ Calcula o Custo Medio do Produto               ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\tIf aSalAtu[1] > 0 .And. aSalAtu[mv_par11+1] > 0\r\n\t\t\t\t\t\t\t\tnCusMed := aSalAtu[mv_par11+1]/aSalAtu[1]\r\n\t\t\t\t\t\t\tElseIf aSalAtu[1] == 0 .And. aSalAtu[mv_par11+1] == 0\r\n\t\t\t\t\t\t\t\tnCusMed := 0\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tnCusMed := &(Eval(bBloco,\"SB2->B2_CM\",mv_par11))\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tMR910ImpCb(aSalAtu,nCusMed,@Li,cPicB2Qt,cPicB2Cust)\r\n\r\n\t\t\t\t\t\t\tIf !MTR910IsMNT()\r\n\t\t\t\t\t\t\t\t@Li ,  0 PSay STR0019\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t\t\t@Li ,  0 PSay __PrtThinLine()\r\n\t\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tIf FindFunction(\"NGProdMNT\")\r\n\t\t\t\t\t\t\t\t\taProdsMNT := aClone(NGProdMNT())\r\n\t\t\t\t\t\t\t\t\tIf aScan(aProdsMNT, {|x| AllTrim(x) == AllTrim(SB1->B1_COD) }) == 0\r\n\t\t\t\t\t\t\t\t\t\t@Li ,  0 PSay STR0019\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t\t\t\t\t@Li ,  0 PSay __PrtThinLine()\r\n\t\t\t\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tElseIf SB1->B1_COD <> cProdMNT .and. SB1->B1_COD <> cProdTER\r\n\t\t\t\t\t\t\t\t\t@Li ,  0 PSay STR0019\t//\"NAO HOUVE MOVIMENTACAO PARA ESTE PRODUTO\"\r\n\t\t\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t\t\t\t@Li ,  0 PSay __PrtThinLine()\r\n\t\t\t\t\t\t\t\t\tLi++\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tExit\r\n\t\t\t\tEndIf\r\n\r\n\t\t\tEndDo\r\n\r\n\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\tdbSkip()\r\n\r\n\t\tEndDo\r\n\r\n\t\tIf !Empty(aGrupos)\r\n\t\t\tLi++\r\n\t\t\t@ Li,005 PSay STR0020\t\t//\"R E S U M O\"\r\n\t\t\tLi++\r\n\t\t\tLi++\r\n\t\t\tcAlias:=Alias()\r\n\t\t\tdbSelectArea(\"SX5\")\r\n\t\t\tFor i:=1 to Len(aGrupos)\r\n\t\t\t\tIf li > 53\r\n\t\t\t\t\tcabec(titulo,cabec1,cabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\tEndIf\r\n\t\t\t\tdbSeek(xFilial(\"SX5\")+\"02\"+aGrupos[i][1])\r\n\t\t\t\t@ Li,000 PSay X5Descri()\r\n\t\t\t\t@ Li,063 PSay aGrupos[i][2] Picture cPicD1Cust\r\n\t\t\t\t@ Li,132 PSay aGrupos[i][3] Picture cPicD2Cust\r\n\t\t\t\t@ Li,177 PSay aGrupos[i][4] Picture cPicB2Cust\r\n\t\t\t\tLi++\r\n\t\t\tNext i\r\n\t\t\tdbSelectArea(cAlias)\r\n\t\tEndIf\r\n\r\n\t\t#IFDEF TOP\r\n\tEndIf\t\r\n\t#ENDIF\r\n\r\n\tIf li != 80 .and. lImpLivro\r\n\t\troda(cbcont,cbtxt,Tamanho)\r\n\tEndIf\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Impressao de Termos Abertura e Encerramento                  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\n\tIf lImpTermos // Impressao dos Termos\r\n\r\n\t\tcArqAbert:=GetMv(\"MV_LMOD3AB\")\r\n\t\tcArqEncer:=GetMv(\"MV_LMOD3EN\")\r\n\r\n\t\tdbSelectArea(\"SM0\")\r\n\t\taVariaveis:={}\r\n\r\n\t\tFor i:=1 to FCount()\r\n\t\t\tIf FieldName(i)==\"M0_CGC\"\r\n\t\t\t\tAADD(aVariaveis,{FieldName(i),Transform(FieldGet(i),\"@R 99.999.999/9999-99\")})\r\n\t\t\tElse\r\n\t\t\t\tIf FieldName(i)==\"M0_NOME\"\r\n\t\t\t\t\tLoop\r\n\t\t\t\tEndIf\r\n\t\t\t\tAADD(aVariaveis,{FieldName(i),FieldGet(i)})\r\n\t\t\tEndIf\r\n\t\tNext\r\n\r\n\t\tdbSelectArea(\"SX1\")\r\n\t\tdbSeek(PADR(\"MTR910\",nTamSX1)+\"01\")\r\n\r\n\t\tWhile SX1->X1_GRUPO==PADR(\"MTR910\",nTamSX1)\r\n\t\t\tAADD(aVariaveis,{Rtrim(Upper(X1_VAR01)),&(X1_VAR01)})\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\r\n\t\tIf !File(cArqAbert)\r\n\t\t\taSavSet:=__SetSets()\r\n\t\t\t//Editor de Termos de Livros\r\n\t\t\tcArqAbert:=CFGX024(,OemToAnsi(STR0021))\t\t//\" Edi‡„o do Termo de Abertura \"\r\n\t\t\t__SetSets(aSavSet)\r\n\t\t\tSet(24,Set(24),.t.)\r\n\t\tEndIf\r\n\r\n\t\tIf !File(cArqEncer)\r\n\t\t\taSavSet:=__SetSets()\r\n\t\t\t// Editor de Termos de Livros\r\n\t\t\tcArqEncer:=CFGX024(,OemToAnsi(STR0022)) \t\t//\" Edi‡„o do Termo de Encerramento \"\r\n\t\t\t__SetSets(aSavSet)\r\n\t\t\tSet(24,Set(24),.t.)\r\n\t\tEndIf\r\n\r\n\t\tcDriver:=aDriver[4]\r\n\t\tIf cArqAbert#NIL\r\n\t\t\tImpTerm(cArqAbert,aVariaveis,&cDriver)\r\n\t\tEndIf\r\n\r\n\t\tIf cArqEncer#NIL\r\n\t\t\tImpTerm(cArqEncer,aVariaveis,&cDriver)\r\n\t\tEndIf\r\n\r\n\tEndIf\r\n\r\n\tdbSelectArea(\"SB1\")\r\n\tdbClearFilter()\r\n\tIf !Empty(cArq1) .AND. File(cArq1 + OrdBagExt())\r\n\t\tRetIndex('SB1')\r\n\t\tFERASE(cArq1 + OrdBagExt())\r\n\tEndIf\r\n\tdbSetOrder(1)\r\n\r\n\tdbSelectArea(\"SB2\")\r\n\tdbSetOrder(1)\r\n\r\n\tdbSelectArea(\"SD1\")\r\n\tIf mv_par16 == 2 .Or. lCusUnif\r\n\t\tRetIndex(\"SD1\")\r\n\t\tFerase(cTrbSD1+OrdBagExt())\r\n\tEndIf\r\n\tdbSetOrder(1)\r\n\r\n\tdbSelectArea(\"SD2\")\r\n\tIf mv_par16 == 2 .Or. lCusUnif\r\n\t\tRetIndex(\"SD2\")\r\n\t\tFerase(cTrbSD2+OrdBagExt())\r\n\tEndIf\r\n\tdbSetOrder(1)\r\n\r\n\tdbSelectArea(\"SD3\")\r\n\tIf mv_par16 == 2 .Or. lCusUnif\r\n\t\tRetIndex(\"SD3\")\r\n\t\tFerase(cTrbSD3+OrdBagExt())\r\n\tEndIf\r\n\tdbSetOrder(1)\r\n\r\n\tIf aReturn[5] = 1\r\n\t\tSet Printer To\r\n\t\tdbCommitAll()\r\n\t\tourspool(wnrel)\r\n\tEndIf\r\n\r\n\tMS_FLUSH()\r\nRETURN\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³MR910ImpCb³ Autor ³ Eveli Morasco         ³ Data ³ 28/11/92 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Imprime o cabecalho do item                                ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe   ³ MR910ImpCb(ExpA1,ExpN1,@ExpN2)                             ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ ExpA1 = Array com informacoes do saldo inicial do item     ³±±\r\n±±³          ³   [1] = Saldo inicial em quantidade                        ³±±\r\n±±³          ³   [2] = Saldo inicial em valor                             ³±±\r\n±±³          ³   [3] = Saldo inicial na 2a unidade de medida              ³±±\r\n±±³          ³ ExpN1 = Custo medio do item                                ³±±\r\n±±³          ³ ExpN2 = Numero da linha corrente de impressao              ³±±\r\n±±³          ³ ExpN3 = Picture Do Campo                                   ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ MATR910                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function MR910ImpCb(aSalAtu,nCusMed,Li,cPicB2Qt,cPicB2Cust, cAliasTop) \r\n\tLocal lVer116   := (VAL(GetVersao(.F.)) == 11 .And. GetRpoRelease() >= \"R6\" .Or. VAL(GetVersao(.F.))  > 11)\r\n\r\n\t#IFDEF TOP\r\n\tIf !(TcSrvType()==\"AS/400\") .And. !(\"POSTGRES\" $ TCGetDB())\r\n\t\tIf ! lVEIC\r\n\t\t\t@ Li,000 PSay (cAliasTop)->PRODUTO\r\n\t\t\t@ Li,019 PSay SubStr((cAliasTop)->B1_DESC,1,30)\r\n\t\t\t@ Li,056 PSay STR0023+(cAliasTop)->B1_UM\t\t\t//\"UM : \"\r\n\t\t\t@ Li,068 PSay STR0024+(cAliasTop)->TIPO\t   \t\t//\"TIPO : \"\r\n\t\t\t@ Li,083 PSay STR0025+(cAliasTop)->B1_GRUPO\t\t//\"GRUPO : \"\r\n\t\t\t@ Li,115 PSay STR0026\t\t\t\t\t\t\t\t//\"Custo Medio : \"\r\n\t\t\t@ Li,132 PSay nCusMed\tPicture cPicB2Cust\r\n\t\t\t@ Li,157 PSay aSalAtu[1] Picture cPicB2Qt\r\n\t\t\t@ Li,177 PSay aSalAtu[mv_par11+1] Picture cPicB2Cust\r\n\t\t\tLi++\r\n\t\t\tIf cPaisLoc<>\"CHI\"\r\n\t\t\t\t@ Li,000 PSay STR0027\t\t\t\t\t\t//\"Posicao IPI : \"\r\n\t\t\t\t@ Li,015 PSay (cAliasTop)->B1_POSIPI Picture \"@R 9999.9999.99\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tdbSelectArea(\"SB2\")\r\n\t\t\tdbSeek(xFilial(\"SB2\")+(cAliasTop)->PRODUTO+If(lCusUnif,\"\",mv_par08))\r\n\t\t\tIf lVer116\r\n\t\t\t\t@ Li,035 PSay STR0028+ If(lCusUnif , MV_PAR08 , Posicione(\"NNR\",1,xFilial(\"NNR\")+MV_PAR08,\"NNR_DESCRI\")) //\"Localizacao : \"\r\n\t\t\tElse\r\n\t\t\t\t@ Li,035 PSay STR0028+ If(lCusUnif , MV_PAR08 , SB2->B2_LOCALIZ) //\"Localizacao : \"\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\t@ Li,000 PSay (cAliasTop)->B1_CODITE\r\n\t\t\t@ Li,PCOL() + 2 PSay SubStr((cAliasTop)->B1_DESC,1,30)\t// SB1->B1_DESC\r\n\t\t\t//\t@ Li,056 PSay STR0023+SB1->B1_UM\t\t\t\t\t//\"UM : \"\r\n\t\t\t//\t@ Li,068 PSay STR0024+SB1->B1_TIPO\t\t\t\t\t//\"TIPO : \"\r\n\t\t\t//\t@ Li,083 PSay STR0025+SB1->B1_GRUPO\t\t\t\t\t//\"GRUPO : \"\r\n\t\t\t@ Li,115 PSay STR0026\t\t\t\t\t\t\t\t\t//\"Custo Medio : \"\r\n\t\t\t@ Li,132 PSay nCusMed\tPicture cPicB2Cust\r\n\t\t\t@ Li,157 PSay aSalAtu[1] Picture cPicB2Qt\r\n\t\t\t@ Li,177 PSay aSalAtu[mv_par11+1] Picture cPicB2Cust\r\n\t\t\tLi++\r\n\t\t\t@ Li,000 PSay (cAliasTop)->PRODUTO // SB1->B1_COD\r\n\t\t\t@ Li,PCOL() + 2 PSay STR0023 + (cAliasTop)->B1_UM\t \t// SB1->B1_UM\t\t\t//\"UM : \"\r\n\t\t\t@ Li,PCOL() + 2 PSay STR0024 + (cAliasTop)->TIPO     \t// SB1->B1_TIPO\t\t\t//\"TIPO : \"\r\n\t\t\t@ Li,PCOL() + 2 PSay STR0025 + (cAliasTop)->B1_GRUPO \t// SB1->B1_GRUPO\t\t//\"GRUPO : \"\r\n\t\t\tIf cPaisLoc<>\"CHI\"\r\n\t\t\t\t@ Li,PCOL() + 2 PSay STR0027\t\t\t\t\t\t//\"Posicao IPI : \"\r\n\t\t\t\t@ Li,PCOL() + 2 PSay (cAliasTop)->B1_POSIPI /* SB1->B1_POSIPI */ Picture \"@R 9999.9999.99\"\r\n\t\t\tEndIf\r\n\t\t\tIf lVer116\r\n\t\t\t\t@ Li,PCOL() + 2 PSay STR0028+ If(lCusUnif , MV_PAR08 , Posicione(\"NNR\",1,xFilial(\"NNR\")+MV_PAR08,\"NNR_DESCRI\")) //\"Localizacao : \" \r\n\t\t\tElse\t\t\r\n\t\t\t\t@ Li,PCOL() + 2 PSay STR0028+ If(lCusUnif , MV_PAR08 , SB2->B2_LOCALIZ) //\"Localizacao : \"\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\r\n\t\tdbSelectArea(cAliasTop)\r\n\tElse\t\r\n\t\t#ENDIF\r\n\r\n\t\tIf ! lVEIC\r\n\t\t\t@ Li,000 PSay SB1->B1_COD\r\n\t\t\t@ Li,019 PSay SubStr(SB1->B1_DESC,1,30)\r\n\t\t\t@ Li,056 PSay STR0023+SB1->B1_UM\t\t\t//\"UM : \"\r\n\t\t\t@ Li,068 PSay STR0024+SB1->B1_TIPO\t\t\t//\"TIPO : \"\r\n\t\t\t@ Li,083 PSay STR0025+SB1->B1_GRUPO\t\t\t//\"GRUPO : \"\r\n\t\t\t@ Li,115 PSay STR0026\t\t\t\t\t\t//\"Custo Medio : \"\r\n\t\t\t@ Li,132 PSay nCusMed\tPicture cPicB2Cust\r\n\t\t\t@ Li,157 PSay aSalAtu[1] Picture cPicB2Qt\r\n\t\t\t@ Li,177 PSay aSalAtu[mv_par11+1] Picture cPicB2Cust\r\n\t\t\tLi++\r\n\t\t\tIf cPaisLoc<>\"CHI\"\r\n\t\t\t\t@ Li,000 PSay STR0027\t\t\t\t\t\t//\"Posicao IPI : \"\r\n\t\t\t\t@ Li,015 PSay SB1->B1_POSIPI Picture \"@R 9999.9999.99\"\r\n\t\t\tEndIf\r\n\t\t\tIf lVer116\r\n\t\t\t\t@ Li,035 PSay STR0028+ If(lCusUnif , MV_PAR08 , Posicione(\"NNR\",1,xFilial(\"NNR\")+MV_PAR08,\"NNR_DESCRI\")) //\"Localizacao : \"\r\n\t\t\tElse\r\n\t\t\t\t@ Li,035 PSay STR0028+ If(lCusUnif , MV_PAR08 , SB2->B2_LOCALIZ) //\"Localizacao : \"\t\t\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\t@ Li,000 PSay SB1->B1_CODITE\r\n\t\t\t@ Li,PCOL() + 2 PSay SB1->B1_DESC\r\n\t\t\t//\t@ Li,056 PSay STR0023+SB1->B1_UM\t\t\t//\"UM : \"\r\n\t\t\t//\t@ Li,068 PSay STR0024+SB1->B1_TIPO\t\t\t//\"TIPO : \"\r\n\t\t\t//\t@ Li,083 PSay STR0025+SB1->B1_GRUPO\t\t\t//\"GRUPO : \"\r\n\t\t\t@ Li,115 PSay STR0026\t\t\t\t\t\t\t//\"Custo Medio : \"\r\n\t\t\t@ Li,132 PSay nCusMed\tPicture cPicB2Cust\r\n\t\t\t@ Li,157 PSay aSalAtu[1] Picture cPicB2Qt\r\n\t\t\t@ Li,177 PSay aSalAtu[mv_par11+1] Picture cPicB2Cust\r\n\t\t\tLi++\r\n\t\t\t@ Li,000 PSay SB1->B1_COD\r\n\t\t\t@ Li,PCOL() + 2 PSay STR0023+SB1->B1_UM\t\t\t//\"UM : \"\r\n\t\t\t@ Li,PCOL() + 2  PSay STR0024+SB1->B1_TIPO\t\t\t//\"TIPO : \"\r\n\t\t\t@ Li,PCOL() + 2  PSay STR0025+SB1->B1_GRUPO\t\t//\"GRUPO : \"\r\n\t\t\tIf cPaisLoc<>\"CHI\"\r\n\t\t\t\t@ Li,PCOL() + 2 PSay STR0027\t\t\t\t\t//\"Posicao IPI : \"\r\n\t\t\t\t@ Li,PCOL() + 2 PSay SB1->B1_POSIPI Picture \"@R 9999.9999.99\"\r\n\t\t\tEndIf\r\n\t\t\tIf lVer116\r\n\t\t\t\t@ Li,PCOL() + 2 PSay STR0028+ If(lCusUnif , MV_PAR08 , Posicione(\"NNR\",1,xFilial(\"NNR\")+MV_PAR08,\"NNR_DESCRI\")) //\"Localizacao : \"\r\n\t\t\tElse \r\n\t\t\t\t@ Li,PCOL() + 2 PSay STR0028+ If(lCusUnif , MV_PAR08 , SB2->B2_LOCALIZ) //\"Localizacao : \"\t\t\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\r\n\t\t#IFDEF TOP\r\n\tEndIf\r\n\t#ENDIF\r\n\r\n\tLi += 2\r\nRETURN\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ MTR910val³ Autor ³ Paulo Boschetti       ³ Data ³ 22.12.92 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Generico                                                   ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function Mtr910val()\r\n\tLocal lRet := .T.\r\n\r\n\tIf mv_par09 $ \"dsDS\"\r\n\t\tlRet := .T.\r\n\tElse\r\n\t\tlRet := .F.\r\n\tEndIf\r\n\r\nReturn lRet\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ MTR910Dev³ Autor ³ Rodrigo de A. Sartorio³ Data ³ 25.04.96 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Avalia se item pertence a uma nota de devolu‡ao             ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ MATR910                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function MTR910Dev(cAliasTop)\r\n\tStatic lListaDev := NIL\r\n\tLOCAL lRet:=.F.\r\n\tLOCAL cAlias:=Alias()\r\n\r\n\r\n\t// Identifica se lista dev. na mesma coluna\r\n\tlListaDev := If(ValType(lListaDev)#\"L\",GetMV(\"MV_LISTDEV\"),lListaDev)\r\n\r\n\r\n\t#IFDEF TOP\r\n\tIf !(TcSrvType()==\"AS/400\") .And. !(\"POSTGRES\" $ TCGetDB())\r\n\t\tIf lListaDev .And. (cAliasTop)->ARQ == \"SD1\"\r\n\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\tIf dbSeek(xFilial(\"SF1\")+(cAliasTop)->DOCUMENTO+(cAliasTop)->SERIE+(cAliasTop)->FORNECEDOR+(cAliasTop)->LOJA) .And. (cAliasTop)->TIPONF == \"D\"\r\n\t\t\t\tlRet:=.T.\r\n\t\t\tEndIf\r\n\t\tElseIf lListaDev .And. (cAliasTop)->ARQ == \"SD2\"\r\n\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\tIf dbSeek(xFilial(\"SF2\")+(cAliasTop)->DOCUMENTO+(cAliasTop)->SERIE+(cAliasTop)->FORNECEDOR+(cAliasTop)->LOJA) .And. (cAliasTop)->TIPONF == \"D\"\r\n\t\t\t\tlRet:=.T.\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\tdbSelectArea(cAliasTop)\r\n\tElse\t\r\n\t\t#ENDIF\r\n\t\tIf lListaDev .And. cAlias == \"SD1\"\r\n\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\tIf dbSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA) .And. SF1->F1_TIPO == \"D\"\r\n\t\t\t\tlRet:=.T.\r\n\t\t\tEndIf\r\n\t\tElseIf lListaDev .And. cAlias == \"SD2\"\r\n\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\tIf dbSeek(xFilial(\"SF2\")+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA) .And. SF2->F2_TIPO == \"D\"\r\n\t\t\t\tlRet:=.T.\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\tdbSelectArea(cAlias)\r\n\r\n\t\t#IFDEF TOP\r\n\tEndIf\r\n\t#ENDIF\r\n\r\nReturn lRet\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³MTR910CUnf ³ Autor ³Rodrigo de A. Sartorio ³ Data ³26/06/00 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Ajusta grupo de perguntas p/ Custo Unificado                ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe   ³ MTR910Cunf(ExpL1)\t\t\t\t\t                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ ExpL1 = Custo Unificado\t\t\t\t\t\t\t\t \t  ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ MATR910                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function MTR910CUnf(lCusUnif)\r\n\tLocal aSvAlias:=GetArea()\r\n\tLocal nTamSX1 :=Len(SX1->X1_GRUPO)\r\n\tdbSelectArea(\"SX1\")\r\n\tIf dbSeek(PADR(\"MTR910\",nTamSX1)+\"08\",.F.)\r\n\t\tIf !(\"MTR910VAlm\" $ X1_VALID)\r\n\t\t\tRecLock(\"SX1\",.F.)\r\n\t\t\tIf Empty(X1_VALID)\r\n\t\t\t\tReplace X1_VALID With \"MTR910VAlm\"\r\n\t\t\tElse\r\n\t\t\t\tReplace X1_VALID With X1_VALID+\".And.MTR910VAlm\"\r\n\t\t\tEndIf\r\n\t\t\tMsUnlock()\r\n\t\tEndIf\r\n\t\tIf lCusUnif .And. X1_CNT01 !=  Repl(\"*\",TamSX3(\"B2_LOCAL\")[1])\r\n\t\t\tRecLock(\"SX1\",.F.)\r\n\t\t\tReplace X1_CNT01 With  Repl(\"*\",TamSX3(\"B2_LOCAL\")[1])\r\n\t\t\tMsUnlock()\r\n\t\tEndIf\r\n\tEndIf\r\n\tRestArea(aSvAlias)\r\nReturn(NIL)\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³MTR910VAlm ³ Autor ³Rodrigo de A. Sartorio ³ Data ³26/06/00 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Valida Almoxarifado do KARDEX com relacao a custo unificado ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³ .T. / .F.                                                  ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ MATR910                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function MTR910VAlm()\r\n\tLOCAL lRet:=.T.\r\n\tLOCAL cConteudo:=&(ReadVar())\r\n\tLOCAL nOpc:=2\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Verifica se utiliza custo unificado por Empresa/Filial       ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLOCAL lCusUnif := IIf(FindFunction(\"A330CusFil\"),A330CusFil(),GetMV(\"MV_CUSFIL\",.F.))\r\n\tIf lCusUnif .And. cConteudo != Repl(\"*\",TamSX3(\"B2_LOCAL\")[1])\r\n\t\tnOpc := Aviso(STR0034,STR0035,{STR0036,STR0037})\t//\"Aten‡„o\"###\"Ao alterar o almoxarifado o custo medio unificado sera desconsiderado.\"###\"Confirma\"###\"Abandona\"\r\n\t\tIf nOpc == 2\r\n\t\t\tlRet:=.F.\r\n\t\tEndIf\r\n\tEndIf\r\nReturn lRet\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡ao    ³ AjustaSX1³ Autor ³ Marcos V. Ferreira    ³ Data ³29/08/2005³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Altera descricao da pergunta no SX1                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ MATR910\t\t\t                                          ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function AjustaSX1()\r\n\r\n\tLocal aArea := { Alias(), IndexOrd() } , aPerg:={}\r\n\tLocal aTamSX3:= TamSX3(\"B2_LOCAL\")\r\n\tLocal cPerg := \"MTR910\"        \r\n\tLocal nTamSX1 := Len(SX1->X1_GRUPO)\r\n\r\n\tAadd(aPerg,{\"So Livro\",\"Solo Libro\",\"Only Book\"})\r\n\tAadd(aPerg,{\"So Termos\",\"Solo Actas\",\"Terms Only\"})\r\n\r\n\tdbSelectArea(\"SX1\")\r\n\tdbSetOrder(1)\r\n\tIf dbSeek(PADR(cPerg,nTamSX1)+\"15\")\r\n\t\tRecLock(\"SX1\",.F.)\r\n\t\tReplace X1_DEF01 \twith aPerg[1][1]\r\n\t\tReplace X1_DEFSPA1\twith aPerg[1][2]\r\n\t\tReplace X1_DEFENG1 \twith aPerg[1][3]\r\n\t\tReplace X1_DEF03 \twith aPerg[2][1]\r\n\t\tReplace X1_DEFSPA3\twith aPerg[2][2]\r\n\t\tReplace X1_DEFENG3 \twith aPerg[2][3]\r\n\t\tMsUnLock()\r\n\tEndIf\r\n\r\n\taPerg := {}\r\n\tAadd(aPerg,{\"Digitacao\",\"Digitacion\",\"Typing\"})\r\n\tAadd(aPerg,{\"Calculo\",\"Calculo\",\"Calculation\"})\r\n\r\n\tdbSelectArea(\"SX1\")\r\n\tdbSetOrder(1)\r\n\r\n\tIf dbSeek(PADR(cPerg,nTamSX1)+\"07\") .And. SX1->X1_TIPO == \"C\"\r\n\t\tRecLock(\"SX1\",.F.)\r\n\t\tReplace X1_TIPO     with \"N\"\r\n\t\tReplace X1_PRESEL   with 1\r\n\t\tReplace X1_GSC   \twith \"C\"\r\n\t\tReplace X1_DEF01    with \"Sim\"\r\n\t\tReplace X1_DEFSPA1  with \"Si\"\r\n\t\tReplace X1_DEFENG1  with \"Yes\"\r\n\t\tReplace X1_DEF02    with \"Nao\"\r\n\t\tReplace X1_DEFSPA2  with \"No\"\r\n\t\tReplace X1_DEFENG2  with \"No\"\r\n\t\tReplace X1_CNT01    with \" \"\r\n\t\tMsUnLock()\r\n\tEndIf\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Ajusta tamanho da get de pergunta do armazem se diferente de B2_LOCAL³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf dbSeek(PADR(cPerg,nTamSX1)+\"08\") .And. SX1->X1_TIPO == \"C\" .And. SX1->X1_TAMANHO != aTamSX3[1]\r\n\t\tRecLock(\"SX1\",.F.)\r\n\t\tReplace X1_TAMANHO with aTamSX3[1]\r\n\t\tMsUnLock()\r\n\tEndIf\r\n\r\n\tIf dbSeek(PADR(cPerg,nTamSX1)+\"16\")\r\n\t\tRecLock(\"SX1\",.F.)\r\n\t\tReplace X1_DEF01 \twith aPerg[1][1]\r\n\t\tReplace X1_DEFSPA1\twith aPerg[1][2]\r\n\t\tReplace X1_DEFENG1 \twith aPerg[1][3]\r\n\t\tReplace X1_DEF02 \twith aPerg[2][1]\r\n\t\tReplace X1_DEFSPA2\twith aPerg[2][2]\r\n\t\tReplace X1_DEFENG2 \twith aPerg[2][3]\r\n\t\tMsUnLock()\r\n\tEndIf\r\n\r\n\tdbSelectArea( aArea[1] )\r\n\tdbSetOrder( aArea[2] )\r\nReturn\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³MR910ImpS1³ Autor ³ Nereu Humberto Junior ³ Data ³ 12/07/06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Imprime secoes 1 e 2 (Dados do produto)                    ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe   ³ MR910ImpS1(ExpA1,ExpN1,ExpC1,ExpL1,ExpL2,ExpO1,ExpO2)\t  ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ ExpA1 = Array com informacoes do saldo inicial do item     ³±±\r\n±±³          ³   [1] = Saldo inicial em quantidade                        ³±±\r\n±±³          ³   [2] = Saldo inicial em valor                             ³±±\r\n±±³          ³   [3] = Saldo inicial na 2a unidade de medida              ³±±\r\n±±³          ³ ExpN1 = Custo medio do item                                ³±±\r\n±±³          ³ ExpC1 = Alias                                              ³±±\r\n±±³          ³ ExpL1 = Veiculo                                            ³±±\r\n±±³          ³ ExpL2 = Custo Unificado                                    ³±±\r\n±±³          ³ ExpO1 = Secao 1                                            ³±±\r\n±±³          ³ ExpO2 = Secao 2                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ MATR910                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function MR910ImpS1(aSalAtu,nCusMed,cAliasTop,lVEIC,lCusUnif,oSection1,oSection2)\r\n\r\n\tLocal aArea := GetArea()\r\n\r\n\toSection1:Init()\r\n\toSection2:Init()\r\n\r\n\toSection1:Cell(\"nCusMed\"):SetValue(nCusMed)\r\n\toSection1:Cell(\"nQtdSal\"):SetValue(aSalAtu[1])\r\n\toSection1:Cell(\"nVlrSal\"):SetValue(aSalAtu[mv_par11+1])\t\t\t\r\n\r\n\t#IFDEF TOP\r\n\toSection1:Cell(\"cProduto\"):SetValue((cAliasTop)->PRODUTO)\t\t\t\r\n\toSection1:Cell(\"cTipo\"):SetValue((cAliasTop)->TIPO\t)\r\n\tIf lVEIC\r\n\t\toSection2:Cell(\"cProduto\"):SetValue((cAliasTop)->PRODUTO)\t\t\t\r\n\t\toSection2:Cell(\"cTipo\"):SetValue((cAliasTop)->TIPO\t)\r\n\tEndif\r\n\r\n\tdbSelectArea(\"SB2\")\r\n\tdbSeek(xFilial(\"SB2\")+(cAliasTop)->PRODUTO+If(lCusUnif,\"\",mv_par08))\r\n\t#ELSE \r\n\toSection1:Cell(\"cProduto\"):SetValue(SB1->B1_COD)\t\t\t\r\n\toSection1:Cell(\"cTipo\"):SetValue(SB1->B1_TIPO)\r\n\tIf lVEIC\r\n\t\toSection2:Cell(\"cProduto\"):SetValue(SB1->B1_COD)\t\t\t\r\n\t\toSection2:Cell(\"cTipo\"):SetValue(SB1->B1_TIPO)\r\n\tEndif\r\n\t#ENDIF\r\n\r\n\toSection1:PrintLine()\r\n\toSection2:PrintLine()\r\n\r\n\tRestArea(aArea)\r\n\r\nRETURN\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³MTR910IsMNT³ Autor ³ Lucas                ³ Data ³ 03.10.06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Verifica se há integração com o modulo SigaMNT/NG          ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ MATR910                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function MTR910IsMNT()\r\n\tLocal aArea\r\n\tLocal aAreaSB1\r\n\tLocal aProdsMNT := {}\r\n\tLocal cProdMNT\t := \"\"\r\n\tLocal nX := 0\r\n\tLocal lIntegrMNT := .F.\r\n\r\n\t//Esta funcao encontra-se no modulo Manutencao de Ativos (NGUTIL05.PRX), e retorna os produtos (pode ser MAIS de UM), dos parametros de\r\n\t//Manutencao - \"M\" (MV_PRODMNT) / Terceiro - \"T\" (MV_PRODTER) / ou Ambos - \"*\" ou em branco\r\n\tIf FindFunction(\"NGProdMNT\")\r\n\t\taProdsMNT := aClone(NGProdMNT(\"M\"))\r\n\t\tIf Len(aProdsMNT) > 0\r\n\t\t\taArea\t := GetArea()\r\n\t\t\taAreaSB1 := SB1->(GetArea())\r\n\r\n\t\t\tSB1->(dbSelectArea( \"SB1\" ))\r\n\t\t\tSB1->(dbSetOrder(1))\r\n\t\t\tFor nX := 1 To Len(aProdsMNT)\r\n\t\t\t\tIf SB1->(dbSeek( xFilial(\"SB1\") + aProdsMNT[nX] ))\r\n\t\t\t\t\tlIntegrMNT := .T.\r\n\t\t\t\t\tExit\r\n\t\t\t\tEndIf \r\n\t\t\tNext nX\r\n\r\n\t\t\tRestArea(aAreaSB1)\r\n\t\t\tRestArea(aArea)\r\n\t\tEndIf\r\n\tElse //Se a funcao nao existir, processa com o parametro aceitando 1 (UM) Produto\r\n\t\tcProdMNT\t := GetMv(\"MV_PRODMNT\")\r\n\t\tcProdMNT := cProdMNT + Space(15-Len(cProdMNT))\r\n\t\tIf !Empty(cProdMNT)\r\n\t\t\taArea\t := GetArea()\r\n\t\t\taAreaSB1 := SB1->(GetArea())\r\n\t\t\tSB1->(dbSelectArea( \"SB1\" ))\r\n\t\t\tSB1->(dbSetOrder(1))\r\n\t\t\tIf SB1->(dbSeek( xFilial('SB1') + cProdMNT ))\r\n\t\t\t\tlIntegrMNT := .T.\r\n\t\t\tEndIf \r\n\t\t\tRestArea(aAreaSB1)\r\n\t\t\tRestArea(aArea)\r\n\t\tEndIf\r\n\tEndIf\r\nReturn( lIntegrMNT )\r\n"}}}
Content-Length: 166
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/Matr910.prw"}}}
Content-Length: 14183
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/MMOVESTEND.PRW","languageId":"advpl","version":1,"text":"#INCLUDE \"rwmake.ch\"\r\n#INCLUDE \"protheus.ch\"\r\n#INCLUDE \"TOPCONN.CH\"\r\n\r\n/*                                          \r\nPrograma ...: MarkEnd.Prw\r\nUso ........: Endereçamento\r\nData .......: 26/08/19\r\nFeito por ..: Bruno Lage Ferreira.\r\n*/\r\n\r\nUser Function MarkEnd()  \r\n/****************************************************************************************************\r\n*\r\n*\r\n****/      \r\nLocal _astru     :={}\r\nLocal _afields   :={}     \r\nLocal _carq             \r\nPrivate arotina  :={}   \r\nPrivate cCadastro \r\nPrivate cMark    := GetMark()\r\n\r\n\r\naRotina   := { \t{ \"Marcar Todos [F5]\",\"U_MARCAR\" \t\t, 0, 4},;               \r\n\t\t\t\t{ \"Desmarcar Todos\"  ,\"U_DESMAR\"  \t\t, 0, 4},;  \r\n\t\t\t\t{ \"Filtra Dados [F4]\",\"u_MfiltDados\"  \t, 0, 3},;\r\n\t\t\t\t{ \"Grava Dados  [F6]\",\"u_MGravMovEst\" \t, 0, 1},;\r\n\t\t\t\t{ \"Rel.Endereçamento\",\"u_RelInWeb('RQ0014')\"\t, 0, 3},;\r\n\t\t\t\t{ \"Rel.End/Tabela\"   ,\"u_RelInWeb('RQ0052')\"\t, 0, 3},;\r\n\t\t\t\t{ \"Etiqueta Endereço\",\"u_RelInWeb('RQ0045')\"\t, 0, 3},;\r\n\t\t\t\t{ \"Rel.Registros\"    ,\"u_MFRQ0015()\"\t, 0, 3},;\r\n\t\t\t\t{ \"Inverter Todos   \",\"U_MARKALL\" \t\t, 0, 4}}   \r\n\r\ncCadastro := \"Endereçamento de Estoque:\"\r\n\r\nSetKey(VK_F4,{||u_MfiltDados()})\r\nSetKey(VK_F5,{||U_MARCAR()})\r\nSetKey(VK_F6,{||u_MGravMovEst()})\r\n\r\n \t\t\t\t\r\n// Estrutura da tabela temporaria\r\nAADD(_astru,{\"OK\"\t\t,\"C\",002,0})\r\nAADD(_astru,{\"CAVALETE\"\t,\"C\",006,0})\r\nAADD(_astru,{\"LOTE\"\t\t,\"C\",010,0})\r\nAADD(_astru,{\"CHAPA\"\t,\"C\",004,0})\r\nAADD(_astru,{\"PRODUTO\"\t,\"C\",015,0})\r\nAADD(_astru,{\"NOME\"\t\t,\"C\",120,0})\r\nAADD(_astru,{\"ENDERECO\"\t,\"C\",020,0})\r\nAADD(_astru,{\"DATAM\"\t,\"D\",008,0})\r\nAADD(_astru,{\"USUARIO\"\t,\"C\",030,0})\r\n\r\n\r\n// cria a tabela temporária\r\n_carq:=\"T_\"+Criatrab(,.F.)\r\nMsCreate(_carq,_astru,\"TOPCONN\") \r\n// atribui a tabela temporária ao alias TRB\r\ndbUseArea(.T.,\"TOPCONN\",_cARq,\"TRB\",.T.,.F.)\r\n\r\nAADD(_afields,{\"OK\"\t\t\t,\"\",\"X\"\t   \t\t})\r\nAADD(_afields,{\"CAVALETE\"\t,\"\",\"CAVALETE\"\t})\r\nAADD(_afields,{\"LOTE\"\t\t,\"\",\"LOTE\"\t\t})\r\nAADD(_afields,{\"CHAPA\"\t\t,\"\",\"CHAPA\"\t\t})\r\nAADD(_afields,{\"PRODUTO\"\t,\"\",\"PRODUTO\"\t})\r\nAADD(_afields,{\"NOME\"\t\t,\"\",\"NOME\"\t\t})\r\nAADD(_afields,{\"ENDERECO\"\t,\"\",\"ENDERECO\"\t})\r\nAADD(_afields,{\"DATAM\"\t\t,\"\",\"DATA MOVIMENTO\"})\r\nAADD(_afields,{\"USUARIO\"\t,\"\",\"USUARIO\"\t})\r\n\r\nDBSELECTAREA(\"TRB\")\r\n\r\n//MarkBrow( 'TRB', 'OK',,_afields,, cMark,'u_MarkAll()',,,,'u_Mark()',{|| u_MarkAll()}) \r\nMarkBrow( 'TRB', 'OK',,_afields,, cMark,'u_MarkAll()',,,,'u_Mark()',{|| })\r\n\r\nDbCloseArea()      \t\t\t\t\r\n\r\n// fecha a tabela temporária\r\nMsErase(_carq+GetDBExtension(),,\"TOPCONN\")\t\r\n// apaga a tabela temporária\r\n\r\n//Alert(\"Favor não usar mais esta rotina! Usar agora a rotina de cavaletes no próprio Protheus.\")\r\n\r\nReturn()\r\n\r\nUser Function MFRQ0015()\r\n********************************************************************************\r\n*\r\n*\r\n***\r\n\r\n/*\r\nTABELA DE DIFERENCAS \r\n*/\r\ncTabela   := \"TB_RQ0015\"\r\n\r\nIf TcCanOpen(cTabela)  \r\n   lOk := TcDelFile(cTabela)   \r\nElse  \r\n\tMsgInfo(\"Tabela \"+cTabela+\" não encontrada.\")\r\nEndif\t\r\n\r\ncQuery := \" SELECT  '\"+SUBSTR(CUSUARIO,7,15)+\"' USUARIO,\r\ncQuery += \" \t\tCast(getdate() as date)  DATA,\r\ncQuery += \" \t\tB8_XENDERE,\t\t\t\t\t\t\t\t   \r\ncQuery += \" \t\tCOUNT(*)\t QTD_BUNDLE,\r\ncQuery += \" \t\tdbo.FBUNDLE_END(B8_XENDERE) BUNDLES\r\ncQuery += \" \t\tINTO  \" + cTabela\r\ncQuery += \" \t\tFROM (\r\ncQuery += \" \t\t\t\tSELECT\tDISTINCT B8_XENDERE,\r\ncQuery += \" \t\t\t\t\t\tB8_YCAVALE\r\ncQuery += \" \t\t\t\t\tFROM SB8010 \r\ncQuery += \" \t\t\t\t\tWHERE D_E_L_E_T_=''\r\ncQuery += \" \t\t\t\t\tAND B8_XPUSUAR = '\"+SUBSTR(CUSUARIO,7,15)+\"'\"\r\ncQuery += \" \t\t\t\t\tAND CAST(B8_XDTMOVE AS DATE) = cast(getdate() as date)\r\ncQuery += \" \t\t\t\t\tAND B8_SALDO <> 0\r\ncQuery += \" \t\t\t\t)TB_ENDE\r\ncQuery += \" WHERE B8_XENDERE <> ''\r\ncQuery += \" GROUP BY B8_XENDERE\r\n\r\nTcSQLExec(cQuery)\r\n\r\nu_RelInWeb('RQ0015')\r\n\r\nReturn()\r\n\r\nUser Function MGravMovEst()\r\n********************************************************************************\r\n*\r\n*\r\n***\r\nLocal oMark := GetMarkBrow()\r\nLocal cQuery:=\"\"\r\n\r\nPrivate aPerg := {}\r\nPrivate cPerg := \"MGRAVMOVES\"\r\n\r\n\r\n//Aadd(aPerg,{cPerg,\"Endereço De  ?\"\t\t,\"C\",06,00,\"G\",\"\",\"ZE1\",\"Vazio() .or. ExistCpo('ZE1')\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nAadd(aPerg,{cPerg,\"Endereço De  ?\"\t\t,\"C\",06,00,\"G\",\"\",\"ZE1\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nU_Testasx1(cPerg,aPerg,.T.)\r\n\r\nIf ! Pergunte(cPerg,.T.)\r\n\tReturn()\r\nEndIf\r\n\r\nIf Empty(mv_par01)\r\n\t//Alert(\"Endereço não pode ser em branco!\")\r\n\t//Return()\r\nEndIf\r\n\r\ndbSelectArea(\"ZE1\")\r\ndbSetOrder(1)\r\nIf !dbSeek(xFilial(\"ZE1\")+AllTrim(mv_par01))\r\n\tAlert(\"Endereço não encontrado!\")\r\n\tReturn()\r\nEndIf\r\n\r\ndbSelectArea(\"ZE1\")\r\ndbSetOrder(1)\r\nIf dbSeek(xFilial(\"ZE1\")+AllTrim(mv_par01))\t\t\r\n\tIf ZE1->ZE1_BLQ == '2'\r\n\t\tAlert(\"Endereço bloqueado para produtos acabados!\")\r\n\t\tReturn()\r\n\tEndIf\r\nEndIf\r\n\r\nIf MsgYesNo(\"Deseja alterar os dados de endereçamento ?\" )\r\n\r\n\tdbSelectArea(\"TRB\")\r\n\tdbGoTop()\t\r\n\tWhile (!Eof())\r\n\t\t\r\n\t\tIf IsMark( 'OK', cMark )\r\n\t\t\tdbSelectArea(\"TRB\")\t\r\n\t\t\tRecLock(\"TRB\",.F.) \t\t\t\t\r\n\t\t\t\tTRB->ENDERECO \t:= mv_par01\r\n\t\t\t\tTRB->DATAM \t\t:= dDataBase\r\n\t\t\t\tTRB->USUARIO \t:= SUBSTR(CUSUARIO,7,15)\r\n\t\t\tMsUnLock()\r\n\t\t\r\n\t\t\t/*\r\n\t\t\tLimpa o local atual caso exita\r\n\t\t\t\r\n\t\t\tcQuery:=\" UPDATE SB8010\r\n\t\t\tcQuery+=\"   SET B8_XDTMOVE ='',B8_XENDERE='',B8_XPUSUAR=''\r\n\t\t\tcQuery+=\"  \tFROM SB8010 SB8 WITH ( NOLOCK )\r\n\t\t\tcQuery+=\" WHERE SB8.D_E_L_E_T_ = ''\r\n\t\t\tcQuery+=\"   AND B8_PRODUTO = '\"+ TRB->PRODUTO  +\"'\r\n\t\t\tcQuery+=\"   AND B8_LOTECTL = '\"+ TRB->LOTE     +\"'\r\n\t\t\tcQuery+=\"   AND B8_NUMLOTE = '\"+ TRB->CAVALETE +\"'\r\n\t\t\tcQuery+=\"   AND LEFT(B8_PRODUTO,2) IN ('CH','AM') \r\n\t\t\t//cQuery+=\"   AND B8_SALDO <> 0\r\n\t\t\r\n\t\t\tTcSQLExec(cQuery)\r\n\t\t\t*/\r\n\t\t\t/*\r\n\t\t\tAtualiza o novo endereço \r\n\r\n\t\t\tPLSQuery\r\n\t\t\t*/\r\n\t\t\tcQuery:=\" UPDATE SB8010\r\n\t\t\tcQuery+=\"   SET B8_XDTMOVE ='\"+dToS(dDataBase)+\"',B8_XENDERE='\"+Alltrim(mv_par01)+\"',B8_XPUSUAR='\"+SUBSTR(CUSUARIO,7,15)+\"'\r\n\t\t\tcQuery+=\"  \tFROM SB8010 SB8 WITH ( NOLOCK )\r\n\t\t\tcQuery+=\" WHERE SB8.D_E_L_E_T_ = ''\r\n\t\t\tcQuery+=\"   AND B8_PRODUTO = '\"+ TRB->PRODUTO  +\"'\r\n\t\t\tcQuery+=\"   AND B8_LOTECTL = '\"+ TRB->LOTE     +\"'\r\n\t\t\tcQuery+=\"   AND B8_NUMLOTE = '\"+ TRB->CAVALETE +\"'\r\n\t\t\tcQuery+=\"   AND LEFT(B8_PRODUTO,2) IN ('CH','AM') \r\n\t\t\t//cQuery+=\"   AND B8_SALDO <> 0\r\n\t\t\r\n\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\r\n\t\t\t/*\r\n\t\t\tlimpa a informção no cavalete\r\n\t\t\t\r\n\t\t\tcQuery:=\" UPDATE ZG3010\r\n\t\t\tcQuery+=\"    SET ZG3_XDTMOV ='',ZG3_XENDER='',ZG3_XPUSUA=''\r\n\t\t\tcQuery+=\"   FROM ZG3010 ZG3 WITH ( NOLOCK )\r\n\t\t\tcQuery+=\"  WHERE ZG3.D_E_L_E_T_ = ''\r\n\t\t\tcQuery+=\"    AND ZG3_CODIGO = '\"+ TRB->CAVALETE +\"'\r\n\t\t\r\n\t\t\tTcSQLExec(cQuery)\r\n\t\t\t*/\r\n\t\t\t/*\r\n\t\t\tGrava o novo endereço no cavalete\r\n\t\t\t*/\r\n\t\t\tcQuery:=\" UPDATE ZG3010 \r\n\t\t\tcQuery+=\"    SET ZG3_XDTMOV ='\"+dToS(dDataBase)+\"',ZG3_XENDER='\"+Alltrim(mv_par01)+\"',ZG3_XPUSUA='\"+SUBSTR(CUSUARIO,7,15)+\"'\r\n\t\t\tcQuery+=\"   FROM ZG3010 ZG3 WITH ( NOLOCK )\r\n\t\t\tcQuery+=\"  WHERE ZG3.D_E_L_E_T_ = ''\r\n\t\t\tcQuery+=\"    AND ZG3_CODIGO = '\"+ TRB->CAVALETE +\"'\r\n\t\t\r\n\t\t\tTcSQLExec(cQuery)\r\n\t\tEndIf\r\n\t\t\t\r\n\t\tDbSelectArea(\"TRB\")\r\n\t\tDBSKIP()\r\n\tEndDo\r\n\r\n MarkBRefresh( )\r\n \r\n // atualiza o browse\r\n oMark:oBrowse:Gotop()\r\n\r\nEndIf\r\n\r\nReturn()\r\n\r\nUser Function MfiltDados()\r\n********************************************************************************\r\n*\r\n*\r\n***\r\nLocal cQuery := \"\"\r\nPrivate aPerg := {}\r\nPrivate cPerg := \"MMOVESTOQS\"\r\n       \r\n             \r\n//Aadd(aPerg,{cPerg,\"Empresa/Filial Destino?\",\"C\",06,00,\"G\",\"\",\"SM0\",\"\",\"\",\"\",\"\",\"\",\"\"})     \r\nAadd(aPerg,{cPerg,\"Cavalete ?\"\t\t,\"C\",06,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Lote Qualitá ?\"\t,\"C\",06,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})     \r\nAadd(aPerg,{cPerg,\"Chapa de  ?\"\t\t,\"C\",03,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Chapa Ate ?\"\t\t,\"C\",03,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nU_Testasx1(cPerg,aPerg,.F.)\r\n\r\nIf ! Pergunte(cPerg,.T.)\r\n\tReturn()\r\nEndIf\r\n \r\n\r\ncQuery := \" SELECT\tB8_LOCAL   AS LOCAL,\r\ncQuery += \" \t\tNNR_DESCRI AS LOCAL_DES,\t\t\r\ncQuery += \" \t\tB8_PRODUTO AS PRODUTO,\r\ncQuery += \" \t\tB1_DESC    AS PRODUTO_DESC,\r\ncQuery += \" \t\tCAST(B8_DATA AS DATE) AS FABRIC,\r\ncQuery += \" \t\tRIGHT(RTRIM(LTRIM(B8_PRODUTO)),2) AS TIPO,\r\ncQuery += \" \t\tIIF(B8_YCLASSI='','P',RTRIM(LTRIM(B8_YCLASSI))) AS CLASSIFICACAO,\r\ncQuery += \" \t\tB8_YCAVALE AS CAVALETE,\r\ncQuery += \" \t\tB8_LOTECTL AS LOTE,\r\ncQuery += \" \t\tB8_NUMLOTE AS SUBLOTE, \r\ncQuery += \" \t\tISNULL((SELECT TOP 1 C6_NUM FROM SC6010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = C6_NUMLOTE AND B8_PRODUTO = C6_PRODUTO ),'') AS PEDIDO_VENDA,\r\ncQuery += \" \t\tIIF(ISNULL((SELECT TOP 1 C6_NUM FROM SC6010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = C6_NUMLOTE AND B8_PRODUTO = C6_PRODUTO ),'')<>'',B8_SALDO,0) AS RESERVADO ,\r\ncQuery += \" \t\tB8_SALDO   AS SALDO,\r\ncQuery += \" \t\tB8_XENDERE ENDERECO, \r\ncQuery += \" \t\tB8_XDTMOVE DATAM,\r\ncQuery += \" \t\tB8_XPUSUAR USUARIO\r\ncQuery += \" \tFROM SB8010 SB8 INNER JOIN NNR010 NNR\r\ncQuery += \" \t\tON (NNR_CODIGO = B8_LOCAL)\r\ncQuery += \" \t\tINNER  JOIN SB1010 SB1 \r\ncQuery += \" \t\tON (B1_COD = B8_PRODUTO)\r\ncQuery += \" \tWHERE SB8.D_E_L_E_T_ = ''\r\ncQuery += \" \tAND SB1.D_E_L_E_T_ = ''\r\ncQuery += \" \tAND NNR.D_E_L_E_T_ = ''\r\nIf !Empty(mv_par01)\r\n\tcQuery += \" \tAND B8_YCAVALE='\"+AllTrim(mv_par01)+\"'\"\r\nEndIf\r\nIf !Empty(mv_par02)\r\n\tcQuery += \" \tAND B8_LOTECTL='\"+AllTrim(mv_par02)+\"'\"\r\nEndIf\r\nIf !Empty(mv_par03) .And. !Empty(mv_par04) \r\n\tcQuery += \" \tAND B8_NUMLOTE BETWEEN '\"+AllTrim(mv_par03)+\"' AND '\" + AllTrim(mv_par04)+\"'\"\r\nEndIf\r\ncQuery += \" \tAND LEFT(B8_PRODUTO,2) IN ('CH','AM') \r\ncQuery += \" \tAND B8_SALDO <> 0\r\ncQuery += \" ORDER BY B8_YCAVALE,B8_LOTECTL,B8_NUMLOTE\r\n\r\n\r\nTcQuery cQuery Alias TRB_ESTOQUE New\r\n\r\n\r\nDBSELECTAREA(\"TRB\")\t\r\nWhile (!Eof())\r\n\r\n\tRECLOCK(\"TRB\",.F.) \r\n\tdbdelete()\r\n\tMSUNLOCK()\r\n\t\r\n\tDbSelectArea(\"TRB\")\r\n\tDBSKIP()\r\nEndDo\r\n\r\n\r\n\r\ndbSelectArea(\"TRB_ESTOQUE\")\r\ndbGoTop()\r\nWhile (!Eof())\r\n\r\n\tDBSELECTAREA(\"TRB\")\t\r\n\tRECLOCK(\"TRB\",.T.) \t\t\t\t\t\r\n\t\tTRB->CAVALETE\t:= TRB_ESTOQUE->CAVALETE \t\t\r\n\t\tTRB->LOTE\t\t:= TRB_ESTOQUE->LOTE\t\t\r\n\t\tTRB->CHAPA\t\t:= TRB_ESTOQUE->SUBLOTE\r\n\t\tTRB->PRODUTO \t:= TRB_ESTOQUE->PRODUTO\r\n\t\tTRB->NOME\t \t:= TRB_ESTOQUE->PRODUTO_DESC\r\n\t\tTRB->ENDERECO \t:= TRB_ESTOQUE->ENDERECO\r\n\t\tTRB->DATAM \t\t:= StoD(TRB_ESTOQUE->DATAM)\r\n\t\tTRB->USUARIO \t:= TRB_ESTOQUE->USUARIO\r\n\tMSUNLOCK()    \r\n\r\n\tdbSelectArea(\"TRB_ESTOQUE\")\r\n\tDBSKIP()\r\nEndDo\r\n\r\nDbSelectArea(\"TRB\")\r\nDbGotop()\r\n\r\nDBSELECTAREA(\"TRB_ESTOQUE\")\r\nDBCloseArea()\r\n\r\nU_DesMar()\r\n\r\nReturn()\r\n\r\n\r\nUser Function Marcar()\r\n********************************************************************************\r\n*// Função para marcar todos os registros do browse\r\n*\r\n***                              \r\nLocal oMark := GetMarkBrow()\r\nDbSelectArea(\"TRB\")\r\nDbGotop()\r\n\r\nWhile !Eof()\t\r\n\tIF RecLock( 'TRB', .F. )\t\t\r\n\t\tTRB->OK := cMark\t\t\r\n\t\tMsUnLock()\t\r\n\tEndIf\t\r\n\tDbSelectArea(\"TRB\")\r\n\tdbSkip()\r\nEnddo\r\n\r\n// atualiza o browse\r\nMarkBRefresh() \r\n\r\n// força o posicionamento do browse no primeiro registro\r\noMark:oBrowse:Gotop()\t\r\n \r\nReturn()\r\n\r\n\r\n \r\nUser Function DesMar()\r\n********************************************************************************\r\n*// Função para desmarcar todos os registros do browse\r\n*\r\n***\r\nLocal oMark := GetMarkBrow()\r\ndbSelectArea(\"TRB\")\r\ndbGotop()\r\n\r\nWhile !Eof()\t\r\n \tIF RecLock( 'TRB', .F. )\t\t\r\n \t\tTRB->OK := SPACE(2)\t\t\r\n \t\tMsUnLock()\t\r\n \tEndIf\t\r\n \tdbSelectArea(\"TRB\")\r\n \tdbSkip()\r\nEnddo\r\n \r\n MarkBRefresh()\t\t\r\n \r\n // atualiza o browse\r\n oMark:oBrowse:Gotop()\t\r\n // força o posicionamento do browse no primeiro registro\r\nReturn\r\n \r\n \r\nUser Function Mark()\r\n********************************************************************************\r\n*// Função para grava marca no campo se não estiver marcado ou limpar a marca se estiver marcado\r\n*\r\n***\r\n If IsMark( 'OK', cMark )\t\r\n\t RecLock( 'TRB', .F. )\t\r\n\t Replace TRB->OK With Space(2)\t\r\n\t MsUnLock()\r\n Else\t\r\n\t RecLock( 'TRB', .F. )\t\r\n\t Replace TRB->OK With cMark\t\r\n\t MsUnLock()\r\n EndIf\r\n \r\nReturn \r\n \r\n \r\nUser Function MarkAll()   \r\n********************************************************************************\r\n*// Função para gravar\\limpar marca em todos os registros\r\n*\r\n*** \r\n Local oMark := GetMarkBrow()\r\n dbSelectArea('TRB')\r\n dbGotop()\r\n\r\n While !Eof()\t\r\n\t u_Mark()\r\n\t dbSelectArea('TRB')\t\r\n\t dbSkip()\r\n End\r\n \r\n MarkBRefresh( )\r\n \r\n // atualiza o browse\r\n oMark:oBrowse:Gotop()\t\r\n // força o posicionamento do browse no primeiro registro\r\n \r\nReturn\r\n"}}}
Content-Length: 169
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/MMOVESTEND.PRW"}}}
Content-Length: 10986
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/MPFEST.prw","languageId":"advpl","version":1,"text":"#include 'TopConn.CH'\r\n#include 'RWMAKE.CH'\r\n#include 'TbiConn.CH'\r\n#INCLUDE \"PROTHEUS.CH\"      \r\n\r\n/*                                          \r\nPrograma ...: MPFEST.Prw\r\nUso ........: Programa para zerar a quantidade nao invetariada no dia da database\r\nData .......: 22/11/18\r\nFeito por ..: Bruno Lage Ferreira.\r\n*/\r\n\r\nUser Function MPFEST()\r\n***********************************************************************************************************\r\n*  \r\n*\r\n*** \r\n// Variaveis Locais da Funcao\r\nPrivate cEdit1\t := GetMv(\"MV_DBLQMOV\")\r\nPrivate cEdit2\t := Space(25)\r\nPrivate oEdit1\r\nPrivate oEdit2\r\n\r\n// Variaveis Private da Funcao\r\nPrivate _oDlg\t\t\t\t// Dialog Principal\r\n\r\n// Verifica se o usuário é o Administrador do sistema ou usuários autorizados. \r\n/*\r\nIf !Alltrim(__cUserID) $ GetMv(\"MV_USERLIB\") \r\n     Alert(\"Somente o Administrador ou usuários autorizados podem executar esta rotina.\") \r\n     Return \r\nEndIf  \r\n*/\r\n\r\n\r\nDEFINE MSDIALOG _oDlg TITLE \"Auxiliar de fechamento de estoque\" FROM u_MGETTELA(306),u_MGETTELA(471) TO u_MGETTELA(483),u_MGETTELA(687) PIXEL\r\n\r\n\t@ u_MGETTELA(003),u_MGETTELA(002) TO u_MGETTELA(036),u_MGETTELA(105) LABEL \"Data do último movimento:\" PIXEL OF _oDlg\r\n\t\t@ u_MGETTELA(016),u_MGETTELA(061) Button \"Salvar\" Size u_MGETTELA(037),u_MGETTELA(012) ACTION(PutMv(\"MV_DBLQMOV\",cEdit1),Alert(\"Salvo com Sucesso!\"))  PIXEL OF _oDlg\r\n\t\t@ u_MGETTELA(019),u_MGETTELA(005) MsGet oEdit1 Var cEdit1 Size u_MGETTELA(047),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t\r\n\t@ u_MGETTELA(045),u_MGETTELA(002) TO u_MGETTELA(083),u_MGETTELA(104) LABEL \"Diferença de fechamento: \" PIXEL OF _oDlg\r\n\t\t//@ u_MGETTELA(061),u_MGETTELA(008) Say \"Almoxarificado:\" Size u_MGETTELA(037),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t\t//@ u_MGETTELA(071),u_MGETTELA(009) MsGet oEdit2 Var cEdit2 Size u_MGETTELA(028),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t\t@ u_MGETTELA(067),u_MGETTELA(061) Button \"Rel. Diferenças\"  Size u_MGETTELA(037),u_MGETTELA(012) ACTION(U_relinweb(\"RQ0077\")) PIXEL OF _oDlg\r\n\r\n\t\t//@ u_MGETTELA(075),u_MGETTELA(061) Button \"Exec ZERA\" Size u_MGETTELA(037),u_MGETTELA(012) ACTION(U_MZeraSB7()) PIXEL OF _oDlg\r\n\r\nACTIVATE MSDIALOG _oDlg CENTERED \r\n\r\nReturn(.T.)\r\n\r\nUser function ZERAQTD()\r\n***********************************************************************************************************\r\n*  \r\n*\r\n***  \r\n\r\nPrivate aPerg := {}\r\nPrivate cPerg := \"MPFESTINV0\"\r\n                  \r\nAadd(aPerg,{cPerg,\"Data               ?\",\"D\",08,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})  \r\nAadd(aPerg,{cPerg,\"Documento          ?\",\"C\",09,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Local              ?\",\"C\",02,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Deletar Inv. Zerado?\",\"N\",01,00,\"C\",\"\",\"\",\"Sim\",\"Nao\",\"\",\"\",\"\",\"\"})\r\n\r\n/*\r\nAadd(aPerg,{cPerg,\"Ate a Data        ?\",\"D\",08,00,\"G\",\"naovazio\",\"\"   ,\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Filtro            ?\",\"N\",01,00,\"C\",\"\",\"\",\"Resolvidos\",\"Nao Resolvidos\",\"Ambos\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Do Grupo          ?\",\"C\",04,00,\"G\",\"\",\"SBM\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Ate o Grupo       ?\",\"C\",04,00,\"G\",\"\",\"SBM\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Produto Atacadista?\",\"N\",01,00,\"C\",\"\",\"\",\"Sim\",\"Nao\",\"Ambos\",\"\",\"\",\"\"})\r\n//Aadd(aPerg,{cPerg,\"Armazém            ?\",\"C\",02,0,\"G\",\"\",\"\",\"\"    ,\"\"      ,\"\",\"\",\"\",\"\"})\r\n//ExecBlock(\"TestaSX1\",.F.,.F.,{cPerg,aPerg})\r\n*/\r\n\r\nU_Testasx1(cPerg,aPerg,.T.) \r\n\r\nIf ! Pergunte(cPerg,.T.)\r\n\tReturn\r\nEndIf\r\n\r\n/*\r\nSe for para deletar os arquivos zerados\r\n*/\r\nIf mv_par04 = 1\r\n\tIf MsgBox(\"Deseja apagar o inventário com quantidade zerada?\",\"Atenção\",\"YESNO\")\r\n\t\t  cSqlDel := \"\"\r\n\t\t  cSqlDel += \" DELETE\r\n\t\t  cSqlDel += \"   FROM \" + RetSqlName(\"SB7\") \r\n \t\t  cSqlDel += \" WHERE B7_DATA = '\"+DTOS(mv_par01)+\"'\" \r\n \t\t  cSqlDel += \" AND B7_FILIAL = '\"+xFilial('SB7')+\"' \"\r\n   \t\t  cSqlDel += \" AND B7_DOC = '\"+mv_par02+\"'\"\r\n   \t\t  cSqlDel += \" AND B7_QUANT = 0\r\n   \t\t  cSqlDel += \" AND B7_LOCAL = '\"+mv_par03+\"'\"\r\n\t\t  \r\n\t\t  TCSqlExec(cSqlDel)\r\n\tEndIf\r\n\t\r\n\tAlert(\"Registros apagados com sucesso!\")\r\n\t\r\n\tReturn()             \r\nEndIf\r\n\r\nIf MsgBox(\"Deseja imprimir o relatório de verificação auxiliar?\",\"Atenção\",\"YESNO\")\r\n\t  RelZeraX()\r\nEndIf\r\n\r\n\r\nIf MsgBox(\"Este programa inventaria com quantidade 0 produtos que não foram \"+CHR(13)+;\r\n             \"inventariados.ATENÇÃO o parametro [Data], deverá ser a data em\"+CHR(13)+\"que foi realizada a contagem\",\"Atenção\",\"YESNO\")\r\n\t  Processa( {|| u_MZeraSB7()} )\r\nEndIf\r\n\r\nreturn() \r\n\r\nStatic function RelZeraX()\r\n***********************************************************************************************************\r\n*  \r\n*\r\n***\r\n/*\r\nTABELA DE DADOS PRINCIPAIS\r\n*/\r\nIf SubString(CNUMEMP,1,2) == \"05\"\r\n\tcTabela   := \"TB_RIM0022\"\r\nELSE\r\n\tcTabela   := \"TB_RQ0022\"\r\nEndIf\r\n\r\nIf TcCanOpen(cTabela)  \r\n   lOk := TcDelFile(cTabela)   \r\nElse  \r\n\tMsgInfo(\"Talbela \"+cTabela+\" nao encontrada.\")\r\nEndif\t \r\n\r\ncQuery := \" SELECT B1_DESC,TB_TEMP.* INTO \"+cTabela+\" FROM (\r\ncQuery += \" \tSELECT  B2_COD,B2_FILIAL,B2_LOCAL,B7_DOC,B7_QUANT,CAST(B7_DATA AS DATE)B7_DATA \r\ncQuery += \" \tFROM   \" + RetSqlName(\"SB7\") + \" SB7 INNER JOIN \" + RetSqlName(\"SB2\") + \" SB2 \r\ncQuery += \" \t\t   ON (B7_COD = B2_COD AND B7_FILIAL = B2_FILIAL AND B7_LOCAL = B2_LOCAL) \r\ncQuery += \" \tAND SB2.D_E_L_E_T_ <> '*' \r\ncQuery += \" \tAND SB7.D_E_L_E_T_ <> '*' \r\ncQuery += \"     AND B2_LOCAL = '\"+mv_par03+\"'\r\ncQuery += \"     AND B7_DATA = '\"+DTOS(mv_par01)+\"' \"\r\ncQuery += \"     AND B7_FILIAL = '\"+xFilial('SB7')+\"' \"\r\ncQuery += \" \t\t\t\t)TB_TEMP INNER JOIN \" + RetSqlName(\"SB1\") + \"  ON (B1_COD = B2_COD)\r\ncQuery += \" WHERE D_E_L_E_T_ = ''\r\ncQuery += \" ORDER BY B2_COD DESC\r\n\r\nTcSQLExec(cQuery)\t\r\n\r\n/*\r\nTABELA DE DIFERENCAS \r\n*/\r\nIf SubString(CNUMEMP,1,2) == \"05\"\r\n\tcTabela   := \"TB_RIM0022E\"\r\nELSE\r\n\tcTabela   := \"TB_RQ0022E\"\r\nEndIf\r\n\r\n\r\nIf TcCanOpen(cTabela)  \r\n   lOk := TcDelFile(cTabela)   \r\nElse  \r\n\tMsgInfo(\"Talbela \"+cTabela+\" nao encontrada.\")\r\nEndif\t\r\n\r\ncQuery := \" SELECT B2_FILIAL,B2_COD,B1_DESC,B2_LOCAL,B2_QATU\r\ncQuery += \"   INTO \" + cTabela\r\ncQuery += \"   FROM \" + RetSqlName(\"SB2\") + \" SB2 INNER JOIN \" + RetSqlName(\"SB1\") + \"  SB1 ON (B1_COD = B2_COD)\r\ncQuery += \"  WHERE SB2.D_E_L_E_T_ = '' \r\n/*\r\nIf SubString(CNUMEMP,1,2) == \"01\"\r\n\tcQuery += \"  AND B1_COD NOT IN (\r\n\tcQuery += \"  \t\t\t\t'33070002',\r\n\tcQuery += \"  \t\t\t\t'33070015',\r\n\tcQuery += \"  \t\t\t\t'33070036',\r\n\tcQuery += \"  \t\t\t\t'33070020',\r\n\tcQuery += \"  \t\t\t\t'33070001',\r\n\tcQuery += \"  \t\t\t\t'33060205',\r\n\tcQuery += \"  \t\t\t\t'33060127',\r\n\tcQuery += \"  \t\t\t\t'33060209',\r\n\tcQuery += \"  \t\t\t\t'33060210',\r\n\tcQuery += \"  \t\t\t\t'33060207',\r\n\tcQuery += \"  \t\t\t\t'33060208',\r\n\tcQuery += \"  \t\t\t\t'33090001',\r\n\tcQuery += \"  \t\t\t\t'33060101',\r\n\tcQuery += \"  \t\t\t\t'33060171',\r\n\tcQuery += \"  \t\t\t\t'33000175',\r\n\tcQuery += \"  \t\t\t\t'33000061',\r\n\tcQuery += \"  \t\t\t\t'33000063',\r\n\tcQuery += \"  \t\t\t\t'33000062',\r\n\tcQuery += \"  \t\t\t\t'11020002',\r\n\tcQuery += \"  \t\t\t\t'11020003',\r\n\tcQuery += \"  \t\t\t\t'11020020',\r\n\tcQuery += \"  \t\t\t\t'11030001',\r\n\tcQuery += \"  \t\t\t\t'11030003',\r\n\tcQuery += \"  \t\t\t\t'11030026',\r\n\tcQuery += \"  \t\t\t\t'33060196',\r\n\tcQuery += \"  \t\t\t\t'33060055'\r\n\tcQuery += \"  \t\t\t  )\r\nEndIf\r\n*/\r\ncQuery += \"    AND NOT EXISTS(\r\ncQuery += \" \t\t\t\tSELECT  B2_FILIAL,B2_COD,B2_LOCAL from \"+ iif(SubString(CNUMEMP,1,2) == \"05\",\"TB_RIM0022\",\"TB_RQ0022\")  +\" E WHERE E.B2_FILIAL = SB2.B2_FILIAL AND E.B2_COD = SB2.B2_COD AND E.B2_LOCAL = SB2.B2_LOCAL\t\t\t\t\r\ncQuery += \" \t\t\t\t)\r\ncQuery += \"    AND B2_FILIAL = '\"+xFilial('SB7')+\"' \"\r\ncQuery += \"    AND B2_LOCAL = '\"+mv_par03+\"'\r\ncQuery += \"    AND B2_QATU <> 0\r\ncQuery += \"    AND B1_RASTRO <> 'L'\r\ncQuery += \" ORDER BY B2_COD,B2_LOCAL\r\n\r\nTcSQLExec(cQuery)\r\n\r\nIf SubString(CNUMEMP,1,2) == \"05\"\r\n\tu_RelInWeb(\"RIM0022\")\r\nElse\r\n\tu_RelInWeb(\"RQ0022\")\r\nEndIf\r\n\r\nRETURN()\r\n\r\nUser function MZeraSB7()\r\n***********************************************************************************************************\r\n*  \r\n*\r\n***\r\nLocal cQuery := \"\"\r\n\r\n/*\r\ncQuery := \"SELECT DISTINCT  SB1.B1_COD,SB1.B1_TIPO, ISNULL(SB7.B7_COD,'NNNNNN') AS B7_COD \" \r\ncQuery += \"FROM   \" + RetSqlName(\"SB7\") + \" SB7 RIGHT JOIN \"+RetSqlName(\"SB1\")+\" SB1 \" \r\ncQuery += \"       ON B7_COD = B1_COD \"\r\ncQuery += \"AND SB1.D_E_L_E_T_ <> '*' \" \r\ncQuery += \"AND SB7.D_E_L_E_T_ <> '*' \"\r\ncQuery += \"AND B7_DATA = '\"+DTOS(mv_par01)+\"' \"\r\ncQuery += \"AND B7_FILIAL = '\"+xFilial('SB7')+\"' \"\r\ncQuery += \"ORDER BY B7_COD DESC \"\r\n*/\r\n\r\nIf SubString(CNUMEMP,1,2) == \"05\"\r\n\tcQuery := \"SELECT B1_COD,B2_LOCAL,B1_TIPO FROM TB_RIM0022E INNER JOIN \"+RetSqlName(\"SB1\")+\" SB1 ON (B1_COD = B2_COD) WHERE D_E_L_E_T_ = ''\r\nELSE\r\n\tcQuery := \"SELECT B1_COD,B2_LOCAL,B1_TIPO FROM TB_RQ0022E INNER JOIN \"+RetSqlName(\"SB1\")+\" SB1 ON (B1_COD = B2_COD) WHERE D_E_L_E_T_ = ''\r\nEndIf\r\n\r\ntcQuery cQuery alias TRB new\r\n//alert (cQuery)\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\nc := 0\r\n//alert(mv_par01 + 15)\r\ndo while !EOF() \r\n    c:=c+1 \r\n    //alert(TRB->B1_COD+\" \"+TRB->B1_DESC+\" \"+TRB->B1_TIPO+\" \"+TRB->B7_COD)\r\n    IncProc(Alltrim(TRB->B1_COD)+\"- DOC:\"+mv_par02+\"...\")\r\n  \t\r\n  \tRecLock(\"SB7\",.t.)\r\n\t\tSB7->B7_FILIAL  := xFilial(\"SB7\")\r\n\t\tSB7->B7_COD     := TRB->B1_COD\r\n\t\tSB7->B7_LOCAL   := TRB->B2_LOCAL\r\n\t\tSB7->B7_QUANT   := 0\r\n\t\tSB7->B7_DATA    := ctoD(\"18/01/2021\")\r\n\t\tSB7->B7_DOC     := \"20210117D\" \r\n\t\tSB7->B7_TIPO    := TRB->B1_TIPO\r\n\t\tSB7->B7_DTVALID := ctoD(\"18/01/2021\")+365 // ddatabase\r\n\t\tSB7->B7_STATUS  := \"1\"\r\n\t\tSB7->B7_ORIGEM  := \"ZERAX\"\r\n\tMsUnLock()\r\n\t\r\n\tdbSelectArea(\"TRB\")\r\n\tdbSkip()\r\nenddo\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n \r\nAlert(\"Total de registros incluídos! \" + STR(c) + \".\")\r\n\r\nReturn()\r\n"}}}
Content-Length: 165
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/MPFEST.prw"}}}
Content-Length: 11612
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/MTA261DOC.prw","languageId":"advpl","version":1,"text":"#Include \"Totvs.ch\"\r\n#INCLUDE \"rwmake.ch\"\r\n#INCLUDE \"protheus.ch\"\r\n#INCLUDE \"topconn.ch\"\r\n\r\n#DEFINE USADO CHR(0)+CHR(0)+CHR(1)\r\n\r\n/*\r\nPrograma ...: MTA261DOC.Prw\r\nUso ........: Validação do documento de transferencia\r\nData .......: 07/08/2019\r\nFeito por ..: Bruno Lage Ferreira \r\n*/\r\n\r\nUser Function MTA261DOC()\r\n***********************************************\r\n* /* Proibe o usuario alterar o numero do doc*/\r\n*\r\n****\r\nLocal lRet := .F.\r\n\r\nReturn(lRet)\r\n\r\nUser Function MSAtuaL()\r\n***********************************************\r\n* \r\n*\r\n****\r\nLocal nSalEstL1 := 0\r\nLocal nSalEstL2 := 0\r\nLocal cQuery    := \"\"\r\n\r\nIf SubString(CNUMEMP,1,2) == \"01\" .And. FUNNAME() == \"MATA261\"\r\n\tIf !Empty(GdFieldGet(\"D3_LOTECTL\",n)) .And. !Empty(GdFieldGet(\"D3_NUMLOTE\",n))\r\n\t\r\n\t\tcQuery := \"SELECT B8_SALDO,B8_SALDO2 FROM SB8010 WHERE D_E_L_E_T_ = '' AND B8_FILIAL = '\" + xFilial(\"SB8\") +  \"' AND B8_SALDO <> 0 AND B8_PRODUTO = '\"+GdFieldGet(\"D3_COD\",n)+\"' and B8_LOCAL = '\"+GdFieldGet(\"D3_LOCAL\",n)+\"' AND B8_LOTECTL = '\"+GdFieldGet(\"D3_LOTECTL\",n)+\"' AND B8_NUMLOTE = '\"+GdFieldGet(\"D3_NUMLOTE\",n)+\"'\r\n\t\r\n\t\ttcQuery cQuery alias TRBEST new\r\n\t\tdbSelectArea(\"TRBEST\")\r\n\t\tdbgotop()\r\n\t\t\r\n\t\tnSalEstL1 := TRBEST->B8_SALDO\r\n\t\tnSalEstL2 := TRBEST->B8_SALDO2\r\n\t\t\r\n\t\tdbSelectArea(\"TRBEST\") \r\n\t\tdbCloseArea()\r\n\t\t\r\n\t\tGdFieldPut(\"D3_QUANT\"   ,nSalEstL1,n)\r\n\t\tGdFieldPut(\"D3_QTSEGUM\" ,nSalEstL2,n)\r\n\t\tGdFieldPut(\"D3_YCAVALE\" ,MCavaleAtu(GdFieldGet(\"D3_COD\",n) , GdFieldGet(\"D3_LOCAL\",n) , GdFieldGet(\"D3_LOTECTL\",n), GdFieldGet(\"D3_NUMLOTE\",n)) ,n)\r\n\tEndIf\r\nEndIf\r\n\r\nReturn(.T.)\r\n\r\n\r\nStatic Function MCavaleAtu(cCodPro,cLocal,cLote,cSubLote)\r\n***************************************************\r\n* // \r\n*\r\n****\r\nLocal cCodCvte := \"\"\r\nLocal cQuery   := \"\"\r\n\r\ncQuery   := \"SELECT B8_YCAVALE FROM SB8010 WHERE D_E_L_E_T_ = '' AND B8_FILIAL = '\" + xFilial(\"SB8\") +  \"' AND B8_LOTECTL = '\"+cLote+\"' AND B8_NUMLOTE = '\"+cSubLote+\"' AND B8_PRODUTO = '\"+cCodPro+\"' AND B8_LOCAL = '\"+cLocal+\"'\r\n\r\ntcQuery cQuery alias TRB new\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\n\r\ncCodCvte := TRB->B8_YCAVALE\r\n\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n\r\n\r\nReturn(cCodCvte)\r\n\r\nUser Function MA261CPO()\r\n****************************************************\r\n* // Manipulação pelo usuário do aHeader e aCols para inclusão de campos na getdados.\r\n*\r\n****\r\nLocal aTam := {}\r\n\r\naTam := TamSX3('D3_YCAVALE')  \r\n\r\nIf AllTrim(FUNNAME()) <> \"GROA038\"\r\n\tAadd(aHeader, {'Cavalete' , 'D3_YCAVALE'   , PesqPict('SD3', 'D3_YCAVALE'), aTam[1]  , aTam[2], ''            , USADO, 'C', 'SD3', ''})\r\nEndIf\r\n\r\nReturn Nil\r\n\r\n\r\nUser Function A261TOK()\r\n****************************************************\r\n* // Tudo OK?\r\n*\r\n****\r\nLocal lRet \t\t:= .T.\r\n\r\nLocal nPosCava := aScan(aHeader, {|x| AllTrim(x[2]) == \"D3_YCAVALE\"}) //Cavalete\r\nLocal nPosLOTE := aScan(aHeader, {|x| AllTrim(x[2]) == \"D3_LOTECTL\"}) //SubLote\r\nLocal nPosSUBL := aScan(aHeader, {|x| AllTrim(x[2]) == \"D3_NUMLOTE\"}) //Lote\r\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\r\n\r\n/*\r\n****************************************************************\r\nConferencia do cavaletes duplicados no proprio pedido \r\n****************************************************************\r\n*/\r\naNumCav \t:= {}\t\t\r\naTodCav \t:= {}\r\naGriCav \t:= {}\r\naGriCavDup \t:= {}\r\naGriLSPv    := {}\r\naLSPvLoca   := {}\t\r\naCavZero    := {}\r\n\r\nIf IsBlind() \r\n\t//COLOCADO PARA NAO VALIDAR NO MOMENTO DO ENCERRAMENTO DA OP NO GRPLUS\r\n\tConOut(\"IsBlind()=.T.\")\r\n\tReturn(lRet)\r\nElse\r\n\tConOut(\"IsBlind()=.F. seguindo...\")\r\nEndIf\r\n\r\nFor nX := 1 To Len(aCols)\r\n\r\n\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t//\"0005/0006/0034/0035/0036\"\r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1)\r\n\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"D3_COD\",nX)) )\r\n\t\r\n\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \r\n\r\n\t\tIf !Empty(GdFieldGet(\"D3_YCAVALE\",nX)) .and. !GDDeleted(nX)\r\n\t\t\tIf Empty( aScan(aNumCav,GdFieldGet(\"D3_YCAVALE\",nX)) )\r\n\t\t\t \taAdd(aNumCav,GdFieldGet(\"D3_YCAVALE\",nX))\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\tIf !GDDeleted(nX)\r\n\t\t\tIf Empty(aScan(aGriCav,GdFieldGet(\"D3_YCAVALE\",nX) + GdFieldGet(\"D3_LOTECTL\",nX) + GdFieldGet(\"D3_NUMLOTE\",nX)) )\r\n\t\t\t\taAdd(aGriCav , GdFieldGet(\"D3_YCAVALE\",nX) + GdFieldGet(\"D3_LOTECTL\",nX) + GdFieldGet(\"D3_NUMLOTE\",nX)  )\r\n\t\t\t\taAdd(aGriLSPv, {GdFieldGet(\"D3_LOTECTL\",nX) , GdFieldGet(\"D3_NUMLOTE\",nX) } )\r\n\t\t\tElse\r\n\t\t\t\taAdd(aGriCavDup, GdFieldGet(\"D3_YCAVALE\",nX) + GdFieldGet(\"D3_LOTECTL\",nX) + GdFieldGet(\"D3_NUMLOTE\",nX)  )\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\tEndIf\r\n\t\r\nNext nX\r\n\r\ncMSG := \"\"\r\nFor nX:=1 to Len(aGriCavDup)\r\n\t\tIf Empty(cMSG)\r\n\t\t\tcMSG := \"Duplicados no pedido atual:\" + chr(13)+chr(10) \r\n\t\tEndIf\r\n\t\tcMSG += \"O item: \" + aGriCavDup[nX] + chr(13)+chr(10)   \r\nNext nX\r\n\r\nIf !Empty(cMSG)\r\n\tAlert(cMSG)\r\n\tlRet := .F.\r\n\t//sleep(300)\t\r\n\tReturn(lRet)\r\n\t//sleep(300) \r\nEndIf\r\n\r\n\r\n/*\r\n****************************************************************\r\nConferencia se todos os itens do cavales estao completos (Se estiverem em cavaletes)\r\nCavalete apagado por completo\r\nA mesma rotina confere se existe produtos sem saldo.\r\n****************************************************************\r\n*/\r\nIf SubString(CNUMEMP,1,8) == \"01010101\"\r\n\tFor nX := 1 To Len(aNumCav)\r\n\r\n\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"D3_COD\",nX)) )\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\r\n\t\t\tcQuery  := \"  SELECT B8_PRODUTO,B1_DESC,B8_YCAVALE,B8_LOTECTL,B8_NUMLOTE,B8_YCAVALE+B8_LOTECTL+B8_NUMLOTE CHAVE,B8_LOCAL,B8_SALDO \r\n\t\t\tcQuery  += \"    FROM SB8010 SB8 INNER JOIN SB1010 SB1 ON (B8_PRODUTO = B1_COD)\r\n\t\t\tcQuery  += \"   WHERE SB8.D_E_L_E_T_ = ''\r\n\t\t\tcQuery  += \"     AND SB1.D_E_L_E_T_ = ''\r\n\t\t\tcQuery  += \"     AND B8_YCAVALE = '\"+aNumCav[nX]+\"'\r\n\t\t\tcQuery  += \"     AND B8_ORIGLAN = 'BD'\r\n\t\t\t\t\t\r\n\t\t\ttcQuery cQuery alias TRB new\r\n\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\tdbgotop()\r\n\t\t\tDo While !EOF()\r\n\t\t\t\r\n\t\t\t\t/*\r\n\t\t\t\tcavaletes incompletos\r\n\t\t\t\t*/\r\n\t\t\t\tIF !aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL] == TRB->CHAVE })  \r\n\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE} )\r\n\t\t\t\tElse\r\n\t\t\t\t\tif GDDeleted(aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL] == TRB->CHAVE }))\r\n\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE} )\r\n\t\t\t\t\tEndIf \r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t/*\r\n\t\t\t\tSem Saldo\r\n\t\t\t\t*/\t\r\n\t\t\t\tiF TRB->B8_SALDO == 0  \r\n\t\t\t\t\taAdd(aCavZero,{ TRB->CHAVE ,AllTrim(TRB->B8_PRODUTO)+\"-\"+ AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE} )\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\tdbSkip()\r\n\t\t\tEndDo\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t/*\r\n\t\t\tCavalete apagado\r\n\t\t\t*/\r\n\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\tdbgotop()\r\n\t\t\tIf EOF() .And.  !Empty(aNumCav[nX])\r\n\t\t\t\r\n\t\t\t\tIF !aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL] == TRB->CHAVE })  \r\n\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE} )\r\n\t\t\t\tElse\r\n\t\t\t\t\tif GDDeleted(aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL] == TRB->CHAVE }))\r\n\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE} )\r\n\t\t\t\t\tEndIf \r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\tdbCloseArea()\r\n\t\tEndIf\r\n\t\t\r\n\tNext nX\r\n\r\n\t/*\r\n\tIncompletos/Apagado\r\n\t*/\r\n\tcMSG := \"\"\r\n\tFor nX:=1 to Len(aTodCav)\r\n\t\tIf Empty(cMSG)\r\n\t\t\tcMSG := \"Cavaletes incompletos/Apagado:\" + chr(13)+chr(10) \r\n\t\tEndIf\t\t\t\r\n\t\tcMSG +=     \"  ->\" + AllTrim(aTodCav[nX][2]) + \" Cav.[\" + Alltrim(aTodCav[nX][3]) + \"] Lote[\" + Alltrim(aTodCav[nX][4]) + \"] SubLote.[\" + Alltrim(aTodCav[nX][5]) + \"]\"+ chr(13)+chr(10)   \r\n\tNext nX\r\n\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\tlRet := .F.\r\n\t\tReturn(lRet) \r\n\tEndIf\r\n\r\n\r\n\t/*\r\n\tSem Saldo\r\n\t*/\r\n\tcMSG := \"\"\r\n\tFor nX:=1 to Len(aCavZero)\r\n\t\tIf Empty(cMSG)\r\n\t\t\tcMSG := \"Produtos sem saldo:\" + chr(13)+chr(10) \r\n\t\tEndIf\t\t\t\r\n\t\tcMSG +=     \"  ->\" + AllTrim(aCavZero[nX][2]) + \" Cav.[\" + Alltrim(aCavZero[nX][3]) + \"] Lote[\" + Alltrim(aCavZero[nX][4]) + \"] SubLote.[\" + Alltrim(aCavZero[nX][5]) + \"]\"+ chr(13)+chr(10)   \r\n\tNext nX\r\n\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\tlRet := .F.\r\n\t\tReturn(lRet) \r\n\tEndIf\r\n\r\nEndIf\r\n/*\r\n****************************************************************\r\nConferencia se existe estes Lote/SubLotes em um PVenda salvo\r\n****************************************************************\r\n*/\r\n\r\n\r\nFor nX := 1 To Len(aGriLSPv)\r\n\t \t\r\n\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t//\"0005/0006/0034/0035/0036\"\r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1)\r\n\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"D3_COD\",nX)) )\r\n\t\r\n\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec .AND. !Empty(aGriLSPv[nX][1])\r\n\t \tcQuery  := \" SELECT C6_NUM,C6_ITEM,C6_LOTECTL,C6_NUMLOTE ,C6_DESCRI \r\n\t \tcQuery  += \"   FROM SC6010 SC6 INNER JOIN SC5010 SC5 ON (C5_FILIAL = C6_FILIAL AND C5_NUM = C6_NUM)\r\n\t \tcQuery  += \"  WHERE SC6.D_E_L_E_T_ = ''\r\n\t \tcQuery  += \"    AND SC5.D_E_L_E_T_ = ''\r\n\t \tcQuery  += \"    AND C5_TIPO = 'N'\r\n\t \tcQuery  += \" \tAND C6_LOTECTL = '\"+aGriLSPv[nX][1]+\"'\r\n\t \tcQuery  += \" \tAND C6_NUMLOTE = '\"+aGriLSPv[nX][2]+\"'\r\n\t \t//cQuery  += \"    AND C6_NUM <> '\"+AllTrim(M->C5_NUM)+\"'\r\n\t \t\r\n\t \ttcQuery cQuery alias TRB new\r\n\t\tdbSelectArea(\"TRB\")\r\n\t\tdbgotop()\r\n\t\tDo While !EOF()\r\n\t\t\r\n\t\t\tIf !aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })\r\n\t\t\t\taAdd(aLSPvLoca,{ AllTrim(TRB->C6_NUM) , TRB->C6_ITEM,TRB->C6_LOTECTL , TRB->C6_NUMLOTE , AllTrim(TRB->C6_DESCRI) } )\r\n\t\t\tElse\r\n\t\t\t\taLSPvLoca[aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })][2] := aLSPvLoca[aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })][2] + \",\" + TRB->C6_ITEM\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\t\t\r\n\t\tdbSelectArea(\"TRB\") \r\n\t\tdbCloseArea()\r\n\t\r\n\tEndIf\r\n\t\r\nNext nX\r\n\r\ncMSG := \"\"\r\nFor nX:=1 to Len(aLSPvLoca)\r\n\t\tIf Empty(cMSG)\r\n\t\t\tcMSG := \"Itens encontrados em outro P.Venda:\" + chr(13)+chr(10) \r\n\t\tEndIf\r\n\t\tcMSG += \"  -> P.Venda:\" + aLSPvLoca[nX][1] +\" Item:\"+ aLSPvLoca[nX][2] +\" Prod.:\" + aLSPvLoca[nX][5] + chr(13)+chr(10)   \r\nNext nX\r\n\r\nIf !Empty(cMSG)\r\n\tAlert(cMSG)\r\n\tlRet := .F.\r\n\tReturn(lRet) \r\nEndIf\r\n\r\n\t\r\nReturn(lRet)\r\n"}}}
Content-Length: 168
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/MTA261DOC.prw"}}}
Content-Length: 33125
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/Relcusto.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"PROTHEUS.CH\"\r\n#INCLUDE \"RWMAKE.CH\"\r\n\r\n\r\n//+----------+-----------+----------+-------------------------+------+-----------+\r\n//|Programa  |RELCUSTO   | Autor    |Marco Tulio M. Vianna    |Data  |30.10.2012 |\r\n//+----------+-----------+----------+-------------------------+------+-----------+  \r\n//|Descricao | Relatorio de Custos                                               |\r\n//+----------+-------------------------------------------------------------------+\r\n//| USO      | Estoque e Custos                                                  |\r\n//+----------+-------------------------------------------------------------------+\r\n//|                    ALTERACOES FEITAS DESDE A CRIACAO                         |\r\n//+----------+-----------+-------------------------------------------------------+\r\n//|Autor     | Data      | Descrição                                             |\r\n//+----------+-----------+-------------------------------------------------------+\r\n//|          |           |                                                       |\r\n//+----------+-----------+-------------------------------------------------------+\r\n\r\n\r\nUser Function Relcusto()\r\n\r\n\t//\tLocal oBTNCancelar\r\n\t//\tLocal oBTNOk\r\n\t//\tLocal oGETData\r\n\t//\tLocal dGETDatade := Date()\r\n\t//\tLocal dGETDataate := Date()\r\n\t//\tLocal oGPRImpCP\r\n\t//\tLocal oLBLData\r\n\t//\tStatic oDLGImpCP\r\n\r\n\t//  \tDEFINE MSDIALOG oDLGImpCP FROM 000, 000  TO 150, 400 COLORS 0, 16777215 PIXEL\r\n\r\n\t//    @ 005, 005 GROUP oGPRImpCP TO 069, 193 PROMPT \"Monta Tabelas Para Relatório de Custos\" OF oDLGImpCP COLOR 0, 16777215 PIXEL\r\n\t//    @ 046, 044 BUTTON oBTNOk PROMPT \"&OK\" SIZE 037, 012 OF oDLGImpCP ACTION (MsgRun(\"Rel. Custos\",\"Aguarde\",{||fImporta(dGETDatade,dGetDataate)}),oDLGImpCP:End())  PIXEL \r\n\t//    @ 045, 106 BUTTON oBTNCancelar PROMPT \"&Cancelar\" SIZE 037, 012 OF oDLGImpCP ACTION oDLGImpCP:End() PIXEL\r\n\t//    @ 026, 009 SAY oLBLData PROMPT \"Data de: \" SIZE 048, 007 OF oDLGImpCP COLORS 0, 16777215 PIXEL\r\n\t//    @ 023, 054 MSGET oGETData VAR dGETDatade SIZE 060, 010 OF oDLGImpCP COLORS 0, 16777215 PIXEL\r\n\t//    @ 036, 009 SAY oLBLData PROMPT \"Data ate: \" SIZE 048, 007 OF oDLGImpCP COLORS 0, 16777215 PIXEL\r\n\t//    @ 033, 054 MSGET oGETData VAR dGETDataate SIZE 060, 010 OF oDLGImpCP COLORS 0, 16777215 PIXEL\r\n\r\n\t//  \tACTIVATE MSDIALOG oDLGImpCP CENTERED\r\n\r\n\t//Return\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Define Variaveis                                             ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLOCAL CbTxt\r\n\tLOCAL cString:= \"SD2\"\r\n\tLOCAL CbCont,cabec1,cabec2\r\n\tLOCAL titulo := OemToAnsi(\"Relatorio de Custos\")\t//\"Relatorio de Custos\"\r\n\tLOCAL cDesc1 := OemToAnsi(\"Emissao do Relatorio de Custos\")\t//\"Emissao do Relatorio de Custos \"\r\n\tLOCAL cDesc2 := OemToAnsi(\" \")\t//\"\"\r\n\tLOCAL cDesc3 := OemToAnsi(\" \")\t//\"\"\r\n\tLOCAL tamanho:= \"G\" \r\n\tLOCAL nTipo    := 0\r\n\tLOCAL limite := 65\r\n\tLOCAL lImprime := .T.\r\n\tcGrtxt := SPACE(11)\r\n\tPRIVATE aReturn := { \"REL. CUSTOS\", 1,\"REL. CUSTOS\", 1, 2, 1, \"\",1 }\t\t//\"Zebrado\"###\"Administracao\"\r\n\tPRIVATE nomeprog:=\"RELCUSTO\"\r\n\tPRIVATE nLastKey := 0\r\n\tPRIVATE cPerg   :=\"RELCUSTO\"  \r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis utilizadas para Impressao do Cabecalho e Rodape    ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tcbtxt    := SPACE(10)\r\n\tcbcont   := 00\r\n\tli       := 132\r\n\tm_pag    := 01\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Verifica as perguntas selecionadas                           ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t//AjustaSX1()\r\n\tpergunte(\"RELCUSTO\",.T.)\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis utilizadas para parametros                         ³\r\n\t//³ mv_par01      A partir de                                    ³\r\n\t//³ mv_par02      Ate a Data                                     ³\r\n\t//³ mv_par03      Centro de Custo de                             ³\r\n\t//³ mv_par04      Centro de Custo Até                            ³\r\n\t//  mv_par05      Filial de                                      ³ \r\n\t//  mv_par06      Filial ate                                     ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Envia controle para a funcao SETPRINT                        ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\twnrel:=\"RELCUSTO\"            //Nome Default do relatorio em Disco\r\n\r\n\t//aOrd :={STR0007,STR0008,STR0009,STR0010,STR0011,STR0036}\t\t//\"Por Tp/Saida+Produto\"###\"Por Tipo    \"###\"Por Grupo  \"###\"P/Ct.Contab.\"###\"Por Produto \" ### \"Por Tp Saida + Serie + Nota \"\r\n\taOrd :={\"NATUREZA\"}\t\t\r\n\t//wnrel:=SetPrint(cString,wnrel,cPerg,titulo,cDesc1,cDesc2,cDesc3,.T.,aOrd,,Tamanho)\r\n\twnrel:=SetPrint(,wnrel,cPerg,titulo,cDesc1,cDesc2,cDesc3,.T.,aOrd,,Tamanho)\r\n\r\n\tIf nLastKey==27\r\n\t\tdbClearFilter()\r\n\t\tReturn\r\n\tEndif\r\n\r\n\tSetDefault(aReturn,cString)\r\n\r\n\tIf nLastKey==27\r\n\t\tdbClearFilter()\r\n\t\tReturn\r\n\tEndif\r\n\r\n\tRptStatus({|lEnd| fImprime(@lEnd,wnRel,cString)},Titulo)\r\n\r\nReturn\r\n\r\n\r\n/*+----------+-----------+----------+-------------------------+------+-----------+\r\n|Programa  |fImprime   | Autor    |Marco Túlio M. Vianna    |Data  |29.10.2012 |\r\n+----------+-----------+----------+-------------------------+------+-----------+\r\n|Descricao | Programa de Impressao P/ Relatório de Custos                      |\r\n+----------+-------------------------------------------------------------------+\r\n| USO      | Financeiro                                                       |\r\n+----------+-------------------------------------------------------------------+\r\n|                    ALTERACOES FEITAS DESDE A CRIACAO                         |\r\n+----------+-----------+-------------------------------------------------------+\r\n|Autor     | Data      | Descrição                                             |\r\n+----------+-----------+-------------------------------------------------------+\r\n|          |           |                                                       |\r\n+----------+-----------+-------------------------------------------------------+ \r\n*/  \t\r\n\r\nStatic Function fImprime(lEnd,WnRel,cString)\r\n\r\n\tLocal cQuery \r\n\tLocal cQryFP   \r\n\tLocal cQryTF\r\n\tLocal cArq    := \"\"\r\n\tLocal cArquivo:= \"\"\r\n\tLocal cFil    := \"\"\r\n\tLocal cDataArqde  := \"\"\r\n\tLocal cTipoDoc:= \"\"\r\n\tLocal cTipoFiltro := \"\"                \r\n\tLocal dEmissao:= Ctod(\"\")\r\n\tLocal aArea   := GetArea()\r\n\tLocal aSelecDocs  := {}\r\n\tLocal lFiltro  := .T.\r\n\tLocal nTotalFat := 0\r\n\tLocal aPrdCusto := {}\r\n\tLocal aPercCusto := {}\r\n\tLocal aNatCusto := {}\r\n\tLocal aQtdeCusto := {}\r\n\tLocal aTotalCusto := {}\r\n\tLocal aTotalFat := {}\r\n\tLocal aNatCod := {}\r\n\tLocal aNatValor := {}\r\n\tLocal aFator := {}\r\n\tLocal aCodDev := {}\r\n\tLocal aPrdDev := {}           \r\n\tLocal aPrdQTDV := {}\r\n\tLocal nI := 0\r\n\tLocal nJ := 0 \r\n\tLocal Tamanho := \"P\"\r\n\tLocal nTipo := 0\r\n\t//LOCAL wnrel := \"RELCUSTO\"\r\n\tPrivate cArqTmp\r\n\tPrivate cArqTfp\r\n\tPrivate cArqTtf   \r\n\tPrivate Li\r\n\tcDataArqde :=  Substr(DtoC(MV_PAR01),7,4)+Substr(DtoC(MV_PAR01),4,2)+Substr(DtoC(MV_PAR01),1,2)\r\n\tcDataArqate := Substr(DtoC(MV_PAR02),7,4)+Substr(DtoC(MV_PAR02),4,2)+Substr(DtoC(MV_PAR02),1,2)\r\n\r\n\tIf Alltrim(MV_PAR03 ) <= \"\"\r\n\t\tMV_PAR03 := \"0\"\r\n\tEndif                 \r\n\t/*\r\n\tcQuery := \"SELECT DISTINCT(E2_NUM+E2_FORNECE+E2_LOJA), E2_NATUREZ, DE_DOC,DE_SERIE,DE_CC,DE_CUSTO1 AS CUSTO,D1_COD from \" + RetSqlName(\"SDE\") + \" SDE050, \" +  RetSqlName(\"SD1\") + \" SD1050, \"  +  RetSqlName(\"SF1\") + \" SF1050, \" +  RetSqlName(\"SE2\") + \" SE2050 \"\r\n\tcQuery += \"WHERE D1_ITEM = DE_ITEMNF AND\"\r\n\tcQuery += \" E2_FORNECE = DE_FORNECE AND E2_LOJA = DE_LOJA AND E2_NUM = DE_DOC AND\"\r\n\tcQuery += \" D1_FORNECE = DE_FORNECE AND D1_LOJA = DE_LOJA AND D1_DOC = DE_DOC AND\"\r\n\tcQuery += \" F1_FORNECE = DE_FORNECE AND F1_LOJA = DE_LOJA AND F1_DOC = DE_DOC AND\"    \r\n\tcQuery += \" F1_EMINFE BETWEEN '\" + cDataArqde + \"' AND '\" + cDataArqate + \"' AND\" \r\n\tcQuery += \" F1_FILIAL >= '\" + MV_PAR05 + \"' AND F1_FILIAL <= '\" + MV_PAR06 + \"' AND\"\r\n\tcQuery += \" DE_CC >= '\" + MV_PAR03 + \"' AND DE_CC <= '\" + MV_PAR04 + \"' AND\"                                      \r\n\tcQuery += \" SF1050.D_E_L_E_T_ <> '*' AND\"\r\n\tcQuery += \" SD1050.D_E_L_E_T_ <> '*' AND\"\r\n\tcQuery += \" SDE050.D_E_L_E_T_ <> '*'\" \r\n\tcQuery += \" ORDER BY DE_CC, E2_NATUREZ\"       \r\n\t*/        \r\n\r\n\t//Bruno Lage                           \r\n\t// COM RATEIO CDE\r\n\tcQuery := \"SELECT DISTINCT(E2_NUM+E2_FORNECE+E2_LOJA), E2_NATUREZ, DE_DOC,DE_SERIE,DE_CC,DE_CUSTO1 AS CUSTO,D1_COD \r\n\tcQuery += \"  FROM \" + RetSqlName(\"SDE\") + \" SDE050, \" +  RetSqlName(\"SD1\") + \" SD1050, \"  +  RetSqlName(\"SF1\") + \" SF1050, \" +  RetSqlName(\"SE2\") + \" SE2050 \"\r\n\tcQuery += \"WHERE D1_ITEM        = DE_ITEMNF \r\n\tcQuery += \"      AND E2_FORNECE = DE_FORNECE                                                     \r\n\tcQuery += \"      AND E2_LOJA    = DE_LOJA \r\n\tcQuery += \"      AND E2_NUM     = DE_DOC \r\n\tcQuery += \"      AND D1_FORNECE = DE_FORNECE \r\n\tcQuery += \"      AND D1_LOJA    = DE_LOJA \r\n\tcQuery += \"      AND D1_DOC     = DE_DOC \r\n\tcQuery += \"      AND F1_FORNECE = DE_FORNECE \r\n\tcQuery += \"      AND F1_LOJA    = DE_LOJA \r\n\tcQuery += \"      AND F1_DOC     = DE_DOC  \r\n\tcQuery += \"      AND D1_FILIAL  = F1_FILIAL\r\n\tcQuery += \"      AND E2_FILIAL  = F1_FILIAL \r\n\tcQuery += \"      AND DE_FILIAL  = F1_FILIAL     \r\n\tcQuery += \"      AND E2_BAIXA  BETWEEN '\" + cDataArqde + \"' AND '\" + cDataArqate + \"' AND\r\n\t//cQuery += \" F1_EMINFE BETWEEN '' AND '' AND\"\r\n\tcQuery += \" F1_FILIAL >= '\" + MV_PAR05 + \"' AND F1_FILIAL <= '\" + MV_PAR06 + \"' AND\"\r\n\tcQuery += \" DE_CC >= '\" + MV_PAR03 + \"' AND DE_CC <= '\" + MV_PAR04 + \"' AND\"                                      \r\n\tcQuery += \" SF1050.D_E_L_E_T_ <> '*' AND\"\r\n\tcQuery += \" SD1050.D_E_L_E_T_ <> '*' AND\"\r\n\tcQuery += \" SDE050.D_E_L_E_T_ <> '*'\" \r\n\tcQuery += \" ORDER BY DE_CC, E2_NATUREZ\"  \r\n\r\n\r\n\tcQuery := ChangeQuery(cQuery)\r\n\r\n\r\n\tdbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), 'CSDE', .T., .F.)\r\n\r\n\tdbSelectArea(\"CSDE\")\r\n\tCSDE->(dbgotop() )\r\n\r\n\t// ENTRADAS DE NOTAS + FRETE\r\n\t/*\r\n\tcQuery := \"SELECT DISTINCT(D1_DOC+D1_SERIE+D1_FORNECE),D1_COD, D1_DOC,D1_SERIE,D1_FORNECE, E2_NATUREZ, D1_CC,(D1_TOTAL-D1_DESC) AS CUSTO from \" + RetSqlName(\"SE2\") + \" SE2050, \"  + RetSqlName(\"SD1\") + \" SD1050, \"  +  RetSqlName(\"SF1\") + \" SF1050 \"\r\n\tcQuery += \"WHERE D1_FORNECE = E2_FORNECE AND D1_LOJA = E2_LOJA AND D1_DOC = E2_NUM AND\"\r\n\tcQuery += \" F1_FORNECE = E2_FORNECE AND F1_LOJA = E2_LOJA AND F1_DOC = E2_NUM AND\"    \r\n\tcQuery += \" F1_EMINFE BETWEEN '\" + cDataArqde + \"' AND '\" + cDataArqate + \"' AND\"\r\n\tcQuery += \" E2_FILIAL >= '\" + MV_PAR05 + \"' AND E2_FILIAL <= '\" + MV_PAR06 + \"' AND\"       \\\r\n\tcQuery += \" D1_CC >= '\" + MV_PAR03 + \"' AND D1_CC <= '\" + MV_PAR04 + \"' AND\"                                      \r\n\tcQuery += \" SE2050.D_E_L_E_T_ <> '*' AND\"\r\n\tcQuery += \" SD1050.D_E_L_E_T_ <> '*'\" \r\n\tcQuery += \" ORDER BY D1_CC,E2_NATUREZ\"\r\n\t*/\r\n\t// Bruno Lage \r\n\t// SEM RATEIO NO CDE - CENTRO DE CUSTOS        \r\n\tcQuery := \" SELECT INDEX1,D1_COD,D1_DOC,D1_SERIE,D1_FORNECE,E2_NATUREZ,D1_CC,SUM(CUSTO) CUSTO FROM (           \r\n\r\n\tcQuery += \" SELECT DISTINCT\r\n\tcQuery += \"\t\t\t(F1_DOC+F1_SERIE+F1_FORNECE) INDEX1 ,\r\n\tcQuery += \"\t\t\tCASE WHEN RTRIM(LTRIM(E2_NATUREZ)) = '2.3.018' THEN '001472' ELSE D1_COD END D1_COD, \r\n\tcQuery += \"\t\t\tD1_DOC,\r\n\tcQuery += \"\t\t\tD1_SERIE,\r\n\tcQuery += \"\t\t\tD1_FORNECE, \r\n\tcQuery += \"\t\t\tE2_NATUREZ, \r\n\tcQuery += \"\t\t\tCASE WHEN RTRIM(LTRIM(D1_CC)) = '' THEN 'SEM CC' ELSE D1_CC END  D1_CC,       \r\n\tcQuery += \"\t\t\tCASE \r\n\tcQuery += \"\t\t\t\tWHEN E2_SALDO = 0 THEN  (((D1_TOTAL - D1_DESC) /(F1_VALBRUT)* 100) * ((E2_VALOR - E2_DECRESC)  + E2_JUROS))/100\t\t\t\t\r\n\tcQuery += \"\t\t\t\tWHEN E2_SALDO <> 0 THEN (((D1_TOTAL - D1_DESC) /(F1_VALBRUT)* 100) * ((E2_VALLIQ - E2_DECRESC) + E2_JUROS))/100  \r\n\tcQuery += \"\t\t\tEND CUSTO\r\n\tcQuery += \"    FROM \" + RetSqlName(\"SE2\") + \" SE2050, \"  + RetSqlName(\"SD1\") + \" SD1050, \"  +  RetSqlName(\"SF1\") + \" SF1050 \r\n\tcQuery += \"    WHERE D1_FORNECE = E2_FORNECE \r\n\tcQuery += \"      AND D1_LOJA = E2_LOJA \r\n\tcQuery += \"      AND D1_DOC = E2_NUM \r\n\t//cQuery += \"      AND F1_FORNECE = E2_FORNECE \r\n\t//cQuery += \"      AND F1_LOJA = E2_LOJA \r\n\tcQuery += \"      AND F1_DOC = E2_NUM \r\n\tcQuery += \"      AND F1_EMISSAO = D1_EMISSAO\r\n\tcQuery += \"      AND F1_FILIAL = D1_FILIAL  \r\n\tcQuery += \"      AND E2_FILIAL = D1_FILIAL  \r\n\tcQuery += \"      AND E2_BAIXA  BETWEEN '\" + cDataArqde + \"' AND '\" + cDataArqate + \"'\r\n\tcQuery += \"      AND E2_FILIAL >=  '\" + MV_PAR05 + \"'\r\n\tcQuery += \"      AND E2_FILIAL <=  '\" + MV_PAR06 + \"' \r\n\t//cQuery += \"      AND D1_CC >= '\" + MV_PAR03 + \"'\r\n\t//cQuery += \"      AND D1_CC <= '\" + MV_PAR04 + \"'\r\n\tcQuery += \"      AND SE2050.D_E_L_E_T_ <> '*' \r\n\tcQuery += \"      AND SD1050.D_E_L_E_T_ <> '*'\r\n\tcQuery += \"      AND SF1050.D_E_L_E_T_ <> '*'\r\n\t//cQuery += \"      AND E2_NATUREZ <> '2.3.018'   \r\n\tcQuery += \"      AND E2_VALLIQ <> 0\r\n\tcQuery += \"      AND D1_RATEIO  = 2\r\n\tcQuery += \" \t) TB_TBNF\r\n\tcQuery += \" WHERE D1_CC >= '\" + MV_PAR03 + \"'\r\n\tcQuery += \"   AND D1_CC <= '\" + MV_PAR04 + \"'    \r\n\tcQuery += \" GROUP BY INDEX1,D1_COD,D1_DOC,D1_SERIE,D1_FORNECE,E2_NATUREZ,D1_CC\r\n\tcQuery += \" ORDER BY D1_CC,E2_NATUREZ\r\n\r\n\r\n\tcQuery := ChangeQuery(cQuery)                                                 \r\n\r\n\tdbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), 'CSD1', .T., .F.)\r\n\r\n\tdbSelectArea(\"CSD1\")\r\n\tCSD1->(dbgotop() )\r\n\r\n\r\n\t/*\r\n\tMov. De estoques\r\n\t*/\r\n\tcQueryD3 := \" SELECT D3_COD,D3_CC,D3_DOC, D3_UM, D3_QUANT, D3_CUSTO1,B1_GRUPO from \" + RetSqlName(\"SD3\") + \" SD3050, \" + RetSqlName(\"SB1\") + \" SB1050\"\r\n\tcQueryD3 += \" WHERE SD3050.D3_EMISSAO BETWEEN '\" + cDataArqde + \"' AND '\" + cDataArqate + \"' AND\"\r\n\tcQueryD3 += \" SD3050.D3_FILIAL >= '\" + MV_PAR05 + \"' AND SD3050.D3_FILIAL <= '\" + MV_PAR06 + \"' AND\"\r\n\tcQueryD3 += \" SD3050.D_E_L_E_T_ <> '*'  AND SD3050.D3_CF >= 'RE0'AND D3_CF<= 'RE9' AND\"                \r\n\tcQueryD3 += \" SB1050.D_E_L_E_T_ <> '*'  AND SB1050.B1_COD = D3_COD AND SD3050.D3_ESTORNO <> 'S' AND\"                \r\n\tcQueryD3 += \" SD3050.D3_CC > = '\" + MV_PAR03 + \"' AND SD3050.D3_CC <= '\" + MV_PAR04\r\n\tcQueryD3 += \"' ORDER BY SD3050.D3_CC,B1_GRUPO,D3_COD\"\r\n\r\n\tcQueryD3 := ChangeQuery(cQueryD3)\r\n\r\n\tdbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQueryD3), 'CSD3', .T., .F.)\r\n\r\n\tdbSelectArea(\"CSD3\")\r\n\tCSD3->(dbgotop() )\t                                       \r\n\r\n\t//IMPOSTOS + AUTORIZACAO DE PAGAMENTOS \r\n\t//Bruno Lage           \r\n\r\n\tcQueryZ2 := \" SELECT * FROM (\r\n\r\n\tcQueryZ2 += \" SELECT E2_PREFIXO,E2_NUM,E2_PARCELA,E2_NATUREZ,CASE WHEN RTRIM(LTRIM(E2_CCD)) = '' THEN 'SEM CC' ELSE E2_CCD END  E2_CCD , \r\n\tcQueryZ2 += \"\t\t\tCASE \r\n\tcQueryZ2 += \"\t\t\t\tWHEN E2_SALDO = 0 THEN  E2_VALOR  \r\n\tcQueryZ2 += \"\t\t\t\tWHEN E2_SALDO <> 0 THEN E2_VALLIQ \r\n\tcQueryZ2 += \"\t\t\tEND CUSTO                            \r\n\tcQueryZ2 += \" FROM SE2050 SE2050\"\r\n\tcQueryZ2 += \" WHERE SE2050.E2_BAIXA BETWEEN '\" + cDataArqde + \"' AND '\" + cDataArqate + \"' AND\"\r\n\tcQueryZ2 += \" SE2050.D_E_L_E_T_ <> '*'  AND \"\r\n\tcQueryZ2 += \" SE2050.E2_TIPO NOT IN('PA','PF','NF') AND \"                \r\n\tcQueryZ2 += \" (SE2050.E2_PREFIXO IN( 'AUT','FP','FPS','FPV','INS','IRR','FGT','','SAG') ) AND\r\n\tcQueryZ2 += \" SE2050.E2_FILIAL >= '\" + MV_PAR05 + \"' AND SE2050.E2_FILIAL <= '\" + MV_PAR06 + \"'\"\t\r\n\tcQueryZ2 += \" AND E2_ARQRAT = ''  \r\n\tcQueryZ2 += \" AND E2_TITPAI = ''   \r\n\t//\tcQueryZ2 += \" AND E2_RATEIO = 'N' \r\n\r\n\tcQueryZ2 += \" UNION ALL           \r\n\r\n\t//SELECT SE2.E2_CCD,E2_NUM,TEMP_PQ.*\r\n\tcQueryZ2 += \" SELECT TEMP_PQ.PREFIXO E2_PREFIXO,\r\n\tcQueryZ2 += \"        TEMP_PQ.NUM     E2_NUM,\r\n\tcQueryZ2 += \"        TEMP_PQ.PARCELA E2_PARCELA,\r\n\tcQueryZ2 += \"        TEMP_PQ.E2_NATUREZ E2_NATUREZ,\r\n\tcQueryZ2 += \"        SE2.E2_CCD E2_CCD,\r\n\tcQueryZ2 += \"        CASE \r\n\tcQueryZ2 += \"\t\t\tWHEN TEMP_PQ.MULTA = 0 THEN TEMP_PQ.VALOR\r\n\tcQueryZ2 += \"\t   \t\tWHEN TEMP_PQ.MULTA <> 0 AND TEMP_PQ.VALOR = TEMP_PQ.MULTA  THEN TEMP_PQ.MULTA\r\n\tcQueryZ2 += \"\t   \t\tWHEN TEMP_PQ.MULTA <> 0 AND TEMP_PQ.VALOR <> TEMP_PQ.MULTA THEN TEMP_PQ.VALOR - TEMP_PQ.MULTA \r\n\tcQueryZ2 += \"\t\t END AS CUSTO\r\n\tcQueryZ2 += \"   FROM SE2050 SE2 , SE5050 SE5 ,\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t(\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\tSELECT DISTINCT E2_NUMLIQ NUMLIQ, E2_NATUREZ,E2_TIPO TIPO,E2_BAIXA BAIXA,E2_NUM NUM,E2_PREFIXO PREFIXO,E2_PARCELA PARCELA,E2_FORNECE FORNECE,E2_LOJA LOJA ,E2_FILIAL FILIAL,E5_VALOR VALOR,E2_MULTA MULTA\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t  FROM SE2050 SE2 , SE5050 SE5\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t WHERE SE2.D_E_L_E_T_ = ''\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND SE5.D_E_L_E_T_ = ''\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E5_NUMERO  = E2_NUM\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E5_PREFIXO = E2_PREFIXO\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E5_PARCELA = E2_PARCELA\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E5_CLIFOR  = E2_FORNECE\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E5_LOJA    = E2_LOJA\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E5_FILORIG = E2_FILIAL \r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E5_TIPO    IN ('PF','BOL','RC')   \r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E5_TIPODOC <> 'JR'\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E5_RECPAG  = 'P'\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E2_NUMLIQ  <> ''\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t   AND E2_BAIXA   BETWEEN '\" + cDataArqde + \"' AND '\" + cDataArqate + \"'\r\n\t//cQueryZ2 += \" \t\t\t\t\t\t\t\t --AND E2_NUMLIQ = '000211'\r\n\tcQueryZ2 += \" \t\t\t\t\t\t\t\t)TEMP_PQ\r\n\tcQueryZ2 += \"  WHERE SE2.D_E_L_E_T_ = ''\r\n\tcQueryZ2 += \"    AND SE5.D_E_L_E_T_ = ''\r\n\tcQueryZ2 += \"    AND E5_NUMERO  = SE2.E2_NUM\r\n\tcQueryZ2 += \"    AND E5_PREFIXO = SE2.E2_PREFIXO\r\n\tcQueryZ2 += \"    AND E5_PARCELA = SE2.E2_PARCELA\r\n\tcQueryZ2 += \"    AND E5_CLIFOR  = SE2.E2_FORNECE\r\n\tcQueryZ2 += \"    AND E5_LOJA    = SE2.E2_LOJA\r\n\tcQueryZ2 += \"    AND E5_FILORIG = SE2.E2_FILIAL \r\n\tcQueryZ2 += \"    AND E5_DOCUMEN = NUMLIQ\r\n\tcQueryZ2 += \"    AND E2_FILIAL  = FILIAL \r\n\tcQueryZ2 += \"    AND E2_FORNECE = FORNECE\r\n\tcQueryZ2 += \"    AND E2_LOJA    = LOJA\r\n\tcQueryZ2 += \"    AND E2_PREFIXO = PREFIXO\r\n\tcQueryZ2 += \"    AND E2_TIPO    = TIPO\r\n\r\n\tcQueryZ2 += \" UNION ALL\r\n\r\n\tcQueryZ2 += \"  SELECT E2_PREFIXO,E2_NUM,E2_PARCELA,E2_NATUREZ,CV4_CCD  E2_CCD, CV4_VALOR AS CUSTO \r\n\tcQueryZ2 += \"  FROM SE2050 SE2050 , CV4050 CV4050\r\n\tcQueryZ2 += \"  WHERE SE2050.E2_BAIXA BETWEEN '\" + cDataArqde + \"' AND '\" + cDataArqate + \"'\" \r\n\tcQueryZ2 += \"  AND SE2050.D_E_L_E_T_ <> '*'  \r\n\tcQueryZ2 += \"  AND CV4050.D_E_L_E_T_ <> '*'\r\n\tcQueryZ2 += \"  AND CV4_FILIAL+CV4_DTSEQ+CV4_SEQUEN = E2_ARQRAT\r\n\tcQueryZ2 += \"  AND SE2050.E2_TIPO NOT  IN('PA','PF','NF')\r\n\tcQueryZ2 += \"  AND (SE2050.E2_PREFIXO IN( 'AUT','FP','FPS','FPV','INS','IRR','FGT','','SAG')  ) \r\n\tcQueryZ2 += \"  AND SE2050.E2_FILIAL >= '\" + MV_PAR05 + \"' AND SE2050.E2_FILIAL <= '\" + MV_PAR06 + \"'\" \r\n\tcQueryZ2 += \"  AND E2_ARQRAT <> ''     \r\n\tcQueryZ2 += \"  AND CV4_FILIAL = E2_FILIAL\r\n\r\n\tcQueryZ2 += \" UNION ALL\r\n\r\n\tcQueryZ2 += \" SELECT 'MBO' E2_PREFIXO,CONVERT(VARCHAR(10),CAST(E5_DATA AS DATE),105) E2_NUM,E5_FILORIG E2_PARCELA,E5_NATUREZ E2_NATUREZ,'10101001' E2_CCD, E5_VALOR AS CUSTO \r\n\tcQueryZ2 += \" FROM SE5050 SE5050 \r\n\tcQueryZ2 += \" WHERE SE5050.E5_DATA BETWEEN '\" + cDataArqde + \"' AND '\" + cDataArqate + \"'\"\r\n\tcQueryZ2 += \" AND D_E_L_E_T_ = ''\r\n\tcQueryZ2 += \" AND E5_FILORIG BETWEEN '\" + MV_PAR05 + \"' AND '\" + MV_PAR06 + \"'\"\r\n\tcQueryZ2 += \" AND E5_NATUREZ = '2.6.001'             \r\n\r\n\tcQueryZ2 += \" ) TB_TEMP\r\n\tcQueryZ2 += \" WHERE E2_CCD >= '\" + MV_PAR03 + \"'\"\r\n\tcQueryZ2 += \" AND E2_CCD   <= '\" + MV_PAR04 + \"'\"\r\n\r\n\tcQueryZ2 += \" ORDER BY E2_CCD,E2_NATUREZ\r\n\r\n\tcQueryZ2 := ChangeQuery(cQueryZ2)\r\n\r\n\tdbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQueryZ2), 'CSZ2', .T., .F.)\r\n\r\n\tdbSelectArea(\"CSZ2\")\r\n\tCSZ2->(dbgotop() )\t\r\n\r\n\r\n\tnlin := 70                                                                                      \r\n\tnQt := 0\r\n\tnTotalCusto := 0  \r\n\tcCusto := \"cCustoRel\"\r\n\tnTotCustoCC := 0\r\n\tnTotCusto := 0\r\n\tcCabec2 := \"Natureza/Produto                          Documento  Série Qtde     Total\"\r\n\tWhile ! CSDE->(Eof() ) .OR. ! CSD3->(Eof()) .OR. ! CSZ2->(Eof()) .OR. ! CSD1->(Eof())\r\n\t\tIf nLin >= 58\r\n\t\t\tCabec(\"Relatorio de Custos\",\"Periodo: \" + DTOC(MV_PAR01) + \" a \" + DTOC(MV_PAR02),cCabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t//nLin := 5\r\n\t\t\t//@ nLin,  60 PSay \"Relatório de Custos\"\r\n\t\t\t//@ nLin+1,65 PSay \"Periodo: \" + DTOC(MV_PAR01) + \" a \" + DTOC(MV_PAR02)\r\n\t\t\t//@ nLin+2, 0 PSay \"------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------\"        \r\n\t\t\t//nLin := nLin + 3\r\n\t\t\t//@ nLin,  0 PSay \"Natureza/Produto                          Documento  Série Qtde     Total\"\r\n\t\t\t//XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX 999999999  999   9,999.99 99,999,999.99\r\n\t\t\t//0         1         2         3         4         5         6         7         8         9\r\n\t\t\t//012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012\r\n\t\t\t//@ nLin+1,0 PSay   \"---------------------------------------------------------------------------------\"     \r\n\t\t\t//nLin := nLin + 2 \r\n\t\t\tnLin := Li\r\n\t\tEndif\r\n\t\tIF (ALLTRIM(cCusto) <> ALLTRIM(CSDE->DE_CC) .AND. ALLTRIM(cCusto) <> ALLTRIM(CSD3->D3_CC) .AND. ALLTRIM(cCusto) <> ALLTRIM(CSZ2->E2_CCD) .AND. ALLTRIM(cCusto) <> ALLTRIM(CSD1->D1_CC))\r\n\t\t\tIf nTotCustoCC > 0\r\n\t\t\t\t@ nLin,0 PSay \"---------------------------------------------------------------------------------\"\r\n\t\t\t\t@ nLin+1,0 PSay \"Total Centro de Custo ------------->\"\r\n\t\t\t\t@ nLin+1, 66 PSay nTotCustoCC Picture \"@E 9,999,999.99\"\r\n\t\t\t\tnLin := nLin+2\r\n\t\t\tEndif  \r\n\t\t\t@ nLin,0 PSay \"---------------------------------------------------------------------------------\"\r\n\t\t\tIf (! CSDE->(EOF())) .AND. (ALLTRIM(CSDE->DE_CC) < ALLTRIM(CSD3->D3_CC) ) .OR. ALLTRIM(CSD3->D3_CC) <= \"\"\r\n\t\t\t\tIf (! CSDE->(EOF())) .AND. (ALLTRIM(CSDE->DE_CC) < ALLTRIM(CSZ2->E2_CCD) ) .OR. ALLTRIM(CSZ2->E2_CCD) = \"\"\r\n\t\t\t\t\tIf (! CSDE->(EOF())) .AND. (ALLTRIM(CSDE->DE_CC) < ALLTRIM(CSD1->D1_CC) ) .OR. ALLTRIM(CSD1->D1_CC) = \"\"\r\n\t\t\t\t\t\tcCusto := CSDE->DE_CC\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcCusto := CSD1->D1_CC\r\n\t\t\t\t\tEndif \r\n\t\t\t\tElse\r\n\t\t\t\t\tIf (! CSZ2->(EOF())) .AND. (ALLTRIM(CSZ2->E2_CCD) < ALLTRIM(CSD1->D1_CC) ) .OR. ALLTRIM(CSD1->D1_CC) = \"\"\r\n\t\t\t\t\t\tcCusto := CSZ2->E2_CCD\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcCusto := CSD1->D1_CC\r\n\t\t\t\t\tEndif \r\n\t\t\t\tEndif                    \r\n\t\t\tElse\r\n\t\t\t\tIf (! CSD3->(EOF())) .AND. (ALLTRIM(CSD3->D3_CC) < ALLTRIM(CSZ2->E2_CCD) ) .OR. ALLTRIM(CSZ2->E2_CCD) = \"\"\r\n\t\t\t\t\tIf (! CSD3->(EOF())) .AND. (ALLTRIM(CSD3->D3_CC) < ALLTRIM(CSD1->D1_CC) ) .OR. ALLTRIM(CSD1->D1_CC) = \"\"\r\n\t\t\t\t\t\tcCusto := CSD3->D3_CC\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcCusto := CSD1->D1_CC\r\n\t\t\t\t\tEndif                    \r\n\t\t\t\tElse\r\n\t\t\t\t\tIf (! CSZ2->(EOF())) .AND. (ALLTRIM(CSZ2->E2_CCD) < ALLTRIM(CSD1->D1_CC) ) .OR. ALLTRIM(CSD1->D1_CC) = \"\"\r\n\t\t\t\t\t\tcCusto := CSZ2->E2_CCD\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcCusto := CSD1->D1_CC\r\n\t\t\t\t\tEndif \r\n\t\t\t\tEndif                     \r\n\t\t\t\t//           Endif    \r\n\t\t\tEndif     \r\n\t\t\t@ nLin+1,0 Psay cCusto + \" - \" + Posicione(\"CTT\", 1, XFilial(\"CTT\")+cCusto, \"CTT->CTT_DESC01\" )\r\n\t\t\t@ nLin+2,0 PSay \"---------------------------------------------------------------------------------\"\r\n\t\t\tnLin := nLin + 3\r\n\t\t\tnTotCustoCC := 0\r\n\t\tEndif              \r\n\t\tlTitulo := .T. \r\n\t\tnTotNat := 0\r\n\t\tWHILE alltrim(cCusto) == alltrim(CSDE->DE_CC )\r\n\t\t\tcNat := CSDE->E2_NATUREZ\r\n\t\t\tIf nLin >= 58\r\n\t\t\t\tCabec(\"Relatorio de Custos\",\"Periodo: \" + DTOC(MV_PAR01) + \" a \" + DTOC(MV_PAR02),cCabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\tnLin := Li\r\n\t\t\tEndif   \r\n\t\t\tIf LTitulo\r\n\t\t\t\tnLin := nLin + 1\r\n\t\t\t\t@ nLin, 0 PSay \"Notas Fiscais de Entrada ... \"\r\n\t\t\t\tnLin := nLin+2         \r\n\t\t\t\tlTitulo := .F.\r\n\t\t\tEndif  \r\n\r\n\t\t\t@ nLin,  0 PSay substr(Posicione(\"SB1\", 1, XFilial(\"SB1\")+CSDE->D1_COD, \"SB1->B1_DESC\" ),1,40)\r\n\t\t\t@ nLin, 42 PSay CSDE->DE_DOC \r\n\t\t\t@ nLin, 53 PSay CSDE->DE_SERIE \r\n\t\t\t@ nLin, 66 PSay CSDE->CUSTO Picture \"@E 9,999,999.99\"                     \r\n\r\n\t\t\tnTotCustoCC := nTotCustoCC + CSDE->Custo\r\n\t\t\tnTotNat := nTotNat + CSDE->Custo\r\n\t\t\tnTotCusto := nTotCusto + CSDE->Custo\r\n\t\t\tnLin := nLin+1\r\n\t\t\tCSDE->(dbSkip())\r\n\t\t\tIf CSDE->E2_NATUREZ <> cNAT .OR. CSDE->(eof()) .OR. aLLtRIM(CSDE->DE_CC) <> AllTrim(cCusto)\r\n\t\t\t\t@ nLin, 0 PSay \"Total \" + substr(Posicione(\"SED\", 1, XFilial(\"SED\")+CNAT, \"SED->ED_DESCRIC\" ),1,40) + \"----------->\"\r\n\t\t\t\t@ nLin,66 PSay nTotNAT Picture \"@E 9,999,999.99\"\r\n\t\t\t\tcNAT := CSDE->E2_NATUREZ\r\n\t\t\t\tnTotNAT := 0\r\n\t\t\t\tnLin := nLin+1\r\n\t\t\tEndif   \r\n\r\n\t\tEnd                               \r\n\t\tnTotNat := 0\r\n\t\tWHILE alltrim(cCusto) == alltrim(CSD1->D1_CC )\r\n\t\t\tcNat := CSD1->E2_NATUREZ\r\n\t\t\tIf nLin >= 58\r\n\t\t\t\tCabec(\"Relatorio de Custos\",\"Periodo: \" + DTOC(MV_PAR01) + \" a \" + DTOC(MV_PAR02),cCabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\tnLin := Li\r\n\t\t\tEndif   \r\n\t\t\tIf LTitulo\r\n\t\t\t\tnLin := nLin + 1\r\n\t\t\t\t@ nLin, 0 PSay \"Notas Fiscais de Entrada ...\"\r\n\t\t\t\tnLin := nLin+2         \r\n\t\t\t\tlTitulo := .F.\r\n\t\t\tEndif  \r\n\r\n\t\t\t// @ nLin,  0 PSay substr(Posicione(\"SED\", 1, XFilial(\"SED\")+CSD1->E2_NATUREZ, \"SED->ED_DESCRIC\" ),1,40)\r\n\t\t\t@ nLin,  0 PSay substr(Posicione(\"SB1\", 1, XFilial(\"SB1\")+CSD1->D1_COD, \"SB1->B1_DESC\" ),1,40)\r\n\t\t\t@ nLin, 42 PSay CSD1->D1_DOC \r\n\t\t\t@ nLin, 53 PSay CSD1->D1_SERIE \r\n\t\t\t@ nLin, 66 PSay CSD1->CUSTO Picture \"@E 9,999,999.99\"\r\n\t\t\tnTotCustoCC := nTotCustoCC + CSD1->Custo\r\n\t\t\tnTotCusto := nTotCusto + CSD1->Custo\r\n\t\t\tnTotNat := nTotNat + CSD1->Custo\r\n\t\t\tnLin := nLin+1\r\n\t\t\tCSD1->(dbSkip())\r\n\t\t\tIf Alltrim(CSD1->E2_NATUREZ) <> AllTrim(cNAT) .OR. CSD1->(eof()) .OR. aLLtRIM(CSD1->D1_CC) <> AllTrim(cCusto)\r\n\t\t\t\t@ nLin, 0 PSay \"Total \" + substr(Posicione(\"SED\", 1, XFilial(\"SED\")+CNAT, \"SED->ED_DESCRIC\" ),1,40) + \"----------->\"\r\n\t\t\t\t@ nLin,66 PSay nTotNAT Picture \"@E 9,999,999.99\"\r\n\t\t\t\tcNAT := CSD1->E2_NATUREZ\r\n\t\t\t\tnTotNAT := 0\r\n\t\t\t\tnLin := nLin+1\r\n\t\t\tEndif   \r\n\t\tEnd  \t   \r\n\t\tlTitulo := .T.\r\n\t\tnTotGru := 0\r\n\t\tWHILE alltrim(cCusto) == alltrim(CSD3->D3_CC)\r\n\t\t\tcGrupo := CSD3->B1_GRUPO\r\n\t\t\tIf nLin >= 58\r\n\t\t\t\tCabec(\"Relatorio de Custos\",\"Periodo: \" + DTOC(MV_PAR01) + \" a \" + DTOC(MV_PAR02),cCabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\tnLin := Li\r\n\t\t\tEndif\r\n\t\t\tIf LTitulo        \r\n\t\t\t\tnLin := nLin + 1         \r\n\t\t\t\t@ nLin, 0 PSay \"Requisições ...\"\r\n\t\t\t\tnLin := nLin+2         \r\n\t\t\t\tlTitulo := .F.\r\n\t\t\tEndif  \r\n\t\t\t@ nLin,  0 PSay substr(Posicione(\"SB1\", 1, XFilial(\"SB1\")+CSD3->D3_COD, \"SB1->B1_DESC\" ),1,40)\r\n\t\t\t@ nLin, 42 PSay CSD3->D3_DOC\r\n\t\t\t@ nLin, 57 PSay CSD3->D3_QUANT Picture \"@E 9,999.99\"\r\n\t\t\t@ nLin, 66 PSay CSD3->D3_CUSTO1 Picture \"@E 9,999,999.99\"\r\n\t\t\tnTotCustoCC := nTotCustoCC + CSD3->D3_CUSTO1\r\n\t\t\tnTotCusto := nTotCusto + CSD3->D3_CUSTO1\r\n\t\t\tnTotGru := nTotGru + CSD3->D3_CUSTO1\r\n\t\t\tnLin := nLin+1\r\n\t\t\tCSD3->(dbSkip())\r\n\t\t\tIf CSD3->B1_GRUPO <> cGrupo .OR. aLLtRIM(CSD3->D3_CC) <> AllTrim(cCusto) .OR. CSD3->(EOF())\r\n\t\t\t\t@ nLin, 0 PSay \"Total \" + Posicione(\"SBM\", 1, XFilial(\"SBM\")+cGRUPO, \"SBM->BM_DESC\" ) +\" ------------------------------>\"\r\n\t\t\t\t@ nLin,66 PSay nTotGru Picture \"@E 9,999,999.99\"\r\n\t\t\t\tcGrupo := CSD3->B1_GRUPO\r\n\t\t\t\tnTotGru := 0\r\n\t\t\t\tnLin := nLin+1\r\n\t\t\tEndif   \r\n\t\tEnd         \r\n\t\tlTitulo := .T.               \r\n\t\tnTotNat := 0\r\n\t\tWHILE alltrim(cCusto) == alltrim(CSZ2->E2_CCD)\r\n\t\t\tcNataut := CSZ2->E2_NATUREZ\r\n\t\t\tIf nLin >= 58\r\n\t\t\t\tCabec(\"Relatorio de Custos\",\"Periodo: \" + DTOC(MV_PAR01) + \" a \" + DTOC(MV_PAR02),cCabec2,wnrel,Tamanho,nTipo)\r\n\t\t\t\tnLin := Li\r\n\t\t\tEndif   \r\n\t\t\tIf LTitulo\r\n\t\t\t\tnLin := nLin + 1         \r\n\t\t\t\t@ nLin, 0 PSay \"Autorizações de Pagamento ...\"\r\n\t\t\t\tnLin := nLin+2         \r\n\t\t\t\tlTitulo := .F.\r\n\t\t\tEndif         \r\n\t\t\t@ nLin,  0 PSay Substr(Posicione(\"SED\", 1, XFilial(\"SED\")+CSZ2->E2_NATUREZ, \"SED->ED_DESCRIC\" ),1,40)\r\n\t\t\t@ nLin, 42 PSay CSZ2->E2_NUM \r\n\t\t\t@ nLin, 53 PSay CSZ2->E2_PARCELA\r\n\t\t\t@ nLin, 66 PSay CSZ2->CUSTO Picture \"@E 9,999,999.99\"\r\n\t\t\tnTotCustoCC := nTotCustoCC + CSZ2->CUSTO\r\n\t\t\tnTotCusto := nTotCusto + CSZ2->CUSTO\r\n\t\t\tnTotNat := nTotNat + CSZ2->CUSTO\r\n\t\t\tnLin := nLin+1\r\n\t\t\tCSZ2->(dbSkip())\r\n\t\t\tIf CSZ2->E2_NATUREZ <> cNataut .OR. aLLtRIM(CSZ2->E2_CCD) <> AllTrim(cCusto) .OR. CSZ2->(EOF())\r\n\t\t\t\t@ nLin, 0 PSay \"Total \" + Substr(Posicione(\"SED\", 1, XFilial(\"SED\")+cNataut, \"SED->ED_DESCRIC\" ),1,40) +\" ------------------>\"\r\n\t\t\t\t@ nLin,66 PSay nTotNat Picture \"@E 9,999,999.99\"\r\n\t\t\t\tcNataut := CSZ2->E2_NATUREZ\r\n\t\t\t\tnTotNat := 0\r\n\t\t\t\tnLin := nLin+1\r\n\t\t\tEndif   \t     \r\n\t\tEnd  \r\n\tEnd              \r\n\tIf nTotCustoCC > 0\r\n\t\t@ nLin,0 PSay \"---------------------------------------------------------------------------------\"\r\n\t\t@ nLin+1,0 PSay \"Total Centro de Custo ------------->\"      \r\n\t\t@ nLin+1, 66 PSay nTotCustoCC Picture \"@E 9,999,999.99\"\r\n\t\tnLin := nLin+2\r\n\tEndif  \r\n\r\n\t@ nLin, 0 PSay \"---------------------------------------------------------------------------------\"\r\n\t@ nLin+1, 0 PSay \"Total Geral -------------------------------------->\"\r\n\t@ nLin+2,65 PSay nTotCusto Picture \"@E 99,999,999.99\"\r\n\tIf aReturn[5] = 1                                                                                                             \r\n\t\tSet Printer To\r\n\t\tdbCommitAll()\r\n\t\tourspool(wnrel)\r\n\tEndif\r\n\tMS_FLUSH()\r\n\r\n\tCSDE->(dbCloseArea())\r\n\tCSD3->(dbCloseArea())\r\n\tCSZ2->(dbCloseArea())\r\n\tCSD1->(dbCloseArea())\r\n\r\n\r\nReturn Nil          \r\n\r\n//=====================================================================================================================================================\t\r\n"}}}
Content-Length: 167
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/Relcusto.prw"}}}
Content-Length: 6819
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/RelMod.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"rwmake.ch\"\r\n#INCLUDE \"protheus.ch\"\r\n#INCLUDE \"TOPCONN.CH\"\r\n\r\nUser Function RelMod\r\n\r\n\t//+--------------------------------------------------------------------+\r\n\t//| Declaracao de Variaveis                                            |\r\n\t//+--------------------------------------------------------------------+\r\n\r\n\tLocal cQuery\t:= \"\"\r\n\tLocal cPerg \t:= \"\"\r\n\r\n\t//+--------------------------------------------------------------------+\r\n\t//| Define os estilos de fonte a serem utilizados                      |\r\n\t//+--------------------------------------------------------------------+\r\n\tPrivate oFont1 := TFont():New( \"Verdana\",,10,,.F.,,,,.F.,.F. )\r\n\tPrivate oFont2 := TFont():New( \"Verdana\",,10,,.T.,,,,.F.,.F. )\r\n\tPrivate oFont3 := TFont():New( \"Verdana\",,16,,.F.,,,,.F.,.F. )\r\n\tPrivate oFont4 := TFont():New( \"Verdana\",,08,,.T.,,,,.F.,.F. )\r\n\r\n\tPrivate nColIni := 0\r\n\tPrivate nLimite\t:= 2350\r\n\tPrivate nColFim := 2330\r\n\tPrivate nLin\t:= 0\r\n\tPrivate cEmpresa := \"\"\r\n\r\n\tPergunte(\"RELMOD001\",.T.)\r\n\r\n\toPrn := TMSPrinter():New(\"Saída de Produtos - Estoque\")\r\n\r\n\toPrn:SetPaperSize(9) // A4\r\n\t//oPrn:SetLandScape(.T.)//Paisagem\r\n\toPrn:setPortrait(.T.) // Retrato\r\n\toPrn:Setup()\r\n\r\n\r\n\r\n\t/*\r\n\tPerguntas Relatorio:\r\n\r\n\tDocumento De? = mv_par01\r\n\tDocumento Ate? = mv_par02\r\n\tDt.Emi. De? = mv_par03  \r\n\tDt.Emi. Ate? = mv_par04\r\n\tProduto De? = mv_par05\r\n\tProduto Ate? = mv_par06\r\n\tCliente De? = mv_par07\r\n\tCliente Ate? = mv_par08\r\n\tCFOP? = mv_par09\r\n\tGera Dupl ? = mv_par10\r\n\tMov.Est.? = mv_par11\r\n\tClass? \t1=1ª = mv_par12\r\n\t2=CO\r\n\t3=Todas\r\n\t*/\r\n\r\n\tImpDados()\r\n\tImpRodape()\r\n\r\n\toPrn:Preview()\r\n\r\nReturn\r\n\r\n/*/\r\n+----------+------------+----------------------------+------+------------+\r\n|Funcao    | ImpDados   | Myrella| Data | 01/06/16   |\r\n+----------+------------+----------------------------+------+------------+\r\n|Descricao | Imprime o Rodape do relatorio                               |\r\n+----------+-------------------------------------------------------------+\r\n|Uso       | MSLR001                                                     |\r\n+----------+-------------------------------------------------------------+\r\n/*/\r\n\r\nStatic Function ImpDados\r\n\r\n\t// QUERY RELATORIO DE VENDAS\r\n\r\n\tcQuery:= \"SELECT D3_FILIAL, D3_COD, B1_DESC, D3_QUANT, D3_DOC, D3_CUSTO1, D3_USUARIO, D3_TM \r\n\tcQuery+= \"FROM SD3050 INNER JOIN SB1050 ON B1_COD = D3_COD WHERE D3_DOC BETWEEN '\" + mv_par01 + \"' AND '\" + mv_par02 + \"'\r\n\r\n\t//\tcQuery+= \" WHERE D3_DOC BETWEEN '\"+mv_par01+\"' AND '\"mv_par02\"'\"\r\n\r\n\tTcQuery cQuery Alias VDAS New\r\n\r\n\tDbSelectArea(\"VDAS\")\r\n\tDbGoTop()\r\n\r\n\tImpCabec()\r\n\tImpCabec1()\r\n\r\n\tnCont\t:= 0\r\n\t//nM3  \t:= 0\r\n\t//nTotal\t:= 0\r\n\t//cUM \t:= VDAS->C6_UM\r\n\r\n\tWhile (!Eof())\r\n\r\n\t\tIF(nLin >= 3100)\r\n\t\t\tReiniciaPag()\r\n\t\t\tImpCabec1()\r\n\t\tEndIf\r\n\r\n\t\tnLin1:= 0\r\n\t\t//cComp :=Alltrim(Transform(VDAS->C6_COMPLIQ,\"@E 99,999.999\"))\r\n\t\t//cAlt  :=Alltrim(Transform(VDAS->C6_ALTLIQ, \"@E 99,999.999\"))\r\n\t\t//cLarg :=Alltrim(Transform(VDAS->C6_LARGLIQ,\"@E 99,999.999\"))\r\n\t\t//cQuant:=Alltrim(Transform(VDAS->C6_QTDVEN, \"@E 99,999.999\"))\r\n\r\n\t\t//D3_FILIAL, D3_COD, D3_QUANT, D3_DOC, D3_CUSTO1, D3_USUARIO                                                          \t\r\n\t\t/*\r\n\t\toPrn:Say( nLin , 0010 , \"Filial\"\t\t\t\t\t\t\t\t\t,oFont2)\r\n\t\toPrn:Say( nLin , 0310 , \"Produto\"\t\t\t\t\t\t\t\t\t\t\t,oFont2)\r\n\t\toPrn:Say( nLin , 0550 , \"Quantidade\"\t\t\t\t\t\t\t\t\t,oFont2)\r\n\t\toPrn:Say( nLin , 0850 , \"Documento\"\t\t\t\t\t\t\t\t\t\t\t,oFont2)\r\n\t\toPrn:Say( nLin , 1450 , \"Custo\"\t\t\t\t\t\t\t\t\t\t\t,oFont2)\r\n\t\toPrn:Say( nLin , 1700 , \"Usuário\"\t\t\t\t\t\t\t\t\t\t\t,oFont2)  \t\t\t\t\t\t\t\t\t\t\r\n\t\t*/ \r\n\t\tnLin+= 70\r\n\r\n\t\toPrn:Say( nLin , 0010 , Alltrim(VDAS->D3_FILIAL)\t\t,oFont1)\r\n\t\toPrn:Say( nLin , 0210 , Alltrim(VDAS->D3_DOC)           ,oFont1)\t\r\n\t\toPrn:Say( nLin , 0450 , TRANSFORM(VDAS->D3_QUANT,\"@E 99,999.999\"),oFont1)\t\r\n\t\toPrn:Say( nLin , 0650 , VDAS->D3_COD ,oFont1)\t\r\n\t\toPrn:Say( nLin , 0850 , VDAS->B1_DESC,oFont1)\t\t\t\r\n\t\toPrn:Say( nLin , 1650 ,\tTRANSFORM(VDAS->D3_CUSTO1,\"@E 99,999.999\"),oFont1)\t\t\r\n\t\toPrn:Say( nLin , 1950 , VDAS->D3_USUARIO\t\t\t,oFont1)\r\n\t\toPrn:Say( nLin , 2150 , VDAS->D3_TM\t\t\t,oFont1)\r\n\r\n\r\n\t\tnLin    += 50 + nLin1\r\n\r\n\r\n\t\tDbSelectArea(\"VDAS\")\t\t\r\n\t\tDbSkip()\r\n\tEndDo\r\n\t//----------------------------------------------------------------------------------------------------\r\n\t//Fim Itens - Blocos\r\n\r\n\tnLin += 50\r\n\r\n\r\n\tDBSELECTAREA(\"VDAS\")\r\n\tDBCloseArea()\r\n\r\nReturn\r\n\r\n/*/\r\n+----------+------------+----------------------------+------+------------+\r\n|Funcao    | ImpRodape  |  MYRELLA GOMES DE SOUSA    | Data | 01/06/16   |\r\n+----------+------------+----------------------------+------+------------+\r\n|Descricao | Imprime o Rodape do relatorio                               |\r\n+----------+-------------------------------------------------------------+\r\n|Uso       | MSLR001                                                     |\r\n+----------+-------------------------------------------------------------+\r\n/*/\r\n\r\nStatic Function ImpRodape\r\n\r\n\toprn:EndPage()\r\n\r\n\tMS_FLUSH()\r\n\r\nReturn\r\n\r\n//Imprime Cabeçalho\r\nStatic Function ImpCabec()\r\n\r\n\toprn:StartPage()\r\n\r\n\toPrn:Say( 0000 , 1150 , Substr(DtoS(date()),7,2)+\"/\"+Substr(DtoS(date()),5,2)+\"/\"+Substr(DtoS(date()),1,4)+\" - \"+time()  , oFont2 )\r\n\toPrn:Say( 0030 , 0450 , \"Saída de Produtos - Estoque\" , oFont3 )\r\n\r\n\tnLin:= 130\r\n\r\nReturn        \r\n\r\n//Imprime Cabeçalho\r\nStatic Function ImpCabec1()\r\n\r\n\toPrn:Say( nLin , 0010 , \"Filial\"\t\t\t\t,oFont2)\r\n\toPrn:Say( nLin , 0210 , \"Documento\"\t\t\t\t,oFont2)\r\n\toPrn:Say( nLin , 0450 , \"Quant.\"\t\t\t,oFont2)\r\n\toPrn:Say( nLin , 0650 , \"Produto\"\t\t\t\t,oFont2)\r\n\toPrn:Say( nLin , 0850 , \"Descrição\"\t\t\t\t,oFont2)\t\r\n\toPrn:Say( nLin , 1650 , \"Custo\"\t\t\t\t\t,oFont2)\r\n\toPrn:Say( nLin , 1950 , \"Usuário\"\t\t\t\t,oFont2)  \t\t\t\t\t\t\t\t\t\t\r\n\toPrn:Say( nLin , 2150 , \"TM\"       \t\t\t\t,oFont2)\t\t\r\n\r\n\tnLin+= 70               \r\n\r\n\r\nReturn\r\n\r\n//Iniciar uma nova pagina\r\nStatic Function ReiniciaPag()\r\n\r\n\toPrn:EndPage()\r\n\toPrn:StartPage()\r\n\tnLin := 0\r\n\r\nReturn "}}}
Content-Length: 165
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/RelMod.prw"}}}
Content-Length: 3213
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/SEQLOTE.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"PROTHEUS.CH\"\r\n\r\n/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³ SEQLOTE  ³ Autor ³ Marco Tulio           ³ Data ³ 13/09/12 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ SEQUENCIAL DE LOTES POR PRODUTO                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Uso       ³ SIGAEST                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/\r\nUser Function SEQLOTE()\r\n\r\n\tLocal aArea    := GetArea()                   \r\n\r\n\tPrivate cCod := \"\"\r\n\tPrivate nSeqLote := 0\r\n\tPrivate cLote  := \"\"\r\n\tPrivate cQuery:= \"\"\r\n\r\n\r\n\tcCod := Alltrim(M->C2_PRODUTO)\r\n\tnSeqLote := SB1->B1_SEQLT\r\n\r\n\tCQuery:= \" SELECT C2_LOTECTL \r\n\tCQuery+= \" FROM \" + RetSqlName(\"SC2\") + \" SC2 \r\n\tCQuery+= \" WHERE R_E_C_N_O_ = ( SELECT MAX(R_E_C_N_O_ ) \r\n\tCQuery+= \" \t\t\t\t  FROM \" + RetSqlName(\"SC2\")  \r\n\tCQuery+= \" \t\t\t\t WHERE C2_PRODUTO= '\"+cCod+\"' \r\n\tCQuery+= \" \t\t\t\t  AND D_E_L_E_T_ = '' \r\n\tCQuery+= \" \t\t\t\t  AND C2_FILIAL = '\"+xFilial(\"SC2\")+\"'\r\n\tCQuery+= \" \t\t\t  )\r\n\r\n\tQuery := ChangeQuery(cQuery)\r\n\r\n\tdbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), 'TSTC2', .T., .F.)\r\n\r\n\tDBSeleCtArea(\"TSTC2\")\r\n\tdbGoTop()\r\n\tWhile ! TSTC2->(Eof())                                                  \u001f\r\n\t\tcLote := Strzero(Val(SubStr(TSTC2->C2_LOTECTL,1,5))+1,5) + Substr(TSTC2->C2_LOTECTL,6,2)\r\n\t\tdbSkip()\r\n\tEnd      \r\n\tDbSeleCtArea(\"TSTC2\")\r\n\tDbCloseArea() \r\n\r\n\tRestArea(aArea)\r\n\r\nReturn (cLote)\r\n\r\n\r\n\r\n//Local cLote := Space(7)\r\n//Local cPar, cNewpar\r\n\r\n//cPar := \"MV_SEQLT\" + Strzero(SB1->B1_SEQLT,2,0)\r\n\r\n//cLote := GETMV(cPar)\r\n\r\n//cNewpar := Strzero(Val(SubStr(cLote,1,5))+1,5)+Substr(cLote,6,2)\r\n\r\n//PUTMV(cPar, cNewpar )\r\n\r\n//Return cLote\r\n"}}}
Content-Length: 166
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/05_ESTOQUE/SEQLOTE.prw"}}}
Content-Length: 115323
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO/MATR730Q.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"MATR730.CH\" \r\n#INCLUDE \"PROTHEUS.CH\"\r\n\r\n/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³ MATR730  ³ Autor ³ Marco Bianchi         ³ Data ³ 10/07/06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Emissao da Pre Nota                                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Uso       ³ SIGAFAT-R4                                                 ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/\r\nUser Function MATR730Q()\r\n\r\nLocal oReport\r\n\r\n//If FindFunction(\"TRepInUse\") .And. TRepInUse()\r\n\t//-- Interface de impressao\r\n\t//oReport := ReportDef()\r\n\t//oReport:PrintDialog()\r\n//Else\r\n\tU_MATR730R3Q()\r\n//EndIf\r\n\r\nReturn\r\n\r\n/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³ReportDef ³ Autor ³ Marco Bianchi         ³ Data ³ 10/07/06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³A funcao estatica ReportDef devera ser criada para todos os ³±±\r\n±±³          ³relatorios que poderao ser agendados pelo usuario.          ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³ExpO1: Objeto do relatório                                  ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³Nenhum                                                      ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ReportDef()\r\n\r\nLocal oReport\r\nLocal oPreNota\r\nLocal nValImp  \t:= 0\r\nLocal nUltLib  \t:= 0\r\nLocal aCabPed\t:= {}\r\nLocal aItemPed  := {}\r\nLocal nItem \t:= 0\r\nLocal nTamData  := Len(DTOC(MsDate()))\r\n\r\nPrivate aCodImps:= {}\r\nPrivate nI\t\t:= 0\r\nPrivate nTotQtd := 0\r\nPrivate nTotVal := 0\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Criacao do componente de impressao                                      ³\r\n//³                                                                        ³\r\n//³TReport():New                                                           ³\r\n//³ExpC1 : Nome do relatorio                                               ³\r\n//³ExpC2 : Titulo                                                          ³\r\n//³ExpC3 : Pergunte                                                        ³\r\n//³ExpB4 : Bloco de codigo que sera executado na confirmacao da impressao  ³\r\n//³ExpC5 : Descricao                                                       ³\r\n//³                                                                        ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noReport := TReport():New(\"MATR730\",STR0050,\"MTR730\", {|oReport| ReportPrint(oReport,oPreNota,@nItem,aItemPed,aCabPed)},STR0051 + \" \" + STR0052)\t// \"Emissao da Confirmacao do Pedido\"###\"Emissao da confirmacao dos pedidos de venda, de acordo com\"###\"intervalo informado na opcaoo Parametros.\"\r\noReport:SetLandscape() \r\noReport:SetTotalInLine(.F.)\r\n\r\n//Pergunte(oReport:uParam,.F.)\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Criacao da secao utilizada pelo relatorio                               ³\r\n//³                                                                        ³\r\n//³TRSection():New                                                         ³\r\n//³ExpO1 : Objeto TReport que a secao pertence                             ³\r\n//³ExpC2 : Descricao da seçao                                              ³\r\n//³ExpA3 : Array com as tabelas utilizadas pela secao. A primeira tabela   ³\r\n//³        sera considerada como principal para a seção.                   ³\r\n//³ExpA4 : Array com as Ordens do relatório                                ³\r\n//³ExpL5 : Carrega campos do SX3 como celulas                              ³\r\n//³        Default : False                                                 ³\r\n//³ExpL6 : Carrega ordens do Sindex                                        ³\r\n//³        Default : False                                                 ³\r\n//³                                                                        ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Criacao da celulas da secao do relatorio                                ³\r\n//³                                                                        ³\r\n//³TRCell():New                                                            ³\r\n//³ExpO1 : Objeto TSection que a secao pertence                            ³\r\n//³ExpC2 : Nome da celula do relatório. O SX3 será consultado              ³\r\n//³ExpC3 : Nome da tabela de referencia da celula                          ³\r\n//³ExpC4 : Titulo da celula                                                ³\r\n//³        Default : X3Titulo()                                            ³\r\n//³ExpC5 : Picture                                                         ³\r\n//³        Default : X3_PICTURE                                            ³\r\n//³ExpC6 : Tamanho                                                         ³\r\n//³        Default : X3_TAMANHO                                            ³\r\n//³ExpL7 : Informe se o tamanho esta em pixel                              ³\r\n//³        Default : False                                                 ³\r\n//³ExpB8 : Bloco de código para impressao.                                 ³\r\n//³        Default : ExpC2                                                 ³\r\n//³                                                                        ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Secao dos itens do Pedido de Vendas                                    ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noPreNota := TRSection():New(oReport,STR0108,{\"SC5\",\"SC6\"},/*{Array com as ordens do relatório}*/,/*Campos do SX3*/,/*Campos do SIX*/)\t// \"Emissao da Confirmacao do Pedido\"\r\noPreNota:SetTotalInLine(.F.)\r\n\r\nTRCell():New(oPreNota,\"AITEM01\",/*Tabela*/,STR0053\t\t\t\t\t ,PesqPict(\"SC6\",\"C6_ITEM\"\t\t),TamSx3(\"C6_ITEM\"\t\t)[1],/*lPixel*/,{|| aItemPed[nItem][01] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"IT\"\r\nTRCell():New(oPreNota,\"AITEM02\",/*Tabela*/,RetTitle(\"C6_PRODUTO\"\t),PesqPict(\"SC6\",\"C6_PRODUTO\"\t),TamSx3(\"C6_PRODUTO\"\t)[1],/*lPixel*/,{|| aItemPed[nItem][02] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// Codigo do Produto\r\nTRCell():New(oPreNota,\"AITEM03\",/*Tabela*/,RetTitle(\"C6_DESCRI\"\t),PesqPict(\"SC6\",\"C6_DESCRI\"\t),TamSx3(\"C6_DESCRI\"\t)[1],/*lPixel*/,{|| IIF(Empty(aItemPed[nItem][03]),SB1->B1_DESC, aItemPed[nItem][03])\t\t\t\t\t\t})\t// Descricao do Produto\r\nTRCell():New(oPreNota,\"AITEM04\",/*Tabela*/,STR0054\t\t\t\t\t ,PesqPict(\"SC6\",\"C6_TES\"\t\t),TamSx3(\"C6_TES\"\t\t)[1],/*lPixel*/,{|| aItemPed[nItem][04] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"TES\"\r\nTRCell():New(oPreNota,\"AITEM05\",/*Tabela*/,STR0055\t\t\t\t\t ,PesqPict(\"SC6\",\"C6_CF\"\t\t),TamSx3(\"C6_CF\"\t\t)[1],/*lPixel*/,{|| aItemPed[nItem][05] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"CF\"\r\nTRCell():New(oPreNota,\"AITEM06\",/*Tabela*/,STR0056\t\t\t\t\t ,PesqPict(\"SC6\",\"C6_UM\"\t\t),TamSx3(\"C6_UM\"\t\t)[1],/*lPixel*/,{|| aItemPed[nItem][06] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"UM\"\r\nTRCell():New(oPreNota,\"AITEM07\",/*Tabela*/,STR0057\t\t\t\t\t ,PesqPictQt(\"C6_QTDVEN\"\t    ),TamSx3(\"C6_QTDVEN\"\t)[1],/*lPixel*/,{|| aItemPed[nItem][07] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"Quant.\"\r\nTRCell():New(oPreNota,\"AITEM08\",/*Tabela*/,RetTitle(\"C6_PRCVEN\"\t),PesqPict(\"SC6\",\"C6_PRCVEN\"\t),TamSx3(\"C6_PRCVEN\"\t)[1],/*lPixel*/,{|| aItemPed[nItem][08] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// Preco Unitario\r\nIf cPaisLoc == \"BRA\"\r\n\tTRCell():New(oPreNota,\"NALIQIPI\",/*Tabela*/\t,STR0058,\"@e 99.99\"\t\t\t\t,5,/*lPixel*/,{|| MaFisRet(nItem,\"IT_ALIQIPI\") \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"IPI\"\r\n\tTRCell():New(oPreNota,\"NALIQICM\",/*Tabela*/\t,STR0059,\"@e 99.99\"\t\t\t\t,5,/*lPixel*/,{|| MaFisRet(nItem,\"IT_ALIQICM\") \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"ICM\"\r\n\tTRCell():New(oPreNota,\"NALIQISS\",/*Tabela*/\t,STR0060,\"@e 99.99\"\t\t\t\t,5,/*lPixel*/,{|| MaFisRet(nItem,\"IT_ALIQISS\") \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"ISS\"\r\nElse\r\n\tTRCell():New(oPreNota,\"NVALIMP\"\t,/*Tabela*/\t,STR0058,Tm(nValImp,10,2)\t,5,/*lPixel*/,{|| Tm(nValImp,10,2) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"IPI\"\r\nEndIf\r\nTRCell():New(oPreNota,\"AITEM13\",/*Tabela*/,STR0061\t\t\t\t\t\t,PesqPict(\"SC6\",\"C6_VALOR\"\t\t),TamSx3(\"C6_VALOR\"\t\t)[1],/*lPixel*/,{|| aItemPed[nItem][13]+nValImp \t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"Vl.Tot.C/IPI\"\r\nTRCell():New(oPreNota,\"AITEM14\",/*Tabela*/,RetTitle(\"C6_ENTREG\"\t)\t,PesqPict(\"SC6\",\"C6_ENTREG\"\t\t),nTamData\t\t\t\t\t,/*lPixel*/,{|| aItemPed[nItem][14] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t},,,,,,.F.)\t// Data de Entrega\r\nTRCell():New(oPreNota,\"AITEM15\",/*Tabela*/,RetTitle(\"C6_DESCONT\"\t)\t,PesqPict(\"SC6\",\"C6_DESCONT\"\t),TamSx3(\"C6_DESCONT\"\t)[1],/*lPixel*/,{|| aItemPed[nItem][15] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// % Desconto\r\nTRCell():New(oPreNota,\"AITEM16\",/*Tabela*/,STR0062\t\t\t\t\t\t,PesqPict(\"SC6\",\"C6_LOCAL\"\t\t),TamSx3(\"C6_LOCAL\"\t\t)[1],/*lPixel*/,{|| aItemPed[nItem][16] \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"Loc.\"\r\nTRCell():New(oPreNota,\"AITEM17\",/*Tabela*/,STR0063\t\t\t\t\t\t,PesqPictQt(\"C6_QTDLIB\"\t\t    ),TamSx3(\"C6_QTDLIB\"\t)[1],/*lPixel*/,{|| aItemPed[nItem][17] \t\t\t\t\t\t\t\t\t\t\t\t  \t\t\t\t})\t// \"Qtd.a Fat.\"\r\nTRCell():New(oPreNota,\"NSALDO\" ,/*Tabela*/,STR0064\t\t\t\t\t\t,PesqPictQt(\"C6_QTDLIB\"\t\t    ),TamSx3(\"C6_QTDLIB\"\t)[1],/*lPixel*/,{|| aItemPed[nItem][07]-aItemPed[nItem][17]+aItemPed[nItem][18]-aItemPed[nItem][19]\t})\t// \"Saldo\"\r\nTRCell():New(oPreNota,\"NULTLIB\",/*Tabela*/,STR0065\t\t\t\t\t\t,PesqPictQt(\"D2_QUANT\",10\t    ),TamSx3(\"D2_QUANT\"\t\t)[1],/*lPixel*/,{|| nUltLib \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t})\t// \"Ult.Fat.\"\r\n\r\nTRFunction():New(oPreNota:Cell(\"AITEM07\"),\"AITEM07\"/* cID */,\"ONPRINT\",/*oBreak*/,/*cTitle*/,PesqPict(\"SC6\",\"C6_QTDVEN\",20),{|| nTotQtd }/*uFormula*/,.T./*lEndSection*/,.F./*lEndReport*/,/*lEndPage*/)\r\nTRFunction():New(oPreNota:Cell(\"AITEM13\"),\"AITEM13\"/* cID */,\"ONPRINT\",/*oBreak*/,/*cTitle*/,/*cPicture*/,{|| nTotVal }/*uFormula*/,.T./*lEndSection*/,.F./*lEndReport*/,/*lEndPage*/)\r\n\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Secao dos Impostos                                                     ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noImpostos := TRSection():New(oReport,STR0109,{\"SC5\",\"SC6\",\"SD1\",\"SB1\",\"SD2\",\"SA1\",\"SA2\",\"SA4\",\"SE4\",\"SA3\",\"SX3\"},/*{Array com as ordens do relatório}*/,/*Campos do SX3*/,/*Campos do SIX*/)\t// \"Emissao da Confirmacao do Pedido\"\r\noImpostos:SetTotalInLine(.F.)\r\nIf cPaisLoc == \"BRA\"\r\n\tTRCell():New(oImpostos,\"NF_BASEICM\"\t,/*Tabela*/,STR0087,PesqPict(\"SF2\",\"F2_BASEICM\"),TamSx3(\"F2_BASEICM\"\t\t)[1],/*lPixel*/,{|| MaFisRet(,\"NF_BASEICM\") \t})\t// \"Base Icms\"\r\n\tTRCell():New(oImpostos,\"NF_VALICM\"\t,/*Tabela*/,STR0088,PesqPict(\"SF2\",\"F2_VALICM\") ,TamSx3(\"F2_VALICM\"\t\t)[1],/*lPixel*/,{|| MaFisRet(,\"NF_VALICM\"\t) \t})\t// \"Valor Icms\"\r\n\tTRCell():New(oImpostos,\"NF_BASEIPI\"\t,/*Tabela*/,STR0089,PesqPict(\"SF2\",\"F2_BASEIPI\"),TamSx3(\"F2_BASEIPI\"\t\t)[1],/*lPixel*/,{|| MaFisRet(,\"NF_BASEIPI\") \t})\t// \"Base Ipi\"\r\n\tTRCell():New(oImpostos,\"NF_VALIPI\"\t,/*Tabela*/,STR0090,PesqPict(\"SF2\",\"F2_VALIPI\") ,TamSx3(\"F2_VALIPI\"\t\t)[1],/*lPixel*/,{|| MaFisRet(,\"NF_VALIPI\"\t) \t})\t// \"Valor Ipi\"\r\n\tTRCell():New(oImpostos,\"NF_BASESOL\"\t,/*Tabela*/,STR0091,PesqPict(\"SF2\",\"F2_BRICMS\") ,TamSx3(\"F2_BRICMS\"\t\t)[1],/*lPixel*/,{|| MaFisRet(,\"NF_BASESOL\") \t})\t// \"Base Retido\"\r\n\tTRCell():New(oImpostos,\"NF_VALSOL\"\t,/*Tabela*/,STR0092,PesqPict(\"SF2\",\"F2_ICMSRET\"),TamSx3(\"F2_ICMSRET\"\t\t)[1],/*lPixel*/,{|| MaFisRet(,\"NF_VALSOL\"\t) \t})\t// \"Valor Retido\"\r\n\tTRCell():New(oImpostos,\"NF_TOTAL\"\t,/*Tabela*/,STR0093,PesqPict(\"SF2\",\"F2_VALBRUT\"),TamSx3(\"F2_VALBRUT\"\t    \t)[1],/*lPixel*/,{|| MaFisRet(,\"NF_TOTAL\"\t) \t})\t// \"Valor Total\"\r\n\tTRCell():New(oImpostos,\"NF_BASEISS\"\t,/*Tabela*/,STR0094,PesqPict(\"SF2\",\"F2_BASEISS\"),TamSx3(\"F2_BASEISS\"\t\t)[1],/*lPixel*/,{|| MaFisRet(,\"NF_BASEISS\") \t})\t// \"Base Iss\"\r\n\tTRCell():New(oImpostos,\"NF_VALISS\"\t,/*Tabela*/,STR0095,PesqPict(\"SF2\",\"F2_VALISS\") ,TamSx3(\"F2_VALISS\"\t\t)[1],/*lPixel*/,{|| MaFisRet(,\"NF_VALISS\"\t) \t})\t// \"Valor Iss\"\r\nElse\r\n\tTRCell():New(oImpostos,\"aCodImps2\"\t,/*Tabela*/,STR0096,/*Picture*/\t\t\t,13,/*lPixel*/,{|| aCodImps[nI][2] \t\t})\t// \"Imposto\"\r\n\tTRCell():New(oImpostos,\"aCodImps3\"\t,/*Tabela*/,STR0097,\"@E 99,999,999.99\"\t,13,/*lPixel*/,{|| aCodImps[nI][3] \t\t})\t// \"Base\"\r\n\tTRCell():New(oImpostos,\"aCodImps4\"\t,/*Tabela*/,STR0098,\"@E 99,999,999.99\"\t,13,/*lPixel*/,{|| aCodImps[nI][4] \t\t})\t// \"Aliquota\"\r\n\tTRCell():New(oImpostos,\"aCodImps5\"\t,/*Tabela*/,STR0099,\"@E 99,999,999.99\"\t,13,/*lPixel*/,{|| aCodImps[nI][5]\t\t\t})\t// \"Valor\"\r\nEndIf\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Troca descricao do total dos itens                                     ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noReport:Section(1):SetTotalText(STR0085)\t// \"T O T A I S \"\r\n\r\nTRPosition():New(oPreNota,\"SC6\",1,{|| xFilial(\"SC5\") + aCabPed[07]+aItemPed[nItem][01]})\r\nTRPosition():New(oPreNota,\"SC5\",1,{|| xFilial(\"SC6\") + aCabPed[07]+aItemPed[nItem][01]})\r\n\r\noReport:Section(2):SetEdit(.F.) \r\noReport:Section(1):SetUseQuery(.F.) // Novo compomente tReport para adcionar campos de usuario no relatorio qdo utiliza query\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Alinhamento a direita as colunas de valor                              ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noPreNota:Cell(\"AITEM07\"):SetHeaderAlign(\"RIGHT\")\r\noPreNota:Cell(\"AITEM08\"):SetHeaderAlign(\"RIGHT\")\r\nIf cPaisLoc == \"BRA\"\r\n\toPreNota:Cell(\"NALIQIPI\"):SetHeaderAlign(\"RIGHT\")\r\n\toPreNota:Cell(\"NALIQICM\"):SetHeaderAlign(\"RIGHT\")\r\n\toPreNota:Cell(\"NALIQISS\"):SetHeaderAlign(\"RIGHT\")\r\n\r\n\toImpostos:Cell(\"NF_BASEICM\"):SetHeaderAlign(\"RIGHT\")\r\n\toImpostos:Cell(\"NF_VALICM\"):SetHeaderAlign(\"RIGHT\")\r\n\toImpostos:Cell(\"NF_BASEIPI\"):SetHeaderAlign(\"RIGHT\")\r\n\toImpostos:Cell(\"NF_VALIPI\"):SetHeaderAlign(\"RIGHT\")\r\n\toImpostos:Cell(\"NF_BASESOL\"):SetHeaderAlign(\"RIGHT\")\r\n\toImpostos:Cell(\"NF_VALSOL\"):SetHeaderAlign(\"RIGHT\")\r\n\toImpostos:Cell(\"NF_TOTAL\"):SetHeaderAlign(\"RIGHT\")\r\n\toImpostos:Cell(\"NF_BASEISS\"):SetHeaderAlign(\"RIGHT\")\r\n\toImpostos:Cell(\"NF_VALISS\"):SetHeaderAlign(\"RIGHT\")\r\n\r\nElse\r\n\toPreNota:Cell(\"NVALIMP\"):SetHeaderAlign(\"RIGHT\")\t\r\n\r\n\toImpostos:Cell(\"aCodImps2\"):SetHeaderAlign(\"RIGHT\")\t\r\n\toImpostos:Cell(\"aCodImps3\"):SetHeaderAlign(\"RIGHT\")\t\r\n\toImpostos:Cell(\"aCodImps4\"):SetHeaderAlign(\"RIGHT\")\t\r\n\toImpostos:Cell(\"aCodImps5\"):SetHeaderAlign(\"RIGHT\")\t\r\nEndIf\r\noPreNota:Cell(\"AITEM13\"):SetHeaderAlign(\"RIGHT\")\t\r\noPreNota:Cell(\"AITEM17\"):SetHeaderAlign(\"RIGHT\")\t\r\noPreNota:Cell(\"NSALDO\"):SetHeaderAlign(\"RIGHT\")\t\r\noPreNota:Cell(\"NULTLIB\"):SetHeaderAlign(\"RIGHT\")\t\r\nReturn(oReport)\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³ReportPrin³ Autor ³ Marco Bianchi         ³ Data ³ 10/07/06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³A funcao estatica ReportDef devera ser criada para todos os ³±±\r\n±±³          ³relatorios que poderao ser agendados pelo usuario.          ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³Nenhum                                                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ExpO1: Objeto Report do Relatório                           ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ReportPrint(oReport,oPreNota,nItem,aItemPed,aCabPed)\r\n\r\nLocal aPedCli    := {}\r\nLocal aC5Rodape  := {}\r\nLocal aRelImp    := MaFisRelImp(\"MT100\",{\"SF2\",\"SD2\"})\r\nLocal aFisGet    := Nil\r\nLocal aFisGetSC5 := Nil\r\nLocal cKey \t     := \"\"\r\nLocal cAliasSC5  := \"SC5\"\r\nLocal cAliasSC6  := \"SC6\"\r\nLocal cQryAd     := \"\"\r\nLocal cPedido    := \"\"\r\nLocal cCliEnt\t := \"\"\r\nLocal cNfOri     := Nil\r\nLocal cSeriOri   := Nil\r\nLocal nDesconto  := 0\r\nLocal nPesLiq    := 0\r\nLocal nRecnoSD1  := Nil\r\nLocal nG\t\t := 0\r\nLocal nFrete\t := 0\r\nLocal nSeguro\t := 0\r\nLocal nFretAut\t := 0\r\nLocal nDespesa\t := 0\r\nLocal nDescCab\t := 0\r\nLocal nPDesCab\t := 0\r\nLocal nY         := 0\r\nLocal nValMerc   := 0\r\nLocal nPrcLista  := 0\r\nLocal nAcresFin  := 0\r\nLocal nCont\t\t := 0\r\n\r\nFisGetInit(@aFisGet,@aFisGetSC5)\r\n\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Transforma parametros Range em expressao SQL                            ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\nMakeSqlExpr(oReport:uParam)\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Filtragem do relatório                                                  ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\ncQryAd := \"%\"\r\nFor nY := 1 To Len(aFisGet)\r\n\tcQryAd += \",\"+aFisGet[nY][2]\r\nNext nY\r\nFor nY := 1 To Len(aFisGetSC5)\r\n\tcQryAd += \",\"+aFisGetSC5[nY][2]\r\nNext nY\t\t\r\ncQryAd += \"%\"\r\n\r\ncAliasSC5:= cAliasSC6:= GetNextAlias()\r\n\r\noReport:Section(1):BeginQuery()\r\nBeginSql Alias cAliasSC5\r\nSELECT SC5.R_E_C_N_O_ SC5REC,SC6.R_E_C_N_O_ SC6REC,\r\nSC5.C5_FILIAL,SC5.C5_NUM,SC5.C5_CLIENTE,SC5.C5_LOJACLI,SC5.C5_TIPO,\r\nSC5.C5_TIPOCLI,SC5.C5_TRANSP,SC5.C5_PBRUTO,SC5.C5_PESOL,SC5.C5_DESC1,\r\nSC5.C5_DESC2,SC5.C5_DESC3,SC5.C5_DESC4, UPPER(ISNULL(CAST(CAST(SC5.C5_MENNOTA AS VARBINARY(MAX)) AS VARCHAR(MAX)),'')) C5_MENNOTA  ,SC5.C5_EMISSAO,\r\nSC5.C5_CONDPAG,SC5.C5_FRETE,SC5.C5_DESPESA,SC5.C5_FRETAUT,SC5.C5_TPFRETE,SC5.C5_SEGURO,SC5.C5_TABELA,\r\nSC5.C5_VOLUME1,SC5.C5_VOLUME2,SC5.C5_ESPECI1,SC5.C5_MOEDA,SC5.C5_REAJUST,SC5.C5_BANCO,\r\nSC5.C5_ACRSFIN,SC5.C5_VEND1,SC5.C5_VEND2,SC5.C5_VEND3,SC5.C5_VEND4,SC5.C5_VEND5,\r\nSC5.C5_COMIS1,SC5.C5_COMIS2,SC5.C5_COMIS3,SC5.C5_COMIS4,SC5.C5_COMIS5,SC5.C5_PDESCAB,SC5.C5_DESCONT,C5_INCISS,\r\nSC5.C5_CLIENT,\r\nSC6.C6_FILIAL,SC6.C6_NUM,SC6.C6_PEDCLI,SC6.C6_PRODUTO,\r\nSC6.C6_TES,SC6.C6_CF,SC6.C6_QTDVEN,SC6.C6_PRUNIT,SC6.C6_VALDESC,\r\nSC6.C6_VALOR,SC6.C6_ITEM,SC6.C6_DESCRI,SC6.C6_UM,\r\nSC6.C6_PRCVEN,SC6.C6_NOTA,SC6.C6_SERIE,SC6.C6_CLI,\r\nSC6.C6_LOJA,SC6.C6_ENTREG,SC6.C6_DESCONT,SC6.C6_LOCAL,\r\nSC6.C6_QTDEMP,SC6.C6_QTDLIB,SC6.C6_QTDENT,SC6.C6_NFORI,SC6.C6_SERIORI,SC6.C6_ITEMORI\r\n%Exp:cQryAd%\r\nFROM %Table:SC5% SC5, %Table:SC6% SC6\r\nWHERE\r\nSC5.C5_FILIAL = %xFilial:SC5% AND\r\nSC5.C5_NUM >= %SC5->C5_NUM% AND\r\n//SC5.C5_NUM <= %Exp:mv_par02% AND\r\nSC5.%notdel% AND\r\nSC6.C6_FILIAL = %xFilial:SC6% AND\r\nSC6.C6_NUM   = SC5.C5_NUM AND\r\nSC6.%notdel%\r\nORDER BY SC5.C5_NUM    \r\nEndSql\r\noReport:section(1):endQuery()\r\n(cAliasSC5)->( dbEval( {|| nCont++ } ) )\r\n(cAliasSC5)->( dbGoTop() )\r\noReport:SetMeter(nCont)\t\t// Total de Elementos da regua\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Inicio da impressao do fluxo do relatório                               ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\nWhile !oReport:Cancel() .And. !((cAliasSC5)->(Eof())) .and. xFilial(\"SC5\")==(cAliasSC5)->C5_FILIAL\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Executa a validacao dos filtros do usuario           \t     ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tdbSelectArea(cAliasSC5)\r\n\r\n\tcCliEnt := IIf(!Empty((cAliasSC5)->(FieldGet(FieldPos(\"C5_CLIENT\")))),(cAliasSC5)->C5_CLIENT,(cAliasSC5)->C5_CLIENTE)\r\n\taCabPed := {}\r\n\r\n\tMaFisIni(cCliEnt,;\t\t\t\t\t\t// 1-Codigo Cliente/Fornecedor\r\n\t\t(cAliasSC5)->C5_LOJACLI,;\t\t\t// 2-Loja do Cliente/Fornecedor\r\n\t\tIf((cAliasSC5)->C5_TIPO$'DB',\"F\",\"C\"),;\t// 3-C:Cliente , F:Fornecedor\r\n\t\t(cAliasSC5)->C5_TIPO,;\t\t\t\t// 4-Tipo da NF\r\n\t\t(cAliasSC5)->C5_TIPOCLI,;\t\t\t// 5-Tipo do Cliente/Fornecedor\r\n\t\taRelImp,;\t\t\t\t\t\t\t// 6-Relacao de Impostos que suportados no arquivo\r\n\t\t,;\t\t\t\t\t\t   \t\t\t// 7-Tipo de complemento\r\n\t\t,;\t\t\t\t\t\t\t\t\t// 8-Permite Incluir Impostos no Rodape .T./.F.\r\n\t\t\"SB1\",;\t\t\t\t\t\t\t\t// 9-Alias do Cadastro de Produtos - (\"SBI\" P/ Front Loja)\r\n\t\t\"MATA461\")\t\t\t\t\t\t\t// 10-Nome da rotina que esta utilizando a funcao\r\n\t//Na argentina o calculo de impostos depende da serie.\r\n\tIf cPaisLoc == 'ARG'\r\n\t\tSA1->(DbSetOrder(1))\r\n\t\tSA1->(MsSeek(xFilial()+(cAliasSC5)->C5_CLIENTE+(cAliasSC5)->C5_LOJACLI))\r\n\t\tMaFisAlt('NF_SERIENF',LocXTipSer('SA1',MVNOTAFIS))\r\n\tEndif\r\n\r\n\tnFrete\t\t:= (cAliasSC5)->C5_FRETE\r\n\tnSeguro\t\t:= (cAliasSC5)->C5_SEGURO\r\n\tnFretAut\t:= (cAliasSC5)->C5_FRETAUT\r\n\tnDespesa\t:= (cAliasSC5)->C5_DESPESA\r\n\tnDescCab\t:= (cAliasSC5)->C5_DESCONT\r\n\tnPDesCab\t:= (cAliasSC5)->C5_PDESCAB\r\n\r\n\taItemPed:= {}\r\n\taCabPed := {\t(cAliasSC5)->C5_TIPO\t,;\r\n\t\t(cAliasSC5)->C5_CLIENTE\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_LOJACLI\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_TRANSP\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_CONDPAG\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_EMISSAO\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_NUM\t\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_VEND1\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_VEND2\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_VEND3\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_VEND4\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_VEND5\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_COMIS1\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_COMIS2\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_COMIS3\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_COMIS4\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_COMIS5\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_FRETE\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_TPFRETE\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_SEGURO\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_TABELA\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_VOLUME1\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_ESPECI1\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_MOEDA\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_REAJUST\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_BANCO\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_ACRSFIN\t\t\t\t,;\r\n\t\t(cAliasSC5)->C5_VOLUME2\t\t\t\t;\r\n\t\t}\r\n\tnTotQtd \t:= 0\r\n\tnTotVal \t:= 0\r\n\tnPesBru\t\t:= 0\r\n\tnPesLiq\t\t:= 0\r\n\taPedCli\t\t:= {}\r\n\tcPedido\t\t:= (cAliasSC5)->C5_NUM\r\n\taC5Rodape\t:= {}\r\n\t\r\n\tdbSelectArea(\"SC5\")\r\n\tdbSetOrder(1)\r\n\tdbSeek(xFilial(\"SC5\")+(cAliasSC5)->C5_NUM)\r\n\t\t\r\n\taadd(aC5Rodape,{(cAliasSC5)->C5_PBRUTO,(cAliasSC5)->C5_PESOL,(cAliasSC5)->C5_DESC1,(cAliasSC5)->C5_DESC2,;\r\n\t\t(cAliasSC5)->C5_DESC3,(cAliasSC5)->C5_DESC4,SC5->C5_MENNOTA + \" \" + SC5->C5_MSG2 })\r\n\r\n\taPedCli := Mtr730Cli(cPedido)\r\n\r\n\tdbSelectArea(cAliasSC5)\r\n\tFor nY := 1 to Len(aFisGetSC5)\r\n\t\tIf !Empty(&(aFisGetSC5[ny][2]))\r\n\t\t\tIf aFisGetSC5[ny][1] == \"NF_SUFRAMA\"\r\n\t\t\t\tMaFisAlt(aFisGetSC5[ny][1],Iif(&(aFisGetSC5[ny][2]) == \"1\",.T.,.F.),Len(aItemPed),.T.)\t\t\r\n\t\t\tElse\r\n\t\t\t\tMaFisAlt(aFisGetSC5[ny][1],&(aFisGetSC5[ny][2]),Len(aItemPed),.T.)\r\n\t\t\tEndif\t\r\n\t\tEndIf\r\n\tNext nY\r\n\r\n\tWhile !oReport:Cancel() .And. !((cAliasSC6)->(Eof())) .And. xFilial(\"SC6\")==(cAliasSC6)->C6_FILIAL .And.;\r\n\t\t\t(cAliasSC6)->C6_NUM == cPedido\r\n\r\n\t\toReport:IncMeter()\r\n\r\n\t\tcNfOri     := Nil\r\n\t\tcSeriOri   := Nil\r\n\t\tnRecnoSD1  := Nil\r\n\t\tnDesconto  := 0\r\n\r\n\t\tIf !Empty((cAliasSC6)->C6_NFORI)\r\n\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSeek(xFilial(\"SC6\")+(cAliasSC6)->C6_NFORI+(cAliasSC6)->C6_SERIORI+(cAliasSC6)->C6_CLI+(cAliasSC6)->C6_LOJA+;\r\n\t\t\t\t(cAliasSC6)->C6_PRODUTO+(cAliasSC6)->C6_ITEMORI)\r\n\t\t\tcNfOri     := (cAliasSC6)->C6_NFORI\r\n\t\t\tcSeriOri   := (cAliasSC6)->C6_SERIORI\r\n\t\t\tnRecnoSD1  := SD1->(RECNO())\r\n\t\tEndIf\r\n\t\tdbSelectArea(cAliasSC6)\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Calcula o preco de lista                     ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tnValMerc  := (cAliasSC6)->C6_VALOR\r\n\t\tnPrcLista := (cAliasSC6)->C6_PRUNIT\r\n\t\tIf ( nPrcLista == 0 )\r\n\t\t\tnPrcLista := NoRound(nValMerc/(cAliasSC6)->C6_QTDVEN,TamSX3(\"C6_PRCVEN\")[2])\r\n\t\tEndIf\r\n\t\tnAcresFin := A410Arred((cAliasSC6)->C6_PRCVEN*(cAliasSC5)->C5_ACRSFIN/100,\"D2_PRCVEN\")\r\n\t\tnValMerc  += A410Arred((cAliasSC6)->C6_QTDVEN*nAcresFin,\"D2_TOTAL\")\t\t\r\n\t\tnDesconto := a410Arred(nPrcLista*(cAliasSC6)->C6_QTDVEN,\"D2_DESCON\")-nValMerc\r\n\t\tnDesconto := IIf(nDesconto==0,(cAliasSC6)->C6_VALDESC,nDesconto)\r\n\t\tnDesconto := Max(0,nDesconto)\r\n\t\tnPrcLista += nAcresFin\r\n\t\tIf cPaisLoc==\"BRA\"\r\n\t\t\tnValMerc  += nDesconto\r\n\t\tEndIf\t\t\t\r\n\t\t\r\n\t\tMaFisAdd((cAliasSC6)->C6_PRODUTO\t,;\t// 1-Codigo do Produto ( Obrigatorio )\r\n\t\t\t(cAliasSC6)->C6_TES\t\t\t\t,;\t// 2-Codigo do TES ( Opcional )\r\n\t\t\t(cAliasSC6)->C6_QTDVEN\t\t\t,;\t// 3-Quantidade ( Obrigatorio )\r\n\t\t\tnPrcLista\t\t\t\t\t\t,;\t// 4-Preco Unitario ( Obrigatorio )\r\n\t\t\tnDesconto\t\t\t\t\t\t,;\t// 5-Valor do Desconto ( Opcional )\r\n\t\t\tcNfOri\t\t\t\t\t\t\t,;\t// 6-Numero da NF Original ( Devolucao/Benef )\r\n\t\t\tcSeriOri\t\t\t\t\t\t,;\t// 7-Serie da NF Original ( Devolucao/Benef )\r\n\t\t\tnRecnoSD1\t\t\t\t\t\t,;\t// 8-RecNo da NF Original no arq SD1/SD2\r\n\t\t\t0\t\t\t\t\t\t\t\t,;\t// 9-Valor do Frete do Item ( Opcional )\r\n\t\t\t0\t\t\t\t\t\t\t\t,;\t// 10-Valor da Despesa do item ( Opcional )\r\n\t\t\t0\t\t\t\t\t\t\t\t,;\t// 11-Valor do Seguro do item ( Opcional )\r\n\t\t\t0\t\t\t\t\t\t\t\t,;\t// 12-Valor do Frete Autonomo ( Opcional )\r\n\t\t\tnValMerc\t\t\t\t\t\t,;\t// 13-Valor da Mercadoria ( Obrigatorio )\r\n\t\t\t0\t\t\t\t\t\t\t\t,;\t// 14-Valor da Embalagem ( Opiconal )\r\n\t\t\t0\t\t\t\t\t\t\t\t,;\t// 15-RecNo do SB1\r\n\t\t\t0\t\t\t\t\t\t\t\t)\t// 16-RecNo do SF4\r\n\t\r\n\t\taadd(aItemPed,\t{\t(cAliasSC6)->C6_ITEM\t,;\r\n\t\t\t(cAliasSC6)->C6_PRODUTO\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_DESCRI\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_TES\t\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_CF\t\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_UM\t\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_QTDVEN\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_PRCVEN\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_NOTA\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_SERIE\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_CLI\t\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_LOJA\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_VALOR\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_ENTREG\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_DESCONT\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_LOCAL\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_QTDEMP\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_QTDLIB\t\t\t\t\t,;\r\n\t\t\t(cAliasSC6)->C6_QTDENT\t\t\t\t\t,;\r\n\t\t\t})\t\t\t\t\t\t\t\r\n\t\t\t\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Forca os valores de impostos que foram informados no SC6.              ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tdbSelectArea(cAliasSC6)\r\n\t\tFor nY := 1 to Len(aFisGet)\r\n\t\t\tIf !Empty(&(aFisGet[ny][2]))\r\n\t\t\t\tMaFisAlt(aFisGet[ny][1],&(aFisGet[ny][2]),Len(aItemPed))\r\n\t\t\tEndIf\r\n\t\tNext nY\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Calculo do ISS                               ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tSF4->(dbSetOrder(1))\r\n\t\tSF4->(MsSeek(xFilial(\"SF4\")+(cAliasSC6)->C6_TES))\r\n\t\tIf ( (cAliasSC5)->C5_INCISS == \"N\" .And. (cAliasSC5)->C5_TIPO == \"N\")\r\n\t\t\tIf ( SF4->F4_ISS==\"S\" )\r\n\t\t\t\tnPrcLista := a410Arred(nPrcLista/(1-(MaAliqISS(Len(aItemPed))/100)),\"D2_PRCVEN\")\r\n\t\t\t\tnValMerc  := a410Arred(nValMerc/(1-(MaAliqISS(Len(aItemPed))/100)),\"D2_PRCVEN\")\r\n\t\t\t\tMaFisAlt(\"IT_PRCUNI\",nPrcLista,Len(aItemPed))\r\n\t\t\t\tMaFisAlt(\"IT_VALMERC\",nValMerc,Len(aItemPed))\r\n\t\t\tEndIf\r\n\t\tEndIf\t\r\n\t\t\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Altera peso para calcular frete              ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tSB1->(dbSetOrder(1))\r\n\t\tSB1->(MsSeek(xFilial(\"SB1\")+(cAliasSC6)->C6_PRODUTO))\t\t\t\r\n\t\tMaFisAlt(\"IT_PESO\",(cAliasSC6)->C6_QTDVEN*SB1->B1_PESO,Len(aItemPed))\r\n\t\tMaFisAlt(\"IT_PRCUNI\",nPrcLista,Len(aItemPed))\r\n\t\tMaFisAlt(\"IT_VALMERC\",nValMerc,Len(aItemPed))\r\n\t\t\t\r\n\t\t(cAliasSC6)->(dbSkip())\r\n\tEndDo\r\n\t\r\n\tMaFisAlt(\"NF_FRETE\"   ,nFrete)\r\n\tMaFisAlt(\"NF_SEGURO\"  ,nSeguro)\r\n\tMaFisAlt(\"NF_AUTONOMO\",nFretAut)\r\n\tMaFisAlt(\"NF_DESPESA\" ,nDespesa)\r\n\r\n\tIf nDescCab > 0\r\n\t\tMaFisAlt(\"NF_DESCONTO\",Min(MaFisRet(,\"NF_VALMERC\")-0.01,nDescCab+MaFisRet(,\"NF_DESCONTO\")))\r\n\tEndIf\r\n\tIf nPDesCab > 0\r\n\t\tMaFisAlt(\"NF_DESCONTO\",A410Arred(MaFisRet(,\"NF_VALMERC\")*nPDesCab/100,\"C6_VALOR\")+MaFisRet(,\"NF_DESCONTO\"))\r\n\tEndIf\r\n\r\n\tImpCabecR4(aPedCli,oReport,aCabPed)\r\n\r\n\toReport:Section(1):Init()\r\n\tnItem := 0\r\n\tFor nG := 1 To Len(aItemPed)\r\n\t\tnItem += 1\r\n\t\tIf oReport:Row() > 1500\r\n\t\t\toReport:Section(1):Finish()\r\n\t\t\tImpRodapR4(nPesLiq,nPesBru,aC5Rodape,.F.,oReport)\r\n\t\t\toReport:EndPage(.T.)\r\n\t\t\toReport:Section(1):Init()\r\n\t\t \tImpCabecR4(aPedCli,oReport,aCabPed)\r\n\t\tEndif\r\n\t\tImpItemR4(nItem,@nPesLiq,@nPesBru,oReport,oPreNota,aCabPed,aItemPed)\r\n\tNext\r\n\toReport:Section(1):Finish()\r\n\tImpRodapR4(nPesLiq,nPesBru,aC5Rodape,.T.,oReport)\r\n\toReport:EndPage(.T.)\t\t// Finaliza pagina de impressao (zeras as linhas e colunas)\r\n\r\n\tMaFisEnd()\r\n\r\nEndDo\r\n\r\nReturn\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ImpCabecR4³ Autor ³ Marco Bianchi         ³ Data ³ 11/07/06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Emissao da Pr‚-Nota                                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe e ³ ImpCabec(void)                                             ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Matr730                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ImpCabecR4(aPedCli,oReport,aCabPed)\r\n\r\nLocal nPed\t\t:= 0\r\nLocal i         := 0\r\nLocal cMoeda\t:= \"\"\r\nLocal cPedCli   := \"\"\r\nLocal cPictCgc  := \"\"\r\nLocal oBox\r\nLocal nPrinLin  := 0\r\nLocal nInicio   := 20\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³  array acabped                                              ³\r\n//³  -------------                                              ³\r\n//³  01 C5_TIPO           10 C5_VEND3     \t19 C5_TPFRETE       ³\r\n//³  02 C5_CLIENTE        11 C5_VEND4     \t20 C5_SEGURO        ³\r\n//³  03 C5_LOJACLI        12 C5_VEND5     \t21 C5_TABELA        ³\r\n//³  04 C5_TRANSP         13 C5_COMIS1    \t22 C5_VOLUME1       ³\r\n//³  05 C5_CONDPAG        14 C5_COMIS2    \t23 C5_ESPECI1       ³\r\n//³  06 C5_EMISSAO        15 C5_COMIS3    \t24 C5_MOEDA         ³\r\n//³  07 C5_NUM            16 C5_COMIS4    \t25 C5_REAJUST       ³\r\n//³  08 C5_VEND1          17 C5_COMIS5    \t26 C5_BANCO         ³\r\n//³  09 C5_VEND2          18 C5_FRETE     \t27 C5_ACRSFIN       ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Posiciona registro no cliente do pedido                     ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\nIF !(aCabPed[1]$\"DB\")   //C5_TIPO\r\n\tdbSelectArea(\"SA1\")\r\n\tdbSeek(xFilial(\"SA1\")+aCabped[2]+aCabped[3])  //C5_CLIENTE + C5_LOJACLI\r\n\tcPictCgc := PesqPict(\"SA1\",\"A1_CGC\")\t\r\nElse\r\n\tdbSelectArea(\"SA2\")\r\n\tdbSeek(xFilial(\"SA2\")+aCabPed[2]+aCabPed[3])  // C5_CLIENTE + C5_LOJACLI\r\n\tcPictCgc := PesqPict(\"SA2\",\"A2_CGC\")\t\r\nEndif\r\n\r\ndbSelectArea(\"SA4\")\r\ndbSetOrder(1)\r\ndbSeek(xFilial(\"SA4\")+aCabPed[4])\t   \t\t\t\t// C5_TRANSP\r\ndbSelectArea(\"SE4\")\r\ndbSetOrder(1)\r\ndbSeek(xFilial(\"SE4\")+aCabPed[5])\t  \t\t\t\t// C5_CONDPAG\r\naSort(aPedCli)\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Inicializa impressao do cabecalho                           ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noReport:HideHeader()\t\t\t// Nao imprime cabecalho padrao do Protheus\r\noReport:SkipLine()\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Desenha as caixas do cabecalho                              ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noReport:Box(20,10,200,750,oBox)\r\noReport:Box(20,750,200,1800,oBox)\r\noReport:Box(20,1800,200,3000,oBox)\r\n\r\nIF !(aCabPed[1]$\"DB\")\t\t//C5_TIPO\r\n   nPrinLin := nInicio\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Informacoes do Quadro 1: Dados da Empresa                   ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\toReport:PrintText(\"\",nPrinLin,10)\r\n\toReport:PrintText(SM0->M0_NOME,nPrinLin,20)\r\n\tnPrinLin += 30\r\n\toReport:PrintText(SM0->M0_ENDCOB,nPrinLin,20)\r\n\tnPrinLin += 30\r\n\toReport:PrintText(STR0067+SM0->M0_TEL,nPrinLin,20)\t// \"TEL: \"\r\n\tnPrinLin += 30\r\n\toReport:PrintText(Iif(cPaisLoc==\"BRA\",STR0071,Alltrim(Posicione('SX3',2,'A1_CGC','SX3->X3_TITULO'))+\":\")+;\t// \"CGC: \"\r\n\t\t\t\t\t\tTransform(SM0->M0_CGC,cPictCgc)+ \" \" +Subs(SM0->M0_CIDCOB,1,15),nPrinLin,20)\r\n\t\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Informacoes do Quadro 2: Dados do Cliente                   ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n   nPrinLin := nInicio\r\n\toReport:PrintText(SA1->A1_COD+\"/\"+SA1->A1_LOJA+\" \"+SA1->A1_NOME,nPrinLin,760)\t\r\n\tnPrinLin += 30\r\n\toReport:PrintText(IF( !Empty(SA1->A1_ENDENT) .And. SA1->A1_ENDENT # SA1->A1_END,SA1->A1_ENDENT, SA1->A1_END ),nPrinLin,760)\r\n\tnPrinLin += 30\r\n\toReport:PrintText(IF( !Empty(SA1->A1_CEPE) .And. SA1->A1_CEPE # SA1->A1_CEP,SA1->A1_CEPE, SA1->A1_CEP )+\" \"+;\r\n\t\t\t\t\t\tIF( !Empty(SA1->A1_MUNE) .And. SA1->A1_MUNE # SA1->A1_MUN,SA1->A1_MUNE, SA1->A1_MUN )+\" \"+;\r\n\t\t\t\t\t\tIF( !Empty(SA1->A1_ESTE) .And. SA1->A1_ESTE # SA1->A1_EST,SA1->A1_ESTE, SA1->A1_EST ),nPrinLin,760)\r\n\tnPrinLin += 30\r\n\toReport:PrintText(subs(transform(SA1->A1_CGC,PicPesFJ(RetPessoa(SA1->A1_CGC))),1,at(\"%\",transform(SA1->A1_CGC,PicPes(RetPessoa(SA1->A1_CGC))))-1),nPrinLin,760)\r\n\tIf cPaisLoc == \"BRA\"\t\r\n\t\toReport:PrintText(STR0069+SA1->A1_INSCR,nPrinLin,1050)\t\t// \"IE: \"\r\n\tEndif\r\n\t\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Informacoes do Quadro 3: Dados do Pedido                    ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n   nPrinLin := nInicio\r\n\toReport:PrintText(STR0066,nPrinLin,1810)\t\t\t\t\t\t\t// \"CONFIRMACAO DO PEDIDO\"\r\n\tnPrinLin += 60\r\n\toReport:PrintText(STR0068+DTOC(aCabPed[6]),nPrinLin,1810)\t\t// \"EMISSAO: \"\r\n\tnPrinLin += 30\r\n\toReport:PrintText(STR0070+aCabPed[7],nPrinLin,1810)\t\t\t// \"PEDIDO N. \"\r\n\t\r\nElse\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Informacoes do Quadro 1: Dados da Empresa                   ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n   nPrinLin := nInicio\r\n   \r\n\toReport:PrintText(SM0->M0_NOME,nPrinLin,20)\r\n\tnPrinLin += 30\r\n\toReport:PrintText(SM0->M0_ENDCOB,nPrinLin,20)\r\n\tnPrinLin += 30\r\n\toReport:PrintText(STR0067+SM0->M0_TEL,nPrinLin,20)\t\t\t\t\t\t\t\t\t\t\t\t\t\t// \"TEL: \"\r\n\tnPrinLin += 30\r\n\toReport:PrintText(Iif(cPaisLoc==\"BRA\",STR0071,Alltrim(Posicione('SX3',2,'A1_CGC','SX3->X3_TITULO'))+\":\")+;\t// \"CGC: \"\r\n\t\t\t\t\t\tTransform(SM0->M0_CGC,cPictCgc)+ \" \" +Subs(SM0->M0_CIDCOB,1,15),nPrinLin,20)\r\n\t\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Informacoes do Quadro 2: Dados do Cliente                   ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tnPrinLin := nInicio\r\n\toReport:PrintText(SA2->A2_COD+\"/\"+SA2->A2_LOJA+\" \"+SA2->A2_NOME,nPrinLin,760)\t\r\n\tnPrinLin += 30\r\n\toReport:PrintText(SA2->A2_END,nPrinLin,760)\r\n\tnPrinLin += 30\r\n\toReport:PrintText(SA2->A2_CEP + \" \" + SA2->A2_MUN + \" \" + SA2->A2_EST,nPrinLin,760)\r\n\tnPrinLin += 30\r\n\toReport:PrintText(subs(transform(SA2->A2_CGC,PicPesFJ(RetPessoa(SA2->A2_CGC))),1,at(\"%\",transform(SA2->A2_CGC,PicPes(RetPessoa(SA2->A2_CGC))))-1),nPrinLin,760)\r\n\tnPrinLin += 30\r\n\tIf cPaisLoc == \"BRA\"\t\r\n\t\toReport:PrintText(STR0069+SA2->A2_INSCR,nPrinLin,1050)\t\t// \"IE: \"\r\n\tEndif\r\n\t\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Informacoes do Quadro 3: Dados do Pedido                    ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tnPrinLin := nInicio\r\n\toReport:PrintText(STR0066,nPrinLin,1810)\t\t\t\t\t\t\t// \"CONFIRMACAO DO PEDIDO\"\r\n\tnPrinLin += 60\r\n\toReport:PrintText(STR0068+DTOC(aCabPed[6]),nPrinLin,1810)\t\t// \"EMISSAO: \"\r\n\tnPrinLin += 30\r\n\toReport:PrintText(STR0070+aCabPed[7],nPrinLin,1810)\t\t\t// \"PEDIDO N. \"\r\n\r\nEndif \r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Pedidos do Cliente                                          ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noReport:SkipLine(6)\r\nIf Len(aPedCli) > 0\r\n\toReport:PrintText(\"PEDIDO(S) DO CLIENTE: \",oReport:Row(),20)\r\n\tcPedCli:=\"\"\r\n\tFor nPed := 1 To Len(aPedCli)\r\n\t\tcPedCli += aPedCli[nPed]+Space(02)\r\n\t\tIf Len(cPedCli) > 100 .or. nPed == Len(aPedCli)\r\n\t\t\toReport:PrintText(cPedCli,oReport:Row(),350)\r\n\t\t\tcPedCli:=\"\"\r\n \t\t   oReport:SkipLine(2)\r\n\t\tEndif\r\n\tNext\r\n\toReport:Line(oReport:Row(),10,oReport:Row()+5,3000)\r\nEndif\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Transportadora                                              ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noReport:SkipLine()\r\noReport:PrintText(STR0072+aCabPed[4]+\" - \"+SA4->A4_NOME,oReport:Row(),20)\t\t// \"TRANSP...: \"\t\t//C5_TRANSP\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Vendedores                                                  ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noReport:SkipLine()\r\nFor i := 8 to 12\r\n\tdbSelectArea(\"SA3\")\r\n\tdbSetOrder(1)\r\n\tIf dbSeek(xFilial(\"SA3\")+aCabPed[i])\t\t\t\t\t\t\t\t\t\t\t\t\t\t// C5_VENDi\r\n\t\tIf i == 8\r\n\t\t\toReport:PrintText(STR0073,oReport:Row(),20)\t\t\t\t\t\t\t\t\t\t// \"VENDEDOR.: \"\r\n\t\t\toReport:PrintText(STR0074,oReport:Row(),1000)\t\t\t\t\t\t\t\t\t\t// \"COMISSAO: \"\r\n\t\tEndIf\r\n\t\toReport:PrintText(aCabPed[i] + \" - \"+SA3->A3_NOME,oReport:Row(),300)\r\n\t\toReport:PrintText(Transform(aCabPed[i+5],\"99.99\"),oReport:Row(),1150)\r\n\t\toReport:SkipLine()\r\n\tEndIf\t\r\nNext\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Condicao de Pagto, Frete e Seguro                           ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noReport:PrintText(STR0075+aCabPed[5]+\" - \"+SE4->E4_DESCRI,oReport:Row(),20)\t\t\t\t\t// \"COND.PGTO: \"\t\t//C5_CONDPAG\r\noReport:PrintText(STR0076,oReport:Row(),1000)\t\t\t\t\t\t\t\t\t\t\t\t\t// \"FRETE...: \"\r\noReport:PrintText(Transform(aCabPed[18],\"@EZ 999,999,999.99\"),oReport:Row(),1050)\t\t\t\t// C5_FRETE\r\noReport:PrintText(TipoFrete(aCabPed[19]),oReport:Row(),1300)\t\t\t\t\t// C5_TPFRETE\r\noReport:PrintText(STR0077,oReport:Row(),2000)\t\t\t\t\t\t\t\t\t\t\t\t\t// \"SEGURO: \"\r\noReport:PrintText(Transform(aCabPed[20],\"@EZ 999,999,999.99\"),oReport:Row(),2050)\t\t\t\t// C5_SEGURO\r\noReport:SkipLine()\r\n\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Tabela, Volume e Especie                                    ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\noReport:PrintText(STR0078+aCabPed[21],oReport:Row(),20)\t\t\t\t\t\t\t\t\t\t// \"TABELA...: \"\t// C5_TABELA\r\noReport:PrintText(STR0079+Transform(aCabPed[22],\"@EZ 999,999\"),oReport:Row(),1000)\t\t\t\t// \"VOLUMES.: \"\t\t// C5_VOLUME1s\r\noReport:PrintText(STR0080+aCabPed[23],oReport:Row(),2000) \t\t\t\t\t\t\t\t\t\t// \"ESPECIE: \"\t\t// C5_ESPECIE1\r\noReport:SkipLine()\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Reajuste, Moeda, Banco e Acrescimo Financeiro               ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\ncMoeda:=Strzero(aCabPed[24],1,0)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// C5_MOEDA\r\noReport:PrintText(STR0081+aCabPed[25]+STR0082 +IIF(cMoeda < \"2\",\"1\",cMoeda),oReport:Row(),20)\t// \"REAJUSTE.: \"###\"   Moeda : \" \t//C5_REAJUST\r\noReport:PrintText(STR0083 + aCabPed[26],oReport:Row(),1000)\t\t\t\t   \t\t\t\t\t// \"BANCO: \"\t\t//C5_BANCO\r\noReport:PrintText(STR0084 + Str(aCabPed[27],6,2),oReport:Row(),2000)\t\t\t\t\t\t\t// \"ACRES.FIN.: \"\t//C5_ACRSFIN\r\noReport:SkipLine()\r\noReport:Line(oReport:Row(),10,oReport:Row()+5,3000)\r\n\r\nReturn( .T. )\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ ImpItemR4³ Autor ³ Marco Bianchi         ³ Data ³ 11/07/06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Emissao da Pr‚-Nota                                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe e ³ ImpItem(void)                                              ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Matr730                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ImpItemR4(nItem,nPesLiq,nPesBru,oReport,oPreNota,aCabPed,aItemPed)\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³  array aitemped                                             ³\r\n//³  --------------                                             ³\r\n//³  01 c6_item           08 c6_prcven         15 c6_descont    ³\r\n//³  02 c6_produto        09 c6_nota           16 c6_local      ³\r\n//³  03 c6_descri         10 c6_serie          17 c6_qtdemp     ³\r\n//³  04 c6_tes            11 c6_cli            18 c6_qtdlib     ³\r\n//³  05 c6_cf             12 c6_loja           19 c6_qtdent     ³\r\n//³  06 c6_um             13 c6_valor                           ³\r\n//³  07 c6_qtdven         14 c6_entreg                          ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\nLocal cChaveD2\t:= \"\"\r\nLocal nDecs\t    := MsDecimais(Max(1,aCabPed[24]))  //C5_MOEDA\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ SetBlock: faz com que as variaveis locais possam ser                   ³\r\n//³ utilizadas em outras funcoes nao precisando declara-las                ³\r\n//³ como private.                                                          ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\nIf cPaisLoc <> \"BRA\"\r\n\toReport:Section(1):Cell(\"NVALIMP\"):SetBlock({|| nValImp})\r\nElse\t\r\n\toReport:Section(1):Cell(\"AITEM13\"):SetBlock({|| aItemPed[nItem][13]+nValImp})\r\nEndIf\r\noReport:Section(1):Cell(\"NULTLIB\"):SetBlock({|| nUltLib})\r\nnValImp := 0\r\nnUltLib := 0\r\nIf cPaisLoc == \"BRA\"\r\n\tIf aCabPed[1] == \"P\"\r\n\t\tnValImp := 0\r\n\tElse\r\n\t\tnValImp\t:=\tMaFisRet(nItem,\"IT_VALIPI\")\r\n\tEndif\r\nElse\r\n\tnValImp\t:=\tMaRetIncIV(nItem,\"2\")\r\nEndif\r\n\r\ndbSelectArea(\"SB1\")\r\ndbSeek(xFilial(\"SB1\")+aItemPed[nItem][2])  //C6_PRODUTO\r\n\r\n//C6_nota C6_serie C6_cli C6_loja C6_produto\r\ncChaveD2 := xFilial(\"SD2\")+aItemPed[nItem][09]+aItemPed[nItem][10]+aItemPed[nItem][11]+aItemPed[nItem][12]+aItemPed[nItem][02]\r\ndbSelectArea(\"SD2\")\r\ndbSetOrder(3)\r\ndbSeek(cChaveD2)\r\nWhile !Eof() .and. cChaveD2 = xFilial(\"SD2\")+D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_COD\r\n\tnUltLib := D2_QUANT\r\n\tdbSkip()\r\nEndDo\r\n\r\noReport:Section(1):PrintLine()\r\n\r\nnTotQtd += aItemPed[nItem][07]\t\t\t\t\t\t//C6_QTDVEN\r\nnTotVal += aItemPed[nItem][13]+nValImp\t\t\t\t//C6_VALOR\r\nnPesLiq\t+= SB1->B1_PESO * aItemPed[nItem][07]\t\t//C6_QTDVEN\r\nnPesBru += SB1->B1_PESBRU * aItemPed[nItem][07]\t\t//C6_QTDVEN\r\n\r\nReturn (Nil)\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ImpRodapR4³ Autor ³ Marco Bianchi         ³ Data ³ 11/07/06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Emissao da Pr‚-Nota                                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe e ³ ImpRoadpe(void)                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Matr730                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ImpRodapR4(nPesLiq,nPesBru,aC5Rodape,lFinal,oReport)\r\n\r\nLocal I     \t:= 0\r\nDEFAULT lFinal\t:= .F.\r\n\r\nIf lFinal\r\n\r\n\toReport:SkipLine()\r\n\toReport:Line(oReport:Row(),10,oReport:Row(),3000)\r\n\r\n\tIf cPaisLoc == 'BRA'\r\n\t\toReport:SkipLine()\r\n\t\toReport:PrintText(SubStr(STR0038,1,15))\r\n\t\toReport:Section(2):Init()\r\n\t\toReport:Section(2):PrintLine()\r\n\t\toReport:Section(2):Finish()\r\n\tElse\r\n\t\taCodImps\t:=\t{}\r\n\t\taCodImps := MaFisRet(,\"NF_IMPOSTOS\") //Descricao / /Aliquota / Valor / Base\r\n\t\toReport:Section(2):Init()\r\n\t\tFor I:=1 To Len(aCodImps)// Vetor com os impostos\r\n\t\t\tnI := I\r\n\t\t\toReport:Section(2):PrintLine()\r\n\t\tNext\r\n\t\toReport:Section(2):Finish()\r\n\tEndif\r\nEndif\t\r\n\r\noReport:SkipLine()\r\noReport:PrintText(STR0100+STR(If(aC5Rodape[1][1] > 0,aC5Rodape[1][1],nPesBru)),1880,30)\t// \"PESO BRUTO ------>\"\r\noReport:PrintText(STR0101+STR(If(aC5Rodape[1][2] > 0,aC5Rodape[1][2],nPesLiq)),1910,30)\t// \"PESO LIQUIDO ---->\"\r\noReport:PrintText(\"BOX ------------->\" ,1940,30)\t\t\t\t\t\t\t\t\t\t        // \"BOX ------------->\"\r\noReport:PrintText(STR0103,1970,30)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// \"SEPARADO POR ---->\"\r\noReport:PrintText(STR0104,2000,30)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// \"CONFERIDO POR --->\"\r\noReport:PrintText(STR0105,2030,30)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// \"D A T A --------->\"\r\n\r\noReport:PrintText(STR0106,2090,30)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// \"DESCONTOS: \"\r\noReport:PrintText(Transform(aC5Rodape[1][3],\"99.99\"),2090,200)\r\noReport:PrintText(Transform(aC5Rodape[1][4],\"99.99\"),2090,300)\r\noReport:PrintText(Transform(aC5Rodape[1][5],\"99.99\"),2090,400)\r\noReport:PrintText(Transform(aC5Rodape[1][6],\"99.99\"),2090,500)\r\n\r\n\r\nnLin2 := mlcount(AllTrim(aC5Rodape[1][7]),60,,.F.)\r\nnDist := 0\r\n\r\nFor i := 1 to nLin2\r\n\tIF I=1\r\n\t\toReport:PrintText(STR0107+memoline(AllTrim(aC5Rodape[1][7]),60,i,,.F.) ,2150,030)\t\t\t\t\t// \"MENSAGEM PARA NOTA FISCAL: \"\r\n\t\tnDist := 30\r\n\tElse\r\n\t\toReport:PrintText(        memoline(AllTrim(aC5Rodape[1][7]),60,2,,.T.),2150,nDist)\t\t\t\t\t\t\t\t// \"MENSAGEM PARA NOTA FISCAL: \"\r\n\tEndIf\r\n\t\r\n\tnDist := nDist + 100\r\nNext\r\n\r\n\r\n\r\n\r\nReturn( NIL )\r\n\r\n//SUBSTR(AllTrim(aC5Rodape[1][7]),301,700)\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³ MATR730R3³ Autor ³ Eduardo José Zanardo  ³ Data ³ 26.12.01 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Emissao da Pr‚-Nota                                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³Nenhum                                                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³Nenhum                                                      ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\n\r\nuser Function Matr730R3Q\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Define Variaveis                                                        ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\nLocal Titulo  := OemToAnsi(STR0001) //\"Emissao da Confirmacao do Pedido\"\r\nLocal cDesc1  := OemToAnsi(STR0002) //\"Emiss„o da confirmac„o dos pedidos de venda, de acordo com\"\r\nLocal cDesc2  := OemToAnsi(STR0003) //\"intervalo informado na op‡„o Parƒmetros.\"\r\nLocal cDesc3  := \" \"\r\nLocal cString := \"SC5\"  // Alias utilizado na Filtragem\r\nLocal lDic    := .F. // Habilita/Desabilita Dicionario\r\nLocal lComp   := .F. // Habilita/Desabilita o Formato Comprimido/Expandido\r\nLocal lFiltro := .F. // Habilita/Desabilita o Filtro\r\nLocal wnrel   := \"MATR730\" // Nome do Arquivo utilizado no Spool\r\nLocal nomeprog:= \"MATR730\"\r\nLocal cPerg   := \"\"//\"MTR730\"\r\n\r\nPrivate Tamanho := \"G\" // P/M/G\r\nPrivate Limite  := 220 // 80/132/220\r\nPrivate aOrdem  := {}  // Ordem do Relatorio\r\nPrivate aReturn := { STR0004, 1,STR0005, 2, 2, 1, \"\",0 } //\"Zebrado\"###\"Administracao\"\r\n//[1] Reservado para Formulario\r\n//[2] Reservado para N§ de Vias\r\n//[3] Destinatario\r\n//[4] Formato => 1-Comprimido 2-Normal\r\n//[5] Midia   => 1-Disco 2-Impressora\r\n//[6] Porta ou Arquivo 1-LPT1... 4-COM1...\r\n//[7] Expressao do Filtro\r\n//[8] Ordem a ser selecionada\r\n//[9]..[10]..[n] Campos a Processar (se houver)\r\n\r\nPrivate lEnd    := .F.// Controle de cancelamento do relatorio\r\nPrivate m_pag   := 1  // Contador de Paginas\r\nPrivate nLastKey:= 0  // Controla o cancelamento da SetPrint e SetDefault\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Verifica as Perguntas Seleciondas                                       ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n//Pergunte(cPerg,.F.)\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Envia para a SetPrinter                                                 ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\nlFiltro := .F.\r\n\r\nwnrel:=SetPrint(cString,wnrel,cPerg,@titulo,cDesc1,cDesc2,cDesc3,lDic,aOrdem,lComp,Tamanho,lFiltro)\r\nIf ( nLastKey==27 )\r\n\tdbSelectArea(cString)\r\n\tdbSetOrder(1)\r\n\tdbClearFilter()\r\n\tReturn\r\nEndif\r\nSetDefault(aReturn,cString)\r\nIf ( nLastKey==27 )\r\n\tdbSelectArea(cString)\r\n\tdbSetOrder(1)\r\n\tdbClearFilter()\r\n\tReturn\r\nEndif\r\n\r\nRptStatus({|lEnd| C730Imp(@lEnd,wnRel,cString,nomeprog,Titulo)},Titulo)\r\n\r\nReturn(.T.)\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Program   ³ C730Imp   ³ Autor ³ Eduardo J. Zanardo   ³ Data ³26.12.2001³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Controle de Fluxo do Relatorio.                             ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³Nenhum                                                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³Nenhum                                                      ³±±\r\n±±³          ³                                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\n\r\nStatic Function C730Imp(lEnd,wnrel,cString,nomeprog,Titulo)\r\n\r\nLocal aPedCli    := {}\r\nLocal aStruSC5   := {}\r\nLocal aStruSC6   := {}\r\nLocal aC5Rodape  := {}\r\nLocal aRelImp    := MaFisRelImp(\"MT100\",{\"SF2\",\"SD2\"})\r\nLocal aFisGet    := Nil\r\nLocal aFisGetSC5 := Nil\r\nLocal li         := 100 // Contador de Linhas\r\nLocal lImp       := .F. // Indica se algo foi impresso\r\nLocal lRodape    := .F.\r\nLocal cbCont     := 0   // Numero de Registros Processados\r\nLocal cbText     := \"\"  // Mensagem do Rodape\r\nLocal cKey \t     := \"\"\r\nLocal cFilter    := \"\"\r\nLocal cAliasSC5  := \"SC5\"\r\nLocal cAliasSC6  := \"SC6\"\r\nLocal cQuery     := \"\"\r\nLocal cQryAd     := \"\"\r\nLocal cName      := \"\"\r\nLocal cPedido    := \"\"\r\nLocal cCliEnt\t := \"\"\r\nLocal cNfOri     := Nil\r\nLocal cSeriOri   := Nil\r\nLocal nItem      := 0\r\nLocal nTotQtd    := 0\r\nLocal nTotVal    := 0\r\nLocal nDesconto  := 0\r\nLocal nPesLiq    := 0\r\nLocal nSC5       := 0\r\nLocal nSC6       := 0\r\nLocal nX         := 0\r\nLocal nRecnoSD1  := Nil\r\nLocal nG\t\t := 0\r\nLocal nFrete\t := 0\r\nLocal nSeguro\t := 0\r\nLocal nFretAut\t := 0\r\nLocal nDespesa\t := 0\r\nLocal nDescCab\t := 0\r\nLocal nPDesCab\t := 0\r\nLocal nY         := 0\r\nLocal nValMerc   := 0\r\nLocal nPrcLista  := 0\r\nLocal nAcresFin  := 0\r\n\r\nPrivate aItemPed := {}\r\nPrivate aCabPed\t := {}\r\n\r\nFisGetInit(@aFisGet,@aFisGetSC5)\r\n\r\ncAliasSC5:= \"C730Imp\"\r\ncAliasSC6:= \"C730Imp\"\r\naStruSC5  := SC5->(dbStruct())\t\t\r\naStruSC6  := SC6->(dbStruct())\t\t\r\ncQuery := \"SELECT SC5.R_E_C_N_O_ SC5REC,SC6.R_E_C_N_O_ SC6REC,\"\r\ncQuery += \"SC5.C5_FILIAL,SC5.C5_NUM,SC5.C5_CLIENTE,SC5.C5_LOJACLI,SC5.C5_TIPO,\"\r\ncQuery += \"SC5.C5_TIPOCLI,SC5.C5_TRANSP,SC5.C5_PBRUTO,SC5.C5_PESOL,SC5.C5_DESC1,\"\r\ncQuery += \"SC5.C5_DESC2,SC5.C5_DESC3,SC5.C5_DESC4,UPPER(ISNULL(CAST(CAST(SC5.C5_MENNOTA AS VARBINARY(MAX)) AS VARCHAR(MAX)),'')) C5_MENNOTA,SC5.C5_EMISSAO,\"\r\ncQuery += \"SC5.C5_CONDPAG,SC5.C5_FRETE,SC5.C5_DESPESA,SC5.C5_FRETAUT,SC5.C5_TPFRETE,SC5.C5_SEGURO,SC5.C5_TABELA,\"\r\ncQuery += \"SC5.C5_VOLUME1,SC5.C5_VOLUME2,SC5.C5_ESPECI1,SC5.C5_MOEDA,SC5.C5_REAJUST,SC5.C5_BANCO,\"\r\ncQuery += \"SC5.C5_ACRSFIN,SC5.C5_VEND1,SC5.C5_VEND2,SC5.C5_VEND3,SC5.C5_VEND4,SC5.C5_VEND5,\"\r\ncQuery += \"SC5.C5_COMIS1,SC5.C5_COMIS2,SC5.C5_COMIS3,SC5.C5_COMIS4,SC5.C5_COMIS5,SC5.C5_PDESCAB,SC5.C5_DESCONT,C5_INCISS,\"\r\n\r\nIf SC5->(FieldPos(\"C5_CLIENT\"))>0\r\n\tcQuery += \"SC5.C5_CLIENT,\"\t\t\t\r\nEndif\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Esta rotina foi escrita para adicionar no select os campos         ³\r\n//³usados no filtro do usuario quando houver, a rotina acrecenta      ³\r\n//³somente os campos que forem adicionados ao filtro testando         ³\r\n//³se os mesmo já existem no select ou se forem definidos novamente   ³\r\n//³pelo o usuario no filtro                                           ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\nIf !Empty(aReturn[7])\r\n\tFor nX := 1 To SC5->(FCount())\r\n\t\tcName := SC5->(FieldName(nX))\r\n\t\tIf AllTrim( cName ) $ aReturn[7]\r\n\t\t\tIf aStruSC5[nX,2] <> \"M\"\r\n\t\t\t\tIf !cName $ cQuery .And. !cName $ cQryAd\r\n\t\t\t\t\tcQryAd += cName +\",\"\r\n\t\t\t\tEndif \t\r\n\t\t\tEndIf\r\n\t\tEndIf \t\t\t       \t\r\n\tNext nX\r\nEndif\r\n\r\nFor nY := 1 To Len(aFisGet)\r\n\tcQryAd += aFisGet[nY][2]+\",\"\r\nNext nY\r\n\r\nFor nY := 1 To Len(aFisGetSC5)\r\n\tcQryAd += aFisGetSC5[nY][2]+\",\"\r\nNext nY\t\t\r\n\r\ncQuery += cQryAd\r\ncQuery += \"SC6.C6_FILIAL,SC6.C6_NUM,SC6.C6_PEDCLI,SC6.C6_PRODUTO,\"\r\ncQuery += \"SC6.C6_TES,SC6.C6_CF,SC6.C6_QTDVEN,SC6.C6_PRUNIT,SC6.C6_VALDESC,\"\r\ncQuery += \"SC6.C6_VALOR,SC6.C6_ITEM,SC6.C6_DESCRI,SC6.C6_UM, \"\r\ncQuery += \"SC6.C6_PRCVEN,SC6.C6_NOTA,SC6.C6_SERIE,SC6.C6_CLI,\"\r\ncQuery += \"SC6.C6_LOJA,SC6.C6_ENTREG,SC6.C6_DESCONT,SC6.C6_LOCAL,\"\r\ncQuery += \"SC6.C6_QTDEMP,SC6.C6_QTDLIB,SC6.C6_QTDENT,SC6.C6_NFORI,SC6.C6_SERIORI,SC6.C6_ITEMORI \"\r\ncQuery += \"FROM \"\r\ncQuery += RetSqlName(\"SC5\") + \" SC5 ,\"\r\ncQuery += RetSqlName(\"SC6\") + \" SC6 \"\t\t\r\ncQuery += \"WHERE \"\r\ncQuery += \"SC5.C5_FILIAL = '\"+xFilial(\"SC5\")+\"' AND \"\t\t\r\ncQuery += \"SC5.C5_NUM = '\"+SC5->C5_NUM+\"' AND \"\r\n//cQuery += \"SC5.C5_NUM <= '\"+mv_par02+\"' AND \"\r\ncQuery += \"SC5.D_E_L_E_T_ = ' ' AND \"\r\ncQuery += \"SC6.C6_FILIAL = '\"+xFilial(\"SC6\")+\"' AND \"\t\t\r\ncQuery += \"SC6.C6_NUM   = SC5.C5_NUM AND \"\r\ncQuery += \"SC6.D_E_L_E_T_ = ' ' \"\r\ncQuery += \"ORDER BY SC5.C5_NUM\"\r\n\r\ncQuery := ChangeQuery(cQuery)\r\n\r\ndbUseArea(.T.,\"TOPCONN\",TcGenQry(,,cQuery),cAliasSC5,.T.,.T.)\r\n\r\nFor nSC5 := 1 To Len(aStruSC5)\r\n\tIf aStruSC5[nSC5][2] <> \"C\" .and.  FieldPos(aStruSC5[nSC5][1]) > 0\r\n\t\tTcSetField(cAliasSC5,aStruSC5[nSC5][1],aStruSC5[nSC5][2],aStruSC5[nSC5][3],aStruSC5[nSC5][4])\r\n\tEndIf\r\nNext nSC5\r\n\r\nFor nSC6 := 1 To Len(aStruSC6)\r\n\tIf aStruSC6[nSC6][2] <> \"C\" .and. FieldPos(aStruSC6[nSC6][1]) > 0\r\n\t\tTcSetField(cAliasSC6,aStruSC6[nSC6][1],aStruSC6[nSC6][2],aStruSC6[nSC6][3],aStruSC6[nSC6][4])\r\n\tEndIf\r\nNext nSC6\t\t    \t\r\n\r\nWhile !((cAliasSC5)->(Eof())) .and. xFilial(\"SC5\")==(cAliasSC5)->C5_FILIAL\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Executa a validacao dos filtros do usuario           \t     ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tdbSelectArea(cAliasSC5)\r\n\tlFiltro := IIf((!Empty(aReturn[7]).And.!&(aReturn[7])),.F.,.T.)\r\n\r\n\tIf lFiltro\r\n\r\n\t\tcCliEnt   := IIf(!Empty((cAliasSC5)->(FieldGet(FieldPos(\"C5_CLIENT\")))),(cAliasSC5)->C5_CLIENT,(cAliasSC5)->C5_CLIENTE)\r\n\r\n\t\taCabPed := {}\r\n\r\n\t\tMaFisIni(cCliEnt,;\t\t\t\t\t\t\t// 1-Codigo Cliente/Fornecedor\r\n\t\t\t(cAliasSC5)->C5_LOJACLI,;\t\t\t// 2-Loja do Cliente/Fornecedor\r\n\t\t\tIf((cAliasSC5)->C5_TIPO$'DB',\"F\",\"C\"),;\t// 3-C:Cliente , F:Fornecedor\r\n\t\t\t(cAliasSC5)->C5_TIPO,;\t\t\t\t// 4-Tipo da NF\r\n\t\t\t(cAliasSC5)->C5_TIPOCLI,;\t\t\t// 5-Tipo do Cliente/Fornecedor\r\n\t\t\taRelImp,;\t\t\t\t\t\t\t// 6-Relacao de Impostos que suportados no arquivo\r\n\t\t\t,;\t\t\t\t\t\t   \t\t\t// 7-Tipo de complemento\r\n\t\t\t,;\t\t\t\t\t\t\t\t\t// 8-Permite Incluir Impostos no Rodape .T./.F.\r\n\t\t\t\"SB1\",;\t\t\t\t\t\t\t// 9-Alias do Cadastro de Produtos - (\"SBI\" P/ Front Loja)\r\n\t\t\t\"MATA461\")\t\t\t\t\t\t\t// 10-Nome da rotina que esta utilizando a funcao\r\n\t\t//Na argentina o calculo de impostos depende da serie.\r\n\t\tIf cPaisLoc == 'ARG'\r\n\t\t\tSA1->(DbSetOrder(1))\r\n\t\t\tSA1->(MsSeek(xFilial()+(cAliasSC5)->C5_CLIENTE+(cAliasSC5)->C5_LOJACLI))\r\n\t\t\tMaFisAlt('NF_SERIENF',LocXTipSer('SA1',MVNOTAFIS))\r\n\t\tEndif\r\n\r\n\t\tnFrete\t\t:= (cAliasSC5)->C5_FRETE\r\n\t\tnSeguro\t\t:= (cAliasSC5)->C5_SEGURO\r\n\t\tnFretAut\t:= (cAliasSC5)->C5_FRETAUT\r\n\t\tnDespesa\t:= (cAliasSC5)->C5_DESPESA\r\n\t\tnDescCab\t:= (cAliasSC5)->C5_DESCONT\r\n\t\tnPDesCab\t:= (cAliasSC5)->C5_PDESCAB\r\n\r\n\t\taItemPed:= {}\r\n\t\taCabPed := {\t(cAliasSC5)->C5_TIPO,;\r\n\t\t\t(cAliasSC5)->C5_CLIENTE,;\r\n\t\t\t(cAliasSC5)->C5_LOJACLI,;\r\n\t\t\t(cAliasSC5)->C5_TRANSP,;\r\n\t\t\t(cAliasSC5)->C5_CONDPAG,;\r\n\t\t\t(cAliasSC5)->C5_EMISSAO,;\r\n\t\t\t(cAliasSC5)->C5_NUM,;\r\n\t\t\t(cAliasSC5)->C5_VEND1,;\r\n\t\t\t(cAliasSC5)->C5_VEND2,;\r\n\t\t\t(cAliasSC5)->C5_VEND3,;\r\n\t\t\t(cAliasSC5)->C5_VEND4,;\r\n\t\t\t(cAliasSC5)->C5_VEND5,;\r\n\t\t\t(cAliasSC5)->C5_COMIS1,;\r\n\t\t\t(cAliasSC5)->C5_COMIS2,;\r\n\t\t\t(cAliasSC5)->C5_COMIS3,;\r\n\t\t\t(cAliasSC5)->C5_COMIS4,;\r\n\t\t\t(cAliasSC5)->C5_COMIS5,;\r\n\t\t\t(cAliasSC5)->C5_FRETE,;\r\n\t\t\t(cAliasSC5)->C5_TPFRETE,;\r\n\t\t\t(cAliasSC5)->C5_SEGURO,;\r\n\t\t\t(cAliasSC5)->C5_TABELA,;\r\n\t\t\t(cAliasSC5)->C5_VOLUME1,;\r\n\t\t\t(cAliasSC5)->C5_ESPECI1,;\r\n\t\t\t(cAliasSC5)->C5_MOEDA,;\r\n\t\t\t(cAliasSC5)->C5_REAJUST,;\r\n\t\t\t(cAliasSC5)->C5_BANCO,;\r\n\t\t\t(cAliasSC5)->C5_ACRSFIN,;\r\n\t\t\t(cAliasSC5)->C5_VOLUME2;\r\n\t\t\t}\r\n\t\tnTotQtd\t\t:= 0\r\n\t\tnTotVal\t\t:= 0\r\n\t\tnPesBru\t\t:= 0\r\n\t\tnPesLiq\t\t:= 0\r\n\t\taPedCli\t\t:= {}\r\n\t\tcPedido\t\t:= (cAliasSC5)->C5_NUM\r\n\t\taC5Rodape\t:= {}\r\n\t\t\r\n\t\tdbSelectArea(\"SC5\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SC5\")+(cAliasSC5)->C5_NUM)\r\n\t\t\r\n\t\taadd(aC5Rodape,{(cAliasSC5)->C5_PBRUTO,(cAliasSC5)->C5_PESOL,(cAliasSC5)->C5_DESC1,(cAliasSC5)->C5_DESC2,;\r\n\t\t\t(cAliasSC5)->C5_DESC3,(cAliasSC5)->C5_DESC4, SC5->C5_MENNOTA + \" \" + SC5->C5_MSG2})\r\n\r\n\t\taPedCli := Mtr730Cli(cPedido)\r\n\r\n\t\tdbSelectArea(cAliasSC5)\r\n\t\tFor nY := 1 to Len(aFisGetSC5)\r\n\t\t\tIf !Empty(&(aFisGetSC5[ny][2]))\r\n\t\t\t\tIf aFisGetSC5[ny][1] == \"NF_SUFRAMA\"\r\n\t\t\t\t\tMaFisAlt(aFisGetSC5[ny][1],Iif(&(aFisGetSC5[ny][2]) == \"1\",.T.,.F.),Len(aItemPed),.T.)\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tMaFisAlt(aFisGetSC5[ny][1],&(aFisGetSC5[ny][2]),Len(aItemPed),.T.)\r\n\t\t\t\tEndif\t\r\n\t\t\tEndIf\r\n\t\tNext nY\r\n\r\n\t\tWhile !((cAliasSC6)->(Eof())) .And. xFilial(\"SC6\")==(cAliasSC6)->C6_FILIAL .And.;\r\n\t\t\t\t(cAliasSC6)->C6_NUM == cPedido\r\n\r\n\t\t\tcNfOri     := Nil\r\n\t\t\tcSeriOri   := Nil\r\n\t\t\tnRecnoSD1  := Nil\r\n\t\t\tnDesconto  := 0\r\n\r\n\t\t\tIf !Empty((cAliasSC6)->C6_NFORI)\r\n\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tdbSeek(xFilial(\"SC6\")+(cAliasSC6)->C6_NFORI+(cAliasSC6)->C6_SERIORI+(cAliasSC6)->C6_CLI+(cAliasSC6)->C6_LOJA+;\r\n\t\t\t\t\t(cAliasSC6)->C6_PRODUTO+(cAliasSC6)->C6_ITEMORI)\r\n\t\t\t\tcNfOri     := (cAliasSC6)->C6_NFORI\r\n\t\t\t\tcSeriOri   := (cAliasSC6)->C6_SERIORI\r\n\t\t\t\tnRecnoSD1  := SD1->(RECNO())\r\n\t\t\tEndIf\r\n\r\n\t\t\tdbSelectArea(cAliasSC6)\r\n\r\n\t\t\tIf lEnd\r\n\t\t\t\t@ Prow()+1,001 PSAY STR0007 //\"CANCELADO PELO OPERADOR\"\r\n\t\t\t\tExit\r\n\t\t\tEndIf\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Calcula o preco de lista                     ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tnValMerc  := (cAliasSC6)->C6_VALOR\r\n\t\t\tnPrcLista := (cAliasSC6)->C6_PRUNIT\r\n\t\t\tIf ( nPrcLista == 0 )\r\n\t\t\t\tnPrcLista := NoRound(nValMerc/(cAliasSC6)->C6_QTDVEN,TamSX3(\"C6_PRCVEN\")[2])\r\n\t\t\tEndIf\r\n\t\t\tnAcresFin := A410Arred((cAliasSC6)->C6_PRCVEN*(cAliasSC5)->C5_ACRSFIN/100,\"D2_PRCVEN\")\r\n\t\t\tnValMerc  += A410Arred((cAliasSC6)->C6_QTDVEN*nAcresFin,\"D2_TOTAL\")\t\t\r\n\t\t\tnDesconto := a410Arred(nPrcLista*(cAliasSC6)->C6_QTDVEN,\"D2_DESCON\")-nValMerc\r\n\t\t\tnDesconto := IIf(nDesconto==0,(cAliasSC6)->C6_VALDESC,nDesconto)\r\n\t\t\tnDesconto := Max(0,nDesconto)\r\n\t\t\tnPrcLista += nAcresFin\r\n\t\t\tIf cPaisLoc==\"BRA\"\r\n\t\t\t\tnValMerc  += nDesconto\r\n\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\tMaFisAdd((cAliasSC6)->C6_PRODUTO,; \t  // 1-Codigo do Produto ( Obrigatorio )\r\n\t\t\t\t(cAliasSC6)->C6_TES,;\t\t\t  // 2-Codigo do TES ( Opcional )\r\n\t\t\t\t(cAliasSC6)->C6_QTDVEN,;\t\t  // 3-Quantidade ( Obrigatorio )\r\n\t\t\t\tnPrcLista,;\t\t  // 4-Preco Unitario ( Obrigatorio )\r\n\t\t\t\tnDesconto,;       // 5-Valor do Desconto ( Opcional )\r\n\t\t\t\tcNfOri,;\t\t                  // 6-Numero da NF Original ( Devolucao/Benef )\r\n\t\t\t\tcSeriOri,;\t\t                  // 7-Serie da NF Original ( Devolucao/Benef )\r\n\t\t\t\tnRecnoSD1,;\t\t\t          // 8-RecNo da NF Original no arq SD1/SD2\r\n\t\t\t\t0,;\t\t\t\t\t\t\t  // 9-Valor do Frete do Item ( Opcional )\r\n\t\t\t\t0,;\t\t\t\t\t\t\t  // 10-Valor da Despesa do item ( Opcional )\r\n\t\t\t\t0,;            \t\t\t\t  // 11-Valor do Seguro do item ( Opcional )\r\n\t\t\t\t0,;\t\t\t\t\t\t\t  // 12-Valor do Frete Autonomo ( Opcional )\r\n\t\t\t\tnValMerc,;// 13-Valor da Mercadoria ( Obrigatorio )\r\n\t\t\t\t0,;\t\t\t\t\t\t\t  // 14-Valor da Embalagem ( Opiconal )\r\n\t\t\t\t0,;\t\t     \t\t\t\t  // 15-RecNo do SB1\r\n\t\t\t\t0) \t\t\t\t\t\t\t  // 16-RecNo do SF4\r\n\r\n\t\t\taadd(aItemPed,\t{\t(cAliasSC6)->C6_ITEM,;\r\n\t\t\t\t(cAliasSC6)->C6_PRODUTO,;\r\n\t\t\t\t(cAliasSC6)->C6_DESCRI,;\r\n\t\t\t\t(cAliasSC6)->C6_TES,;\r\n\t\t\t\t(cAliasSC6)->C6_CF,;\r\n\t\t\t\t(cAliasSC6)->C6_UM,;\r\n\t\t\t\t(cAliasSC6)->C6_QTDVEN,;\r\n\t\t\t\t(cAliasSC6)->C6_PRCVEN,;\r\n\t\t\t\t(cAliasSC6)->C6_NOTA,;\r\n\t\t\t\t(cAliasSC6)->C6_SERIE,;\r\n\t\t\t\t(cAliasSC6)->C6_CLI,;\r\n\t\t\t\t(cAliasSC6)->C6_LOJA,;\r\n\t\t\t\t(cAliasSC6)->C6_VALOR,;\r\n\t\t\t\t(cAliasSC6)->C6_ENTREG,;\r\n\t\t\t\t(cAliasSC6)->C6_DESCONT,;\r\n\t\t\t\t(cAliasSC6)->C6_LOCAL,;\r\n\t\t\t\t(cAliasSC6)->C6_QTDEMP,;\r\n\t\t\t\t(cAliasSC6)->C6_QTDLIB,;\r\n\t\t\t\t(cAliasSC6)->C6_QTDENT,;\r\n\t\t\t\t})\t\t\t\t\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Forca os valores de impostos que foram informados no SC6.              ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tdbSelectArea(cAliasSC6)\r\n\t\t\tFor nY := 1 to Len(aFisGet)\r\n\t\t\t\tIf !Empty(&(aFisGet[ny][2]))\r\n\t\t\t\t\tMaFisAlt(aFisGet[ny][1],&(aFisGet[ny][2]),Len(aItemPed))\r\n\t\t\t\tEndIf\r\n\t\t\tNext nY\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Calculo do ISS                               ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tSF4->(dbSetOrder(1))\r\n\t\t\tSF4->(MsSeek(xFilial(\"SF4\")+(cAliasSC6)->C6_TES))\r\n\t\t\tIf ( (cAliasSC5)->C5_INCISS == \"N\" .And. (cAliasSC5)->C5_TIPO == \"N\")\r\n\t\t\t\tIf ( SF4->F4_ISS==\"S\" )\r\n\t\t\t\t\tnPrcLista := a410Arred(nPrcLista/(1-(MaAliqISS(Len(aItemPed))/100)),\"D2_PRCVEN\")\r\n\t\t\t\t\tnValMerc  := a410Arred(nValMerc/(1-(MaAliqISS(Len(aItemPed))/100)),\"D2_PRCVEN\")\r\n\t\t\t\t\tMaFisAlt(\"IT_PRCUNI\",nPrcLista,Len(aItemPed))\r\n\t\t\t\t\tMaFisAlt(\"IT_VALMERC\",nValMerc,Len(aItemPed))\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Altera peso para calcular frete              ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tSB1->(dbSetOrder(1))\r\n\t\t\tSB1->(MsSeek(xFilial(\"SB1\")+(cAliasSC6)->C6_PRODUTO))\t\t\t\r\n\t\t\tMaFisAlt(\"IT_PESO\",(cAliasSC6)->C6_QTDVEN*SB1->B1_PESO,Len(aItemPed))\r\n\t\t\tMaFisAlt(\"IT_PRCUNI\",nPrcLista,Len(aItemPed))\r\n\t\t\tMaFisAlt(\"IT_VALMERC\",nValMerc,Len(aItemPed))\r\n\t\t\t\r\n\t\t\t(cAliasSC6)->(dbSkip())\r\n\t\tEndDo\r\n\t\t\r\n\t\tMaFisAlt(\"NF_FRETE\"   ,nFrete)\r\n\t\tMaFisAlt(\"NF_SEGURO\"  ,nSeguro)\r\n\t\tMaFisAlt(\"NF_AUTONOMO\",nFretAut)\r\n\t\tMaFisAlt(\"NF_DESPESA\" ,nDespesa)\r\n\r\n\t\tIf nDescCab > 0\r\n\t\t\tMaFisAlt(\"NF_DESCONTO\",Min(MaFisRet(,\"NF_VALMERC\")-0.01,nDescCab+MaFisRet(,\"NF_DESCONTO\")))\r\n\t\tEndIf\r\n\t\tIf nPDesCab > 0\r\n\t\t\tMaFisAlt(\"NF_DESCONTO\",A410Arred(MaFisRet(,\"NF_VALMERC\")*nPDesCab/100,\"C6_VALOR\")+MaFisRet(,\"NF_DESCONTO\"))\r\n\t\tEndIf\r\n\r\n\t\tnItem := 0\r\n\t\tFor nG := 1 To Len(aItemPed)\r\n\t\t\tnItem += 1\r\n\t\t\tIF li > 45\r\n\t\t\t\tIF lRodape\r\n\t\t\t\t\tImpRodape(nPesLiq,nTotQtd,nTotVal,@li,nPesBru,aC5Rodape,cAliasSC5,,cAliasSC6)\r\n\t\t\t\tEndif\r\n\t\t\t\tli := 0\r\n\t\t\t\tlRodape := ImpCabec(@li,aPedCli,cAliasSC5)\r\n\t\t\tEndif\r\n\t\t\tImpItem(nItem,@nPesLiq,@li,@nTotQtd,@nTotVal,@nPesBru,cAliasSC6,cAliasSC5)\r\n\t\t\tli++\r\n\t\tNext\r\n\r\n\t\tIF lRodape\r\n\t\t\tImpRodape(nPesLiq,nTotQtd,nTotVal,@li,nPesBru,aC5Rodape,cAliasSC5,.T.,cAliasSC6)\r\n\t\t\tlRodape:=.F.\r\n\t\tEndif\r\n\r\n\t\tMaFisEnd()\r\n\r\n\tElse\r\n\t\tdbSelectArea(cAliasSC5)\r\n\t\tdbSkip()\r\n\tEndIf\r\n\r\nEndDo\r\n\r\ndbSelectArea(cAliasSC5)\r\ndbCloseArea()\r\n\r\nSet Device To Screen\r\nSet Printer To\r\n\r\nRetIndex(\"SC5\")\r\ndbSelectArea(\"SC5\")\r\ndbClearFilter()\r\n\r\ndbSelectArea(\"SC6\")\r\ndbClearFilter()\r\ndbSetOrder(1)\r\ndbGotop()\r\n\r\nIf ( aReturn[5] = 1 )\r\n\tdbCommitAll()\r\n\tOurSpool(wnrel)\r\nEndif\r\nMS_FLUSH()\r\nReturn(.T.)\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ ImpItem  ³ Autor ³ Claudinei M. Benzi    ³ Data ³ 05.11.92 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Emissao da Pr‚-Nota                                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe e ³ ImpItem(void)                                              ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Matr730                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ImpItem(nItem,nPesLiq,li,nTotQtd,nTotVal,nPesBru,cAliasSC6,cAliasSC5)\r\n/*\r\n01 C6_item\r\n02 C6_produto\r\n03 C6_descri\r\n04 C6_tes\r\n05 C6_cf\r\n06 C6_um\r\n07 C6_qtdven\r\n08 C6_prcven\r\n09 C6_nota\r\n10 C6_serie\r\n11 C6_cli\r\n12 C6_loja\r\n13 C6_valor\r\n14 C6_entreg\r\n15 C6_descont\r\n16 C6_local\r\n17 C6_qtdemp\r\n18 C6_qtdlib\r\n19 C6_qtdent\r\n*/\r\nLocal nUltLib  := 0\r\nLocal cChaveD2 := \"\"\r\nLocal nDecs\t:=\tMsDecimais(Max(1,aCabPed[24]))  //C5_MOEDA\r\nLocal nValImp\t:=0\r\ndbSelectArea(\"SB1\")\r\ndbSeek(xFilial(\"SB1\")+aItemPed[nItem][2])  //C6_PRODUTO\r\n\r\n@li,000 psay aItemPed[nItem][01]\t//C6_ITEM\r\n@li,003 psay aItemPed[nItem][02]\t//C6_PRODUTO\r\n@li,040 psay SUBS(IIF(Empty(aItemPed[nItem][03]),SB1->B1_DESC, aItemPed[nItem][03]),1,30)\t\t//C6_DESCRI\r\n@li,071 psay aItemPed[nItem][04]\t//C6_TES\r\n@li,075 psay aItemPed[nItem][05]\t//C6_CF\r\n@li,080 psay aItemPed[nItem][06]\t//C6_UM\r\n@li,083 psay aItemPed[nItem][07] Picture PesqPictQt(\"C6_QTDVEN\")\t//C6_QTDVEN\r\n@li,096 psay aItemPed[nItem][08] Picture PesqPict(\"SC6\",\"C6_PRCVEN\",12)\t//C6_PRCVEN\r\nIf cPaisLoc == \"BRA\"\r\n\tIf aCabPed[1] == \"P\"\r\n\t\tnValImp := 0\r\n\tElse\r\n\t\tnValImp\t:=\tMaFisRet(nItem,\"IT_VALIPI\")\r\n\tEndif\r\n\t@li,109 psay MaFisRet(nItem,\"IT_ALIQIPI\") Picture \"@e 99.99\"\r\nElse\r\n\tnValImp\t:=\tMaRetIncIV(nItem,\"2\")\r\n\t@li,110 psay  nValImp\tPicture Tm(nValImp,10,nDecs)\r\nEndif\r\n         \r\n\r\nIf ( cPaisLoc==\"BRA\" )\r\n\t@li,115 psay MaFisRet(nItem,\"IT_ALIQICM\") Picture \"@e 99.99\" //Aliq de ICMS\r\n\t@li,121 psay MaFisRet(nItem,\"IT_ALIQISS\") Picture \"@e 99.99\" //Aliq de ISS\t\r\nEndIf\r\n//C6_nota C6_serie C6_cli C6_loja C6_produto\r\ncChaveD2 := xFilial(\"SD2\")+aItemPed[nItem][09]+aItemPed[nItem][10]+aItemPed[nItem][11]+aItemPed[nItem][12]+aItemPed[nItem][02]\r\ndbSelectArea(\"SD2\")\r\ndbSetOrder(3)\r\ndbSeek(cChaveD2)\r\nWhile !Eof() .and. cChaveD2 = xFilial(\"SD2\")+D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_COD\r\n\tnUltLib := D2_QUANT\r\n\tdbSkip()\r\nEndDo\r\n\r\n@li,126   psay aItemPed[nItem][13]+nValImp Picture PesqPict(\"SC6\",\"C6_VALOR\",16,nDecs)\t\t//C6_VALOR\r\n@li,143   psay aItemPed[nItem][14]\t\t//C6_ENTREG\r\n@li,153   psay aItemPed[nItem][15]    Picture \"99.9\"  //C6_DESCONT\r\n@li,159   psay aItemPed[nItem][16]\t\t//C6_LOCAL\r\n@li,163   psay aItemPed[nItem][17] Picture PesqPictQt(\"C6_QTDLIB\")\t\t//C6_QTDEMP\r\n//C6_QTDVEN C6_QTDEMP C6_QTDLIB C6_QTDENT\r\n@li,177   psay aItemPed[nItem][07] - aItemPed[nItem][17] + aItemPed[nItem][18] - aItemPed[nItem][19] Picture PesqPictQt(\"C6_QTDLIB\")\r\n@li,190   psay nUltLib Picture PesqPictQt(\"D2_QUANT\")\r\n\r\nnTotQtd += aItemPed[nItem][07]\t\t\t\t\t\t//C6_QTDVEN\r\nnTotVal += aItemPed[nItem][13]+nValImp\t\t\t\t//C6_VALOR\r\nnPesLiq\t+= SB1->B1_PESO * aItemPed[nItem][07]\t\t//C6_QTDVEN\r\nnPesBru += SB1->B1_PESBRU * aItemPed[nItem][07]\t\t//C6_QTDVEN\r\nReturn (Nil)\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ ImpRodape³ Autor ³ Claudinei M. Benzi    ³ Data ³ 05.11.92 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Emissao da Pr‚-Nota                                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe e ³ ImpRoadpe(void)                                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Matr730                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ImpRodape(nPesLiq,nTotQtd,nTotVal,li,nPesBru,aC5Rodape,cAliasSC5,lFinal,cAliasSC6)\r\nLocal aCodImps\t:=\t{}\r\nLocal I     \t:= 0\r\n\r\nDEFAULT lFinal := .F.\r\n\r\n@ li,000 psay Replicate(\"-\",limite)\r\nli++\r\n@ li,000 psay STR0029\t//\" T O T A I S \"\r\n@ li,072 psay nTotQtd    Picture PesqPict(\"SC6\",\"C6_QTDVEN\",20)\r\n@ li,126 psay nTotVal    Picture PesqPict(\"SC6\",\"C6_VALOR\",17)\r\nIf lFinal\r\n\tli++\r\n\t@ li,000 psay Replicate(\"-\",limite-37)\r\n\tIf cPaisLoc == 'BRA'\r\n\t\tli++\r\n\t\t@ li,000 psay STR0038\r\n\t\t@ li,026 PSay STR0039\r\n\t\t@ li,046 PSay STR0040\r\n\t\t@ li,067 PSay STR0041\r\n\t\t@ li,087 PSay STR0042\r\n\t\t@ li,107 PSay STR0043\r\n\t\t@ li,128 PSay STR0044\r\n\t\t@ li,149 PSay STR0045\t\r\n\t\tli++\r\n\t\t@ li,022 PSay Transform(MaFisRet(,\"NF_BASEICM\"),PesqPict(\"SF2\",\"F2_BASEICM\"))\r\n\t\t@ li,042 PSay Transform(MaFisRet(,\"NF_VALICM\") ,PesqPict(\"SF2\",\"F2_VALICM\") )\r\n\t\t@ li,062 PSay Transform(MaFisRet(,\"NF_BASEIPI\"),PesqPict(\"SF2\",\"F2_BASEIPI\"))\r\n\t\t@ li,083 PSay Transform(MaFisRet(,\"NF_VALIPI\") ,PesqPict(\"SF2\",\"F2_VALIPI\") )\r\n\t\t@ li,105 PSay Transform(MaFisRet(,\"NF_BASESOL\"),PesqPict(\"SF2\",\"F2_ICMSRET\"))\r\n\t\t@ li,127 PSay Transform(MaFisRet(,\"NF_VALSOL\") ,PesqPict(\"SF2\",\"F2_VALBRUT\"))\r\n\t\t@ li,147 PSay Transform(MaFisRet(,\"NF_TOTAL\")  ,PesqPict(\"SF2\",\"F2_VALBRUT\"))\r\n\t\tli++                                                                            \t\r\n\t\t@ li,026 psay STR0046\r\n\t\t@ li,046 PSay STR0047\r\n\t\tli++                                                                            \t\t\r\n\t\t@ li,022 PSay Transform(MaFisRet(,\"NF_BASEISS\"),PesqPict(\"SF2\",\"F2_BASEISS\"))\r\n\t\t@ li,042 PSay Transform(MaFisRet(,\"NF_VALISS\") ,PesqPict(\"SF2\",\"F2_VALISS\") )\r\n\tElse\r\n\r\n\t\taCodImps := MaFisRet(,\"NF_IMPOSTOS\") //Descricao / /Aliquota / Valor / Base\r\n\t\tli++\r\n\t\t@ li,000 psay STR0038\r\n\t\t@ li,025 PSay STR0049 //\"Imposto                                 Base      Aliquota         Valor\"\r\n\t\tli++         \t\t\t\r\n\t\t@ li,025 PSay           \"------------------------------ ------------- ------------- -------------\"\r\n\t\tli++\r\n\t\tFor I:=1 To Len(aCodImps)// Vetor com os impostos\r\n\t\t\t@ li,25 PSay aCodImps[I][2]\r\n\t\t\t@ li,57 PSay aCodImps[I][3] Picture TM(aCodImps[I][4],12,MsDecimais(1))\r\n\t\t\t@ li,71 PSay aCodImps[I][4] Picture TM(aCodImps[I][4],12,MsDecimais(1))\r\n\t\t\t@ li,85 PSay aCodImps[I][5] Picture TM(aCodImps[I][4],12,MsDecimais(1))\r\n\t\t\tli++\r\n\t\tNext\r\n\r\n\tEndif\r\nEndif\t\r\n\r\n@ 51,005 psay STR0030+STR(If(aC5Rodape[1][1] > 0,aC5Rodape[1][1],nPesBru))\t//\"PESO BRUTO ------>\"\r\n@ 52,005 psay STR0031+STR(If(aC5Rodape[1][2] > 0,aC5Rodape[1][2] ,nPesLiq))\t//\"PESO LIQUIDO ---->\"\r\n@ 53,005 psay \"BOX ------------->                 \" + AllTrim(Str(SC5->C5_VOLUME2))\t//\"VOLUMES --------->\"\r\n@ 54,005 psay STR0033\t//\"SEPARADO POR ---->\"\r\n@ 55,005 psay STR0034\t//\"CONFERIDO POR --->\"\r\n@ 56,005 psay STR0035\t//\"D A T A --------->\"\r\n\r\n@ 58,000 psay STR0036\t//\"DESCONTOS: \"\r\n@ 58,011 psay aC5Rodape[1][3] Picture \"99.99\"\r\n@ 58,019 psay aC5Rodape[1][4] picture \"99.99\"\r\n@ 58,027 psay aC5Rodape[1][5] picture \"99.99\"\r\n@ 58,035 psay aC5Rodape[1][6] picture \"99.99\"\r\n\r\n\r\n\r\n//BRUNO\r\nnLin2 := mlcount(AllTrim(aC5Rodape[1][7]),200,,.F.)\r\nnDist := 0\r\n\r\nFor i := 1 to nLin2\r\n\tIF I=1\r\n\t\t@ 60,000 psay STR0037 + memoline(AllTrim(aC5Rodape[1][7]),200,i,,.T.) \t\t\t\r\n\t\tnDist := 60\r\n\tElse\r\n\t\t@ nDist,000 psay  memoline(AllTrim(aC5Rodape[1][7]),200,i,,.T.) \t\t\t\r\n\tEndIf\r\n\t\r\n\tnDist := nDist + 1\r\nNext\r\n\r\n\r\n@ 61,000 psay \"\"\r\n\r\nli := 80\r\n\r\nReturn( NIL )\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ ImpCabec ³ Autor ³ Claudinei M. Benzi    ³ Data ³ 05.11.92 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Emissao da Pr‚-Nota                                        ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe e ³ ImpCabec(void)                                             ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Matr730                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function ImpCabec(li,aPedCli,cAliasSC5)\r\n\r\nLocal cHeader\t:= \"\"\r\nLocal nPed\t\t:= 0\r\nLocal i         := 0\r\nLocal cMoeda\t:= \"\"\r\nLocal cPedCli   := \"\"\r\nLocal cPictCgc  := \"\"\r\nIf cPaisLoc == \"BRA\"\r\n\tcHeader := STR0008\t// It Codigo          Desc. do Material              TES CF   UM        Quant.  Valor Unit. IPI   ICMS   ISS     Vl.Tot.C/IPI Entrega   Desc Loc.    Qtd.a Fat         Saldo      Ult.Fat.\r\n\t//          \t\t   0         1         2         3         4         5         6         7         8         9        10        11        12        13        14\r\n\t//                     0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234\r\nElse\r\n\tcHeader := STR0048\t//\"It Codigo          Desc de Material               TES CF   UM        Quant.  Valor Unit.        Imp.Inc.       Valor Total Entrega   Desc Loc.      Ctd.Ent         Saldo     Ult.Entr.\"\r\n\t//        \t\t\t   0         1         2         3         4         5         6         7         8         9        10        11        12        13        14\r\n\t//                     0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234\r\nEndif\r\n\r\n/* array acabped\r\n01 C5_TIPO\r\n02 C5_CLIENTE\r\n03 C5_LOJACLI\r\n04 C5_TRANSP\r\n05 C5_CONDPAG\r\n06 C5_EMISSAO\r\n07 C5_NUM\r\n08 C5_VEND1\r\n09 C5_VEND2\r\n10 C5_VEND3\r\n11 C5_VEND4\r\n12 C5_VEND5\r\n13 C5_COMIS1\r\n14 C5_COMIS2\r\n15 C5_COMIS3\r\n16 C5_COMIS4\r\n17 C5_COMIS5\r\n18 C5_FRETE\r\n19 C5_TPFRETE\r\n20 C5_SEGURO\r\n21 C5_TABELA\r\n22 C5_VOLUME1\r\n23 C5_ESPECI1\r\n24 C5_MOEDA\r\n25 C5_REAJUST\r\n26 C5_BANCO\r\n27 C5_ACRSFIN\r\n*/\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³ Posiciona registro no cliente do pedido                     ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\nIF !(aCabPed[1]$\"DB\")   //C5_TIPO\r\n\tdbSelectArea(\"SA1\")\r\n\tdbSeek(xFilial(\"SA1\")+aCabped[2]+aCabped[3])  //C5_CLIENTE + C5_LOJACLI\r\n\tcPictCgc := PesqPict(\"SA1\",\"A1_CGC\")\t\r\nElse\r\n\tdbSelectArea(\"SA2\")\r\n\tdbSeek(xFilial(\"SA2\")+aCabPed[2]+aCabPed[3])  //C5_CLIENTE + C5_LOJACLI\r\n\tcPictCgc := PesqPict(\"SA2\",\"A2_CGC\")\t\r\nEndif\r\n\r\ndbSelectArea(\"SA4\")\r\ndbSetOrder(1)\r\ndbSeek(xFilial(\"SA4\")+aCabPed[4])\t\t//C5_TRANSP\r\ndbSelectArea(\"SE4\")\r\ndbSetOrder(1)\r\ndbSeek(xFilial(\"SE4\")+aCabPed[5])\t\t//C5_CONDPAG\r\n\r\naSort(aPedCli)\r\n@ 00,000 psay AvalImp(limite)\r\n@ 01,000 psay Replicate(\"-\",limite-37)\r\n@ 02,000 psay SM0->M0_NOME\r\nIF !(aCabPed[1]$\"DB\")\t\t//C5_TIPO\r\n\t@ 02,041 psay \"| \"+Left(SA1->A1_COD+\"/\"+SA1->A1_LOJA+\" \"+SA1->A1_NOME, 56)\r\n\t@ 02,100 psay STR0009\t\t//\"| CONFIRMACAO DO PEDIDO \"\r\n\t@ 03,000 psay SM0->M0_ENDCOB\r\n\t@ 03,041 psay \"| \"+IF( !Empty(SA1->A1_ENDENT) .And. SA1->A1_ENDENT # SA1->A1_END,SA1->A1_ENDENT, SA1->A1_END )\r\n\t@ 03,100 psay \"|\"\r\n\t@ 04,000 psay STR0010+SM0->M0_TEL\t\t\t//\"TEL: \"\r\n\t@ 04,041 psay \"| \"\r\n\t@ 04,043 psay IF( !Empty(SA1->A1_CEPE) .And. SA1->A1_CEPE # SA1->A1_CEP,SA1->A1_CEPE, SA1->A1_CEP )\r\n\t@ 04,053 psay IF( !Empty(SA1->A1_MUNE) .And. SA1->A1_MUNE # SA1->A1_MUN,SA1->A1_MUNE, SA1->A1_MUN )\r\n\t@ 04,077 psay IF( !Empty(SA1->A1_ESTE) .And. SA1->A1_ESTE # SA1->A1_EST,SA1->A1_ESTE, SA1->A1_EST )\r\n\t@ 04,100 psay STR0011\t\t//\"| EMISSAO: \"\r\n\t@ 04,111 psay aCabPed[6]\t//C5_EMISSAO\r\n\t@ 05,000 psay Iif(cPaisLoc==\"BRA\",STR0012,Alltrim(Posicione('SX3',2,'A1_CGC','SX3->X3_TITULO'))+\":\")\t\t//\"CGC: \"\r\n\t@ 05,006 psay SM0->M0_CGC    Picture cPictCGC //\"@R 99.999.999/9999-99\"\r\n\t@ 05,025 psay Subs(SM0->M0_CIDCOB,1,15)\r\n\t@ 05,041 psay \"|\"\r\n\t@ 05,043 psay subs(transform(SA1->A1_CGC,PicPes(RetPessoa(SA1->A1_CGC))),1,at(\"%\",transform(SA1->A1_CGC,PicPes(RetPessoa(SA1->A1_CGC))))-1)\r\n\tIf cPaisLoc == \"BRA\"\t\r\n\t\t@ 05,062 psay STR0013+SA1->A1_INSCR\t\t\t//\"IE: \"\r\n\tEndif\r\n\t@ 05,100 psay STR0014+aCabPed[7]\t\t\t//\"| PEDIDO N. \"\t//C5_NUM\r\nElse\r\n\t@ 02,041 psay \"| \"+SA2->A2_COD+\"/\"+SA2->A2_LOJA+\" \"+SA2->A2_NOME\r\n\t@ 02,100 psay STR0009\t//\"| CONFIRMACAO DO PEDIDO \"\r\n\t@ 03,000 psay SM0->M0_ENDCOB\r\n\t@ 03,041 psay \"| \"+ SA2->A2_END\r\n\t@ 03,100 psay \"|\"\r\n\t@ 04,000 psay STR0010+SM0->M0_TEL\t\t\t//\"TEL: \"\r\n\t@ 04,041 psay \"| \"+SA2->A2_CEP\r\n\t@ 04,053 psay SA2->A2_MUN\r\n\t@ 04,077 psay SA2->A2_EST\r\n\t@ 04,100 psay STR0011\t\t//\"| EMISSAO: \"\r\n\t@ 04,111 psay aCabPed[6]\t//C5_EMISSAO\r\n\t@ 05,000 psay Iif(cPaisLoc==\"BRA\",STR0012,Alltrim(Posicione('SX3',2,'A1_CGC','SX3->X3_TITULO'))+\":\")\t\t//\"CGC: \"\r\n\t@ 05,006 psay SM0->M0_CGC    Picture cPictCGC //\"@R 99.999.999/9999-99\"\r\n\t@ 05,025 psay Subs(SM0->M0_CIDCOB,1,15)\r\n\t@ 05,041 psay \"|\"\r\n\t@ 05,043 psay SA2->A2_CGC    Picture cPictCGC //\"@R 99.999.999/9999-99\"\r\n\tIf cPaisLoc == \"BRA\"\t\r\n\t\t@ 05,062 psay STR0013+SA2->A2_INSCR\t\t\t//\"IE: \"\r\n\tEndif\t\r\n\t@ 05,100 psay STR0014+aCabPed[7]\t\t\t//\"| PEDIDO N. \"\t//C5_NUM\r\nEndif\r\nli:= 6\r\nIf Len(aPedCli) > 0\r\n\t@ li,000 psay Replicate(\"-\",limite-37)\r\n\tli++\r\n\t@ li,000 psay \"PED. CLIENTE-#PO:\"\r\n\tcPedCli:=SC5->C5_XPO\r\n\t\r\n\tFor nPed := 1 To Len(aPedCli)\r\n\t\tcPedCli += aPedCli[nPed]+Space(02)\r\n\t\tIf Len(cPedCli) > 100 .or. nPed == Len(aPedCli)\r\n\t\t\t@ li,23 psay cPedCli\r\n\t\t\tcPedCli:=\"\"\r\n\t\t\tli++\r\n\t\tEndif\r\n\tNext\r\n\t\r\nEndif\r\n@ li,000 psay Replicate(\"-\",limite-37)\r\nli++\r\n@ li,000 psay STR0016+aCabPed[4]+\" - \"+SA4->A4_NOME\t\t\t//\"TRANSP...: \"\t\t//C5_TRANSP\r\nli++\r\n\r\nFor i := 8 to 12\r\n\tdbSelectArea(\"SA3\")\r\n\tdbSetOrder(1)\r\n\tIf dbSeek(xFilial(\"SA3\")+aCabPed[i])\t//C5_VENDi\r\n\t\tIf i == 8\r\n\t\t\t@ li,000 psay STR0017\t\t//\"VENDEDOR.: \"\r\n\t\tEndIf\r\n\t\t@ li,013 psay aCabPed[i] + \" - \"+SA3->A3_NOME\t//C5_VENDi\r\n\t\tIf i == 8\r\n\t\t\t@ li,065 psay STR0018\t\t//\"COMISSAO: \"\r\n\t\tEndIf\r\n\t\t@ li,075 psay aCabPed[i+5] Picture \"99.99\"\t\t//C5_COMISi+5\r\n\t\tli++\r\n\tEndIf\t\r\nNext\r\n\r\n@ li,000 psay STR0019+aCabPed[5]+\" - \"+SE4->E4_DESCRI\t\t\t//\"COND.PGTO: \"\t\t//C5_CONDPAG\r\n@ li,065 psay STR0020\t\t//\"FRETE...: \"\r\n@ li,075 psay aCabPed[18] Picture \"@EZ 999,999,999.99\"\t\t//C5_FRETE\r\n@ li,090 psay TipoFrete(aCabPed[19])\t\t//C5_TPFRETE\r\n@ li,100 psay STR0021\t\t//\"SEGURO: \"\r\n@ li,108 psay aCabPed[20] Picture \"@EZ 999,999,999.99\"\t\t//C5_SEGURO\r\nli++\r\n@ li,000 psay STR0022+aCabPed[21]\t\t//\"TABELA...: \"\t\t//C5_TABELA\r\n@ li,065 psay STR0023\t\t//\"VOLUMES.: \"\r\n@ li,075 psay aCabPed[22]    Picture \"@EZ 999,999\"\t\t//C5_VOLUME1s\r\n@ li,100 psay STR0024+aCabPed[23]\t\t//\"ESPECIE: \"\t//C5_ESPECIE1\r\nli++\r\ncMoeda:=Strzero(aCabPed[24],1,0)\t\t//C5_MOEDA\r\n@ li,000 psay STR0025+aCabPed[25]+STR0026 +IIF(cMoeda < \"2\",\"1\",cMoeda)\t\t//\"REAJUSTE.: \"###\"   Moeda : \" \t//C5_REAJUST\r\n@ li,065 psay STR0027 + aCabPed[26]\t\t\t\t\t//\"BANCO: \"\t\t//C5_BANCO\r\n@ li,100 psay STR0028+Str(aCabPed[27],6,2)\t\t//\"ACRES.FIN.: \"\t//C5_ACRSFIN\r\nli++\r\n@ li,000 psay Replicate(\"-\",limite)\r\nli++\r\n@ li,000 psay cHeader\r\nli++\r\n@ li,000 psay Replicate(\"-\",limite)\r\nli++\r\n\r\nReturn( .T. )\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³Mtr730Cli ³ Autor ³ Henry Fila            ³ Data ³ 26.08.02 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Função que retorna os pedidos do cliente                   ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe e ³ Mtr730Cli(cPedido)                                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ ExpC1: Numero do pedido                                    ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Matr730                                                    ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function Mtr730Cli(cPedido)\r\n\r\nLocal aPedidos := {}\r\nLocal aArea    := GetArea()\r\nLocal aAreaSC6 := SC6->(GetArea())\r\n\r\nSC6->(dbSetOrder(1))\r\nSC6->(MsSeek(xFilial(\"SC6\")+cPedido))\r\n\r\nWhile !(SC6->(Eof())) .And. xFilial(\"SC6\")==SC6->C6_FILIAL .And.;\r\n\t\tSC6->C6_NUM == cPedido\r\n\r\n\tIf !Empty(SC6->C6_PEDCLI) .and. Ascan(aPedidos,SC6->C6_PEDCLI) = 0\r\n\t\tAadd(aPedidos, SC6->C6_PEDCLI )\r\n\tEndif\t\t\r\n\r\n\tSC6->(dbSkip())\r\nEnddo\r\n\r\nRestArea(aAreaSC6)\r\nRestArea(aArea)\r\n\r\nReturn(aPedidos)\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Funcao    ³FisGetInit³ Autor ³Eduardo Riera          ³ Data ³17.11.2005³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Inicializa as variaveis utilizadas no Programa              ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³Nenhum                                                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³Nenhum                                                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao Efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nStatic Function FisGetInit(aFisGet,aFisGetSC5)\r\n\r\nLocal cValid      := \"\"\r\nLocal cReferencia := \"\"\r\nLocal nPosIni     := 0\r\nLocal nLen        := 0\r\n\r\nIf aFisGet == Nil\r\n\taFisGet\t:= {}\r\n\tdbSelectArea(\"SX3\")\r\n\tdbSetOrder(1)\r\n\tMsSeek(\"SC6\")\r\n\tWhile !Eof().And.X3_ARQUIVO==\"SC6\"\r\n\t\tcValid := UPPER(X3_VALID+X3_VLDUSER)\r\n\t\tIf 'MAFISGET(\"'$cValid\r\n\t\t\tnPosIni \t:= AT('MAFISGET(\"',cValid)+10\r\n\t\t\tnLen\t\t:= AT('\")',Substr(cValid,nPosIni,Len(cValid)-nPosIni))-1\r\n\t\t\tcReferencia := Substr(cValid,nPosIni,nLen)\r\n\t\t\taAdd(aFisGet,{cReferencia,X3_CAMPO,MaFisOrdem(cReferencia)})\r\n\t\tEndIf\r\n\t\tIf 'MAFISREF(\"'$cValid\r\n\t\t\tnPosIni\t\t:= AT('MAFISREF(\"',cValid) + 10\r\n\t\t\tcReferencia\t:=Substr(cValid,nPosIni,AT('\",\"MT410\",',cValid)-nPosIni)\r\n\t\t\taAdd(aFisGet,{cReferencia,X3_CAMPO,MaFisOrdem(cReferencia)})\r\n\t\tEndIf\r\n\t\tdbSkip()\r\n\tEndDo\r\n\taSort(aFisGet,,,{|x,y| x[3]<y[3]})\r\nEndIf\r\n\r\nIf aFisGetSC5 == Nil\r\n\taFisGetSC5\t:= {}\r\n\tdbSelectArea(\"SX3\")\r\n\tdbSetOrder(1)\r\n\tMsSeek(\"SC5\")\r\n\tWhile !Eof().And.X3_ARQUIVO==\"SC5\"\r\n\t\tcValid := UPPER(X3_VALID+X3_VLDUSER)\r\n\t\tIf 'MAFISGET(\"'$cValid\r\n\t\t\tnPosIni \t:= AT('MAFISGET(\"',cValid)+10\r\n\t\t\tnLen\t\t:= AT('\")',Substr(cValid,nPosIni,Len(cValid)-nPosIni))-1\r\n\t\t\tcReferencia := Substr(cValid,nPosIni,nLen)\r\n\t\t\taAdd(aFisGetSC5,{cReferencia,X3_CAMPO,MaFisOrdem(cReferencia)})\r\n\t\tEndIf\r\n\t\tIf 'MAFISREF(\"'$cValid\r\n\t\t\tnPosIni\t\t:= AT('MAFISREF(\"',cValid) + 10\r\n\t\t\tcReferencia\t:=Substr(cValid,nPosIni,AT('\",\"MT410\",',cValid)-nPosIni)\r\n\t\t\taAdd(aFisGetSC5,{cReferencia,X3_CAMPO,MaFisOrdem(cReferencia)})\r\n\t\tEndIf\r\n\t\tdbSkip()\r\n\tEndDo\r\n\taSort(aFisGetSC5,,,{|x,y| x[3]<y[3]})\r\nEndIf\r\nMaFisEnd()\r\nReturn(.T.)\r\n\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Funcao    ³TipoFrete ³ Autor ³Vendas e CRM           ³ Data ³23/02/2012³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Texto do tipo de frete                                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³Texto do tipo de frete                                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³Sigla do frete                                              ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao Efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\n\r\nStatic Function TipoFrete(cTipofrete)\r\nLocal cReturn := ''\r\n\r\nDo Case\r\n\tCase cTipofrete = 'C'\r\n\t\tcReturn := '(CIF)'\r\n\tCase cTipofrete = 'F'\r\n\t\tcReturn := '(FOB)'\r\n\tCase cTipofrete = 'T'\r\n\t\tcReturn := '(TER)'\r\n\tCase cTipofrete = 'S'\r\n\t\tcReturn := '(SEM)'\t\t\r\nEnd\r\n\r\nReturn cReturn"}}}
Content-Length: 171
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO/MATR730Q.prw"}}}
Content-Length: 13193
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO/MCLASSIFI.PRW","languageId":"advpl","version":1,"text":"#INCLUDE \"rwmake.ch\"\r\n#INCLUDE \"protheus.ch\"\r\n#INCLUDE \"TOPCONN.CH\"\r\n\r\n/*                                          \r\nPrograma ...: MCLASSIFI.Prw\r\nUso ........: CLASSIFICAÇÃO\r\nData .......: 14/09/19\r\nFeito por ..: Bruno Lage Ferreira.\r\n*/\r\n\r\nUser Function MCLASSIFI()  \r\n/**********************************************************************************************************************************************\r\n*\r\n*\r\n****/      \r\nLocal _astru     :={}\r\nLocal _afields   :={}     \r\nLocal _carq             \r\nPrivate arotina  :={}   \r\nPrivate cCadastro \r\nPrivate cMark    :=GetMark()\r\n\r\naRotina   := { \t{ \"Marcar Todos [F5]\",\"U_MARCARF\" \t\t, 0, 4},;               \r\n\t\t\t\t{ \"Desmarcar Todos\"  ,\"U_DESMARCLA\"  \t, 0, 4},;  \r\n\t\t\t\t{ \"Filtra Dados [F4]\",\"U_MfiltCLASS\"  \t, 0, 3},;\r\n\t\t\t\t{ \"Grava Dados  [F6]\",\"U_MGravCLASS\" \t, 0, 1},;\r\n\t\t\t\t{ \"Inverter Todos   \",\"U_MARKALLCLA\" \t, 0, 4}}   \r\n\r\ncCadastro := \"Alteração de Classificação de Produtos\"\r\n\r\nSetKey(VK_F4,{||u_MfiltCLASS()})\r\nSetKey(VK_F5,{||U_MARCARF()})\r\nSetKey(VK_F6,{||u_MGravCLASS()})\r\n \t\t\t\t\r\n// Estrutura da tabela temporaria\r\nAADD(_astru,{\"OK\"\t\t,\"C\",002,0})\r\nAADD(_astru,{\"CAVALETE\"\t,\"C\",006,0})\r\nAADD(_astru,{\"LOTE\"\t\t,\"C\",010,0})\r\nAADD(_astru,{\"CHAPA\"\t,\"C\",004,0})\r\nAADD(_astru,{\"PRODUTO\"\t,\"C\",015,0})\r\nAADD(_astru,{\"NOME\"\t\t,\"C\",120,0})\r\nAADD(_astru,{\"CLASSIF\"\t,\"C\",020,0})\r\nAADD(_astru,{\"DATAM\"\t,\"D\",008,0})\r\nAADD(_astru,{\"USUARIO\"\t,\"C\",030,0})\r\n\r\n\r\n// cria a tabela temporária\r\n_carq:=\"T_\"+Criatrab(,.F.)\r\nMsCreate(_carq,_astru,\"TOPCONN\") \r\n// atribui a tabela temporária ao alias TRB\r\ndbUseArea(.T.,\"TOPCONN\",_cARq,\"TRB\",.T.,.F.)\r\n\r\nAADD(_afields,{\"OK\"\t\t\t,\"\",\"X\"\t   \t\t})\r\nAADD(_afields,{\"CAVALETE\"\t,\"\",\"CAVALETE\"\t})\r\nAADD(_afields,{\"LOTE\"\t\t,\"\",\"LOTE\"\t\t})\r\nAADD(_afields,{\"CHAPA\"\t\t,\"\",\"CHAPA\"\t\t})\r\nAADD(_afields,{\"PRODUTO\"\t,\"\",\"PRODUTO\"\t})\r\nAADD(_afields,{\"NOME\"\t\t,\"\",\"NOME\"\t\t})\r\nAADD(_afields,{\"CLASSIF\"\t,\"\",\"CLASSIFICAÇÃO\"\t})\r\nAADD(_afields,{\"DATAM\"\t\t,\"\",\"DATA MOVIMENTO\"})\r\nAADD(_afields,{\"USUARIO\"\t,\"\",\"USUARIO\"\t})\r\n\r\n\r\nDBSELECTAREA(\"TRB\")\r\n\r\n//MarkBrow( 'TRB', 'OK',,_afields,, cMark,'u_MarkAll()',,,,'u_MarkCLASS()',{|| u_MarkAll()}) \r\nMarkBrow( 'TRB', 'OK',,_afields,, cMark,'u_MarkAllCLA()',,,,'u_MarkCLASS()',{|| })\r\n\r\nDbCloseArea()      \t\t\t\t\r\n\r\n// fecha a tabela temporária\r\nMsErase(_carq+GetDBExtension(),,\"TOPCONN\")\t\r\n// apaga a tabela temporária\r\n\r\nReturn()\r\n\r\n\r\nUser Function MGravCLASS()\r\n/*********************************************************************************************************************************************\r\n*\r\n*\r\n***/\r\nLocal oMark := GetMarkBrow()\r\nLocal cCLassif := \"\"\r\nLocal cClassId  := \"\"\r\nLocal cQuery:=\"\"\r\n\r\nPrivate aPerg := {}\r\nPrivate cPerg := \"MGRAVCLASS\"\r\n\r\nAadd(aPerg,{cPerg,\"Classificação  ?\",\"N\",01,00,\"C\",\"\",\"\",\"STANDARD\",\"COMMERCIAL\",\"PREMIUM\",\"SAMPLE\",\"\",\"\"})\r\n\r\nU_Testasx1(cPerg,aPerg,.T.)\r\n\r\nIf ! Pergunte(cPerg,.T.)\r\n\tReturn()\r\nEndIf\r\n\r\nIf Empty(mv_par01)\r\n\tAlert(\"Endereço não pode ser em branco!\")\r\n\tReturn()\r\nEndIf\r\n\r\n\r\nIf MsgYesNo(\"Deseja alterar a classificação do produtos ?\" )\r\n\r\n\tDBSELECTAREA(\"TRB\")\r\n\tdbGoTop()\t\r\n\tWhile (!Eof())\r\n\t\r\n\t\t/*\r\n\t\tVerifica se o produto possui saldo \r\n\t\tantes de entrar no update\r\n\t\t*/\r\n\t\tcQuery:=\" SELECT B8_SALDO\r\n\t\tcQuery+=\"   FROM SB8010 SB8 \r\n\t\tcQuery+=\"  WHERE SB8.D_E_L_E_T_ = ''\r\n\t    cQuery+=\"    AND B8_PRODUTO = '\"+TRB->PRODUTO+\"'\r\n\t    cQuery+=\"    AND B8_LOTECTL = '\"+TRB->LOTE   +\"'\r\n\t    cQuery+=\"    AND B8_NUMLOTE = '\"+TRB->CHAPA  +\"'\r\n\t    cQuery+=\"    AND LEFT(B8_PRODUTO,2) IN ('CH','AM') \r\n\t    cQuery+=\"    AND B8_SALDO <> 0\r\n\t    cQuery+=\"    AND B8_ORIGLAN <> 'BD'\r\n\t    \r\n\t    TcQuery cQuery Alias TRB_UPD New\r\n\t    \r\n\t    dbSelectArea(\"TRB_UPD\")\r\n\t    dbGoTop()\r\n\t   \r\n\t\tIF TRB_UPD->B8_SALDO <> 0\r\n\t\t\r\n\t\t\tDBSELECTAREA(\"TRB\")\r\n\t\r\n\t\t\tIf mv_par01 == 1\r\n\t\t\t\tcCLassif := \"STANDARD\"\r\n\t\t\t\tcClassId := \"S\"\r\n\t\t\tElseIf mv_par01 == 2\r\n\t\t\t\tcCLassif := \"COMMERCIAL\"\r\n\t\t\t\tcClassId := \"C\"\r\n\t\t\tElseIf mv_par01 == 3\r\n\t\t\t\tcCLassif := \"PREMIUM\"\r\n\t\t\t\tcClassId := \"P\"\r\n\t\t\tElseIf mv_par01 == 4\r\n\t\t\t\tcCLassif := \"SAMPLE\"\r\n\t\t\t\tcClassId := \"A\"\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf IsMark( 'OK', cMark )\r\n\t\t\t\tDBSELECTAREA(\"TRB\")\t\r\n\t\t\t\tRECLOCK(\"TRB\",.F.) \t\t\t\t\r\n\t\t\t\t\tTRB->CLASSIF \t:= cCLassif\r\n\t\t\t\t\tTRB->DATAM \t\t:= dDataBase\r\n\t\t\t\t\tTRB->USUARIO \t:= SUBSTR(CUSUARIO,7,15)\r\n\t\t\t\tMSUNLOCK()\r\n\t\t\t\t\r\n\t\t\t\tcQuery:=\" UPDATE SB8010\r\n\t\t\t\tcQuery+=\"   SET B8_XDTMOVE ='\"+dToS(dDataBase)+\"',B8_YCLASSI='\"+Alltrim(cClassId)+\"',B8_XPUSUAR='\"+SUBSTR(CUSUARIO,7,15)+\"'\r\n\t\t\t\tcQuery+=\"  \tFROM SB8010 SB8 \r\n\t\t\t\tcQuery+=\" WHERE SB8.D_E_L_E_T_ = ''\r\n\t\t\t\tcQuery+=\"   AND B8_PRODUTO = '\"+TRB->PRODUTO+\"'\r\n\t\t\t\tcQuery+=\"   AND B8_LOTECTL = '\"+TRB->LOTE   +\"'\r\n\t\t\t\tcQuery+=\"   AND B8_NUMLOTE = '\"+TRB->CHAPA  +\"'\r\n\t\t\t\tcQuery+=\"   AND LEFT(B8_PRODUTO,2) IN ('CH','AM') \r\n\t\t\t\tcQuery+=\"   AND B8_SALDO <> 0\r\n\t\t\t\tcQuery+=\"   AND B8_ORIGLAN <> 'BD'\r\n\t\t\t\r\n\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tElse\r\n\t\t\tAlert(\"Este registro já não possui mais saldo! PRODUTO:\" + TRB->PRODUTO + \" LOTE:\" +TRB->LOTE   + \" SUBLOTE:\" + TRB->CHAPA  )\r\n\t\tEndIf\r\n\t\t\r\n\t\t/*\r\n\t\tDestroi a area temporaria de consulta de saldo antes do update\r\n\t\t*/\r\n\t\tdbSelectArea(\"TRB_UPD\")\r\n\t\tDBCloseArea()\r\n\t\t\r\n\t\tDbSelectArea(\"TRB\")\r\n\t\tDBSKIP()\r\n\tEndDo\r\n\r\n MarkBRefresh( )\r\n \r\n // atualiza o browse\r\n oMark:oBrowse:Gotop()\r\n\r\nEndIf\r\n\r\nReturn()\r\n\r\nUser Function MfiltCLASS()\r\n/*********************************************************************************************************************************************\r\n*\r\n*\r\n***/\r\nLocal cQuery := \"\"\r\nLocal aLote    := {}\r\nLocal aChapa   := {}\r\n\r\nPrivate aPerg := {}\r\nPrivate cPerg := \"MALTCLASSI\"\r\n\r\n//Aadd(aPerg,{cPerg,\"Empresa/Filial Destino?\",\"C\",06,00,\"G\",\"\",\"SM0\",\"\",\"\",\"\",\"\",\"\",\"\"})     \r\nAadd(aPerg,{cPerg,\"Lote Qualitá (Separar usando [,])?\"\t,\"C\",99,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})     \r\nAadd(aPerg,{cPerg,\"Chapa (Separar usando [,])?\"\t\t,\"C\",99,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nU_Testasx1(cPerg,aPerg,.F.)\r\n\r\nIf ! Pergunte(cPerg,.T.)\r\n\tReturn()\r\nEndIf\r\n\r\naLote    := strtokarr (AllTrim(mv_par01), \",\")\r\naChapa   := strtokarr (AllTrim(mv_par02), \",\")\r\n\r\ncQuery := \" SELECT\tB8_LOCAL   AS LOCAL,\r\ncQuery += \" \t\tNNR_DESCRI AS LOCAL_DES,\t\t\r\ncQuery += \" \t\tB8_PRODUTO AS PRODUTO,\r\ncQuery += \" \t\tB1_DESC    AS PRODUTO_DESC,\r\ncQuery += \" \t\tCAST(B8_DATA AS DATE) AS FABRIC,\r\ncQuery += \" \t\tRIGHT(RTRIM(LTRIM(B8_PRODUTO)),2) AS TIPO,\r\ncQuery += \" \t\tCASE \r\ncQuery += \" \t\t\tWHEN RTRIM(LTRIM(B8_YCLASSI)) = 'S' THEN 'STANDARD'\r\ncQuery += \" \t\t\tWHEN RTRIM(LTRIM(B8_YCLASSI)) = 'C' THEN 'COMMERCIAL'\r\ncQuery += \" \t\t\tWHEN RTRIM(LTRIM(B8_YCLASSI)) = 'P' THEN 'PREMIUM'\r\ncQuery += \" \t\t\tWHEN RTRIM(LTRIM(B8_YCLASSI)) = ''  THEN 'PREMIUM' \r\ncQuery += \" \t\t\tWHEN RTRIM(LTRIM(B8_YCLASSI)) = 'A' THEN 'SAMPLE'\r\ncQuery += \" \t\t\tEND CLASSIFICACAO, \r\ncQuery += \" \t\tB8_YCAVALE AS CAVALETE,\r\ncQuery += \" \t\tB8_LOTECTL AS LOTE,\r\ncQuery += \" \t\tB8_NUMLOTE AS SUBLOTE, \r\ncQuery += \" \t\tISNULL((SELECT TOP 1 C6_NUM FROM SC6010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = C6_NUMLOTE AND B8_PRODUTO = C6_PRODUTO ),'') AS PEDIDO_VENDA,\r\ncQuery += \" \t\tIIF(ISNULL((SELECT TOP 1 C6_NUM FROM SC6010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = C6_NUMLOTE AND B8_PRODUTO = C6_PRODUTO ),'')<>'',B8_SALDO,0) AS RESERVADO ,\r\ncQuery += \" \t\tB8_SALDO   AS SALDO,\r\ncQuery += \" \t\tB8_XENDERE ENDERECO, \r\ncQuery += \" \t\tB8_XDTMOVE DATAM,\r\ncQuery += \" \t\tB8_XPUSUAR USUARIO\r\ncQuery += \" \tFROM SB8010 SB8 INNER JOIN NNR010 NNR\r\ncQuery += \" \t\tON (NNR_CODIGO = B8_LOCAL)\r\ncQuery += \" \t\tINNER  JOIN SB1010 SB1 \r\ncQuery += \" \t\tON (B1_COD = B8_PRODUTO)\r\ncQuery += \" \tWHERE SB8.D_E_L_E_T_ = ''\r\ncQuery += \" \tAND SB1.D_E_L_E_T_ = ''\r\ncQuery += \" \tAND NNR.D_E_L_E_T_ = ''\r\n\r\nIf Len(aLote)>0\r\n\tFor nX:=1 to Len(aLote)\r\n\t \tIf nX = 1\r\n\t \t\tcQuery += \" AND (B8_LOTECTL LIKE '%\"+AllTrim(aLote[nX])+\"%' \"\r\n\t \tElse\r\n\t \t\tcQuery += \" OR  B8_LOTECTL LIKE '%\"+AllTrim(aLote[nX])+\"%' \"\r\n\t \tEndIf\r\n\tNext nX\r\n\tcQuery += \" )\"\r\nEndIf\r\n\r\nIf Len(aChapa)>0\r\n\tFor nX:=1 to Len(aChapa)\r\n\t \tIf nX = 1\r\n\t \t\tcQuery += \" AND (B8_NUMLOTE LIKE '%\"+AllTrim(aChapa[nX])+\"%' \"\r\n\t \tElse\r\n\t \t\tcQuery += \" OR  B8_NUMLOTE LIKE '%\"+AllTrim(aChapa[nX])+\"%' \"\r\n\t \tEndIf\r\n\tNext nX\r\n\tcQuery += \" )\"\r\nEndIf\r\n\r\ncQuery += \" \tAND LEFT(B8_PRODUTO,2) IN ('CH','AM') \r\ncQuery += \" \tAND B8_SALDO <> 0\r\ncQuery += \"     AND B8_ORIGLAN <> 'BD'\r\ncQuery += \" ORDER BY B8_YCAVALE,B8_LOTECTL,B8_NUMLOTE\r\n\r\n\r\nTcQuery cQuery Alias TRB_ESTOQUE New\r\n\r\ndbSelectArea(\"TRB\")\t\r\nWhile (!Eof())\r\n\r\n\tRECLOCK(\"TRB\",.F.) \r\n\tdbdelete()\r\n\tMSUNLOCK()\r\n\t\r\n\tDbSelectArea(\"TRB\")\r\n\tDBSKIP()\r\nEndDo\r\n\r\ndbSelectArea(\"TRB_ESTOQUE\")\r\ndbGoTop()\r\nWhile (!Eof())\r\n\r\n\tDBSELECTAREA(\"TRB\")\t\r\n\tRECLOCK(\"TRB\",.T.) \t\t\t\t\t\r\n\t\tTRB->CAVALETE\t:= TRB_ESTOQUE->CAVALETE \t\t\r\n\t\tTRB->LOTE\t\t:= TRB_ESTOQUE->LOTE\t\t\r\n\t\tTRB->CHAPA\t\t:= TRB_ESTOQUE->SUBLOTE\r\n\t\tTRB->PRODUTO \t:= TRB_ESTOQUE->PRODUTO\r\n\t\tTRB->NOME\t \t:= TRB_ESTOQUE->PRODUTO_DESC\r\n\t\tTRB->CLASSIF \t:= TRB_ESTOQUE->CLASSIFICACAO\r\n\t\tTRB->DATAM \t\t:= StoD(TRB_ESTOQUE->DATAM)\r\n\t\tTRB->USUARIO \t:= TRB_ESTOQUE->USUARIO\r\n\tMSUNLOCK()    \r\n\r\n\tdbSelectArea(\"TRB_ESTOQUE\")\r\n\tDBSKIP()\r\nEndDo\r\n\r\nDbSelectArea(\"TRB\")\r\nDbGotop()\r\n\r\nDBSELECTAREA(\"TRB_ESTOQUE\")\r\nDBCloseArea()\r\n\r\nU_DesMarCLA()\r\n\r\nReturn()\r\n\r\n\r\nUser Function MarcarF()\r\n/*********************************************************************************************************************************************\r\n* Função para marcar todos os registros do browse\r\n*\r\n***/                            \r\nLocal oMark := GetMarkBrow()\r\nDbSelectArea(\"TRB\")\r\nDbGotop()\r\n\r\nWhile !Eof()\t\r\n\tIF RecLock( 'TRB', .F. )\t\t\r\n\t\tTRB->OK := cMark\t\t\r\n\t\tMsUnLock()\t\r\n\tEndIf\t\r\n\tDbSelectArea(\"TRB\")\r\n\tdbSkip()\r\nEnddo\r\n\r\n// atualiza o browse\r\nMarkBRefresh() \r\n\r\n// força o posicionamento do browse no primeiro registro\r\noMark:oBrowse:Gotop()\t\r\n \r\nReturn()\r\n\r\n\r\n \r\nUser Function DesMarCLA()\r\n/*********************************************************************************************************************************************\r\n* Função para marcar todos os registros do browse\r\n*\r\n***/  \r\nLocal oMark := GetMarkBrow()\r\ndbSelectArea(\"TRB\")\r\ndbGotop()\r\n\r\nWhile !Eof()\t\r\n \tIF RecLock( 'TRB', .F. )\t\t\r\n \t\tTRB->OK := SPACE(2)\t\t\r\n \t\tMsUnLock()\t\r\n \tEndIf\t\r\n \tdbSelectArea(\"TRB\")\r\n \tdbSkip()\r\nEnddo\r\n \r\n MarkBRefresh()\t\t\r\n \r\n // atualiza o browse\r\n oMark:oBrowse:Gotop()\t\r\n // força o posicionamento do browse no primeiro registro\r\nReturn\r\n \r\n \r\nUser Function MarkCLASS()\r\n/*********************************************************************************************************************************************\r\n* Função para grava marca no campo se não estiver marcado ou limpar a marca se estiver marcado\r\n*\r\n***/  \r\n If IsMark( 'OK', cMark )\t\r\n\t RecLock( 'TRB', .F. )\t\r\n\t Replace TRB->OK With Space(2)\t\r\n\t MsUnLock()\r\n Else\t\r\n\t RecLock( 'TRB', .F. )\t\r\n\t Replace TRB->OK With cMark\t\r\n\t MsUnLock()\r\n EndIf\r\n \r\nReturn \r\n \r\n \r\nUser Function MarkAllCLA()   \r\n/*********************************************************************************************************************************************\r\n* Função para gravar\\limpar marca em todos os registros\r\n*\r\n***/  \r\n Local oMark := GetMarkBrow()\r\n dbSelectArea('TRB')\r\n dbGotop()\r\n\r\n While !Eof()\t\r\n\t u_MarkCLASS()\r\n\t dbSelectArea('TRB')\t\r\n\t dbSkip()\r\n End\r\n \r\n MarkBRefresh( )\r\n \r\n // atualiza o browse\r\n oMark:oBrowse:Gotop()\t\r\n // força o posicionamento do browse no primeiro registro\r\n \r\nReturn()"}}}
Content-Length: 172
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO/MCLASSIFI.PRW"}}}
Content-Length: 581327
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO/nfesefaz.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"PROTHEUS.CH\"   \r\n#INCLUDE \"COLORS.CH\"\r\n#INCLUDE \"TBICONN.CH\"\r\n\r\n/*\r\n****************************************************************\r\nDATA DO ARQUIVO: Quarta-feira, 18/06/2020, \r\nDATA DA IMPLEMENTAÇÃO: 16/09/2020\r\n****************************************************************\r\n*/\r\n/*/\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Programa  ³XmlNFeSef ³ Autor ³ Eduardo Riera         ³ Data ³13.02.2007³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³Rdmake de- exemplo para geracao da Nota Fiscal Eletronica do ³±±\r\n±±³          ³SEFAZ - Versao T01.00 / 2.00                                ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Retorno   ³String da Nota Fiscal Eletronica                            ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Parametros³ExpC1: Tipo da NF                                           ³±±\r\n±±³          ³       [0] Entrada                                          ³±±\r\n±±³          ³       [1] Saida                                            ³±±\r\n±±³          ³ExpC2: Serie da NF                                          ³±±\r\n±±³          ³ExpC3: Numero da nota fiscal                                ³±±\r\n±±³          ³ExpC4: Codigo do cliente ou fornecedor                      ³±±\r\n±±³          ³ExpC5: Loja do cliente ou fornecedor                        ³±± \r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³   DATA   ³ Programador   ³Manutencao efetuada                         ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³          ³               ³                                            ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n/*/\r\nUser Function XmlNfeSef(cTipo,cSerie,cNota,cClieFor,cLoja,cNotaOri,cSerieOri)\r\n\r\n//Declaração de Arrays\r\nLocal aNota     \t:= {}\r\nLocal aDupl     \t:= {}\r\nLocal aDest     \t:= {}\r\nLocal aEntrega  \t:= {}\r\nLocal aProd     \t:= {}\r\nLocal aICMS     \t:= {}\r\nLocal aICMSST   \t:= {}\r\nLocal aICMSZFM\t\t:= {}\r\nLocal aIPI      \t:= {}\r\nLocal aPIS      \t:= {}                         \r\nLocal aCOFINS   \t:= {}\r\nLocal aPISST    \t:= {}\r\nLocal aCOFINSST \t:= {}\r\nLocal aISSQN   \t\t:= {}\r\nLocal aISS      \t:= {}\r\nLocal aCST      \t:= {}\r\nLocal aRetido   \t:= {}\r\nLocal aTransp   \t:= {}\r\nLocal aImp      \t:= {}\r\nLocal aVeiculo  \t:= {}\r\nLocal aDetPag\t\t:= {}  \r\nLocal aReboque  \t:= {}\r\nLocal aReboqu2  \t:= {}\r\nLocal aEspVol   \t:= {}\r\nLocal aNfVinc   \t:= {}\r\nLocal aPedido   \t:= {}\r\nLocal aOldReg   \t:= {}\r\nLocal aOldReg2  \t:= {}\r\nLocal aMed\t\t\t:= {}\r\nLocal aArma\t\t\t:= {}\r\nLocal aComb\t\t\t:= {}\r\nLocal aveicProd\t\t:= {}\r\nLocal aLote\t\t\t:= {}\r\nLocal aIEST\t\t\t:= {}\r\nLocal aDI\t\t\t:= {}\r\nLocal aAdi\t\t\t:= {}\r\nLocal aExp\t\t\t:= {}\r\nLocal aDados\t\t:= {}\r\nLocal aPisAlqZ\t\t:= {}\r\nLocal aCofAlqZ\t\t:= {}\r\nLocal aCsosn\t\t:= {}\r\nLocal aIPIDev\t\t:= {}\r\nLocal aIPIAux\t\t:= {}\r\nLocal aNotaServ \t:= {}\r\nLocal aAnfC\t   \t\t:= {}\r\nLocal aAnfI\t   \t\t:= {} \r\nLocal aPedCom   \t:= {} \r\nLocal aInfoItem\t\t:= {}\r\nLocal aNfVincRur\t:= {}\r\nLocal aRefECF\t\t:= {}\r\nLocal aAreaSD2  \t:= {}    \t\t\t// Area do SD2\r\nLocal aAreaSF2  \t:= {}    \t\t\t// Area do SF2\r\nLocal cNfeArea\t\t:= {}\r\nLocal aRetServ \t\t:= {}\r\nLocal aRetirada\t\t:= {}\r\nLocal aMotivoCont \t:= {}\r\nLocal aTotal    \t:= {0,0,0}\r\nLocal aFCI\t\t\t:= {}\r\nLocal aDocDat\t\t:= {}\r\nLocal aICMUFDest\t:= {}\r\nLocal aIPIDevol\t\t:= {}\r\nLocal aSb1\t\t\t:= {}\r\nLocal aAgrPis\t\t:= {}\t\t\t\t\t\t\t\t\t// Verifica se a TES utiliza agrega Pis para incluir o valor na Tag vOutros\r\nLocal aAgrCofins\t:= {}\t\t\t\t\t\t\t\t\t// Verifica se a TES utiliza agrega Cofins para incluir o valor na Tag vOutros\r\nLocal aItemCupRef\t:= {}\t\t\t\t\t\t\t\t\t// Array para itens dos cupons vinculados na nota sobre cupom\r\nLocal aCupRefLoj\t:= {}\t\t\t\t\t\t\t\t\t// Array para buscar cupons relacionados na nota sobre cupom(quando e utilizado a rotina de multiplos cupons na nota sobre cupom)\r\nLocal aItemVinc\t\t:= {}\t\t\t\t\t\t\t\t\t// Array para as notas vinculadas por item\r\nLocal cAmbiente\t\t:= {}\r\nLocal cVerAmb\t\t:= {}\r\nLocal aMensAux\t\t:= {}\r\nLocal aTelEmit\t\t:= {}\r\nLocal aCMPUSR\t\t:= {}\r\nLocal aFat\t\t\t:= {}\r\nLocal aValTotOpe\t:= {}\r\n\r\n//Declaração de Strings\r\nLocal cString    \t:= \"\"\r\nLocal cNatOper   \t:= \"\"\r\nLocal cModFrete  \t:= \"\"\r\nLocal cScan      \t:= \"\"\r\nLocal cEspecie   \t:= \"\"\r\nLocal cMensCli   \t:= \"\"\r\nLocal cMensONU\t\t:= \"\"\r\nLocal cMensFis   \t:= \"\"\r\nLocal cNFe       \t:= \"\"\r\nLocal cMVSUBTRIB \t:= \"\"\r\nLocal cLJTPNFE\t\t:= \"\"\r\nLocal cWhere\t\t:= \"\"\r\nLocal cMunISS\t\t:= \"\"\r\nLocal cCodIss\t\t:= \"\"\r\nLocal cValIPI    \t:= \"\"\r\nLocal cNCM\t     \t:= \"\" \r\nLocal cField\t\t:= \"\"\r\nLocal cRetISS   \t:= \"\"\r\nLocal cTipoNF   \t:= \"\"\r\nLocal cDocEnt  \t\t:= \"\"\r\nLocal cSerEnt  \t\t:= \"\"\r\nLocal cFornece  \t:= \"\"\r\nLocal cLojaEnt  \t:= \"\"\r\nLocal cTipoNFEnt\t:= \"\"\r\nLocal cPedido   \t:= \"\"\r\nLocal cItemPC   \t:= \"\"\r\nLocal cNFOri    \t:= \"\"\r\nLocal cSerOri   \t:= \"\"\r\nLocal cItemOri  \t:= \"\"\r\nLocal cProd     \t:= \"\"\r\nLocal cLote         := \"\"\r\nLocal cTribMun  \t:= \"\"\r\nLocal cModXML   \t:= \"\"\r\nLocal cItem\t\t\t:= \"\"\r\nLocal cAnfavea\t\t:= \"\"\r\nLocal cSerNfCup \t:= \"\"\t// Serie da NF sobre Cupom\r\nLocal cNumNfCup \t:= \"\"\t// Numero do Documento da NF sobre Cupom\r\nLocal cD2Cfop  \t\t:= \"\"  // CFOP da nota \r\nLocal cD2Tes  \t\t:= \"\"\t// TES do SD2\r\nLocal cSitTrib\t\t:= \"\"\r\nLocal cValST  \t\t:= \"\"\r\nLocal cBsST    \t\t:= \"\"\r\nLocal cChave \t\t:= \"\"\r\nLocal cItemOr\t\t:= \"\"\r\nLocal cCST      \t:= \"\"\r\nLocal cInfAdic\t\t:= \"\"\r\nLocal cUmDipi       := \"\"\r\nLocal nConvDip      := 0\r\nLocal cServ     \t:= \"\"\r\nLocal cMunPres  \t:= \"\"\r\nLocal cAliasSE1  \t:= \"SE1\"\r\nLocal cAliasSE2  \t:= \"SE2\"\r\nLocal cAliasSD1  \t:= \"SD1\"\r\nLocal cAliasSD2  \t:= \"SD2\" \r\nlocal cAliasSB5   \t:=\"SB5\"\r\nLocal cAnttRntrc\t:= iif(!Empty(SM0->M0_RNTRC),AllTrim(SM0->M0_RNTRC), AllTrim(SuperGetMV(\"MV_TMSANTT\",,\"\")))  //Parametro do TMS que informa o codigo ANTT do transpotador\r\nLocal cMVNFEMSA1\t:= AllTrim(GetNewPar(\"MV_NFEMSA1\",\"\"))\r\nLocal cMVNFEMSF4\t:= AllTrim(GetNewPar(\"MV_NFEMSF4\",\"\"))\r\nLocal cMVCFOPREM\t:= AllTrim(GetNewPar(\"MV_CFOPREM\",\"\"))     // Parâmetro que informa as CFOPs de Remessa para entrega Futura que terão tratamento para que o valor de IPI seja considerado como Outras Despesas Acessórias (tag vOutros).\r\n//Local cConjug   \t:= AllTrim(SuperGetMv(\"MV_NFECONJ\",,\"\"))\r\nLocal cMV_LJTPNFE\t:= SuperGetMV(\"MV_LJTPNFE\", ,\" \")\r\nLocal cValLiqB\t\t:= SuperGetMv(\"MV_BR10925\", ,\"2\")\r\nLocal cDescServ \t:= SuperGetMV(\"MV_NFESERV\", ,\"2\")\r\nlocal cMVREFNFE\t\t:= SuperGetMV(\"MV_REFNFE\", ,\" \") \t\t\t// Parametro para informe quais CFOPs são de simples Remessa para levar informação \r\nLocal cMVCfopTran\t:= SuperGetMV(\"MV_CFOPTRA\", ,\" \")   \t\t// Parametro que define as CFOP´s pra transferência de Crédito/Débito\r\nLocal cCliLoja\t\t:= \"\" \r\nLocal cCliNota\t\t:= \"\"\r\nLocal cInfAdPr\t\t:= SuperGetMV(\"MV_INFADPR\", .F.,\"2\")      // Parametro que define de onde sera impressa as informacoes adicionais do produto\r\nLocal cInfAdPed  \t:= \"\"\r\nLocal cCodProd\t\t:= \"\" \r\nLocal cDescProd\t\t:= \"\"\r\nLocal cMsSeek\t\t:= \"\"\r\nLocal cTpPessoa\t\t:= \"\"\r\nLocal cSeekD1\t\t:= \"\"  \r\nLocal cSeekAux\t\t:= \"\" \r\nLocal cIpiCst\t\t:= \"\"\r\nLocal cNfRefcup\t\t:= \"\"\r\nLocal cSerRefcup\t:= \"\"\r\nLocal cOrigem\t\t:= \"\"\r\nLocal cCSTrib\t\t:= \"\"\r\nLocal cMsgFci\t\t:= \"\"\r\nLocal cChaveD2\t\t:= \"\"\r\nLocal cChaveF2\t\t:= \"\"\r\nLocal cTpOper\t\t:= \"\" //Tipo de operação complemento\r\nLocal cChaveD1\t\t:= \"\" \r\nLocal cMVAEHC \t\t:= AllTrim(GetNewPar(\"MV_AEHC\",\"\"))     // Informar o código de classificação AEHC\r\nLocal cHoraNota\t\t:= \"\"\r\nLocal cIndPres\t\t:= \"\"\r\nLocal cIndIss\t\t:= \"\"\r\nLocal cFilDev\t\t:= \"\"\t\t//Guarda filial de devolução\r\nLocal cTpGar\t\t:= SuperGetMV(\"MV_LJTPGAR\",,\"GE\")\r\nLocal cFieldMsg\t\t:= \"\"\r\nLocal cSpecie\t\t:= \"\"\r\nLocal cChCupom\t\t:= \"\"\r\nLocal cDevMerc\t\t:= \"\" //Identifica devolução de mercadoria que não foi entregue ao destinatário em atendimento ao Artigo 453, I, do RICMS/2000 SP)\r\nLocal cEndEmit\t\t:= \"\"\r\nLocal cFoneEmit\t\t:= \"\"\r\nLocal cCodlan\t\t:= \"\"\r\nLocal cMunTransp\t:= \"\"\r\nLocal cMunDest \t\t:= \"\"\r\nLocal cIndEscala\t:= \"\"\r\nLocal cMensDifal\t:= \"\"\r\nlocal cEstado       := \"\"\r\nlocal cICMSZFM      := \"\"\r\nLocal cMensCpl\t\t:= \"\"\r\n//Declaração de numéricos\r\nLocal nA\t\t\t:= 0\r\nLocal nX         \t:= 0\r\nLocal nCon       \t:= 1  \r\nLocal nCstIpi \t\t:= 1\r\nLocal nLenaIpi\t\t:= 0\r\nLocal nPosI\t\t\t:= 0\r\nLocal nPosF\t\t\t:= 0\r\nLocal nBaseIrrf  \t:= 0\r\nLocal nValIrrf   \t:= 0\r\nLocal nValIPI    \t:= 0\r\nLocal nValAux    \t:= 0\r\nLocal nValPisZF  \t:= 0\r\nLocal nValCofZF  \t:= 0\r\nLocal nPisRet   \t:= 0\r\nLocal nCofRet   \t:= 0\r\nLocal nInssRet  \t:= 0\r\nLocal nIrRet    \t:= 0\r\nLocal nCsllRet  \t:= 0\r\nLocal nDedu     \t:= 0\r\nLocal nIssRet   \t:= 0\r\nLocal nTotRet   \t:= 0\r\nLocal nRedBC    \t:= 0\r\nLocal nValST    \t:= 0\r\nLocal nValSTAux \t:= 0\r\nLocal nBsCalcST \t:= 0\r\nLocal nMargem\t\t:= 0\r\nLocal nDesconto \t:= 0   \t\t\t// Desconto no total da NF sobre cupom\r\nLocal nDescRed  \t:= 0   \t\t\t// Valores dos descontos dos itens referente ao Decreto nº 43.080/2002 RICMS-MG (SFT)\r\nLocal nDesTotal  \t:= 0   \t\t\t// Valor total dos descontos referente ao Decreto nº 43.080/2002 RICMS-MG\r\nLocal nDescIcm  \t:= 0   \t\t\t// Valor do desconto do ICMS-Quando TES configurada com AGREGA Valor = D\r\nLocal nDescZF\t  \t:= 0   \t\t\t// Valores dos descontos Zona Franca\r\nLocal nDescNfDup\t:= 0   \t\t\t// Valores dos descontos para deduzir os valores de ICMS diferido na NF e da Duplicata (opção: 6 – Diferido(Deduz NF e Duplicata)\t\r\nLocal nPercLeite\t:= 0\t  \t\t\t//Percentual da redução do Leite\t\r\nLocal nValLeite\t\t:= 0   \t\t\t//Valor da reduçao do Leite\r\nLocal nPrTotal\t\t:= 0   \r\nLocal nCont\t \t\t:= 0\r\nLocal nValBse\t\t:= 0\r\nLocal nValIss\t\t:= 0\r\nLocal nIcmsST\t\t:= 0\r\nLocal cNumitem\t\t:= 0\r\nLocal nOrderSF1\t\t:= 0\r\nLocal nRecnoSF1\t\t:= 0  \r\n//Local nValParImp\t\t:= 0\r\n//Local nContImp\t\t:= 0\r\nLocal nSF3Index\t\t:= 0\r\nLocal nSF3Recno\t\t:= 0\r\nlocal nValIPIDestac\t:= 0\r\nLocal nValIcmDev\t:= 0\r\nLocal nValIcmDif\t:= 0\r\nLocal nIPIConsig\t:= 0\r\nLocal nSTConsig\t\t:= 0\r\nLocal nValICMParc\t:= 0\r\nLocal nBasICMParc\t:= 0\r\nLocal nValSTParc \t:= 0\r\nLocal nBasSTParc \t:= 0\r\nLocal nVicmsDeson\t:= 0\r\nLocal nToTvBC\t\t:= 0\t\r\nLOcal nToTvICMS\t\t:= 0\r\nLocal nDeducao\t\t:= 0\r\nLocal nVIcmDif\t\t:= 0\r\nLocal nIcmsDif \t\t:= 0\r\nLocal nValISSRet\t:= 0\r\nLocal nValSimprem\t:= 0\r\nLocal nvFCPUFDest\t:= 0\r\nLocal nvICMSUFDest\t:= 0\r\nLocal nvICMSUFRemet\t:= 0\r\nLocal nvBCUFDest  \t:= 0 \r\nLocal npFCPUFDest \t:= 0 \r\nLocal npICMSUFDest\t:= 0 \r\nLocal npICMSInter \t:= 0 \r\nLocal npICMSIntP  \t:= 0 \r\nLocal nValTFecp\t    := 0\r\nLocal nValIFecp\t    := 0   \r\nLocal nTDescIt\t\t:= 0\r\nLocal nCount\t\t:= 0\r\nLocal nSD1Pos\t\t:= 0\r\nLocal nCountNF\t\t:= 0\r\nLocal nValIpiBene\t:= 0\r\nLocal nValtrib\t\t:= 0\r\nLocal nCountIT\t\t:= 0\r\nLocal nDesVrIcms\t:= 0\r\nLocal nValDifer\t\t:= 0\r\n//Declaração de Lógicos\r\nLocal lQuery    \t:= .F.\r\nLocal lCalSol\t\t:= .F.\r\nLocal lOk\t\t\t:= .T.\r\nLocal lBrinde\t\t:= .F.\t\t\t\t\t\t\t// Flag que define se é uma operação de Brinde\r\nLocal lContinua\t\t:= .T.\r\nLocal lCabAnf\t\t:= .T.\r\nLocal lConsig   \t:= .F.\t\t\t\t\t\t\t\t// Flag que diz se a operação é de consignação mercantil\r\nLocal lNfCup\t\t:= .F.\t\t\t\t\t\t\t\t// Define se eh Nf sobre cupom\r\nLocal lNFPTER\t\t:= GetNewPar(\"MV_NFPTER\",.T.)\t\t\t\t\t\r\nLocal lComplDev\t\t:= .F.\t\t   \t  \t\t\t\t\t         //Utilizado para identificar quando for uma nota de complemento de IPI de uma devulução.\r\n\r\nLocal lIpiOutr      := .F.\r\n\r\nLocal lIpiDev   \t:= GetNewPar(\"MV_IPIDEV\",.F.)   \t        //Apenas para devolução de compra de IPI (nota de saída). T-Séra gerado na tag vIPI e destacado no campo//VALOR IPI do cabeçalho do danfe. F-Será gerado na tag vIPIDevol e destacado nas informações complementares do danfe.\r\nLocal lIPIOutro \t:= GetNewPar(\"MV_IPIOUT\",.F.) .And. lIpiDev //Quando habilitado juntamente com o MV_IPIDEV, o valor do IPI será gerado na tag vOutro, destacado nas informações complementares e no campo OUTRAS DESPESAS ACESSORIAS.\r\n\r\nLocal lEipiDev   \t:= GetNewPar(\"MV_EIPIDEV\",.F.)\r\nLocal lEIPIOutro \t:= GetNewPar(\"MV_EIPIOUT\",.F.) .And. lEipiDev //Quando habilitado juntamente com o MV_EIPIDEV, o valor do IPI será gerado na tag vOutro, destacado nas informações complementares e no campo OUTRAS DESPESAS ACESSORIAS.\r\n\r\nLocal lIpiBenef\t\t:= GetNewPar(\"MV_IPIBENE\",.F.) \t\t\t\t   //Nota de saída de retorno com tipo = Beneficiamento. .T.- Será gerado na tag vOutro e destacado nas informações//complementares do danfe e no campo OUTRAS DESPESAS ACESSORIAS. .F. - Séra gerado na tag vIPI e destacado no campo//VALOR IPI do cabeçalho do danfe (procedimento padrão)\r\nLocal lIPIOutB \t    := GetNewPar(\"MV_IPIOUTB\",.F.) .And. lIpiBenef //Quando habilitado juntamente com o MV_IPIBENE, o valor do IPI será gerado na tag vOutro, destacado nas informações complementares e no campo OUTRAS DESPESAS ACESSORIAS.\r\n\r\nLocal lIcmSTDev \t:= GetNewPar(\"MV_ICSTDEV\",.T.)  //Indica se sera gravado no XML o valor e base de ICMS ST para nf de devolucao.(Padrao T - leva)\r\nLocal lIcmDevol\t\t:= GetNewPar(\"MV_ICMDEVO\",.T.)\t//Define se sera gravado no XML o valor e base de ICMS para nf de devolucao. (Padrao T - leva)\r\nLocal lIcmsPR\t\t:= .F.\t\t\t\t\t\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017)\r\nlocal lIcmSTDevOri\t:= lIcmSTDev\t\t\t\t\t// Arnazena o valor original pois é alterado para legislação ICMS/PR 2017\r\nlocal lIcmDevolOri\t:= lIcmDevol\t  \t\t\t\t// Arnazena o valor original pois é alterado para legislação ICMS/PR 2017\r\nLocal lNatOper   \t:= GetNewPar(\"MV_SPEDNAT\",.F.)\r\nLocal lInfAdZF   \t:= GetNewPar(\"MV_INFADZF\",.F.)\r\nLocal lEndFis \t\t:= GetNewPar(\"MV_SPEDEND\",.F.)\r\nLocal lEECFAT\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lMVCOMPET\t\t:= SuperGetMV(\"MV_COMBPET\", ,.F.)\r\nLocal lEasy\t\t\t:= SuperGetMV(\"MV_EASY\") == \"S\"\r\nLocal lSimpNac   \t:= SuperGetMV(\"MV_CODREG\")== \"1\" .or. SuperGetMV(\"MV_CODREG\")== \"2\"\r\nLocal lCD2PARTIC\t:= CD2->(FieldPos(\"CD2_PARTIC\")) > 0\r\nLocal lC6_CODINF\t:= SC6->(FieldPos(\"C6_CODINF\")) > 0 \r\nLocal lCpoAlqSB1 \t:= SB1->(FieldPos(\"B1_IMPNCM\")) > 0        \t// Verifica a existencia do campo de Aliq. de Imposto NCM/NBS\r\nLocal lCpoAlqSBZ\t:= SBZ->(FieldPos(\"BZ_IMPNCM\")) > 0     \t   \t// Verifica a existencia do campo de Aliq. de Imposto NCM/NBS na tabela SBZ\r\nLocal lCpoMsgLT\t\t:= SF4->(FieldPos(\"F4_MSGLT\")) > 0 \r\nLocal lCpoCusEnt\t:= SF4->(FieldPos(\"F4_CUSENTR\")) > 0 \t\t\t//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças\r\nLocal lCpoLoteFor\t:= SB8->(FieldPos(\"B8_LOTEFOR\")) > 0  \r\nLocal lValFecp\t\t:= SF3->(FieldPos(\"F3_VALFECP\")) >0 \r\nLocal lVfecpst\t\t:= SF3->(FieldPos(\"F3_VFECPST\")) >0 \r\nLocal lSb1CT\t\t:= SB1->(FieldPos(\"B1_X_CT\")) >0 \r\nLocal lHistTab\t    := existFunc(\"NotaVinc\") .And. SuperGetMv(\"MV_HISTTAB\",.F.,.F.) .And. AliasIndic('AIF') \r\n\r\n\r\nLocal lMvImpFecp\t:= GetNewPar(\"MV_IMPFECP\",.F.)\t                // Imprime FECP\r\nLocal lOrgaoPub\t\t:= GetNewPar(\"MV_NFORGPU\",.F.)\t\t\t\t//NF-e de remessa nas operações de aquisição de órgão público, com entrega em outro órgão público (RICMS SP)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//AJUSTE SINIEF 13, DE 26 DE JULHO DE 2013 \r\n\r\nLocal lUsaCliEnt\t:= GetNewPar(\"MV_NFEDEST\",.F.) \t\t\t\t//Quando habilitado considera o Cliente, Cli. Entrega e Cli. Retirada utilizados, para compor\r\n \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t//respectivamente as tags \"dest\", \"entrega\" e \"retirada\" no XML\r\nLocal lVinc \t\t:= .F.\t// Se existe nota vinculada\r\nlocal lGrupCob\t\t:= SuperGetMV(\"MV_GRUPCOB\",.F.,.T.) \r\nLocal LRespTec  \t:= iif(findFunction(\"getRespTec\"),getRespTec(\"1\"),.T.) //0-Todos, 1-NFe, 2-MDFe\r\nLocal lNfCupZero\t:= .F.\r\nLocal lRural\t\t:= .F.\r\nLocal lSeekOk   \t:= .F.\r\nLocal lDifParc\t\t:= .F.\r\nLocal lNfCompl\t\t:= .F.\r\nLocal lFCI\t\t\t:= GetNewPar(\"MV_FCIDANF\",.F.) // Imprime ou não os dados da FCI no Xml/Danfe (De acordo com as configurações necessárias)\r\nLocal lGE\t\t\t:= FindFunction(\"LjUP104OK\") .AND. LjUP104OK() .AND. SuperGetMV(\"MV_LJIMPGF\",,.F.)\t// Indica se usa garantia\r\nLocal lLjDescIt\t\t:= .F.\t// Inicializa as variaveis que serao utilizadas para desconto \r\nLocal lFirstItem \t:= .T.\r\nLocal lF1Motivo\t\t:= SF1->(FieldPos(\"F1_MOTIVO\")) > 0\r\nLocal lNfCupNFCE\t:= .F.\r\nLocal lNfCupSAT\t\t:= .F.\r\nLocal lChave     \t:= .F.\r\nLocal lCNPJIgual\t:= .F.\r\nLocal lEIC0064\t\t:= GetNewPar(\"MV_EIC0064\",.F.)\r\nLocal lVeicNovo     := .F.\r\nLocal cD2TesNF\t\t:= \"\" // TES da NF Sobre Cupom (SD2)\r\nLocal cForma\t\t:= \"\"\r\nlocal cChvPag\t\t:= \"\"      \r\nLocal aSX560      \t:= {}\r\nLocal aSX513      \t:= {}\r\nLocal cFiltro\t\t:= \"\"\r\n//Parametro Logico - Define se sera impresso a 2a. Unidade de Medida para operacoes dentro do País - Opcoes: [.T.]-Não Imprime ou [.F.]-Imprime (Default)\r\nLocal lNoImp2UM\t\t:= GetNewPar(\"MV_NIMP2UM\",.F.)\r\n\r\n//Relacao de CFOP's vinculadas a exportacao - NT 2016.001\r\nLocal cCFOPExp \t\t:= \"1501-2501-5501-5502-5504-5505-6501-6502-6504-6505\"\r\n\r\nLocal lPe01Nfe\t\t:= ExistBlock(\"PE01NFESEFAZ\")\r\nLocal lIntegHtl \t:= SuperGetMv(\"MV_INTHTL\",, .F.) //Integracao via Mensagem Unica - Hotelaria\r\n//Alimentação da tag retTransp\r\nLocal nBCTot \t\t:= 0\r\nLocal nALIQTot\t\t:= 0\r\nLocal nVLTRIBTot\t:= 0\r\nLocal aObsCont\t\t:= {}\r\n\r\n//Alimentação do Grupo de Repasse\r\nLocal nBRICMSO \t\t:= 0\r\nLocal nICMRETO\t\t:= 0\r\nLocal nBRICMSD \t\t:= 0\r\nLocal nICMRETD\t\t:= 0\r\nLocal nAliqST\t\t:= 0\r\nLocal nCrdPres\t\t:= 0\r\nLocal nTotCrdP      := 0\r\n\r\nLocal aRetPgLoj \t:= {}\r\nLocal aProcRef\t\t:= {}\r\nLocal lVLojaDir \t:= .F. //Venda Direta ou Loja ou Nota Sobre Cupom\r\nLocal cIndPag\t\t:= \"\"\r\nLocal nValOutr\t\t:= 0\r\nLocal cTpOrig \t\t:= \"\"\r\nLocal lDescIss\t\t:= SuperGetMV(\"MV_DESCISS\",,.F.) //Informa ao sistema se o ISS devera ser descontado do valor do titulo financeiro caso o cliente for responsável pelo recolhimento.\r\nLocal lTpabiss\t\t:= SuperGetMV(\"MV_TPABISS\",,\"2\") == \"1\"//Se parâmetro igual a 1 indica se será efetuado um desconto na duplicata quando o cliente recolhe ISS se igual a 2 será gerado um titulo de abatimento.\r\nLocal lRuleDescISS  := lDescIss .And. lTpabiss\r\nLocal cSeekCDA\t\t:= \"\"\r\nlocal lCodLan\t\t:= .F.\r\nLocal nDescFis\t\t:= 0\r\nLocal cTpEspcBen\t:= \"\"\r\nlocal cStringUTF\t:= \"\"\r\nLocal lNCMOk\t\t:= .F.\r\n\r\nLocal aTotICMSST\t:= {}\r\n\r\nLocal aOrdSED\t\t:= {}\r\nLocal cNatFin\t\t:= \"\"\r\nLocal cED_DEDINSS\t:= \"\"\r\nLocal cED_RECFUN\t:= \"\"\r\nLocal cFilTit \t\t:= \"\"\r\nLocal cPrfTit \t\t:= \"\"\r\nLocal cNumTit \t\t:= \"\"\r\nLocal cNumDupl\t\t:= \"\"\r\nLocal cChaveSE1 \t:= \"\"\r\n\r\nlocal cRetForm\t\t:= \"\"\r\n\r\nlocal nPosCpoEsp\t:= 0\r\nlocal nPosCpoVol\t:= 0\r\nlocal nVolume\t\t:= 0\r\nlocal cMRCVLMSF1\t:= alltrim(SuperGetMV(\"MV_MRCVLM1\",,\"\"))\r\nlocal cMRCVLMSF2\t:= alltrim(SuperGetMV(\"MV_MRCVLM2\",,\"\"))\r\nlocal aCpoMarVol\t:= {}\r\nlocal cCpoMarca\t\t:= \"\"\r\nlocal cCpoNumer\t\t:= \"\"\r\nlocal nPosCpoMrc\t:= 0\r\nlocal nPosCpoNum\t:= 0\r\nlocal cMarca\t\t:= \"\"\r\nlocal cNumeracao\t:= \"\"\r\n\r\n//Declaração de Arrays\r\nPrivate aUF     \t:= {}\r\nPrivate aCSTIPI \t:= {}\r\n \r\n//Declaração de Strings\r\nPrivate cFntCtrb\t:= \"\"\r\nPrivate cMvMsgTrib\t:= SuperGetMV(\"MV_MSGTRIB\",,\"1\")\r\nPrivate cMvFntCtrb\t:= SuperGetMV(\"MV_FNTCTRB\",,\" \")\r\nPrivate cMvFisCTrb\t:= SuperGetMV(\"MV_FISCTRB\",,\"1\")\r\nPrivate cAutXml\t\t:= SuperGetMV(\"MV_AUTXML\",,\"\")\r\nPrivate cMVEstado\t:= SuperGetMV(\"MV_ESTADO\", ,\" \")\r\nPrivate cTpCliente\t:= \"\"\r\nPrivate cIdRecopi\t:= \"\"\r\nPrivate cNumRecopi\t:= \"\"\r\nPrivate cIdDest\t\t:= \"\"\r\nPrivate cIndFinal\t:= \"\"\r\nPrivate cIndIEDest \t:= \"\"\r\nPrivate cTPNota\t    := \"\"\t\r\n//Declaração de numéricos\r\nPrivate nTotNota\t:= 0\r\nPrivate nTotalCrg\t:= 0\r\nPrivate nTotFedCrg\t:= 0\t// Ente Tributante Federal\r\nPrivate nTotEstCrg\t:= 0\t// Ente Tributante Estadual\r\nPrivate nTotMunCrg\t:= 0\t// Ente Tributante Municipal\r\n\r\n//Declaração de Lógicos\r\nPrivate lMvEnteTrb\t:= SuperGetMV(\"MV_ENTETRB\",,.F.)\t// Valor dos tributos por Ente Tributante: Federal, Estadual e Municipal\r\nPrivate lMvNFLeiZF\t:= SuperGetMV(\"MV_NFLEIZF\",,.F.)\t// Tratamento para a lei da Portaria Suframa nº 275/2009 para Pis e Cofins do chamado TPIPVV\r\nPrivate lAnfavea\t:= If(AliasIndic(\"CDR\") .And. AliasIndic(\"CDS\"),.T.,.F.)\r\nPrivate lCustoEntr\t:= .F.\t//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças\r\nPrivate lDifal\t\t:= .F.\r\nPrivate lDifer\t\t:= .F.\r\nPrivate lTagProduc\t:= .F.\r\n\r\nIf FunName() == \"SPEDNFSE\"\r\n\tDEFAULT cTipo   := PARAMIXB[1]\r\n\tDEFAULT cSerie  := PARAMIXB[3]\r\n\tDEFAULT cNota   := PARAMIXB[4]\r\n\tDEFAULT cClieFor:= PARAMIXB[5]\r\n\tDEFAULT cLoja   := PARAMIXB[6]     \r\n\t\r\n\t\r\nElse\r\n\tDefault cTipo     := PARAMIXB[1,1] // PARAMIXB[1]\r\n\tDefault cSerie    := PARAMIXB[1,3] // PARAMIXB[3]\r\n\tDefault cNota     := PARAMIXB[1,4] // PARAMIXB[4]\r\n\tDefault cClieFor  := PARAMIXB[1,5] // PARAMIXB[5]\r\n\tDefault cLoja     := PARAMIXB[1,6] // PARAMIXB[6]    \r\n\taMotivoCont \t  := PARAMIXB[1,7]\r\n\tcVerAmb     \t  := PARAMIXB[2]\r\n\tcAmbiente\t\t  := PARAMIXB[3]                  \r\n\tDEFAULT cNotaOri  := PARAMIXB[4,1]                  \r\n\tDEFAULT cSerieOri := PARAMIXB[4,2]\r\n\tlTagProduc \t\t  := date() > CTOD(\"06/05/2019\") .or. cAmbiente == \"2\"\r\nEndif\r\n\r\n//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n//³Preenchimento do Array de UF                                            ³\r\n//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\naadd(aUF,{\"RO\",\"11\"})\r\naadd(aUF,{\"AC\",\"12\"})\r\naadd(aUF,{\"AM\",\"13\"})\r\naadd(aUF,{\"RR\",\"14\"})\r\naadd(aUF,{\"PA\",\"15\"})\r\naadd(aUF,{\"AP\",\"16\"})\r\naadd(aUF,{\"TO\",\"17\"})\r\naadd(aUF,{\"MA\",\"21\"})\r\naadd(aUF,{\"PI\",\"22\"})\r\naadd(aUF,{\"CE\",\"23\"})\r\naadd(aUF,{\"RN\",\"24\"})\r\naadd(aUF,{\"PB\",\"25\"})\r\naadd(aUF,{\"PE\",\"26\"})\r\naadd(aUF,{\"AL\",\"27\"})\r\naadd(aUF,{\"MG\",\"31\"})\r\naadd(aUF,{\"ES\",\"32\"})\r\naadd(aUF,{\"RJ\",\"33\"})\r\naadd(aUF,{\"SP\",\"35\"})\r\naadd(aUF,{\"PR\",\"41\"})\r\naadd(aUF,{\"SC\",\"42\"})\r\naadd(aUF,{\"RS\",\"43\"})\r\naadd(aUF,{\"MS\",\"50\"})\r\naadd(aUF,{\"MT\",\"51\"})\r\naadd(aUF,{\"GO\",\"52\"})\r\naadd(aUF,{\"DF\",\"53\"})\r\naadd(aUF,{\"SE\",\"28\"})\r\naadd(aUF,{\"BA\",\"29\"})\r\naadd(aUF,{\"EX\",\"99\"})\r\n\r\nIf FindFunction(\"GETSUBTRIB\")\r\n\tcMVSUBTRIB := GetSubTrib()\r\nEndif\r\n\r\nIF GetNewPar(\"MV_CMPUSR\",\"\")  <>  \"\"\r\n\taCMPUSR\t:= StrTokArr( GetNewPar(\"MV_CMPUSR\",\"\"), \"|\" )\t\r\nEndif \r\n\r\nIf cTipo == \"1\"\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Verifica se existem mais de um cupom relacionado na nota sobre cupom    ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\r\n\t//Para usar a função do loja LjR30Sped ja tem que estar posicionado na SF2 \r\n\tIf FindFunction(\"LjR30Sped\")\r\n\t\tcNFeArea := SF2->(GetArea()) \r\n\t\tdbSelectArea(\"SF2\") \r\n\t\tdbSetOrder(1)\r\n\t\tIf MsSeek(xFilial(\"SF2\")+cNota+cSerie+cClieFor+cLoja)\r\n\t\t\taItemCupRef := LjR30Sped()\r\n\t\tEndif\r\n\t\tRestArea(cNfeArea)\r\n\tEndIf\r\n\r\n\taCupRefLoj := NfMultCup(aItemCupRef, cSerie, cNota, cClieFor, cLoja)\r\n\r\n\tFor nCountNF := 1 To Len(aCupRefLoj)\r\n\t\taNota\t\t:= {}\r\n\t\taEntrega\t:= {}\r\n\t\taDest\t\t:= {}\r\n\t\taTransp\t\t:= {}\r\n\t\taVeiculo\t:= {}\r\n\t\taReboque\t:= {}\r\n\t\taReboqu2\t:= {}\r\n\t\tlVLojaDir \t:= .F.\r\n\r\n\t\tcSerie\t\t:= aCupRefLoj[nCountNF][1]\r\n\t\tcNota\t\t:= aCupRefLoj[nCountNF][2]\r\n\t\tcClieFor\t:= aCupRefLoj[nCountNF][3]\r\n\t\tcLoja\t\t:= aCupRefLoj[nCountNF][4]\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Posiciona NF                                                            ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tdbSelectArea(\"SF2\")\r\n\t\tdbSetOrder(1)\r\n\t\tIf MsSeek(xFilial(\"SF2\")+cNota+cSerie+cClieFor+cLoja)\r\n\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Busca dados do ISS                                                      ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\tdbSetOrder(4)\r\n\t\t\tIf MsSeek(xFilial(\"SF3\")+cClieFor+cLoja+cNota+cSerie)\r\n\t\t\t\tWhile !SF3->(Eof()) .And. cClieFor+cLoja+cNota+cSerie == SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE\r\n\t\t\t\t\t\r\n\t\t\t\t\tnCont++\r\n\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t//FT_FILIAL+FT_TIPOMOV+FT_CLIEFOR+FT_LOJA+FT_SERIE+FT_NFISCAL+FT_IDENTF3\r\n\t\t\t\t\tMsSeek(xFilial(\"SFT\")+\"S\"+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_SERIE+SF3->F3_NFISCAL+SF3->F3_IDENTFT)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SFT->FT_NFISCAL+SFT->FT_SERIE+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_PRODUTO)\r\n\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SF4\")+SD2->D2_TES)\r\n\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\r\n\t\t\t\t\t\tIf SF3->F3_RECISS ==\"1\"\r\n\t\t\t\t\t\t\tcSitTrib := \"R\"\r\n\t\t\t\t\t\tElseif SF3->F3_RECISS ==\"2\" \r\n\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\tElseif SF4->F4_LFISS ==\"I\"\r\n\t\t\t\t\t\t\tcSitTrib:= \"I\"\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndif\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SB1\")+SD2->D2_COD)\r\n\t\t\t\t\tIf SB1->(FieldPos(\"B1_TRIBMUN\"))>0\r\n\t\t\t\t\t\tcTribMun:= SB1->B1_TRIBMUN\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\r\n\t\t\t\t\tcTpPessoa\t:= SA1->A1_TPESSOA\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tIf nCont == 1\r\n\t\t\t\t\t\tDo While !SD2->(Eof ()) .And. xFilial(\"SD2\") == (cAliasSD2)->D2_FILIAL .And.;\r\n\t\t\t\t\t\t\t\tSF2->F2_DOC == (cAliasSD2)->D2_DOC . And. SF2->F2_SERIE == (cAliasSD2)->D2_SERIE .And.;\r\n\t\t\t\t\t\t\t\tSF2->F2_CLIENTE == (cAliasSD2)->D2_CLIENTE .And. SF2->F2_LOJA == (cAliasSD2)->D2_LOJA .And.;\r\n\t\t\t\t\t\t\t\t( SF3->F3_TIPO == \"S\" .Or. lSimpNac )\r\n\t\t\t\t\t\t\t\tIf SF3->F3_TIPO == \"S\"\r\n\t\t\t\t\t\t\t\t\tnPrTotal += (cAliasSD2)->D2_PRCVEN\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t//------------------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\t// Retirado o uso do parametro MV_SIMPREM para que a mensagem sejá gerado de acordo com o CSOSN\r\n\t\t\t\t\t\t\t\t//------------------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+SD2->D2_TES)\r\n\t\t\t\t\t\t\t\tIf lSimpNac .And. (SF4->F4_CSOSN $ '101-201-900')\r\n\t\t\t\t\t\t\t\t\tnValSimprem += (cAliasSD2)->D2_VALICM\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tSD2->(DbSkip ())\r\n\t\t   \t\t\t\tEndDo\r\n\t\t   \t\t\t\t\r\n\t\t   \t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t   \t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t   \t\t\r\n\t\t   \t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf DbSeek(xFilial(\"CD2\")+\"S\"+SF2->F2_SERIE+SF2->F2_DOC+cClieFor+cLoja+PadR(SD2->D2_ITEM,4)+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\tDo While !CD2->(Eof ()) .And. CD2->CD2_DOC == (cAliasSD2)->D2_DOC  \r\n\t\t\t                    If Alltrim(CD2->CD2_IMP) == \"ISS\" \r\n\t\t\t                    \tnValIss\t+= CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCD2->(DbSkip ())\r\n\t\t\t\t\t\t\tEndDo \r\n\t\t\t\t\t\tEndIf \r\n\t\t   \t\t\tEndIf\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf FunName() == \"SPEDNFSE\" //.Or. FunName() == \"SPEDCTE\"\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\r\n\t\t\t\t\t\t\taadd(aISSQN,;\r\n\t\t\t\t\t\t\t\t\t\t{AllTrim(SF3->F3_CODISS),;\r\n\t\t\t\t\t\t\t\t\t\tnPrTotal+SF3->F3_VALOBSE,;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_CNAE,;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_ALIQICM,;\r\n\t\t\t\t\t\t\t\t\t\tIIf((SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\"),nValIss,SF3->F3_VALICM),;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_VALOBSE,;\r\n\t\t\t\t\t\t\t\t\t\tcTribMun,;\r\n\t\t\t\t\t\t\t\t\t\tSF3->F3_BASEICM,;\r\n\t\t\t\t\t\t\t\t\t\tcSitTrib})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aISSQN,;\r\n\t\t\t\t\t\t\t\t\t\t{\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\t\t\"\"})\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tSF3->(dbSkip())\r\n\t\t\t\tEnd\r\n\t\t\t\t\r\n\t\t\tEndif\r\n\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Tratamento temporario do CTe                                            ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf FunName() == \"SPEDCTE\" .Or. AModNot(SF2->F2_ESPECIE)==\"57\"\r\n\t\t\t\tcNFe := \"CTe35080944990901000143570000000000200000168648\"\r\n\t\t\t\tcString := '<infNFe versao=\"T02.00\" modelo=\"57\" >'\r\n\t\t\t\tcString += '<CTe xmlns=\"http://www.portalfiscal.inf.br/cte\">'\r\n\t\t\t\tcString += '<infCte Id=\"CTe35080944990901000143570000000000200000168648\" versao=\"1.02\"><ide><cUF>35</cUF><cCT>000016864</cCT><CFOP>6353</CFOP>'\r\n\t\t\t\tcString += '<natOp>ENTREGA NORMAL</natOp><forPag>1</forPag><mod>57</mod><serie>0</serie><nCT>20</nCT><dhEmi>2008-09-12T10:49:00</dhEmi>'\r\n\t\t\t\tcString += '<tpImp>2</tpImp><tpEmis>2</tpEmis><cDV>8</cDV><tpAmb>2</tpAmb><tpCTe>0</tpCTe><procEmi>0</procEmi><verProc>1.12a</verProc>'\r\n\t\t\t\tcString += '<cMunEmi>3550308</cMunEmi><xMunEmi>Sao Paulo</xMunEmi><UFEmi>SP</UFEmi><modal>01</modal><tpServ>0</tpServ><cMunIni>3550308</cMunIni>'\r\n\t\t\t\tcString += '<xMunIni>Sao Paulo</xMunIni><UFIni>SP</UFIni><cMunFim>3550308</cMunFim><xMunFim>Sao Paulo</xMunFim><UFFim>SP</UFFim><retira>1</retira>'\r\n\t\t\t\tcString += '<xDetRetira>TESTE</xDetRetira><toma03><toma>0</toma></toma03></ide><emit><CNPJ>44990901000143</CNPJ><IE>00000000000</IE>'\r\n\t\t\t\tcString += '<xNome>FILIAL SAO PAULO</xNome><xFant>Teste</xFant><enderEmit><xLgr>Av. Teste, S/N</xLgr><nro>0</nro><xBairro>Teste</xBairro><cMun>3550308</cMun>'\r\n\t\t\t\tcString += '<xMun>Sao Paulo</xMun><CEP>00000000</CEP><UF>SP</UF></enderEmit></emit><rem><CNPJ>58506155000184</CNPJ><IE>115237740114</IE><xNome>CLIENTE SP</xNome>'\r\n\t\t\t\tcString += '<xFant>CLIENTE SP</xFant><enderReme><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun><xMun>SAO PAULO</xMun>'\r\n\t\t\t\tcString += '<CEP>77777777</CEP><UF>SP</UF></enderReme><infOutros><tpDoc>00</tpDoc><dEmi>2008-09-17</dEmi></infOutros></rem><dest><CNPJ></CNPJ><IE></IE>'\r\n\t\t\t\tcString += '<xNome>CLIENTE RJ</xNome><enderDest><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun><xMun>RIO DE JANEIRO</xMun>'\r\n\t\t\t\tcString += '<CEP>44444444</CEP><UF>RJ</UF></enderDest></dest><vPrest><vTPrest>1.93</vTPrest><vRec>1.93</vRec></vPrest><imp><ICMS><CST00><CST>00</CST><vBC>250.00</vBC>'\r\n\t\t\t\tcString += '<pICMS>18.00</pICMS><vICMS>450.00</vICMS></CST00></ICMS></imp><infCteComp><chave>35080944990901000143570000000000200000168648</chave><vPresComp>'\r\n\t\t\t\tcString += '<vTPrest>10.00</vTPrest></vPresComp><impComp><ICMSComp><CST00Comp><CST>00</CST><vBC>10.00</vBC><pICMS>10.00</pICMS><vICMS>10.00</vICMS></CST00Comp>'\r\n\t\t\t\tcString += '</ICMSComp></impComp></infCteComp></infCte></CTe>'\r\n\t\t\t\tcString += '</infNFe>'\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento Nota de Servico  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tElseIf FunName() == \"SPEDNFSE\"\r\n\t\t\t\t\r\n\t\t\t\t//Modelo do XML ISSNET ou BH\r\n\t\t\t\tcModXML:= mv_par04\r\n\t\t\t\t\r\n\t\t\t\taadd(aNotaServ,SF2->F2_SERIE)\r\n\t\t\t\taadd(aNotaServ,SF2->F2_DOC)\r\n\t\t\t\taadd(aNotaServ,SF2->F2_EMISSAO)\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Posiciona cliente  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\taadd(aDest,AllTrim(SA1->A1_CGC))\r\n\t\t\t\taadd(aDest,SA1->A1_NOME)\r\n\t\t\t\taadd(aDest,FisGetEnd(SA1->A1_END,SA1->A1_EST)[1])\r\n\t\t\t\tIf \"/\" $ FisGetEnd(SA1->A1_END,SA1->A1_EST)[3]\r\n\t\t\t\t\taadd(aDest,IIF(FisGetEnd(SA1->A1_END,SA1->A1_EST)[3]<>\"\",FisGetEnd(SA1->A1_END,SA1->A1_EST)[3],\"SN\"))\r\n\t\t\t\tElse\r\n\t \t\t\t\taadd(aDest,IIF(FisGetEnd(SA1->A1_END,SA1->A1_EST)[2]<>0,FisGetEnd(SA1->A1_END,SA1->A1_EST)[2],\"SN\"))\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\taadd(aDest,FisGetEnd(SA1->A1_END,SA1->A1_EST)[4])\r\n\t\t\t\taadd(aDest,SA1->A1_BAIRRO)\r\n\t\t\t\t\r\n\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aDest,\"99999\")\r\n\t\t\t\tEndIf\r\n\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\taadd(aDest,SA1->A1_CEP)\r\n\t\t\t\taadd(aDest,Alltrim(SA1->A1_DDD)+SA1->A1_TEL)\r\n\t\t\t\taadd(aDest,SA1->A1_INSCRM)\r\n\t\t\t\taadd(aDest,SA1->A1_EMAIL)\r\n\t\t\t\t\r\n\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\tSC6->(dbSetOrder(4))\r\n\t\t\t\t\tSC5->(dbSetOrder(1))\r\n\t\t\t\t\tIf (SC6->(MsSeek(xFilial(\"SC6\")+SF2->F2_DOC+SF2->F2_SERIE)))\r\n\t\t\t\t\t\tSC5->(MsSeek(xFilial(\"SC5\")+SC6->C6_NUM))\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf Empty (SC5->C5_FORNISS)\r\n\t\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tSA2->(dbSetOrder(1))\r\n\t\t\t\t\t\t\tSA2->(MsSeek(xFilial(\"SA2\")+SC5->C5_FORNISS+\"00\"))\r\n\t\t\t\t\t\t\taadd(aDest,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aDest,Upper(SA2->A2_EST))\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aDest,\"99999\")\r\n\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\tdbSetOrder(4)\r\n\t\t\t\tMsSeek(xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE)\r\n\t\t\t\t\r\n\t\t\t\tWhile !Eof() .And. xFilial(\"SF3\") == SF3->F3_FILIAL .And.;\r\n\t\t\t\t\tSF2->F2_SERIE == SF3->F3_SERIE .And.;\r\n\t\t\t\t\tSF2->F2_DOC == SF3->F3_NFISCAL .And. !Empty(SF3->F3_CODISS) .And. SF3->F3_TIPO==\"S\"\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Natureza da Operação\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSST\"))>0\r\n\t\t\t\t\t\tcNatOper:= SF3->F3_ISSST\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Tipo de RPS - O sistema de BH ainda não está recebendo Notas Conjugadas\r\n\t\t\t\t\t//If SF2->F2_ESPECIE $ cConjug\r\n\t\t\t\t\t//cTipoRps:=\"2\" //RPS - Conjugada (Mista)\r\n\t\t\t\t\tIf !Empty(SF2->F2_PDV)\r\n\t\t\t\t\t\tcTipoRps:=\"3\" //Cupom\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcTipoRps:=\"1\" //RPS\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Pega os impostos de retencao somente quando houver a retenção, ³\r\n\t\t\t\t\t//³ou seja, os titulos de retenção que existirem                  ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\t\t\tSE1->(dbSetOrder(2))\r\n\t\t\t\t\tIf SE1->(dbSeek(xFilial(\"SE1\")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_SERIE+SF3->F3_NFISCAL))\r\n\t\t\t\t\t\tWhile !SE1->(Eof()) .And. xFilial(\"SE1\") == SE1->E1_FILIAL .And.;\r\n\t\t\t\t\t\t\t\tSF3->F3_CLIEFOR == SE1->E1_CLIENTE .And. SF3->F3_LOJA == SE1->E1_LOJA .And.;\r\n\t\t\t\t\t\t\t\tSF3->F3_SERIE == SE1->E1_PREFIXO .And. SF3->F3_NFISCAL == SE1->E1_NUM\r\n\t\t\t\t\t\t\tIf 'NF' $ SE1->E1_TIPO\r\n\t\t\t\t\t\t\t\tnTotRet+=SumAbatRec(SE1->E1_PREFIXO,SE1->E1_NUM,SE1->E1_PARCELA,SE1->E1_MOEDA,\"V\",SE1->E1_BAIXA,,@nIrRet,@nCsllRet,@nPisRet,@nCofRet,@nInssRet)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tSE1->(DbSkip ())\r\n\t\t\t\t\t\tEndDo\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aRetServ,{nIrRet,nCsllRet,nPisRet,nCofRet,nInssRet,nTotRet})\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Pega as deduções ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSSUB\"))>0\r\n\t\t\t\t\t\tnDedu+= SF3->F3_ISSSUB\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSMAT\"))>0\r\n\t\t\t\t\t\tnDedu+= SF3->F3_ISSMAT\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Obtem os dados do Serviço ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\taSX560 \t := FwGetSX5(\"60\",SF3->F3_CODISS)\r\n\t\t\t\t\tIf len(aSX560) > 0\r\n\t\t\t\t\t\t//Verifico se a Descrição é composta do pedido de Venda ou SX5\r\n\t\t\t\t\t\tIf cDescServ$\"1\"\r\n\t\t\t\t\t\t\tSC6->(dbSetOrder(4))\r\n\t\t\t\t\t\t\tSC5->(dbSetOrder(1))\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SC6\")+SF3->F3_NFISCAL+SF3->F3_SERIE)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SC5\")+SC6->C6_NUM)\r\n\t\t\t\t\t\t\t\r\n\t\t\t           \tIF len(aCMPUSR) > 0  \r\n\t\t\t\t\t\t\t\t\tcFieldMsg := aCMPUSR[1]  \r\n\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf !Empty(cFieldMsg) .and. SC5->(FieldPos(cFieldMsg)) > 0 .and. !Empty(&(\"SC5->\"+cFieldMsg))\r\n\t\t\t\t\t\t\t\tcServ := &(\"SC5->\"+cFieldMsg) \r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcServ := SC5->C5_MENNOTA\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf Empty(cServ)\r\n\t\t\t\t\t\t\t\tcServ := aSX560[1][4]\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcServ := aSX560[1][4]\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Verifica se recolhe ISS Retido ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\tIf SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\tIf SF3->F3_RECISS $\"1|S\"\r\n\t\t\t\t\t\t\tcRetIss :=\"1\"\r\n\t\t\t\t\t\t\tnIssRet := SF3->F3_VALICM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcRetIss :=\"2\"\r\n\t\t\t\t\t\t\tnIssRet := 0\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tElseIf SA1->A1_RECISS $\"1|S\"\r\n\t\t\t\t\t\tcRetIss :=\"1\"\r\n\t\t\t\t\t\tnIssRet := SF3->F3_VALICM\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcRetIss :=\"2\"\r\n\t\t\t\t\t\tnIssRet := 0\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Verifica se municipio de prestação foi informado no pedido ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf SC5->(FieldPos(\"C5_MUNPRES\")) > 0 .And. !Empty(SC5->C5_MUNPRES)\r\n\t\t\t\t\t\tcMunPres  := SC5->C5_MUNPRES\r\n\t\t\t\t\t\tcMunPres:= ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[14]})][02]+cMunPres)\r\n\t\t\t\t\t\tcDescMunP := SC5->C5_DESCMUN\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMunPres:= aDest[13]\r\n\t\t\t\t\t\tcMunPres:= ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[14]})][02]+cMunPres)\r\n\t\t\t\t\t\tcDescMunP := aDest[08]\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SB1\")+SD2->D2_COD)\r\n\t\t\t\t\tIf SB1->(FieldPos(\"B1_TRIBMUN\"))>0\r\n\t\t\t\t\t\tcTribMun:= SB1->B1_TRIBMUN\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tcString := \"\"\r\n\t\t\t\t\tcString += NFSeIde(aNotaServ,cNatOper,cTipoRPS,cModXML)\r\n\t\t\t\t\tcString += NFSeServ(aISSQN[1],aRetServ[1],nDedu,nIssRet,cRetIss,cServ,cMunPres,cModXML,cTpPessoa)\r\n\t\t\t\t\tcString += NFSePrest(cModXML)\r\n\t\t\t\t\tcString += NFSeTom(aDest,cModXML,cMunPres)\r\n\t\t\t\t\t\r\n\t\t\t\t\tExit\r\n\t\t\t\tEndDo\r\n\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Para o caso de Nota sobre Cupom Fiscal, busca os dados da Nota  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t  \t\r\n\t\t\t  \tIf (\"CF\" $ SF2->F2_ESPECIE .OR. \"NFCE\" $ SF2->F2_ESPECIE .OR. \"SATCE\" $ SF2->F2_ESPECIE .OR. (LjAnalisaLeg(18)[1] .AND. \"ECF\" $ SF2->F2_ESPECIE .AND. (\"S\" $ SF2->F2_ECF) )) .AND. !Empty(SF2->F2_NFCUPOM) \r\n\t\t\t\t\tcSerNfCup \t:= SubStr(SF2->F2_NFCUPOM,1,TamSx3(\"F2_SERIE\")[1])\r\n\t\t\t\t\tcNumNfCup \t:= SubStr(SF2->F2_NFCUPOM,4,TamSx3(\"F2_DOC\")[1]) \r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(cNotaOri) .And. cNotaOri <> cNumNfCup\t\t\t\t                                                            \r\n\t\t\t\t\t\tcSerNfCup \t:= cSerieOri\r\n\t\t\t\t\t\tcNumNfCup \t:= cNotaOri\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Alltrim(SF2->F2_ESPECIE) == \"NFCE\"\r\n\t\t\t\t\t\tlNfCupNFCE := .T.\r\n\t\t\t\t\tElseIf Alltrim(SF2->F2_ESPECIE) == \"SATCE\"\r\n\t\t\t\t\t\tlNfCupSAT := .T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tDbSelectArea( \"SF2\" )\r\n\t\t\t\t\tDbSetOrder(1)  // F2_DOC + F2_SERIE + F2_CLIENTE + F2_LOJA\r\n\t\t\t\t\tIf DbSeek( xFilial(\"SF2\") + cNumNfCup + cSerNfCup)\r\n\t\t\t\t\t\taadd(aNota,SF2->F2_SERIE)\r\n\t\t\t\t\t\taadd(aNota,IIf(Len(SF2->F2_DOC)==6,\"000\",\"\")+SF2->F2_DOC)\r\n\t\t\t\t\t\taadd(aNota,SF2->F2_EMISSAO)\r\n\t\t\t\t\t\tlNfCup\t:= .T.\r\n\t\t\t\t\t\tcCliNota\t:= SF2->F2_CLIENTE\r\n\t\t\t\t\t\tcCliLoja\t:= SF2->F2_LOJA\r\n\t\t\t\t\t\tcHoraNota\t:= SF2->F2_HORA\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tRestArea(aAreaSF2)\r\n\t \t\t\tEndIf       \r\n\t            \r\n\t\t\t\tIf !lNfCup .OR. Len(aNota) == 0\r\n\t\t\t\t\taadd(aNota,SF2->F2_SERIE)\r\n\t\t\t\t\taadd(aNota,IIF(Len(SF2->F2_DOC)==6,\"000\",\"\")+SF2->F2_DOC)\r\n\t\t\t\t\taadd(aNota,SF2->F2_EMISSAO)\r\n\t\t\t\tEndIf    \r\n\t\t\t\t\r\n\t\t\t\taadd(aNota,cTipo)\r\n\t\t\t\taadd(aNota,SF2->F2_TIPO)\r\n\t\t\t\taadd(aNota,Iif(lNfCup,cHoraNota,SF2->F2_HORA))\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Posiciona cliente ou fornecedor                                         ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\t\t\t\tIf !SF2->F2_TIPO $ \"DB\" \r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tIf (SF2->(ColumnPos(\"F2_CLIRET\")) > 0 .And. SF2->(ColumnPos(\"F2_LOJARET\")) > 0) .And. !Empty(SF2->F2_CLIRET+SF2->F2_LOJARET) .And. SF2->F2_CLIRET+SF2->F2_LOJARET<>SF2->F2_CLIENTE+SF2->F2_LOJA\r\n\t\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf MsSeek(xFilial(\"SA1\")+SF2->F2_CLIRET+SF2->F2_LOJARET)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_CGC)\r\n\t\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,AllTrim(MyGetEnd(SA1->A1_COMPLEM,\"SA1\")[1]))\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_EMAIL))\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcChaveF2 := \"S\" + SF2->( F2_SERIE + F2_DOC + F2_CLIENTE + F2_LOJA )\r\n\r\n\t\t\t\t\tIf AliasIndic(\"CD9\")\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"CD9\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tif MsSeek(xFilial(\"CD9\") + cChaveF2 )\r\n\t\t\t\t\t\t\tcTpOper := CD9->CD9_TPOPER\r\n\t\t\t\t\t\tendif\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf (SF2->(FieldPos(\"F2_CLIENT\"))<>0 .And. !Empty(SF2->F2_CLIENT+SF2->F2_LOJENT) .And. (SF2->F2_CLIENT+SF2->F2_LOJENT<>SF2->F2_CLIENTE+SF2->F2_LOJA .OR. cTpOper == \"1\" )) .OR.;\r\n\t\t\t\t\t(SF2->(ColumnPos(\"F2_CLIREM\"))<>0 .And. SF2->(ColumnPos(\"F2_LOJAREM\"))<>0 .And. !Empty(SF2->F2_CLIREM + SF2->F2_LOJAREM) .And. (SF2->F2_CLIREM+SF2->F2_LOJAREM <> SF2->F2_CLIENT+SF2->F2_LOJENT .OR. cTpOper == \"1\" ))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tIf (SF2->(ColumnPos(\"F2_CLIREM\"))<>0 .AND. !Empty(SF2->F2_CLIREM + SF2->F2_LOJAREM))//verifica se existe cliente remessa preenchido\r\n\t\t\t\t\t\t\tcFiltro := xFilial(\"SA1\") + SF2->F2_CLIREM + SF2->F2_LOJAREM\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcFiltro := xFilial(\"SA1\") + SF2->F2_CLIENT + SF2->F2_LOJENT\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t \r\n\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\r\n                        If MsSeek(cFiltro)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_CGC)\r\n\t\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\t\taadd(aEntrega,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\t\taadd(aEntrega,AllTrim(MyGetEnd(SA1->A1_COMPLEM,\"SA1\")[1]))\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aEntrega,SA1->A1_MUN)\r\n\t\t\t\t\t\t\taadd(aEntrega,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\t\taadd(aEntrega,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL)) \r\n\t\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_EMAIL))\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t/* Se MV_NFEDEST estiver desabilitado (default .F.) permanece o legado:\r\n\t\t\t\t\ta) Para operações interestaduais (UF do emitente diferente da UF do Cliente de Entrega) e o CNPJ do Destinatario(Cliente - F2_CLIENTE)\r\n\t\t\t\t\t\tfor DIFERENTE do emitente, serão considerados os dados do CLIENTE DE ENTREGA.  \r\n\t\t\t\t\t\t- Os dados do Cliente de Entrega serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\tb) Para operações internas (UF do emitente igual a UF do Cliente de Entrega) e se o CNPJ do Destinatário(Cliente - F2_CLIENTE)\r\n\t\t\t\t\t\tfor IGUAL ao do emitente, serão considerado os dados do CLIENTE, mesmo que UFs sejam diferentes.\r\n\t\t\t\t\t\t- Os dados do Cliente serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf !lUsaCliEnt\r\n\t\t\t\t\t\tlCNPJIgual := AllTrim(SA1->A1_CGC) == Alltrim(SM0->M0_CGC)\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(AllTrim(SF2->F2_CLIENT)) .And. !Empty(AllTrim(SF2->F2_LOJENT))\t\t\t\r\n\t\t\t\t\t\t\tIf Len(aEntrega) > 0\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//Se a UF da entrega for diferente da UF do emitente (operação interestadual) e o CNPJ do destinatario for diferente do emitente, \r\n\t\t\t\t\t\t\t\t//tenho que buscar os dados do cliente de entrega para nao ocorrer \r\n\t\t\t\t\t\t\t\t//rejeicao 523 - CFOP não é de Operação Estadual e UF emitente igual à UF destinatário\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] <> IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .And. !lCNPJIgual //aEntrega[08] <> Upper(SA1->A1_EST)\r\n\t\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENT+SF2->F2_LOJENT))\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t//Se a UF de entrega for igual a UF do emitente (Operação interna) - busco os dados do cliente para montar como destinatario.\r\n\t\t\t\t\t\t\t\t//Se o CNPJ do emitente for igual ao do destinatário também levo os dados do cliente, mesmo que UFs forem diferente.\r\n\t\t\t\t\t\t\t\t//Se o cliente não for consumidor final e possuir IE, pode ocorrer a rejeição 773 - Operação Interna e UF de destino difere da UF do emitente\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] == IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .OR. lCNPJIgual\r\n\t\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tIf !Empty(cCliNota+cCliLoja)\r\n\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+cCliNota+cCliLoja))   //Busca os dados do cliente da Nota sobre Cupom para montar os dados do destinatário do XML\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t/* Se MV_NFEDEST estiver habilitado (.T.):\r\n\t\t\t\t\t\t\tA tag de destinatário - 'dest' será gerada com os dados do CLIENTE (F2_CLIENTE)\r\n\t\t\t\t\t\t\tCaso possua Cliente de Entrega (F2_CLIENT) a tag de entrega será gerada exatamente com os dados do Cliente de Entrega \r\n\t\t\t\t\t\t\tCaso possua Cliente de Retirada (F2_CLIRET) a tag de retirada será gerada exatamente com os dados do Cliente de Retirada (***FUTURA IMPLEMENTAÇÃO*** campo F2_CLIRET inexistente)\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tIf !Empty(cCliNota+cCliLoja)\r\n\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+cCliNota+cCliLoja))   //Busca os dados do cliente da Nota sobre Cupom para montar os dados do destinatário do XML\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SF2->F2_CLIENTE+SF2->F2_LOJA))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\r\n\t\t\t\t\tIf !Empty(SA1->A1_MENSAGE)\r\n\t\t\t\t\t\tcRetForm := SA1->(Formula(A1_MENSAGE))\r\n\t\t\t\t\t\tif cRetForm <> Nil .and. !empty(cRetForm)\r\n\t\t\t\t\t\t\tIf cMVNFEMSA1==\"C\"\r\n\t\t\t\t\t\t\t\tcMensCli\t:=\tcRetForm\r\n\t\t\t\t\t\t\tElseIf cMVNFEMSA1==\"F\"\r\n\t\t\t\t\t\t\t\tcMensFis\t:=\tcRetForm\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_CGC))\r\n\t\t\t\t\taadd(aDest,SA1->A1_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t   \r\n\t\t\t\t\tIf MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0\r\n\t\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[3]) \r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(SA1->(FieldPos(\"A1_COMPLEM\")) > 0 .And. !Empty(SA1->A1_COMPLEM),AllTrim(SA1->A1_COMPLEM),MyGetEnd(SA1->A1_END,\"SA1\")[4]))\r\n\t\t\t\t\taadd(aDest,SA1->A1_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\taadd(aDest,SA1->A1_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_DDD)+SA1->A1_TEL)                                                 \t\t\t\t\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"                                                      \t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(SA1->A1_INSCRUR) .And. SA1->A1_PESSOA == \"F\" .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\"  .And. SA1->A1_EST == \"PR\"\r\n\t\t\t\t\t\t\taadd(aDest,SA1->A1_INSCRUR)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,VldIE(SA1->A1_INSCR))\r\n\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,SA1->A1_SUFRAMA)\r\n\t\t\t\t\taadd(aDest,SA1->A1_EMAIL)\r\n\t\t\t\t\taAdd(aDest,SA1->A1_CONTRIB) // Posição 17\r\n\t\t\t\t\taadd(aDest,Iif(SA1->(FieldPos(\"A1_IENCONT\")) > 0 ,SA1->A1_IENCONT,\"\"))\r\n\t\t\t\t\taadd(aDest,SA1->A1_INSCRM)\r\n\t\t\t\t\taadd(aDest,SA1->A1_TIPO)\r\n\t\t\t\t\taadd(aDest,SA1->A1_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\t//Fornecedor\r\n\t\t\t\t\tIf (SF2->(ColumnPos(\"F2_CLIRET\")) > 0 .And. SF2->(ColumnPos(\"F2_LOJARET\")) > 0) .And. !Empty(SF2->F2_CLIRET+SF2->F2_LOJARET) .And. SF2->F2_CLIRET+SF2->F2_LOJARET<>SF2->F2_CLIENTE+SF2->F2_LOJA .and. SF2->F2_TIPO == \"B\"\r\n\t\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf MsSeek(xFilial(\"SA1\")+SF2->F2_CLIRET+SF2->F2_LOJARET)\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_CGC)\r\n\t\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,AllTrim(MyGetEnd(SA1->A1_COMPLEM,\"SA1\")[1]))\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,SA1->A1_MUN)\r\n\t\t\t\t\t\t\taadd(aRetirada,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL))\r\n\t\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_EMAIL))\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t    dbSelectArea(\"SA2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t// Tratamento para quando existir um cliente de entrega, utilizá-lo ao invés do fornecedor (apenas por garantia)\r\n\t\t\t\t\tIf !Empty(AllTrim(SF2->F2_CLIENT)) .And. !Empty(AllTrim(SF2->F2_LOJENT))\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SF2->F2_CLIENT+SF2->F2_LOJENT)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taDest := {}\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_CGC))\r\n\t\t\t\t\taadd(aDest,SA2->A2_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t                \r\n\t\t\t\t\tIf !Empty(SA2->A2_NR_END) .Or. MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0 \r\n\t\t\t\t\t\taadd(aDest,iif(Empty(SA2->A2_NR_END),MyGetEnd(SA2->A2_END,\"SA2\")[3],SA2->A2_NR_END))\r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(SA2->(FieldPos(\"A2_COMPLEM\")) > 0 .And. !Empty(SA2->A2_COMPLEM),SA2->A2_COMPLEM,MyGetEnd(SA2->A2_END,\"SA2\")[4]))\t\t\t\t\r\n\t\t\t\t\taadd(aDest,SA2->A2_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(SA2->A2_EST))\r\n\t\t\t\t\taadd(aDest,SA2->A2_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\")))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_DDD)+SA2->A2_TEL)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\t\t\t\t\r\n\t\t\t\t\t\taadd(aDest,VldIE(SA2->A2_INSCR))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,\"\")//SA2->A2_SUFRAMA\r\n\t\t\t\t\taadd(aDest,SA2->A2_EMAIL)\t\t\t\t\t\r\n\t\t\t\t\tIf SA2->(FieldPos(\"A2_CONTRIB\"))>0\r\n\t\t\t\t\t\taAdd(aDest,SA2->A2_CONTRIB)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\r\n\t\t\t\t\tEndIf\t \r\n\t\t\t\t\taadd(aDest,\"\")// Posição 18 (referente a A1_IENCONT, sendo passado como vazio já que não existe A2_IENCONT)\r\n\t\t\t\t\taadd(aDest,SA2->A2_INSCRM)\r\n\t\t\t\t\taadd(aDest,\"\")//Posição 20\r\n\t\t\t\t\taadd(aDest,SA2->A2_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Posiciona transportador                                                 ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf !Empty(SF2->F2_TRANSP)\r\n\t\t\t\t\tdbSelectArea(\"SA4\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"SA4\")+SF2->F2_TRANSP)\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aTransp,AllTrim(SA4->A4_CGC))\r\n\t\t\t\t\taadd(aTransp,SA4->A4_NOME)\r\n\t\t\t\t\tIf (SA4->A4_TPTRANS <> \"3\")\r\n\t\t\t\t\t//Conforme RICMS/MG, Anexo V Art. 2º, na emissão do documento fiscal em relação ao quadro transportador, \r\n\t\t\t\t\t//se o mesmo for o próprio remetente ou destinatário, deve-se informar a palavra Remetente ou Destinatário, \r\n\t\t\t\t\t//dispensado o preenchimento dos campos: condição de pagamento, CNPJ ou CPF do transportador, endereço, município, \r\n\t\t\t\t\t//unidade da Federação e a inscrição estadual do transportador (CHAMADO-TVMWZL).\r\n\t\t\t\t\t\tif (IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\") .and. Empty(SA4->A4_INSEST) .and. (ALLTRIM(Upper(SA4->A4_NOME)) =='REMETENTE' .OR. ALLTRIM(Upper(SA4->A4_NOME)) =='DESTINATARIO')\r\n\t\t\t\t\t\t\taadd(aTransp,VldIE(SA4->A4_INSEST,.F.))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aTransp,VldIE(SA4->A4_INSEST))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t                    aadd(aTransp,\"\")\t\t\t\t\r\n\t                EndIf    \r\n\t\t\t\t\taadd(aTransp,SA4->A4_END)\r\n\t\t\t\t\taadd(aTransp,SA4->A4_MUN)\r\n\t\t\t\t\taadd(aTransp,Upper(SA4->A4_EST)\t)\r\n\t\t\t\t\taadd(aTransp,SA4->A4_EMAIL\t)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(SF2->F2_VEICUL1)\r\n\t\t\t\t\t\tdbSelectArea(\"DA3\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"DA3\")+SF2->F2_VEICUL1)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\taadd(aVeiculo,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,iif(!Empty(cAnttRntrc),cAnttRntrc,\"\")))//RNTC\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(SF2->F2_VEICUL2)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"DA3\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"DA3\")+SF2->F2_VEICUL2)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aReboque,DA3->DA3_PLACA)\r\n\t\t\t\t\t\t\taadd(aReboque,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\t\taadd(aReboque,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,\"\")) //RNTC\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf !Empty(SF2->F2_VEICUL3)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"DA3\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"DA3\")+SF2->F2_VEICUL3)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taadd(aReboqu2,DA3->DA3_PLACA)\r\n\t\t\t\t\t\t\t\taadd(aReboqu2,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\t\t\taadd(aReboqu2,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,\"\")) //RNTC\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\tElseIf lNfCup   \r\n\t\t\t\t\t\tSL1->(dbSetOrder(2))\r\n\t\t\t\t\t\tSL1->(MsSeek(xFilial(\"SL1\")+SF2->F2_SERIE+SF2->F2_DOC))\r\n\t\t\t\t\r\n\t\t\t\t\t\taadd(aVeiculo,SL1->L1_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,SL1->L1_UFPLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,iif(!Empty(cAnttRntrc),cAnttRntrc,\"\"))  \r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf GetNewPar(\"MV_SUFRAMA\",.F.) .And. !empty(aDest[15])\r\n\t\t\t\t\tcMensFis += \"Código Suframa: \"+alltrim(aDest[15])+\".\" \r\n\t\t\t\tEndif\r\n\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t// Procura registro nos livros fiscais para tratamentos\r\n\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\r\n\t\t\t\tcChave:=\"\"\r\n\t\t\t\tIf !lNfCup\r\n\t\t\t\t\tcChave :=  xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE\r\n\t\t\t\tElse\r\n\t\t\t\t\tcChave :=  xFilial(\"SF3\")+cCliNota+cCliLoja+cNumNfCup+cSerNfCup\r\n\t\t\t\tEndif\r\n\r\n\t\t\t\tIf MsSeek(cChave)\r\n\t\t\t\t\r\n\t\t\t\t\t// Verifica se o CFOP é de venda por consignação mercantil (CFOP 5111 ou 6111)\r\n\t\t\t\t\tIf AllTrim(SF3->F3_CFO) == \"5111\" .Or. AllTrim(SF3->F3_CFO) == \"6111\" .or.  AllTrim(SF3->F3_CFO)  == '5918' .or.  AllTrim(SF3->F3_CFO)  == '6918'\r\n\t\t\t\t\t\tlConsig  := .T.\r\n\t\t\t\t\telseif ( AllTrim(SF3->F3_CFO) == \"5949\" .or. AllTrim(SF3->F3_CFO) == \"5910\" ) .and. SM0->M0_ESTENT == 'SP' /*termos do inciso II do art. 456 do RICMS/ SP  chamado THPXGS*/ \r\n\t\t\t\t\t\t//lBrinde := .T. //Retirado tratamento de brinde pois foi constatado pela consultoria tributária que nao e' possivel amarrar por CFOP.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Msg Simples Nacional\r\n\t\t\t\t\tIf lSimpNac\r\n\r\n\t\t\t\t\t\tcChave := xFilial(\"SD2\") + SFT->FT_NFISCAL + SFT->FT_SERIE + SFT->FT_CLIEFOR + SFT->FT_LOJA\r\n\r\n\t\t\t\t\t \tSD2->(MsSeek(cChave))\r\n\r\n\t\t\t\t\t\tDo While !SD2->(Eof ()) .And. cChave == SD2->(D2_FILIAL + D2_DOC + D2_SERIE + D2_CLIENTE + D2_LOJA)\r\n\t\t\t\t\t\t\tIf Empty(SD2->D2_PICM) .Or. SD2->D2_PICM == 0\r\n\t\t\t\t\t\t\t\tSD2->(DbSkip ())\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tExit\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndDo\r\n\r\n\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf SF2->F2_TIPO == \"D\"\r\n\t\t\t\t\t\t\tcMensFis += \"Documento emitido por ME ou EPP optante pelo Simples Nacional. \"\r\n\t\t\t\t\t\t\tcMensFis += \"Base de cálculo do ICMS: R$ \" + Str(SF2->F2_BASEICM, 14, 2) + \". \"\r\n\t\t\t\t\t\t\tcMensFis += \"Valor do ICMS: R$ \" + Str(SF2->F2_VALICM, 14, 2) + \". \"\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tIf SF2->F2_VALICM > 0 .And. nValSimprem > 0   // Novo Tratamento\r\n\t\t\t\t\t\t\t\tcMensFis += \"Documento emitido por ME ou EPP optante pelo Simples Nacional.\"\r\n\t\t\t\t\t\t\t\tcMensFis += \"Permite o aproveitamento do credito de ICMS no valor de R$ \" + IIf( Empty(nValSimprem),Str(SF2->F2_VALICM, 14, 2), Str(nValSimprem, 14, 2) ) + \" corresponde a aliquota de \"+str(SD2->D2_PICM,5,2)+ \"% , nos termos do art. 23 da LC 123/2006.\"\r\n\t\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\t\tcMensFis += \"Documento emitido por ME ou EPP optante pelo Simples Nacional. Nao gera direito a credito fiscal de IPI.\"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\t\t\r\n\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Volumes / Especie Nota de Saida                                         ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tcScan := \"1\"\r\n\t\t\t\tnPosCpoEsp := SF2->(ColumnPos(\"F2_ESPECI\"+cScan))\r\n\t\t\t\tnPosCpoVol := SF2->(ColumnPos(\"F2_VOLUME\"+cScan))\r\n\t\t\t\tnPosCpoMrc := 0\r\n\t\t\t\tnPosCpoNum := 0\r\n\t\t\t\tif !empty(cMRCVLMSF2)\r\n\t\t\t\t\taCpoMarVol := StrTokArr2(cMRCVLMSF2, \";\" ) \r\n\t\t\t\t\tif len(aCpoMarVol) == 2\r\n\t\t\t\t\t\tcCpoMarca := alltrim(aCpoMarVol[1])\r\n\t\t\t\t\t\tcCpoNumer := alltrim(aCpoMarVol[2])\r\n\t\t\t\t\t\tnPosCpoMrc := SF2->(ColumnPos(cCpoMarca + cScan)) \r\n\t\t\t\t\t\tnPosCpoNum := SF2->(ColumnPos(cCpoNumer + cScan))\r\n\t\t\t\t\tendif\r\n\t\t\t\tendif\r\n\r\n\t\t\t\tWhile ( !Empty(cScan) )\r\n\t\t\t\t\tcEspecie := \"\"\r\n\t\t\t\t\tnVolume := 0\r\n\t\t\t\t\tcMarca := \"\"\r\n\t\t\t\t\tcNumeracao := \"\"\r\n\r\n\t\t\t\t\tif nPosCpoEsp > 0\r\n\t\t\t\t\t\tcEspecie := upper(SF2->(FieldGet(nPosCpoEsp)))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\t\tIf !empty(cEspecie)\r\n\r\n\t\t\t\t\t\tif nPosCpoMrc > 0\r\n\t\t\t\t\t\t\tcMarca := alltrim(SF2->(FieldGet(nPosCpoMrc)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoNum > 0\r\n\t\t\t\t\t\t\tcNumeracao := alltrim(SF2->(FieldGet(nPosCpoNum)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoVol > 0\r\n\t\t\t\t\t\t\tnVolume := SF2->(FieldGet(nPosCpoVol))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tnScan := aScan(aEspVol,{|x| x[1] == cEspecie})\r\n\t\t\t\t\t\tIf ( nScan==0 .AND.cScan == \"1\" )\r\n\t\t\t\t\t\t\taadd(aEspVol,{ cEspecie, nVolume , SF2->F2_PLIQUI , SF2->F2_PBRUTO, cMarca, cNumeracao})\r\n\t\t\t\t\t\tElseIf ( nScan<>0 .AND.cScan == \"1\" )\r\n\t\t\t\t\t\t\taEspVol[nScan][2] += nVolume\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aEspVol,{ cEspecie, nVolume , 0 , 0, cMarca, cNumeracao})\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcScan := Soma1(cScan,1)\r\n\t\t\t\t\tnPosCpoEsp := SF2->(ColumnPos(\"F2_ESPECI\"+cScan))\r\n\t\t\t\t\tIf nPosCpoEsp == 0 \r\n\t\t\t\t\t\tcScan := \"\"\r\n\t\t\t\t\t\texit\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tnPosCpoVol := SF2->(ColumnPos(\"F2_VOLUME\"+cScan))\r\n\t\t\t\t\tif !empty(cCpoMarca) .and. !empty(cCpoNumer)\r\n\t\t\t\t\t\tnPosCpoMrc := SF2->(ColumnPos(cCpoMarca+cScan))\r\n\t\t\t\t\t\tnPosCpoNum := SF2->(ColumnPos(cCpoNumer+cScan))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\tEndDo\r\n\r\n\t\t\t\t//Verifica se é uma venda de origem do Venda Direta ou SIGALOJA\r\n\t\t\t\tdbSelectArea(\"SL1\")\r\n\t\t\t\tSL1->(DbSetOrder(2)) //L1_FILIAL+L1_SERIE+L1_DOC+L1_PDV\r\n\t\t\t\tlVLojaDir := SL1->(DbSeek(xFilial('SL1') + SF2->F2_SERIE + SF2->F2_DOC))\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Procura duplicatas                                                      ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf !Empty(SF2->F2_DUPL)\t.Or. lVLojaDir\r\n\t\t\t\t\t\r\n\t\t\t\t\tcFilTit := xFilial(\"SE1\")\r\n\r\n\t\t\t\t\tIf lVLojaDir\r\n\t\t\t\t\t\t//Verifica se é venda com Entrega ou Retira Posterior, pois pode ter ocorrido em outra filial.\r\n\t\t\t\t\t\tIf !Empty(SL1->L1_ORCRES)\r\n\t\t\t\t\t\t\tcFilTit := xFilial(\"SE1\",SL1->L1_FILRES)\r\n\t\t\t\t\t\t\tSL1->(DbSetOrder(1)) //L1_FILIAL + L1_NUM\r\n\t\t\t\t\t\t\t//Posiciona no Orçamento Pai\r\n\t\t\t\t\t\t\tSL1->(DbSeek(xFilial(\"SL1\",SL1->L1_FILRES)+SL1->L1_ORCRES))\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tcPrfTit\t\t:= If(Empty(SL1->L1_SERIE),SL1->L1_SERPED,SL1->L1_SERIE)\r\n\t\t\t\t\t\tcNumTit \t:= LJ7NumTit()\r\n\t\t\t\t\t\tcNumDupl \t:= cNumTit\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcPrfTit \t:= SF2->F2_PREFIXO\r\n\t\t\t\t\t\tcNumTit \t:= SF2->F2_DOC\r\n\t\t\t\t\t\tcNumDupl \t:= SF2->F2_DUPL\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcChaveSE1 := cFilTit + cPrfTit + cNumTit\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SED\")\r\n\t\t\t\t\taOrdSED := SED->(getArea())\r\n\t\t\t\t\tSED->(dbSetOrder(1))\r\n\t\t\t\t\tcLJTPNFE := (StrTran(cMV_LJTPNFE,\",\",\" ','\"))+\" \"\r\n\t\t\t\t\tcWhere := cLJTPNFE\r\n\t\t\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\t\t\tSE1->(dbSetOrder(1))\r\n\t\t\t\t\t#IFDEF TOP\r\n\t\t\t\t\t\tlQuery  := .T.\r\n\t\t\t\t\t\tcAliasSE1 := GetNextAlias()\r\n\t\t\t\t\t\tBeginSql Alias cAliasSE1\r\n\t\t\t\t\t\t\tCOLUMN E1_VENCORI AS DATE\r\n\t\t\t\t\t\t\tSELECT E1_FILIAL,E1_PREFIXO,E1_NUM,E1_PARCELA,E1_TIPO,E1_VENCORI,E1_VALOR,E1_VLCRUZ,E1_ORIGEM,E1_PIS,E1_COFINS,E1_CSLL,E1_INSS,E1_VLRREAL,E1_IRRF,E1_ISS,E1_NATUREZ\r\n\t\t\t\t\t\t\tFROM %Table:SE1% SE1\r\n\t\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\tSE1.E1_FILIAL = %Exp:cFilTit% AND\r\n\t\t\t\t\t\t\tSE1.E1_PREFIXO = %Exp:cPrfTit% AND \r\n\t\t\t\t\t\t\tSE1.E1_NUM = %Exp:cNumDupl% AND \r\n\t\t\t\t\t\t\t((SE1.E1_TIPO = %Exp:MVNOTAFIS%) OR (SE1.E1_TIPO = 'DP ' ) OR\r\n\t\t\t\t\t\t\t ((SE1.E1_ORIGEM IN ('LOJA701','FATA701','LOJA010')) AND SE1.E1_TIPO IN (%Exp:cWhere%))) AND\r\n\t\t\t\t\t\t\tSE1.%NotDel%\r\n\t\t\t\t\t\t\tORDER BY %Order:SE1%\r\n\t\t\t\t\t\tEndSql\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t#ELSE\r\n\t\t\t\t\t\tcChaveSE1 := cFilTit + SF2->F2_PREFIXO + SF2->F2_DOC\r\n\t\t\t\t\t\tSE1->(MsSeek(cChaveSE1))\r\n\t\t\t\t\t#ENDIF\r\n\t\t\t\t\tWhile (cAliasSE1)->(!Eof()) .And. (cAliasSE1)->E1_FILIAL+(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM == cChaveSE1\r\n\t\t\t\t\t\t\tIf empty(cNatFin) .Or. !(cNatFin == (cAliasSE1)->E1_NATUREZ)\r\n\t\t\t\t\t\t\t\tcNatFin := (cAliasSE1)->E1_NATUREZ\r\n\t\t\t\t\t\t\t\tSED->(dbSeek( xfilial(\"SED\") + cNatFin))\r\n\t\t\t\t\t\t\t\tcED_DEDINSS := alltrim(SED->ED_DEDINSS)\r\n\t\t\t\t\t\t\t\tcED_RECFUN := alltrim(SED->ED_RECFUN)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf (cAliasSE1)->E1_TIPO = MVNOTAFIS .OR. (cAliasSE1)->E1_TIPO = 'DP' .OR. ((Alltrim((cAliasSE1)->E1_ORIGEM) $ 'LOJA701|FATA701|LOJA010') .AND. (cAliasSE1)->E1_TIPO $ cWhere)\r\n\t\t\t\t\t\t\t\t//Aletrado a busca do valor da Fatura do campo E1_VLCURZ para E1_VLRREAL, \r\n\t\t\t\t\t\t\t\t//devido a titulos com desconto da TAXA do Cartão de Créito que não devem\r\n\t\t\t\t\t\t\t\t//ser repassados para o XML e DANFE.                                                                                    \r\n\t\t\t\t\t\t\t\tnValDupl := IIF((cAliasSE1)->E1_VLRREAL > 0,(cAliasSE1)->E1_VLRREAL,(cAliasSE1)->E1_VLCRUZ)\r\n\t\t\t\t\t\t\t\tIf cValLiqB == \"2\" // 1 Baixa - 2 Emissao\r\n\t\t\t\t\t\t\t\t\tIf Alltrim(SM0->M0_PRODRUR) $ \"1|2|F|J\" .And.;\r\n\t\t\t\t\t\t\t\t\t\t(Alltrim(SM0->M0_PRODRUR) $ \"2|J\" .Or. ;\r\n\t\t\t\t\t\t\t\t\t\t(Alltrim(SM0->M0_PRODRUR) $ \"1|F\" .And. ( Alltrim(SA1->A1_PESSOA) == \"F\" .or. ( (cED_DEDINSS == \"2\" .and. cED_RECFUN == \"2\") .or. Alltrim(SA1->A1_RECINSS) == \"S\"))))\r\n\t\t\t\t\t\t\t\t\t\taadd(aDupl,{(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM+(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_VENCORI;\r\n\t\t\t\t\t\t\t\t\t\t,(nValDupl-(cAliasSE1)->E1_PIS-(cAliasSE1)->E1_COFINS-(cAliasSE1)->E1_CSLL)-(cAliasSE1)->E1_IRRF- IIF(!lRuleDescISS, (cAliasSE1)->E1_ISS, 0)})\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taadd(aDupl,{(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM+(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_VENCORI;\r\n\t\t\t\t\t\t\t\t\t\t,(nValDupl-(cAliasSE1)->E1_PIS-(cAliasSE1)->E1_COFINS-(cAliasSE1)->E1_CSLL-(cAliasSE1)->E1_INSS)-(cAliasSE1)->E1_IRRF- IIF(!lRuleDescISS, (cAliasSE1)->E1_ISS, 0)})\t\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t  \r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\taadd(aDupl,{(cAliasSE1)->E1_PREFIXO+(cAliasSE1)->E1_NUM+(cAliasSE1)->E1_PARCELA,(cAliasSE1)->E1_VENCORI,nValDupl})\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tdbSelectArea(cAliasSE1)\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t    EndDo\r\n\t\t\t\t    If lQuery\r\n\t\t\t\t    \tdbSelectArea(cAliasSE1)\r\n\t\t\t\t    \tdbCloseArea()\r\n\t\t\t\t    \tdbSelectArea(\"SE1\")\r\n\t\t\t\t    EndIf\r\n\t\t\t\t\tRestArea(aOrdSED)\r\n\t\t\t\tElse\r\n\t\t\t\t\taDupl := {}\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Analisa os impostos de retencao                                         ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t//Tratamento para notas sobre cupom(Incluir demais estados conforme conforme legislacao).\r\n\t\t\t\t//A Nota Fiscal  deve ser toda preenchida, sendo a sua escrituração feita com valores zerados, já que o débito será feito pelo cupom\r\n\t\t\t\t//Assim, no livro Registro de Saídas deve ser registrado para esta nota apenas a coluna \"Observações\", onde serão indicados o seu número e a sua série.\r\n\t\t\t\t//Fundamento: artigo 135, § 2º, do RICMS/2000.\t\t  \t\r\n\t\t\t\t//Fundamento: Decreto nº 29.907/2009 , art. 36 , §§ 9º e 10º; RICMS-CE/1997 , art. 731-E1\t\r\n\t\t\t\t//Fundamento: Portaria SEFP nº 799, de 30.12.1997 - DO DF de 31.12.1997\r\n\t\t\t\tIf lNfCup .And. SM0->M0_ESTCOB $ \"CE/DF\" \r\n\t\t\t\t\tlNfCupZero\t:= .T.\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\tDbSelectArea( \"SF2\" )\r\n\t\t\t\t\tDbSetOrder(1)  // F2_DOC + F2_SERIE + F2_CLIENTE + F2_LOJA\r\n\t\t\t\t\tDbSeek( xFilial(\"SF2\") + cNumNfCup + cSerNfCup)\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALPIS\"))<>0 .and. SF2->F2_VALPIS>0\r\n\t\t\t\t\taadd(aRetido,{\"PIS\",0,SF2->F2_VALPIS})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALCOFI\"))<>0 .and. SF2->F2_VALCOFI>0\r\n\t\t\t\t\taadd(aRetido,{\"COFINS\",0,SF2->F2_VALCOFI})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALCSLL\"))<>0 .and. SF2->F2_VALCSLL>0\r\n\t\t\t\t\taadd(aRetido,{\"CSLL\",0,SF2->F2_VALCSLL})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALIRRF\"))<>0 .and. SF2->F2_VALIRRF>0\r\n\t\t\t\t\taadd(aRetido,{\"IRRF\",SF2->F2_BASEIRR,SF2->F2_VALIRRF})\r\n\t\t\t\tEndIf\t\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_VALINSS\"))<>0 .and. SF2->F2_VALINSS>0\r\n\t\t\t\t\taadd(aRetido,{\"INSS\",SF2->F2_BASEINS,SF2->F2_VALINSS})\r\n\t\t\t\tEndIf  \r\n\t\t\t\t\r\n\t\t\t\t// Total Carga Tributária \r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTIMP\"))<>0 .and. SF2->F2_TOTIMP>0\r\n\t\t\t\t\tnTotalCrg := SF2->F2_TOTIMP\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//----------------------------------------------\r\n\t\t\t\t// Total Carga Tributária por Ente Tributante\r\n\t\t\t\t//----------------------------------------------\r\n\t\t\t\t\r\n\t\t\t\t// Ente Federal\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTFED\"))<>0 .and. SF2->F2_TOTFED>0\r\n\t\t\t\t\tnTotFedCrg := SF2->F2_TOTFED\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t// Ente Estadual\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTEST\"))<>0 .and. SF2->F2_TOTEST>0\r\n\t\t\t\t\tnTotEstCrg := SF2->F2_TOTEST\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t// Ente Municipal\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_TOTMUN\"))<>0 .and. SF2->F2_TOTMUN>0\r\n\t\t\t\t\tnTotMunCrg := SF2->F2_TOTMUN\r\n\t\t\t\tEndIf\t\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//RECOPI\r\n\t\t\t\tIf SF2->(FieldPos(\"F2_IDRECOP\")) > 0 .and. !Empty(SF2->F2_IDRECOP)\r\n\t\t\t\t\tcIdRecopi := SF2->F2_IDRECOP\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf !Empty(cIdRecopi)\r\n\t\t\t\t\tIf AliasIndic(\"CE3\")\r\n\t\t\t\t\t\tCE3->(DbSetOrder(1))\r\n\t\t\t\t\t\tIf CE3->(DbSeek(xFilial(\"CE3\")+Alltrim(cIdRecopi)))\r\n\t\t\t\t\t\t\tcNumRecopi:= IIf(CE3->(FieldPos(\"CE3_RECOPI\")) > 0, Alltrim(CE3->CE3_RECOPI), \"\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//////INCLUSAO DE CAMPOS NA QUERY////////////\r\n\t\t\t\t\r\n\t\t\t\tcField := \"%\"\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_DESCZFC\"))<>0 .AND. SD2->(FieldPos(\"D2_DESCZFP\"))<>0\r\n\t\t\t\t\tcField += \",D2_DESCZFC,D2_DESCZFP\" \t\t\t\t\t\t\r\n\t\t\t\tEndIf     \r\n\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_NFCUP\"))<>0\r\n\t\t\t\t   cField  +=\",D2_NFCUP\"\r\n\t\t\t\tEndIF   \r\n\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_DESCICM\"))<>0\r\n\t\t\t\t   cField  +=\",D2_DESCICM\"\t\t\t\t\t\t    \r\n\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_FCICOD\"))<>0\r\n\t\t\t\t   cField  +=\",D2_FCICOD\"\t\t\t\t\t\t    \r\n\t\t\t\tEndIF\r\n\t\t\t\t\r\n\t\t\t\tif SD2->(FieldPos(\"D2_VLIMPOR\"))<>0\r\n\t\t\t\t   cField  +=\",D2_VLIMPOR\"\t\t\t\t    \r\n\t\t\t\tEndIF\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTIMP\"))<>0\r\n\t\t\t\t   cField  +=\",D2_TOTIMP\"\t\t\t\t    \r\n\t\t\t\tEndIf\t\t\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTFED\"))<>0\t// Ente Tributante Federal\r\n\t\t\t\t   cField  +=\",D2_TOTFED\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTEST\"))<>0\t// Ente Tributante Estadual\r\n\t\t\t\t   cField  +=\",D2_TOTEST\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_TOTMUN\"))<>0\t// Ente Tributante Municipal\r\n\t\t\t\t   cField  +=\",D2_TOTMUN\"\t\t\t\t    \r\n\t\t\t\tEndIf\t \r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_GRPCST\"))<>0 //Grupo de tributação de ipi\r\n\t\t\t\t   cField  +=\",D2_GRPCST\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf SD2->(FieldPos(\"D2_VRDICMS\"))<>0\r\n\t\t\t\t   cField  +=\",D2_VRDICMS\"\t\t\t\t    \r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tcField += \"%\"\r\n\t\t\t\t\r\n\t\t\t\t//////////////////////////////////////////////\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf lNfCupZero\r\n\t\t\t\t\tRestArea(aAreaSF2)\r\n\t\t\t\tEndIf\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Pesquisa itens de nota                                                  ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t#IFDEF TOP\r\n\t\t\t\t\tlQuery  := .T.\r\n\t\t\t\t\tcAliasSD2 := GetNextAlias()\r\n\t\t\t\t\t//Verifica se existe Template DCL\r\n\t      \t\t\tIF cVerAmb >= \"4.00\" .And. (ExistTemplate(\"PROCMSG\")) //Tratativa para Grupo de Repasse de Combustiveis\r\n\t\t\t\t\t\tBeginSql Alias cAliasSD2\r\n\t\t\t\t\t\t\t\tSELECT D2_FILIAL,D2_SERIE,D2_DOC,D2_CLIENTE,D2_LOJA,D2_COD,D2_TES,D2_NFORI,D2_SERIORI,D2_ITEMORI,D2_TIPO,D2_ITEM,D2_CF,\r\n\t\t\t\t\t\t\t\tD2_QUANT,D2_TOTAL,D2_DESCON,D2_VALFRE,D2_SEGURO,D2_PEDIDO,D2_ITEMPV,D2_DESPESA,D2_VALBRUT,D2_VALISS,D2_PRUNIT,\r\n\t\t\t\t\t\t\t\tD2_CLASFIS,D2_PRCVEN,D2_IDENTB6,D2_CODISS,D2_DESCZFR,D2_PREEMB,D2_DESCZFC,D2_DESCZFP,D2_LOTECTL,D2_NUMLOTE,D2_ICMSRET,D2_VALPS3,\r\n\t\t\t\t\t\t\t\tD2_ORIGLAN,D2_VALCF3,D2_VALIPI,D2_VALACRS,D2_PICM,D2_PDV,D2_BRICMSO,D2_ICMRETO,D2_BRICMSD,D2_ICMRETD %Exp:cField% \r\n\t\t\t\t\t\t\t\tFROM %Table:SD2% SD2\r\n\t\t\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\t\tSD2.D2_FILIAL  = %xFilial:SD2% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_SERIE   = %Exp:SF2->F2_SERIE% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_DOC     = %Exp:SF2->F2_DOC% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_CLIENTE = %Exp:SF2->F2_CLIENTE% AND\r\n\t\t\t\t\t\t\t\tSD2.D2_LOJA    = %Exp:SF2->F2_LOJA% AND\r\n\t\t\t\t\t\t\t\tSD2.%NotDel%\r\n\t\t\t\t\t\t\t\tORDER BY D2_FILIAL,D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA,D2_ITEM,D2_COD\r\n\t\t\t\t\t\tEndSql\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tBeginSql Alias cAliasSD2\r\n\t\t\t\t\t\t\tSELECT D2_FILIAL,D2_SERIE,D2_DOC,D2_CLIENTE,D2_LOJA,D2_COD,D2_TES,D2_NFORI,D2_SERIORI,D2_ITEMORI,D2_TIPO,D2_ITEM,D2_CF,\r\n\t\t\t\t\t\t\tD2_QUANT,D2_TOTAL,D2_DESCON,D2_VALFRE,D2_SEGURO,D2_PEDIDO,D2_ITEMPV,D2_DESPESA,D2_VALBRUT,D2_VALISS,D2_PRUNIT,\r\n\t\t\t\t\t\t\tD2_CLASFIS,D2_PRCVEN,D2_IDENTB6,D2_CODISS,D2_DESCZFR,D2_PREEMB,D2_DESCZFC,D2_DESCZFP,D2_LOTECTL,D2_NUMLOTE,D2_ICMSRET,D2_VALPS3,\r\n\t\t\t\t\t\t\tD2_ORIGLAN,D2_VALCF3,D2_VALIPI,D2_VALACRS,D2_PICM,D2_PDV %Exp:cField% \r\n\t\t\t\t\t\t\tFROM %Table:SD2% SD2\r\n\t\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\t\tSD2.D2_FILIAL  = %xFilial:SD2% AND\r\n\t\t\t\t\t\t\tSD2.D2_SERIE   = %Exp:SF2->F2_SERIE% AND\r\n\t\t\t\t\t\t\tSD2.D2_DOC     = %Exp:SF2->F2_DOC% AND\r\n\t\t\t\t\t\t\tSD2.D2_CLIENTE = %Exp:SF2->F2_CLIENTE% AND\r\n\t\t\t\t\t\t\tSD2.D2_LOJA    = %Exp:SF2->F2_LOJA% AND\r\n\t\t\t\t\t\t\tSD2.%NotDel%\r\n\t\t\t\t\t\t\tORDER BY D2_FILIAL,D2_DOC,D2_SERIE,D2_CLIENTE,D2_LOJA,D2_ITEM,D2_COD\r\n\t\t\t\t\t\tEndSql\r\n\r\n\t\t\t\t\tEndIf\t\r\n\t\r\n\t\t\t\t#ELSE\r\n\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tlLjDescIt\t:= .F.\t// Inicializa as variaveis que serao utilizadas para desconto \r\n\t\t\t\tlFirstItem \t:= .T.\r\n\t\t\t\tnCount\t\t:= 0\r\n\t\t\t\tlVLojaDir\t:= .F. //Verifica se tem item de venda de origem Venda Direta, Sigaloja ou Nota Sobre Cupom\r\n\t\t\t\tnCountIT := 0\r\n\t\t\t\tWhile !Eof() .And. xFilial(\"SD2\") == (cAliasSD2)->D2_FILIAL .And.;\r\n\t\t\t\t\tSF2->F2_SERIE == (cAliasSD2)->D2_SERIE .And.;\r\n\t\t\t\t\tSF2->F2_DOC == (cAliasSD2)->D2_DOC\r\n\t\t\t\t\t\r\n\t\t\t\t\tlContinua := .T.\r\n\t\t\t\t\t\r\n\t\t\t\t\tnCount++\r\n\t\t\t\t\t//Se for nota sobre cupom, pega somente os itens do cupom que estão na nota sobre cupom.\t\t\t\t\r\n\t\t\t\t\tIf SD2->(FieldPos(\"D2_NFCUP\")) <> 0 .And. !Empty( (cAliasSD2)->D2_NFCUP )\r\n\t\t\t\t\t\tIf lNfCup .And. !( cSerNfCup + cNumNfCup  == SubStr((cAliasSD2)->D2_SERIORI,1,TamSx3(\"F2_SERIE\")[1]) + SubStr((cAliasSD2)->D2_NFCUP,1,TamSx3(\"F2_DOC\")[1]) )\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tlContinua := .F.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tendIf\r\n\t\t\t\t\tEndif\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf (cAliasSD2)->D2_TIPO == \"D\" .And. SM0->M0_ESTENT == \"PR\" .And. (cAliasSD2)->D2_ICMSRET > 0\r\n\t\t\t\t\t\t/* Tratamento para com base na legislação do Estado do Paraná Decreto n 6.080/2012 - DOE PR Suplemento  \r\n\t\t\t\t\t\te para atender a ICMS/PR 2017 (Decreto 7.871/2017) Art. 9, Seção I, Anexo IX \r\n\t\t\t\t\t\tque não prevê o destaque do ICMS no campo específico (tanto o da operação própria do substituto quanto do \r\n\t\t\t\t\t\tretido por substituição tributária) ISSUE DSERTSS1-5542. */\t\t\t\t\t\t\r\n\t\t\t\t\t\tlIcmSTDev\t:= .F.\r\n\t\t\t\t\t\tlIcmDevol\t:= .F.\t\t\t\t\t\t\r\n\t\t\t\t\t\tlIcmsPR\t:= .T.\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tlIcmSTDev\t:= lIcmSTDevOri\r\n\t\t\t\t\t\tlIcmDevol\t:= lIcmDevolOri\t\r\n\t\t\t\t\t\tlIcmsPR\t:= .F.\r\n\t\t\t\t\tendif\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf lGE .and. lNfCup \r\n\t\t\t\t\t\tDbSelectArea(\"SB1\")\r\n\t\t\t\t\t\taSb1 := SB1->(GetArea())\r\n\t\t\t\t\t\tDbSetOrder(1) // B1_FILIAL+B1_COD\r\n\t\t\t\t\t\tIf DbSeek(xFilial(\"SB1\")+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\tIf SB1->B1_TIPO == cTpGar \t\r\n\t\t\t\t\t\t\t\tlContinua := .F.\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tRestArea(aSb1)\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf lContinua\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Verifica a natureza da operacao                                         ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf lNfCup\r\n\t\t\t\t\t\t\taAreaSD2  \t:= SD2->(GetArea())\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Pesquisa itens de nota                                                  ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\t\t\t\t\t\t\tIf Val((cAliasSD2)->D2_ITEMORI)== 0\r\n\t\t\t\t\t\t\t   cNumitem := (cAliasSD2)->D2_ITEM\r\n\t\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\t   cNumitem := (cAliasSD2)->D2_ITEMORI\r\n\t\t\t\t\t\t\tEnd\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t/*Ajuste para buscar a TES do cupom fiscal*/\r\n\t\t\t\t\t\t\tDbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\tDbSetOrder(3)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf Dbseek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\t\t\tcD2Tes\t:= SD2->D2_TES\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf DbSeek(xFilial(\"SD2\")+cNumNfCup+cSerNfCup+cCliNota+cCliLoja+(cAliasSD2)->D2_COD+cNumitem)\r\n\t\t\t\t\t\t\t\tcD2Cfop := SD2->D2_CF\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tlChave:=.T.\r\n\t\t\t\t\t\t\t\tcChCupom := \"S\"+cSerNfCup+cNumNfCup+cCliNota+cCliLoja+cNumitem\r\n\t\t\t\t\t\t\t\tcD2TesNF := SD2->D2_TES\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tRestArea(aAreaSD2)\r\n\t\t\t\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t\t    \t//|                                                             ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf Alltrim(SF2->F2_ESPECIE) == \"NFCE\" .OR. Alltrim(SF2->F2_ESPECIE) == \"SATCE\"\r\n\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF2->F2_EMISSAO, SF2->F2_SERIE, SF2->F2_DOC, SM0->M0_CGC, SM0->M0_ESTCOB, SF2->F2_ESPECIE, SF2->F2_CHVNFE,0,\"\",\"\",0,\"\",\"\" })\r\n\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aRefECF,{SD2->D2_DOC,SF2->F2_ESPECIE,SF2->F2_PDV})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Quando nao for cupom fiscal,\t\t\t\t\t\t\t³\r\n\t\t\t\t\t\t\t//³\to CFOP deve ser atualizado com o CFOP de cada ITEM, |\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t \r\n\t\t\t\t\t\t\tcD2Cfop := (cAliasSD2)->D2_CF\r\n\t\t\t\t\t\t\tcD2Tes\t:= (cAliasSD2)->D2_TES\r\n\t\t\t\t\t\t\tlChave:=.F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcChaveD2 := \"S\" + ( cAliasSD2 )->( D2_SERIE + D2_DOC + D2_CLIENTE + D2_LOJA + D2_ITEM )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+cD2Tes)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças\r\n\t\t\t\t\t\tIf lCpoCusEnt .And. cMVEstado == \"PE\" .And. SF4->F4_CUSENTR ==\"1\"\r\n\t\t\t\t\t\t\tlCustoEntr := .T.\r\n\t\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\t\tIf SF4->F4_AGRPIS = \"1\"\r\n\t\t\t\t\t\t\taAdd(aAgrPis,{.T.,0})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taAdd(aAgrPis,{.F.,0})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf SF4->F4_AGRCOF = \"1\"\r\n\t\t\t\t\t\t\taAdd(aAgrCofins,{.T.,0})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taAdd(aAgrCofins,{.F.,0})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcChave:=\"\"\r\n\t\t\t\t\t\tIf !lChave\r\n\t\t\t\t\t\t\tcChave :=  cChaveD2   \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcChave :=  cChCupom\r\n\t\t\t\t\t\tEndif\r\n\t\r\n\t          // Posiciono na TES do cupom fiscal para pegar a natureza de operação da nf sobre cupom\r\n\t\t\t\t\t\t/*Necessario para imprimir a natureza de operação do cupom fiscal emitido em ECF*/\r\n\t\t\t\t\t\tIf lNfCup .And. !Empty(cD2TesNF)\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+cD2TesNF)\r\n\t\t\t\t\t\tEndIf              \r\n\t                  \r\n\t\t\t\t\t\tSFT->( dbSetOrder( 1 ) )\r\n\t\t\t\t\t\t//utiliza a funcao SpedNatOper ( SPEDXFUN ) que possui o tratamento para a natureza da operacao/prestacao\r\n\t\t\t\t\t\tif FindFunction( \"SpedNatOper\" ) .And. SFT->( MsSeek( xFilial( \"SFT\" ) +cChave) )\r\n\t\t\t\t\t\t\tIf !Alltrim(SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ])$cNatOper\r\n\t\t\t\t\t\t  \t\tIf\tEmpty(cNatOper)\r\n\t\t\t\t\t\t     \t\tcNatOper := SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\t  \t\tElse\r\n\t\t\t\t\t\t      \t\tcNatOper := cNatOper + \"/ \" +SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\t  \t\tEndif\r\n\t\t\t\t\t\t   Endif\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tIf !lNatOper\r\n\t\t\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\t\t\tcNatOper := Alltrim(SF4->F4_TEXTO)\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tcNatOper += Iif(!Alltrim(SF4->F4_TEXTO)$cNatOper,\"/ \" + SF4->F4_TEXTO,\"\")\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\tElse\t\t\t\t   \t\r\n\t\t\t\t\t\t\t\taSX513 \t := FwGetSX5(\"13\",SF4->F4_CF)\r\n\t\t\t\t\t\t\t\tIf len(aSX513) > 0\r\n\t\t\t\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\t\t\t\tcNatOper := AllTrim(SubStr(aSX513[1][4],1,55))\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tcNatOper += Iif(!AllTrim(SubStr(aSX513[1][4],1,55)) $ cNatOper, \"/ \" + AllTrim(SubStr(aSX513[1][4],1,55)), \"\")\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t    \t\tEndIf\r\n\t\t\t\t    \tendif\r\n\t\t\t    \t\t\r\n\t\t\t    \t\t// Posiciono na TES da NF Sobre Cupom novamente\r\n\t\t\t\t\t\t/*Necessario para posicionar noo SF4 referente a nota sobre cupom*/\r\n\t\t\t\t\t\tIf lNfCup\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SF4\")+cD2Tes)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t    \t\tIf SF4->(FieldPos(\"F4_BASEICM\"))>0\r\n\t\t\t    \t\t\tnRedBC := IiF(SF4->F4_BASEICM>0,IiF(SF4->F4_BASEICM == 100,SF4->F4_BASEICM,IiF(SF4->F4_BASEICM > 100,0,100-SF4->F4_BASEICM)),SF4->F4_BASEICM)\r\n\t\t\t    \t\t\tcCST   := SF4->F4_SITTRIB \r\n\t\t\t    \t\tEndif\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Verifica as notas vinculadas                                            ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_NFORI)\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_TIPO $ \"DBN\"\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tIf\t( MsSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD+PADL(alltrim((cAliasSD2)->D2_ITEMORI),TamSx3(\"D2_ITEMORI\")[1],\"0\")) ) .OR. ;\r\n\t\t\t\t\t\t\t\t\t( MsSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA) .And. Empty(cMVREFNFE) )  .Or. ;\r\n\t\t\t\t\t\t\t\t\tPosiTriang(cAliasSD2)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//Posiciona SD1 de acordo com o D1_NUMSEQ caso tenha referencia de poder de terceiro.\r\n\t\t\t\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_IDENTB6)    \t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tnSD1Pos := SD1->(Recno())\t\t\t\t\t\t\t\t\t\t\t\t\t    \t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_IDENTB6)\r\n\t\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\t\tSD1->(DbGoTo(nSD1Pos))\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_TIPO)\r\n\t\t\t\t\t\t\t\t\tIf SD1->D1_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Obtem os dados de nota fiscal de produtor rural referenciada                                  ³\r\n\t\t\t\t\t\t\t\t\t//³Temos duas situacoes:                                                                         ³\r\n\t\t\t\t\t\t\t\t\t//³A NF de saída é uma devolucao, onde a NF original pode ser ou nao uma devolução.              ³\r\n\t\t\t\t\t\t\t\t\t//³1) Quando a NF original for uma devolucao, devemos utilizar o remetente do documento fiscal,  ³\r\n\t\t\t\t\t\t\t\t\t//³    podendo ser o sigamat.emp no caso de formulario proprio ou o proprio SA1 no caso de nf de ³\r\n\t\t\t\t\t\t\t\t\t//³    entrada com formulario proprio igual a NAO.                                               ³\r\n\t\t\t\t\t\t\t\t\t//³2) Quando a NF original NAO for uma devolucao, neste caso tambem pode variar conforme o       ³\r\n\t\t\t\t\t\t\t\t\t//³    formulario proprio igual a SIM ou NAO. No caso do NAO, os dados a serem obtidos retornara ³\r\n\t\t\t\t\t\t\t\t\t//³    da tabela SA2.                                                                            ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf AllTrim(SF1->F1_ESPECIE)==\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t//para nota de entrada tipo devolucao o emitente eh o cliente ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\t\t\t\tIf SD1->D1_TIPO$\"DB\"\r\n\t\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA1->A1_CGC),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA1->A1_EST),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA1->A1_INSCR)})\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t//para nota de entrada normal o emitente eh o fornecedor ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA2->A2_CGC),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA2->A2_EST),; \r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA2->A2_INSCR)})\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\t//Informacoes do cupom fiscal referenciado\r\n\t\t\t\t\t\t\t\t\tIf AllTrim(SF1->F1_ESPECIE)==\"CF\"\r\n\t\t\t\t\t\t\t\t\t\taadd(aRefECF,{SD1->D1_DOC,SF1->F1_ESPECIE,\"\"})\r\n\t\t\t\t\t\t\t\t\tEndif  \r\n\t\t\t\t\t\t\t\t\t//Outros documentos referenciados\r\n\t\t\t\t\t\t\t\t\tif AllTrim(SF1->F1_ESPECIE)<>\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t//Documento de Estorno - Tipo Devolucao e F4_AJUSTE=\"S\"\r\n\t\t\t\t\t\t\t\t\t\t//identifica que se trata de nf de estorno.\r\n\t\t\t\t\t\t\t\t\t\tIf ( ( cAliasSD2 )->D2_COD == SD1->D1_COD .AND. SF4->F4_AJUSTE == \"S\" )\t\r\n\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SD1->D1_EMISSAO, SD1->D1_SERIE , SD1->D1_DOC, iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ), SM0->M0_ESTCOB, SF1->F1_ESPECIE, SF1->F1_CHVNFE, SD1->D1_TOTAL-SD1->D1_DESC, \"\", SF1->F1_TIPO, iif(SD1->D1_TIPO $ \"DB\",1,2), SD1->D1_FORNECE, SD1->D1_LOJA })\r\n\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tnCountIT += 1\r\n\t\t\t\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF1->F1_CHVNFE, SF1->F1_VALBRUT})\r\n\r\n\t\t\t\t\t\t\t\t\t\tElseif cChave <> dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE;\r\n\t\t\t\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SD1->D1_EMISSAO, SD1->D1_SERIE, SD1->D1_DOC, iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ), SM0->M0_ESTCOB, SF1->F1_ESPECIE, SF1->F1_CHVNFE,SD1->D1_TOTAL-SD1->D1_DESC,\"\",SF1->F1_TIPO, iif(SD1->D1_TIPO $ \"DB\",1,2), SD1->D1_FORNECE, SD1->D1_LOJA })\r\n\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\tnCountIT += 1\r\n\t\t\t\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF1->F1_CHVNFE, SF1->F1_VALBRUT})\r\n\t\t\t\t\t\t\t\t\t\tendIf\t\r\n\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\r\n\t\t\t\t\t\t\t\t\tendIf\t\r\n\t\t\t\t\t\t\t\tElseIf (cAliasSD2)->D2_TIPO == \"N\"                                                     \t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t   \t\tdbSetOrder(4)     \r\n\t\t\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SFT\")+\"S\"+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_NFORI)\r\n\t\t\t\t\t\t\t\t\t\tIf SFT->FT_ESTADO == \"EX\" .or. ((SubStr(SM0->M0_CODMUN,1,2) == \"35\" .Or. SubStr(SM0->M0_CODMUN,1,2) == \"29\") .and. \"REMESSA POR CONTA E ORDEM DE TERCEIROS\" $ Upper(cNatOper) .and. lOrgaoPub )//(Venda para orgao publico - SP/BA/CFOP Remessa por conta e ordem de terceiros (cfop 5923/6923)- ch:TIDWCY   \r\n\t\t\t\t\t\t\t\t\t\t\t//Se venda para orgao publico, vincula NFe do tipo Normal de faturamento\r\n\t\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\t\t\t   \t\tdbSetOrder(4) \r\n\t\t\t\t\t\t\t\t\t   \t\tMsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE) \r\n\t\t\t\t\t\t\t\t\t\t\tif cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA1->A1_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tElseIf Alltrim(SFT->FT_CFOP) $ cMVREFNFE\r\n\t\t\t\t\t\t\t\t\t\t\t//Tratamento para que leve na TAG <refNFe> as notas referenciadas que contém o CFOP no parâmetro MV_REFNFE\r\n\t\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\t\t\t   \t\tdbSetOrder(4) \r\n\t\t\t\t\t\t\t\t\t   \t\tIf (MsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE))\r\n\t\t\t\t\t\t\t\t\t\t   \t\tIf cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA1->A1_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\t\t\t\t\t\t\t\t\t\t\t\r\n\t                                                lVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\r\n\t\t\t\t\t\t\t\t\t\t   \tEndif\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\t\t\t   \t\tdbSetOrder(4) \r\n\t\t\t\t\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE)\t\t\t\t\t\t\t\t\t\t   \t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t//Obtem os dados de nota fiscal de produtor rural referenciada\r\n\t\t\t\t\t\t\t\t\t\t\t\t//A NF de saída Para este tipo de nota, o emitente eh sempre o sigamat.emp\r\n\t\t\t\t\t\t\t\t\t\t\t\tIf AllTrim(SF3->F3_ESPECIE)==\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t//para nota de saida normal o emitente eh o sigamat\r\n\t\t\t\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SF3->F3_EMISSAO,SF3->F3_SERIE,SF3->F3_NFISCAL,SF3->F3_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tSM0->M0_CGC,SM0->M0_ESTENT,SM0->M0_INSC})\r\n\t\t\t\t\t\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\t   \t\t\t\t\tIf cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t\t\t\t   \t\t\t\t\t\t.or. (cAliasSD2)->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t   \t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA1->A1_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE ,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA1->A1_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tendIf \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD2 )->D2_ITEM\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taOldReg  := SD2->(GetArea())\r\n\t\t\t\t\t\t\t\taOldReg2 := SF2->(GetArea())\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\t\t\t//Alterado a chave de busca completa devido ao procedimento de complemento de notas de devolucao de compras. FNC -> 00000008125/2011.\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//If MsSeek(xFilial(\"SD2\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD+(cAliasSD2)->D2_ITEMORI)\r\n\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SD2\")+(cAliasSD2)->D2_NFORI+(cAliasSD2)->D2_SERIORI)//+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD+(cAliasSD2)->D2_ITEMORI)\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SF2\")+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\tIf !SD2->D2_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\t\tlComplDev := .T.\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t//Obtem os dados de nota fiscal de produtor rural referenciada\r\n\t\t\t\t\t\t\t\t\t//A NF de saída NAO EH uma devolucao, portanto eh uma nota de saida complementar. Para este tipo\r\n\t\t\t\t\t\t\t\t\t//de nota, o emitente eh sempre o sigamat.emp\r\n\t\t\t\t\t\t\t\t\tIf AllTrim(SF2->F2_ESPECIE)==\"NFP\"\r\n\t\t\t\t\t\t\t\t\t\t//para nota de saida normal o emitente eh o sigamat\r\n\t\t\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD2->D2_EMISSAO,SD2->D2_SERIE,SD2->D2_DOC,SF2->F2_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\t\t\tSM0->M0_CGC,SM0->M0_ESTENT,SM0->M0_INSC})\r\n\t\t\t\t\t\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Outros documentos referenciados³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf cChave <> Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\taadd(aNfVinc,{SF2->F2_EMISSAO,SD2->D2_SERIE,SD2->D2_DOC,SM0->M0_CGC,SM0->M0_ESTCOB,SF2->F2_ESPECIE,SF2->F2_CHVNFE,0,\"\",\"\",0,\"\",\"\"})\r\n\t\t\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\t\t\tcChave := Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tRestArea(aOldReg)\r\n\t\t\t\t\t\t\t\tRestArea(aOldReg2)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf lVinc .and. !Empty(aNfVinc)\r\n\t\t\t\t\t\t\taadd(aItemVinc,{ATail(aNfVinc)[1]})\r\n\t\t\t\t\t\tElse\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aItemVinc,{})\r\n\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Obtem os dados do produto\r\n\t\t\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SB1\")+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\r\n\t\t   \t\t\t\tdbSelectArea(\"SB5\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tIf MsSeek(xFilial(\"SB5\")+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\tIf SB5->(FieldPos(\"B5_DESCNFE\")) > 0 .And. !Empty(SB5->B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tcInfAdic := Alltrim(SB5->B5_DESCNFE)\r\n\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\tcInfAdic := \"\"\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\r\n                            cUmDipi  := SB5->B5_UMDIPI      \r\n                            nConvDip := SB5->B5_CONVDIP    \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcInfAdic := \"\"\t\t\r\n                            cUmDipi  := \"\"    \r\n                            nConvDip := 0      \r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t \t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"DY3\")\r\n\t\t\t\t   \t\tdbSetOrder(1)\r\n\t\t\t\t   \t\tIf MsSeek(xFilial(\"DY3\")+ (cAliasSB5)->B5_ONU)\r\n\t\t\t\t\t\t\tIf !Empty(DY3->DY3_DESCRI) .and. (DY3->DY3_INFCPL ==\"S\" .OR. DY3->DY3_INFCPL ==\"1\")\r\n\t\t\t\t\t\t\t\tIf !cMensONU $ DY3->DY3_ONU\r\n\t\t\t\t\t     \t   \t\tcMensONU\t:= cMensONU +'  ONU '+Alltrim(DY3->DY3_ONU)+' '+Alltrim(DY3->DY3_DESCRI)+'   '   \r\n\t\t\t\t\t    \t\tEndIF\r\n\t\t\t\t   \t\t\tEndIF  \t\t\r\n\t\t\t\t\t\tEndIF\r\n\r\n                        \r\n                        //Atualiza a Unid. Medida da DIPI(cUmDipi) e o Fator de Conv. da DIPI(nConvDip) com dados da SBZ caso os parâmetro recebidos estejam vazios\r\n                        RetInfoSBZ((cAliasSD2)->D2_COD, @cUmDipi, @nConvDip)\r\n                        \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//------------------------------------------------------------------------\r\n\t\t\t\t\t\t//Obtem dados adicionais ou do produto, ou do item do pedido de venda\r\n\t\t\t\t\t\t//------------------------------------------------------------------------\r\n\t\t\t\t\t\tIf lC6_CODINF .And. cInfAdPr <> \"2\" .And. !Empty(cInfAdPr)\r\n\t\t\t\t\t\t\tSC6->(dbSetOrder(2))\r\n\t\t\t\t\t\t\tIf SC6->(MsSeek(xFilial(\"SD2\")+(cAliasSD2)->(D2_COD+D2_PEDIDO+D2_ITEMPV))) \r\n\t\t\t\t\t\t\t\tcInfAdPed := Alltrim(MSMM(SC6->C6_CODINF,80))\r\n\t\t\t\t\t\t\t\tIf !Empty(cInfAdPed)\r\n\t\t\t\t\t\t\t\t\t//--Obtem informacoes do item do pedido de venda\r\n\t\t\t\t\t          \tIf cInfAdPr == \"1\"     \r\n\t\t\t\t\t           \t\tcInfAdic := cInfAdPed\r\n\t\t\t\t\t           \t//--Obtem informacoes do item do pedido de venda e do produto\r\n\t\t\t\t\t           \tElseIf cInfAdPr == \"3\" \r\n\t\t\t\t\t           \t   cInfAdPed := SubStr(AllTrim(cInfAdPed),1,250)\r\n\t\t\t\t\t           \t   cInfAdic  := SubStr(AllTrim(cInfAdic),1,249)\r\n\t\t\t\t\t           \t   cInfAdic  += \" \" + cInfAdPed\r\n\t\t\t\t\t           \tEndIf \r\n\t\t\t\t\t      \tEndIf\r\n\t\t\t\t\t\t\tEndIf                                                  \t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Veiculos Novos\r\n\t\t\t\t\t\tIf AliasIndic(\"CD9\")\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD9\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD9\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//Combustivel\r\n\t\t\t\t\t\tIf AliasIndic(\"CD6\")\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD6\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD6\")+\"S\"+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+Padr((cAliasSD2)->D2_ITEM,4)+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//Medicamentos\r\n\t\t\t\t\t\tIf AliasIndic(\"CD7\")\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD7\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD7\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t// Armas de Fogo\r\n\t\t\t\t\t\tIf AliasIndic(\"CD8\")\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD8\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"CD8\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Anfavea\r\n\t\t\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDR\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tDbSeek(xFilial(\"CDR\")+\"S\"+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDS\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tcItem := PADR((cAliasSD2)->D2_ITEM,TAMSX3(\"CDS_ITEM\")[1])\r\n\t\t\t\t\t\t\tDbSeek(xFilial(\"CDS\")+\"S\"+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+cItem+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\tEndIf  \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Rastreabilidade\r\n\t\t\t\t\t\tIf AliasIndic(\"F0A\")\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"F0A\")\r\n\t\t\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"F0A\") + cChaveD2 )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t \t\t                    \t\t\t\t\t\r\n\t\t\t\t\t\t//Desconto Zona Franca PIS e COFINS \r\n\t\t\t\t\t\tIf\tSD2->(FieldPos(\"D2_DESCZFC\"))<>0 .AND. SD2->(FieldPos(\"D2_DESCZFP\"))<>0\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_DESCZFC > 0\t\r\n\t\t\t\t\t\t\t\tnValCofZF += (cAliasSD2)->D2_DESCZFC\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_DESCZFP > 0\t\r\n\t\t\t\t\t\t\t\tnValPisZF += (cAliasSD2)->D2_DESCZFP\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"SC5\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SC5\")+(cAliasSD2)->D2_PEDIDO)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tdbSelectArea(\"SC6\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SC6\")+(cAliasSD2)->D2_PEDIDO+(cAliasSD2)->D2_ITEMPV+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcTpCliente:= Alltrim(SF2->F2_TIPOCLI)\r\n\t\t\t\t\t\t//Para nota sobre cupom deve ser \r\n\t\t\t\t\t\t//impresso os valores da lei da transparência.\t\t\t\t\t\r\n\t\t\t\t\t\tif lNfCup\r\n\t\t\t\t\t\t\tcTpCliente := \"F\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !AllTrim(SC5->C5_MENNOTA) $ cMensCli\r\n\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t***********************\r\n\t\t\t\t\t\t\t* BRUNO LAGE\r\n\t\t\t\t\t\t\t***********************\r\n\t\t\t\t\t\t\t*\r\n\t\t\t\t\t\t\t*    \r\n\r\n\t\t\t\t\t\t\tcMensCli += AllTrim(SC5->C5_MENNOTA) + AllTrim(SC5->C5_MSG2)\r\n\r\n\t\t\t\t\t\t\t//MENSAGEM 2 PARA NF <TLM>\r\n\t\t\t\t\t\t\tIf !AllTrim(SC5->C5_MSG2) $ cMensCli\r\n\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t//cMensCli += \" \"\r\n\t\t\t\t\t\t\t\t\tcMensCli += AllTrim(SC5->C5_MSG2)\r\n\t\t\t\t\t\t\t\tEndIf                 \r\n\t\t\t\t\t\t\t\t//cMensCli += AllTrim(SC5->C5_MSG2) \r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t*\r\n\t\t\t\t\t\t\t*********** \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//-- Tratamento para a integração entre WMS Logix X ERP Protheus \r\n\t\t\t\t\t\t\tIf SC5->( FieldPos(\"C5_ORIGEM\") ) > 0 .And. 'LOGIX' $ Upper(SC5->C5_ORIGEM) \r\n\t\t\t\t\t\t\t\tLgxMsgNfs()\r\n\t\t\t\t\t\t\tEndIf     \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF len(aCMPUSR) > 0  \r\n\t\t\t\t\t\t\t\tcFieldMsg := aCMPUSR[1]  \r\n\t\t\t\t\t\t\tEndIf    \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//BRUNO (VALIDAR POIS O CAMPO C5_MENNOTA É MEMO NA QUALITA)                       \r\n\t\t\t\t\t\t\tIf !Empty(cFieldMsg) .and. SC5->(FieldPos(cFieldMsg)) > 0 .and. !Empty(&(\"SC5->\"+cFieldMsg))\r\n\t\t\t\t\t\t\t\tcMensCli := alltrim(&(\"SC5->\"+cFieldMsg))\r\n\t\t\t\t\t\t\tElseIf !(IIF( SF2->(FieldPos(\"F2_MENNOTA\")) > 0, AllTrim(SF2->F2_MENNOTA),AllTrim(SC5->C5_MENNOTA)) $ cMensCli)\r\n\t\t\t\t\t\t\t\tcMensCli += IIF( SF2->(FieldPos(\"F2_MENNOTA\")) > 0, AllTrim(SF2->F2_MENNOTA),AllTrim(SC5->C5_MENNOTA))\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf !Empty(SC5->C5_MENPAD) \r\n\t\t\t\t\t\t\tcRetForm := FORMULA(SC5->C5_MENPAD)\r\n\t\t\t\t\t\t\tif cRetForm <> nil .and. !AllTrim(cRetForm) $ cMensFis\r\n\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensFis += AllTrim(cRetForm)\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf !Empty( cNumNfCup )\r\n\t\t\t\t\t\t\t//Tratamento para nota sobre Cupom \r\n\t\t\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\t\t\tIf Len(aItemCupRef) > 0\r\n\t\t\t\t\t\t\t\tcMsgCup := \" CF/SERIE: \" + AllTrim((cAliasSD2)->D2_DOC) + \" \" + Alltrim((cAliasSD2)->D2_SERIE) +\" ECF:\" + Alltrim((cAliasSD2)->D2_PDV)\r\n\t\t\t\t\t\t\t\tif !upper(Alltrim(cMsgCup)) $ upper(Alltrim(cMensCli))\r\n\t\t\t\t\t\t\t\t\tif \"CF/SERIE:\" $ upper(Alltrim(cMensCli))\r\n\t\t\t\t\t\t\t\t\t\tcMensCli +=\" / \"\r\n\t\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\t\tcMensCli +=\" CF/SERIE: \" + AllTrim((cAliasSD2)->D2_DOC) + \" \" + Alltrim((cAliasSD2)->D2_SERIE) +\" ECF:\" + Alltrim((cAliasSD2)->D2_PDV)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t    DbSetOrder(1)\r\n\t\t\t\t\t\t\t    If SFT->(DbSeek((xFilial(\"SD2\")+\"S\"+ cSerNfCup + cNumNfCup )))\r\n\t\t\t\t\t\t\t\t\tIF  AllTrim(SFT->FT_OBSERV) <> \" \" .AND.(cAliasSD2)->D2_ORIGLAN==\"LO\"\r\n\t\t\t\t\t\t\t\t\t\tIF !Alltrim(SFT->FT_OBSERV) $ Alltrim(cMensCli) \r\n\t\t\t\t\t\t\t\t\t\t\tif upper( \"F - simples faturamento\" ) $  upper( Alltrim(SFT->FT_OBSERV) )\r\n\t\t\t\t\t\t\t\t\t\t\t\tcMensCli +=\" CF/SERIE: \" + AllTrim((cAliasSD2)->D2_DOC) + \" \" + Alltrim((cAliasSD2)->D2_SERIE) +\" ECF:\" + Alltrim((cAliasSD2)->D2_PDV)\r\n\t\t\t\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\t\t\t\tIf \"DEVOLUCAO N.F.\" $ Upper(SFT->FT_OBSERV) \r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcMensCli +=\" \" + StrTran(AllTrim(SFT->FT_OBSERV),\"N.F.\",\"C.F.\")\r\n\t\t\t\t\t\t\t\t\t\t\t\tElseIf !lNfCupNFCE .and. !lNfCupSAT\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tcMensCli +=\" \" + AllTrim(SFT->FT_OBSERV)\r\n\t\t\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\tendif\t\t\r\n\t\t\t\t\t\t\t\t\t\tEndIf       \r\n\t\t\t\t\t           \t\tEndIf\r\n\t\t\t\t\t        \tEndIF\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tRestArea(aAreaSF2)\t        \t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tif !lIcmDevol .And. !(\"Nota fiscal emitida sem destaque do ICMS\" $ cMensCli)\r\n\t\t\t\t\t\t\tif Len( cMensCli ) > 0\r\n\t\t\t\t\t\t\t\tcMensCli += ' '\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\tif SM0->M0_ESTENT == \"PR\"\r\n\t\t\t\t\t\t\t\tcMensCli += \" Nota fiscal emitida sem destaque do ICMS conforme artigo 9. do Anexo IX do RICMS-PR/2017.\"\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\tcMensCli += \" Nota fiscal emitida sem destaque do ICMS.\"\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tendif \t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Obtem os dados do veiculo informado no pedido de venda\r\n\t\t\t\t\t\tIf Empty(aVeiculo)\r\n\t\t\t\t\t\t\tDbSelectArea(\"DA3\")\r\n\t\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\tIf DbSeek(xFilial(\"DA3\")+Iif(SC5->(FieldPos(\"C5_VEICULO\")) > 0 ,SC5->C5_VEICULO,\"\"))\r\n\t\t\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_PLACA)\r\n\t\t\t\t\t\t\t\taadd(aVeiculo,DA3->DA3_ESTPLA)\r\n\t\t\t\t\t\t\t\taadd(aVeiculo,Iif(DA3->(FieldPos(\"DA3_RNTC\")) > 0 ,DA3->DA3_RNTC,iif(!Empty(cAnttRntrc),cAnttRntrc,\"\")))//RNTC\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t//O campo F4_FORINFC é um substituto do F4_FORMULA, e através do parâmetro MV_NFEMSF4 se determina se o conteúdo da formula devera compor a mensagem do cliente (=\"C\") ou do fisco (=\"F\"). \t\t\t\t\r\n\t\t\t\t\t\tIf SF4->(ColumnPos(\"F4_FORINFC\") ) > 0  .And. !Empty(SF4->F4_FORINFC) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORINFC)\r\n\t\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4==\"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4==\"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tElseIf !Empty(SF4->F4_FORMULA) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORMULA)\r\n\t\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4==\"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4==\"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tIf lSb1CT\r\n\t\t\t\t\t\t\tIf lMvImpFecp  .And. SB1->B1_X_CT$cMVAEHC\r\n\t\t\t\t\t\t\t\tIf (lValFecp .Or. lVfecpst) \r\n\t\t\t\t\t\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t\t    DbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tIf SFT->(DbSeek((xFilial(\"SFT\") + cChaveD2 )))\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tIf SFT->FT_VFECPST > 0\r\n\t\t\t\t\t\t\t\t   \t\t\tcMensFis += \" Cod.Prod: \" + Alltrim((cAliasSD2)->D2_COD) + IIF(SB1->B1_X_CT$cMVAEHC,\" AEHC \",\"\") + \" BC R$: \" + Alltrim(Transform(SFT->FT_BASERET,\"@E 999,999,999.99\"))  + \" o adicional de \" + Alltrim(Str(SFT->FT_ALQFECP, 14, 2))+\"%\" + \" valor FECP R$ \" + Alltrim(Transform(SFT->FT_VFECPST,\"@E 999,999,999.99\")) \r\n\t\t\t\t\t\t\t\t\t    Endif\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\tEndif \r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tIf lMvImpFecp \r\n\t\t\t\t\t\t   If (lValFecp .Or. lVfecpst) \r\n\t\t\t\t\t\t   \t\tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\t\tIf SFT->(DbSeek((xFilial(\"SFT\") + cChaveD2 )))\t\r\n\t\t\t\t\t\t\t\t\t\tnValTFecp += SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\r\n\t\t\t\t\t\t\t\t\t\tnValIFecp := SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t   \r\n\t\t\t\t\t\t   Endif\t\t\t\t\t\r\n\t\t\t\t\t\tEndif\t\r\n\t\t\t\t\t\t//Verifica se existe Template DCL\r\n\t      \t\t\t\tIF (ExistTemplate(\"PROCMSG\"))\r\n\t      \t\t\t\t\taMens := ExecTemplate(\"PROCMSG\",.f.,.f.,{cAliasSD2})      \t\t\t\t\t\t\t\t\t\t \t\t      \t\t\t\t\t\r\n\t\t\t\t\t\t\t\tFor nA:=1 to len(aMens)\r\n\t\t\t\t\t\t\t\t    If aMens[nA][1] == \"V\" .Or. (aMens[nA][1] == \"T\" .And. Ascan(aMensAux,aMens[nA][2])==0)\r\n\t\t\t\t\t\t\t\t\t\tAADD(aMensAux,aMens[nA][2])\r\n\t\t\t\t\t\t\t\t\tEndif\t\r\n\t\t\t\t\t\t\t\tNext    \t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\tIf len(aMens) > 0\r\n\t\t\t\t\t\t\t\t\taAreaSD2  \t:= SD2->(GetArea())\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(3)\r\n\r\n\t\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SD2\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA+(cAliasSD2)->D2_COD )\r\n\t\t\t\t\t\t\t\t\t\tnBRICMSO \t:= SD2->D2_BRICMSO\r\n\t\t\t\t\t\t\t\t\t\tnICMRETO\t:= SD2->D2_ICMRETO\r\n\t\t\t\t\t\t\t\t\t\tnBRICMSD \t:= SD2->D2_BRICMSD\r\n\t\t\t\t\t\t\t\t\t\tnICMRETD\t:= SD2->D2_ICMRETD \r\n\t\t\t\t\t\t\t\t\t\tnAliqST\t\t:= SD2->D2_ALIQSOL\r\n\t\t\t\t\t\t\t\t\tEndif  \r\n\r\n\t\t\t\t\t\t\t\t\tRestArea(aAreaSD2) \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t     \t\t\t\tEndif \r\n\t     \t\t\t\t\r\n\t\t\t\t \t\tIf SF2->F2_TPFRETE == \"C\"\r\n\t\t\t\t\t\t\tcModFrete := \"0\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"F\"\r\n\t\t\t\t\t\t \tcModFrete := \"1\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"T\"\r\n\t\t\t\t\t\t \tcModFrete := \"2\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"R\"\r\n\t\t\t\t\t \t\tcModFrete := \"3\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"D\"\r\n\t\t\t\t\t \t\tcModFrete := \"4\"\r\n\t\t\t\t\t\tElseIf SF2->F2_TPFRETE == \"S\"\r\n\t\t\t\t\t\t \tcModFrete := \"9\"\r\n\t\t\t\t\t \tElseIf Empty(cModFrete)\r\n\t\t\t\t\t \t\tIf SC5->C5_TPFRETE==\"C\"\r\n\t\t\t\t\t\t\t\tcModFrete := \"0\"\r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"F\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"1\"\r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"T\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"2\"\r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"S\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"9\" \r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"R\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"3\" \r\n\t\t\t\t\t\t\tElseIf SC5->C5_TPFRETE==\"D\"\r\n\t\t\t\t\t\t\t \tcModFrete := \"4\" \r\n\t\t\t\t\t\t \tElse\r\n\t\t\t\t\t\t \t\tcModFrete := \"1\" \t\t\t \t \t\r\n\t\t\t\t\t\t\tEndIf   \t\t\t \r\n\t\t\t\t\t\tEndIf               \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf Empty(aPedido)\r\n\t\t\t\t\t\t\taPedido := {Iif(SC5->(FieldPos(\"C5_NTEMPEN\")) > 0,Alltrim(SC5->C5_NTEMPEN),\"\"),AllTrim(SC6->C6_PEDCLI),\"\"}\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Indicador de presença do comprador no estabelecimento comercial no momento da operação - VERSÃO 3.10\r\n\t\t\t\t\t\tIf SC5->(FieldPos(\"C5_INDPRES\")) > 0\r\n\t\t\t\t\t\t\t If lNfCup .Or. (cAliasSD2)->D2_ORIGLAN $ \"VD|LO\"\r\n\t\t\t\t\t\t\t \tcIndPres := \"1\" //1=Operação presencial\r\n\t\t\t\t\t\t\t Else\r\n\t\t\t\t\t\t\t \tcIndPres:= Alltrim(SC5->C5_INDPRES)\r\n\t\t\t\t\t\t\t EndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Verifica se municipio de prestação foi informado no pedido\r\n\t\t\t\t\t\tIf SC5->(FieldPos(\"C5_MUNPRES\")) > 0 .And. !Empty(SC5->C5_MUNPRES)\r\n\t\t\t\t\t\t\tif len(AllTrim(SC5->C5_MUNPRES)) == 7 \r\n\t\t\t\t\t\t\t\tcMunPres  := SC5->C5_MUNPRES\r\n\t\t\t\t\t\t\t\tcMunTransp := cMunPres\r\n\t\t\t\t\t\t\telseif SC5->(FieldPos(\"C5_ESTPRES\")) > 0 .and. !Empty(SC5->C5_ESTPRES)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tcMunPres  := ConvType(aUF[aScan(aUF,{|x| x[1] == SC5->C5_ESTPRES})][02]+SC5->C5_MUNPRES)\r\n\t\t\t\t\t\t\t\tcMunTransp := cMunPres\r\n\t\t\t\t\t\t\tendif  \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcMunPres := ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[09]})][02]+aDest[07])\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t// Tags xPed e nItemPed (controle de B2B) para nota de saída\r\n\t\t\t\t\t\tIf SC6->(FieldPos(\"C6_NUMPCOM\")) > 0 .And. SC6->(FieldPos(\"C6_ITEMPC\")) > 0\r\n\t\t\t\t\t\t\tIf !Empty(SC6->C6_NUMPCOM) .And. !Empty(SC6->C6_ITEMPC) \r\n\t\t\t\t\t\t\t\taadd(aPedCom,{SC6->C6_NUMPCOM,SC6->C6_ITEMPC})\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aPedCom,{})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aPedCom,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Conforme Decreto RICM, N 43.080/2002 valido somente em MG deduzir o\r\n\t\t\t\t\t\t//imposto dispensado na operação\r\n\t\t\t\t\t\tnDescRed := 0\r\n\t\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t//FT_FILIAL+FT_TIPOMOV+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM+FT_PRODUTO\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SFT\") + cChaveD2 + \"  \" + (cAliasSD2)->D2_COD)  \r\n\t\t\t\t\t\tIf SFT->(FieldPos(\"FT_DS43080\")) <> 0 .And. SFT->FT_DS43080 > 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\t\t\tnDescRed := SFT->FT_DS43080 \r\n\t\t\t\t\t\t\tnDesTotal+= nDescRed\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SFT->(ColumnPos(\"FT_DESCFIS\")) <> 0 .And. SFT->FT_DESCFIS > 0\r\n\t\t\t\t\t\t\tnDescFis := SFT->FT_DESCFIS\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf (SFT->(ColumnPos(\"FT_CRDPRES\")) <> 0 .And. SFT->FT_CRDPRES > 0) .and. ( SF4->F4_AGREGCP $\"1|S\")\r\n\t\t\t\t\t\t\tnCrdPres := SFT->FT_CRDPRES\r\n\t\t\t\t\t\t\tnTotCrdP += nCrdPres\r\n\t\t\t\t\t\tEndIf \r\n\r\n\t\t\t\t\t\t//Alteração realizada no campo F4_ICMSDIF, foi incluido a opção: 6 – Diferido(Deduz NF e Duplicata)\r\n\t\t\t\t\t\t//no combo para deduzir os valores de ICMS diferido na NF e da Duplicata\r\n\t\t\t\t\t\t//http://tdn.totvs.com/display/public/PROT/2892815+DSERFIS1-6266+DT+Diferimento+ICMS\r\n\t\t\t\t\t\tnDescNfDup :=0\r\n\t\t\t\t\t\tIf\tSF4->F4_ICMSDIF == \"6\"\r\n\t\t\t\t\t\t\tnDescNFDup := IIF(SF1->(F1_STATUS) == 'C', (cAliasSD1)->(D1_ICMSDIF),SFT->FT_ICMSDIF)\r\n\t\t\t\t\t\tEndIF \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Incluido o tratamento pelo fato do SIGALOJA e o VENDA DIRETA nao gravar\r\n\t\t\t\t\t\t//o campo D2_DESCON, quando e' dado desconto no total da venda.\r\n\t\t\t\t\t\tIf lNfCup .Or. (cAliasSD2)->D2_ORIGLAN $ \"VD|LO\"\r\n\r\n\t\t\t\t\t\t\tlVLojaDir := .T.\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnDesconto := 0\r\n\t\t\t\t\t\t\t//Caso possua desconto vai fazer essa logica abaixo para se adequar a mesma logica do faturamento , \r\n\t\t\t\t\t\t\t//Pq ao contrario do faturamento o LOJA nao grava o D2_DESCON quando o desconto eh no total \r\n\t\t\t\t\t\t\tIf SF2->F2_DESCONT > 0\r\n\t\t\t\t\t\t\t\tIf lFirstItem\t// Somente faz o looping nos itens na primeira vez\r\n\t\t\t\t\t\t\t\t\tnTDescIt := 0\r\n\r\n\t\t\t\t\t\t\t\t\t//Posicionando diretamente na SD2, para poder utilizar o Get/RestArea e atender TOP e DBF.\r\n\t\t\t\t\t\t\t\t\taAreaSD2  \t:= SD2->(GetArea())\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SD2\")+SF2->F2_DOC+SF2->F2_SERIE+SF2->F2_CLIENTE+SF2->F2_LOJA)\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tWhile !SD2->(Eof()) .And. xFilial(\"SD2\") == SD2->D2_FILIAL .And.;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  SF2->F2_SERIE  == SD2->D2_SERIE  .And.;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  SF2->F2_DOC    == SD2->D2_DOC\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tnTDescIt += SD2->D2_DESCON \t// Soma de todos os descontos nos itens\r\n\t\t\t\t\t\t\t\t\t\tSD2->(DbSkip())\r\n\t\t\t\t\t\t\t\t\tEnd\r\n\t\t\t\t\t\t\t\t\tlFirstItem := .F.\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tRestArea(aAreaSD2)\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t/*Retirado tratamento pois não funciona para DBF\r\n\t\t\t\t\t\t\t\t\tnX := 1\r\n\t\t\t\t\t\t\t\t\t// Como nao temos RestArea para alias temp , da um gotop e depois certifica que esta no recno correto\r\n\t\t\t\t\t\t\t\t\tWhile nCount <> (cAliasSD2)->(Recno()) .AND. nX < 50 // Protecao para nao ficar loop infinito\r\n\t\t\t\t\t\t\t\t\t\t(cAliasSD2)->(DbSkip())\r\n\t\t\t\t\t\t\t\t\t\tnX++\r\n\t\t\t\t\t\t\t\t\tEnd\r\n\t\t\t\t\t\t\t\t\t */\r\n\t\t\t\t\t\t\t\t\t// Se o valor do desconto for igual significa que soemente teve desconto no item \r\n\t\t\t\t\t\t\t\t\t// Nesse caso pode seguir a mesma regra do faturamente e pegar direto do D2_DESCON\t\r\n\t\t\t\t\t\t\t\t\tIf nTDescIt = SF2->F2_DESCONT\r\n\t\t\t\t\t\t\t\t\t\tlLjDescIt\t:= .T.\t\t\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf lLjDescIt\t// Se so teve desconto no item pega direto do D2_DESCON\r\n\t\t\t\t\t\t\t\t\tnDesconto := (cAliasSD2)->D2_DESCON\r\n\t\t\t\t\t\t\t\tElse\t\t\t// Faz o rateio do desconto no total + o desconto no item\r\n\t\t\t\t\t\t\t\t\tnDesconto := ((((cAliasSD2)->D2_QUANT*(cAliasSD2)->D2_PRUNIT)/SF2->F2_VALMERC) * (SF2->F2_DESCONT- nTDescIt))+(cAliasSD2)->D2_DESCON \r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t            Else \r\n\t\t\t\t\t\t\tnDesconto := (cAliasSD2)->D2_DESCON            \t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf  (cAliasSD2)->D2_VRDICMS > 0  .and. nDesconto >= (cAliasSD2)->D2_VRDICMS \r\n\t\t\t\t\t\t\t\tnDesVrIcms := (cAliasSD2)->D2_VRDICMS\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf\tSD2->(FieldPos(\"D2_DESCICM\"))<>0\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tnDescIcm := ( IIF(SF4->F4_AGREG == \"D\",(cAliasSD2)->D2_DESCICM,0) )\r\n\t\r\n\t\t\t\t\t\t\t\tIf cVerAmb >= \"3.10\" .and. SF4->F4_AGREG == \"D\" .and.  (!Empty(SF4->F4_MOTICMS) .and. (AllTrim(SF4->F4_MOTICMS) $ \"3-8-9\" .or.  AllTrim(SF4->F4_MOTICMS) =='90')) .and. Empty(SF4->F4_CSOSN)\r\n\t\t\t\t\t\t\t\t\tnDescIcm:=0\r\n\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t            EndIf\r\n\t\t\t            \r\n\t\t\t\t\t\t//Tratamento para verificar se o produto e controlado por terceiros (IDENTB6)\r\n\t\t\t\t\t\t//e a partir do tipo do pedido (Cliente ou Fornecedor) verifica  se existe\r\n\t\t\t\t\t\t//amarracao entre Produto X Cliente(SA7) ou Produto X Fornecedor(SA5)\r\n\t\t\t\t\t\t//Caso haja a amarraca, o codigo e descricao do produto, assumem o conteudo da SA7 ou SA5\r\n\t\t\r\n\t\t\t\t\t\tcCodProd  := (cAliasSD2)->D2_COD\t            \r\n\t\t\t\t\t\tcDescProd := IIF(Empty(SC6->C6_DESCRI),SB1->B1_DESC,SC6->C6_DESCRI) \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t********************************************************************\r\n\t\t\t\t\t\t* BRUNO LAGE FERREIRA\r\n\t\t\t\t\t\t********************************************************************\r\n\t\t\t\t\t\t*  \r\n\t\t\t\t\t\t*\r\n\t\t\t\t\t\tIF(Alltrim((cAliasSD2)->D2_LOTECTL) == '')\r\n\t\t\t\t\t\t\tcDescProd := IIf(Empty(SC6->C6_LTREM) , cDescProd , Alltrim(cDescProd) + \" - NUM. \" + Alltrim(SC6->C6_LTREM))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcDescProd := IIf(Empty((cAliasSD2)->D2_LOTECTL) , cDescProd , Alltrim(cDescProd) + \" - NUM. \" + Alltrim((cAliasSD2)->D2_LOTECTL))\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t//Acrescentar comprimento, altura e largura bruta para Remessa p/ industrialização por conta ord.\r\n\t\t\t\t\t\tIf ( !Empty(SC6->C6_COMPBRU) .AND. !Empty(SC6->C6_ALTBRU ) .AND. !Empty(SC6->C6_LARGBRU) .AND. SC6->C6_TES == \"526\" )\r\n\r\n\t\t\t\t\t\t\tcDescProd += \" Bru.- \" + ALLTRIM(cValToChar(SC6->C6_COMPBRU)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_ALTBRU)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_LARGBRU)) + \" Liq.- \"\r\n\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf ( !Empty(SC6->C6_COMPLIQ) .AND. !Empty(SC6->C6_ALTLIQ) .AND. !Empty(SC6->C6_LARGLIQ) )\r\n\r\n\t\t\t\t\t\t\tcDescProd += \" \" + ALLTRIM(cValToChar(SC6->C6_COMPLIQ)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_ALTLIQ)) + \" x \"\r\n\t\t\t\t\t\t\tcDescProd += ALLTRIM(cValToChar(SC6->C6_LARGLIQ))\r\n\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t*\r\n\t\t\t\t\t\t*\r\n\t\t\t\t\t\t*******************************************************************\r\n\t\t\t\t\t\t \r\n\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_IDENTB6) .And. lNFPTER  \r\n\t\t\t\t         \tIf SC5->C5_TIPO == \"N\" \r\n\t\t\t\t\t\t         //--A7_FILIAL + A7_CLIENTE + A7_LOJA + A7_PRODUTO\r\n\t\t\t\t\t\t         SA7->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\t         If SA7->(MsSeek( xFilial(\"SA7\") + (cAliasSD2)->(D2_CLIENTE+D2_LOJA+D2_COD) )) .and. !empty(SA7->A7_CODCLI) .and. !empty(SA7->A7_DESCCLI) \r\n\t\t\t\t\t\t         \tcCodProd  := SA7->A7_CODCLI \r\n\t\t\t\t\t\t            cDescProd := SA7->A7_DESCCLI\t            \t\t\t\t\t\t\r\n\t\t\t\t\t\t         EndIf \r\n\t\t\t\t\t\t\tElseIf SC5->C5_TIPO == \"B\"\r\n\t\t\t\t\t\t      \t//--A5_FILIAL + A5_FORNECE + A5_LOJA + A5_PRODUTO\r\n\t\t\t\t\t\t         SA5->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\t         If SA5->(MsSeek( xFilial(\"SA5\") + (cAliasSD2)->(D2_CLIENTE+D2_LOJA+D2_COD) )) .and. !empty(SA5->A5_CODPRF) .and. !empty(SA5->A5_DESREF)\r\n\t\t\t\t\t\t         \tcCodProd  := SA5->A5_CODPRF \r\n\t\t\t\t\t\t            cDescProd := SA5->A5_DESREF \t            \r\n\t\t\t\t\t\t         EndIf \t\r\n\t\t\t\t\t      \tEndIf  \r\n\t\t\t         \tEndIf \r\n\t\t\t         \r\n\t\t\t            nDescZF := (cAliasSD2)->D2_DESCZFR \r\n\t\t\t            \r\n\t\t\t            // Faz o destaque do IPI nos dados complementares caso seja uma venda por consignação mercantil e possuir IPI\r\n\t\t\t\t\t\tIf (lConsig .Or. Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .And. (cAliasSD2)->D2_VALIPI > 0\r\n\t\t\t\t\t\t\tnIPIConsig += (cAliasSD2)->D2_VALIPI\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Faz o destaque do ICMS ST nos dados complementares caso seja uma venda por consignação mercantil e possuir ICMS ST\r\n\t\t\t\t\t\tIf Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM .And. (cAliasSD2)->D2_ICMSRET > 0 .And. lConsig    \r\n\t\t\t\t\t\t\tnSTConsig += (cAliasSD2)->D2_ICMSRET \r\n\t\t\t\t\t\tEndIf  \t\r\n\t\t\t            \r\n\t\t\t            //Tratamento para que o valor de ICMS ST venha a compor o valor da tag vOutros quando for uma nota de Devolução, impedindo que seja gerada a rejeição 610.\r\n\t\t\t            nIcmsST := 0\r\n\t\t\t            If (!lIcmSTDev .And. (cAliasSD2)->D2_TIPO == \"D\" .And. SubStr((cAliasSD2)->D2_CLASFIS,2,2) $ '00#10#30#70#90') .Or. (lConsig .And. Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .Or. (!lIcmSTDev .And. lComplDev .And. (cAliasSD2)->D2_TIPO == \"I\" )\r\n\t\t\t            \tnIcmsST := (cAliasSD2)->D2_ICMSRET\r\n\t\t\t            EndIf   \r\n\t\t\t            cOrigem:= IIF(!Empty((cAliasSD2)->D2_CLASFIS),SubStr((cAliasSD2)->D2_CLASFIS,1,1),'0')\r\n\t\t\t            cCSTrib:= IIF(!Empty((cAliasSD2)->D2_CLASFIS),SubStr((cAliasSD2)->D2_CLASFIS,2,2),'50')\r\n\t\t\t            \r\n\t\t\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//\t\t\tFCI - Ficha de Conteúdo de Importação\r\n\t\t\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//**Operação INTERNA:\r\n\t\t\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da importação      (Industrialização)\r\n\t\t\t\t\t\t//\r\n\t\t\t\t\t\t//**Operação INTERESTADUAL:\r\n\t\t\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t\t\t// - Informar o valor da parcela importada do exterior, o número da FCI e o Conteúdo de\r\n\t\t\t\t\t\t//   Importação expresso percentualmente (Industrialização)\r\n\t\t\t\t\t\t//----------------------------------------------------------------------------------------- \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf (cOrigem $\"1-2-3-4-5-6-8\" .And. cCSTrib $ \"00-10-20-30-40-41-50-51-60-70-90\")\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->(FieldPos(\"D2_FCICOD\")) > 0 .And. !Empty((cAliasSD2)->D2_FCICOD)\r\n\t\t\t\t\t\t\t\taadd(aFCI,{(cAliasSD2)->D2_FCICOD}) \r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf lFCI\r\n\t\t\t\t\t\t\t\t\tcMsgFci\t:= \"Resolucao do Senado Federal nº 13/12\"\r\n\t\t\t\t\t\t\t\t\tcInfAdic  += cMsgFci + \", Numero da FCI \" + Alltrim((cAliasSD2)->D2_FCICOD) + \".\"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t// Retirada a validação devido a criação da tag nFCI (NT 2013/006)\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//Campo SD2->D2_FCICOD só é preenchido nos casos de Industrialização Interestadual\r\n\t\t\t\t\t\t//Executar UPDSIGAFIS para criação do campo na D2 e tabela CFD.\r\n\t\t\t\t\t\t//Obs.: O campo D2_FCICOD é alimentado com o conteúdo do campo CFD_FCICOD após\r\n\t\t\t\t\t\t//faturar os Documentos de Saída (MATA461).\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//If AliasIndic(\"CFD\")\r\n\t\t\t\t\t\t\t//CFD->(DbSetOrder(3))   //Tabela de Ficha de Conteudo de Importação\r\n\t\t\t\t\t\t\t//If CFD->(DbSeek(xFilial(\"CFD\")+(cAliasSD2)->D2_FCICOD))\r\n\t\t\t\t\t\t\t\t//-----------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\t//Obs.: Retirado o valor da parcela importada devido ao Convênio 38/2013  CH: THHDRV\r\n\t\t\t\t\t\t\t\t//nValParImp\t:= IIf(CFD->(FieldPos(\"CFD_VPARIM\")) > 0,CFD->CFD_VPARIM, 0)         \r\n\t\t\t\t\t\t\t\t//-----------------------------------------------------------------------------------\r\n\t\t\t\t\t\t\t\t//nContImp\t:= IIf(CFD->(FieldPos(\"CFD_CONIMP\")) > 0,CFD->CFD_CONIMP, 0)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//cInfAdic  += cMsgFci + \", Valor da Parcela Importada R$ \"+ ConvType(nValParImp, 11,2)+ \", Conteudo de Importacao \" + ConvType(nContImp, 11,2) + \"% , Numero da FCI \" + Alltrim((cAliasSD2)->D2_FCICOD)\r\n\t\t\t\t\t\t\t\t//cInfAdic  += cMsgFci + \", Conteudo de Importacao \" + ConvType(nContImp, 11,2) + \"% , Numero da FCI \" + Alltrim((cAliasSD2)->D2_FCICOD)\r\n\t\t\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\r\n\t\t\t\t\t\t//Preencher o campo C6_VLIMPOR com o valor da Importação para popular o D2_VLIMPOR\r\n\t\t\t\t\t\t//Obs.: Somente preencher nos casos em que não utilize RASTRO, caso utilize será\r\n\t\t\t\t\t\t//      populado automaticamente.\r\n\t\t\t\t\t\t//--------------------------------------------------------------------------------\t\r\n\t\t\t\t\t\t//ElseIf (cAliasSD2)->(FieldPos(\"D2_VLIMPOR\")) > 0 .And. !Empty((cAliasSD2)->D2_VLIMPOR)\r\n\t\t\t\t\t\t\t//cInfAdic  += cMsgFci + \", Valor da Importacao R$ \" + ConvType((cAliasSD2)->D2_VLIMPOR, 11,2)\r\n\t\t\t\t\t\t//EndIf\r\n\t\r\n\t\t\t\t\t\t//Adequação NT2013/003 - Verifica se o valor será composto da tabela SBZ ou SB1\r\n\t\t\t\t\t\tnAliqNcm := 0\r\n\t\t\t\t\t\tIf lCpoAlqSBZ .And. lCpoAlqSB1   \r\n\t\t\t\t\t\t\tnAliqNcm := RetFldProd(cCodProd,\"B1_IMPNCM\",\"SB1\")\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !empty(nAliqNcm) .and. nAliqNcm == 0 .And. lCpoAlqSB1   \t \r\n\t\t\t\t\t\t\tnAliqNcm:=  SB1->B1_IMPNCM\r\n\t\t\t\t\t\tEndIf\t\r\n\t\t\t            \t\t            \r\n\t\t\t            If lCpoMsgLT .And. lCpoLoteFor .And. SF4->F4_MSGLT $ \"1\" \r\n\t\t\t\t\t\t\tcNumLotForn := Alltrim(Posicione(\"SB8\",2,xFilial(\"SB8\")+(cAliasSD2)->D2_NUMLOTE+(cAliasSD2)->D2_LOTECTL+cCodProd,\"B8_LOTEFOR\"))\r\n\t\t\t\t\t\t\tif !Empty(cNumLotForn)\r\n\t\t\t\t\t\t\t\tcInfAdic := \"LOTE:\"+cNumLotForn+\" \"+cInfAdic\r\n\t\t\t\t\t\t\tEndIf\t\t\t            \t            \t\t             \r\n\t\t\t            endif  \r\n\t\t\t            \r\n\t\t\t            //Verifica fonte carga tributária\r\n\t\t\t            \t            \r\n\t\t\t            If cMvMsgTrib $ \"1-3\"\r\n\t\t\t            \tIf lIntegHtl //Integracao Hotelaria\r\n                                cFntCtrb := SF2->F2_LTRAN \r\n                            Else\r\n\t\t\t\t            \tIf cMvFisCTrb ==\"1\"\r\n\t\t\t\t\t            \tIf FindFunction(\"AlqLeiTran\")\t\t            \t\t\r\n\t\t\t\t\t            \t\tcFntCtrb := AlqLeiTran(\"SB1\",\"SBZ\" )[2]\t\t\t            \t\t\r\n\t\t\t\t\t            \tEndIf\r\n\t\t\t\t\t            \tIf Empty(cFntCtrb) .And. !Empty(cMvFntCtrb).And. !cFntCtrb $ \"IBPT\"\r\n\t\t\t\t\t\t             \tcFntCtrb := cMvFntCtrb\r\n\t\t\t\t\t\t            EndIf \r\n\t\t\t\t            \tElse\r\n\t\t\t\t            \t\tIf Empty(cFntCtrb) .And. !Empty(cMvFntCtrb)\r\n\t\t\t\t\t\t             \tcFntCtrb := cMvFntCtrb\r\n\t\t\t\t\t\t            EndIf \r\n\t\t\t\t            \tEndIf\r\n\t\t\t\t            EndIf\r\n\t\t\t            EndIf\r\n\t\t\t            \r\n\t\t\t            \r\n\t\t\t          \t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³  ³Código de Benefício Fiscal na UF aplicado ao item\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \r\n\t\t\t\t\t\tIf lNfCupNFCE\r\n\t\t\t\t\t\t\tcTpEspcBen := 'NFCE'\r\n\t\t\t\t\t\tElseIf lNfCupSAT\r\n\t\t\t\t\t\t\tcTpEspcBen := 'SATCE'\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcTpEspcBen := 'SPED'\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tlCodLan := .F.\r\n\t\t\t\t\t\tIf SM0->M0_ESTENT $ \"PR/RJ/RS/\" //TAG cBenef buscar o conteúdo da tabela 5.2 no sistema quando for do PR.\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDV\")\r\n\t\t\t\t\t\t\tdbSetOrder(4) //CDV_FILIAL+CDV_TPMOVI+CDV_ESPECI+CDV_FORMUL+CDV_DOC+CDV_SERIE+CDV_CLIFOR+CDV_LOJA+CDV_NUMITE+CDV_SEQ+CDV_CODAJU\r\n\t\t\t\t\t\t\tcCodlan := \"\"\r\n\t\t\t\t\t\t\tIf MsSeek(xFilial(\"CDV\") +'S'+PadR(cTpEspcBen,TamSX3(\"CDV_ESPECI\")[1])+'S'+(cAliasSD2)->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_ITEM))\r\n\t\t\t\t\t\t\t\t//Tratamento realizado enquanto o fiscal não realiza a criação do campo na CDV\r\n\t\t\t\t\t\t\t\tif CDV->(ColumnPos(\"CDV_NFE\")) > 0\r\n\t\t\t\t\t\t\t\t\tif CDV->CDV_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"CDY\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf CDV->(ColumnPos(\"CDV_CODAJU\")) > 0 .and. !Empty(CDV->CDV_CODAJU) .and. MsSeek( xFilial(\"CDY\") + CDV->CDV_CODAJU)\r\n\t\t\t\t\t\t\t\t\t\tIf CDY->CDY_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\t\tendif\t\r\n\r\n\t\t\t\t\t\t\t\tif lCodLan\r\n\t\t\t\t\t\t\t\t\tcCodlan:= CDV->CDV_CODAJU\r\n\t\t\t\t\t\t\t\tendif\t\r\n\t\t\t\t\t\t\telse \r\n\t\t\t\t\t\t\t\tcCodlan := getCodLan( alltrim(SM0->M0_ESTENT), SF4->F4_SITTRIB, cAmbiente )\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcCodlan := \"\"\t\r\n\t\t\t\t\t\t\tIf SM0->M0_ESTENT <> \"SP\" .and. CDA->(ColumnPos(\"CDA_CODLAN\")) > 0\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"CDA\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1) //CDA_FILIAL+CDA_TPMOVI+CDA_ESPECI+CDA_FORMUL+CDA_NUMERO+CDA_SERIE+CDA_CLIFOR+CDA_LOJA+CDA_NUMITE+CDA_SEQ+CDA_CODLAN+CDA_CALPRO\r\n\t\t\t\t\t\t\t\tcSeekCDA := xFilial(\"CDA\") + 'S' + PadR(cTpEspcBen,TamSX3(\"CDA_ESPECI\")[1]) + 'S' + (cAliasSD2)->(D2_DOC+D2_SERIE+D2_CLIENTE+D2_LOJA+D2_ITEM)\r\n\t\t\t\t\t\t\t\tIf CDA->(MsSeek(cSeekCDA))\r\n\t\t\t\t\t\t\t\t\tWhile alltrim(cSeekCDA) == alltrim(CDA->(CDA_FILIAL + CDA_TPMOVI + CDA_ESPECI + CDA_FORMUL + CDA_NUMERO + CDA_SERIE + CDA_CLIFOR + CDA_LOJA + CDA_NUMITE))\r\n\t\t\t\t\t\t\t\t\t\tIf !Empty(CDA->CDA_CODLAN) .And. Len(AllTrim(CDA->CDA_CODLAN)) == 10\r\n\t\t\t\t\t\t\t\t\t\t\tcCodlan := CDA->CDA_CODLAN\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\tCDA->(dbSkip())\r\n\t\t\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t          \t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³  Indicador de Produção em escala relevante, conforme Cláusula 23 do Convenio ICMS 52/2017\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \t\t\t\t\t\t\r\n\t\t\t\t\t\tIf AliasIndic(\"D3E\")\r\n\t\t\t\t\t\t\tdbSelectArea(\"D3E\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tcIndEscala :=\"\"\r\n\t\t\t\t\t\t\tIf MsSeek(PADR(xFilial(\"D3E\"),TAMSX3(\"D3E_FILIAL\")[1]) +(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\t\tIf D3E->(ColumnPos(\"D3E_INDESC\")) > 0\r\n\t\t\t\t\t\t\t\t\tIf\t!Empty(D3E->D3E_INDESC)  .AND.  D3E->D3E_INDESC == \"1\"\r\n\t\t\t\t\t\t\t\t\t\tcIndEscala:= \"S\"\r\n\t\t\t\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cD2Cfop)\r\n\r\n\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO <> 'D') .Or. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM)\r\n\t\t\t\t\t\t\tlIPIOutro:=.F.\r\n\t\t\t\t\t\tEnd\r\n                        \r\n\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO <> 'B')\r\n\t\t\t\t\t\t\tlIPIOutB :=.F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t   \r\n\t\t\t\t\t\tnValOutr  := 0\r\n\t\t\t\t\t\t//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).E devolução com IPI. (Nota de compl.Ipi de uma devolução de compra(MV_IPIDEV=F) leva o IPI em voutros)\t\r\n\t\t\t\t\t\tIF((cAliasSD2)->D2_TIPO == \"D\" .And. (!lIpiDev .Or. lIPIOutro)) .Or. lConsig .Or. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM ) .or. ((cAliasSD2)->D2_TIPO == \"B\" .and. lIpiBenef) .or. ((cAliasSD2)->D2_TIPO==\"P\" .And. lComplDev .And. !lIpiDev)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO  == \"D\" .and.  lIPIOutro ) .or. ((cAliasSD2)->D2_TIPO  == \"B\" .and. lIPIOutB)\r\n\t\t\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n                            EndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\t\t\tnValOutr += 0\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tnValOutr +=(cAliasSD2)->D2_VALIPI\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\t\r\n\r\n\t\t\t\t\t\tnValOutr += (cAliasSD2)->D2_DESPESA + (cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3 + nIcmsST + nCrdPres\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcTpOrig  := IIF(nCountIT > 0 .And. Len(aNfVinc[nCountIT]) > 9, aNfVinc[nCountIT][10], \"\") //Pegar tipo da nota de origem\r\n\t\t\t\t\t\t\r\n\t\t\t           \t//BRUNO\r\n\t\t\t\t\t\tcF2Tipo\t:= IIF(!Empty(aNota[5]),aNota[5], \"N\")\r\n\t\t\t           \t\t            \t\t\r\n\t\t\t\t\t\taAdd(aInfoItem,{(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV,(cAliasSD2)->D2_TES,(cAliasSD2)->D2_ITEM})\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf aDest[09] == \"DF\"\r\n\t\t\t\t\t\t\tIf Substr(SB1->B1_POSIPI,1,4) $ \"2401|2402|2403|2203\" .Or. Substr(SB1->B1_POSIPI,1,6) $ \"210690|220290\"\r\n\t\t\t\t\t\t\t\tlNCMOk := .T.\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tBruno SigawiSe\r\n\t\t\t\t\t\tse for a itinga a chamada e orignal \r\n\t\t\t\t\t\tse for qualita muda a função U_RETPESOFAT\r\n\t\t\t\t\t\tAlert(SC5->C5_NUM)\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SubString(CNUMEMP,1,2) == \"05\" .OR. !SubString(AllTrim(SB1->B1_COD),1,2) $  'CH/AM' .OR. SC5->C5_YTIPO $ \"MI/TF\"\r\n\t\t\t\t\t\t\r\n\t\t\t\t   \t\t   aadd(aProd,\t{Len(aProd)+1,;\r\n\t\t\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\t\t\tSB1->B1_POSIPI,;//Retirada validação do parametro MV_CAPPROD, de acordo com a NT2014/004 não é mais possível informar o capítulo do NCM\r\n\t\t\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t\t\tcD2Cfop,;\r\n\t\t\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_QUANT,;\r\n\t\t\t\t\t\t\t\tIIF(!((cAliasSD2)->D2_TIPO$\"IP\" .Or. ((cAliasSD2)->D2_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,IIF(!(lMvNFLeiZF),(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR-nDesVrIcms,(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR - ((cAliasSD2)->D2_DESCZFP+(cAliasSD2)->D2_DESCZFC+nDesVrIcms)),IIF(((cAliasSD2)->D2_TIPO==\"I\" .And. SF4->F4_AJUSTE == \"S\" .And. \"RESSARCIMENTO\" $ Upper(cNatOper) .And. \"RESSARCIMENTO\" $ Upper(cDescProd)),(cAliasSD2)->D2_TOTAL,0)),;\r\n\t\t\t\t\t\t\t\tretUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\t\t\tretQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), nConvDip, (cAliasSD2)->D2_QUANT ),;    //retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_CONVDIP, (cAliasSD2)->D2_QUANT ),;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_VALFRE,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_SEGURO,;\r\n\t\t\t\t\t\t\t\t(nDesconto+nDescIcm+nDescRed+nDescNfDup+nDescFis),;\r\n\t\t\t\t\t\t\t\t0,;// O valor unitario sera obtido pela divisao do valor do produto pela quantidade comercial de acordo com o  Manual do Contribuinte 6.00 realizado na tag <vUnCom>(ConvType(aProd[10]/aProd[09],21,8)) \r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_NUMLOTE,;//Numero do Lote\r\n\t\t\t\t\t\t\t   \tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).E devolução com IPI. (Nota de compl.Ipi de uma devolução de compra(MV_IPIDEV=F) leva o IPI em voutros)\r\n\t\t\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\t\t\tIIF((SF4->F4_AGREG='N' .And. !AllTrim(SF4->F4_CF) $ cMVCfopTran) .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\"),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_TES,;\r\n\t\t\t\t\t\t\t\tIIF(SB5->(FieldPos(\"B5_PROTCON\"))<>0,SB5->B5_PROTCON,\"\"),; //Campo criado para informar protocolo ou convenio ICMS \r\n\t\t\t\t\t\t\t\tIIf(SubStr(SM0->M0_CODMUN,1,2) == \"35\" .And. cTpPessoa == \"EP\" .And. nDescIcm > 0, nDescIcm,0),;   \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTIMP\"))<>0,(cAliasSD2)->D2_TOTIMP,0),;   //aProd[30] - Total imposto carga tributária. \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFP,;\t\t\t//aProd[31] - Desconto Zona Franca PIS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFC,;\t\t\t//aProd[32] - Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PICM,;\t\t//aProd[33] - Percentual de ICMS\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;  //aProd[34]\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTFED\"))<>0,(cAliasSD2)->D2_TOTFED,0),;   //aProd[35] - Total carga tributária Federal\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTEST\"))<>0,(cAliasSD2)->D2_TOTEST,0),;   //aProd[36] - Total carga tributária Estadual\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTMUN\"))<>0,(cAliasSD2)->D2_TOTMUN,0),;   //aProd[37] - Total carga tributária Municipal\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PEDIDO,;\t //aProd[38] \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_ITEMPV,;\t //aProd[39] \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_GRPCST\")) > 0 .and. !Empty((cAliasSD2)->D2_GRPCST),(cAliasSD2)->D2_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //aProd[40]\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aProd[41] NT2015/003\r\n\t\t\t\t\t\t\t\t\"\",; //aprod[42] apenas na entrada é utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\t\t\tnValIFecp,; //aprod[43]  Valor do FECP.\r\n\t\t\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),;//aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),;  //aprod[46]\r\n\t\t\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\t\t\tSF4->F4_ART274,;  //aprod[48]\r\n\t\t\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taadd(aProd,\t{Len(aProd)+1,;\r\n\t\t\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\t\t\tSB1->B1_POSIPI,;//Retirada validação do parametro MV_CAPPROD, de acordo com a NT2014/004 não é mais possível informar o capítulo do NCM\r\n\t\t\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t\t\tcD2Cfop,;\r\n\t\t\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_QUANT,;\r\n\t\t\t\t\t\t\t\tIIF(!((cAliasSD2)->D2_TIPO$\"IP\" .Or. ((cAliasSD2)->D2_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,IIF(!(lMvNFLeiZF),(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR-nDesVrIcms,(cAliasSD2)->D2_TOTAL+nDesconto+(cAliasSD2)->D2_DESCZFR - ((cAliasSD2)->D2_DESCZFP+(cAliasSD2)->D2_DESCZFC+nDesVrIcms)),IIF(((cAliasSD2)->D2_TIPO==\"I\" .And. SF4->F4_AJUSTE == \"S\" .And. \"RESSARCIMENTO\" $ Upper(cNatOper) .And. \"RESSARCIMENTO\" $ Upper(cDescProd)),(cAliasSD2)->D2_TOTAL,0)),;\r\n\t\t\t\t\t\t\t\tretUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\t\t\tIIf(cF2Tipo == \"B\",retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_CONVDIP, (cAliasSD2)->D2_QUANT ),U_RETPESOFAT((cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV)  ),; \t\t\t// BRUNO SIGAWISE retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD2)->D2_CF), SB5->B5_CONVDIP, (cAliasSD2)->D2_QUANT )\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_VALFRE,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_SEGURO,;\r\n\t\t\t\t\t\t\t\t(nDesconto+nDescIcm+nDescRed+nDescNfDup+nDescFis),;\r\n\t\t\t\t\t\t\t\t0,;// O valor unitario sera obtido pela divisao do valor do produto pela quantidade comercial de acordo com o  Manual do Contribuinte 6.00 realizado na tag <vUnCom>(ConvType(aProd[10]/aProd[09],21,8)) \r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_NUMLOTE,;//Numero do Lote\r\n\t\t\t\t\t\t\t   \tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).E devolução com IPI. (Nota de compl.Ipi de uma devolução de compra(MV_IPIDEV=F) leva o IPI em voutros)\r\n\t\t\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\t\t\tIIF((SF4->F4_AGREG='N' .And. !AllTrim(SF4->F4_CF) $ cMVCfopTran) .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\"),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_TES,;\r\n\t\t\t\t\t\t\t\tIIF(SB5->(FieldPos(\"B5_PROTCON\"))<>0,SB5->B5_PROTCON,\"\"),; //Campo criado para informar protocolo ou convenio ICMS \r\n\t\t\t\t\t\t\t\tIIf(SubStr(SM0->M0_CODMUN,1,2) == \"35\" .And. cTpPessoa == \"EP\" .And. nDescIcm > 0, nDescIcm,0),;   \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTIMP\"))<>0,(cAliasSD2)->D2_TOTIMP,0),;   //aProd[30] - Total imposto carga tributária. \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFP,;\t\t\t//aProd[31] - Desconto Zona Franca PIS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_DESCZFC,;\t\t\t//aProd[32] - Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PICM,;\t\t//aProd[33] - Percentual de ICMS\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;  //aProd[34]\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTFED\"))<>0,(cAliasSD2)->D2_TOTFED,0),;   //aProd[35] - Total carga tributária Federal\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTEST\"))<>0,(cAliasSD2)->D2_TOTEST,0),;   //aProd[36] - Total carga tributária Estadual\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_TOTMUN\"))<>0,(cAliasSD2)->D2_TOTMUN,0),;   //aProd[37] - Total carga tributária Municipal\r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_PEDIDO,;\t //aProd[38] \r\n\t\t\t\t\t\t\t\t(cAliasSD2)->D2_ITEMPV,;\t //aProd[39] \r\n\t\t\t\t\t\t\t\tIIF((cAliasSD2)->(FieldPos(\"D2_GRPCST\")) > 0 .and. !Empty((cAliasSD2)->D2_GRPCST),(cAliasSD2)->D2_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //aProd[40]\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aProd[41] NT2015/003\r\n\t\t\t\t\t\t\t\t\"\",; //aprod[42] apenas na entrada é utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\t\t\tnValIFecp,; //aprod[43]  Valor do FECP.\r\n\t\t\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),;//aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),;  //aprod[46]\r\n\t\t\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\t\t\tSF4->F4_ART274,;  //aprod[48]\r\n\t\t\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aCST,{cCSTrib,cOrigem})\r\n\t\t\t\t\t\taadd(aICMS,{})\r\n\t\t\t\t\t\taadd(aIPI,{})\r\n\t\t\t\t\t\taadd(aICMSST,{})\r\n\t\t\t\t\t\taadd(aPIS,{})\r\n\t\t\t\t\t\taadd(aPISST,{})\r\n\t\t\t\t\t\taadd(aCOFINS,{})\r\n\t\t\t\t\t\taadd(aCOFINSST,{})\r\n\t\t\t\t\t\taadd(aISSQN,{})\r\n\t\t\t\t\t\taadd(aAdi,{})\r\n\t\t\t\t\t\taadd(aDi,{})\r\n\t\t\t\t\t\taadd(aICMUFDest,{})\r\n\t\t\t\t\t\taadd(aIPIDevol,{})\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//aadd(aPedCom,{})\r\n\t\t\t\t\t\taadd(aPisAlqZ,{})\r\n\t\t\t\t\t\taadd(aCofAlqZ,{})\r\n\t\t\t\t\t\taadd(aCsosn,{})\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcNCM := SB1->B1_POSIPI\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para TAG Exportação quando existe a integração com a EEC     ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf lEECFAT\r\n\t\t\t\t\t\t\t/*Alterações TQXWO2\r\n\t\t\t\t\t\t\tNa chamada da função, foram criados dois novos parâmetros: \r\n\t\t\t\t\t\t\to 3º referente ao código do produto e o 4º referente ao número da nota fiscal + série (chave).\r\n\t\t\t\t\t\t\tGetNfeExp(pProcesso, pPedido, cProduto, cChave)\r\n\t\t\t\t\t\t\tNo retorno da função serão devolvidas as informações do legado, conforme leiaute anterior à versão 3.10 , \r\n\t\t\t\t\t\t\te as informações dos grupos “I03 - Produtos e Serviços / Grupo de Exportação” e “ZA - Informações de Comércio Exterior”, conforme estrutura da NT20013.005_v1.21.\r\n\t\t\t\t\t\t\tAs posições 1 e 2 mantém o retorno das informações ZA02 e ZA03, mantendo o legado para os cliente que utilizam versão 2.00\r\n\t\t\t\t\t\t\tNa posição 3 passa a ser enviado o agrupamento do ID I50, tendo como filhos os IDs I51 e I52.\r\n\t\t\t\t\t\t\tNa posição 4 passa a ser enviado o agrupamento do ZA01, tendo como filhos os IDs ZA02, ZA03 e ZA04.\r\n\t\t\t\t\t\t\tNa posição 5 passa a ser enviado informaçãoes para o grupo \"BA02 - Chaves Nfe referenciadas\" as chaves de notas fiscais de saída de lote de exportação associadas à nota de saída de exportação.\r\n\t\t\t\t\t\t\tO array de retorno será multimensional, trazendo na primeira posição o identificador (ID), \r\n\t\t\t\t\t\t\tna segunda posição a tag (o campo) e na terceira posição o conteúdo retornado do processo, \r\n\t\t\t\t\t\t\tpodendo ser um outro array com a mesma estrutura caso o ID possua abaixo de sua estrutura outros IDs. \t\t\t\t\t\t \t\t\t\t\r\n\t\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t\t/*Alterações TUSHX4\r\n\t\t\t\t\t\t\tFoi incluido o parametro D2_LOTECTL para que a função localize as notas de entrada (produto com lote e endereçamento) amarradas no pedido de exportção e consiga\r\n\t\t\t\t\t\t\tretornar o array de exportind de acordo com a quantidade de cada item da SD2, para não ocorrer a rejeição \r\n\t\t\t\t\t\t\t346 Somatório das quantidades informadas na Exportação Indireta não correspondem a quantidade do item.*/\r\n\t\t\t\t\t\t\tIf !Empty((cAliasSD2)->D2_PREEMB)\r\n\t\t\t\t\t\t\t\taadd(aExp,(GETNFEEXP((cAliasSD2)->D2_PREEMB,,cCodProd,(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE,(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV,(cAliasSD2)->D2_LOTECTL)))\r\n\t\t\t\t\t\t\tElseIf !Empty(SC5->C5_PEDEXP)\r\n\t\t\t\t\t\t\t\taADD(aExp,(GETNFEEXP(,SC5->C5_PEDEXP,cCodProd,(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE,(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV,(cAliasSD2)->D2_LOTECTL)))\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tElseiF AliasIndic(\"CDL\")\r\n\t\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\t\tDbSelectArea(\"CDL\")\r\n\t\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\tDbSeek(xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\t\t\t\t\t\tWhile !CDL->(Eof()) .And. CDL->CDL_FILIAL+CDL->CDL_DOC+CDL->CDL_SERIE+CDL->CDL_CLIENT+CDL->CDL_LOJA == xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA\r\n\t\t\t\t\t\t    \tIf CDL->(FieldPos(\"CDL_PRODNF\")) <> 0 .And. CDL->(FieldPos(\"CDL_ITEMNF\")) <> 0 .And. AllTrim(CDL->CDL_PRODNF)+AllTrim(CDL->CDL_ITEMNF) == AllTrim((cAliasSD2)->D2_COD)+AllTrim((cAliasSD2)->D2_ITEM)\r\n\t\t\t\t\t\t\t    \taDados := {}\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"ZA02\",\"ufEmbarq\"  , IIF(CDL->(FieldPos(\"CDL_UFEMB\"))<>0 , CDL->CDL_UFEMB  ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"ZA03\",\"xLocEmbarq\", IIF(CDL->(FieldPos(\"CDL_LOCEMB\"))<>0, CDL->CDL_LOCEMB ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I51\",\"nDraw\", IIF(CDL->(FieldPos(\"CDL_ACDRAW\"))<>0, CDL->CDL_ACDRAW ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I53\",\"nRE\", IIF(CDL->(FieldPos(\"CDL_NRREG\"))<>0, CDL->CDL_NRREG ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I54\",\"chNFe\", IIF(CDL->(FieldPos(\"CDL_CHVEXP\"))<>0, CDL->CDL_CHVEXP ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"I55\",\"qExport\", IIF(CDL->(FieldPos(\"CDL_QTDEXP\"))<>0, CDL->CDL_QTDEXP ,\"\") })\r\n\t\t\t\t\t\t\t    \taAdd(aDados,{\"ZA04\",\"xLocDespacho\", IIF(CDL->(FieldPos(\"CDL_LOCDES\"))<>0, CDL->CDL_LOCDES ,\"\") })\r\n\t\t\t\t\t\t\t\t\taAdd(aDados,{\"NAT_EXP\",\"Natureza\", IIF(CDL->(FieldPos(\"CDL_NATEXP\"))<>0, CDL->CDL_NATEXP ,\"\") }) //Adicionado para utilizar na verificação da montagem das tags do grupo de exportação indireta (I52 - exportind) substituindo o I53 - nRE.\r\n\r\n\t\t\t\t\t\t\t    \taAdd(aExp[Len(aExp)],aDados)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\t\t    \tCDL->(DbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0  .And. CD6->(FieldPos(\"CD6_BCCIDE\")) > 0 .And. CD6->(FieldPos(\"CD6_VALIQ\")) > 0 .And. CD6->(FieldPos(\"CD6_VCIDE\")) > 0\r\n\t\t\t\t\t\t\taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_UFCONS,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_BCCIDE,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_VALIQ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_VCIDE,;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_MIXGN\")) > 0,CD6->CD6_MIXGN,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_BICO\")) > 0,CD6->CD6_BICO,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_BOMBA\")) > 0,CD6->CD6_BOMBA,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_TANQUE\")) > 0,CD6->CD6_TANQUE,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_ENCINI\")) > 0,CD6->CD6_ENCINI,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_ENCFIN\")) > 0,CD6->CD6_ENCFIN,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_DESANP\")) > 0,CD6->CD6_DESANP,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_PGLP\")) > 0,CD6->CD6_PGLP,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_PGNN\")) > 0,CD6->CD6_PGNN,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_PGNI\")) > 0,CD6->CD6_PGNI,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD6->(ColumnPos(\"CD6_VPART\")) > 0,CD6->CD6_VPART,\"\"),;\r\n\t\t\t\t\t\t\t\tnBRICMSO,;\r\n\t\t\t\t\t\t\t\tnICMRETO,;\r\n\t\t\t\t\t\t\t\tnBRICMSD,;\r\n\t\t\t\t\t\t\t\tnICMRETD,;\r\n\t\t\t\t\t\t\t\tnAliqST})\r\n\r\n\t\t\t\t\t    Elseif AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0 \r\n\t\t\t\t\t    \taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_UFCONS,; \r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\tnBRICMSO,;\r\n\t\t\t\t\t\t\t\tnICMRETO,; \r\n\t\t\t\t\t\t\t\tnBRICMSD,;\r\n\t\t\t\t\t\t\t\tnICMRETD,;\r\n\t\t\t\t\t\t\t\tnAliqST})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aComb,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf AliasIndic(\"CD7\")\r\n\t\t\t\t\t\t\taadd(aMed,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,CD7->CD7_PRECO,IIf(CD7->(ColumnPos(\"CD7_CODANV\")) > 0,CD7->CD7_CODANV,\"\"),IIf(CD7->(ColumnPos(\"CD7_MOTISE\")) > 0,CD7->CD7_MOTISE,\"\")})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aMed,{})\r\n\t\t\t   \t\t\tEndIf\r\n\t\t\t   \t\t\tIf AliasIndic(\"CD8\")\r\n\t\t\t\t\t\t\taadd(aArma,{CD8->CD8_TPARMA,CD8->CD8_NUMARM,CD8->CD8_DESCR})                       \r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aArma,{})\r\n\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\tIf AliasIndic(\"CD9\")    \t\r\n\t\t\t\t\t\t\taadd(aveicProd,{IIF(CD9->CD9_TPOPER$\"03\",1,IIF(CD9->CD9_TPOPER$\"1\",2,IIF(CD9->CD9_TPOPER$\"2\",3,IIF(CD9->CD9_TPOPER$\"9\",0,\"\")))),;\r\n\t\t\t\t\t\t\t\t\t\t\tCD9->CD9_CHASSI,CD9->CD9_CODCOR,CD9->CD9_DSCCOR,CD9->CD9_POTENC,CD9->CD9_CM3POT,CD9->CD9_PESOLI,;\r\n\t\t\t\t\t\t\t                CD9->CD9_PESOBR,CD9->CD9_SERIAL,CD9->CD9_TPCOMB,CD9->CD9_NMOTOR,CD9->CD9_CMKG,CD9->CD9_DISTEI,CD9->CD9_RENAVA,;\r\n\t\t\t\t\t\t\t                CD9->CD9_ANOMOD,CD9->CD9_ANOFAB,CD9->CD9_TPPINT,CD9->CD9_TPVEIC,CD9->CD9_ESPVEI,CD9->CD9_CONVIN,CD9->CD9_CONVEI,;\r\n\t\t\t\t\t\t\t                CD9->CD9_CODMOD,;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CILIND\")>0,CD9_CILIND,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_TRACAO\")>0,CD9_TRACAO,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_LOTAC\")>0,CD9_LOTAC,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CORDE\")>0,CD9_CORDE,\"\")),;\r\n\t\t\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_RESTR\")>0,CD9_RESTR,\"\"))})\r\n\t\t\t\t\t\t\tlVeicNovo:= (!empty(CD9->CD9_CHASSI))\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t    aadd(aveicProd,{})\r\n\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para Rastreamento de Lote - Cabecalho e Itens   \r\n\t\t\t\t\t\t//Primeiro busca no compl. de rastreabilidade (F0A) e  depois compl.de medicamento (CD7)                ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\r\n\t\t\t\t\t\tIf AliasIndic(\"F0A\") .AND. F0A->(FieldPos(\"F0A_LOTE\")) > 0 .And. !Empty(F0A->F0A_LOTE)\r\n\t\t\t\t\t\t\taadd(aLote,{IIf(F0A->(FieldPos(\"F0A_LOTE\")) > 0,F0A->F0A_LOTE,\"\"),;\r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_QTDLOT\")) > 0,F0A->F0A_QTDLOT,\"\"),;\r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_FABRIC\")) > 0,F0A->F0A_FABRIC,\"\"),;\r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_VALID\")) > 0,F0A->F0A_VALID ,\"\"),;  \r\n\t\t\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_CODAGR\")) > 0,F0A->F0A_CODAGR ,\"\")})  \r\n\t\t\t\t\t\tElseIf !Empty(aMed) .And. !Empty(aMed[1][1])\r\n\t\t\t\t\t\t\taadd(aLote,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,\"\"})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aLote,{})\r\n\t   \t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para Anfavea - Cabecalho e Itens                             ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\r\n\t\t\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t\t\t//Cabecalho\r\n\t\t\t\t\t\t\taAnfC := {}\r\n\t\t\t\t\t\t\taadd(aAnfC,{CDR->CDR_VERSAO,CDR->CDR_CDTRAN,CDR->CDR_NMTRAN,CDR->CDR_CDRECP,CDR->CDR_NMRECP,;\r\n\t\t\t\t\t\t\t\tAModNot(CDR->CDR_ESPEC),CDR->CDR_CDENT,CDR->CDR_DTENT,CDR->CDR_NUMINV}) \r\n\t\t\t\t\t\t\t//Itens\r\n\t\t\t\t\t\t\taadd(aAnfI,{CDS->CDS_PRODUT,CDS->CDS_PEDCOM,CDS->CDS_SGLPED,CDS->CDS_SEPPEN,CDS->CDS_TPFORN,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_UM,CDS->CDS_DTVALI,CDS->CDS_PEDREV,CDS->CDS_CDPAIS,CDS->CDS_PBRUTO,CDS->CDS_PLIQUI,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_TPCHAM,CDS->CDS_NUMCHA,CDS->CDS_DTCHAM,CDS->CDS_QTDEMB,CDS->CDS_QTDIT,CDS->CDS_LOCENT,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_PTUSO,CDS->CDS_TPTRAN,CDS->CDS_LOTE,CDS->CDS_CPI,CDS->CDS_NFEMB,CDS->CDS_SEREMB,;\r\n\t\t\t\t\t\t\t\tCDS->CDS_CDEMB,CDS->CDS_AUTFAT,CDS->CDS_CDITEM})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aAnfC,{})\r\n\t\t\t\t\t\t\taadd(aAnfI,{})\r\n\t\t\t   \t\t\tEndIf\t\t\t\t\r\n\t\r\n\t\t\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t\t\tIf !Empty(aAnfC) .And. !Empty(aAnfC[01,01]) .And. lCabAnf\r\n\t\t\t\t\t\t\t\tlCabAnf := .F.\r\n\t\t\t\t\t\t\t\tcAnfavea := '<![CDATA[[' \r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,01])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' <versao>' + allTrim(aAnfC[01,01]) + '</versao>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tcAnfavea += \t'<transmissor'\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,02])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' codigo=\"' + allTrim(aAnfC[01,02]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,03])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' nome=\"' + allTrim(aAnfC[01,03]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t    cAnfavea += '/><receptor'\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,04])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' codigo=\"' + allTrim(aAnfC[01,04]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,05])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t' nome=\"' + allTrim(aAnfC[01,05]) + '\"'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t    cAnfavea += '/>'\t\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,06])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<especieNF>' + allTrim(aAnfC[01,06]) + '</especieNF>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,07])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<fabEntrega>' + allTrim(aAnfC[01,07]) + '</fabEntrega>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,08])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<prevEntrega>' + allTrim(Dtos(aAnfC[01,08])) + '</prevEntrega>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tIf !Empty(aAnfC[01,09])\r\n\t\t\t\t\t\t\t\t\tcAnfavea += \t'<Invoice>' + allTrim(aAnfC[01,09]) + '</Invoice>'\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tcAnfavea +=\t']]>'\r\n\t\t\t\t\t\t\tEndif  \r\n\t\t\t\t\t\tEndif\r\n\t\r\n\t\t\t\t\t\tDbSelectArea(\"SF2\")\r\n\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SF2\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\t\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\t\tIf !(cAliasSD2)->D2_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tdbSetOrder(2)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t    \r\n\t\t\t\t\t    DbSelectArea(\"SFT\")\r\n\t\t\t\t\t    DbSetOrder(1)\r\n\t\t\t\t\t    If SFT->(DbSeek(xFilial(\"SFT\")+\"S\"+(cAliasSD2)->(D2_SERIE+D2_DOC+D2_CLIENTE+D2_LOJA+PadR(D2_ITEM,TamSx3(\"FT_ITEM\")[1])+D2_COD)))\r\n\t\t\t\t\t\t   If !Empty( SFT->FT_CTIPI )\r\n\t\t\t\t\t\t   \t\taadd(aCSTIPI,{SFT->FT_CTIPI})\r\n\t\t\t\t\t\t   EndIf\r\n\t\t\t\t\t\t   //TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t\t\t\t   //PEGA OS VALORES E PERCENTUAL DO INNCENTIVO NOS ITENS NA SFT.\r\n\t\t\t\t\t\t   If SFT->(FieldPos(\"FT_PRINCMG\")) > 0 .And. SFT->(FieldPos(\"FT_VLINCMG\")) > 0\r\n\t\t\t\t\t\t\t\tIf SFT->FT_VLINCMG > 0\r\n\t\t\t\t\t\t\t\t\tnValLeite += SFT->FT_VLINCMG\r\n\t\t\t\t\t\t\t\t\t aprod[Len(aProd)][49]:=  SFT->FT_VLINCMG\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tIf nPercLeite == 0 .And. SFT->FT_PRINCMG > 0 \r\n\t\t\t\t\t\t\t\t\tnPercLeite := SFT->FT_PRINCMG\r\n\t\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t     \r\n\t\t\t\t\t\tCD2->(dbSeek(xFilial(\"CD2\")+\"S\"+SF2->F2_SERIE+SF2->F2_DOC+SF2->F2_CLIENTE+SF2->F2_LOJA+PadR((cAliasSD2)->D2_ITEM,4)+(cAliasSD2)->D2_COD))\r\n\t\t\t\r\n\t\t\t\t\t\tWhile CD2->(!Eof()) .And. xFilial(\"CD2\") == CD2->CD2_FILIAL .And.;\r\n\t\t\t\t\t\t\t\"S\" == CD2->CD2_TPMOV .And.;\r\n\t\t\t\t\t\t\tSF2->F2_SERIE == CD2->CD2_SERIE .And.;\r\n\t\t\t\t\t\t\tSF2->F2_DOC == CD2->CD2_DOC .And.;\r\n\t\t\t\t\t\t\tSF2->F2_CLIENTE == IIF(!(cAliasSD2)->D2_TIPO $ \"DB\",CD2->CD2_CODCLI,CD2->CD2_CODFOR) .And.;\r\n\t\t\t\t\t\t\tSF2->F2_LOJA == IIF(!(cAliasSD2)->D2_TIPO $ \"DB\",CD2->CD2_LOJCLI,CD2->CD2_LOJFOR) .And.;\r\n\t\t\t\t\t\t\t(cAliasSD2)->D2_ITEM == SubStr(CD2->CD2_ITEM,1,Len((cAliasSD2)->D2_ITEM)) .And.;\r\n\t\t\t\t\t\t\tAlltrim((cAliasSD2)->D2_COD) == Alltrim(CD2->CD2_CODPRO)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t    nMargem :=  IiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC == 100,CD2->CD2_PREDBC,IF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC)),CD2->CD2_PREDBC)              \t\t \t\t\t\t\t\r\n\t\r\n\t\t\t\t\t\t\t/*DbSelectArea(\"SF7\")\t\t\t\t\r\n\t\t\t\t\t\t\tDbSetOrder(1)\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf DbSeek(xFilial(\"SF7\")+SB1->B1_GRTRIB+SA1->A1_GRPTRIB)\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf SF7->F7_BASEICM > 0\r\n\t\t\t\t\t\t\t\t\t\tnMargem := SF7->F7_BASEICM\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf*/\t\t\r\n\t\t\t\t\t\t\tnValtrib:= CD2->CD2_VLTRIB\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//Alterado conteudo da variavel de CD2->CD2_VLTRIB para SFT->FT_VOPDIF - Para pegar valor de diferimento - Devido atualizacao do Fiscal\r\n\t\t\t\t\t\t\tIf SubStr((cAliasSD2)->D2_CLASFIS,2,2) $ '51' .and. !Empty(SFT->FT_ICMSDIF) .and. SFT->(ColumnPos(\"FT_VOPDIF\")) > 0  .and. !Empty(SFT->FT_VOPDIF)\r\n\t\t\t\t\t\t\t\tnValtrib:= Iif(cVerAmb == \"4.00\".and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','SFT','FT_VOPDIF'),SFT->FT_VOPDIF)\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tElseIf SFT->(FieldPos(\"FT_TRFICM\")) <> 0 .And. SFT->FT_TRFICM <> 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) $ \"RS/GO\"\r\n\t\t\t\t\t\t\t\tnValtrib:= Iif(cVerAmb == \"4.00\".and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','SFT','FT_TRFICM'),SFT->FT_TRFICM)\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tnValtrib:= Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'),CD2->CD2_VLTRIB)\t\r\n\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Verifica se existe percentual de reducao na SFT referête ao RICMS 43080/2002 MG.\r\n\t\t\t\t\t\t\tIf SFT->(FieldPos(\"FT_PR43080\")) <> 0 .And. SFT->FT_PR43080 <> 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\t\t\t\tnMargem := SFT->FT_PR43080\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tDo Case\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ICM\"\r\n\t\t\t\t\t\t\t\t\taTail(aICMS) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t   If(lNfCupZero,SF4->F4_SITTRIB,CD2->CD2_CST),;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t   CD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t                   If(lNfCupZero,0,nMargem),;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t   If(lNfCupZero .Or. lIcmsPR,0,CD2->CD2_BC),;\r\n\t\t\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), If(lNfCupZero,0,Iif(CD2->CD2_BC>0,xFisRetFCP('4.0','CD2','CD2_ALIQ'),0)), If(lNfCupZero,0,Iif(CD2->CD2_BC>0,CD2->CD2_ALIQ,0))),;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero .Or. lIcmsPR,0,nValtrib),;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\"),;\r\n\t\t\t\t\t\t\t\t\tSFT->FT_ICMSDIF,;\r\n\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\tSF4->F4_ICMSDIF,;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,xFisRetFCP('4.0','CD2','CD2_BFCP'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,xFisRetFCP('4.0','CD2','CD2_PFCP'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,xFisRetFCP('4.0','CD2','CD2_VFCP'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BSTANT\")) > 0,SFT->FT_BSTANT,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_VSTANT'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_PSTANT'),0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BFCANTS\")) > 0,SFT->FT_BFCANTS,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PFCANTS\")) > 0,SFT->FT_PFCANTS,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VFCANTS\")) > 0,SFT->FT_VFCANTS,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VICPRST\")) > 0,SFT->FT_VICPRST,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,0)}\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\t\t\tnValICMParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\t\t\tnBasICMParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017) \r\n\t\t\t\t\t\t\t\t\tIf \tlIcmsPR \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tnToTvBC \t+= \tCD2->CD2_BC \t\t//aICMS[05]\t\r\n\t\t\t\t\t\t\t\t\t\tnToTvICMS\t+=\tCD2->CD2_VLTRIB\t//aICMS[07]   \r\n\t\t\t\t\t\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"SOL\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aICMSST) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero,SF4->F4_SITTRIB,CD2->CD2_CST),;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero,0,IiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC),CD2->CD2_PREDBC)),;\r\n\t\t\t\t\t\t\t\t\tIf(lNfCupZero,0,CD2->CD2_BC),;\r\n\t\t\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_ALIQ'), If(lNfCupZero,0,CD2->CD2_ALIQ)),; \r\n\t\t\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'), If(lNfCupZero,0,CD2->CD2_VLTRIB)),; \r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,CD2->CD2_BFCP,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,CD2->CD2_PFCP,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,CD2->CD2_VFCP,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\")}\r\n\r\n\t\t\t\t\t\t\t\t\tIf lConsig .And. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM)  .And. CD2->CD2_VLTRIB > 0\r\n\t\t\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\"))>0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\")}\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t\t\t\tlCalSol := .T.\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Tratamento CAT04 de 26/02/2010                       ³\r\n\t\t\t\t\t\t\t\t\t//³Verifica de deve ser garavado no xml o valor e base  ³\r\n\t\t\t\t\t\t\t\t\t//³de calculo do ICMS ST para notas fiscais de devolucao³\r\n\t\t\t\t\t\t\t\t\t//³Verifica o parametro MV_ICSTDEV                      ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tnValST \t:= Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'), CD2->CD2_VLTRIB)\r\n\t\t\t\t\t\t\t\t\t//para a 4.0 devera exibir a informação Valor do ICMS ST não majorado.\r\n\t\t\t\t\t\t\t\t\tIf cVerAmb == \"4.00\" .and. nValST > 0 .And. lConsig\r\n\t\t\t\t\t\t\t\t\t\tnSTConsig += nValST\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf !lIcmSTDev\r\n\t\t\t\t\t\t\t\t\t\tIf ( (cAliasSD2)->D2_TIPO==\"D\" .Or. ( (cAliasSD2)->D2_TIPO==\"I\" .And. lComplDev)) .And. !Empty(nValST) \r\n\t\t\t\t\t\t\t\t\t\t\tnValSTAux := nValSTAux + nValST\r\n\t\t\t\t\t\t\t\t\t\t\tnBsCalcST := nBsCalcST + CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\t\t\tnValST \t  := 0\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\"))>0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\")}\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\t\t\tnValSTParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\t\t\tnBasSTParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"IPI\"\r\n\t\t\t\t\t\t\t\t\t//If !lConsig\r\n\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,;\r\n\t\t\t\t\t\t\t\t\t\tSB1->B1_CLASSE,;\r\n\t\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),; //NT2015/002\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_BC,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_ALIQ,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_VLTRIB,;\r\n\t\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t\tIiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC),CD2->CD2_PREDBC)}\r\n\t\t\t\t\t\t\t\t\t\tnValIPI := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\t\t\tIf (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .And. !Empty(nValIPI) \r\n\t\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0  .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,0,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,0}\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\tIf (!lIpiDev .OR. lIPIOutro) .And. !(Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM) .OR. ((cAliasSD2)->D2_TIPO==\"B\" .And. (lIpiBenef .OR. lIPIOutB))  \r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tIf ( (cAliasSD2)->D2_TIPO==\"B\" .And. lIpiBenef .and. !Empty(nValIPI) )\r\n\t\t\t\t\t\t\t\t\t\t\t\tnValIpiBene += nValIPI  // Quando lIpiBenef = T leva IPI em vOutro e Inf. Adic.\r\n\t\t\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,0,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,0}\r\n\t\t\t\t\t\t\t\t\t\t\tElseIf ( (cAliasSD2)->D2_TIPO==\"D\" .And. !Empty(nValIPI) ).OR. ( (cAliasSD2)->D2_TIPO==\"P\" .And. lComplDev .And. !Empty(nValIPI) ) \r\n\t\t\t\t\t\t\t\t\t\t\t\taAdd(aIPIDev, {nValIPI,cNCM})\r\n\t\t\t\t\t\t\t\t\t\t\t\tnValIPI := 0\r\n\t\t\t\t\t\t\t\t\t\t\t\tcNCM\t:= \"\"\r\n\t\t\t\t\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,0,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,0}\r\n\t\t\t\t\t\t\t\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t\t\t/*Chamado TTVZJG - Grupo impostoDevol - informar o percentual e valor do IPI devolvido, em notas de devolução (finNFe =4)\r\n\t\t\t\t\t\t\t\tIncluida a verificação do campo F4_PODER3=D para os casos de retorno de beneficiamento*/\r\n\t\t\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO == \"D\" .or. SF4->F4_PODER3 == \"D\") .and. ((CD2->(FieldPos(\"CD2_PDEVOL\")) > 0 .and. !Empty(CD2->CD2_PDEVOL) .Or. (SF4->F4_QTDZERO == \"1\")) .And. cTPNota == \"4\")\r\n\t\t\t\t\t\t\t\t\tIf (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM ) \r\n\t\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\t\tElseIf cVerAmb >= \"4.00\" .and. (((cAliasSD2)->D2_TIPO == \"D\" .and. (lIpiDev .Or. lIPIOutro)) .or. ((cAliasSD2)->D2_TIPO == \"B\" .and. (!lIpiBenef .or. lIPIOutB))) \r\n\t\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,0}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS2\"\r\n\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\taTail(aPIS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tIf aAgrPis[Len(aAgrPis)][1]\r\n\t\t\t\t\t\t\t\t\t\t\taAgrPis[Len(aAgrPis)][2] := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aPIS) := {SF4->F4_CSTPIS,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF2\"\r\n\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\taTail(aCOFINS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tIf aAgrCofins[Len(aAgrCofins)][1]\r\n\t\t\t\t\t\t\t\t\t\t\taAgrCofins[Len(aAgrCofins)][2] := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aCOFINS) := {SF4->F4_CSTCOF,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS3\" .And. (cAliasSD2)->D2_VALISS==0\r\n\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\taTail(aPISST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\taTail(aPISST) := {SF4->F4_CSTPIS,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\t\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF3\" .And. (cAliasSD2)->D2_VALISS==0\r\n\t\t\t\t\t\t\t\t\t\tIf !lNfCupZero\r\n\t\t\t\t\t\t\t\t\t\t\taTail(aCOFINSST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\taTail(aCOFINSST) := {SF4->F4_CSTCOF,0,0,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ISS\" \r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\taISS[01] += (cAliasSD2)->D2_TOTAL+(cAliasSD2)->D2_DESCON\r\n\t\t\t\t\t\t\t\t\taISS[02] += CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\taISS[03] += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\t\t\tcMunISS := ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[09]})][02]+aDest[07])\r\n\t\t\t\t\t\t\t\t\t/* (Inicio) Alterado em 04/04/2019 por Felipe Azevedo - Desenvolvimento TSS NFS-e\r\n\t\t\t\t\t\t\t\t\t//\r\n\t\t\t\t\t\t\t\t\t//Conjunto de Alterações 229221 - Aline Yumi Kokumai - 21/05/2014 18:27:45 - Inclusão do fonte para manter o histórico.\r\n\r\n\t\t\t\t\t\t\t\t\tA condição da validação do Codigo do ISS passou a ser Verdadeira (.T.) \r\n\t\t\t\t\t\t\t\t\tdevido as rotinas do REINF ter começado a popular a tabela CDN causando\r\n\t\t\t\t\t\t\t\t\terro em municipios especificos.\r\n\t\t\t\t\t\t\t\t\tPortanto será mantido o legado da tabela CDN, porém para emissão de NF-e\r\n\t\t\t\t\t\t\t\t\tconjugada será considerado o \"Código de serviço da Nota fiscal eletônica\" (SD2).\r\n\r\n\t\t\t\t\t\t\t\t\t[Antes]\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t\tcCodIss := AllTrim((cAliasSD2)->D2_CODISS)\r\n\t\t\t\t\t\t\t\t\tIf AliasIndic(\"CDN\") .And. CDN->(dbSeek(xFilial(\"CDN\")+cCodIss))\r\n\t\t\t\t\t\t\t\t\t\tcCodIss := AllTrim(CDN->CDN_CODLST)\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t[Depois] */\r\n\t\t\t\t\t\t\t\t\tcCodIss := AllTrim((cAliasSD2)->D2_CODISS)\r\n\t\t\t\t\t\t\t\t\tIf AliasIndic(\"CDN\") .And. CDN->(dbSeek(xFilial(\"CDN\")+cCodIss))\r\n\t\t\t\t\t\t\t\t\t\tcCodIss := AllTrim(CDN->CDN_CODISS)\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t//\r\n\t\t\t\t\t\t\t\t\t// (Fim) Alterado em 04/04/2019 por Felipe Azevedo - Desenvolvimento TSS NFS-e\r\n\t\t\t\t\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\t\t\t\t\t\t\t  \r\n\t\t\t\t\t\t\t\t\t\tIf SF3->F3_RECISS ==\"1\" \r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib := \"R\"\r\n\t\t\t\t\t\t\t\t\t\tElseif SF3->F3_RECISS ==\"2\" //.and. ( !SF4->F4_LFISS == \"I\" .and. !SM0->M0_ESTENT == \"\" )\r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\t\t\tElseif SF4->F4_LFISS ==\"I\"\r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib:= \"I\"\r\n\t\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIF SF4->F4_ISSST == \"1\" .or. Empty(SF4->F4_ISSST)\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"1\" //1-Exigível;\r\n\t\t\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"2\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"2\"\t//2-Não incidência\r\n\t\t\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"3\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"3\" //3-Isenção\r\n\t\t\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"4\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"5\"\t //5-Imunidade\r\n\t\t\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"5\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"6\"\t //6-Exigibilidade Suspensa por Decisão Judicial\r\n\t\t\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"6\"\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"7\"\t //7-Exigibilidade Suspensa por Processo Administrativo\r\n\t\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\t\tcIndIss := \"4\"//4-Exportação\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Pega as deduções ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSSUB\")) > 0\r\n\t\t\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSSUB\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSMAT\")) > 0\r\n\t\t\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSMAT\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t\t\t//³Verifica se recolhe ISS Retido ³\r\n\t\t\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t\t\t\tIf SF3->F3_RECISS $\"1|S\"  \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\tnValISSRet := SFT->FT_VALICM // Valor do ISSRET por item\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t/*If SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t\t\t\tIf SF3->F3_RECISS $\"1S\"       \r\n\t\t\t\t\t\t\t\t\t\t\tIf SF3->(dbSeek(xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE))\r\n\t\t\t\t\t\t\t\t\t\t\t\tWhile !SF3->(EOF()) .And. xFilial(\"SF3\")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE==SF2->F2_FILIAL+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tIf SF3->F3_TIPO==\"S\" //Serviço\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tnValISSRet+= SF3->F3_VALICM\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tSF3->(dbSkip())\r\n\t\t\t\t\t\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t   \t\tEndif\r\n\t\t\t\t\t\t\t\t\tEndIf*/\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aISSQN) := {CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,cMunISS,cCodIss,cSitTrib,nDeducao,cIndIss,nValISSRet}\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CMP\" //ICMSUFDEST\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aICMUFDest) := {IIf(CD2->CD2_BC > 0,CD2->CD2_BC, 0),; //[1]vBCUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PFCP\")) > 0 .and. CD2->CD2_PFCP > 0,CD2->CD2_PFCP,0),;  //[2]pFCPUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->CD2_ALIQ > 0,CD2->CD2_ALIQ,0),;//[3]pICMSUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_ADIF\")) > 0 .and. CD2->CD2_ADIF > 0,CD2->CD2_ADIF,0),;//[4]pICMSInter\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PDDES\")) > 0 .and. CD2->CD2_PDDES > 0,CD2->CD2_PDDES,0),;//[5]pICMSInterPart\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VFCP\")) > 0 .and. CD2->CD2_VFCP > 0,CD2->CD2_VFCP,0),;//[6]vFCPUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VDDES\")) > 0 .and. CD2->CD2_VDDES > 0,CD2->CD2_VDDES,0),;//[7]vICMSUFDest\r\n\t\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VLTRIB\")) > 0 .and. CD2->CD2_VLTRIB > 0,CD2->CD2_VLTRIB,0)}//[8]vICMSUFRemet\r\n\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"TST\" \r\n\r\n\t\t\t\t\t\t\t\t\tnBCTot += IIf(CD2->CD2_BC > 0,CD2->CD2_BC,0)\t\t\t\t//Total Base de Calculo\r\n\t\t\t\t\t\t\t\t\tnALIQTot += IIf(CD2->CD2_ALIQ > 0,CD2->CD2_ALIQ,0)\t\t\t//Total de aliquota\r\n\t\t\t\t\t\t\t\t\tnVLTRIBTot += IIf(CD2->CD2_VLTRIB > 0,CD2->CD2_VLTRIB,0)\t//Total do valor tributado\r\n\r\n\t\t\t\t\t\t\t\t\t//Preenchimento da Tag <retTransp>\r\n\t\t\t\t\t\t\t\t\taImp := {;\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIF(SC5->C5_FRETAUT > 0,SC5->C5_FRETAUT,0),;\t\t//vServ - Valor do Serviço\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIf(SC5->(ColumnPos(\"C5_FRTCFOP\")) > 0 .And. !Empty(SC5->C5_FRTCFOP) ,SC5->C5_FRTCFOP,\"\"),; \t//CFOP\r\n\t\t\t\t\t\t\t\t\t\t\t\tIIf(!Empty(cMunTransp),cMunTransp,0),;\t//cMunFG - Código do município de ocorrência do fato gerador do ICMS do transporte\r\n\t\t\t\t\t\t\t\t\t\t\t\t0,;\t\t\t//CST - Não utiliza no manual do contribuinte v6.00\r\n\t\t\t\t\t\t\t\t\t\t\t\t0,;\t\t\t//MODBC - Não utiliza no manual do contribuinte v6.00\r\n\t\t\t\t\t\t\t\t\t\t\t\t0,;\t\t\t//PREDBC - Não utiliza no manual do contribuinte v6.00\r\n\t\t\t\t\t\t\t\t\t\t\t\tnBCTot,;\t//vBCRet - BC da Retenção do ICMS \r\n\t\t\t\t\t\t\t\t\t\t\t\tnALIQTot,;\t//pICMSRet - Alíquota da Retenção\r\n\t\t\t\t\t\t\t\t\t\t\t\tnVLTRIBTot;\t//vICMSRet - Valor do ICMS Retido\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ZFM\"\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\tcICMSZFM := If(CD2->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,\"\")\r\n\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\tEndCase\r\n\t\t\t\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\t\tEndDo\r\n\r\n\t\t\t\t\t\tIf SFT->FT_DESCZFR>0  .OR. !Empty(cICMSZFM)\r\n\t\t\t\t\t\t\taadd(aICMSZFM,{If(SFT->(ColumnPos(\"FT_DESCZFR\")) > 0,SFT->FT_DESCZFR,\"\"),;\r\n\t\t\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\"),;\r\n\t\t\t\t\t\t\tcICMSZFM})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aICMSZFM,{})\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Tratamento para que o valor de PIS ST e COFINS ST venha a compor o valor total da tag vOutros  (NT 2011/004). E devolução de compra com IPI não tributado\r\n\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO == \"D\" .and. (!lIpiDev .OR. lIPIOutro))  .Or. lConsig .Or. (Alltrim((cAliasSD2)->D2_CF) $ cMVCFOPREM ) .OR. ((cAliasSD2)->D2_TIPO == \"B\" .and. (lIpiBenef .OR. lIPIOutB)) .OR. ((cAliasSD2)->D2_TIPO==\"P\" .And. lComplDev .And. !lIpiDev)\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf ((cAliasSD2)->D2_TIPO  == \"D\" .and.  lIPIOutro ) .or. ((cAliasSD2)->D2_TIPO  == \"B\" .and.  lIPIOutB)\r\n\t\t\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n                            EndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\t\t\taTotal[01] += 0\t\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taTotal[01] += (cAliasSD2)->D2_VALIPI\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\taTotal[01] += (cAliasSD2)->D2_DESPESA + (cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3 + nIcmsST + nCrdPres\r\n\t\t\t\t\t   \r\n\t\t\t\t\t\tIf (cAliasSD2)->D2_TIPO == \"I\"\r\n\t\t\t\t\t\t\tIf (cAliasSD2)->D2_ICMSRET > 0\r\n\t\t\t\t\t\t\t\taTotal[02] += (cAliasSD2)->D2_VALBRUT\r\n\t\t\t\t\t\t\tElseIf  ( (SF4->F4_AGREG == \"S\" .And. SF4->F4_AJUSTE == \"S\") .And. (\"RESSARCIMENTO\" $ Upper(cNatOper) .And. \"RESSARCIMENTO\" $ Upper(cDescProd)))\r\n\t\t\t\t\t\t\t\taTotal[02] += (cAliasSD2)->D2_TOTAL\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taTotal[02] += 0\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tElseIf (cAliasSD2)->D2_TIPO == \"N\" .And. AllTrim(SF4->F4_CF) $ cMVCfopTran\r\n\t\t\t\t\t\t\taTotal[02] += (cAliasSD2)->D2_TOTAL\r\n\t\t\t\t\t\tElseIf SF4->F4_PSCFST == \"1\" .And. SF4->F4_APSCFST == \"1\"\r\n\t\t\t\t\t\t\taTotal[02] += ((cAliasSD2)->D2_VALBRUT - ((cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3))\r\n\t\t\t\t\t\tElse\r\n\t\t                    aTotal[02] += (cAliasSD2)->D2_VALBRUT\r\n\t\t              EndIf\t\t\r\n\t\t              //Tratamento para que o valor de PIS ST,COFINS ST venha a compor o valor total da nota.\r\n\t\t\t\t\t\taTotal[03]+= (cAliasSD2)->D2_VALPS3 + (cAliasSD2)->D2_VALCF3\t\r\n\t\t\t\t\t\tIf findfunction( 'ColumnPos' )\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF SF4->(ColumnPos(\"F4_DIFAL\")) > 0 .And. SF4->F4_DIFAL == \"1\"\r\n\t\t\t\t\t\t\t\tlDifal := .T.\r\n\t\t\t\t\t\t\tEndIF \t\t\t\t\t\r\n\t\t\t\t\t\tElse \r\n\t\t\t\t\t\t\tMsgInfo(\"É necessário a atualização do sistema para a expedição mais recente.\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf (lCalSol .OR.  lMVCOMPET .OR. lDifal )\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE)\r\n\t\t\t\t\t\t\t\tcEstado := IIf(lVeicNovo,SF3->F3_ESTADO,(iif(aDest[09]<> nil,aDest[09],\"\" )))\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf At (cEstado, cMVSUBTRIB)>0\r\n\t\t\t\t\t\t\t\t\tnPosI\t:=\tAt (cEstado, cMVSUBTRIB)+2\r\n\t\t\t\t\t\t\t\t\tnPosF\t:=\tAt (\"/\", SubStr (cMVSUBTRIB, nPosI))-1\r\n\t\t\t\t\t\t\t\t\tnPosF\t:=\tIIf(nPosF<=0,len(cMVSUBTRIB),nPosF)\r\n\t\t\t\t\t\t\t\t\taAdd (aIEST, SubStr (cMVSUBTRIB, nPosI, nPosF))\t//01 - IE_ST\r\n\t\t\t\t\t\t\t\t\taAdd (aIEST,iif(aDest[14]<> nil,aDest[14],\"\" ))\t//IE Dest.\r\n\t\t\t\t\t\t\t\tElseif  lDifal\r\n\t\t\t\t\t\t\t\t\tIf AliasInDic(\"F0L\")\r\n\t\t\t\t\t\t\t\t\t\tdbSelectArea(\"F0L\")\r\n\t\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\t\tIf MsSeek(xFilial(\"F0L\")+cEstado)\t//F0L_FILIAL, F0L_UF, F0L_INSCR, R_E_C_N_O_, D_E_L_E_T_\r\n\t\t\t\t\t\t\t\t\t\t\taAdd (aIEST, F0L->F0L_INSCR)\t\t\t\t\t  \t//01 - IE_ST DIFAL\r\n\t\t\t\t\t\t\t\t\t\t\taAdd (aIEST,iif(aDest[14]<> nil,aDest[14],\"\" ))\t//IE Dest.\r\n\t\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t    Endif\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf SFT->(FieldPos(\"FT_CSTPIS\")) > 0 .And. SFT->(FieldPos(\"FT_CSTCOF\")) > 0\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"SFT\") //Livro Fiscal Por Item da NF\r\n\t\t\t\t\t\t\tdbSetOrder(1) //FT_FILIAL+FT_TIPOMOV+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM+FT_PRODUTO\r\n\t\t\t\t\t\t\tIf MsSeek(xFilial(\"SFT\")+\"S\"+SF2->F2_SERIE+SF2->F2_DOC+SF2->F2_CLIENTE+SF2->F2_LOJA+PadR((cAliasSD2)->D2_ITEM,4)+(cAliasSD2)->D2_COD)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SFT->FT_CSTPIS)\r\n\t\t\t\t\t\t\t\t\taTail(aPisAlqZ):= {SFT->FT_CSTPIS}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SFT->FT_CSTCOF)\r\n\t\t\t\t\t\t\t\t\taTail(aCofAlqZ) := {SFT->FT_CSTCOF}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SF4->F4_CSTPIS)\r\n\t\t\t\t\t\t\t\taTail(aPisAlqZ):= {SF4->F4_CSTPIS}\t\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SF4->F4_CSTCOF)\r\n\t\t\t\t\t\t\t\taTail(aCofAlqZ):= {SF4->F4_CSTCOF}\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !len(aCofAlqZ)>0 .or. !len(aPisAlqZ)>0\r\n\t\t\t\t\t\t\taadd(aCofAlqZ,{})  \r\n\t\t\t\t\t   \t\taadd(aPisAlqZ,{})\t\t\t\t\t\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tIf SF4->(FieldPos(\"F4_CSOSN\"))>0\r\n\t\t\t\t\t\t\taTail(aCsosn):= SF4->F4_CSOSN\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taTail(aCsosn):= \"\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t   \t\t\r\n\t\t\t\t\t\tIf !len(aCsosn)>0 \r\n\t\t\t\t\t\t\taadd(aCsosn,\"\")  \r\n\t\t\t\t\t   \tEndif\r\n\t\t\t\t\tendif\t\r\n\t\r\n\t\t\t\t\tdbSelectArea(cAliasSD2)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t    EndDo \r\n\t\r\n\t\t\t\t//Tratamento para incluir a mensagem em informacoes adicionais do Suframa\r\n\t\t\t\tIf !Empty(aDest[15])\r\n\t\t\t\t// Msg Zona Franca de Manaus / ALC\r\n\t\t\t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\tdbSeek (xFilial(\"SF3\")+SF2->F2_CLIENTE+SF2->F2_LOJA+SF2->F2_DOC+SF2->F2_SERIE)\r\n\t\t\t\t\tDo While !SF3->(Eof()) .AND. xFilial(\"SF3\") == SF3->F3_FILIAL .And.;\r\n\t\t\t\t\t\tSF2->F2_CLIENTE == SF3->F3_CLIEFOR .And. SF2->F2_LOJA == SF3->F3_LOJA .And.;\r\n\t\t\t\t\t\tSF2->F2_DOC == SF3->F3_NFISCAL .And. SF2->F2_SERIE == SF3->F3_SERIE\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnValBse += SF3->F3_VALOBSE\r\n\t\t\t\t\t\t\tSF3->(DbSkip ())\r\n\t   \t\t\t\tEndDo\t\t\r\n\t\t\t\t\tIf !SF2->F2_DESCZFR == 0 .or. ( lInfAdZF .and. nValBse > 0 )//Desnecessario seek redundante na SF3 pois o campo F2_DESCZFR ja possui os valores de ZFR de toda a venda\r\n\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t   cMensFis += \" \"\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\t\tIf lInfAdZF .And. (nValPisZF > 0 .Or. nValCofZF > 0)\r\n\t\t\t\t\t\t\tcMensFis += \"Descontos Ref. a Zona Franca de Manaus / ALC. ICMS - R$ \"+str(nValBse-SF2->F2_DESCONT-nValPisZF-nValCofZF,13,2)+\", PIS - R$ \"+ str(nValPisZF,13,2) +\"e COFINS - R$ \" +str(nValCofZF,13,2) \t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElseIF !lInfAdZF .And. (nValPisZF > 0 .Or. nValCofZF > 0) \r\n\t\t\t\t\t\t\tcMensFis += \"Desconto Ref. ao ICMS - Zona Franca de Manaus / ALC. R$ \"+str(nValBse-SF2->F2_DESCONT-nValPisZF-nValCofZF,13,2)\r\n\t\t\t\t\t    Else\r\n\t\t\t\t\t    \tcMensFis += \"Total do desconto Ref. a Zona Franca de Manaus / ALC. R$ \"+str(nValBse-SF2->F2_DESCONT,13,2)\r\n\t\t\t\t\t    EndIF\r\n\t\t\t\t\tEndIf \t\r\n\t\t\t\tEndIF\r\n\t\r\n\t\t\t\t//TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t\t//INSERE MSG EM INFADFISCO E SOMA NO TOTAL DA NOTA.\r\n\t\t\t\tIf nValLeite > 0 .And. nPercLeite > 0\r\n\t\t\t\t\tcMensFis += Alltrim(Str(nPercLeite,10,2))+'% Incentivo à produção e à industrialização do leite = R$ '+ Alltrim(Str(nValLeite,10,2))\r\n\t\t\t\t\taTotal[02] += nValLeite\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\tIf Len(aIPIDev)>0\r\n\t\t\t    \tnX := 1\r\n\t\t\t\t\tDo While lOk\r\n\t\t\r\n\t\t\t\t\t   nValAux := aIPIDev[nX][1]               \r\n\t\t\t\t\t   cNCMAux := aIPIDev[nX][2]\r\n\t\t\t\t\t   \r\n\t\t\t\t\t   npos := aScan( aIPIAux,{|x| x[2]==cNCMAux})\r\n\t\t\t\t\t   IF npos >0\t\t\t\r\n\t\t\t\t\t\t\taIPIAux[npos][1]+=nValAux\r\n\t\t\t\t       Else\r\n\t\t\t\t\t\t\tAaDd(aIPIAux,{nValAux,cNCMAux})\t\t       \r\n\t\t\t\t       EndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tnX += 1\r\n\t\t\t\t\t\tIf nX > Len(aIPIDev)\r\n\t\t\t\t\t\t\tlOk := .F.\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndDo\r\n\t\t\r\n\t\t\t\t\t\tFor nX := 1 To Len(aIPIAux)\r\n\t\t\t\t\t\t\tcValIPI  := AllTrim(Str(aIPIAux[nX][1],15,2))\r\n\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\tcMensCli += \"(Valor do IPI: R$ \"+cValIPI+\" - \"+\"Classificação fiscal: \"+aIPIAux[nX][2]+\") \"\r\n\t\t\t\t\t\t\tcValIPI  := \"\"\r\n\t\t\t\t\t\t\tcNCMAux  := \"\"\r\n\t\t\t\t\t\tNext nX\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf nValSTAux > 0 \r\n\t\t\t\t\tcValST  := AllTrim(Str(nValSTAux,15,2))\r\n\t\t\t\t\tcBsST   := AllTrim(Str(nBsCalcST,15,2))\r\n\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\tIf lComplDev .And.  nBsCalcST == 0\r\n\t\t\t\t\t\tcMensCli += \"(Valor do ICMS ST: R$ \"+cValST+\") \" \t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS ST: R$ \"+cBsST+ \" - \"+\"Valor do ICMS ST: R$ \"+cValST+\") \"\r\n\t\t\t\t\tEndIF\t\r\n\t\t\t\t\tcValST\t  := \"\"  \r\n\t\t\t\t\tcBsST \t  := \"\"   \r\n\t\t\t\t\tnBsCalcST := 0\r\n\t\t\t\t\tnValSTAux := 0\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017) \r\n\t\t\t\tIf \tnToTvBC > 0 .And. nToTvICMS > 0 \t\t\t\t\t\t\t\t   \r\n\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS : R$ \"+AllTrim(Str(nToTvBC,15,2))+\" - \"+\"Valor do ICMS : R$ \"+AllTrim(Str(nToTvICMS,15,2))+\") \"\r\n\t\t\t\tEndif\r\n\t\t\t\t//Tratamento legislacao do Rio Grande do Sul, quando existir intes com ICMS-ST e intens somente com ICMS  próprio\r\n\t\t\t\tIf SM0->M0_ESTCOB $ \"RS\" .And. Len(aICMS) > 0 .And. Len(aICMSSt) > 0 \r\n\t\t\t\t\tcMensCli += MsgCliRsIcm(aICMS,aICMSSt)\r\n\t\t\t\tEndif\r\n\t\t\t\t//Tratamento legislacao do DF, quando existir intes com ICMS-ST e intens somente com ICMS  próprio\r\n\t\t\t\tIf aDest[9] $ \"DF\" .And. Len(aICMS) > 0 .And. Len(aICMSSt) > 0 \r\n\t\t\t\t\tcMensCli += MsgCliDFIcm(aICMS,aICMSSt,lNCMOk)\r\n\t\t\t\tEndif\r\n\t\t\t    \r\n\t\t\t    //Mensagem para ICMS Particionado - Convênio ICMS Nº 51/00,\r\n\t\t\t    if nValICMParc > 0 .And. nBasICMParc > 0 .And. nValSTParc > 0 .And. nBasSTParc > 0\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t   cMensFis += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tcMensFis += \"Faturamento Direto ao Consumidor - Convenio ICMS Nº 51/00, de 15 de setembro de 2000. \"\r\n\t\t\t\t\tcMensFis += \"Base de calculo ICMS R$\"+ AllTrim(Str(nBasICMParc,15,2))+\" e \"\r\n\t\t\t\t\tcMensFis += \"Valor do ICMS R$\"+ AllTrim(Str(nValICMParc,15,2))+\". \"\r\n\t\t\t\t\tcMensFis += \"Base do ICMS-ST R$\"+ AllTrim(Str(nBasSTParc,15,2))+\" e \"\r\n\t\t\t\t\tcMensFis += \"Valor do ICMS-ST R$\"+ AllTrim(Str(nValSTParc,15,2))+\". \"\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(aEntrega) \r\n\t\t\t\t\t\tcMensFis += \"Concessionaria que ira entregar o veiculo ao adquirente \"+ConvType(aEntrega[09],115)+\". \"\r\n\t\t\t\t\t\tcMensFis += \"CNPJ: \"+AllTrim(aEntrega[01])+\" e IE: \"+AllTrim(aEntrega[10])+\". \"\r\n\t\t\t\t\t\tcMensFis += \"Endereço: \"+ConvType(aEntrega[02],125)+\", \"+ConvType(aEntrega[03],10)+\" \"+ConvType(aEntrega[04],60)+\". \" //Rua,Num,Complemento\r\n\t\t\t\t\t\tcMensFis += ConvType(aEntrega[05],60)+\" - \"+ ConvType(aEntrega[07],50) +\"-\"+ConvType(aEntrega[08],2)+\". \"//Bairro, Cidade, UF\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMensFis += \"Concessionaria que ira entregar o veiculo ao adquirente \"+ConvType(aDest[02],115)+\". \"\r\n\t\t\t\t\t\tcMensFis += \"CNPJ \"+AllTrim(aDest[01])+\" e IE: \"+AllTrim(aDest[14])+\". \"\r\n\t\t\t\t\t\tcMensFis += \"Endereço: \"+ConvType(aDest[03],125)+\" \"+ConvType(aDest[04],10)+\" \"+ConvType(aDest[05],60)+\", \" //Rua,Num,Complemento\r\n\t\t\t\t\t\tcMensFis += ConvType(aDest[06],60)+ \", \"+ ConvType(aDest[08],50) +\" - \"+ConvType(aDest[09],2)+\". \"//Bairro, Cidade, UF \r\n\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tendif\r\n\t\t\t\t\r\n\t\t\t\tIf ((SubStr(SM0->M0_CODMUN,1,2) == \"35\" ) .and. \"REMESSA POR CONTA E ORDEM DE TERCEIROS\" $ Upper(cNatOper) .and. lOrgaoPub )\r\n\t\t\t\t\tcMensFis += \"NF-e emitida nos termos do artigo 129-A do RICMS.\"\r\n\t\t\t\t\tcMensFis += \"(Redacao dada ao artigo pelo Decreto n60.060 , de 14.01.2014, DOE SP de 15.01.2014)\"\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t    \r\n\t\t\t    If lQuery\r\n\t\t\t    \tdbSelectArea(cAliasSD2)\r\n\t\t\t    \tdbCloseArea()\r\n\t\t\t    \tdbSelectArea(\"SD2\")\r\n\t\t\t    \r\n\t\t\t    \tdbSelectArea(\"SC5\")\r\n\t\t\t    \tdbCloseArea()\r\n\t\t\t    EndIf\r\n\t\t\t    /*Tratamento para buscar a Nota Original e a Data referente inciso II do art. 456 do RICMS / SP, chamado THPXGS*/\r\n\t\t\t    if lBrinde\r\n\t\t\t    \taDocDat := DocDatOrig(SD2->D2_NUMLOTE,SD2->D2_LOTECTL,SD2->D2_COD)\r\n\t\t\t    \tif len (cMensCli) > 0\r\n\t\t\t    \t\tcMensCli += ' '\r\n\t\t\t    \tendif\r\n\t\t\t    \tcMensCli += \"Nota Fiscal emitida nos termos do inciso II do art. 456 do RICMS - Nota Fiscal de Aquisição nº \"+aDocDat[2]+\", de \"+aDocDat[1]+\".\"\r\n\t\t\t    endif \r\n\t\t\t    //Tratamento para incluir a mensagem em informacoes adicionais do FECP -DF - MG - PR - RJ - RS.\r\n\t\t\t    If nValTFecp > 0\r\n\t\t\t\t\tIf cVerAmb >= \"4.00\"\t\t\t\t\r\n\t\t\t    \tcMensFis += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\t\t\tElse\r\n\t\t\t    \t\tcMensCli += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\t\t\tEndIf\r\n\t\t\t    EndIf\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext\r\nElse\r\n\tdbSelectArea(\"SF1\")\r\n\tdbSetOrder(1)\r\n\tIf MsSeek(xFilial(\"SF1\")+cNota+cSerie+cClieFor+cLoja)\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Tratamento temporario do CTe                                            ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\tIf FunName() == \"SPEDCTE\" .Or. AModNot(SF1->F1_ESPECIE)==\"57\"\r\n\t\t\tcNFe := \"CTe35080944990901000143570000000000200000168648\"\r\n\t\t\tcString := '<infNFe versao=\"T02.00\" modelo=\"57\" >'\r\n\t\t\tcString += '<CTe xmlns=\"http://www.portalfiscal.inf.br/cte\"><infCte Id=\"CTe35080944990901000143570000000000200000168648\" versao=\"1.02\"><ide><cUF>35</cUF>'\r\n\t\t\tcString += '<cCT>000016864</cCT><CFOP>6353</CFOP><natOp>ENTREGA NORMAL</natOp><forPag>1</forPag><mod>57</mod><serie>0</serie><nCT>20</nCT>'\r\n\t\t\tcString += '<dhEmi>2008-09-12T10:49:00</dhEmi><tpImp>2</tpImp><tpEmis>2</tpEmis><cDV>8</cDV><tpAmb>2</tpAmb><tpCTe>0</tpCTe><procEmi>0</procEmi>'\r\n\t\t\tcString += '<verProc>1.12a</verProc><cMunEmi>3550308</cMunEmi><xMunEmi>Sao Paulo</xMunEmi><UFEmi>SP</UFEmi><modal>01</modal><tpServ>0</tpServ>'\r\n\t\t\tcString += '<cMunIni>3550308</cMunIni><xMunIni>Sao Paulo</xMunIni><UFIni>SP</UFIni><cMunFim>3550308</cMunFim><xMunFim>Sao Paulo</xMunFim>'\r\n\t\t\tcString += '<UFFim>SP</UFFim><retira>1</retira><xDetRetira>TESTE</xDetRetira><toma03><toma>0</toma></toma03></ide><emit><CNPJ>44990901000143</CNPJ>'\r\n\t\t\tcString += '<IE>00000000000</IE><xNome>FILIAL SAO PAULO</xNome><xFant>Teste</xFant><enderEmit><xLgr>Av. Teste, S/N</xLgr><nro>0</nro><xBairro>Teste</xBairro>'\r\n\t\t\tcString += '<cMun>3550308</cMun><xMun>Sao Paulo</xMun><CEP>00000000</CEP><UF>SP</UF></enderEmit></emit><rem><CNPJ>58506155000184</CNPJ><IE>115237740114</IE>'\r\n\t\t\tcString += '<xNome>CLIENTE SP</xNome><xFant>CLIENTE SP</xFant><enderReme><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun>'\r\n\t\t\tcString += '<xMun>SAO PAULO</xMun><CEP>77777777</CEP><UF>SP</UF></enderReme><infOutros><tpDoc>00</tpDoc><dEmi>2008-09-17</dEmi></infOutros></rem><dest><CNPJ>'\r\n\t\t\tcString += '</CNPJ><IE></IE><xNome>CLIENTE RJ</xNome><enderDest><xLgr>R</xLgr><nro>0</nro><xBairro>BAIRRO NAO CADASTRADO</xBairro><cMun>3550308</cMun><xMun>RIO DE JANEIRO</xMun>'\r\n\t\t\tcString += '<CEP>44444444</CEP><UF>RJ</UF></enderDest></dest><vPrest><vTPrest>1.93</vTPrest><vRec>1.93</vRec></vPrest><imp><ICMS><CST00><CST>00</CST><vBC>250.00</vBC><pICMS>18.00</pICMS><vICMS>450.00</vICMS>'\r\n\t\t\tcString += '</CST00></ICMS></imp><infCteComp><chave>35080944990901000143570000000000200000168648</chave><vPresComp><vTPrest>10.00</vTPrest>'\r\n\t\t\tcString += '</vPresComp><impComp><ICMSComp><CST00Comp><CST>00</CST><vBC>10.00</vBC><pICMS>10.00</pICMS><vICMS>10.00</vICMS></CST00Comp></ICMSComp></impComp>'\r\n\t\t\tcString += '</infCteComp></infCte></CTe>'\r\n\t\t\tcString += '</infNFe>'\r\n\t\tElse\t\t\t\t\r\n\t\t\taadd(aNota,SF1->F1_SERIE)\r\n\t\t\taadd(aNota,IIF(Len(SF1->F1_DOC)==6,\"000\",\"\")+SF1->F1_DOC)\r\n\t\t\taadd(aNota,SF1->F1_EMISSAO)\r\n\t\t\taadd(aNota,cTipo)\r\n\t\t\taadd(aNota,SF1->F1_TIPO)\r\n\t\t\taadd(aNota,SF1->F1_HORA)\t\t\t\r\n\t\t\tIf SF1->F1_TIPO $ \"DB\" \r\n\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA1\")+cClieFor+cLoja)\r\n\r\n\t\t\t\tIf !Empty(SA1->A1_MENSAGE) \r\n\t\t\t\t\tcRetForm := SA1->(Formula(A1_MENSAGE))\r\n\t\t\t\t\tif cRetForm <> Nil .and. !empty(cRetForm)\r\n\t\t\t\t\t\tIf cMVNFEMSA1==\"C\"\r\n\t\t\t\t\t\t\tcMensCli\t:=\tcRetForm\r\n\t\t\t\t\t\tElseIf cMVNFEMSA1==\"F\"\r\n\t\t\t\t\t\t\tcMensFis\t:=\tcRetForm\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tendif\r\n\t\t\t\tEndIf\t\t\t\t\t\t\t\t\r\n\t\t\t\t/* Quando houver uma troca/devolução (LOJA720) de uma NFC-e no Estado do AM, a tag <infAdFisco> \r\n\t\t\t\tda NF-e de entrada deve conter o motivo de devolução, nome, endereço e cpf do cliente\r\n\t\t\t\tO campo F1_MOTIVO é preenchido na funcao LOJA720 do SIGALOJA */\r\n\t\t\t\tIf lF1Motivo .AND. AllTrim(SF1->F1_ORIGLAN) == \"LO\" .AND. LjAnalisaLeg(73)[1] .AND. !Empty(SF1->F1_MOTIVO)\r\n\t\t\t\t\tcMensFis += SF1->F1_MOTIVO\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_FORRET\"))<>0 .And. !Empty(SF1->F1_FORRET+SF1->F1_LOJARET) .And. SF1->F1_FORRET+SF1->F1_LOJARET <> SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIF MsSeek(xFilial(\"SA1\")+SF1->F1_FORRET+SF1->F1_LOJARET)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_CGC)\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA1->A1_END,\"SA1\")[4])\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,SA1->A1_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_NOME))\r\n\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA1->A1_EMAIL))\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_FORENT\")) <> 0 .And. !Empty(SF1->F1_FORENT+SF1->F1_LOJAENT) .And. SF1->F1_FORENT+SF1->F1_LOJAENT <> SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SA1\")+SF1->F1_FORENT+SF1->F1_LOJAENT)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_CGC)\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\t\t\t\t\taadd(aEntrega,ConvType(IIF(MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0,MyGetEnd(SA1->A1_END,\"SA1\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA1->A1_END,\"SA1\")[4])\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_BAIRRO)\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,Upper(SA1->A1_EST))\r\n\t\t\t\t\t\taadd(aEntrega,SA1->A1_NOME)\r\n\t\t\t\t\t\taadd(aEntrega,Iif(!Empty(SA1->A1_INSCR),VldIE(SA1->A1_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_CEP))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(AllTrim(SA1->A1_DDD)+SA1->A1_TEL)) \r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA1->A1_EMAIL))\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndIf\r\n\t\t\t\t/*MMAN-5156\r\n\t\t\t\tAtendimento ao processo de Recusa de mercadoria por parte do cliente,\r\n\t\t\t\tonde o Emitente deverá realizar a inclusão de recebimento da recusa utilizando\r\n\t\t\t\tCFOP 1.201/2.201 - devolução de venda de produção do estabelecimento; \r\n\t\t\t\te (ii) 1.410/2.410 - devolução de venda de produção do estabelecimento em operação \r\n\t\t\t\tcom produto sujeito ao regime de substituição tributária. \r\n\t\t\t\tBem como incluindo seus dados de Emitente como Destinatário.\r\n\t\t\t\tParecer da Consultoria de segmentos:\r\n\t\t\t\thttp://tdn.totvs.com/pages/releaseview.action?pageId=269448809\r\n\t\t\t\t\r\n\t\t\t\tFoi criado o campo na aba DANFE no Documento de Entrada (campo do materiais UPDCOM18)\r\n\t\t\t\tF1_DEVMERC (Identifica devolução de mercadoria que não foi entregue ao destinatário em\r\n\t\t\t\tatendimento ao Artigo 453, I, do RICMS/2000 SP) \r\n\t\t\t\tTipo Caracter (Combo S=Sim;N=Não) Tamanho 1\r\n\t\t\t\t\r\n\t\t\t\tAo preencher o campo como S=Sim, os dados do próprio estabelecimento (Emitente)\r\n\t\t\t\tserão utilizados como destinatário no XML e Danfe, ao invés do cliente padrão da nota.\t\t\r\n\t\t\t\t*/\r\n\t\t\t\tIf SF1->( ColumnPos( \"F1_DEVMERC\" ) ) > 0\r\n\t\t\t\t\tcDevMerc := Alltrim(SF1->F1_DEVMERC)\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf cDevMerc == \"S\"\r\n\t\t\t\t\r\n\t\t\t\t\taadd(aDest,AllTrim(SM0->M0_CGC)) // 1\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_NOMECOM))// 2\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[1]),ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1])))// 3\r\n\t\r\n\t\t\t\t\tIf !lEndFis\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcEndEmit :=  IIF(!lEndFis,Iif(!Empty(SM0->M0_COMPCOB),SM0->M0_COMPCOB,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[4]) ) ,;\r\n\t\t\t\t\t\t  \t\tIif(!Empty(SM0->M0_COMPENT),SM0->M0_COMPENT,ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[4]) ) )\r\n\t\t\t\t\taadd(aDest,cEndEmit)// 5\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_BAIRCOB),ConvType(SM0->M0_BAIRENT)))// 6\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_CODMUN))// 7\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CIDCOB),ConvType(SM0->M0_CIDENT)))// 8\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))))// 9\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CEPCOB),ConvType(SM0->M0_CEPENT)))// 10\r\n\t\t\t\t\taadd(aDest,\"1058\")// 11\r\n\t\t\t\t\taadd(aDest,\"BRASIL\")// 12\r\n\t\t\t\t\t\r\n\t\t\t\t\taTelEmit:= FisGetTel(SM0->M0_TEL)\r\n\t\t\t\t\tcFoneEmit := IIF(aTelEmit[1] > 0,ConvType(aTelEmit[1],3),\"\") // Código do Pais\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[2] > 0,ConvType(aTelEmit[2],3),\"\") // Código da Área\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[3] > 0,ConvType(aTelEmit[3],9),\"\") // Código do Telefone\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,cFoneEmit)// 13\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(VldIE(SM0->M0_INSC)))// 14\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_SUFRAMA*/)// 15\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_EMAIL*/)// 16\r\n\t\t\t\t\taAdd(aDest,\"1\" /*SA1->A1_CONTRIB*/) // 17\r\n\t\t\t\t\taadd(aDest,\"\") // 18\r\n\t\t\t\t\taadd(aDest,SM0->M0_INSCM) // 19\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_TIPO*/) // 20\r\n\t\t\t\t\taadd(aDest,\"\"/*SA1->A1_PFISICA*/)//21\r\n\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t/* Se MV_NFEDEST estiver desabilitado (default .F.) permanece o legado:\r\n\t\t\t\t\ta) Para operações interestaduais (UF do emitente diferente da UF do Cliente de Entrega) e o CNPJ do Destinatario(Cliente - F1_FORNECE)\r\n\t\t\t\t\t\tfor DIFERENTE do emitente, serão considerados os dados do CLIENTE DE ENTREGA.  \r\n\t\t\t\t\t\t- Os dados do Cliente de Entrega serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\tb) Para operações internas (UF do emitente igual a UF do Cliente de Entrega) e se o CNPJ do Destinatário(Cliente - F1_FORNECE)\r\n\t\t\t\t\t\tfor IGUAL ao do emitente, serão considerado os dados do CLIENTE, mesmo que UFs sejam diferentes.\r\n\t\t\t\t\t\t- Os dados do Cliente serão gerados na tag de Destinatário - 'dest'.\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf !lUsaCliEnt\r\n\t\t\t\t\t\tlCNPJIgual := AllTrim(SA1->A1_CGC) == Alltrim(SM0->M0_CGC)\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf !Empty(AllTrim(SF1->F1_FORENT)) .And. !Empty(AllTrim(SF1->F1_LOJAENT))\t\t\t\r\n\t\t\t\t\t\t\tIf Len(aEntrega) > 0\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//Se a UF da entrega for diferente da UF do emitente (operação interestadual) e o CNPJ do destinatario for diferente do emitente, \r\n\t\t\t\t\t\t\t\t//tenho que buscar os dados do cliente de entrega para nao ocorrer \r\n\t\t\t\t\t\t\t\t//rejeicao 523 - CFOP não é de Operação Estadual e UF emitente igual à UF destinatário\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] <> IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .And. !lCNPJIgual //aEntrega[08] <> Upper(SA1->A1_EST)\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORENT+SF1->F1_LOJAENT)\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t//Se a UF de entrega for igual a UF do emitente (Operação interna) - busco os dados do cliente para montar como destinatario.\r\n\t\t\t\t\t\t\t\t//Se o CNPJ do emitente for igual ao do destinatário também levo os dados do cliente, mesmo que UFs forem diferente.\r\n\t\t\t\t\t\t\t\t//Se o cliente não for consumidor final e possuir IE, pode ocorrer a rejeição 773 - Operação Interna e UF de destino difere da UF do emitente\r\n\t\t\t\t\t\t\t\tIf aEntrega[08] == IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) .OR. lCNPJIgual\r\n\t\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t/* Se MV_NFEDEST estiver habilitado (.T.):\r\n\t\t\t\t\t\t\tA tag de destinatário - 'dest' será gerada com os dados do CLIENTE (F1_FORNECE)\r\n\t\t\t\t\t\t\tCaso possua Cliente de Entrega (F1_FORENT) a tag de entrega será gerada exatamente com os dados do Cliente de Entrega \r\n\t\t\t\t\t\t\tCaso possua Cliente de Retirada (F1_FORRET) a tag de retirada será gerada exatamente com os dados do Cliente de Retirada\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_CGC))\r\n\t\t\t\t\taadd(aDest,SA1->A1_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[1])\r\n\t\r\n\t\t\t   \t\tIf MyGetEnd(SA1->A1_END,\"SA1\")[2]<>0\r\n\t\t\t\t\t\taadd(aDest,MyGetEnd(SA1->A1_END,\"SA1\")[3]) \r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(SA1->(FieldPos(\"A1_COMPLEM\")) > 0 .And. !Empty(SA1->A1_COMPLEM),SA1->A1_COMPLEM,MyGetEnd(SA1->A1_END,\"SA1\")[4]))\r\n\t\r\n\t\t\t\t\taadd(aDest,SA1->A1_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA1->A1_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,Upper(SA1->A1_EST))\r\n\t\t\t\t\taadd(aDest,SA1->A1_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA1->A1_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA1->A1_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA1->A1_DDD)+SA1->A1_TEL)\r\n\t\t\t\t\tIf !Upper(SA1->A1_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,VldIE(SA1->A1_INSCR))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,SA1->A1_SUFRAMA)\r\n\t\t\t\t\taadd(aDest,SA1->A1_EMAIL)\r\n\t\t\t\t\taAdd(aDest, SA1->A1_CONTRIB) // Posição 17\r\n\t\t\t\t\taadd(aDest,Iif(SA1->(FieldPos(\"A1_IENCONT\")) > 0 ,SA1->A1_IENCONT,\"\"))\r\n\t\t\t\t\taadd(aDest,SA1->A1_INSCRM)\r\n\t\t\t\t\taadd(aDest,SA1->A1_TIPO)\r\n\t\t\t\t\taadd(aDest,SA1->A1_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t   \tdbSelectArea(\"SA2\")\r\n\t\t\t\tdbSetOrder(1)  \t\t\t\t\r\n\t\t\t\tMsSeek(xFilial(\"SA2\")+cClieFor+cLoja)\r\n\t\t\t\tIf SF1->( ColumnPos( \"F1_DEVMERC\" ) ) > 0\r\n\t\t\t\t\tcDevMerc := Alltrim(SF1->F1_DEVMERC)\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t/*Atendimento ao processo de Recusa de mercadoria. Notas do Tipo D, B e N\r\n\t\t\t\tAo preencher o campo como S=Sim, os dados do próprio estabelecimento (Emitente)\r\n\t\t\t\tserão utilizados como destinatário no XML e Danfe, ao invés do fornecedor padrão da nota*/\r\n\t\t\t\t\r\n\t\t\t\tIf cDevMerc == \"S\"\r\n\t\t\t\t\taadd(aDest,AllTrim(SM0->M0_CGC)) // 1\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_NOMECOM))// 2\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[1]),ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1])))// 3\r\n\t\r\n\t\t\t\t\tIf !lEndFis\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tIf FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2] <> 0\r\n\t\t\t\t\t\t\taadd(aDest,FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3])// 4\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taadd(aDest,\"SN\")\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcEndEmit :=  IIF(!lEndFis,Iif(!Empty(SM0->M0_COMPCOB),SM0->M0_COMPCOB,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[4]) ) ,;\r\n\t\t\t\t\t\t  \t\tIif(!Empty(SM0->M0_COMPENT),SM0->M0_COMPENT,ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[4]) ) )\r\n\t\t\t\t\taadd(aDest,cEndEmit)// 5\r\n\t\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_BAIRCOB),ConvType(SM0->M0_BAIRENT)))// 6\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(SM0->M0_CODMUN))// 7\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CIDCOB),ConvType(SM0->M0_CIDENT)))// 8\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))))// 9\r\n\t\t\t\t\taadd(aDest,IIF(!lEndFis,ConvType(SM0->M0_CEPCOB),ConvType(SM0->M0_CEPENT)))// 10\r\n\t\t\t\t\taadd(aDest,\"1058\")// 11\r\n\t\t\t\t\taadd(aDest,\"BRASIL\")// 12\r\n\t\t\t\t\t\r\n\t\t\t\t\taTelEmit:= FisGetTel(SM0->M0_TEL)\r\n\t\t\t\t\tcFoneEmit := IIF(aTelEmit[1] > 0,ConvType(aTelEmit[1],3),\"\") // Código do Pais\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[2] > 0,ConvType(aTelEmit[2],3),\"\") // Código da Área\r\n\t\t\t\t\tcFoneEmit += IIF(aTelEmit[3] > 0,ConvType(aTelEmit[3],9),\"\") // Código do Telefone\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,cFoneEmit)// 13\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,ConvType(VldIE(SM0->M0_INSC)))// 14\r\n\t\t\t\t\t\r\n\t\t\t\t\taadd(aDest,\"\")// 15\r\n\t\t\t\t\taadd(aDest,\"\")// 16\r\n\t\t\t\t\taAdd(aDest,\"1\") // 17\r\n\t\t\t\t\taadd(aDest,\"\") // 18\r\n\t\t\t\t\taadd(aDest,SM0->M0_INSCM) // 19\r\n\t\t\t\t\taadd(aDest,\"\") // 20\r\n\t\t\t\t\taadd(aDest,\"\")//21\r\n\t\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_CGC))\r\n\t\t\t\t\taadd(aDest,SA2->A2_NOME)\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t\r\n\t\t\t\t\tIf MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0 .or. !Empty(SA2->A2_NR_END)\r\n\t\t\t\t\t\taadd(aDest,iif(!Empty(SA2->A2_NR_END),alltrim(SA2->A2_NR_END),MyGetEnd(SA2->A2_END,\"SA2\")[3])) \r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taadd(aDest,\"SN\") \r\n\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\taadd(aDest,MyGetEnd(SA2->A2_END,\"SA2\")[4])\r\n\t\t\t\t\taadd(aDest,SA2->A2_BAIRRO)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_MUN)\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"99999\")\t\t\t\r\n\t\t\t\t\t\taadd(aDest,\"EXTERIOR\")\r\n\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\taadd(aDest,Upper(SA2->A2_EST))\r\n\t\t\t\t\taadd(aDest,SA2->A2_CEP)\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\taadd(aDest,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\")))\r\n\t\t\t\t\taadd(aDest,AllTrim(SA2->A2_DDD)+SA2->A2_TEL)\r\n\t\t\t\t\tIf !Upper(SA2->A2_EST) == \"EX\"\t\t\t\t\r\n\t\t\t\t\t\taadd(aDest,VldIE(SA2->A2_INSCR))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aDest,\"\")\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taadd(aDest,\"\")//SA2->A2_SUFRAMA\r\n\t\t\t\t\taadd(aDest,SA2->A2_EMAIL)\r\n\t\t\t\t\tIf SA2->(FieldPos(\"A2_CONTRIB\"))>0\r\n\t\t\t\t\t\taadd(aDest,SA2->A2_CONTRIB)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taAdd(aDest, \"\") \r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\taAdd(aDest, \"\")// Posição 18 (referente a A1_IENCONT, sendo passado como vazio já que não existe A2_IENCONT)\r\n\t\t\t\t\taadd(aDest,SA2->A2_INSCRM)\r\n\t\t\t\t\taadd(aDest,\"\")//Posição 20\r\n\t\t\t\t\taadd(aDest,SA2->A2_PFISICA)//21-Identificação estrangeiro\r\n\t\t\t\tEndIf\r\n\t\t       \r\n\t\t       If SF1->(FieldPos(\"F1_FORRET\"))<>0 .And. !Empty(SF1->F1_FORRET+SF1->F1_LOJARET) .And. SF1->F1_FORRET+SF1->F1_LOJARET<>SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SA2\")+SF1->F1_FORRET+SF1->F1_LOJARET)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_CGC)\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t\t\t\t\t\taadd(aRetirada,ConvType(IIF(MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0,MyGetEnd(SA2->A2_END,\"SA2\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aRetirada,MyGetEnd(SA2->A2_END,\"SA2\")[4])\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_BAIRRO)\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,SA2->A2_MUN)\r\n\t\t\t\t\t\taadd(aRetirada,Upper(SA2->A2_EST))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA2->A2_NOME))\r\n\t\t\t\t\t\taadd(aRetirada,Iif(!Empty(SA2->A2_INSCR),VldIE(SA2->A2_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA2->A2_CEP))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aRetirada,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(AllTrim(SA2->A2_DDD)+SA2->A2_TEL))\r\n\t\t\t\t\t\taadd(aRetirada,Alltrim(SA2->A2_EMAIL))\t\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_FORENT\")) <> 0 .And. !Empty(SF1->F1_FORENT+SF1->F1_LOJAENT) .And. SF1->F1_FORENT+SF1->F1_LOJAENT <> SF1->F1_FORNECE+SF1->F1_LOJA\r\n\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SA2\")+SF1->F1_FORENT+SF1->F1_LOJAENT)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_CGC)\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA2->A2_END,\"SA2\")[1])\r\n\t\t\t\t\t\taadd(aEntrega,ConvType(IIF(MyGetEnd(SA2->A2_END,\"SA2\")[2]<>0,MyGetEnd(SA2->A2_END,\"SA2\")[2],\"SN\")))\r\n\t\t\t\t\t\taadd(aEntrega,MyGetEnd(SA2->A2_END,\"SA2\")[4])\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_BAIRRO)\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_COD_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_MUN)\r\n\t\t\t\t\t\taadd(aEntrega,Upper(SA2->A2_EST))\r\n\t\t\t\t\t\taadd(aEntrega,SA2->A2_NOME)\r\n\t\t\t\t\t\taadd(aEntrega,Iif(!Empty(SA2->A2_INSCR),VldIE(SA2->A2_INSCR,.T.,.F.),\"\"))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA2->A2_CEP))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA2->A2_PAIS),\"1058\"  ,Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_SISEXP\")))\r\n\t\t\t\t\t\taadd(aEntrega,IIF(Empty(SA2->A2_PAIS),\"BRASIL\",Posicione(\"SYA\",1,xFilial(\"SYA\")+SA2->A2_PAIS,\"YA_DESCR\" )))\r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(AllTrim(SA2->A2_DDD)+SA2->A2_TEL)) \r\n\t\t\t\t\t\taadd(aEntrega,Alltrim(SA2->A2_EMAIL))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf \r\n\t\t\t\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\tIf SF1->F1_TIPO $ \"DB\" \r\n\t\t\t    dbSelectArea(\"SA1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA)\t\r\n\t\t\tElse\r\n\t\t\t    dbSelectArea(\"SA2\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA2\")+SF1->F1_FORNECE+SF1->F1_LOJA)\t\r\n\t\t\tEndIf\r\n\r\n\t\t\t// Faz o destaque do IPI nos dados complementares caso seja uma venda que possuir IPI\r\n\t\t\tnSF3Recno:= SF3->(RECNO())\r\n\t\t\tnSF3Index:= SF3->(IndexOrd()) \t\t\t\r\n\t\t\tSF3->(dbSetOrder(5))\r\n\t\t\tif ( SF3->(dbSeek(xFilial(\"SF3\")+cSerie+cNota)) ) \r\n\r\n\t\t\t\t//Conforme consultoria tributaria \r\n\t\t\t\t//§ 1º do artigo 442, do RICMS CE, determina que todos os documentos recebidos pelo Estado\r\n\t\t\t\t// que acobertam operações interestaduais com este Estado deverão possuir a Inscrição Estadual de Substituto\r\n\t\t\t\tIf SF3->F3_ESTADO == \"CE\"\t\t\t\t\t\r\n\t\t\t\t\tIf At (SF3->F3_ESTADO, cMVSUBTRIB)>0\r\n\t\t\t\t\t\tnPosI\t:=\tAt (SF3->F3_ESTADO, cMVSUBTRIB)+2\r\n\t\t\t\t\t\tnPosF\t:=\tAt (\"/\", SubStr (cMVSUBTRIB, nPosI))-1\r\n\t\t\t\t\t\tnPosF\t:=\tIIf(nPosF<=0,len(cMVSUBTRIB),nPosF)\t\t\t\t\t\t\r\n\t\t\t\t\t\taAdd (aIEST, SubStr (cMVSUBTRIB, nPosI, nPosF))\t//01 - IE_ST\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\taAdd (aIEST,iif(aDest[14]<> nil,aDest[14],\"\" ))\t//IE Dest.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\twhile SF3->F3_SERIE == cSerie .and. SF3->F3_NFISCAL == cNota\r\n\t\t\t\t\tIf SF3->F3_VALIPI > 0 .And. SF3->F3_TIPO == \"D\"\r\n\t\t\t\t\t\tnValIPIDestac += SF3->F3_VALIPI\t\t\t\t\r\n\t\t\t\t\tElseIf SF3->F3_IPIOBS > 0 .And. SF3->F3_TIPO == \"D\"\r\n\t\t\t\t\t\tnValIPIDestac += SF3->F3_IPIOBS\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\tSF3->(dbSkip())\r\n\t\t\t\tend\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\tif nValIPIDestac > 0\r\n\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcMensFis += \"Valor do IPI: R$ \" + AllTrim(Transform(nValIPIDestac, \"@ze 9,999,999,999,999.99\")) + \" \"\r\n\t\t\t\tendif  \r\n\t\t\t\t\r\n\t\t\tEndIf\t\r\n\t\t\t\r\n\t  \r\n\t\t\tSF3->(DBSETORDER(nSF3Index))\r\n\t\t\tSF3->(DBGOTO(nSF3Recno))\r\n\t\t\t\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Verifica Duplicatas da nota de entrada                                  ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\r\n\t\t\tIf !Empty(SF1->F1_DUPL)\t\r\n\t\t\t\tdbSelectArea(\"SE2\")\r\n\t\t\t\tdbSetOrder(1)\t\r\n\t\t\t\t#IFDEF TOP\r\n\t\t\t\t\tlQuery  := .T.\r\n\t\t\t\t\tcAliasSE2 := GetNextAlias()\r\n\t\t\t\t\tBeginSql Alias cAliasSE2\r\n\t\t\t\t\t\tCOLUMN E2_VENCORI AS DATE\r\n\t\t\t\t\t\tSELECT E2_FILIAL,E2_PREFIXO,E2_NUM,E2_PARCELA,E2_TIPO,E2_FORNECE,E2_LOJA,E2_VENCORI,E2_VALOR,E2_VLCRUZ,E2_ORIGEM,E2_ISS\r\n\t\t\t\t\t\tFROM %Table:SE2% SE2\r\n\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\tSE2.E2_FILIAL = %xFilial:SE2% AND\r\n\t\t\t\t\t\tSE2.E2_PREFIXO = %Exp:SF1->F1_PREFIXO% AND\r\n\t\t\t\t\t\tSE2.E2_NUM = %Exp:SF1->F1_DUPL% AND\r\n\t\t\t\t\t\tSE2.E2_FORNECE = %Exp:SF1->F1_FORNECE% AND\r\n\t\t\t\t\t\tSE2.E2_LOJA = %Exp:SF1->F1_LOJA% AND\r\n\t\t\t\t\t\tSE2.E2_TIPO = %Exp:MVNOTAFIS% AND\r\n\t\t\t\t\t\tSE2.%NotDel%\r\n\t\t\t\t\t\tORDER BY %Order:SE2%\r\n\t\t\t\t\tEndSql\r\n\t\t\t\t\t\r\n\t\t\t\t#ELSE\r\n\t\t\t\t\tMsSeek(xFilial(\"SE2\")+SF1->F1_PREFIXO+SF1->F1_DOC)\r\n\t\t\t\t#ENDIF\r\n\t\t\t\tWhile !Eof() .And. xFilial(\"SE2\") == (cAliasSE2)->E2_FILIAL .And.;\r\n\t\t\t\t\tSF1->F1_PREFIXO == (cAliasSE2)->E2_PREFIXO .And.;\r\n\t\t\t\t\tSF1->F1_DOC == (cAliasSE2)->E2_NUM\r\n\t\t\t\t\tIf \t(cAliasSE2)->E2_TIPO==MVNOTAFIS .And. (cAliasSE2)->E2_FORNECE==SF1->F1_FORNECE .And. (cAliasSE2)->E2_LOJA==SF1->F1_LOJA\r\n\t\t\t\t\t\taadd(aDupl,{(cAliasSE2)->E2_PREFIXO+(cAliasSE2)->E2_NUM+(cAliasSE2)->E2_PARCELA,(cAliasSE2)->E2_VENCORI,(cAliasSE2)->E2_VLCRUZ - IIF(!lRuleDescISS, (cAliasSE2)->E2_ISS, 0) })\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tdbSelectArea(cAliasSE2)\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t    EndDo\r\n\t\t\t    If lQuery\r\n\t\t\t    \tdbSelectArea(cAliasSE2)\r\n\t\t\t    \tdbCloseArea()\r\n\t\t\t    \tdbSelectArea(\"SE2\")\r\n\t\t\t    EndIf\r\n\t\t\tElse\r\n\t\t\t\taDupl := {}\r\n\t\t\tEndIf\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Analisa os impostos de retencao                                         ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf SF1->(FieldPos(\"F1_VALPIS\"))<>0 .And. SF1->F1_VALPIS>0\r\n\t\t\t\taadd(aRetido,{\"PIS\",0,SF1->F1_VALPIS})\r\n\t\t\tEndIf\r\n\t\t\tIf SF1->(FieldPos(\"F1_VALCOFI\"))<>0 .And. SF1->F1_VALCOFI>0\r\n\t\t\t\taadd(aRetido,{\"COFINS\",0,SF1->F1_VALCOFI})\r\n\t\t\tEndIf\r\n\t\t\tIf SF1->(FieldPos(\"F1_VALCSLL\"))<>0 .And. SF1->F1_VALCSLL>0\r\n\t\t\t\taadd(aRetido,{\"CSLL\",0,SF1->F1_VALCSLL})\r\n\t\t\tEndIf\r\n\t\t\tIf SF1->(FieldPos(\"F1_INSS\"))<>0 .and. SF1->F1_INSS>0\r\n\t\t\t\taadd(aRetido,{\"INSS\",SF1->F1_BASEINS,SF1->F1_INSS})\r\n\t\t\tEndIf\r\n\t\t\t//RECOPI\r\n\t\t\tIf SF1->(FieldPos(\"F1_IDRECOP\")) > 0 .and. !Empty(SF1->F1_IDRECOP)\r\n\t\t\t\tcIdRecopi := SF1->F1_IDRECOP\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf !Empty(cIdRecopi)\r\n\t\t\t\tIf AliasIndic(\"CE3\")\r\n\t\t\t\t\tCE3->(DbSetOrder(1))\r\n\t\t\t\t\tIf CE3->(DbSeek(xFilial(\"CE3\")+Alltrim(cIdRecopi)))\r\n\t\t\t\t\t\tcNumRecopi:= IIf(CE3->(FieldPos(\"CE3_RECOPI\")) > 0, Alltrim(CE3->CE3_RECOPI), \"\")\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Volumes / Especie Nota de Entrada                                       ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tcScan := \"1\"\r\n\t\t\tif (nPosCpoEsp := SF1->(ColumnPos(\"F1_ESPECI\"+cScan))) > 0\r\n\r\n\t\t\t\tnPosCpoVol := SF1->(ColumnPos(\"F1_VOLUME\"+cScan))\r\n\t\t\t\tnPosCpoMrc := 0\r\n\t\t\t\tnPosCpoNum := 0\r\n\t\t\t\tif !empty(cMRCVLMSF1)\r\n\t\t\t\t\taCpoMarVol := StrTokArr2(cMRCVLMSF1, \";\" ) \r\n\t\t\t\t\tif len(aCpoMarVol) == 2\r\n\t\t\t\t\t\tcCpoMarca := alltrim(aCpoMarVol[1])\r\n\t\t\t\t\t\tcCpoNumer := alltrim(aCpoMarVol[2])\r\n\t\t\t\t\t\tnPosCpoMrc := SF1->(ColumnPos(cCpoMarca + cScan)) \r\n\t\t\t\t\t\tnPosCpoNum := SF1->(ColumnPos(cCpoNumer + cScan))\r\n\t\t\t\t\tendif\r\n\t\t\t\tendif\r\n\r\n\t\t\t\tWhile ( !Empty(cScan) )\r\n\t\t\t\t\tcEspecie := \"\"\r\n\t\t\t\t\tnVolume := 0\r\n\t\t\t\t\tcMarca := \"\"\r\n\t\t\t\t\tcNumeracao := \"\"\r\n\r\n\t\t\t\t\tif nPosCpoEsp > 0\r\n\t\t\t\t\t\tcEspecie := upper(SF1->(FieldGet(nPosCpoEsp)))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\t\tIf !empty(cEspecie)\r\n\r\n\t\t\t\t\t\tif nPosCpoMrc > 0\r\n\t\t\t\t\t\t\tcMarca := alltrim(SF1->(FieldGet(nPosCpoMrc)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoNum > 0\r\n\t\t\t\t\t\t\tcNumeracao := alltrim(SF1->(FieldGet(nPosCpoNum)))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif nPosCpoVol > 0\r\n\t\t\t\t\t\t\tnVolume := SF1->(FieldGet(nPosCpoVol))\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tnScan := aScan(aEspVol,{|x| x[1] == cEspecie})\r\n\t\t\t\t\t\tIf ( nScan==0 )\r\n\t\t\t\t\t\t\taadd(aEspVol,{ cEspecie, nVolume , SF1->F1_PLIQUI , SF1->F1_PBRUTO, cMarca, cNumeracao})\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taEspVol[nScan][2] += nVolume\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tcScan := Soma1(cScan,1)\r\n\t\t\t\t\tnPosCpoEsp := SF1->(ColumnPos(\"F1_ESPECI\"+cScan))\r\n\t\t\t\t\tIf nPosCpoEsp == 0 \r\n\t\t\t\t\t\tcScan := \"\"\r\n\t\t\t\t\t\texit\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tnPosCpoVol := SF1->(ColumnPos(\"F1_VOLUME\"+cScan))\r\n\t\t\t\t\tif !empty(cCpoMarca) .and. !empty(cCpoNumer)\r\n\t\t\t\t\t\tnPosCpoMrc := SF1->(ColumnPos(cCpoMarca+cScan))\r\n\t\t\t\t\t\tnPosCpoNum := SF1->(ColumnPos(cCpoNumer+cScan))\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\tEndDo\r\n\t\t\tEndIf\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Posiciona transportador                                                 ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf FieldPos(\"F1_TRANSP\") > 0 .And. !Empty(SF1->F1_TRANSP)\r\n\t\t\t\tdbSelectArea(\"SA4\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SA4\")+SF1->F1_TRANSP)\r\n\t\t\t\t\r\n\t\t\t\taadd(aTransp,AllTrim(SA4->A4_CGC))\r\n\t\t\t\taadd(aTransp,SA4->A4_NOME)\r\n\t\t\t\taadd(aTransp,VldIE(SA4->A4_INSEST))\r\n\t\t\t\taadd(aTransp,SA4->A4_END)\r\n\t\t\t\taadd(aTransp,SA4->A4_MUN)\r\n\t\t\t\taadd(aTransp,Upper(SA4->A4_EST)\t)\r\n\t\t\t\taadd(aTransp,SA4->A4_EMAIL\t)\r\n\t\t\t\t\tIf !Empty(SF1->F1_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,SF1->F1_PLACA)\r\n\t\t\t\t\t\taadd(aVeiculo,SA4->A4_EST)\r\n\t\t\t\t\t\taadd(aVeiculo,\"\")//RNTC\r\n\t\t\t\t\tEndIf\t\t\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SF1->(FieldPos(\"F1_MENNOTA\"))>0\r\n\t\t\t\tIf !AllTrim(SF1->F1_MENNOTA) $ cMensCli\r\n\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIF len(aCMPUSR) > 1  \r\n\t\t\t\t\t\tcFieldMsg := aCMPUSR[2]  \r\n\t\t\t\t\tEndIf  \r\n\t\t\t\t\tIf !Empty(cFieldMsg) .and. SF1->(FieldPos(cFieldMsg)) > 0 .and. !Empty(&(\"SF1->\"+cFieldMsg))\r\n\t\t\t\t\t\tcMensCli := alltrim(&(\"SF1->\"+cFieldMsg))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcMensCli += AllTrim(SF1->F1_MENNOTA)\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SF1->(FieldPos(\"F1_MENPAD\")) > 0  .and. !Empty(SF1->F1_MENPAD)\r\n\t\t\t\tcRetForm := FORMULA(SF1->F1_MENPAD)\r\n\t\t\t\tIf cRetForm <> nil .And. !AllTrim(cRetForm) $ cMensFis\r\n\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcMensFis += AllTrim(cRetForm)\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\r\n\t\t\tcField := \"%\"\r\n\t\t\tIf SD1->(FieldPos(\"D1_ICMSDIF\")) > 0\r\n\t\t\t\tcField += \",D1_ICMSDIF\"\r\n\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_FILORI\")) > 0\r\n\t\t\t\tcField += \",D1_FILORI\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_DESCZFR\")) > 0\r\n\t\t\t\tcField += \",D1_DESCZFR\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_DESCZFP\")) > 0\r\n\t\t\t\tcField += \",D1_DESCZFP\"\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf SD1->(FieldPos(\"D1_DESCZFC\")) > 0\r\n\t\t\t\tcField += \",D1_DESCZFC\"\r\n\t\t\tEndIf\r\n\t\t\tIf SD1->(FieldPos(\"D1_GRPCST\"))<>0 //Grupo de tributação de ipi\r\n\t\t\t   cField  +=\",D1_GRPCST\"\t\t\t\t    \r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf SD1->( ColumnPos('D1_AFRMIMP') ) > 0 //Campo específico para despesa de importação\r\n\t\t\t   cField  +=\",D1_AFRMIMP\"\t\t\t\t    \r\n\t\t\tEndIf\t\t\t\r\n\r\n\t\t\tIf SD1->( ColumnPos('D1_VOPDIF') ) > 0\r\n\t\t\t   cField  +=\",D1_VOPDIF\"\t\t\t\t    \r\n\t\t\tEndIf\r\n\r\n\t\t\tif SD1->(ColumnPos(\"D1_FCICOD\"))<>0\r\n\t\t\t\tcField  +=\",D1_FCICOD\"\t\t\t\t\t\t    \r\n\t\t\tEndIF\r\n\t\t\t\r\n\t\t\tcField += \"%\"\r\n\t\t\t\r\n\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\tdbSetOrder(1)\t\r\n\t\t\t#IFDEF TOP\r\n\t\t\t\tlQuery  := .T.\r\n\t\t\t\tcAliasSD1 := GetNextAlias()\r\n\t\t\t\tBeginSql Alias cAliasSD1\t\t\t\r\n\t\t\t\t\t\tSELECT D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_COD,D1_ITEM,D1_TES,D1_TIPO,D1_NFORI,D1_SERIORI,D1_ITEMORI,\r\n\t\t\t\t\t\tD1_CF,D1_QUANT,D1_TOTAL,D1_VALDESC,D1_VALFRE,D1_SEGURO,D1_DESPESA,D1_CODISS,D1_VALISS,D1_VALIPI,D1_ICMSRET,\r\n\t\t\t\t\t\tD1_VUNIT,D1_CLASFIS,D1_VALICM,D1_TIPO_NF,D1_PEDIDO,D1_ITEMPC,D1_VALIMP5,D1_VALIMP6,D1_BASEIRR,D1_VALIRR,D1_LOTECTL, \r\n\t\t\t\t\t\tD1_NUMLOTE,D1_CUSTO,D1_ORIGLAN,D1_DESCICM,D1_II,D1_FORMUL,D1_VALPS3,D1_ORIGLAN,D1_VALCF3,D1_TESACLA,D1_IDENTB6,D1_PICM,D1_DESC  %Exp:cField%\r\n\t\t\t\t\t\tFROM %Table:SD1% SD1\r\n\t\t\t\t\t\tWHERE\r\n\t\t\t\t\t\tSD1.D1_FILIAL  = %xFilial:SD1% AND\r\n\t\t\t\t\t\tSD1.D1_SERIE   = %Exp:SF1->F1_SERIE% AND\r\n\t\t\t\t\t\tSD1.D1_DOC     = %Exp:SF1->F1_DOC% AND\r\n\t\t\t\t\t\tSD1.D1_FORNECE = %Exp:SF1->F1_FORNECE% AND\r\n\t\t\t\t\t\tSD1.D1_LOJA    = %Exp:SF1->F1_LOJA% AND\r\n\t\t\t\t\t\tSD1.D1_FORMUL  = 'S' AND\r\n\t\t\t\t\t\tSD1.%NotDel%\r\n\t\t\t\t\t\tORDER BY D1_FILIAL,D1_DOC,D1_SERIE,D1_FORNECE,D1_LOJA,D1_ITEM,D1_COD\r\n\t\t\t\tEndSql\r\n\r\n\t\t\t#ELSE\r\n\t\t\t\tMsSeek(xFilial(\"SD1\")+SF1->F1_DOC+SF1->F1_SERIE+SF1->F1_FORNECE+SF1->F1_LOJA)\r\n\t\t\t#ENDIF\r\n\t\t\t\r\n\t\t\tnCountIT := 0\r\n\t\t\tWhile !Eof() .And. xFilial(\"SD1\") == (cAliasSD1)->D1_FILIAL .And.;\r\n\t\t\t\tSF1->F1_SERIE == (cAliasSD1)->D1_SERIE .And.;\r\n\t\t\t\tSF1->F1_DOC == (cAliasSD1)->D1_DOC .And.;\r\n\t\t\t\tSF1->F1_FORNECE == (cAliasSD1)->D1_FORNECE .And.;\r\n\t\t\t\tSF1->F1_LOJA ==  (cAliasSD1)->D1_LOJA\t\t\t\t\r\n\r\n\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SF4\")+(cAliasSD1)->D1_TES)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t   \tIf SF4->F4_AGRPIS = \"1\"\r\n\t\t\t\t\t\taAdd(aAgrPis,{.T.,0})\r\n\t\t\t\t\t\taAgrPis[Len(aAgrPis)][2] := (cAliasSD1)->D1_VALIMP6\r\n\t\t\t\tElse\r\n\t\t\t\t\t\taAdd(aAgrPis,{.F.,0})\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tIf SF4->F4_AGRCOF = \"1\"\r\n\t\t\t\t\t\taAdd(aAgrCofins,{.T.,0})\r\n\t\t\t\t\t\taAgrCofins[Len(aAgrCofins)][2] := (cAliasSD1)->D1_VALIMP5\r\n\t\t\t\tElse\r\n\t\t\t\t\t\taAdd(aAgrCofins,{.F.,0})\r\n\t\t\t\tEndIf\r\n\r\n\r\n\t\t\t\tIf SD1->(FieldPos(\"D1_DESCZFR\"))>0\r\n\t\t            nDescZF := (cAliasSD1)->D1_DESCZFR\r\n\t\t\t\tElse\r\n\t\t\t\t\tnDescZF := 0\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//Tratamento para nota sobre Cupom \r\n\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t    DbSetOrder(1)\r\n\t\t\t    IF SFT->(DbSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA)))\r\n\t\t\t\t\tIF AllTrim(SFT->FT_OBSERV) <> \" \" .AND.(cAliasSD1)->D1_ORIGLAN==\"LO\"\r\n\t\t\t\t\t\tIf !Alltrim(SFT->FT_OBSERV) $ Alltrim(cMensCli) \r\n\t\t\t\t\t\t\tIf \"DEVOLUCAO N.F.\" $ Upper(SFT->FT_OBSERV) \r\n\t\t\t\t\t\t\t\tcMensCli +=\" \" + StrTran(AllTrim(SFT->FT_OBSERV),\"N.F.\",\"C.F.\")\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcMensCli +=\" \" + AllTrim(SFT->FT_OBSERV)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf       \r\n           \t\t\tEndIf\r\n\t        \tEndIF\t\t\t\r\n\t\r\n\t\t\t\tdbSelectArea(\"SF4\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_STATUS\"))>0 .And.SD1->(FieldPos(\"D1_TESACLA\"))>0 .And. SF1->F1_STATUS='C' \r\n\t\t\t\t\tMsSeek(xFilial(\"SF4\")+(cAliasSD1)->D1_TESACLA)\r\n\t\t\t\tElse \r\n\t\t\t\t\tMsSeek(xFilial(\"SF4\")+(cAliasSD1)->D1_TES)\r\n\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\tcChaveD1 := \"E\" + ( cAliasSD1 )->( D1_SERIE + D1_DOC + D1_FORNECE + D1_LOJA + D1_ITEM )\t\t\t\t\r\n\t\t\t\tSFT->( dbSetOrder( 1 ) )\r\n\t\t\t\t//utiliza a funcao SpedNatOper ( SPEDXFUN ) que possui o tratamento para a natureza da operacao/prestacao\r\n\t\t\t\tif FindFunction( \"SpedNatOper\" ) .And. SFT->( MsSeek( xFilial( \"SFT\" ) + cChaveD1 ) )\r\n\t\t\t\t\tIf !Alltrim(SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ])$cNatOper\r\n\t\t\t\t\t\tIf\tEmpty(cNatOper)\r\n\t\t\t\t\t\t\tcNatOper := SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcNatOper := cNatOper + \"/ \" +SpedNatOper( nil , lNatOper , \"SFT\" , \"SF4\" , .T. )[ 2 ]\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\telse\r\n\t\t\t\t\tIf !lNatOper\r\n\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\tcNatOper := Alltrim(SF4->F4_TEXTO)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcNatOper += Iif(!Alltrim(SF4->F4_TEXTO)$cNatOper,\"/ \" + SF4->F4_TEXTO,\"\")\r\n\t\t\t\t\t\tEndif \r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taSX513 \t := FwGetSX5(\"13\",SF4->F4_CF)\r\n\t\t\t\t\t\tIf len(aSX513) > 0\r\n\t\t\t\t\t\t\tIf Empty(cNatOper)\r\n\t\t\t\t\t\t\t\tcNatOper := AllTrim(SubStr(aSX513[1][4],1,55))\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcNatOper += Iif(!AllTrim(SubStr(aSX513[1][4],1,55)) $ cNatOper, \"/ \" + AllTrim(SubStr(aSX513[1][4],1,55)), \"\")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t    \t\tEndIf\r\n\t\t    \tendif\r\n\t    \t\t\r\n\t    \t\tIf SF4->(FieldPos(\"F4_BASEICM\"))>0\r\n\t    \t\t\tnRedBC := IiF(SF4->F4_BASEICM>0,IiF(SF4->F4_BASEICM == 100,SF4->F4_BASEICM,IiF(SF4->F4_BASEICM > 100,0,100-SF4->F4_BASEICM)),SF4->F4_BASEICM)\r\n\t    \t\t\tcCST   := SF4->F4_SITTRIB \r\n\t    \t\tEndif\r\n\t    \t\t\r\n\t    \t\t//Operação com diferimento parcial de 66,66% do RICMS/PR para importação\r\n\t    \t\tlDifParc := .F.\r\n\t    \t\tIf (SF4->(FieldPos(\"F4_PICMDIF\"))>0 .And. \"66.66\" $ Alltrim(Str(SF4->F4_PICMDIF)) ) ;\r\n\t    \t\t\t.And. (SF4->(FieldPos(\"F4_ICMSDIF\"))>0 .And. SF4->F4_ICMSDIF <> \"2\") ;\r\n\t    \t\t\t.And. (SubStr(SM0->M0_CODMUN,1,2)=='41' .And. SubStr((cAliasSD1)->D1_CF,1,1) == '3')\t    \t\t\t\r\n\t\t\t\t\tlDifParc := .T.\r\n\t    \t\tEndIf\r\n\t    \t\t\r\n\t    \t\tIf ((cAliasSD1)->D1_VALICM > 0 .And. (cAliasSD1)->D1_ICMSDIF > 0 ) .And. lDifParc\r\n\t    \t\t\tnValIcmDev += (cAliasSD1)->D1_VALICM   //Valor total do ICMS devido\r\n\t    \t\t\tnValIcmDif += (cAliasSD1)->D1_ICMSDIF  //Valor total do ICMS diferido \r\n\t    \t\tEndIf\r\n\t    \t\t//O campo F4_FORINFC é o substituto do F4_FORMULA, e através do parâmetro MV_NFEMSF4  se determina se o conteudo da formula devera compor a mensagem do cliente(=\"C\") ou do fisco(=\"F\").\r\n\t\t\t\tIf (cAliasSD1)->D1_FORMUL==\"S\"\r\n\t\t\t\t\tIf SF4->(ColumnPos(\"F4_FORINFC\") ) > 0  .And. !Empty(SF4->F4_FORINFC) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORINFC)\r\n\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4==\"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4==\"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\tElseIf !Empty(SF4->F4_FORMULA) .and. ( cMVNFEMSF4 == \"C\" .or. cMVNFEMSF4 == \"F\" )\r\n\t\t\t\t\t\tcRetForm := Formula(SF4->F4_FORMULA)\r\n\t\t\t\t\t\tif cRetForm <> NIL .And. ( ( cMVNFEMSF4 == \"C\" .And. !AllTrim(cRetForm) $ cMensCli ) .Or. (cMVNFEMSF4 == \"F\" .And. !AllTrim(cRetForm)$cMensFis) )\r\n\t\t\t\t\t\t\tIf cMVNFEMSF4==\"C\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensCli) > 0 .And. SubStr(cMensCli, Len(cMensCli), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensCli\t+=\tcRetForm\r\n\t\t\t\t\t\t\tElseIf cMVNFEMSF4==\"F\"\r\n\t\t\t\t\t\t\t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tcMensFis\t+=\tcRetForm\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf lMvImpFecp \r\n\t\t\t\t\tIf (lValFecp .Or. lVfecpst) \r\n\t\t\t\t    \tDbSelectArea(\"SFT\")\r\n\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\tIf SFT->(DbSeek((xFilial(\"SFT\") + cChaveD1 )))\t\r\n\t\t\t\t\t    \tnValTFecp += SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\r\n\t\t\t\t\t\t\tnValIFecp := SFT->FT_VFECPST + SFT->FT_VALFECP  + SFT->FT_VFECPMG + SFT->FT_VFESTMG\t\t\t\t\t\t\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t   \r\n\t\t\t\t\tEndif\t\t\t\t\t\r\n\t\t\t\tEndif\r\n\t   \t\t\t\r\n\t\t\t\t//Verifica se existe Template DCL\r\n      \t\t\tIF (ExistTemplate(\"PROCMSG\"))\r\n      \t\t\t\taMens := ExecTemplate(\"PROCMSG\",.f.,.f.,{cAliasSD1})      \t\t\t\t\t\t\t\t\t\t \t\t      \t\t\t\t\t\r\n\t\t\t\t\t\tFor nA:=1 to len(aMens)\r\n\t\t\t\t\t\t    If aMens[nA][1] == \"V\" .Or. (aMens[nA][1] == \"T\" .And. Ascan(aMensAux,aMens[nA][2])==0)\r\n\t\t\t\t\t\t\t\tAADD(aMensAux,aMens[nA][2])\r\n\t\t\t\t\t\t\tEndif\t\r\n\t\t\t\t\t\tNext    \t\t\t\t\t\r\n     \t\t\tEndif \r\n     \t\t\t\r\n     \t\t\t// Verifica se o CFOP é de devolução por consignação mercantil (CFOP 1111/1111/1918/2918)\r\n\t\t\t\tIf  AllTrim((cAliasSD1)->D1_CF) == \"1111\" .Or.  AllTrim((cAliasSD1)->D1_CF) == \"2111\" .or.  AllTrim((cAliasSD1)->D1_CF) == '1918' .or.   AllTrim((cAliasSD1)->D1_CF) == '2918'\r\n\t\t\t\t\tlConsig  := .T.\r\n\t\t\t\tEndIf\r\n     \t\t\t\r\n     \t\t\t\r\n\t\t\t\t/*Tratamento para NF DE AJUSTE chamado THYZ13 -  PORTARIA N° 163/2007 Artigo 18-B-2 item 4a da SEFAZ-MT */\r\n\t\t\t\t\r\n\t\t\t\tif SF4->F4_AJUSTE ==\"S\" .and. aDest[1] == SM0->M0_CGC .and. (cAliasSD1)->(D1_TIPO) == \"D\" .and. (cAliasSD1)->D1_FORMUL == \"S\"\r\n\t\t\t\t\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\taAreaSA1\t:= SA1->(GetArea())\t\t\t\r\n\t\t\t\t\taAreaSYA\t:= SYA->(GetArea())\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tif SF2->(DbSeek(xFilial(\"SF2\")+(cAliasSD1)->(D1_NFORI)+(cAliasSD1)->(D1_SERIORI))) \r\n\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\r\n\t\t\t\t\t\tif SA1->(DbSeek(xFilial(\"SA1\")+(SF2->F2_CLIENTE)+(SF2->F2_LOJA)))\r\n\t\t\t\t\t\t\tcMensCli += iIf(!Empty(SA1->A1_CGC),'CNPJ: '+Rtrim(SA1->A1_CGC) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_NOME),' NOME: '+Rtrim(SA1->A1_NOME) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_END),' ENDEREÇO: '+Rtrim(SA1->A1_END) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_BAIRRO),' BAIRRO: '+Rtrim(SA1->A1_BAIRRO) ,'')\r\n\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SA1->A1_EST),' UF: '+Rtrim(SA1->A1_EST) ,'')\r\n\t\t\t\t\t\t\tif !Empty(SA1->A1_PAIS)\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SYA\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tif SYA->(DbSeek(xFilial(\"SYA\")+(SA1->A1_PAIS)))\r\n\t\t\t\t\t\t\t\t\tcMensCli += iIf (!Empty(SYA->YA_DESCR),' PAIS: '+Rtrim(SYA->YA_DESCR),'')\r\n\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\taAdd( aNfVinc, { SF2->F2_EMISSAO, SF2->F2_SERIE, SF2->F2_DOC,SA1->A1_CGC,SF2->F2_EST,SF2->F2_ESPECIE, SF2->F2_CHVNFE, 0,\"\",\"\",0,\"\",\"\" })\r\n\t\t\t\t\tlVinc := .T.\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tendif\t\t\t\t\r\n\t\t\t\t\tRestArea(aAreaSF2)\r\n\t\t\t\t\tRestArea(aAreaSA1)\t\t\t\t\r\n\t\t\t\t\tRestArea(aAreaSYA)\t\t\t\t\r\n\t\t\t\tendif     \t\t\t\r\n     \t\t\t\r\n     \t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Verifica as notas vinculadas                                            ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\tIf !Empty((cAliasSD1)->D1_NFORI)\r\n\t\t\t\t\t\r\n\t\t\t\t\taAreaSF2  \t:= SF2->(GetArea())\r\n\t\t\t\t\tdbSelectArea(\"SF2\")\r\n        \t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf SF2->(DbSeek(xFilial(\"SF2\")+(cAliasSD1)->(D1_NFORI)+(cAliasSD1)->(D1_SERIORI))) \r\n        \t\t\t\tcSpecie:= Alltrim(SF2->F2_ESPECIE)\r\n        \t\t\tEndIf\r\n        \t\t\tRestArea(aAreaSF2)\r\n\t\t\t\t\t\r\n\t\t\t\t\taOldReg  := SD1->(GetArea())\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Realiza o backup do order e recno da SF1\r\n\t\t\t\t\tnOrderSF1\t:= SF1->( indexOrd() )\r\n\t\t\t\t\tnRecnoSF1\t:= SF1->( recno() )\r\n\r\n\t\t\t\t\tlNfCompl\t:= SF1->F1_TIPO == \"C\" .And. cMVEstado == \"RS\" \r\n                 \r\n                \t//Ajustes para que ao gerar nota de entrada do tipo complemento de preço de uma devolução seja vinculado o cliente correto \r\n\t\t\t\t\t//da nota de origem.                \t\t\r\n\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tcSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SD1\")+cSeekD1)\r\n\t\t\t\t\t\tcTipoNF :=  SD1->D1_TIPO \r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO) $ \"NCI\" // Tratamento para notas de entrada noadminrmais e complementares buscar o fornecedor original corretamente\r\n\t\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO) <> \"N\"  .AND.  cTipoNF $ 'DB'\r\n\t\t\t\t\t\t    cSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+SD1->D1_FORNECE+SD1->D1_LOJA+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_ITEMORI\r\n\t\t\t\t\t    ELSE\r\n\t\t\t\t\t        cSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_ITEMORI\r\n\t\t\t\t\t        cSeekAux:= (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI\r\n\t\t\t\t\t    EndIf\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcSeekD1 := (cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI\r\n\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\r\n\t\t\t\t\taAreaSD1 := SD1->(GetArea())\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Alterado a chave de busca completa devido ao procedimento de complemento de notas de devolucao de VENDA onde o codigo do fornecedor não seja o mesmo da nota de origem \r\n\t\t\t\t\tIf !MsSeek(xFilial(\"SD1\")+cSeekD1) .and. ((cAliasSD1)->D1_TIPO) $ \"C|I\"\r\n\t\t\t\t\t\tcSeekD1:= cSeekAux\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf MsSeek(xFilial(\"SD1\")+cSeekD1)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tSF1->( dbSetOrder( 1 ) )\r\n\t\t\t\t\t\tSF1->( msSeek( xFilial( \"SF1\" ) + SD1->D1_DOC + SD1->D1_SERIE + SD1->D1_FORNECE + SD1->D1_LOJA + SD1->D1_TIPO ) )\r\n\t\t\t\t\t\tlSeekOk := .T.\r\n\t\t\t\t\t\tIf SD1->D1_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD1->D1_FORNECE+SD1->D1_LOJA)\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t        lRural := ( AllTrim(SF1->F1_ESPECIE) == \"NFP\" .Or. AllTrim(SF1->F1_ESPECIE) == \"NFA\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tlSeekOk := .F.\r\n\t\t\t\t\t\tRestArea(aAreaSD1)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf !(cAliasSD1)->D1_TIPO $ \"DBN\" .Or. lRural\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Obtem os dados de nota fiscal de produtor rural referenciada                                  ³\r\n\t\t\t\t\t\t//³Temos duas situacoes:                                                                         ³\r\n\t\t\t\t\t\t//³A NF de saída é uma devolucao, onde a NF original pode ser ou nao uma devolução.              ³\r\n\t\t\t\t\t\t//³1) Quando a NF original for uma devolucao, devemos utilizar o remetente do documento fiscal,  ³\r\n\t\t\t\t\t\t//³    podendo ser o sigamat.emp no caso de formulario proprio ou o proprio SA1 no caso de nf de ³\r\n\t\t\t\t\t\t//³    entrada com formulario proprio igual a NAO.                                               ³\r\n\t\t\t\t\t\t//³2) Quando a NF original NAO for uma devolucao, neste caso tambem pode variar conforme o       ³\r\n\t\t\t\t\t\t//³    formulario proprio igual a SIM ou NAO. No caso do NAO, os dados a serem obtidos retornara ³\r\n\t\t\t\t\t\t//³    da tabela SA2.                                                                            ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\tIf ( AllTrim(SF1->F1_ESPECIE)== \"NFP\" .Or. AllTrim(SF1->F1_ESPECIE)== \"NFA\" ) .and. lSeekOk\r\n\t\t\t\t\t\t\t//para nota de entrada tipo devolucao o emitente eh o cliente ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\tIf SD1->D1_TIPO$\"DB\"\r\n\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA1->A1_CGC),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA1->A1_EST),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA1->A1_INSCR)})\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//para nota de entrada normal o emitente eh o fornecedor ou o sigamat no caso de formulario proprio=sim\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\taadd(aNfVincRur,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA2->A2_CGC),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA2->A2_EST),; \r\n\t\t\t\t\t\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA2->A2_INSCR)})\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t    \t//|                                                             ³\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\tIf AllTrim(SF1->F1_ESPECIE)==\"CF\" .and. lSeekOk\r\n\t\t\t\t\t\t\taadd(aRefECF,{SD1->D1_DOC,SF1->F1_ESPECIE})\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t// Outros documentos referenciados\r\n\t\t\t\t\t\tif !lRural .and. lSeekOk\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tif cChave <> dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE;\r\n\t\t\t\t\t\t\t\t.or. ( cAliasSD2 )->D2_ITEM <> cItemOr\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taAdd( aNfVinc, { SD1->D1_EMISSAO, SD1->D1_SERIE, SD1->D1_DOC, iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ), SM0->M0_ESTCOB, SF1->F1_ESPECIE, SF1->F1_CHVNFE,SD1->D1_TOTAL,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\tcChave\t:= dToS( SD1->D1_EMISSAO ) + SD1->D1_SERIE + SD1->D1_DOC + iIf( SD1->D1_TIPO $ \"DB\", iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA1->A1_CGC ), iIf( SD1->D1_FORMUL == \"S\", SM0->M0_CGC, SA2->A2_CGC ) ) + SM0->M0_ESTCOB + SF1->F1_ESPECIE + SF1->F1_CHVNFE\r\n\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF1->F1_CHVNFE, SF1->F1_VALBRUT})\r\n\t\t\t\t\t\t\t\t//Busca NFP vinculada, da nota Original.\r\n\t\t\t\t\t\t\t\tIf lNfCompl\r\n\t\t\t\t\t\t\t\t\taNfVincRur :=\tRetNfpVinc(SD1->D1_DOC,SD1->D1_SERIE,SD1->D1_FORNECE,SD1->D1_LOJA)\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t    endIf\r\n\t\t\t\t\t\t    \r\n\t\t\t\t\t    \tcItemOr\t:= ( cAliasSD1 )->D1_ITEM\r\n\t\t\t\t\t    \t\r\n\t\t\t\t\t    endIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tdbSelectArea(\"SD2\")\r\n\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\tIF (cAliasSD1)->D1_ORIGLAN ==\"LO\"\r\n\t\t\t\t\t\t    If (cAliasSD1)->(FieldPos(\"D1_FILORI\")) > 0\r\n\t\t\t\t\t\t\t\tcFilDev := Iif(Empty((cAliasSD1)->D1_FILORI),xFilial(\"SD2\"),(cAliasSD1)->D1_FILORI)\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcFilDev := xFilial(\"SD2\")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t   cMsSeek\t:=(cFilDev+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI)\r\n\t\t\t\t\t\tELSE \r\n\t\t\t\t\t\t\tIf (cAliasSD1)->(FieldPos(\"D1_FILORI\")) > 0\r\n\t\t\t\t\t\t\t\tcFilDev := Iif(Empty((cAliasSD1)->D1_FILORI),xFilial(\"SD2\"),(cAliasSD1)->D1_FILORI)\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcFilDev := xFilial(\"SD2\")\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tif !(SF4->F4_AJUSTE=='S' .and. ((cAliasSD1)->D1_TIPO == \"D\")) .and. cSpecie <> 'NFCE' .And. !DevCliEntr(cAliasSD1)\r\n\t\t\t\t\t   \t\t\tcMsSeek\t:=(cFilDev+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_COD+(cAliasSD1)->D1_ITEMORI)\r\n\t\t\t\t\t   \t\telse  /* Quando for uma devolução de Ajuste não tem necessidade de informar os outros campo para posicionar na SD2. chamado TIANDL*/\r\n\t\t\t\t\t   \t\t\tcMsSeek\t:=(cFilDev+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI)\r\n\t\t\t\t\t   \t\tendif       \r\n\t\t\t\t\t\tEndIF                                                                          \r\n\t\t\t\t\t\t    \r\n\t\t\t\t\t\tIF MsSeek (cMsSeek)\r\n\t\t\t\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\tMsSeek(cFilDev+SD2->D2_DOC+SD2->D2_SERIE+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\tIf !SD2->D2_TIPO $ \"DB\"\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA1\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t//Tratamento para os campos do Loja(cNfRefcup = Numero da Nota de complemento sobre cupom /cSerRefcup = Serie da Nota de complemento sobre cupom)\r\n\t\t\t\t\t\t\t\tif SD2->(FieldPos(\"D2_NFCUP\")) <> 0\r\n\t\t\t\t\t\t\t\t\tcNfRefcup := SD2->D2_NFCUP\r\n\t\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\t\tcNfRefcup := \"\"\r\n\t\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\t\t\tcSerRefcup := SD2->D2_SERIORI\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SA2\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\tMsSeek(xFilial(\"SA2\")+SD2->D2_CLIENTE+SD2->D2_LOJA)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t\t    \t//|                                                             ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t\t\t\tIf Alltrim(SF2->F2_ESPECIE)==\"CF\" .OR. (LjAnalisaLeg(18)[1] .AND. \"ECF\"$SF2->F2_ESPECIE)\r\n\t\t\t\t\t\t\t\taadd( aRefECF,{ SD2->D2_DOC,SF2->F2_ESPECIE,SF2->F2_PDV } )\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Outros documentos referenciados³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf cChave <> Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taadd(aNfVinc,{SD2->D2_EMISSAO,SD2->D2_SERIE,SD2->D2_DOC,SM0->M0_CGC,SM0->M0_ESTCOB,SF2->F2_ESPECIE,SF2->F2_CHVNFE,SD2->D2_TOTAL-SD2->D2_DESCON,SD2->D2_PEDIDO,SF2->F2_TIPO,iif(SD2->D2_TIPO $ \"DB\",2,1),SD2->D2_CLIENTE,SD2->D2_LOJA})\r\n\t\t\t\t\t\t\t\tlVinc := .T.\r\n\t\t\t\t\t\t\t\tcChave := Dtos(SF2->F2_EMISSAO)+SD2->D2_SERIE+SD2->D2_DOC+SM0->M0_CGC+SM0->M0_ESTCOB+SF2->F2_ESPECIE+SF2->F2_CHVNFE\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tnCountIT += 1\r\n\t\t\t\t\t\t\t\taAdd(aValTotOpe, {SF2->F2_CHVNFE, SF2->F2_VALBRUT})\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tElseIf (cAliasSD1)->D1_TIPO == \"N\" .And. (cAliasSD1)->D1_FORMUL = \"S\"                                                  \t\t\t\t\t\t\r\n\t\t\t\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\t\t   \t\tdbSetOrder(4)\r\n\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_SERIORI+(cAliasSD1)->D1_NFORI)\r\n\t\t\t\t\t   \t\t\tdbSelectArea(\"SF3\")\r\n\t\t\t\t\t\t   \t\tdbSetOrder(4)\r\n\t\t\t\t\t\t   \t\tIf MsSeek(xFilial(\"SF3\")+SFT->FT_CLIEFOR+SFT->FT_LOJA+SFT->FT_NFISCAL+SFT->FT_SERIE)\r\n\t\t\t\t\t\t   \t\t\tIf cChave <> dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA2->A2_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE;\r\n\t\t\t\t\t   \t\t\t\t\t.or. ( cAliasSD1 )->D1_ITEM <> cItemOr\r\n\t\t\t\t\t   \t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\taAdd( aNfVinc, { SF3->F3_EMISSAO, SF3->F3_SERIE, SF3->F3_NFISCAL, SA2->A2_CGC, SM0->M0_ESTCOB, SF3->F3_ESPECIE, SF3->F3_CHVNFE,0,\"\",\"\",0,\"\",\"\" } )\r\n\t\t\t\t\t\t\t\t\t\tcChave\t:= dToS( SF3->F3_EMISSAO ) + SF3->F3_SERIE + SF3->F3_NFISCAL + SA2->A2_CGC + SM0->M0_ESTCOB + SF3->F3_ESPECIE + SF3->F3_CHVNFE\r\n\t\t\t\t\t\t\t\t\t\tlVinc := .T. \r\n\t\t\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\t\t\t\tcItemOr\t:= ( cAliasSD1 )->D1_ITEM\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tRestArea(aOldReg)\r\n\t\t\t\t\t\r\n\t\t\t\t\t// Restaura a ordem e recno da SF1\r\n\t\t\t\t\tSF1->( dbSetOrder( nOrderSF1 ) )\r\n\t\t\t\t\tSF1->( dbGoTo( nRecnoSF1 ) )\r\n\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t//³Verifica as notas vinculadas na tabela SF8 - Amarracao NF Orig x NF Imp/Fre     ³\r\n\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\t\tIf Alltrim( (cAliasSD1)->D1_ORIGLAN ) $ \"D-DP-FR\" .And. Alltrim( (cAliasSD1)->D1_TIPO ) == \"C\"\r\n\t\t\t\t\t\tdbSelectArea(\"SF8\")\r\n\t\t\t\t\t\tdbSetOrder(3)\r\n\t\t\t\t\t\tIf dbSeek(cChavesf8:=xFilial(\"SF8\")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA)\r\n\t\t\t\t\t\t\taAreaSD1 := SD1->(GetArea())\r\n\t\t\t\t\t\t\taAreaSF1 := SF1->(GetArea())\r\n\t\t\t\t\t\t\tDo While cChavesf8 == SF8->(F8_FILIAL+F8_NFDIFRE+F8_SEDIFRE+F8_TRANSP+F8_LOJTRAN)\r\n\t\t\t\t\t\t\t\tdbSelectArea(\"SD1\")\r\n\t\t\t\t\t\t\t\tdbSetOrder(1)  \r\n\t\t\t\t\t\t\t\tIf dbSeek(xFilial(\"SD1\")+SF8->F8_NFORIG+SF8->F8_SERORIG+SF8->F8_FORNECE+SF8->F8_LOJA)\r\n\t\t\t\t\t\t\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\tIf dbSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA+SD1->D1_TIPO)\r\n\t\t\t\t\t\t\t\t\t\tAADD(aNfVinc,{SF1->F1_EMISSAO,SF1->F1_SERIE,SF1->F1_DOC,SM0->M0_CGC,SM0->M0_ESTCOB,SF1->F1_ESPECIE,SF1->F1_CHVNFE,0,\"\",\"\",0,\"\",\"\"})\r\n\t\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\tSF8->(DbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\t\tRestArea(aAreaSD1)\r\n\t\t\t\t\t\t\tRestArea(aAreaSF1)\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\tEndif\t\r\n\t\t\t\tEndIf \r\n\t\t\t\t\r\n\t\t\t\tIf lVinc .and. !Empty(aNfVinc)\r\n\t\t\t\t\taADD(aItemVinc,{ATail(aNfVinc)[1]})\r\n\t\t\t\tElse\r\n\t\t\t\t\taADD(aItemVinc,{})\r\n\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Obtem os dados do produto                                               ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tMsSeek(xFilial(\"SB1\")+(cAliasSD1)->D1_COD)\r\n\t\t\t\t//Veiculos Novos\r\n\t\t\t\tIf AliasIndic(\"CD9\")\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"CD9\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD9\")+cChaveD1)\r\n\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t//Combustivel\r\n\t\t\t\tIf AliasIndic(\"CD6\")\r\n\t\t\t\t\tdbSelectArea(\"CD6\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD6\")+cChaveD1)\r\n\t\t\t\tEndIf\r\n\t\t\t\t//Medicamentos\r\n\t\t\t\tIf AliasIndic(\"CD7\")\r\n\t\t\t\t\tdbSelectArea(\"CD7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD7\")+cChaveD1)\r\n\t\t\t\tEndIf\r\n\t            // Armas de Fogo\r\n\t            If AliasIndic(\"CD8\")\r\n\t\t\t\t\tdbSelectArea(\"CD8\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"CD8\")+cChaveD1)\r\n\t\t\t\tEndIf\r\n\t\t\t\t//Anfavea\r\n\t\t\t\tIf lAnfavea\r\n\t\t\t\t\tdbSelectArea(\"CDR\")\r\n\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\tMsSeek(xFilial(\"CDR\")+\"S\"+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA)\r\n\r\n\t\t\t\t\tdbSelectArea(\"CDS\")\r\n\t\t\t\t\tdbSetOrder(1) \r\n\t\t\t\t\tMsSeek(xFilial(\"CDS\")+\"S\"+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_ITEM+(cAliasSD1)->D1_COD)\r\n\t\t\t\tEndIf   \r\n\t\t\t\t//RASTREABILIDADDE\r\n\t         \tIf AliasIndic(\"F0A\")\r\n\t\t\t\t\tdbSelectArea(\"F0A\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tMsSeek(xFilial(\"F0A\")+cChaveD1)\r\n\t\t\t\tEndIf \r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"SB5\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf MsSeek(xFilial(\"SB5\")+(cAliasSD1)->D1_COD)\r\n\t\t\t\t\tIf SB5->(FieldPos(\"B5_DESCNFE\")) > 0 .And. !Empty(SB5->B5_DESCNFE)\r\n\t\t\t\t\t\tcInfAdic := Alltrim(SB5->B5_DESCNFE)\r\n\t\t\t\t\tElse\t\r\n\t\t\t\t\t\tcInfAdic := \"\"\t\t\t\t\r\n\t\t\t\t\tEndIF\r\n\r\n                    cUmDipi  := SB5->B5_UMDIPI\r\n                    nConvDip := SB5->B5_CONVDIP\r\n\t\t\t\tElse\r\n\t\t\t\t\tcInfAdic := \"\"\r\n                    cUmDipi  := \"\"\r\n                    nConvDip := 0\r\n\t\t\t\tEndIF \r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"DY3\")\r\n\t\t\t   \tdbSetOrder(1)\r\n\t\t\t   \tIf MsSeek(xFilial(\"DY3\")+ (cAliasSB5)->B5_ONU)\r\n\t\t\t\t\tIf !Empty(DY3->DY3_DESCRI) .and. DY3->DY3_INFCPL ==\"S\"\r\n\t\t\t\t\t\tIf !cMensONU $ DY3->DY3_ONU\r\n\t\t\t\t     \t   \tcMensONU\t:= cMensONU +'  ONU '+Alltrim(DY3->DY3_ONU)+' '+Alltrim(DY3->DY3_DESCRI)+'   '   \r\n\t\t\t\t    \tEndIF\r\n\t\t\t   \t\tEndIF  \t\t\r\n\t\t\t\tEndIF\r\n\r\n                //Atualiza a Unid. Medida da DIPI(cUmDipi) e o Fator de Conv. da DIPI(nConvDip) com dados da SBZ caso os parâmetro recebidos estejam vazios\r\n                RetInfoSBZ((cAliasSD1)->D1_COD, @cUmDipi, @nConvDip)\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³ Conforme Decreto RICM, N 43.080/2002 valido somente em MG deduzir o \t³ \r\n\t\t\t\t//³\timposto dispensado na operação\t\t\t\t  \t\t\t                ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tnDescRed := 0\r\n\t\t\t\tdbSelectArea(\"SFT\")\r\n\t\t\t\tdbSetOrder(1)\r\n\r\n\t\t\t\tMsSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_ITEM+(cAliasSD1)->D1_COD) \r\n\t\t\t\tIf SFT->(FieldPos(\"FT_DS43080\")) <> 0 .And. SFT->FT_DS43080 > 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\tnDescRed := SFT->FT_DS43080 \r\n\t\t\t\t\tnDesTotal+= nDescRed\r\n\t\t\t\tEndIF\r\n\t\t\t\t\r\n\t\t\t\tIf SFT->(ColumnPos(\"FT_DESCFIS\")) <> 0 .And. SFT->FT_DESCFIS > 0\r\n\t\t\t\t\tnDescFis := SFT->FT_DESCFIS\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf (SFT->(ColumnPos(\"FT_CRDPRES\")) <> 0 .And. SFT->FT_CRDPRES > 0) .and. ( SF4->F4_AGREGCP $\"1|S\")\r\n\t\t\t\t\tnCrdPres := SFT->FT_CRDPRES\r\n\t\t\t\t\tnTotCrdP += nCrdPres\r\n\t\t\t\tEndIf \r\n\r\n\t\t\t\tIf SD1->(FieldPos(\"D1_DESCICM\"))<>0\r\n\t\t\t\t\tnDescIcm := ( IIF(SF4->F4_AGREG == \"D\",(cAliasSD1)->D1_DESCICM,0) )\r\n\t\t\t\t\tIf cVerAmb >= \"3.10\" .and. SF4->F4_AGREG == \"D\" .and. (!Empty(SF4->F4_MOTICMS) .and. (!AllTrim(SF4->F4_MOTICMS) $ \"8|9\" .or. AllTrim(SF4->F4_MOTICMS) != \"90\")) .and. Empty(SF4->F4_CSOSN)\r\n\t\t\t\t\t\tnDescIcm:=0\r\n\t\t\t\t\tEndIF\t\t\t\t\t\t\r\n\t\t\t\tEndIF\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//Alteração realizada no campo F4_ICMSDIF, foi incluido a opção: 6 – Diferido(Deduz NF e Duplicata)\r\n\t\t\t\t//no combo para deduzir os valores de ICMS diferido na NF e da Duplicata\r\n\t\t\t\t//http://tdn.totvs.com/display/public/PROT/2892815+DSERFIS1-6266+DT+Diferimento+ICMS\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\r\n\t\t\t\tnDescNfDup :=0\r\n\t\t\t\tIf\tSF4->F4_ICMSDIF == \"6\"\r\n\t\t\t\t\tnDescNFDup := IIF(SF1->(F1_STATUS) == 'C', (cAliasSD1)->(D1_ICMSDIF),SFT->FT_ICMSDIF)\r\n\t\t\t\tEndIF \r\n\t\t\t\t\t\t\r\n\t\t\t\t//Tratamento para o Tipo de Frete no documento de entrada\r\n\t\t\t\tIf SF1->(FieldPos(\"F1_TPFRETE\")) > 0 .And. !Empty( SF1->F1_TPFRETE )\t\t\t\t\t\r\n\t\t\t\t\tIf SF1->F1_TPFRETE==\"C\"\r\n\t\t\t\t\t\tcModFrete := \"0\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"F\"\r\n\t\t\t\t\t \tcModFrete := \"1\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"T\"\r\n\t\t\t\t\t \tcModFrete := \"2\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"R\"\r\n\t\t\t\t\t \tcModFrete := \"3\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"D\"\r\n\t\t\t\t\t \tcModFrete := \"4\"\r\n\t\t\t\t\tElseIf SF1->F1_TPFRETE==\"S\"\r\n\t\t\t\t\t \tcModFrete := \"9\"\r\n\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tcModFrete := IIF(SF1->F1_FRETE>0,\"0\",\"1\")\r\n\t\t\t\tEndIf\r\n\t\t\t\taAdd(aInfoItem,{(cAliasSD1)->D1_PEDIDO,(cAliasSD1)->D1_ITEMPC,(cAliasSD1)->D1_TES,(cAliasSD1)->D1_ITEM})\r\n\t\t\t\t\r\n\t\t\t\t//Tratamento para que o valor de ICMS ST venha a compor o valor da tag vOutros quando for uma nota de Devolução, impedindo que seja gerada a rejeição 610.\r\n\t\t       nIcmsST := 0\r\n\t\t       If (!lIcmSTDev .And. (cAliasSD1)->D1_TIPO == \"D\" .And. SubStr((cAliasSD1)->D1_CLASFIS,2,2) $ '10#30#70#90') .Or. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM) .Or. (!lIcmSTDev .And. lComplDev .And. (cAliasSD1)->D1_TIPO == \"I\" )\r\n\t\t       nIcmsST := (cAliasSD1)->D1_ICMSRET\r\n\t\t       EndIf   \t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//Tratamento para verificar se o produto é controlado por terceiros (IDENTB6)³\r\n\t\t\t\t//e a partir do tipo do documento (Cliente ou Fornecedor) verifica  se existe³\r\n\t\t\t\t//amarracao entre Produto X Cliente(SA7) ou Produto X Fornecedor(SA5)       ³  \r\n\t\t\t\t//Caso haja a amarracao, o codigo e descricao do produto, assumem o conteudo  ³\r\n\t\t\t\t//da SA7 ou SA5\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t   ³ \r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ  \r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcCodProd  := (cAliasSD1)->D1_COD\t            \r\n\t\t\t\tcDescProd := SB1->B1_DESC \r\n\t\t\t\t\t \r\n\t\t\t\tIf !Empty((cAliasSD1)->D1_IDENTB6) .And. lNFPTER  \r\n\t\t\t\t\tIf (cAliasSD1)->D1_TIPO == \"N\" \r\n\t\t\t\t\t\t//--A5_FILIAL + A5_FORNECE + A5_LOJA + A5_PRODUTO\r\n\t\t\t\t\t\tSA5->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\tIf SA5->(MsSeek( xFilial(\"SA5\") + (cAliasSD1)->(D1_FORNECE+D1_LOJA+D1_COD) )) .and. !empty(SA5->A5_CODPRF) .and. !empty(SA5->A5_DESREF)\r\n\t\t\t\t\t\t\tcCodProd  := SA5->A5_CODPRF \r\n\t\t\t\t\t\t\tcDescProd := SA5->A5_DESREF \t            \r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tElseIf (cAliasSD1)->D1_TIPO == \"B\"\r\n\t\t\t         //--A7_FILIAL + A7_CLIENTE + A7_LOJA + A7_PRODUTO\r\n\t\t\t\t\t\tSA7->(dbSetOrder(1)) \t         \r\n\t\t\t\t\t\tIf SA7->(MsSeek( xFilial(\"SA7\") + (cAliasSD1)->(D1_FORNECE+D1_LOJA+D1_COD) )) .and. !empty(SA7->A7_CODCLI) .and. !empty(SA7->A7_DESCCLI) \r\n\t\t\t\t\t\t\tcCodProd  := SA7->A7_CODCLI \r\n\t\t\t\t\t\t\tcDescProd := SA7->A7_DESCCLI\t            \t\t\t\t\t\t\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcOrigem:= IIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,1,1),'0')\r\n\t\t\t    cCSTrib:= IIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,2,2),'50')\r\n\t\t\t            \r\n\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t//\t\t\tFCI - Ficha de Conteúdo de Importação\r\n\t\t\t\t//-----------------------------------------------------------------------------------------\r\n\t\t\t\t//**Operação INTERNA:\r\n\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da importação      (Industrialização)\r\n\t\t\t\t//\r\n\t\t\t\t//**Operação INTERESTADUAL:\r\n\t\t\t\t//1) Emitente da NF (vendedor) NÃO realizou processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da importação      (Revenda)\r\n\t\t\t\t//2) Emitente da NF (vendedor) REALIZOU processo de industrialização com a mercadoria:\r\n\t\t\t\t// - Informar o valor da parcela importada do exterior, o número da FCI e o Conteúdo de\r\n\t\t\t\t//   Importação expresso percentualmente (Industrialização)\r\n\t\t\t\t//----------------------------------------------------------------------------------------- \r\n\t\t\t\t\t\t\r\n\t\t\t\tIf (cOrigem $\"1-2-3-4-5-6-8\" .And. cCSTrib $ \"00-10-20-30-40-41-50-51-60-70-90\")\r\n\t\t\t\t\tIf (cAliasSD1)->(ColumnPos(\"D1_FCICOD\")) > 0 .And. !Empty((cAliasSD1)->D1_FCICOD)\r\n\t\t\t\t\t\taadd(aFCI,{(cAliasSD1)->D1_FCICOD}) \r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf lFCI\r\n\t\t\t\t\t\t\tcMsgFci\t:= \"Resolucao do Senado Federal nº 13/12\"\r\n\t\t\t\t\t\t\tcInfAdic  += cMsgFci + \", Numero da FCI \" + Alltrim((cAliasSD1)->D1_FCICOD) + \".\"\r\n\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse \r\n\t\t\t\t\taadd(aFCI,{})\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³  ³Código de Benefício Fiscal na UF aplicado ao item\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \r\n\t\t\t\tlCodLan := .F.\r\n\t\t\t\tIf SM0->M0_ESTENT $ \"PR/RJ/RS/\" //TAG cBenef buscar o conteúdo da tabela 5.2 no sistema quando for do PR.\r\n\t\t\t\t\tdbSelectArea(\"CDV\")\r\n\t\t\t\t\tdbSetOrder(4)\r\n\t\t\t\t\tcCodlan :=\"\"\r\n\t\t\t\t\tIf MsSeek(xFilial(\"CDV\") +'E'+PadR('SPED',TamSX3(\"CDV_ESPECI\")[1])+'S'+(cAliasSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_ITEM))\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//Tratamento realizado enquanto o fiscal não realiza a criação do campo na CDV\r\n\t\t\t\t\t\tif CDV->(ColumnPos(\"CDV_NFE\")) > 0\r\n\t\t\t\t\t\t\tif CDV->CDV_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\tendif\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tdbSelectArea(\"CDY\")\r\n\t\t\t\t\t\t\tdbSetOrder(1)\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf CDV->(ColumnPos(\"CDV_CODAJU\")) > 0 .and. !Empty(CDV->CDV_CODAJU) .and. MsSeek( xFilial(\"CDY\") + CDV->CDV_CODAJU)\r\n\t\t\t\t\t\t\t\tIf CDY->CDY_NFE <> \"2\"\r\n\t\t\t\t\t\t\t\t\tlCodLan := .T.\r\n\t\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\tendif\r\n\r\n\t\t\t\t\t\tif lCodLan\r\n\t\t\t\t\t\t\tcCodlan:= CDV->CDV_CODAJU\r\n\t\t\t\t\t\tendif\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcCodlan := getCodLan( alltrim(SM0->M0_ESTENT), SF4->F4_SITTRIB, cAmbiente )\r\n\t\t\t\t\tEndIF\r\n\t\t\t\tElse\r\n\t\t\t\t\tcCodlan := \"\"\t\r\n\t\t\t\t\tIf SM0->M0_ESTENT <> \"SP\" .and. CDA->(ColumnPos(\"CDA_CODLAN\")) > 0\r\n\t\t\t\t\t\tdbSelectArea(\"CDA\")\r\n\t\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\t\tcSeekCDA := xFilial(\"CDA\") +'E'+PadR('SPED',TamSX3(\"CDA_ESPECI\")[1])+'S'+(cAliasSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_ITEM)\r\n\t\t\t\t\t\tIf MsSeek(cSeekCDA) //CDA_FILIAL, CDA_TPMOVI, CDA_ESPECI, CDA_FORMUL, CDA_NUMERO, CDA_SERIE, CDA_CLIFOR, CDA_LOJA, CDA_NUMITE, CDA_SEQ, CDA_CODLAN, CDA_CALPRO\r\n\t\t\t\t\t\t\tWhile alltrim(cSeekCDA) == alltrim(CDA->(CDA_FILIAL + CDA_TPMOVI + CDA_ESPECI + CDA_FORMUL + CDA_NUMERO + CDA_SERIE + CDA_CLIFOR + CDA_LOJA + CDA_NUMITE))\r\n\t\t\t\t\t\t\t\tIf !Empty(CDA->CDA_CODLAN) .And. CDA->CDA_TPLANC == \"2\" .and. Len(AllTrim(CDA->CDA_CODLAN)) == 10\r\n\t\t\t\t\t\t\t\t\tcCodlan := CDA->CDA_CODLAN\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\tCDA->(dbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\t\t\tEndIf\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³  Indicador de Produção em escala relevante, conforme Cláusula 23 do Convenio ICMS 52/2017\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ \t\t\t\t\t\t\r\n\t\t\t\tIf AliasIndic(\"D3E\")\r\n\t\t\t\t\tdbSelectArea(\"D3E\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tcIndEscala :=\"\"\r\n\t\t\t\t\tIf MsSeek(PADR(xFilial(\"D3E\"),TAMSX3(\"D3E_FILIAL\")[1]) +(cAliasSD1)->D1_COD)\r\n\t\t\t\t\t\tIf D3E->(ColumnPos(\"D3E_INDESC\")) > 0\r\n\t\t\t\t\t\t\tIf\t!Empty(D3E->D3E_INDESC)  .AND.  D3E->D3E_INDESC == \"1\"\r\n\t\t\t\t\t\t\t\tcIndEscala:= \"S\"\r\n\t\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\tEndIF\t\t\r\n\t\t\t\tEndIF\t\t\r\n\t\t\t\t\r\n\t\t\t\tcTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,(cAliasSD1)->D1_CF)\r\n\t\t\t\t\r\n\t\t\t\tIf((cAliasSD1)->D1_TIPO <> \"D\") .Or. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM)\r\n\t\t\t\t\tlEIPIOutro := .F.\r\n\t\t\t\tEnd\r\n\t\t\t\t\r\n\t\t\t\tIf ((cAliasSD1)->D1_TIPO <> 'B')\r\n\t\t\t\t\tlIPIOutB :=.F.\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).\r\n\t\t\t\tnValOutr  := 0\r\n\t\t\t\tIf (((cAliasSD1)->D1_TIPO == \"D\" .And. (!lEipiDev .Or. lEIPIOutro)) .Or. ((cAliasSD1)->D1_TIPO == \"B\" .and. lIpiBenef)) \r\n\r\n\t\t\t\t    If ((cAliasSD1)->D1_TIPO == \"D\" .and.  lEIPIOutro ) .or. ((cAliasSD1)->D1_TIPO == \"B\" .and. lIPIOutB)\r\n\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n                    EndIf \t\t            \t\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\tnValOutr += 0\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tnValOutr += (cAliasSD1)->D1_VALIPI\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tnValOutr += (cAliasSD1)->D1_DESPESA + (cAliasSD1)->D1_VALPS3 + (cAliasSD2)->D2_VALCF3 + nIcmsST + nCrdPres\r\n\t\t\t\tcTpOrig  := IIF(nCountIT > 0 .And. Len(aNfVinc[nCountIT]) > 9, aNfVinc[nCountIT][10], \"\")\r\n\t\t\t\t\t\t\t\t            \t\t            \t\t\t\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t/*\r\n\t\t\t\tBruno Sigawie\r\n\t\t\t\tse for a itinga a chamada e orignal \r\n\t\t\t\tse for qualita muda a função U_RETPESOFAT\r\n\t\t\t\t*/\r\n\t\t\t\t\r\n\t\t\t\t//If SubString(CNUMEMP,1,2) == \"05\"\r\n\t\t\t\t\t\t\t\t            \t\t            \t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\taadd(aProd,\t{Len(aProd)+1,;  \r\n\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\tSB1->B1_POSIPI,;\r\n\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_CF,;\r\n\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_QUANT,;\r\n\t\t\t\t\t\tIIF(!((cAliasSD1)->D1_TIPO $\"IP\" .Or. ((cAliasSD1)->D1_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,(IIF(!(lMvNFLeiZF),(cAliasSD1)->D1_TOTAL,(cAliasSD1)->D1_TOTAL - ((cAliasSD1)->D1_DESCZFP+(cAliasSD1)->D1_DESCZFC))),0),;\r\n\t\t\t\t\t\tretUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\tretQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), nConvDip, (cAliasSD1)->D1_QUANT ),;    //retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_CONVDIP, (cAliasSD1)->D1_QUANT ),;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_VALFRE,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_SEGURO,;\r\n\t\t\t\t\t\tnDescRed + nDescIcm + nDescNfDup + (cAliasSD1)->D1_VALDESC + nDescFis -(SFT->FT_DESCZFR),;\r\n\t\t\t\t\t   \tIIF(!((cAliasSD1)->D1_TIPO $\"IP\"),(cAliasSD1)->D1_VUNIT,0),;\r\n\t\t\t\t\t   \tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF  \r\n\t\t\t\t\t\t(cAliasSD1)->D1_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t(cAliasSD1)->D1_NUMLOTE,;//Numero do Lote \r\n\t\t\t\t\t\tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).\r\n\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\tIIF(SF4->F4_AGREG<>'N' .And. SF4->F4_ISS='S',\"1\",IIF(SF4->F4_AGREG='N' .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\")),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t(cAliasSD1)->D1_TES,;\r\n\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t0,;  // Da posição 28 a 30 tratamento realizado apenas para documento de saída por este motivo campos estão zerados e vazios.\r\n\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFP\"))<>0,(cAliasSD1)->D1_DESCZFP,0),;\t\t\t//Desconto Zona Franca PIS\r\n\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFC\"))<>0,(cAliasSD1)->D1_DESCZFC,0),;\t\t\t//Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t(cAliasSD1)->D1_PICM,;\t\t// [33] Percentual de ICMS\r\n\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;\t\t// [34]\r\n\t\t\t\t\t\t0,;\t\t// [35]\r\n\t\t\t\t\t\t0,;\t\t// [36]\r\n\t\t\t\t\t\t0,;\t\t// [37]\r\n\t\t\t\t\t\t0,;\t\t// [38]\r\n\t\t\t\t\t\t0,;\t\t// [39]\r\n\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_GRPCST\")) > 0 .and. !Empty((cAliasSD1)->D1_GRPCST),(cAliasSD1)->D1_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //[40]\r\n\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aprod[41] NT2015/003\r\n\t\t\t\t\t\tIIF(SF4->(ColumnPos(\"F4_VENPRES\"))>0,SF4->F4_VENPRES,\"\"),; //aprod[42] utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\tnValIFecp ,; //aprod[43]  Valor do FECP. \r\n\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),; //aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),; //aprod[46] \r\n\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\tSF4->F4_ART274,; //aprod[48]\r\n\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t})\r\n\t\t\t\t/*Else\r\n\t\t\t\t\taadd(aProd,\t{Len(aProd)+1,;  \r\n\t\t\t\t\t\t\t\tcCodProd,;\r\n\t\t\t\t\t\t\t\tIIf(Val(SB1->B1_CODBAR)==0,\"\",StrZero(Val(SB1->B1_CODBAR),Len(Alltrim(SB1->B1_CODBAR)),0)),;\r\n\t\t\t\t\t\t\t\tcDescProd,;\r\n\t\t\t\t\t\t\t\tSB1->B1_POSIPI,;\r\n\t\t\t\t\t\t\t\tSB1->B1_EX_NCM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_CF,;\r\n\t\t\t\t\t\t\t\tSB1->B1_UM,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_QUANT,;\r\n\t\t\t\t\t\t\t\tIIF(!((cAliasSD1)->D1_TIPO $\"IP\" .Or. ((cAliasSD1)->D1_TIPO $ \"D\" .And. cTpOrig == \"P\")) ,(IIF(!(lMvNFLeiZF),(cAliasSD1)->D1_TOTAL,(cAliasSD1)->D1_TOTAL - ((cAliasSD1)->D1_DESCZFP+(cAliasSD1)->D1_DESCZFC))),0),;\r\n\t\t\t\t\t\t\t\tretUn2UM ( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), \"\", SB1->B1_UM            ) ,; // BRUNO retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), cUmDipi, SB1->B1_UM ),;                 //retUn2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_UMDIPI, SB1->B1_UM ),;\r\n\t\t\t\t\t\t\t\tretQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), 0 , (cAliasSD1)->D1_QUANT ) ,; // BRUNO retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), nConvDip, (cAliasSD1)->D1_QUANT ),;    //retQtd2UM( lNoImp2UM, cCFOPExp, Alltrim((cAliasSD1)->D1_CF), SB5->B5_CONVDIP, (cAliasSD1)->D1_QUANT ),;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_VALFRE,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_SEGURO,;\r\n\t\t\t\t\t\t\t\tnDescRed + nDescIcm + nDescNfDup + (cAliasSD1)->D1_VALDESC + nDescFis -(SFT->FT_DESCZFR),;\r\n\t\t\t\t\t\t\t   \tIIF(!((cAliasSD1)->D1_TIPO $\"IP\"),(cAliasSD1)->D1_VUNIT,0),;\r\n\t\t\t\t\t\t\t   \tIIF(SB1->(FieldPos(\"B1_CODSIMP\"))<>0,SB1->B1_CODSIMP,\"\"),; //codigo ANP do combustivel\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CODIF\"))<>0,SB1->B1_CODIF,\"\"),; //CODIF  \r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_LOTECTL,;//Controle de Lote\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_NUMLOTE,;//Numero do Lote \r\n\t\t\t\t\t\t\t\tnValOutr,;//Outras despesas + PISST + COFINSST  (Inclusão do valor de PIS ST e COFINS ST na tag vOutros - NT 2011/004).\r\n\t\t\t\t\t\t\t\tnRedBC,;//% Redução da Base de Cálculo\r\n\t\t\t\t\t\t\t\tcCST,;//Cód. Situação Tributária\r\n\t\t\t\t\t\t\t\tIIF(SF4->F4_AGREG<>'N' .And. SF4->F4_ISS='S',\"1\",IIF(SF4->F4_AGREG='N' .Or. (SF4->F4_ISS='S' .And. SF4->F4_ICM='N'),\"0\",\"1\")),;// Tipo de agregação de valor ao total do documento\r\n\t\t\t\t\t\t\t\tcInfAdic,;//Informacoes adicionais do produto(B5_DESCNFE)\r\n\t\t\t\t\t\t\t\tnDescZF,;\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_TES,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;  // Da posição 28 a 30 tratamento realizado apenas para documento de saída por este motivo campos estão zerados e vazios.\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFP\"))<>0,(cAliasSD1)->D1_DESCZFP,0),;\t\t\t//Desconto Zona Franca PIS\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_DESCZFC\"))<>0,(cAliasSD1)->D1_DESCZFC,0),;\t\t\t//Desconto Zona Franca CONFINS\r\n\t\t\t\t\t\t\t\t(cAliasSD1)->D1_PICM,;\t\t// [33] Percentual de ICMS\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_TRIBMUN\"))<>0,RetFldProd(SB1->B1_COD,\"B1_TRIBMUN\"),\"\"),;\t\t// [34]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [35]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [36]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [37]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [38]\r\n\t\t\t\t\t\t\t\t0,;\t\t// [39]\r\n\t\t\t\t\t\t\t\tIIF((cAliasSD1)->(FieldPos(\"D1_GRPCST\")) > 0 .and. !Empty((cAliasSD1)->D1_GRPCST),(cAliasSD1)->D1_GRPCST,IIF(SB1->(FieldPos(\"B1_GRPCST\")) > 0 .and. !Empty(SB1->B1_GRPCST),SB1->B1_GRPCST, IIF(SF4->(FieldPos(\"F4_GRPCST\")) > 0 .and. !Empty(SF4->F4_GRPCST),SF4->F4_GRPCST,\"999\"))),; //[40]\r\n\t\t\t\t\t\t\t\tIIF(SB1->(FieldPos(\"B1_CEST\"))<>0,SB1->B1_CEST,\"\"),; //aprod[41] NT2015/003\r\n\t\t\t\t\t\t\t\tIIF(SF4->(ColumnPos(\"F4_VENPRES\"))>0,SF4->F4_VENPRES,\"\"),; //aprod[42] utilizado para montar a tag indPres=1 para nota de devolução de venda\r\n\t\t\t\t\t\t\t\tnValIFecp ,; //aprod[43]  Valor do FECP. \r\n\t\t\t\t\t\t\t\tcCodlan,; //aprod[44]  Código de Benefício Fiscal na UF aplicado ao item .\r\n\t\t\t\t\t\t\t\tIIf(SB5->(ColumnPos(\"B5_2CODBAR\")) > 0,IIf(Val(SB5->B5_2CODBAR)==0,\"\",StrZero(Val(SB5->B5_2CODBAR),Len(Alltrim(SB5->B5_2CODBAR)),0)),\"\"),; //aprod[45]  Código de barra da segunda unidade de medida.\r\n\t\t\t\t\t\t\t\tIIf(SB1->(ColumnPos(\"B1_CODGTIN\")) > 0,SB1->B1_CODGTIN,\"\"),; //aprod[46] \r\n\t\t\t\t\t\t\t\tcIndEscala,; //aprod[47]  Indicador de Escala Relevante\r\n\t\t\t\t\t\t\t\tSF4->F4_ART274,; //aprod[48]\r\n\t\t\t\t\t\t\t\t0,;  //aprod[49]   nValLeite\r\n\t\t\t\t\t\t\t\t})\r\n\t\t\t\tEndIf\t\r\n\t\t\t\t*/\r\n\t\t\t\t\t\r\n\t\t\t\t\t        \r\n\t\t\t\taadd(aCST,{IIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,2,2),'50'),;\r\n\t\t\t\t\tIIF(!Empty((cAliasSD1)->D1_CLASFIS),SubStr((cAliasSD1)->D1_CLASFIS,1,1),'0')})\r\n\t\t\t\taadd(aICMS,{})\r\n\t\t\t\taadd(aIPI,{})\r\n\t\t\t\taadd(aICMSST,{})\r\n\t\t\t\taadd(aPIS,{})\r\n\t\t\t\taadd(aPISST,{})\r\n\t\t\t\taadd(aCOFINS,{})\r\n\t\t\t\taadd(aCOFINSST,{})\r\n\t\t\t\taadd(aISSQN,{})\r\n\t\t\t\taadd(aPisAlqZ,{})\r\n\t\t\t\taadd(aCofAlqZ,{})\r\n\t\t\t\taadd(aCsosn,{})\r\n\t\t\t\taadd(aFCI,{})\r\n\t\t\t\taadd(aICMUFDest,{})\r\n\t\t\t\taadd(aIPIDevol,{})\r\n\r\n\t\t\t\tDbSelectArea(\"SC7\")\r\n\t\t\t\tDbSetOrder(1)\r\n\t\t\t\tIf MsSeek(xFilial(\"SC7\")+(cAliasSD1)->D1_PEDIDO+(cAliasSD1)->D1_ITEM)\r\n\t\t\t\t\taadd(aPedCom,{SC7->C7_NUM,SC7->C7_ITEM})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aPedCom,{})\r\n\t\t\t\tEndif\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento para TAG Exportação quando existe a integração com a EEC     ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\tIf lEECFAT\r\n\t\t\t\t\t/*Alterações TQXWO2\r\n\t\t\t\t\tNa chamada da função, foram criados dois novos parâmetros: \r\n\t\t\t\t\to 3º referente ao código do produto e o 4º referente ao número da nota fiscal + série (chave).\r\n\t\t\t\t\tGetNfeExp(pProcesso, pPedido, cProduto, cChave)\r\n\t\t\t\t\tNo retorno da função serão devolvidas as informações do legado, conforme leiaute anterior à versão 3.10 , \r\n\t\t\t\t\te as informações dos grupos “I03 - Produtos e Serviços / Grupo de Exportação” e “ZA - Informações de Comércio Exterior”, conforme estrutura da NT20013.005_v1.21.\r\n\t\t\t\t\tAs posições 1 e 2 mantém o retorno das informações ZA02 e ZA03, mantendo o legado para os cliente que utilizam versão 2.00\r\n\t\t\t\t\tNa posição 3 passa a ser enviado o agrupamento do ID I50, tendo como filhos os IDs I51 e I52.\r\n\t\t\t\t\tNa posição 4 passa a ser enviado o agrupamento do ZA01, tendo como filhos os IDs ZA02, ZA03 e ZA04.\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tO array de retorno será multimensional, trazendo na primeira posição o identificador (ID), \r\n\t\t\t\t\tnasegunda posição a tag (o campo) e na terceira posição o conteúdo retornado do processo, \r\n\t\t\t\t\t\tpodendo ser um outro array com a mesma estrutura caso o ID possua abaixo de sua estrutura outros IDs.\t\t\t\t\t\t \t\t\t\t\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf !Empty((cAliasSD2)->D2_PREEMB) .and. ((cAliasSD2)->D2_DOC == (cAliasSD1)->D1_NFORI)\r\n\t\t\t\t\t\taExp:= {}\t\r\n\t\t\t\t\t\taadd(aExp,(GETNFEEXP((cAliasSD2)->D2_PREEMB,,cCodProd,(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE,(cAliasSD2)->D2_PEDIDO,(cAliasSD2)->D2_ITEMPV)))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElseiF AliasIndic(\"CDL\")\r\n\t\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\t\t\tDbSelectArea(\"CDL\")\r\n\t\t\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\tDbSeek(xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA)\r\n\t\t\t\t\t\tWhile !CDL->(Eof()) .And. CDL->CDL_FILIAL+CDL->CDL_DOC+CDL->CDL_SERIE+CDL->CDL_CLIENT+CDL->CDL_LOJA == xFilial(\"CDL\")+(cAliasSD2)->D2_DOC+(cAliasSD2)->D2_SERIE+(cAliasSD2)->D2_CLIENTE+(cAliasSD2)->D2_LOJA\r\n\t\t\t\t\t\t\tIf CDL->(FieldPos(\"CDL_PRODNF\")) <> 0 .And. CDL->(FieldPos(\"CDL_ITEMNF\")) <> 0 .And. AllTrim(CDL->CDL_PRODNF)+AllTrim(CDL->CDL_ITEMNF) == AllTrim((cAliasSD2)->D2_COD)+AllTrim((cAliasSD2)->D2_ITEM)\r\n\t\t\t\t\t\t\t\taDados := {}\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"I53\",\"nRE\", IIf(CDL->(ColumnPos(\"CDL_NRREG\"))>0,CDL->CDL_NRREG,\"\") })\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"I54\",\"chNFe\",SF2->F2_CHVNFE,\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"I55\",\"qExport\",(cAliasSD1)->D1_QUANT})\t\t\t\t\t\t\t    \r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t\t\taAdd(aDados,{\"\",\"\",\"\"})\r\n\t\t\t\t\t\t    \t\r\n\t\t\t\t\t\t\t\taAdd(aExp[Len(aExp)],aDados)\r\n\t\t\t\t\t\t\tEndIf\r\n\t\r\n\t\t\t\t\t\t    \tCDL->(DbSkip())\r\n\t\t\t\t\t\t\tEndDo\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aExp,{})\r\n\t\t\t\tEndIf\t\t\r\n\t\t\t\t\r\n\t\t\t\t// ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\t//³       Informacoes do cupom fiscal referenciado              |\r\n\t\t\t\t//|                                                             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ|\r\n\t\t\t\tDbSelectArea(\"SF2\")\r\n\t\t\t\tDbSetOrder(1)\r\n\t\t\t\tIf MsSeek(xFilial(\"SF2\")+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI)\r\n\t\t\t\t\tIf AllTrim(SF2->F2_ESPECIE)==\"CF\"\r\n\t\t\t\t\t\taadd(aRefECF,{SF2->F2_DOC,SF2->F2_ESPECIE,\"\"})\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf lEasy  .And. !Empty((cAliasSD1)->D1_TIPO_NF)\r\n\r\n\t\t\t\t\tcTipoNF \t:= (cAliasSD1)->D1_TIPO\r\n\t\t\t\t\tcDocEnt \t:= (cAliasSD1)->D1_DOC\r\n\t\t\t\t\tcSerEnt \t:= (cAliasSD1)->D1_SERIE\r\n\t\t\t\t\tcFornece\t:= (cAliasSD1)->D1_FORNECE\r\n\t\t\t\t\tcLojaEnt\t:= (cAliasSD1)->D1_LOJA\r\n\t\t\t\t\tcTipoNFEnt\t:= (cAliasSD1)->D1_TIPO_NF\r\n\t\t\t\t\tcPedido \t:= (cAliasSD1)->D1_PEDIDO\r\n\t\t\t\t\tcItemPC \t:= (cAliasSD1)->D1_ITEMPC\r\n\t\t\t\t\tcNFOri  \t:= (cAliasSD1)->D1_NFORI\r\n\t\t\t\t\tcSerOri \t:= (cAliasSD1)->D1_SERIORI\r\n\t\t\t\t\tcItemOri\t:= (cAliasSD1)->D1_ITEMORI\r\n\t\t\t\t\tcProd   \t:= (cAliasSD1)->D1_COD\r\n\t\t\t\t\tcLote\t\t:= (cAliasSD1)->D1_LOTECTL\r\n\t\t\t\t\tcItem\t\t:= (cAliasSD1)->D1_ITEM\r\n\r\n\t\t\t\t\tIf !cTipoNF$\"IPC\" .And. cTipoNFEnt <> \"6\"\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para TAG Importação quando existe a integração com a EIC  (Se a nota for primeira ou unica)|\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\taadd(aDI,(GetNFEIMP(.F.,cDocEnt,cSerEnt,cFornece,cLojaEnt,cTipoNFEnt,cPedido,cItemPC,cLote,cItem)))\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t//³Tratamento para TAG Importação quando existe a integração com a EIC  (Se a nota for complementar)     |\r\n\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\taadd(aDI,(GetNFEIMP(.F.,cNFOri,cSerOri,cFornece,cLojaEnt,cTipoNFEnt, ,cItemOri, ,cItem )))\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\taAdi := aDI\r\n\t\t\t\t// Se não o parâmetro de integração entre o SIGAEIC e o SIGAFAT estiver desabilitado,\r\n\t\t\t\t//   procura as informações da importação da tabela CD5 (complemento de importação).\r\n\t\t\t\tElseIf !lEasy .Or. (lEasy .AND. (cAliasSD1)->D1_TIPO $ \"DCPI\")\r\n\t\t\t\t\tDbSelectArea(\"CD5\")\r\n\t\t\t\t\tDbSetOrder(4)\r\n\t\t\t\t\t// Procura algum registro na CD5 referente a nota que foi complementada\r\n\t\t\t\t\tIf MsSeek(xFilial(\"CD5\")+(cAliasSD1)->D1_DOC+(cAliasSD1)->D1_SERIE+(cAliasSD1)->D1_FORNECE+(cAliasSD1)->D1_LOJA+(cAliasSD1)->D1_ITEM)\r\n\t\t\t\t\t\t\taAdd(aDI,{;\r\n\t\t\t\t\t\t\t\t{\"I04\",\"NCM\",SB1->B1_POSIPI},;\t\t\t\t//1\r\n\t\t\t\t\t\t\t\t{\"I15\",\"vFrete\",0},;\t\t\t\t\t\t\t//2\r\n\t\t\t\t\t\t\t\t{\"I16\",\"vSeg\",0},;\t\t\t\t\t\t\t//3\r\n\t\t\t\t\t\t\t\t{\"I19\",\"nDI\",Iif(!Empty(CD5->CD5_NDI),CD5->CD5_NDI,\"NIHIL\")},;\t\t//4\r\n\t\t\t\t\t\t\t\t{\"I20\",\"dDI\",CD5->CD5_DTDI},;\t\t\t\t//5\r\n\t\t\t\t\t\t\t\t{\"I21\",\"xLocDesemb\",CD5->CD5_LOCDES},;\t\t//6\r\n\t\t\t\t\t\t\t\t{\"I22\",\"UFDesemb\",CD5->CD5_UFDES},;\t\t//7\r\n\t\t\t\t\t\t\t\t{\"I23\",\"dDesemb\",CD5->CD5_DTDES},;\t\t\t//8\r\n\t\t\t\t\t\t\t\t{\"I24\",\"cExportador\",CD5->CD5_CODEXP},;\t//9\r\n\t\t\t\t\t\t\t\t{\"I26\",\"nAdicao\",Val(CD5->CD5_NADIC)},;\t//10\r\n\t\t\t\t\t\t\t\t{\"I27\",\"nSeqAdi\",Val(CD5->CD5_SQADIC)},;\t//11\r\n\t\t\t\t\t\t\t\t{\"I28\",\"cFabricante\",CD5->CD5_CODFAB},;\t//12\r\n\t\t\t\t\t\t\t\t{\"I29\",\"vDescDI\",0},;\t\t\t\t\t\t//13\r\n\t\t\t\t\t\t\t\t{\"N14\",\"pRedBC\",0},;\t\t\t\t\t\t\t//14\r\n\t\t\t\t\t\t\t\t{\"O11\",\"qUnid\",0},;\t\t\t\t\t\t\t//15\r\n\t\t\t\t\t\t\t\t{\"O12\",\"vUnid\",0},;\t\t\t\t\t\t\t//16\r\n\t\t\t\t\t\t\t\t{\"P02\",\"vBC\",CD5->CD5_BCIMP},;\t\t\t\t//17\r\n\t\t\t\t\t\t\t\t{\"P03\",\"vDespAdu\",CD5->CD5_DSPAD},;\t\t\t//18\r\n\t\t\t\t\t\t\t\t{\"P04\",\"vII\",(cAliasSD1)->D1_II},;\t\t\t//19\r\n\t\t\t\t\t\t\t\t{\"P05\",\"vIOF\",CD5->CD5_VLRIOF},;\t\t\t//20\r\n\t\t\t\t\t\t\t\t{\"Q10\",\"qBCProd\",0},;\t\t\t\t\t\t//21\r\n\t\t\t\t\t\t\t\t{\"Q11\",\"vAliqProd\",0},;\t\t\t\t\t\t//22\r\n\t\t\t\t\t\t\t\t{\"S09\",\"qBCProd\",0},;\t\t\t\t\t\t//23\r\n\t\t\t\t\t\t\t\t{\"S10\",\"vAliqProd\",0},;\t\t\t\t\t\t//24\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t{\"X04\",\"CNPJ\",0},;\t\t\t\t\t\t\t//25\r\n\t\t\t\t\t\t\t\t{\"X06\",\"xNome\",0},;\t\t\t\t\t\t\t//26\r\n\t\t\t\t\t\t\t\t{\"X07\",\"IE\",0},;\t\t\t\t\t\t\t\t//27\r\n\t\t\t\t\t\t\t\t{\"X08\",\"xEnder\",0},;\t\t\t\t\t\t\t//28\r\n\t\t\t\t\t\t\t\t{\"X09\",\"xMun\",0},;\t\t\t\t\t\t\t//29\r\n\t\t\t\t\t\t\t\t{\"X10\",\"UF\",0},;\t\t\t\t\t\t\t\t//30\r\n\t\t\t\t\t\t\t\t{\"XXX\",\"Emaildesp\",0},;\t\t\t\t\t\t//31\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t{\"HOU\",\"house\",0},;\t\t\t\t\t\t\t//32\r\n\t\t\t\t\t\t\t\t{\"DES\",\"cDesp\",0},;\t\t\t\t\t\t\t//33\r\n\t\t\t\t\t\t\t\t{\"129A\",\"nDraw\",IIf(CD5->(FieldPos(\"CD5_ACDRAW\")) > 0,CD5->CD5_ACDRAW,\"\")},;\t\t\t//34\r\n\t\t\t\t\t\t\t\t{\"105a\",\"NVE\",0},;\t\t\t\t\t\t\t//35\r\n\t\t\t\t\t\t\t\t{\"I23a\",\"tpViaTransp\",IIf(CD5->(FieldPos(\"CD5_VTRANS\")) > 0,CD5->CD5_VTRANS,\"\")},;\t//36\r\n\t\t\t\t\t\t\t\t{\"I23b\",\"vAFRMM\",IIf(CD5->(FieldPos(\"CD5_VAFRMM\")) > 0,CD5->CD5_VAFRMM,\"\")},;\t\t\t//37\r\n\t\t\t\t\t\t\t\t{\"I23c\",\"tpIntermedio\",IIf(CD5->(FieldPos(\"CD5_INTERM\")) > 0,CD5->CD5_INTERM,\"\")},;\t//38\r\n\t\t\t\t\t\t\t\t{\"I23d\",\"CNPJ\",IIf(CD5->(FieldPos(\"CD5_CNPJAE\")) > 0,CD5->CD5_CNPJAE,\"\")},;\t\t\t//39\r\n\t\t\t\t\t\t\t\t{\"I23e\",\"UFTerceiro\",IIf(CD5->(FieldPos(\"CD5_UFTERC\")) > 0,CD5->CD5_UFTERC,\"\")}})\t//40\r\n\t\t\t\t\t\t// O array aAdi deve ser identico ao aDI para futuro tratamento neste fonte\r\n\t\t\t\t\t\taAdi := aDI\r\n\t\t\t\t\t// Caso nenhum registro de complemento de importação para essa nota exista, coloca os arrays em branco\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taadd(aAdi,{})\r\n\t\t\t\t\t\taadd(aDi,{})\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aAdi,{})\r\n\t\t\t\t\taadd(aDi,{})\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf (cAliasSD1)->D1_BASEIRR > 0  .And. (cAliasSD1)->D1_VALIRR > 0 \r\n\t\t\t\t\tnBaseIrrf += (cAliasSD1)->D1_BASEIRR\r\n\t\t\t\t\tnValIrrf  += (cAliasSD1)->D1_VALIRR \r\n\t\t\t\tEndIf\t\r\n\r\n\t\t\t\tIf AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0  .And. CD6->(FieldPos(\"CD6_BCCIDE\")) > 0 .And. CD6->(FieldPos(\"CD6_VALIQ\")) > 0 .And. CD6->(FieldPos(\"CD6_VCIDE\")) > 0\r\n\t\t\t\t\taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t         CD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t         CD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t         CD6->CD6_UFCONS,;\r\n\t\t\t\t\t\t         CD6->CD6_BCCIDE,;\r\n\t\t\t\t\t\t         CD6->CD6_VALIQ,;\r\n\t\t\t\t\t\t         CD6->CD6_VCIDE,;\r\n\t\t\t\t\t\t         IIf(CD6->(FieldPos(\"CD6_MIXGN\")) > 0,CD6->CD6_MIXGN,\"\"),;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         \"\",;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_DESANP\")) > 0,CD6->CD6_DESANP,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_PGLP\")) > 0,CD6->CD6_PGLP,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_PGNN\")) > 0,CD6->CD6_PGNN,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_PGNI\")) > 0,CD6->CD6_PGNI,\"\"),;\r\n\t\t\t\t\t\t         IIf(CD6->(ColumnPos(\"CD6_VPART\")) > 0,CD6->CD6_VPART,\"\"),;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t\t 0,;\r\n\t\t\t\t\t\t\t     0})\r\n\t\t\t    Elseif AliasIndic(\"CD6\")  .And. CD6->(FieldPos(\"CD6_QTAMB\")) > 0 .And. CD6->(FieldPos(\"CD6_UFCONS\")) > 0 \r\n\t\t\t\t\taadd(aComb,{CD6->CD6_CODANP,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_SEFAZ,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_QTAMB,;\r\n\t\t\t\t\t\t\t\tCD6->CD6_UFCONS,; \r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",; \r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,; \r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aComb,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf AliasIndic(\"CD7\")\r\n\t\t\t\t\taadd(aMed,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,CD7->CD7_PRECO,IIf(CD7->(FieldPos(\"CD7_CODANV\")) > 0,CD7->CD7_CODANV,\"\"),IIf(CD7->(ColumnPos(\"CD7_MOTISE\")) > 0,CD7->CD7_MOTISE,\"\")})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aMed,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf AliasIndic(\"CD8\")\r\n\t\t\t\t\taadd(aArma,{CD8->CD8_TPARMA,CD8->CD8_NUMARM,CD8->CD8_DESCR})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aArma,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\tIf AliasIndic(\"CD9\")\r\n\t\t\t\t\taadd(aveicProd,{CD9->CD9_TPOPER,CD9->CD9_CHASSI,CD9->CD9_CODCOR,CD9->CD9_DSCCOR,CD9->CD9_POTENC,CD9->CD9_CM3POT,CD9->CD9_PESOLI,;\r\n\t\t\t\t\t                CD9->CD9_PESOBR,CD9->CD9_SERIAL,CD9->CD9_TPCOMB,CD9->CD9_NMOTOR,CD9->CD9_CMKG,CD9->CD9_DISTEI,CD9->CD9_RENAVA,;\r\n\t\t\t\t\t                CD9->CD9_ANOMOD,CD9->CD9_ANOFAB,CD9->CD9_TPPINT,CD9->CD9_TPVEIC,CD9->CD9_ESPVEI,CD9->CD9_CONVIN,CD9->CD9_CONVEI,;\r\n\t\t\t\t\t                CD9->CD9_CODMOD,;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CILIND\")>0,CD9_CILIND,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_TRACAO\")>0,CD9_TRACAO,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_LOTAC\")>0,CD9_LOTAC,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_CORDE\")>0,CD9_CORDE,\"\")),;\r\n\t\t\t\t\t                CD9->(Iif(FieldPos(\"CD9_RESTR\")>0,CD9_RESTR,\"\"))})\r\n\t\t\t\tElse\r\n\t\t\t\t    aadd(aveicProd,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento para Rastreamento de Lote - Cabecalho e Itens   \r\n\t\t\t\t// Primeiro busca no compl. de rastreabilidade (F0A) e  depois compl.de medicamento (CD7)                ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\r\n\t\t\t\tIf AliasIndic(\"F0A\")  .AND. F0A->(FieldPos(\"F0A_LOTE\")) > 0 .And. !Empty(F0A->F0A_LOTE)\t\r\n\t\t\t\t\taadd(aLote,{IIf(F0A->(FieldPos(\"F0A_LOTE\")) > 0,F0A->F0A_LOTE,\"\"),;\r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_QTDLOT\")) > 0,F0A->F0A_QTDLOT,\"\"),;\r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_FABRIC\")) > 0,F0A->F0A_FABRIC,\"\"),;\r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_VALID\")) > 0,F0A->F0A_VALID ,\"\"),;  \r\n\t\t\t\t\tIIf(F0A->(ColumnPos(\"F0A_CODAGR\")) > 0,F0A->F0A_CODAGR ,\"\")})  \r\n\t\t\t\tElseIf !Empty(aMed) .And. !Empty(aMed[1][1])\r\n\t\t\t\t\taadd(aLote,{CD7->CD7_LOTE,CD7->CD7_QTDLOT,CD7->CD7_FABRIC,CD7->CD7_VALID,\"\"})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aLote,{})\r\n\t   \t\t\tEndIf\t\r\n\t   \t\t\t\r\n\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t//³Tratamento para Anfavea - Cabecalho e Itens                             ³\r\n\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\t\t\t\t\r\n\t\t\t\tIf lAnfavea\r\n\t\t\t\t\t//Cabecalho\r\n\t\t\t\t\taadd(aAnfC,{CDR->CDR_VERSAO,CDR->CDR_CDTRAN,CDR->CDR_NMTRAN,CDR->CDR_CDRECP,CDR->CDR_NMRECP,;\r\n\t\t\t\t\t\tAModNot(CDR->CDR_ESPEC),CDR->CDR_CDENT,CDR->CDR_DTENT,CDR->CDR_NUMINV}) \r\n\t\t\t\t\t//Itens\r\n\t\t\t\t\taadd(aAnfI,{CDS->CDS_PRODUT,CDS->CDS_PEDCOM,CDS->CDS_SGLPED,CDS->CDS_SEPPEN,CDS->CDS_TPFORN,;\r\n\t\t\t\t\t\tCDS->CDS_UM,CDS->CDS_DTVALI,CDS->CDS_PEDREV,CDS->CDS_CDPAIS,CDS->CDS_PBRUTO,CDS->CDS_PLIQUI,;\r\n\t\t\t\t\t\tCDS->CDS_TPCHAM,CDS->CDS_NUMCHA,CDS->CDS_DTCHAM,CDS->CDS_QTDEMB,CDS->CDS_QTDIT,CDS->CDS_LOCENT,;\r\n\t\t\t\t\t\tCDS->CDS_PTUSO,CDS->CDS_TPTRAN,CDS->CDS_LOTE,CDS->CDS_CPI,CDS->CDS_NFEMB,CDS->CDS_SEREMB,;\r\n\t\t\t\t\t\tCDS->CDS_CDEMB,CDS->CDS_AUTFAT,CDS->CDS_CDITEM})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aAnfC,{})\r\n\t\t\t\t\taadd(aAnfI,{})\r\n\t   \t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\tIf !(cAliasSD1)->D1_TIPO $ \"DB\"\t\t\t\r\n\t\t\t\t\tdbSetOrder(2)\r\n\t\t\t\tElse\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tDbSelectArea(\"SFT\")\r\n\t\t\t\tDbSetOrder(1)\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf SFT->(DbSeek(xFilial(\"SFT\")+\"E\"+(cAliasSD1)->(D1_SERIE+D1_DOC+D1_FORNECE+D1_LOJA+D1_ITEM+D1_COD)))\r\n\t\t\t\t   aadd(aCSTIPI,{SFT->FT_CTIPI})\r\n\t\t\t\t   //TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t\t   //PEGA OS VALORES E PERCENTUAL DO INNCENTIVO NOS ITENS NA SFT.\r\n\t\t\t\t   If SFT->(FieldPos(\"FT_PRINCMG\")) > 0 .And. SFT->(FieldPos(\"FT_VLINCMG\")) > 0\r\n\t\t\t\t\t\tIf SFT->FT_VLINCMG > 0\r\n\t\t\t\t\t\t\tnValLeite += SFT->FT_VLINCMG\r\n\t\t\t\t\t\t\taprod[Len(aProd)][49]:=  SFT->FT_VLINCMG\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tIf nPercLeite == 0 .And. SFT->FT_PRINCMG > 0 \r\n\t\t\t\t\t\t\tnPercLeite := SFT->FT_PRINCMG\r\n\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\tEndIF\r\n\t\t\t\tElseIf substr((cAliasSD1)->D1_CF,1,1) ==\"3\"\r\n\t\t\t\t\taadd(aCSTIPI,{SF4->F4_CTIPI})\t\t\t\t\t\t\t\t\r\n\t\t\t\tEndIf \r\n\t\t\t\t\r\n\t\t\t\t\t\t\t\t \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t//Posiciona novente na SF1 do documento que esta sendo processado\t\t\t\t\r\n\t\t\t\tSF1->(MsSeek(xFilial(\"SF1\")+(cAliasSD1)->(D1_DOC+D1_SERIE+D1_FORNECE+D1_LOJA+D1_TIPO)))\r\n\t\t\t\tCD2->(MsSeek(xFilial(\"CD2\")+\"E\"+SF1->F1_SERIE+SF1->F1_DOC+SF1->F1_FORNECE+SF1->F1_LOJA+PadR((cAliasSD1)->D1_ITEM,4)+(cAliasSD1)->D1_COD))\r\n\t\t\t\tWhile !CD2->(Eof()) .And. xFilial(\"CD2\") == CD2->CD2_FILIAL .And.;\r\n\t\t\t\t\t\"E\" == CD2->CD2_TPMOV .And.;\r\n\t\t\t\t\tSF1->F1_SERIE == CD2->CD2_SERIE .And.;\r\n\t\t\t\t\tSF1->F1_DOC == CD2->CD2_DOC .And.;\r\n\t\t\t\t\tSF1->F1_FORNECE == IIF(!(cAliasSD1)->D1_TIPO $ \"DB\",CD2->CD2_CODFOR,CD2->CD2_CODCLI) .And.;\r\n\t\t\t\t\tSF1->F1_LOJA == IIF(!(cAliasSD1)->D1_TIPO $ \"DB\",CD2->CD2_LOJFOR,CD2->CD2_LOJCLI) .And.;\t\t\t\t\r\n\t\t\t\t\t(cAliasSD1)->D1_ITEM == SubStr(CD2->CD2_ITEM,1,Len((cAliasSD1)->D1_ITEM)) .And.;\r\n\t\t\t\t\t(cAliasSD1)->D1_COD == CD2->CD2_CODPRO\r\n\t\t\t\t\t\r\n\t\t\t\t\tnMargem :=  IiF(CD2->CD2_PREDBC>0,IiF(CD2->CD2_PREDBC == 100,CD2->CD2_PREDBC,IF(CD2->CD2_PREDBC > 100,0,100-CD2->CD2_PREDBC)),IiF(Len(aAdI[1])>0 .And. ConvType(aAdI[1][04][01]) == \"I19\",IiF((aAdi[1][14][03]) > 100,0,aAdi[1][14][03]),CD2->CD2_PREDBC))\r\n\t\t\t\t\t\r\n\t\t\t\t\tSF7->(DbSetOrder(1))\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tSA2->(DbSetOrder(1))\r\n\t\t\t\t\tSA1->(DbSetOrder(1))\r\n\r\n\t\t\t\t\tIF !(cAliasSD1)->D1_TIPO $ \"DB\"\r\n\t\t\t\t\t\tIf SA2->(DbSeek(xFilial(\"SA2\")+SF1->F1_FORNECE+SF1->F1_LOJA))\r\n\t\t\t\t\t\t\tIf SF7->(DbSeek(xFilial(\"SF7\")+SB1->B1_GRTRIB+SA2->A2_GRPTRIB))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf  SF7->F7_BASEICM > 0 .And. SF7->F7_BASEICM < 100\r\n\t\t\t\t\t\t\t\t\tnMargem :=  100 - SF7->F7_BASEICM\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n            \t        EndIf\r\n                    Else\r\n\t\t\t\t\t\tIf SA1->(DbSeek(xFilial(\"SA1\")+SF1->F1_FORNECE+SF1->F1_LOJA))\r\n\t\t\t\t\t\t\tIf SF7->(DbSeek(xFilial(\"SF7\")+SB1->B1_GRTRIB+SA1->A1_GRPTRIB))\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\tIf  SF7->F7_BASEICM > 0 .And. SF7->F7_BASEICM < 100\r\n\t\t\t\t\t\t\t\t\tnMargem :=  100 - SF7->F7_BASEICM\r\n\t\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\r\n            \t        EndIf                    \r\n                    EndIf \r\n                    // Verifica se existe percentual de reducao na SFT referente ao RICMS 43080/2002 MG.\r\n\t\t\t\t\tIf SFT->(FieldPos(\"FT_PR43080\")) <> 0 .And. SFT->FT_PR43080 <> 0 .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\"\r\n\t\t\t\t\t\tnMargem := SFT->FT_PR43080\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tIf SubStr((cAliasSD1)->D1_CLASFIS,2,2) $ '51'\t .and. !Empty(SFT->FT_ICMSDIF)           .and. SFT->(ColumnPos(\"FT_VOPDIF\")) > 0  .and. !Empty(SFT->FT_VOPDIF) .or.; // verifica diferimento com bloqueio de movimento\r\n\t\t\t\t\t\tSubStr((cAliasSD1)->D1_CLASFIS,2,2) $ '51' .and. !Empty((cAliasSD1)->(D1_ICMSDIF)) .and. SD1->(ColumnPos(\"D1_VOPDIF\")) > 0  .and. !Empty((cAliasSD1)->(D1_VOPDIF)) .and. SF1->(F1_STATUS) == 'C'\r\n\t\t\t\t\t\tlDifer :=.T.\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tlDifer := .F. //Reinicialização da variável\r\n\t\t\t\t\tEndIf\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tDo Case\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ICM\"\r\n\t\t\t\t\t\t\taTail(aICMS) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\t\t\t  CD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\t\t\t  CD2->CD2_MODBC,; \r\n\t\t\t\t\t\t\t                  nMargem,;// Tratamento para obter o percentual da redução de base do icms nota interna e importacao(integracao com EIC)\t\t\t\t\t\t\t                  \r\n\t\t\t\t\t\t\tCD2->CD2_BC,;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), If(lNfCupZero,0,Iif(CD2->CD2_BC>0,xFisRetFCP('4.0','CD2','CD2_ALIQ'),0)), Iif(CD2->CD2_BC>0,CD2->CD2_ALIQ,0)),;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), iif(!lDifer,xFisRetFCP('4.0','CD2','CD2_VLTRIB'),iif(SF1->(F1_STATUS) == 'C',(cAliasSD1)->(D1_VOPDIF),xFisRetFCP('4.0','SFT','FT_VOPDIF'))),Iif(!lDifer,CD2->CD2_VLTRIB,SFT->FT_VOPDIF)),;//Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), Iif(!lDifer,xFisRetFCP('4.0','CD2','CD2_VLTRIB'),xFisRetFCP('4.0','SFT','FT_VOPDIF')), Iif(!lDifer,CD2->CD2_VLTRIB,SFT->FT_VOPDIF)),; \r\n\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\"),;\r\n\t\t\t\t\t\t\tIIF(SF1->(F1_STATUS) == 'C', (cAliasSD1)->(D1_ICMSDIF),SFT->FT_ICMSDIF),;\r\n\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\tSF4->F4_ICMSDIF,;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,CD2->CD2_BFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,CD2->CD2_PFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,CD2->CD2_VFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BSTANT\")) > 0,SFT->FT_BSTANT,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_VSTANT'),0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PSTANT\")) > 0,xFisRetFCP('4.0','SFT','FT_PSTANT'),0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_BFCANTS\")) > 0,SFT->FT_BFCANTS,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_PFCANTS\")) > 0,SFT->FT_PFCANTS,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VFCANTS\")) > 0,SFT->FT_VFCANTS,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_VICPRST\")) > 0,SFT->FT_VICPRST,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,0)}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnCon++\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\tnValICMParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\tnBasICMParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\tEndIf\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"SOL\"\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taTail(aICMSST) := {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\tCD2->CD2_PREDBC,;\r\n\t\t\t\t\t\t\tCD2->CD2_BC,;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_ALIQ'),CD2->CD2_ALIQ),;\r\n\t\t\t\t\t\t\tIif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'),CD2_VLTRIB),;\r\n\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_BFCP\")) > 0,CD2->CD2_BFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PFCP\")) > 0,CD2->CD2_PFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_VFCP\")) > 0,CD2->CD2_VFCP,0),;\r\n\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_PICMDF\")) > 0,CD2->CD2_PICMDF,0),;\r\n\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\")}   \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf lConsig .And. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM)  .And. CD2->CD2_VLTRIB > 0\r\n\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\")}\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf lCD2PARTIC .And. CD2->CD2_PARTIC == \"2\"\r\n\t\t\t\t\t\t\t\tnValSTParc += CD2->CD2_VLTRIB \r\n\t\t\t\t\t\t\t\tnBasSTParc += CD2->CD2_BC\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tlCalSol := .T.\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Tratamento CAT04 de 26/02/2010                       ³\r\n\t\t\t\t\t\t\t//³Verifica de deve ser garavado no xml o valor e base  ³\r\n\t\t\t\t\t\t\t//³de calculo do ICMS ST para notas fiscais de devolucao³\r\n\t\t\t\t\t\t\t//³Verifica o parametro MV_ICSTDEV                      ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnValST \t:= Iif(cVerAmb == \"4.00\" .and. FindFunction(\"xFisRetFCP\"), xFisRetFCP('4.0','CD2','CD2_VLTRIB'), CD2->CD2_VLTRIB)\r\n\t\t\t\t\t\t\t//para a 4.0 devera exibir a informação Valor do ICMS ST não majorado.\r\n\t\t\t\t\t\t\tIf cVerAmb == \"4.00\" .and. nValST > 0 .And. lConsig\r\n\t\t\t\t\t\t\t\tnSTConsig += nValST\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf !lIcmSTDev\r\n\t\t\t\t\t\t\t\tIf ( (cAliasSD1)->D1_TIPO==\"D\" .Or. ( (cAliasSD1)->D1_TIPO==\"I\" .And. lComplDev)) .And. !Empty(nValST) \r\n\t\t\t\t\t\t\t\t\tnValSTAux := nValSTAux + nValST\r\n\t\t\t\t\t\t\t\t\tnBsCalcST := nBsCalcST + CD2->CD2_BC\r\n\t\t\t\t\t\t\t\t\tnValST \t  := 0\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\taTail(aICMSST):= {CD2->CD2_ORIGEM,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_CST,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MODBC,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_MVA,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_QTRIB,;\r\n\t\t\t\t\t\t\t\t\tCD2->CD2_PAUTA,;\r\n\t\t\t\t\t\t\t\t\tIif(lCD2PARTIC,CD2->CD2_PARTIC,\"\"),;\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(ColumnPos(\"CD2_DESONE\")) > 0,CD2->CD2_DESONE,0),;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\t0,;\r\n\t\t\t\t\t\t\t\t\tIIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,IIF(SF1->(F1_STATUS) == 'C',SF4->F4_MOTICMS ,SFT->FT_MOTICMS),\"\")}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t   \r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"IPI\"\r\n\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_QTRIB,CD2->CD2_PAUTA,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_MODBC,CD2->CD2_PREDBC}\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tnValIPI := CD2->CD2_VLTRIB\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf (((cAliasSD1)->D1_TIPO == \"D\" .and. !lEipiDev))  .Or. ((cAliasSD1)->D1_TIPO == \"B\" .And. lIpiBenef .and. !Empty(nValIPI)) .Or. lEIPIOutro .Or. lIPIOutB\r\n\t\t\t\t   \t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"B\" .And. lIpiBenef .and. !Empty(nValIPI)) .or. lIPIOutB\r\n\t\t\t\t   \t\t\t\t\tnValIpiBene += nValIPI  // Quando lIpiBenef = T leva IPI em vOutro e Inf. Adic.\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t \r\n\t\t\t\t\t\t\t\taTail(aIPI) := {SB1->B1_SELOEN,SB1->B1_CLASSE,0,IIf(CD2->(FieldPos(\"CD2_GRPCST\")) > 0 .and. !Empty(CD2->CD2_GRPCST),CD2->CD2_GRPCST,\"999\"),CD2->CD2_CST,0,CD2->CD2_QTRIB,CD2->CD2_PAUTA,0,0,CD2->CD2_MODBC,CD2->CD2_PREDBC}\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t/*Chamado TTVZJG - Grupo impostoDevol - informar o percentual e valor do IPI devolvido, em notas de devolução (finNFe =4)\r\n\t\t\t\t\t\t\tIncluida a verificação do campo F4_PODER3=D para os casos de retorno de beneficiamento*/\r\n\t\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"D\" .Or. SF4->F4_PODER3 == \"D\") .And. ((CD2->(FieldPos(\"CD2_PDEVOL\")) > 0 .And. !Empty(CD2->CD2_PDEVOL) .Or. (SF4->F4_QTDZERO == \"1\")) .And. cTPNota == \"4\")\r\n\t\t\t\t\t\t\t\tIf (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM )\r\n\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}\r\n\t\t\t\t\t\t\t\tElseIf cVerAmb >= \"4.00\" .And. (((cAliasSD1)->D1_TIPO == \"D\" .and. (lEipiDev .Or. lEIPIOutro)) .or.((cAliasSD1)->D1_TIPO == \"B\" .and. (!lIpiBenef .Or. lIPIOutB)))\r\n\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,0}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\taTail(aIPIDevol):= {CD2->CD2_PDEVOL,CD2->CD2_VLTRIB}//Percentual do IPI devolvido e Valor do IPI devolvido\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf        \t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS2\"\r\n\t\t\t\t\t\t\tIf (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\t\taTail(aPIS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\taISS[04]          += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF2\"\r\n\t\t\t\t\t\t\tIf (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\t\taTail(aCOFINS) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\taISS[05] += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"PS3\" .And. (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\taTail(aPISST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CF3\" .And. (cAliasSD1)->D1_VALISS==0\r\n\t\t\t\t\t\t\taTail(aCOFINSST) := {CD2->CD2_CST,CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,CD2->CD2_QTRIB,CD2->CD2_PAUTA}\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ISS\"\r\n\t\t\t\t\t\t\tIf Empty(aISS)\r\n\t\t\t\t\t\t\t\taISS := {0,0,0,0,0}\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\taISS[01] += (cAliasSD1)->D1_TOTAL\r\n\t\t\t\t\t\t\taISS[02] += CD2->CD2_BC\r\n\t\t\t\t\t\t\taISS[03] += CD2->CD2_VLTRIB\t\r\n\t\t\t\t\t\t\tIf SF3->F3_TIPO ==\"S\"\r\n\t\t\t\t\t\t\t\tIf SF3->F3_RECISS ==\"1\"\r\n\t\t\t\t\t\t\t\t\tcSitTrib := \"R\"\r\n\t\t\t\t\t\t\t\tElseif SF3->F3_RECISS ==\"2\"\r\n\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\tElseif SF4->F4_LFISS ==\"I\"\r\n\t\t\t\t\t\t\t\t\tcSitTrib:= \"I\"\r\n\t\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\t\tcSitTrib:= \"N\"\r\n\t\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIF SF4->F4_ISSST == \"1\" .or. Empty(SF4->F4_ISSST)\r\n\t\t\t\t\t\t\t\tcIndIss := \"1\" //1-Exigível;\r\n\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"2\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"2\"\t//2-Não incidência\r\n\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"3\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"3\" //3-Isenção\r\n\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"4\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"5\"\t //5-Imunidade\r\n\t\t\t\t\t\t\tElseIf\tSF4->F4_ISSST == \"5\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"6\"\t //6-Exigibilidade Suspensa por Decisão Judicial\r\n\t\t\t\t\t\t\tElseIf SF4->F4_ISSST == \"6\"\r\n\t\t\t\t\t\t\t\tcIndIss := \"7\"\t //7-Exigibilidade Suspensa por Processo Administrativo\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tcIndIss := \"4\"//4-Exportação\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Pega as deduções ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSSUB\"))>0\r\n\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSSUB\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_ISSMAT\"))>0\r\n\t\t\t\t\t\t\t\tnDeducao+= SF3->F3_ISSMAT\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t\t\t\t\t//³Verifica se recolhe ISS Retido ³\r\n\t\t\t\t\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\t\t\t\t\tIf SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t\tIf SF3->F3_RECISS $\"1|S\"  \t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\tnValISSRet := SFT->FT_VALICM // Valor do ISSRET por item\r\n\t\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\tEndIf\t\t\t\t\t\t\t\r\n\r\n\t\t\t\t\t\t\t// If SF3->(FieldPos(\"F3_RECISS\"))>0\r\n\t\t\t\t\t\t\t// \tIf SF3->F3_RECISS $\"1|S\"       \r\n\t\t\t\t\t\t\t// \t\tIf SF3->(dbSeek(xFilial(\"SF3\")+SF1->F1_FORNECE+SF1->F1_LOJA+SF1->F1_DOC+SF1->F1_SERIE))\r\n\t\t\t\t\t\t\t// \t\t\tWhile !SF3->(EOF()) .And. xFilial(\"SF3\")+SF3->F3_CLIEFOR+SF3->F3_LOJA+SF3->F3_NFISCAL+SF3->F3_SERIE==SF1->F1_FILIAL+SF1->F1_FORNECE+SF1->F1_LOJA+SF1->F1_DOC+SF1->F1_SERIE\r\n\t\t\t\t\t\t\t// \t\t\t\tIf SF3->F3_TIPO==\"S\" //Serviço\r\n\t\t\t\t\t\t\t// \t\t\t\t\tnValISSRet+= SF3->F3_VALICM\r\n\t\t\t\t\t\t\t// \t\t\t\tEndIf\r\n\t\t\t\t\t\t\t// \t\t\t\tSF3->(dbSkip())\r\n\t\t\t\t\t\t\t// \t\t\tEndDo\r\n\t\t\t\t\t\t\t// \t\tEndIf\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t   \t// \tEndif\r\n\t\t\t\t\t\t\t// EndIf\r\n\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\taTail(aISSQN) := {CD2->CD2_BC,CD2->CD2_ALIQ,CD2->CD2_VLTRIB,\"\",AllTrim((cAliasSD1)->D1_CODISS),cSitTrib,nDeducao,cIndIss,nValISSRet}\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"CMP\" //ICMSUFDEST\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\taTail(aICMUFDest) := {IIf(CD2->CD2_BC > 0,CD2->CD2_BC, 0),; //[1]vBCUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PFCP\")) > 0 .and. CD2->CD2_PFCP > 0,CD2->CD2_PFCP,0),;  //[2]pFCPUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->CD2_ALIQ > 0,CD2->CD2_ALIQ,0),;//[3]pICMSUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_ADIF\")) > 0 .and. CD2->CD2_ADIF > 0,CD2->CD2_ADIF,0),;//[4]pICMSInter\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_PDDES\")) > 0 .and. CD2->CD2_PDDES > 0,CD2->CD2_PDDES,0),;//[5]pICMSInterPart\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VFCP\")) > 0 .and. CD2->CD2_VFCP > 0,CD2->CD2_VFCP,0),;//[6]vFCPUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VDDES\")) > 0 .and. CD2->CD2_VDDES > 0,CD2->CD2_VDDES,0),;//[7]vICMSUFDest\r\n\t\t\t\t\t\t\t\t\tIIf(CD2->(FieldPos(\"CD2_VLTRIB\")) > 0 .and. CD2->CD2_VLTRIB > 0,CD2->CD2_VLTRIB,0)}//[8]vICMSUFRemet\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tCase AllTrim(CD2->CD2_IMP) == \"ZFM\"\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tcICMSZFM := If(CD2->(ColumnPos(\"CD2_DESCZF\")) > 0,CD2->CD2_DESCZF,\"\")\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndCase\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf nValSTAux > 0 \r\n\t\t\t\t\t\tcValST  := AllTrim(Str(nValSTAux,15,2))\r\n\t\t\t\t\t\tcBsST   := AllTrim(Str(nBsCalcST,15,2))\r\n\t\t\t\t\t\tcMensCli += \" \"\r\n\t\t\t\t\t\tIf lComplDev .And.  nBsCalcST == 0\r\n\t\t\t\t\t\t\tcMensCli += \"(Valor do ICMS ST: R$ \"+cValST+\") \" \t\t\t\t\t\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS ST: R$ \"+cBsST+ \" - \"+\"Valor do ICMS ST: R$ \"+cValST+\") \"\r\n\t\t\t\t\t\tEndIF\t\r\n\t\t\t\t\t\tcValST\t  := \"\"  \r\n\t\t\t\t\t\tcBsST \t  := \"\"   \r\n\t\t\t\t\t\tnBsCalcST := 0\r\n\t\t\t\t\t\tnValSTAux := 0\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tdbSelectArea(\"CD2\")\r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\tEndDo\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf SFT->FT_DESCZFR>0  .OR. !Empty(cICMSZFM)\r\n\t\t\t\t\taadd(aICMSZFM,{If(SFT->(ColumnPos(\"FT_DESCZFR\")) > 0,SFT->FT_DESCZFR,\"\"),;\r\n\t\t\t\t\tIf(SFT->(ColumnPos(\"FT_MOTICMS\")) > 0,SFT->FT_MOTICMS,\"\"),;\r\n\t\t\t\t\tcICMSZFM})\r\n\t\t\t\tElse\r\n\t\t\t\t\taadd(aICMSZFM,{})\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"SFT\") //Livro Fiscal Por Item da NF\r\n\t\t\t\tdbSetOrder(1) //FT_FILIAL+FT_TIPOMOV+FT_SERIE+FT_NFISCAL+FT_CLIEFOR+FT_LOJA+FT_ITEM+FT_PRODUTO\r\n\t\t\t\tIf MsSeek(xFilial(\"SFT\")+\"E\"+SF1->F1_SERIE+SF1->F1_DOC+SF1->F1_FORNECE+SF1->F1_LOJA+PadR((cAliasSD1)->D1_ITEM,4)+(cAliasSD1)->D1_COD) .And. ;\r\n\t\t\t\t\tSFT->(FieldPos(\"FT_CSTPIS\")) > 0 .And. SFT->(FieldPos(\"FT_CSTCOF\")) > 0\r\n\t\t\t\t\t\r\n\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SFT->FT_CSTPIS)\r\n\t\t\t\t\t\taTail(aPisAlqZ):= {SF4->F4_CSTPIS}\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SFT->FT_CSTCOF)\r\n\t\t\t\t\t\taTail(aCofAlqZ):= {SF4->F4_CSTCOF}\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tElse\r\n\r\n\t\t\t\t\tIF Empty(aPis[Len(aPis)]) .And. !empty(SF4->F4_CSTPIS)\r\n\t\t\t\t\t\taTail(aPisAlqZ):= {SF4->F4_CSTPIS}\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tIF Empty(aCOFINS[Len(aCOFINS)]) .And. !empty(SF4->F4_CSTCOF) \r\n\t\t\t\t\t\taTail(aCofAlqZ):= {SF4->F4_CSTCOF}\t\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf !Len(aCofAlqZ)>0 .Or. !Len(aPisAlqZ)>0\r\n\t\t\t\t\taadd(aCofAlqZ,{})\r\n\t\t\t\t\taadd(aPisAlqZ,{})\r\n\t\t\t\tEndif\r\n\t\t\t\t\r\n\t\t\t\tIf SF4->(FieldPos(\"F4_CSOSN\"))>0\r\n\t\t\t\t\taTail(aCsosn):= SF4->F4_CSOSN\r\n\t\t\t\tElse\r\n\t\t\t\t\taTail(aCsosn):= \"\"\r\n\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\tIf !Len(aCsosn)>0 \r\n\t\t\t\t\taTail(aCsosn):= \"\"\r\n\t\t\t\tEndIf                \r\n                         \r\n\t           //Tratamento para que o valor de PIS ST e COFINS ST venha a compor o valor total da tag vOutros  (NT 2011/004). E devolução de compra com IPI não tributado apenas para saida\r\n\t\t\t\t//Tratamento para que ao transmitir uma nota de devolução leve o valor do IPI conforme configurado o parametro MV_EIPIDEV.\r\n\t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"D\" .and. !lIpiDev .and. cTipo == \"1\")  .Or. ((cAliasSD1)->D1_TIPO == \"D\" .and. !lEipiDev ) .Or. lConsig .Or. (Alltrim((cAliasSD1)->D1_CF) $ cMVCFOPREM ) .OR. ((cAliasSD1)->D1_TIPO == \"B\" .and. lIpiBenef) .OR. ((cAliasSD1)->D1_TIPO==\"P\" .And. lComplDev .And. !lIpiDev) .OR. lEIPIOutro .Or. lIPIOutB\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf ((cAliasSD1)->D1_TIPO == \"D\" .and.  lEIPIOutro ) .or. ((cAliasSD1)->D1_TIPO == \"B\" .and.  lIPIOutB)\r\n\t\t\t\t\t\tlIpiOutr:= .T.\t\t\t\t\r\n\t\t\t\t\tEndIf \r\n\r\n\t\t\t\t\tIf cVerAmb >= \"4.00\" .And. cTPNota == \"4\" .And. !lIpiOutr\r\n\t\t\t\t\t\taTotal[01] += 0\t\r\n\t\t\t\t\tElse \r\n\t\t\t\t\t\taTotal[01] += (cAliasSD1)->D1_VALIPI\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\taTotal[01] += (cAliasSD1)->D1_DESPESA + (cAliasSD1)->D1_VALPS3 + (cAliasSD1)->D1_VALCF3 + nIcmsST + nCrdPres\r\n\t\t\t\t\t\r\n\t\t\t\tIf (cAliasSD1)->D1_TIPO $ \"I\"\r\n\t\t\t\t\tIf (cAliasSD1)->D1_ICMSRET > 0\r\n\t\t\t\t\t\taTotal[02] += (cAliasSD1)->D1_ICMSRET\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\taTotal[02] += 0\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\t\t\t\t\r\n\t\t\t\t\taTotal[02] += ((cAliasSD1)->D1_TOTAL-(cAliasSD1)->D1_VALDESC+(cAliasSD1)->D1_VALFRE+(cAliasSD1)->D1_SEGURO+(cAliasSD1)->D1_DESPESA;\r\n\t\t\t\t\t+ IIF(SD1->(ColumnPos('D1_AFRMIMP'))>0,(cAliasSD1)->D1_AFRMIMP,0);\r\n\t\t\t\t\t+ IIF(((cAliasSD1)->D1_TIPO $\"IP\" .Or. ((cAliasSD1)->D1_TIPO == \"D\" .And. cTpOrig == \"P\")),0,(cAliasSD1)->D1_VALIPI)+(cAliasSD1)->D1_ICMSRET + (cAliasSD1)->D1_VALPS3 + (cAliasSD1)->D1_VALCF3;      \r\n\t\t\t\t\t+ IIF(SF4->F4_AGREG   $ \"IB\",(cAliasSD1)->D1_VALICM,0\t);\r\n\t\t\t\t\t+ IIF(SF4->F4_AGRPIS  $ \"1P\",(cAliasSD1)->D1_VALIMP6,0\t);\r\n\t\t\t\t\t+ IIF(SF4->F4_AGRCOF  $ \"1C\",(cAliasSD1)->D1_VALIMP5,0\t));\r\n\t\t\t\t\t-(IIF(SF4->F4_AGREG  $ \"D\",(cAliasSD1)->D1_DESCICM,0\t));\r\n\t\t\t\t\t-(IIF(SF4->F4_AGREG  $ \"N\",(cAliasSD1)->D1_TOTAL,0\t\t));\r\n\t\t\t\t\t-(IIF(SF4->F4_INCSOL $ \"N\",(cAliasSD1)->D1_ICMSRET,0\t));\r\n\t\t\t\t\t-(IIF(Alltrim(SF4->F4_AGRPIS)  $ \"D\",(cAliasSD1)->D1_VALIMP6,0\t));\r\n\t\t\t\t\t-(IIF(Alltrim(SF4->F4_AGRCOF)  $ \"D\",(cAliasSD1)->D1_VALIMP5,0\t))\r\n\t\t\t\tEndIf\r\n\t\t\t\tdbSelectArea(cAliasSD1)\r\n\t\t\t\tdbSkip()\r\n\t\t    EndDo\t\r\n\r\n\t\t\t\t   \t\r\n\t\t    //Retira o desconto referente ao RICMS 43080/2002\r\n\t\t    If nDesTotal > 0\r\n\t\t    \taTotal[2] -= nDesTotal\r\n\t\t    EndIf\r\n\t\t    \r\n\t\t\tIf nBaseIrrf > 0 .And. nValIrrf > 0\r\n\t\t\t\taadd(aRetido,{\"IRRF\",nBaseIrrf,nValIrrf})\r\n\t\t\tEndIf\r\n\t\t\t//TRATAMENTO DA AQUISIÇÃO DE LEITE DO PRODUTOR RURAL CONFORME ARTIGO 207-B, INCISO II RICMS/MG\r\n\t\t\t//INSERE MSG EM INFADFISCO E SOMA NO TOTAL DA NOTA.\r\n\t\t\tIf nValLeite > 0 .And. nPercLeite > 0\r\n\t\t\t\tcMensFis += Alltrim(Str(nPercLeite,10,2))+'% Incentivo à produção e à industrialização do leite = R$ '+ Alltrim(Str(nValLeite,10,2))\r\n\t\t\t\taTotal[02] += nValLeite\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t//Operação com diferimento parcial de 66,66% do RICMS/PR\r\n\t\t\tIf nValIcmDev > 0 .And. nValIcmDif > 0\r\n\t\t\t\tcMensFis +=\t\"Operacao com diferimento parcial de 66,66% do imposto no valor de R$ \" + Alltrim(Str(nValIcmDif,10,2)) + \" - \"\r\n\t\t\t\tcMensFis += \"ICMS devido de R$ \" + Alltrim(Str(nValIcmDev,10,2)) + \", \"\r\n\t\t\t\tcMensFis += \"nos termos do Art 459 do DECRETO N.º 7.871/2017 - RICMS/PR\" //ISSUE DSERTSS1-6543 - Decreto 7.871 que revoga o regulamento do ICMS aprovado pelo decreto n 6080 de 28 de setembro de 2012.\r\n\t\t\tEndif\r\n\t\t\t\r\n\t\t\tIf nValSTAux > 0 \r\n\t\t\t\tcValST  := AllTrim(Str(nValSTAux,15,2))\r\n\t\t\t\tcBsST   := AllTrim(Str(nBsCalcST,15,2))\r\n\t\t\t\tcMensCli += \" \"\r\n\t\t\t\tIf lComplDev .And.  nBsCalcST == 0\r\n\t\t\t\t\tcMensCli += \"(Valor do ICMS ST: R$ \"+cValST+\") \" \t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tcMensCli += \"(Base de Calculo do ICMS ST: R$ \"+cBsST+ \" - \"+\"Valor do ICMS ST: R$ \"+cValST+\") \"\r\n\t\t\t\tEndIF\t\r\n\t\t\t\tcValST\t  := \"\"  \r\n\t\t\t\tcBsST \t  := \"\"   \r\n\t\t\t\tnBsCalcST := 0\r\n\t\t\t\tnValSTAux := 0\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017) \r\n\t\t\tIf \tlIcmsPR .And. nToTvBC > 0 .And. nToTvICMS > 0 \t\t\t\t\t\t\t\t   \r\n\t\t\t\tcMensCli += \"(Base de Calculo do ICMS : R$ \"+nToTvBC+ \" - \"+\"Valor do ICMS : R$ \"+nToTvICMS+\") \"\r\n\t\t\tEndif\r\n\t\t    \r\n\t\t    If lQuery\r\n\t\t    \tdbSelectArea(cAliasSD1)\r\n\t\t    \tdbCloseArea()\r\n\t\t    \tdbSelectArea(\"SD1\")\r\n\t\t    EndIf\r\n\t\tEndIf\r\n\t\t//Tratamento para incluir a mensagem em informacoes adicionais do FECP -DF - MG - PR - RJ - RS.\r\n\t\tIf nValTFecp > 0\r\n\t\t\tIf cVerAmb >= \"4.00\"\r\n\t\t\t\tcMensFis += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\tElse\r\n\t\t\t\tcMensCli += NfeMFECOP(nValTFecp,aDest[9],\"1\",aICMS,aICMSST,cVerAmb)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\r\nEndIf\r\n\r\n//Tratamento para que o valor de ValII venha compor o total da nota quando o parametro MV_EIC0064 for = .T. \r\nIf len(aDI)> 0\r\n\tFor nX := 1 To Len(aDI)\r\n\t\tIF  Len(aDI[nX])> 0\r\n\t\t\tIF Len(aDI[nX][19]) > 0 .and. lEIC0064 \r\n\t\t\t\taTotal[02]+= aDI[nX][19][03]   //ValIIaDI\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext\r\nEndIf\t\t\r\n\r\nIf FunName() <> \"SPEDNFSE\"\r\n\tIF cVeramb >= \"4.00\"\r\n\t   //Ajute para alimentar o aDetPag\r\n\t\tcTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,aProd[1,7])\r\n\t\t\r\n\t\t//Indicador da Forma de Pagamento\r\n\t\tcIndPag := IIF((Len(aDupl)==1 .And. aDupl[01][02]<=DataValida(aNota[03]+1,.T.)) .Or. Len(aDupl)==0,\"0\",\"1\")\t\r\n\r\n\t\tIf cTipo == \"1\"\r\n\t\t  cChvPag := SF2->F2_COND\r\n\t\tElse\r\n\t\t  cChvPag := SF1->F1_COND\r\n\t\tEndIf\r\n\r\n\t\tIf\tcTPNota $ '3-4'\r\n\t\t\t\r\n\t\t\tcForma := \"90\"  //90=Sem Pagamento.\r\n\t\t\taadd(aDetPag, {cForma, aTotal[2]+aTotal[03], 0.00, \"\", \"\", \"\", \"\", cIndPag})   \r\n\t\tElseIf (lVLojaDir .OR. !Empty(POSICIONE(\"SL1\",2,xFilial(\"SL1\")+SF2->F2_SERIE+SF2->F2_DOC,\"L1_NUM\"))) .And. cTipo == \"1\" .And. ( aRetPgLoj := GetPagLoja(aDupl, cChvPag, aTotal[2], cIndPag,cVerAmb) )[1]\r\n\t\t\t//Montagem do AdetPag quando venda for advindo do Venda Direta ou SigaLoja e condição de pagamento for = \"CN\"(Condicao Negociada)\r\n\t\t\t//Alem disso verifico se existem o registro na SL4, caso não, mantenho o legado anterior\r\n\t\t\taDetPag := aRetPgLoj[2]\t\r\n\t\tElse\t\t\r\n\t\t\t//caso tenha escolhido a forma de pagamento no cadastro de condição de pagamento.\r\n\t\t\tdbSelectArea(\"SE4\")\r\n\t\t\tdbSetOrder(1)\t\r\n\t\t\tIf DbSeek(xFilial(\"SE4\")+cChvPag)\r\n\t\t\t\tcForma := GetFormPgt(Alltrim(SE4->E4_FORMA), aDupl)\r\n\t\t\tElse\r\n\t\t\t\tcForma := GetFormPgt(\"\", aDupl)\t\r\n\t\t\tEndIf\r\n\t\t\taadd(aDetPag, {cForma, aTotal[2]+aTotal[03], 0.00, \"\", \"\", \"\", \"\", cIndPag})   \r\n\t\tEndIf\t\r\n\t\t\r\n\t\t//Exemplo de como gerar o Grupo Cobrança\r\n\t\t//aadd(aFat,{\"Número da Fatura\",Valor Original da Fatura,Valor do desconto,Valor Líquido da Fatura})   \r\n\t\t\r\n\tEndIf\r\nEndIf\r\n\r\n//Tratamento para que se caso mude o cliente o mesmo busque dados do cliente da nota original.\r\nIf lHistTab .and. !Empty(aNfVinc) .and. aNota[5] == \"D\"\r\n \taDest := AjustaDest(aDest,aNfVinc,cCliefor,cLoja)\r\nendif\r\n\r\nIF lPe01Nfe     \r\n\r\n\r\n\taParam := {aProd,cMensCli,cMensFis,aDest,aNota,aInfoItem,aDupl,aTransp,aEntrega,aRetirada,aVeiculo,aReboque,aNfVincRur,aEspVol,aNfVinc,aDetPag,aObsCont,aProcRef}\r\n\r\n\taParam := ExecBlock(\"PE01NFESEFAZ\",.F.,.F.,aParam)\r\n\t\r\n\tIf ( Len(aParam) >= 5 )\r\n\t\taProd\t\t:= aParam[1]\r\n\t\tcMensCli\t:= aParam[2]\r\n\t\tcMensFis\t:= aParam[3]\r\n\t\taDest \t\t:= aParam[4]\r\n\t\taNota \t\t:= aParam[5]\r\n\t\taInfoItem\t:= aParam[6]  \r\n\t\taDupl\t\t:= aParam[7]\r\n\t\taTransp\t\t:= aParam[8]\r\n\t\taEntrega\t:= aParam[9]\r\n\t\taRetirada\t:= aParam[10]\r\n\t\taVeiculo\t:= aParam[11]\r\n\t\taReboque\t:= aParam[12]\r\n\t\taNfVincRur\t:= aParam[13]\r\n\t\taEspVol     := aParam[14]\r\n\t\taNfVinc\t\t:= aParam[15]\r\n\t\tIf ( Len(aParam) >= 16 )\r\n\t\t\taDetPag\t\t:= aParam[16]\r\n\t\tEndIf\r\n\t\tIf ( Len(aParam) >= 17)\r\n\t\t\taObsCont    := aParam[17]\r\n\t\tEndIf\t\r\n\t\tIf ( Len(aParam) >= 18)\r\n\t\t\taProcRef    := aParam[18]\r\n\t\tEndIf\r\n\t\r\n\tEndIf\r\nEndif \r\n\r\n/* PONTO DE ENTRADA PARA TRATAMENTO SEGMENTO GRANITO BRUNO SIGAWISE */                      \r\nIf ExistBlock(\"PEGRNFESEFAZ\")                        \r\n\tIf AllTrim(aNota[1]) = \"2\"\r\n\t\taParam := {aNota,aProd,aIcms,aIcmsSt,aIpi,aICMUFDest,aPis,aCOFINS,aExp,aEspVol,aICMSZFM,aNfVinc}\r\n\t\taParam := ExecBlock(\"PEGRNFESEFAZ\",.F.,.F.,aParam)\r\n\t\t\r\n\t\taProd      := aParam[1]\r\n\t\taIcms      := aParam[2]\r\n\t\taIcmsSt    := aParam[3]\r\n\t\taIpi       := aParam[4]        \r\n\t\taICMUFDest := aParam[5]\r\n\t\taPis       := aParam[6]\r\n\t\taCOFINS    := aParam[7]\r\n\t\taExp       := aParam[8]\r\n\t\taEspVol    := aParam[9]\r\n\t\taICMSZFM   := aParam[10]\r\n\t\taNfVinc    := aParam[11]\r\n\tEndIf\r\nEndIf\r\n\r\n\r\nnLenaIpi := Len(aCstIpi) // Tratamento para CST IPI.\r\n\r\n//Geracao do arquivo XML\r\nIf !Empty(aNota)\r\n\r\n\tIf !lIcmDevol .And. aNota[5] = \"I\"\r\n\t\tlIcmDevol := .T.\r\n\tEnd If\r\n\t//Tratamento implementado para atender a ICMS/PR 2017 (Decreto 7.871/2017)\r\n\tIf nToTvBC > 0 .And. nToTvICMS > 0 \r\n\t\tlIcmSTDev\t:= lIcmSTDevOri\r\n\t\tlIcmDevol\t:= lIcmDevolOri\t\r\n\tEndIf\r\n\r\n\tcString := \"\"\r\n\tcString += '<?xml version=\"1.0\" encoding=\"UTF-8\"?>'\r\n\tcString += NfeIde(@cNFe,aNota,cNatOper,aDupl,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cIndPres,aDest,aProd,aExp,aComb)\r\n\tcString += NfeEmit(aIEST,cVerAmb,aDest)\r\n\tcString += NfeDest(aDest,cVerAmb,aTransp,aCST,lBrinde,@cMunDest)\r\n\tIf !Empty(cAutXml)\r\n\t\tcString += NfeAutXml(cAutXml)\r\n\tEndIf\r\n\tcString += NfeLocalRetirada(aRetirada)\r\n\tcString += NfeLocalEntrega(aEntrega)\r\n\taTotICMSST := {0,0,0}\r\n\tFor nX := 1 To Len(aProd)\r\n\t\tIf nLenaIpi > 0\r\n\t\t\tIf  nCstIpi <= nLenaIpi\r\n\t\t\t\tcIpiCst := aCSTIPI[nX][1]\r\n\t\t\t\tnCstIpi += 1\r\n\t\t\tElse\r\n\t\t\t\tcIpiCst := \"\"\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\r\n\t\tcString += \tNfeItem(aProd[nX],aICMS[nX],aICMSST[nX],aIPI[nX],aPIS[nX],aPISST[nX],aCOFINS[nX],aCOFINSST[nX],aISSQN[nX],aCST[nX],;\r\n\t\t\t\t\taMed[nX],aArma[nX],aveicProd[nX],aDI[nX],aAdi[nX],aExp[nX],aPisAlqZ[nX],aCofAlqZ[nX],aAnfI[nX],cTipo,cVerAmb, aComb[Nx],;\r\n\t\t\t\t\t@cMensFis,aCsosn[Nx],aPedCom[nX],aNota,aICMSZFM[nX],aDest,cIpiCst,aFCI[nX],lIcmDevol,@nVicmsDeson,@nVIcmDif,cMunPres,;\r\n\t\t\t\t\taAgrPis[nX],aAgrCofins[nX],nIcmsDif,aICMUFDest[nX],@nvFCPUFDest,@nvICMSUFDest,@nvICMSUFRemet,cAmbiente,aIPIDevol[nX],;\r\n\t\t\t\t\t@nvBCUFDest, aItemVinc[nX], @npFCPUFDest,@npICMSUFDest,@npICMSInter,@npICMSIntP,aLote[nX],@cMensDifal,;\r\n\t\t\t\t\t@aTotICMSST,len(aProd), nX, @nValDifer)\r\n\tNext nX\r\n  \tcString += NfeTotal(aTotal,aRetido,aICMS,aICMSST,lIcmDevol,cVerAmb,aISSQN,nVicmsDeson,aNota,nVIcmDif,aAgrPis,aAgrCofins,nValLeite )\r\n\tcString += NfeTransp(cModFrete,aTransp,aImp,aVeiculo,aReboque,aEspVol,cVerAmb,aReboqu2,cMunDest)\r\n\t\r\n\tIf cVeramb == \"3.10\"\r\n\t\tcString += NfeCob(aDupl)\r\n\tEndIf\r\n\t\r\n\t\r\n\tIF cVeramb >= \"4.00\"\r\n\t\t//Obrigatório o preenchimento do Grupo Informações de Pagamento para NF-e e NFC-e. Para as notas com finalidade de Ajuste ou Devolução o\r\n\t\t//campo Forma de Pagamento deve ser preenchido com 90=Sem Pagamento.\r\n\t\t//Retirado o grupo de duplicata para não ocorrer a Rejeição 867: Grupo duplicata informado e forma de pagamento não é Duplicata Mercantil.\r\n\t\t\r\n       //If aScan( aDetPag,{ |x|x[1] == \"14\"} ) > 0\t\t\t\r\n\t\tIf lGrupCob\r\n\t\t\tcString += NfeCob(aDupl,aFat,(Alltrim(cSerie)+ Alltrim(cNota)))\r\n\t\tEndIf\r\n\t\t//EndIf\r\n\t\tcString += NfePag(aDetPag)\r\n\tEndIf\r\n\t\r\n\tnA := 0\r\n\tFor nA:=1 to Len(aMensAux)\r\n\t\tcMensFis += \" \" + aMensAux[nA] + CRLF\r\n\tNext\r\n\t\r\n\tIf cMensONU <> \"\"\r\n\t\tcMensCli:= cMensCli+\" \"+ Alltrim(cMensONU)\r\n\tEndIf\r\n\t\r\n\tIf nValDifer > 0\r\n\t\tcMensCpl += \"Diferimento do ICMS que exceder 12% - Base Legal Item II da Subseção III da Seção IV do Apêndice II do RICMS/RS. Valor do ICMS Diferido R$ \" + ConvType(nValDifer,15,2) + \".\"\r\n\tEndIf\r\n\t\r\n\t// Tratamento para buscar \r\n\tIf  Empty(aPedido) .and. !Empty(aNfVinc)  .and. aNota[5] == \"D\" .and. Len(aNfVinc[1]) > 8\r\n\t\taPedido := DadNfVinc(aNfVinc)\r\n\tEndIf \r\n\t\r\n\tcString += NfeInfAd(cMensCli,cMensFis,aPedido,aExp,cAnfavea,aMotivoCont,aNota,aNfVinc,aProd,aDI,aNfVincRur,aRetido,cNfRefcup,cSerRefcup,cTipo,nIPIConsig,nSTConsig,lBrinde,cVerAmb,Iif(aNota[5] == \"D\",aRefECF,{}),nVicmsDeson,nvFCPUFDest,nvICMSUFDest,nvICMSUFRemet,nvBCUFDest,aICMUFDest,nValIpiBene,npFCPUFDest,npICMSUFDest,npICMSInter,npICMSIntP,aObsCont,aValTotOpe,cMensDifal,aProcRef,aDest,nTotCrdP,cMensCpl)\r\n\t\r\n\tIf LRespTec .and. lTagProduc .and. FindFunction(\"NfeRespTec\")\r\n\t\tcString += NfeRespTec(\"\")\r\n\tEndIf\r\n\t\r\n\tcString += \"</infNFe>\"\r\nEndIf\r\n\r\ncStringUTF := EncodeUTF8(cString)\r\nif cStringUTF == nil\r\n\tcString := SpecialChar( cString )\r\n\tcStringUTF := EncodeUTF8(cString)\r\nendif\r\n\r\nReturn({cNFe, cStringUTF ,cNotaOri,cSerieOri})\r\n\r\nStatic Function NfeIde(cChave,aNota,cNatOper,aDupl,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cIndPres,aDest,aProd,aExp,aComb)\r\n\r\nLocal cString    \t:= \"\"\r\nLocal cNFVinc    \t:= \"\"\r\nLocal cModNot    \t:= \"\"\r\nLocal cOper\t\t\t:= \"\"\r\nLocal cCFOP\t\t\t:= \"\"\r\nLocal cChaveRef\t\t:= \"\"\r\nLocal cIndicador\t:= \"\"\r\nLocal cTipocli\t\t:= \"\"\r\nLocal cVENPRES\t\t:= \"\"\r\nLocal cChvDupli\t\t:= \"\"\t\t\t\t\t\t\t\t\t\t\t// Não permitido gerar a mesma nota \r\nLocal lAvista    \t:= Len(aDupl)==1 .And. aDupl[01][02]<=DataValida(aNota[03]+1,.T.)\r\nLocal lDSaiEnt   \t:= GetNewPar(\"MV_DSAIENT\", .T.)\r\nLocal lNfVincRur \t:= .F.\r\nLocal lNfVinc    \t:= .F.\r\nLocal lEECFAT\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lRefEcf\t\t:= .F.\r\nLocal nX         \t:= 0\r\nLocal nPos       \t:= 0 \r\nLocal nY\t\t\t:= 0\r\nLocal cTpImp\t \t:=  AllTrim(GetNewPar(\"MV_NFTPIMP\",\"\"))\r\nLocal nZ\t\t\t:= 0\r\nLocal aNfLtExpRf \t:= {}\r\n\r\ncVerAmb := PARAMIXB[2]\r\n\r\ncChave := aUF[aScan(aUF,{|x| x[1] == SM0->M0_ESTCOB})][02]+FsDateConv(aNota[03],\"YYMM\")+SM0->M0_CGC+\"55\"+StrZero(Val(aNota[01]),3)+StrZero(Val(aNota[02]),9)\r\ncChave+=Inverte(StrZero(Val(aNota[02]),8))\r\n\r\ncString += '<infNFe versao=\"T01.00\">'\r\ncString += '<ide>'\r\ncString += '<cUF>'+ConvType(aUF[aScan(aUF,{|x| x[1] == SM0->M0_ESTCOB})][02],02)+'</cUF>'\r\ncString += '<cNF>'+ConvType(Inverte(StrZero(Val(aNota[02]),Len(aNota[02]))),08)+'</cNF>'\r\ncString += '<natOp>'+ConvType(cNatOper)+'</natOp>'\r\n\r\nIf cVeramb <> \"4.00\"  //Retirado o campo indicador da Forma de Pagamento do Grupo B\r\n\tcString += '<indPag>'+IIF(lAVista,\"0\",IIf(Len(aDupl)==0,\"2\",\"1\"))+'</indPag>'\r\nEndif\r\n\r\nIf Empty(aNota[01])\r\n\tcString += '<serie>'+\"000\"+'</serie>'\r\nElse\r\n\tcString += '<serie>'+ConvType(Val(aNota[01]),3)+'</serie>'\r\nEndif\r\ncString += '<nNF>'+ConvType(Val(aNota[02]),9)+'</nNF>'\r\n//Nota Técnica 2013/005 - Data e Hora no formato UTC\r\nIf cVeramb >= \"3.10\"\r\n\tcString += '<dhEmi>'+ConvType(aNota[03])+\"T\"+Iif(Len(AllTrim(aNota[06])) > 5,ConvType(aNota[06]),ConvType(aNota[06])+\":00\")+'</dhEmi>'\r\n\tcString += NfeTag('<dhSaiEnt>',Iif(lDSaiEnt,\"\",ConvType(aNota[03])+\"T\"+Iif(Len(AllTrim(aNota[06])) > 5,ConvType(aNota[06]),ConvType(aNota[06])+\":00\")))\r\nElse\t\r\n\tcString += '<dEmi>'+ConvType(aNota[03])+'</dEmi>'\r\n\tcString += NfeTag('<dSaiEnt>',Iif(lDSaiEnt, \"\", ConvType(aNota[03])))\r\n\tIf !lDSaiEnt .And. !Empty(aNota[06])\r\n\t\tif len(aNota[06]) > 5\r\n\t\t\tcString += '<hSaiEnt>'+ConvType(aNota[06])+'</hSaiEnt>'\r\n\t\telse\r\n\t\t\tcString += '<hSaiEnt>'+ConvType(aNota[06])+\":00\"+'</hSaiEnt>'\t\r\n\t\tendif\r\n\tEndif\r\nEndIf\r\ncString += '<tpNF>'+aNota[04]+'</tpNF>'\r\nIf cVeramb >= \"3.10\"\r\n\t\r\n\tcCFOP:= AllTrim(aProd[1][7]) //Considera somente o CFOP da primeira nota\r\n\t\r\n\tIf SubStr(cCFOP,1,1) == \"2\" .Or. SubStr(cCFOP,1,1) == \"6\" \r\n\t\t cOper:= \"2\" //Operação Interestadual\r\n\tElseIf SubStr(cCFOP,1,1) == \"3\" .Or. SubStr(cCFOP,1,1) == \"7\" \r\n\t\tcOper:= \"3\" //Operação com Exterior\r\n\tElse\r\n\t\tcOper:= \"1\" //Operação Interna CFOP 1 e 5\r\n\tEndIf\r\n\r\n\t//Operação Interna/Interestadual, pois apesar de CFOP 3 ou 7, porem UF de cliente diferente de EX/ Rejeição 731 e 520 (NT 2013/005 v 1.10)/(NT 2010/007)\r\n\t//Conforme entendimento com a equipe, ao analisar o campo de UF da variavel aComb, devo verificar apenas a primeira linha, sendo a mesma tratativa feita anteriormente no tocante ao codigo da CFOP\r\n\tIf cOper == \"3\" .And. Len(aComb) > 0 .And. aDest[9] != \"EX\" .And. aComb[1][4] == \"EX\"\t\t\r\n\t\tIf aDest[9] == IIF(!GetNewPar(\"MV_SPEDEND\",.F.),ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))\r\n\t\t\tcOper:= \"1\" \r\n\t\tElse\r\n\t\t\tcOper:= \"2\"\r\n\t\tEndIf\t\t\r\n\tEndIf\r\n\t\r\n\t//Identificador de Local de Destino da Operação\r\n\tcString += '<idDest>'+cOper+'</idDest>'\t\r\n\tcIdDest:= cOper\r\nEndIf\r\n\r\nIf !Empty(cTpImp)\r\n\tcString += '<TpImp>'+cTpImp+'</TpImp>'\t\r\nEndIf\r\n\r\nIf !(cVerAmb >= \"4.00\") .And. !Empty(aNfVinc)\r\n\t\r\n\tcModNot := AModNot(aNfVinc[1][06])\r\n\t\r\n\tIf cModNot == '02'\r\n\t\taNfVinc   := {}\r\n\tEndIf\r\nEndIf\r\n\r\nIf(!Empty(aNfVinc)\t.And. Empty(aExp[1])) .or.(!Empty(aNfVinc).And. !Empty(aExp[1]) .and. lEECFAT)\r\n\tcString += '<NFRef>'\r\n\tFor nX := 1 To Len(aNfVinc)\r\n\t\tlNfVincRur := aScan(aNfVincRur,{|aX| aX[4]==aNfVinc[nX][6] .And. aX[2]==aNfVinc[nX][2] .And. aX[3]==aNfVinc[nX][3] .And. aX[5]==aNfVinc[nX][4]}) == 0\r\n\t\t// Verifica se ja foi gerada a tag para a mesma nota anteriormente, para não ser gerada novamente\r\n\t\t//   ocasionando em rejeição pela SEFAZ\r\n\t\tnPos       := aScan(aNfVinc, {|aX| aX[2] == aNfVinc[nX][2] .And. aX[3] == aNfVinc[nX][3]})\r\n\t\tlNfVinc    := (nPos > 0 .And. nPos <> nX)\r\n\t\t\r\n\t\tIf cVerAmb >= \"2.00\" .And. lNfVincRur .And. !lNfVinc\r\n\t\t\tIf !Empty(aNfVinc[Nx][7]) // Contem chave de NF-e ou Ct-e\r\n\t\t\t\tIf !(aNfVinc[Nx][7] $ cChvDupli)\r\n\t\t\t\t\tif !Empty(aNfVinc[Nx][6]) .and. \"CTE\" == UPPER(Alltrim(aNfVinc[Nx][6]))\r\n\t\t\t\t\t\tcString += '<refCTe>'+aNfVinc[Nx][7]+'</refCTe>'\t\t\t\t\r\n\t\t\t\t\telse\t\t\t\t\r\n\t\t\t\t\t\tcString += '<refNFe>'+aNfVinc[Nx][7]+'</refNFe>'   \r\n\t\t\t\t\tendif\r\n\t\t\t\tcChvDupli += aNfVinc[Nx][7]+'-'\r\n\t\t\t\tEndIf\r\n\t\t\tElseIf !(ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVinc[nX][05]})][02],02)+;\r\n\t\t\t\tFsDateConv(aNfVinc[nX][01],\"YYMM\")+;\r\n\t\t\t\taNfVinc[nX][04]+;\r\n\t\t\t\tAModNot(aNfVinc[nX][06])+;\r\n\t\t\t\tConvType(Val(aNfVinc[nX][02]),3)+;\r\n\t\t\t\tConvType(Val(aNfVinc[nX][03]),9) $ cNFVinc )\r\n\t\t\t\tcString += '<RefNF>'\r\n\t\t\t\tcString += '<cUF>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVinc[nX][05]})][02],02)+'</cUF>'\r\n\t\t\t\tcString += '<AAMM>'+FsDateConv(aNfVinc[nX][01],\"YYMM\")+'</AAMM>'\r\n\t\t\t\tIf Len(AllTrim(aNfVinc[nX][04]))==14\r\n\t\t\t\t\tcString += '<CNPJ>'+aNfVinc[nX][04]+'</CNPJ>'\r\n\t\t\t\tElseIf Len(AllTrim(aNfVinc[nX][04]))>0\r\n\t\t\t\t\tcString += '<CNPJ>'+Replicate(\"0\",14)+'</CNPJ>'\r\n\t\t\t\t\tcString += '<CPF>'+aNfVinc[nX][04]+'</CPF>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<CNPJ></CNPJ>'\r\n\t\t\t\tEndIf\r\n\t\t\t\tcString += '<mod>'+IIf(Alltrim(aNfVinc[nX][06]) == \"NFA\",\"01\",AModNot(aNfVinc[nX][06]))+'</mod>'\r\n\t\t\t\tcString += '<serie>'+ConvType(Val(aNfVinc[nX][02]),3)+'</serie>'\r\n\t\t\t\tcString += '<nNF>'+ConvType(Val(aNfVinc[nX][03]),9)+'</nNF>'\r\n\t\t\t\tcString += '<cNF>' + strZero( val( convType( inverte( strZero( val( aNfVinc[nX][03] ), len( aNfVinc[nX][03] ) ) ), 8 ) ), 9 ) + '</cNF>'\r\n\t\t\t\tcString += '</RefNF>'\r\n\t\t\r\n\t\t\t\tcNFVinc += ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVinc[nX][05]})][02],02)+;\r\n\t\t\t\t\tFsDateConv(aNfVinc[nX][01],\"YYMM\")+;\r\n\t\t\t\t\taNfVinc[nX][04]+;\r\n\t\t\t\t\tAModNot(aNfVinc[nX][06])+;\r\n\t\t\t\t\tConvType(Val(aNfVinc[nX][02]),3)+;\r\n\t\t\t\t\tConvType(Val(aNfVinc[nX][03]),9)\r\n\t\t\tEndIf\t\t\t\t\t\t\r\n\t\tEndIf                \t\t\r\n\tNext nX                  \r\n\tcString += '</NFRef>'\r\nEndIf\r\n\r\nif SM0->M0_ESTCOB  ==  'RS' .and. anota[5] == 'C' .and. len(aNfVincRur) > 0   // verifica se estado é RS e se nota é complemento\r\n\taNfVincRur := FiltEst(@aNfVincRur, SM0->M0_ESTCOB ) // remove notas referenciadas que não são do RS\r\nendif\r\n\r\nIf !Empty(aNfVincRur)\t\r\n\tIf len(aNfVincRur)>0 .and. cVerAmb >= \"2.00\"       \r\n\t\tcString += '<NFRef>'\r\n\t\tFor nX := 1 To Len(aNfVincRur)\r\n\t\t\tcString +='<refNFP>' \r\n\t\t\tcString += '<cUF>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aNfVincRur[nX][06]})][02],02)+'</cUF>'\r\n\t\t\tcString += '<AAMM>'+FsDateConv(aNfVincRur[nX][01],\"YYMM\")+'</AAMM>'\r\n\t\t\tIf Len(AllTrim(aNfVincRur[nX][05]))==14\r\n\t\t\t\tcString += '<CNPJ>'+AllTrim(aNfVincRur[nX][05])+'</CNPJ>'\r\n\t\t\tElseIf Len(AllTrim(aNfVincRur[nX][05]))<>0\r\n\t\t\t\tcString += '<CPF>' +AllTrim(aNfVincRur[nX][05])+'</CPF>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<CNPJ></CNPJ>'         \r\n\t\t\tEndIf\t               \r\n\t\t\tcString += '<IE>'+ConvType(aNfVincRur[nX][07])+'</IE>'\r\n\t\t\tcString += '<mod>'+IIf(Alltrim(aNfVincRur[nX][04]) == \"NFA\",\"01\",AModNot(aNfVincRur[nX][04]))+'</mod>'\t\r\n\t\t\tcString += '<serie>'+ConvType(Val(aNfVincRur[nX][02]),3)+'</serie>'\r\n\t\t\tcString += '<nNf>'+ConvType(Val(aNfVincRur[nX][03]),9)+'</nNf>'\r\n \t\t\tcString +='</refNFP>'\r\n\t\tExit \t\r\n  \t\tNext nX          \r\n  \t\tcString += '</NFRef>'\r\n\tEndif\r\nEndIF\r\n\r\nIf !Empty(aRefECF)\r\n\tIf len(aRefECF) > 0 .and. cVerAmb >= \"2.00\"        \r\n\t\tcString += '<NFRef>'\t\r\n\r\n\t\tFor nX := 1 To Len(aRefECF)\r\n\t\t\t// Verifica se ja foi gerada a tag para o mesmo ECF / CF, para não ser gerada novamente\r\n\t\t\t// ocasionando em rejeição pela SEFAZ\r\n\t\t\tnPos\t\t:= aScan(aRefECF, {|aX| aX[1] == aRefECF[nX][1] .And. aX[3] == aRefECF[nX][3]})\r\n\t\t\tlRefEcf\t:= (nPos > 0 .And. nPos <> nX)\r\n\t\t\t\r\n\t\t\tif !lRefEcf\r\n\t\t\t\tcString +='<refECF>'\r\n\r\n\t\t\t\tif Alltrim(aRefECF[nX][02]) == \"ECF\" .Or. Alltrim(aRefECF[nX][02])==\"CF\" \r\n\t\t  \t\t\tcString += '<Mod>'+\"2C\"+'</Mod>'\r\n\t  \t\t\telse\r\n\t  \t\t\t\tcString += '<Mod>'+\"2B\"+'</Mod>'\r\n\t  \t\t\tendif\r\n\t\t\t\tcString += '<nECF>'+ConvType(Val(aRefECF[nX][03]),3)+'</nECF>'\r\n\t\t\t\tcString += '<nCOO>'+ConvType(Val(aRefECF[nX][01]),6)+'</nCOO>'\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\tcString +='</refECF>'\r\n\t\t\tendif\r\n\t\t\t\r\n\t\t\t//if !Empty(aRefECF[nX][01]) .And.  !Empty(aRefECF[nX][02]) .And.  !Empty(aRefECF[nX][03])  \r\n\t\t\t//\tExit\r\n\t\t\t//endif\t\t\t\r\n\r\n  \t\tNext nX \r\n\t\tcString += '</NFRef>'\r\n\t\r\n\tEndif\t\r\nEndIf \r\n\r\n/*Quando há exportação indireta(I52), deve-se informar as chaves(I54) na tag refNFe.\r\nEEC não consegue preencher campo D2_NFORI pois pode existir mais de um documento de entrada para referenciar em um mesmo item,\r\npor este motivo, as chaves recebidas na tag chNFe do grupo exportInd serão geradas automaticamente na refNFe.\r\n*/\r\n\r\nIf !Empty(aExp[1]) .and. lEECFAT .and. cVerAmb >= \"3.10\"\r\n\tIf Len(aExp) > 0 .and. (aNota[04] == \"1\" .OR.  aNota[5] $ \"D|N\") //Somente se nota de saída ou devolução.\r\n\t\tFor nX := 1 To Len(aExp)\r\n\t\t\tIf Len(aExp[nX][3][3]) > 0\r\n\t\t\t\tFor nY := 1 To Len(aExp[nX][3][3][2])\r\n\t\t\t\t\t//Quando não há exportInd, a posição 3 é retornada vazia\r\n\t\t\t\t\tIf !Empty(aExp[nX][3][3][2][nY][3])\r\n\t\t\t\t\t\tIf !aExp[nX][3][3][2][nY][3][2][3] $ cChaveRef \r\n\t\t\t\t\t\t\tcChaveRef += '<refNFe>'+aExp[nX][3][3][2][nY][3][2][3]+'</refNFe>'\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tNext nY\r\n\t\t\tEndIf \r\n         /*Quando há notas fiscais de formação de lote de exportação associadas, deve-se informar as chaves(BA02) na tag refNFe.\r\n\t\t\t  Estas informações ficarão na posição 6 do array aExp retornado peloa função GETNFEEXP( ) do SIGAEEC - Exportação */\r\n\t\t\tIf Len(aExp[nX]) > 4 .And. Len(aExp[nX][5]) > 2 .And. Len(aExp[nX][5][3]) > 0\r\n\t\t\t\tFor nZ := 1 To Len(aExp[nX][5][3])\r\n\t\t\t\t\tIf !Empty(aExp[nX][5][3][nZ][1])\r\n\t\t\t\t\t   If aScan(aNfLtExpRf,aExp[nX][5][3][nZ][1]) == 0\r\n\t\t\t\t\t      cChaveRef += '<refNFe>'+aExp[nX][5][3][nZ][1]+'</refNFe>'\r\n\t\t\t\t\t\t\taAdd( aNfLtExpRf , aExp[nX][5][3][nZ][1] )\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tNext nY\r\n\t\t\tEndIf \r\n\t\tNext Nx\r\n\t\t\r\n\t\tIf !Empty(cChaveRef)\r\n\t\t\tcString += '<NFRef>'\r\n\t\t\tcString += cChaveRef\r\n\t\t\tcString += '</NFRef>'\r\n\t\tEndIf\r\n\r\n\t   aNfLtExpRf := {}\r\n\r\n\tEndIf\t\r\n/*SEM INTEGRAÇÃO COM EEC - Quando há exportação indireta, deve-se informar a chave(I54 - tag chNFe) na tag refNFe.\r\nCaso não seja vinculada a NF original no pedido de venda (C6_NFORI/D2_NFORI), será considerada a chave contida\r\nno campo CDL_CHVEXP na montagem da refNFe.\r\n*/\r\nElseIf !Empty(aExp[1]) .and. !lEECFAT .and. (aNota[04] == \"1\" .or. (aNota[04] == \"0\" .and. aNota[5] $ \"D|N\"))  //.and. Empty(aNfVinc)\r\n\tFor nX := 1 To Len(aExp)\r\n\t\tIf !Empty(aExp[nX])\r\n\t\t\tFor nZ := 1 To Len(aExp[nX])\r\n\t\t\t\tIf !Empty(aExp[nX][nZ][5][3])\r\n\t\t\t\t\tIf !aExp[nX][nZ][5][3] $ cChaveRef\r\n\t\t\t\t\t\tcChaveRef += '<refNFe>'+ConvType(aExp[nX][nZ][5][3],44)+'</refNFe>'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tnext\r\n\t\tEndif\t\r\n\tNext nX\r\n\tIf !Empty(cChaveRef)\r\n\t\tcString += '<NFRef>'\r\n\t\tcString += cChaveRef\r\n\t\tcString += '</NFRef>'\r\n\tEndIf\r\nEndIf\r\n\r\ncTPNota := NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,aProd[1,7])\r\n\t\r\n/*Verificação do conteudo da tag IndIeDest para atribuir valor 1 na tag indFinal - rej 696-NT2015/003_v1.71*/\r\nIf ConvType(aDest[17]) <> \"2\" .and. !Empty(aDest[14])\r\n\tIf \"ISENT\" $ Upper(Alltrim(aDest[14]))\r\n\t\tcIndicador := \"2\"\r\n\tElse\r\n\t\tcIndicador := \"1\"\t\t\r\n\tEndIf\r\nElse\r\n\tcIndicador := \"9\" //9-Não Contribuinte\r\nEndIf\r\n//Ajuste para considerar o tipo do cliente cadastrado na (C5_TIPOCLI) quando alterado no cabeçalho das NF de Saída\r\n//pois todos os cálculos fiscais são feitos com base nessa informação e não no campo A1_TIPO.\r\nIf !Empty(SF2->F2_TIPOCLI) .and. !Empty(aDest[20]) \r\n\tIf (!Empty(aDest[20]) .and. aDest[20]) <> SF2->F2_TIPOCLI\t\r\n  \t\tcTipocli:= SF2->F2_TIPOCLI\r\n  \tElse\r\n  \t   cTipocli:= aDest[20]\r\n  \tEndIf\r\nElse \r\n\tIf !Empty(aDest[20]) \t\r\n\t\tcTipocli:= aDest[20]\r\n\tEndIf\r\nEndIf\r\n\r\ncString += '<tpNFe>'+cTPNota+'</tpNFe>'\r\nIf cVeramb >= \"3.10\"\r\n\tIf cTipocli  == \"F\"\r\n\t\tcString += '<indFinal>1</indFinal>' //1-Operação com consumidor final\r\n\t\tcIndFinal:= \"1\"\r\n\tElse\r\n\t\tIf cIndicador == \"9\" .and. cIdDest <> \"3\" //(tag indIEDest=9)-Não Contribuinte e operação que não é com exterior (tag idDest <> 3)\r\n\t\t\tcString += '<indFinal>1</indFinal>'//1-Consumidor final\r\n\t\t\tcIndFinal:= \"1\"\r\n\t\tElse\r\n\t\t\tcString += '<indFinal>0</indFinal>'//0-Não\r\n\t\t\tcIndFinal:= \"0\"\r\n\t\tEndIf\r\n\tEndIf\r\n\tIf Empty(cIndPres)\r\n\t\tcVENPRES:= AllTrim(aProd[1][42]) //Considera somente o F4_VENPRES do primeiro item\r\n\t\tIf aNota[5] == \"N\"\r\n\t\t\tcIndPres := \"9\" //Operação não presencial \r\n\t\tElseIf aNota[5] == \"D\" .and. aNota[04] == \"0\" .and. (!Empty(cVENPRES) .and. cVENPRES == \"1\")\r\n\t\t\t/*Manutenção para considerar o conteúdo do campo F4_VENPRES=1 na montagem da tag \r\n\t\t\t\tindPres = 1 – Operação Presencial, em notas de devolução de venda para contribuinte de \r\n\t\t\t\toutro Estado, com CFOP iniciado por 1 e sem frete, a fim de não apresentar a \r\n\t\t\t\trejeição 521 - Operação Interna e UF do emitente difere da UF do destinatário/remetente \r\n\t\t\t\tcontribuinte do ICMS.*/\r\n\t\t\tcIndPres := \"1\"\r\n\r\n\t\tElse\r\n\t\t\tcIndPres := \"0\" //0-Não se Aplica\t\r\n\t\tEndIf\r\n\tEndIf\r\n\tcString += '<indPres>'+cIndPres+'</indPres>' // Presenção do comprador no momento da Operação\r\nEndIf\r\ncString += '</ide>'\r\n\r\nReturn( cString )\r\n\r\nStatic Function NfeEmit(aIEST, cVerAmb, aDest)\r\n\r\nLocal aTelDest \t\t:= {} \r\n\r\nLocal cFoneDest\t\t:= \"\"\r\nLocal cMVCODREG\t\t:= SuperGetMV(\"MV_CODREG\", ,\" \")  \r\n//Local cMVEstado\t\t:= SuperGetMV(\"MV_ESTADO\", ,\" \")\r\n//Local cSTIeUf\t\t:= SuperGetMV(\"MV_STNIEUF\",.F.,\"\")\r\nLocal cString \t\t:= \"\"\r\nLocal cUfDest\t\t:= \"\"\r\nLocal cEndEmit\t:= \"\"\r\n\r\nLocal lEndFis \t\t:= GetNewPar(\"MV_SPEDEND\",.F.)\r\nLocal lUsaGesEmp\t:= IIF(FindFunction(\"FWFilialName\") .And. FindFunction(\"FWSizeFilial\") .And. FWSizeFilial() > 2,.T.,.F.)\r\n\r\nDEFAULT aIEST\t := {}\r\n\r\ncVerAmb     := PARAMIXB[2] \r\ncUfDest\t\t:= ConvType(aDest[09])\r\n\r\ncString := '<emit>'\r\nIf Len(AllTrim(SM0->M0_CGC))==14\r\n\tcString += '<CNPJ>'+AllTrim(SM0->M0_CGC)+'</CNPJ>'\r\nElseIf Len(AllTrim(SM0->M0_CGC))<>0\r\n\tcString += '<CPF>'+AllTrim(SM0->M0_CGC)+'</CPF>'\r\nElse\r\n\tcString += '<CNPJ></CNPJ>'\r\nEndIf\r\ncString += '<Nome>'+ConvType(SM0->M0_NOMECOM)+'</Nome>'\r\n\r\n/*\r\nQuando utilizar Gestao de empresas o M0_NOME guarda o nome do Grupo e não da Filial.\r\nFWFilialName - Pega o nome da Filial Atual,só usar funcao se estiver habilitado \r\ngestao de empresa (FWSizeFilial() > 2)\r\n*/\r\n\r\nIf lUsaGesEmp\r\n\tcString += NfeTag('<Fant>',ConvType(FWFilialName()))\r\nElse\r\n\tcString += NfeTag('<Fant>',ConvType(SM0->M0_NOME))\r\nEndIf\t     \r\n\r\ncString += '<enderEmit>'\r\ncString += '<Lgr>'+IIF(!lEndFis,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[1]),ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1]))+'</Lgr>'\r\n\r\nIf !lEndFis\r\n\tIf FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[2]<>0\r\n\t\tcString += '<nro>'+FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[3]+'</nro>'  \r\n\tElse\r\n\t\tcString += '<nro>'+\"SN\"+'</nro>' \r\n\tEndIf\r\nElse\r\n\tIf FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2]<>0\r\n\t\tcString += '<nro>'+FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3]+'</nro>' \r\n\tElse\r\n\t\tcString += '<nro>'+\"SN\"+'</nro>'\r\n\tEndIf\r\nEndIf\t\r\n\t\r\ncEndEmit :=  IIF(!lEndFis,Iif(!Empty(SM0->M0_COMPCOB),SM0->M0_COMPCOB,ConvType(FisGetEnd(SM0->M0_ENDCOB,SM0->M0_ESTCOB)[4]) ) ,;\r\n\t\t\t\t\t\t  Iif(!Empty(SM0->M0_COMPENT),SM0->M0_COMPENT,ConvType(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[4]) ) )\r\ncString += NfeTag('<Cpl>',cEndEmit)\r\ncString += '<Bairro>'+IIF(!lEndFis,ConvType(SM0->M0_BAIRCOB),ConvType(SM0->M0_BAIRENT))+'</Bairro>'\r\ncString += '<cMun>'+ConvType(SM0->M0_CODMUN)+'</cMun>'\r\ncString += '<Mun>'+IIF(!lEndFis,ConvType(SM0->M0_CIDCOB),ConvType(SM0->M0_CIDENT))+'</Mun>'\r\ncString += '<UF>'+IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT))+'</UF>'\r\ncString += NfeTag('<CEP>',IIF(!lEndFis,ConvType(SM0->M0_CEPCOB),ConvType(SM0->M0_CEPENT)))\r\ncString += NfeTag('<cPais>',\"1058\")\r\ncString += NfeTag('<Pais>',\"BRASIL\")\r\naTelDest:= FisGetTel(SM0->M0_TEL)\r\ncFoneDest := IIF(aTelDest[1] > 0,ConvType(aTelDest[1],3),\"\") // Código do Pais\r\ncFoneDest += IIF(aTelDest[2] > 0,ConvType(aTelDest[2],3),\"\") // Código da Área\r\ncFoneDest += IIF(aTelDest[3] > 0,ConvType(aTelDest[3],9),\"\") // Código do Telefone\r\ncString += NfeTag('<fone>',cFoneDest)\r\ncString += '</enderEmit>'\r\ncString += '<IE>'+ConvType(VldIE(SM0->M0_INSC))+'</IE>'\r\nIf !Empty(aIEST) \r\n\t/*ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t  ³ Tratamento para acordo entre os estados preenchidos no parametro MV_STNIEUF, quando em      ³\r\n\t  ³ um movimento com ICMS-ST nao e' necessario ter insccricao estadual, assim esse tratamento   ³\r\n\t  ³ retorna a inscricao \" \" para gerar a guia de recolhimento para o estado destino             ³ \r\n\t  ³ Este tratamento foi feito a partir da necessidade das UF de MG p/ PR,onde existe esse \t    ³\r\n\t  ³ acordo PROTOCOLO ICMS CONSELHO NACIONAL DE POLÍTICA FAZENDÁRIA - CONFAZ Nº 191 DE 11.12.2009³ \r\n\t  ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ*/\r\n\r\n\t/*If !(cMVEstado+cUfDest) $ cSTIeUf\r\n\t\tcString += NfeTag('<IEST>',aIEST[01]) \r\n\tEndIf*/\r\n\t\r\n\t// Preenche a tag quando IE do Emitente diferente do IE do parametro MV_SUBTRIB\r\n\t/*Inserida a verificação do idDest = 2 por conta de rejeição\r\n\t347 Informada IE do substituto tributário em operação que não é interestadual\r\n\t\r\n\tRegra de Validação\r\n\tSe informada a IE do Substituto Tributário para uma operação com Exterior ou Operação Interna (tag:idDest=1 ou 3)\r\n\tExceção: A critério da UF, poderá ser aceita a informação da IE-ST em operação interna.\r\n\t*/\r\n\t/* Adicionado tratativa para destacar em XML I.E. especial, para cliente ST, em operações internas no estado do PR, conforme Art. 176 § 10 do RICMS 2017 */                                                                                                                                                                                                                                                       \r\n\tIf((AllTrim(ConvType(VldIE(SM0->M0_INSC))) <> Alltrim(aIEST[01])) .And. (Alltrim (aIEST[01]) <> Alltrim(aIEST[02])) .And.;\r\n\t\t\t (cIdDest == \"2\" .OR. (cIdDest == \"1\" .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\")))\r\n\t\tcString += NfeTag('<IEST>',aIEST[01]) \r\n\tEndIf\r\nEndIf\r\ncString += NfeTag('<IM>',SM0->M0_INSCM)\r\ncString += NfeTag('<CNAE>',ConvType(SM0->M0_CNAE))\r\ncString += '<CRT>'+cMVCODREG+'</CRT>' \r\ncString += '</emit>'\r\nReturn(cString)\r\n\r\nStatic Function NfeDest(aDest,cVerAmb,aTransp,aCST,lBrinde,cMunDest)\r\n\t\r\n\tLocal aTelDest\t\t:= {}\r\n\tLocal cString\t\t:= \"\"\r\n\tLocal cMailTrans \t:= \"\"\r\n\tLocal cFoneDest\t\t:= \"\"\r\n\tLocal cIndicador\t:= \"\"\r\n\r\n\tDefault cMunDest\t:= \"\"\r\n\t\r\n\tcVerAmb\t:= PARAMIXB[2] \r\n\tcMunDest\t:= iIf(!lBrinde,IIf(Len(aDest[07])>5,aDest[07],aUF[aScan(aUF,{|x| x[1] == aDest[09]})][02]+aDest[07]),SM0->M0_CODMUN)\r\n\t\r\n\tcString := '<dest>'\r\n\tIf cVerAmb >= '3.10'\r\n\t//Estrangeiro não manda a tag de CPFCNPJ\r\n\t\tIf !\"EX\"$aDest[09]\r\n\t\t\tIf Len(AllTrim(aDest[01]))==14\r\n\t\t\t\tcString += '<CNPJ>'+iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CNPJ>'\r\n\t\t\tElseIf Len(AllTrim(aDest[01]))<>0\r\n\t\t\t\tcString += '<CPF>' +iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CPF>'\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\tIf !Empty(aDest[21])\r\n\t\t\t\tcString += '<idEstrangeiro>'+aDest[21]+'</idEstrangeiro>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<idEstrangeiro></idEstrangeiro>'\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tElse\r\n\t\tIf Len(AllTrim(aDest[01]))==14\r\n\t\t\tcString += '<CNPJ>'+iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CNPJ>'\r\n\t\tElseIf Len(AllTrim(aDest[01]))<>0\r\n\t\t\tcString += '<CPF>' +iIf(!lBrinde,AllTrim(aDest[01]),SM0->M0_CGC)+'</CPF>'\r\n\t\tElse\r\n\t\t\tcString += '<CNPJ></CNPJ>'\r\n\t\tEndIf\r\n\tEndIf\r\n\tcString += '<Nome>'+ConvType(iIf(!lBrinde,aDest[02],\"Diversos - Brindes\"))+'</Nome>'\r\n\tcString += '<enderDest>'\r\n\tcString += '<Lgr>'+ConvType(iIf(!lBrinde,aDest[03],(FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[1])))+'</Lgr>'\r\n\tif lBrinde\r\n\t\t\r\n\t\tif FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[2]<>0\r\n\t\t\tcString += '<nro>'+FisGetEnd(SM0->M0_ENDENT,SM0->M0_ESTENT)[3]+'</nro>' \r\n\t\telse\r\n\t\t\tcString += '<nro>'+\"SN\"+'</nro>'\r\n\t\tendif\r\n\t\r\n\telse \r\n\t\t\r\n\t\tIf  ValType(aDest[04]) == \"N\" .and. AT(\".\",Alltrim(Str(aDest[04]))) > 0\r\n\t\t\tcString += '<nro>'+Alltrim(Str(aDest[04]))+'</nro>'\r\n\t\tElse\r\n\t\t\tcString += '<nro>'+ConvType(aDest[04])+'</nro>'\r\n\t\tEndIf\r\n\tendif\r\n\tcString += NfeTag('<Cpl>',ConvType(iIf(!lBrinde,aDest[05],SM0->M0_COMPENT)))\r\n\tcString += '<Bairro>'+ConvType(iIf(!lBrinde,aDest[06],SM0->M0_BAIRENT))+'</Bairro>'\r\n\tcString += '<cMun>'+ConvType(cMunDest)+'</cMun>'\r\n\tcString += '<Mun>'+ConvType(iIf(!lBrinde,aDest[08],SM0->M0_CIDENT))+'</Mun>'\r\n\tcString += '<UF>'+ConvType(iIf(!lBrinde,aDest[09],SM0->M0_ESTENT))+'</UF>'\r\n\tcString += NfeTag('<CEP>',iIf(!lBrinde,aDest[10],SM0->M0_CEPENT))\r\n\tcString += NfeTag('<cPais>',aDest[11])\r\n\tcString += NfeTag('<Pais>',ConvType(aDest[12]))\r\n\tif lBrinde\r\n\t\taTelDest\t:= FisGetTel(SM0->M0_TEL)\r\n\t    cFoneDest\t:= IIF(aTelDest[1] > 0,ConvType(aTelDest[1],3),\"\") // Código do Pais\r\n\t    cFoneDest\t+= IIF(aTelDest[2] > 0,ConvType(aTelDest[2],3),\"\") // Código da Área\r\n\t    cFoneDest\t+= IIF(aTelDest[3] > 0,ConvType(aTelDest[3],9),\"\") // Código do Telefone\r\n\t\tcString\t+= NfeTag('<fone>',cFoneDest)\t\t\t\r\n\telse\r\n\t\tcString += NfeTag('<fone>', ConvType( FisGetTel(aDest[13])[2], 3) + ConvType( FisGetTel(aDest[13])[3], 11)  )\r\n\tendif\r\n\tcString += '</enderDest>'\r\n\t\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tIf ConvType(aDest[17]) <> \"2\" .and. !Empty(aDest[14])\r\n\t\t\tIf \"ISENT\" $ Upper(Alltrim(aDest[14]))\r\n\t\t\t\tcIndicador := \"2\"\r\n\t\t\tElse\r\n\t\t\t\tcIndicador := \"1\"\r\n\t\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\t\tcIndicador := \"9\" //9-Não Contribuinte: a IE do destinatário pode ser informada ou não, já que algumas UF concedem inscrição estadual para não contribuintes.\r\n\t\t\t\t//No caso de operação com o Exterior informar indIEDest=9 e não informar a tag IE do destinatário;\r\n\t\t\t\tIf  !\"EX\" $ aDest[09] .And. ConvType(aDest[14]) <> \"ISENTO\"\r\n\t\t\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\t\tcString += '<indIEDest>'+cIndicador+'</indIEDest>'\r\n\t\tcIndIEDest:= cIndicador\r\n\t\t\r\n\t\t/*\tindIEDest - Indicador da IE do destinatário\r\n\t\t\t1=Contribuinte ICMS (informar a IE do destinatário);\r\n\t\t\t2=Contribuinte isento de Inscrição no cadastro de Contribuintes do ICMS;\r\n\t\t\t9=Não Contribuinte, que pode ou não possuir Inscrição Estadual no Cadastro de Contribuintes do ICMS;\t\r\n\t\t*/\r\n\tElse\r\n\t\t// Conforme legislação, não contribuinte em SP, deve levar a IE se preenchida.\r\n\t\tIf ConvType(aDest[18]) == \"1\" .And. ConvType(aDest[17]) == \"2\"\r\n\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\tElseIf ConvType(aDest[17]) == \"2\" .And. ConvType(aDest[14]) <> \"ISENTO\" .And. SuperGetMV(\"MV_ESTADO\") <> \"SP\"  \r\n\t\t\tcString += '<IE>'+\"\"+'</IE>' \r\n\t\t\r\n\t\t/*---------------------------------------------\r\n\t\t Tratamento realizado Produtor Rural - RS\r\n\t\t \r\n\t\t 1. Cliente     \t\t= Produtor Rural\r\n\t\t 2. Documento tipo\t= Devolucao\r\n\t\t 3. Origem Rotina\t\t= Loja\r\n\t\t 4. Parametro\testado\t= RS (Rio G. Sul)\r\n\t\t \r\n\t\t Obs.: Chamado Consultoria Tributaria: TQCMPM\r\n\t\t---------------------------------------------*/\t\r\n\t\tElseIf Alltrim(SA1->A1_TIPO) == \"L\" .And. Alltrim(SF1->F1_TIPO) == \"D\" .And. Alltrim(SF1->F1_ORIGLAN) == \"LO\" .And. SuperGetMV(\"MV_ESTADO\") == \"RS\" \r\n\t\t\tcString += '<IE>'+\"\"+'</IE>'\t\t\t\r\n\t\t\r\n\t\tElse\r\n\t\t\tcString += '<IE>'+ConvType(iIf(!lBrinde,aDest[14],SM0->M0_INSC))+'</IE>'\r\n\t\tEndif\r\n\tEndIf\r\n\t\r\n\t//Tratamento para atender Manual de Orientação do Contribuinte versão 5.00 onde é Obrigatório, nas operações que se beneficiam de incentivos fiscais existentes nas áreas sob controle da SUFRAMA.\r\n\tcString += NfeTag('<IESUF>',aDest[15])\t\r\n\t\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += NfeTag('<IM>',aDest[19])\r\n\tEndIf\r\n\t//Considera o e-mail do cadastro da transportadora\r\n\tIf Len(aTransp) > 0\r\n\t\tIf !Empty(aDest[16]) .and. !Empty(AllTrim(aTransp[07]))\r\n\t\t\tcMailTrans := \";\"+AllTrim(aTransp[07])\r\n\t\tElse \r\n\t\t\tcMailTrans := AllTrim(aTransp[07])\r\n\t\tEndIf \t\r\n\tElse\r\n\t\tcMailTrans := \"\"\r\n\tEndIf\r\n\tif !lBrinde\r\n\t\tcString += NfeTag('<EMAIL>',AllTrim(aDest[16])+cMailTrans)\r\n\tendif\r\n\t\r\n\tcString += '</dest>'\r\nReturn(cString)\r\n\r\nStatic Function NfeLocalEntrega(aEntrega)\r\n\r\nLocal cString:= \"\"\r\n\r\nIf !Empty(aEntrega) .And. (Len(AllTrim(aEntrega[01]))==14 .Or. Len(AllTrim(aEntrega[01]))==11) \r\n\tcString := '<entrega>'\r\n\tIf Len(AllTrim(aEntrega[01]))==14 .AND. !(\"EX\" $ aEntrega[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<CNPJ>'+AllTrim(aEntrega[01])+'</CNPJ>' \r\n\tElseif Len(AllTrim(aEntrega[01]))<>0 .AND. !(\"EX\" $ aEntrega[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<cpf>' +AllTrim(aEntrega[01])+'</cpf>'\t\r\n\tElse\r\n\t\tcString += '<CNPJ></CNPJ>'\r\n\tEndif\r\n\tIf lTagProduc\r\n\t\tcString += '<Nome>'+ConvType(aEntrega[09])+'</Nome>'\r\n\tEndif\r\n\tcString += '<Lgr>'+ConvType(aEntrega[02])+'</Lgr>'\r\n\tcString += '<nro>'+ConvType(aEntrega[03])+'</nro>'\r\n\tcString += NfeTag('<Cpl>',ConvType(aEntrega[04]))\r\n\tcString += '<Bairro>'+ConvType(aEntrega[05])+'</Bairro>'\r\n\tcString += '<cMun>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aEntrega[08]})][02]+aEntrega[06])+'</cMun>'\r\n\tcString += '<Mun>'+ConvType(aEntrega[07])+'</Mun>'\r\n\tcString += '<UF>'+ConvType(aEntrega[08])+'</UF>'\r\n\tIf lTagProduc\r\n\t\tcString += '<CEP>'+ConvType(aEntrega[11])+'</CEP>'\r\n\t\tcString += '<cPais>'+ConvType(aEntrega[12])+'</cPais>'\r\n\t\tcString += '<Pais>'+ConvType(aEntrega[13])+'</Pais>'\r\n\t\tcString += '<fone>'+ConvType(aEntrega[14])+'</fone>'\r\n\t\tcString += '<email>'+ConvType(aEntrega[15])+'</email>'\r\n\t\tcString += '<IE>'+ConvType(aEntrega[10])+'</IE>'\r\n\tEndif\r\n\t\r\n\tcString += '</entrega>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NfeLocalRetirada(aRetirada)\r\n\r\nLocal cString:= \"\"\r\n\r\nIf !Empty(aRetirada)\r\n\tcString := '<retirada>'\r\n\tIf Len(AllTrim(aRetirada[01]))==14 .AND. !(\"EX\" $ aRetirada[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<CNPJ>'+AllTrim(aRetirada[01])+'</CNPJ>' \r\n\tElseif Len(AllTrim(aRetirada[01]))<>0 .AND. !(\"EX\" $ aRetirada[08]) //Verifica se cliente estrangeiro\r\n\t\tcString += '<cpf>' +AllTrim(aRetirada[01])+'</cpf>'\t\r\n\tElse\r\n\t\tcString += '<CNPJ></CNPJ>'\r\n\tEndif\r\n\tIf lTagProduc\r\n\t\tcString += '<Nome>'+ConvType(aRetirada[09])+'</Nome>'\r\n\tEndif\r\n\tcString += '<Lgr>'+ConvType(aRetirada[02])+'</Lgr>'\r\n\tcString += '<nro>'+ConvType(aRetirada[03])+'</nro>'\r\n\tcString += NfeTag('<Cpl>',ConvType(aRetirada[04]))\r\n\tcString += '<Bairro>'+ConvType(aRetirada[05])+'</Bairro>'\r\n\tcString += '<cMun>'+ConvType(aUF[aScan(aUF,{|x| x[1] == aRetirada[08]})][02]+aRetirada[06])+'</cMun>'\r\n\tcString += '<Mun>'+ConvType(aRetirada[07])+'</Mun>'\r\n\tcString += '<UF>'+ConvType(aRetirada[08])+'</UF>'\r\n\tIf lTagProduc\r\n\t\tcString += '<CEP>'+ConvType(aRetirada[11])+'</CEP>'\r\n\t\tcString += '<cPais>'+ConvType(aRetirada[12])+'</cPais>'\r\n\t\tcString += '<Pais>'+ConvType(aRetirada[13])+'</Pais>'\r\n\t\tcString += '<fone>'+ConvType(aRetirada[14])+'</fone>'\r\n\t\tcString += '<email>'+ConvType(aRetirada[15])+'</email>'\r\n\t\tcString += '<IE>'+ConvType(aRetirada[10])+'</IE>'\r\n\tEndif\r\n\tcString += '</retirada>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NfeItem(aProd,aICMS,aICMSST,aIPI,aPIS,aPISST,aCOFINS,aCOFINSST,aISSQN,aCST,aMed,aArma,aveicProd,aDI,aAdi,aExp,aPisAlqZ,aCofAlqZ,aAnfI,cTipo,cVerAmb,aComb,cMensFis,cCsosn,aPedCom,aNota,aICMSZFM,aDest,cIpiCst,aFCI,lIcmDevol,nVicmsDeson,nVIcmDif,cMunPres,aAgrPis,aAgrCofins,nIcmsDif,aICMUFDest,nvFCPUFDest,nvICMSUFDest,nvICMSUFRemet,cAmbiente,aIPIDevol,nvBCUFDest, aItemVinc,npFCPUFDest,npICMSUFDest,npICMSInter,npICMSIntP,aLote,cMensDifal, aTotICMSST, nTotProd, nItProd, nValDifer)\r\n\r\nLocal cString \t\t:= \"\"\r\nLocal cMVCODREG\t\t:= AllTrim(SuperGetMV(\"MV_CODREG\", ,\" \"))\r\nLocal cVunCom\t\t:= \"\"\r\nLocal cVunTrib\t\t:= \"\"  \r\nLocal cMotDesICMS\t:= \"\"\r\nLocal cMensDeson\t:= \"\"\r\nLocal cDedIcm\t\t:= \"\"\r\nLocal cCrgTrib\t\t:= \"\"\r\nLocal cPercTrib\t\t:= \"\"\r\nLocal cMVINCEFIS\t:= AllTrim(GetNewPar(\"MV_INCEFIS\",\"2\"))\r\nLocal cMVNumProc\t:= AllTrim(GetNewPar(\"MV_NUMPROC\",\" \"))\r\nLocal cF2Tipo\t\t:= \"\"\r\nLocal cMsgDI\t\t:= \"\"\r\nLocal cMensFecp\t\t:= \"\"\r\nLocal cEan\t\t\t:= \"\"\r\nLocal cEantrib\t\t:= \"\"\r\nLocal lAnfProd\t\t:= SuperGetMV(\"MV_ANFPROD\",,.T.)\r\nLocal lArt186\t    := SuperGetMV(\"MV_ART186\",,.F.)\r\nLocal lIssQn     \t:= .F.\r\nLocal lMvPisCofD \t:= GetNewPar(\"MV_DPISCOF\",.F.)   // Parâmetro para informar os valores de Cofins e Pis nas Informações complementares do Danfe \r\n//Local lSimpNac   \t:= SuperGetMV(\"MV_CODREG\")== \"1\" .Or. SuperGetMV(\"MV_CODREG\")== \"2\" \r\nLocal lUnTribCom\t:= GetNewPar(\"MV_VTRICOM\",.F.) //Parâmetro para informar o valor unitário comercial e valor unitário tributável nas informações complementares do DANFE (quando vuncom e vuntrib forem diferentes)\r\nLocal lNContrICM\t:= .F.  //Define se o cliente não é contribuinte do ICMS no estado.\r\nLocal lPesFisica\t:= .F.\r\nLocal lDInoDanfe\t:= GetNewPar(\"MV_DIDANFE\",.F.) //Parâmetro para informar os dados da DI nas informações complementares do Xml/Danfe\r\nLocal lCalcMed \t\t:= GetNewPar(\"MV_STMEDIA\",.F.) //Define se irá calcular a média do ICMS ST e da BASE do ICMS ST. \r\nLocal lSuframa\t\t:= GetNewPar(\"MV_SUFRAMA\",.F.) // Parâmetro referente a Suframa\r\nLocal lProdItem\t\t:= .F.\t//Define se esta configurado para gerar a mensagem da Lei da Transparencia por Produto ou somente nas informacoes Complementares.\r\nLocal lEECFAT\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lEndFis \t\t:= GetNewPar(\"MV_SPEDEND\",.F.)\r\nlocal lDateRefNf\t:= .T.\r\nLocal aPPDifal\t\t:= &(SuperGetMV(\"MV_PPDIFAL\", ,\"{{2016,40,60},{2017,60,40},{2018,80,20},{2019,100,0}}\"))\r\nLocal aPICMSInter\t:= {}\r\nLocal nX\t\t\t:= 0\r\nLocal nBaseIcm   \t:= 0\r\nLocal nValCof \t\t:= 0\r\nLocal nValICM\t \t:= 0\r\nLocal nValPis\t\t:= 0\r\nLocal nDesonICM\t\t:= 0\r\nLocal nValIcmDif\t:= 0\r\nLocal nA\t\t\t:= 0\r\nLocal nPos\t\t\t:= 0\r\nLocal nUltimo\t\t:= 0\r\nLocal nBfcpant\t\t:= 0\r\nLocal nAfcpant\t\t:= 0\r\nLocal nVfcpant\t\t:= 0\r\nLocal nAlqICM   \t:= 0  \r\nLocal nVICPRST  \t:= 0  \r\nLocal cUltAqui  \t:= AllTrim(SuperGetMv(\"MV_ULTAQUI\",,\"\"))\r\nLocal cArt274\t\t:= \"\"\r\nLocal anDraw\t\t:= {}\r\nLocal aExportInd\t:= {}\r\nLocal nValDeson\t\t:= 0\r\nLocal lRetEfet\t\t:= .T.     //ICMS RETIDO COM ICMS EFETIVO\r\nLocal nPIcmsDif\t\t:= 0\r\n\r\nDEFAULT aICMS    \t\t:= {}\r\nDEFAULT aICMSST  \t\t:= {}\r\nDEFAULT aICMSZFM \t\t:= {}\r\nDEFAULT aIPI     \t\t:= {}\r\nDEFAULT aPIS    \t\t:= {}\r\nDEFAULT aPISST   \t\t:= {}\r\nDEFAULT aCOFINS  \t\t:= {}\r\nDEFAULT aCOFINSST\t\t:= {}\r\nDEFAULT aISSQN   \t\t:= {}\r\nDEFAULT aMed     \t\t:= {}\r\nDEFAULT aArma    \t\t:= {}\r\nDEFAULT aveicProd\t\t:= {}\r\nDEFAULT aDI\t\t \t\t:= {}\r\nDEFAULT aAdi\t \t\t:= {}\r\nDEFAULT aExp\t \t\t:= {}\r\nDEFAULT aAnfI\t \t\t:= {}\r\nDEFAULT aPedCom  \t\t:= {}\r\nDEFAULT aFCI\t\t\t:= {}\r\nDEFAULT aIPIDevol\t\t:= {}\r\nDEFAULT aItemVinc\t\t:= {}\r\nDEFAULT aTotICMSST\t\t:= {}\r\nDEFAULT cMensFis \t\t:= \"\"\r\nDEFAULT cCsosn    \t\t:= \"\"\r\nDEFAULT cMensDifal\t\t:= \"\"\r\nDEFAULT nVicmsDeson\t\t:= 0\r\nDEFAULT nVIcmDif\t\t:= 0\r\nDEFAULT nIcmsDif\t\t:= 0 \r\nDEFAULT nvFCPUFDest\t\t:= 0\r\nDEFAULT nvICMSUFDest\t:= 0\r\nDEFAULT nvICMSUFRemet\t:= 0\r\nDEFAULT nvBCUFDest\t\t:= 0\r\nDEFAULT nTotProd\t\t:= 0\r\nDEFAULT nItProd\t\t\t:= 0\r\nDEFAULT nValDifer\t\t:= 0\r\n\r\ncVerAmb     := PARAMIXB[2]\r\ncAmbiente\t:= PARAMIXB[3]\r\ncF2Tipo\t:= IIF(!Empty(aNota[5]),aNota[5], \"N\")\r\ncArt274 := aProd[48]\r\n//Se o campo B1_CODGTIN estiver preenchido considera ele em promeiro lugar  para levar para nfe.\r\n//Porem se  B1_CODGTIN  ='999999999999999' e levando \"\" sendo tratado pelo tss \"SEM GETIN\"\r\n//Se B1_CODGTIN =  \"\" vaziu continua pegando do legado B1_CODBAR para levar para nfe.\r\ncEan\t\t:= IIF(!Empty(aProd[46]),iif( aProd[46] == \"000000000000000\",\"\",aProd[46]), aProd[03])\r\n\r\n//Se a segunda unidade de medida estiver \"B5_2CODBAR\" estiver preenchido leva ele  para nfe.\r\n//senão verifica se a unidade comercial e diferente da tributaria para considerar o mesmo valor da cEan se for igual.\r\ncEantrib\t:= IIF(!Empty(aProd[45]),aProd[45], iif( aProd[08] <> aProd[11],\"\",cEan))\r\n\r\n//Validação para controle das tags que deverão ser preenchidas apenas nas operações não destinadas a consumidor final RS\r\nlRetEfet := (cMVEstado == \"RS\" .and. cIndFinal == '0') .or. cMVEstado <> \"RS\"\r\n\r\ncString += '<det nItem=\"'+ConvType(aProd[01])+'\">'\r\ncString += '<prod>'\r\ncString += '<cProd>'+ConvType(aProd[02])+'</cProd>'\r\ncString += '<ean>'+ConvType(cEan)+'</ean>'\r\ncString += '<Prod>'+ConvType(aProd[04],120)+'</Prod>'\r\nIf len(aDI)> 0\r\n\tcString +='<NCM>'+ConvType(aDI[01][03])+'</NCM>'\r\n\tIf cVerAmb >= \"3.10\" .and. ConvType(aDI[04][1]) == \"I19\"\r\n\t\tcString += NfeTag('<NVE>',ConvType(aDI[35][03]))\r\n\tElseIf cVerAmb >= \"3.10\" .and. ConvType(aDI[02][1]) == \"I19\" //Nota Complementar EEC/EIC\r\n\t\tcString += NfeTag('<NVE>',ConvType(aDI[17][03]))\t\r\n\tEndIf\r\nElse\r\n\tcString +='<NCM>'+ConvType(aProd[05])+'</NCM>'\r\nEndIf\r\ncString += NfeTag('<CEST>',ConvType(aProd[41]))\r\n\r\nIF cVeramb >= \"4.00\"\r\n\tcString += NfeTag('<indEscala>',ConvType(aProd[47]))\r\n\tcString += NfeTag('<cBenef>',ConvType(aProd[44]))\r\n\r\nEndIf\r\ncString += NfeTag('<EXTIPI>',ConvType(aProd[06]))\r\ncString += '<CFOP>'+ConvType(aProd[07])+'</CFOP>'\r\ncString += '<uCom>'+ConvType(aProd[08])+'</uCom>'\r\ncString += '<qCom>'+ConvType(round(aProd[09],4),15,4 )+'</qCom>' // bruno original = ConvType( aProd[09],15,4 )\r\n\r\n/*\r\nbruno sigawise\r\n-original = cString += '<vUnCom>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[09],21,8))+'</vUnCom>'\r\n-não tem o if\r\n*/\r\nIf aProd[8] <> aProd[11]\r\n\tcString += '<vUnCom>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[09],21,8))+'</vUnCom>'\r\nElse\r\n\tcString += '<vUnCom>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[12],21,8))+'</vUnCom>'\r\nEndIf\r\n\r\ncString += '<vProd>' +ConvType(aProd[10],15,2)+'</vProd>' \r\ncString += '<eantrib>'+ConvType(cEantrib)+'</eantrib>'\r\ncString += '<uTrib>'+ConvType(aProd[11])+'</uTrib>'\r\nIf aProd[8] <> aProd[11]  // aProd[8] = B1_UM  e  aProd[11] = B5_UMDIPI - pega diferente para segunda unidade de medida \r\n\tcString += '<qTrib>' + ConvType(aProd[12], 15, TamSX3(\"B5_CONVDIP\")[2]) + '</qTrib>'\r\nElse\r\n\tcString += '<qTrib>' + ConvType(aProd[12], 15, Min(IIf(cTipo == \"0\", TamSX3(\"D1_QUANT\")[2], TamSX3(\"D2_QUANT\")[2]), 4)) + '</qTrib>'\r\nEndif\r\n\r\ncString += '<vUnTrib>'+ IIf(cF2Tipo == \"C\",ComplPreco(cTipo,cF2Tipo,aProd),ConvType(aProd[10]/aProd[12],21,8))+'</vUnTrib>'\t\r\n\r\ncString += NfeTag('<vFrete>',ConvType(aProd[13],15,2))\r\ncString += NfeTag('<vSeg>'  ,ConvType(aProd[14],15,2))\r\n\r\n//Tag <vDesc>\r\n//Quando eh Zona Franca de Manaus\r\nIf cVerAmb >= \"3.10\" .and. Len(aICMSZFM) > 0 .And. Len(aCST) > 0 .And. !Empty(aICMSZFM[1])\r\n\tIf !(lMvNFLeiZF)\t\r\n\t\tcString += NfeTag('<vDesc>' ,ConvType((aProd[31]+aProd[32])+aProd[15],15,2))\t\r\n\tElse\t\r\n\t\tcString += NfeTag('<vDesc>' ,ConvType(aProd[15],15,2))\r\n\tEndif\r\nElse\r\n\t//Versao 2.00\r\n\tcString += NfeTag('<vDesc>' ,ConvType((aProd[15]),15,2))\r\nEndIf\r\n\r\ncString += NfeTag('<vOutro>' ,ConvType(aProd[49]+aProd[21]+Iif(aAgrPis[01],aAgrPis[02],0)+Iif(aAgrCofins[01],aAgrCofins[02],0),15,2))\r\n// Define se o valor do produto <vProd> será agregado ao valor total\r\n//   dos produtos do documento <vProd> dentro de <total>\r\ncString += '<indTot>'+aProd[24]+'</indTot>'\r\n\r\n/* Adequação Nota Técnica 2013/003 (Obs. Tratamento apenas para documento de saída pois refere-se a venda ao consumidor) */\r\nIf cTipo == \"1\" .And. cTpCliente == \"F\"\r\n\tcString += NfeTag('<vTotTrib>' ,ConvType(aProd[30],15,2))\r\nEndIf\r\n\r\n\r\n/*Nas situações em que o valor unitário comercial (vUnCom) for diferente do valor unitário tributável (vUnTrib), \r\nambas as informações deverão estar expressas e identificadas no DANFE - CH:TGCOQA*/\r\n\r\ncVunCom := ConvType(aProd[10]/aProd[09],21,8)\r\ncVunTrib:= ConvType(aProd[10]/aProd[12],21,8)\r\n\r\nIf (cVunCom <> cVunTrib) .and. lUnTribCom\r\n\tcMensFis += \" \"\r\n\tcMensFis += \"(Valor unitario comercial: \"+cVunCom+ \", \"\r\n\tcMensFis += \"Valor unitario tributavel: \"+cVunTrib+ \") \"\t\r\nEndIf\r\n\r\n//³Criação de novo grupo “Rastreabilidade de produto” para permitir a rastreabilidade de qualquer produto sujeito a regulações sanitárias.\r\nIf\tcVeramb >= \"4.00\" .and. !empty(aLote)\r\n    If  !empty(aLote[1])\r\n\t\tcString += '<rastro>'\r\n\t\tcString += '<nLote>'+ConvType(aLote[01])+'</nLote>'\r\n\t\tcString += '<qLote>'+ConvType(aLote[02],12,3)+'</qLote>'\r\n\t\tcString += '<dFab>'+ConvType(aLote[03]) +'</dFab>'\r\n\t\tcString += '<dVal>'+ConvType(aLote[04]) +'</dVal>'\r\n\t\tcString += NfeTag('<cAgreg>',ConvType(aLote[05]))\r\n\t\tcString += '</rastro>'\r\n\tEndIf\r\nEndIf \r\n\r\n//Ver II - Average - Tag da Declaração de Importação aDI\r\nIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\"\r\n\tcString += '<DI>'\r\n\tcString += '<nDI>'+ConvType(aDI[04][03])+'</nDI>'\r\n\tcString += '<dtDi>'+ConvType(aDI[05][03])+ '</dtDi>'      \r\n\tcString += '<LocDesemb>'+ConvType(aDI[06][03])+ '</LocDesemb>'\r\n\tcString += '<UFDesemb>'+ConvType(aDI[07][03])+ '</UFDesemb>'\r\n\tcString += '<dtDesemb>'+ConvType(aDI[08][03])+ '</dtDesemb>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<viaTransp>'+ConvType(aDI[36][03],2)+ '</viaTransp>'\r\n\t\tcString += NfeTag('<AFRMM>',ConvType(aDI[37][3],15,2))\r\n\t\tcString += '<intermedio>'+ConvType(aDI[38][03],1)+ '</intermedio>'\r\n\t\tcString += NfeTag('<CNPJ>',ConvType(aDI[39][3],14))\r\n\t\tcString += NfeTag('<UfTerceiro>',ConvType(aDI[40][3],2))\t\t\r\n\tEndIf\r\n\tcString += '<Exportador>'+ConvType(aDI[09][03])+ '</Exportador>'\r\n\tIf Len(aAdi)>0\r\n\t\tcString += '<adicao>'\r\n\t\tcString += '<Adicao>'+ConvType(aAdi[10][03])+ '</Adicao>'\r\n\t\tcString += '<SeqAdic>'+ConvType(aAdi[11][03])+ '</SeqAdic>'\r\n\t\tcString += '<Fabricante>'+ConvType(aAdi[12][03])+ '</Fabricante>'\r\n\t\tcString += '<vDescDI>'+ConvType(aAdi[13][03])+ '</vDescDI>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += NfeTag('<draw>',ConvType(aAdi[34][3],11))\r\n\t\tEndIf\r\n\t\tcString += '</adicao>'\r\n\tEndIf\r\n\tcString += '</DI>'\r\n\t/*Impressão dos dados da DI nas informações complementares do Danfe - CH:TELKDV*/\r\n\tIf lDInoDanfe\r\n\t\tcMsgDI  := \" \"\r\n\t\tcMsgDI += \"(Numero DI: \"+ConvType(aDI[04][03])+ \", \"\r\n\t\tcMsgDI += \"Local do Desembaraco: \"+ConvType(aDI[06][03])+ \", \"\r\n\t\tcMsgDI += \"UF do Desembaraco: \"+ConvType(aDI[07][03])+\", \"\r\n\t\tcMsgDI += \"Data do Desembaraco: \"+ConvType(aDI[08][03])+ \") \"\t\r\n\r\n\t\tIf !cMsgDI $ cMensFis\r\n\t\t\tcMensFis += cMsgDI\r\n\t\tEndIf\r\n\tEndIf\r\nElseif Len(aDI)>0\r\n\t//Nota Complementar - SIGAEIC estrutura 23X3\r\n\tcString += '<DI>'\r\n\tcString += '<nDI>'+ConvType(aDI[02][03])+'</nDI>'\r\n\tcString += '<dtDi>'+ConvType(aDI[03][03])+ '</dtDi>'      \r\n\tcString += '<LocDesemb>'+ConvType(aDI[04][03])+ '</LocDesemb>'\r\n\tcString += '<UFDesemb>'+ConvType(aDI[05][03])+ '</UFDesemb>'\r\n\tcString += '<dtDesemb>'+ConvType(aDI[06][03])+ '</dtDesemb>'\r\n\t\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<viaTransp>'+ConvType(aDI[18][03],2)+ '</viaTransp>'\r\n\t\tcString += NfeTag('<AFRMM>',ConvType(aDI[19][3],15,2))\r\n\t\tcString += '<intermedio>'+ConvType(aDI[20][03],1)+ '</intermedio>'\r\n\t\tcString += NfeTag('<CNPJ>',ConvType(aDI[21][3],14))\r\n\t\tcString += NfeTag('<UfTerceiro>',ConvType(aDI[22][3],2))\t\t\r\n\tEndIf\r\n\tcString += '<Exportador>'+ConvType(aDI[07][03])+ '</Exportador>'\r\n\tIf Len(aAdi)>0\r\n\t\tcString += '<adicao>'\r\n\t\tcString += '<Adicao>'+ConvType(aAdi[08][03])+ '</Adicao>'\r\n\t\tcString += '<SeqAdic>'+ConvType(aAdi[09][03])+ '</SeqAdic>'\r\n\t\tcString += '<Fabricante>'+ConvType(aAdi[10][03])+ '</Fabricante>'\r\n\t //\tcString += '<vDescDI>'+ConvType(aAdi[13][03])+ '</vDescDI>'\r\n\t \tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += NfeTag('<draw>',ConvType(aAdi[23][3],11))\r\n\t\tEndIf\r\n\t\tcString += '</adicao>'\r\n\tEndIf\r\n\tcString += '</DI>'\r\n\t/*Impressão dos dados da DI nas informações complementares do Danfe - CH:TELKDV*/\r\n\tIf lDInoDanfe\r\n\t\tcMsgDI := \" \"\r\n\t\tcMsgDI += \"(Numero DI: \"+ConvType(aDI[02][03])+ \", \"\r\n\t\tcMsgDI += \"Local do Desembaraco: \"+ConvType(aDI[04][03])+ \", \"\r\n\t\tcMsgDI += \"UF do Desembaraco: \"+ConvType(aDI[05][03])+\", \"\r\n\t\tcMsgDI += \"Data do Desembaraco: \"+ConvType(aDI[06][03])+ \") \"\t\r\n\r\n\t\tIf !cMsgDI $ cMensFis\r\n\t\t\tcMensFis += cMsgDI\r\n\t\tEndIf\r\n\tEndIf\r\nEndIf\r\n\r\n/*Grupo de informações de exportação para o item - versão 3.10*/\r\nIf cVerAmb >= \"3.10\" .and. Len(aExp)>0\r\n\tIf lEECFAT\r\n\t\t/*Quando a terceira posição do array estiver vazia ou possuir tamanho 0 é porque a informação não existe no processo.\r\n\t\t  Quando não houver dados de retorno referente ao ato concessório e a exportação indireta, a posição [3][3] terá tamanho 0.\r\n\t\t  Quando houver ato concessório, a informação será retornada na posição [3][3][1]. O tamanho dessa dimensão corresponde à quantidade de atos concessórios encontrados para o item.\r\n\t\t  Quando houver exportação indireta, a informação será retornada na posição [3][3][2]. O tamanho dessa dimensão corresponde à quantidade de notas fiscais de remessa com fim específico de exportação encontrada para o item.\r\n\t\t*/\r\n\t\tIf ConvType(aExp[03][1]) == \"I50\" .and. Len(aExp[03][3]) > 0\r\n\t\t\t\r\n\t\t\t\tFor nA:= 1 to Len(aExp[03][3][1])\r\n\t\t\t\t\tanDraw:= aExp[03][3][1][nA] //Array (tag nDraw - I51)\r\n\t\t\t\t\taExportInd:= aExp[03][3][2][nA]//Array I52(Grupo - I52)\r\n\t\t\t\t\t\r\n\t\t\t\t\tcString += '<detExport>'\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !Empty(anDraw[3])\r\n\t\t\t\t\t\tcString += '<Draw>'+ConvType(anDraw[3],11)+ '</Draw>'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//Caso não tenha I52, posição 3 é retornada vazia\r\n\t\t\t\t\tIf !Empty(aExportInd[3])\r\n\t\t\t\t\t\tcString += '<exportInd>'\r\n\t\t\t\t\t\tcString += '<nre>'+ConvType(aExportInd[03][1][3],12)+ '</nre>'\r\n\t\t\t\t\t\tcString += '<chnfe>'+ConvType(aExportInd[03][2][3],44)+ '</chnfe>'\r\n\t\t\t\t\t\tcString += '<qExport>'+ConvType(aExportInd[03][3][3],15,4)+ '</qExport>'\r\n\t\t\t\t\t\tcString += '</exportInd>'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tcString += '</detExport>'\r\n\t\t\t\tNext\r\n\t\t\t\r\n\t\tEndIf\r\n\t// Para nota de devolução de exportação gerar a tag  exportInd para não ocorrer a rejeição:340\r\n\t//340-Rejeicao: Nao informado o grupo de exportacao indireta no item [nItem:1] chamado:TVTAA8                                                                                                                                                                                  \r\n\tElseIf !lEECFAT .and. aNota[04] == \"0\" .and. aNota[5] $ \"D|N\"  \r\n\t\tFor nX := 1 To Len(aExp)\r\n\t\t\t   IF !Empty(aExp[nX][03][03]) .Or. !Empty(aExp[nX][04][03]) \r\n\t\t\t\t\tcString += '<detExport>'\r\n\t\t\t\t\tIf !Empty(aExp[nX][04][03])\r\n\t\t\t\t\t\tcString += '<exportInd>'\r\n\t\t\t\t\t\tcString += '<nre>'+ConvType(aExp[nX][04][03],12)+ '</nre>'\r\n\t\t\t\t\t\tcString += '<chnfe>'+ConvType(aExp[nX][05][03],44)+ '</chnfe>'\r\n\t\t\t\t\t\tcString += '<qExport>'+ConvType(aExp[nX][06][03],15,4)+ '</qExport>'\r\n\t\t\t\t\t\tcString += '</exportInd>'\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcString += '</detExport>'\r\n\t\t\t\tEndif\r\n\t\tNext\t\r\n\tElse\r\n\t\tFor nX := 1 To Len(aExp)\r\n\t\t\tIf ConvType(aExp[nX][03][1]) == \"I51\"\r\n\t\t\t   IF !Empty(aExp[nX][03][03]) .Or. aExp[nX][08][03] == \"1\" .Or. (!Empty(aExp[nX][04][03]) .And. !Empty(aExp[nX][05][03]) .And. !Empty(aExp[nX][06][03]))\r\n\t\t\t\t\tcString += '<detExport>'\r\n\t\t\t\t\tcString += '<Draw>'+ConvType(aExp[nX][03][03],11)+ '</Draw>'\r\n\t\t\t\t\tIf aExp[nX][08][03] == \"1\" .Or. (!Empty(aExp[nX][04][03]) .And. !Empty(aExp[nX][05][03]) .And. !Empty(aExp[nX][06][03]))\r\n\t\t\t\t\t\tcString += '<exportInd>'\r\n\t\t\t\t\t\tcString += '<nre>'+ConvType(aExp[nX][04][03],12)+ '</nre>'\r\n\t\t\t\t\t\tcString += '<chnfe>'+ConvType(aExp[nX][05][03],44)+ '</chnfe>'\r\n\t\t\t\t\t\tcString += '<qExport>'+ConvType(aExp[nX][06][03],15,4)+ '</qExport>'\r\n\t\t\t\t\t\tcString += '</exportInd>'\r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\t\tcString += '</detExport>'\r\n\t\t\t\tEndif\r\n\t\t\tEndIf\r\n\t\tNext \r\n\tEndIf\r\nEndif\r\n//Combustiveis\r\n\r\nIf Len(aComb) > 0  .And. !Empty(aComb[01])\r\n\tcString += '<comb>'\r\n\tcString += '<cprodanp>'+ConvType(aComb[01])+'</cprodanp>'\r\n\tIf cVeramb >= \"3.10\" .and. Len(aComb) > 4\r\n\t\tcString += NfeTag('<mixGN>',ConvType(aComb[08],7,4))\r\n\tEndIf\r\n\t\r\n\tIf\tcVeramb >= \"4.00\" .and. Len(aComb) > 4\r\n\t\tcString += '<descANP>'+ConvType(aComb[14])+'</descANP>'\r\n\t\tcString += NfeTag('<pGLP>',ConvType(aComb[15],15,4))\r\n\t\tcString += NfeTag('<pGNn>',ConvType(aComb[16],15,4))\r\n\t\tcString += NfeTag('<pGNi>',ConvType(aComb[17],15,4))\r\n\t\tcString += NfeTag('<vPart>',ConvType(aComb[18],13,2))\r\n\tEndif\r\n\t\r\n\tcString += NfeTag('<codif>',ConvType(aComb[02]))\r\n\r\n\tcString += NfeTag('<qTemp>',ConvType(aComb[03],12,4))\r\n\tcString += '<ICMSCONS>'\r\n\tcString += '<UFCons>'+aComb[04]+'</UFCons>'\r\n    cString += '</ICMSCONS>'\t\r\n    If Len(aComb) > 4 .and. !Empty(aComb[05])\r\n\t\tcString += '<CIDE>'\r\n\t\tcString += '<qBCProd>'+ConvType(aComb[05],16,2)+'</qBCProd>'\r\n\t\tcString += '<vAliqProd>'+ConvType(aComb[06],15,4)+'</vAliqProd>'\r\n\t\tcString += '<vCIDE>'+ConvType(aComb[07],15,2)+'</vCIDE>'\r\n\t\tcString += '</CIDE>'\r\n\tEndif\t\r\n\t/*NT 2015/002\r\n\t379 - Rejeição: Grupo de Encerrante na NF-e (modelo 55) para CFOP diferente \r\n\tde venda de combustível para consumidor final (CFOP=5.656, 5.667).\t\r\n\t*/\r\n\tIf Len(aComb) > 4 .and. !Empty(aComb[09])\r\n\t\tcString += '<encerrante>'\r\n\t\tcString += '<nBico>'+ConvType(aComb[09])+'</nBico>'\r\n\t\tcString += NfeTag('<nBomba>',ConvType(aComb[10]))\r\n\t\tcString += '<nTanque>'+ConvType(aComb[11])+'</nTanque>'\r\n\t\tcString += '<vEncIni>'+ConvType(aComb[12],15)+'</vEncIni>'\r\n\t\tcString += '<vEncFin>'+ConvType(aComb[13],15)+'</vEncFin>'\r\n\t\tcString += '</encerrante>'\t\t\r\n\tEndIf\r\n\tcString += '</comb>'\r\n\r\nElseIf !Empty(aProd[17])\r\n\tcString += '<comb>'\r\n\tcString += '<cprodanp>'+ConvType(aProd[17])+'</cprodanp>'\r\n\tcString += NfeTag('<codif>',ConvType(aProd[18]))\r\n\tcString += '</comb>'\r\n\t//Tratamento da CIDE - Ver com a Average\r\n\t//Tratamento de ICMS-ST - Ver com fisco\r\nEndIf\r\n\r\n//Veiculos Novos\r\nIf !Empty(aveicProd) .And. !Empty(aveicProd[02])\r\n\tcString += '<veicProd>'\r\n\tcString += '<tpOp>'+ConvType(aveicProd[01])+'</tpOp>'\r\n\tcString += '<chassi>'+ConvType(aveicProd[02],17)+'</chassi>'\r\n\tcString += '<cCor>'+ConvType(aveicProd[03],4)+'</cCor>'\r\n\tcString += '<xCor>'+ConvType(aveicProd[04],40)+'</xCor>'\r\n\tcString += '<pot>'+ConvType(aveicProd[05],4)+'</pot>'\r\n\tcString += '<Cilin>'+ConvType(aveicProd[23],4)+'</Cilin>'\r\n\t//Alteração efeutada para permitir que de acorodo com o Manual NFE 6.0, \r\n\t//quando peso liquido e bruto forem em toledas que se tenham 4 casas decimais.\r\n\tcString += '<pesol>'+ConvType(aveicProd[07],9,4)+'</pesol>'\r\n\tcString += '<pesob>'+ConvType(aveicProd[08],9,4)+'</pesob>'\t\r\n\tcString += '<nserie>'+ConvType(aveicProd[09],9)+'</nserie>'\r\n\tcString += '<tpcomb>'+ConvType(aveicProd[10],2)+'</tpcomb>'\r\n\tcString += '<nmotor>'+ConvType(aveicProd[11],21)+'</nmotor>'\r\n\tcString += '<CMT>'+ConvType(aveicProd[24],9)+'</CMT>' \r\n\tcString += '<dist>'+ConvType(aveicProd[13],4)+'</dist>'\r\n\tcString += '<anomod>'+ConvType(aveicProd[15],4)+'</anomod>'\r\n\tcString += '<anofab>'+ConvType(aveicProd[16],4)+'</anofab>'\r\n\tcString += '<tppint>'+ConvType(aveicProd[17],1)+'</tppint>'\r\n\tcString += '<tpveic>'+ConvType(aveicProd[18],2)+'</tpveic>'\r\n\tcString += '<espvei>'+SubStr(aveicProd[19],2,1)+'</espvei>'  // Considera apenas a segunda posição do campo CD9_ESPVEI\r\n\tcString += '<vin>'+ConvType(aveicProd[20],1)+'</vin>'\r\n\tcString += '<condvei>'+ConvType(aveicProd[21],1)+'</condvei>'\r\n\tcString += '<cmod>'+ConvType(aveicProd[22],6)+'</cmod>'\r\n\tcString += '<cCorDENATRAN>'+ConvType(aveicProd[26],2)+'</cCorDENATRAN>'\r\n\tcString += '<Lota>'+ConvType(aveicProd[25],3)+'</Lota>'\r\n\tcString += '<tpRest>'+ConvType(aveicProd[27],1)+ '</tpRest>'\r\n\tcString += '</veicProd>'                            \r\nEndIf \r\n\r\n\r\n//Medicamentos\r\nIf !Empty(aMed) .And. !Empty(aMed[01])\r\n\tcString += '<med>'\t\r\n\tcString += '<cProdANVISA>'+ConvType(aMed[06],13)+'</cProdANVISA>'\r\n\tIf lTagProduc .and. !Empty(aMed[07])\r\n\t\tcString += '<MotivoIsencao>'+ConvType(aMed[07],225)+'</MotivoIsencao>'\r\n\tEndIf\r\n\tcString += '<Lote>'+ConvType(aMed[01],20)+'</Lote>'\r\n\tcString += NfeTag('<qLote>',ConvType(aMed[02],11,3))\r\n\tcString += NfeTag('<dtFab>',ConvType(aMed[03]))\r\n\tcString += NfeTag('<dtVal>',ConvType(aMed[04]))\r\n\tcString += '<vPMC>'+ConvType(aMed[05],15,2)+'</vPMC>'\r\n\tcString += '</med>'                            \r\nEndIf \r\n\r\n//Armas de Fogo\r\nIf !Empty(aArma) .And. !Empty(aArma[01])\r\n\tcString += '<arma>'\t\r\n\tcString += '<tpArma>'+ConvType(aArma[01])+'</tpArma>'\r\n\tIf cVeramb >= \"3.10\"\r\n\t\tcString += NfeTag('<nSerie>',ConvType(aArma[02],15))\r\n\t\tcString += NfeTag('<nCano>' ,ConvType(aArma[02],15))\r\n\tElse\r\n\t\tcString += NfeTag('<nSerie>',ConvType(aArma[02],9))\r\n\t\tcString += NfeTag('<nCano>' ,ConvType(aArma[02],9))\r\n\tEndIf\r\n\tcString += NfeTag('<descr>' ,ConvType(aArma[03],256))\r\n\tcString += '</arma>'                            \r\nEndIf \r\n\r\n//RECOPI\r\nIf cVeramb >= \"3.10\" .and. !Empty(cNumRecopi)\r\n\tcString += '<Recopi>'\r\n\tcString += '<nRECOPI>'+cNumRecopi+'</nRECOPI>'\r\n\tcString += '</Recopi>'\r\nEndIf\r\n\r\nIf Len(aPedCom) > 0 .And. !Empty(aPedCom[01])\r\n\tcString += '<xPed>'+ConvType(aPedCom[01])+'</xPed>'\r\n\tcString += '<nItemPed>'+ConvType(aPedCom[02])+'</nItemPed>'\r\nEndif\r\n\r\n//Nota Técnica 2013/006\r\nIf !Empty(aFCI)\r\n\tcString += '<nFCI>'+Alltrim(aFCI[01])+'</nFCI>'\r\nEndIf\r\ncString += '</prod>'\r\nDbSelectArea(\"SF4\")\r\n\r\nlIssQn:=(Len(aISSQN)>0 .and. !Empty(aISSQN[01]))\r\n\r\nIf (aCST[01] = \"60\" .or. cCsosn$ \"500\") .and. !Empty(cUltAqui)  .and. Len(aIcms)>19\r\n\t//novos campos na tabela SFT são: FT_BSTANT (Base) FT_PSTANT (Percentual) FT_VSTANT (Valor) Atenciosamente.\r\n\tnBaseIcm :=  aICMS[20]      //SFT->FT_BSTANT\r\n\tnValICM  :=  aICMS[21]      //SFT->FT_VSTANT\r\n\tnAlqICM  :=  aICMS[22]      //SFT->FT_PSTANT\r\n\t//novos campos do FECP na tabela SFT são: FT_BFCANTS (Base) FT_PFCANTS (Percentual) FT_VFCANTS (Valor) Atenciosamente.\r\n\tnBfcpant := aICMS[23]    //SFT->FT_BFCANTS\r\n\tnAfcpant := aICMS[24]    //SFT->FT_PFCANTS\r\n\tnVfcpant := aICMS[25]    //SFT->FT_VFCANTS\r\n\r\n\tnVICPRST := aICMS[26]   // FT_VICPRST  (Tag vICMSSubstituto)\r\nEndif\r\n\r\nIf  !lIssQn    \r\n\tIf cMVCODREG == \"1\" .and. SF4->(FieldPos(\"F4_CSOSN\"))>0 .And. !Empty(SF4->F4_CSOSN)\r\n\t\r\n\t\tIf Len(aIcms)>0\t\t\t\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>ICMSSN</codigo>'\r\n\t\t \tcString += '<cpl>'\r\n\t\t   \tcString += '<orig>'+ConvType(aICMS[01])+'</orig>'\r\n\t\t   \tcString += '</cpl>' \r\n\t\t   \tcString += '<Tributo>'\r\n\t\t\tcString += '<CSOSN>'+cCsosn+'</CSOSN>'   \r\n\t\tElse\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>ICMSSN</codigo>'\r\n\t\t \tcString += '<cpl>'\r\n\t\t   \tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\r\n\t\t   \tcString += '</cpl>' \r\n\t\t   \tcString += '<Tributo>'\r\n\t\t\tcString += '<CSOSN>'+cCsosn+'</CSOSN>' \t\r\n\t\tEndif\t\r\n\t\t\r\n\t\tIf cCsosn$\"900\" .And. Len(aIcms)>0\t    \r\n\t\t\tcString += '<modBC>'+ConvType(aICMS[03])+'</modBC>'\r\n\t\t\tcString += '<vBC>'+ConvType(aICMS[05],15,2)+'</vBC>'\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\" .And. !Empty(aAdi[14][03])\t\t\t \r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\r\n\t\t   \tElse\r\n\t   \t\t\tcString += '<pRedBC>'+ConvType(aICMS[04],8,4)+'</pRedBC>'\r\n\t\t\tEndIf\r\n\t\t\tcString += '<pICMS>'+ConvType(aICMS[06],5,2)+'</pICMS>'\r\n\t\t\tcString += '<vICMS>'+ConvType(aICMS[07],15,2)+'</vICMS>'\r\n\t\t\t\r\n\t\tElseIf cCsosn$\"900\" .And. Len(aIcms)<=0\t  \r\n\t\t\tcString += '<modBC>'+ConvType(0)+'</modBC>'\r\n\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\" .And. !Empty(aAdi[14][03])\t\t\t \r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\t\t\t \r\n\t\t   \tElse\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\t\t   \t\r\n\t\t\tEndIf\r\n\t\t\tcString += '<pICMS>'+ConvType(0,5,2)+'</pICMS>'\r\n\t\t\tcString += '<vICMS>'+ConvType(0,15,2)+'</vICMS>'\r\n\t\t\t\r\n\t    Endif\r\n\t\t\r\n\t\tIf cCsosn$\"201,202,203,900\" .AND. Len(aICMSST)>0\t\r\n\t\t\tcString += '<modBCST>'+ConvType(aICMSST[03])+'</modBCST>'\r\n\t\t\tIf cVeramb >= \"3.10\"\r\n\t\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],8,4)+'</pmvast>'\r\n\t\t\t\tcString += '<pRedBCST>'+ConvType(aICMSST[04],7,4)+'</pRedBCST>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],6,2)+'</pmvast>'\r\n\t\t\t\tcString += '<pRedBCST>'+ConvType(aICMSST[04],5,2)+'</pRedBCST>'\r\n\t\t\tEndIf\t\t\t\r\n\t\t\tcString += '<vBCST>'+ConvType(aICMSST[05],15,2)+'</vBCST>'\r\n\t\t\tcString += '<pICMSST>'+ConvType(aICMSST[06],5,2)+'</pICMSST>'\r\n\t\t\tcString += '<vICMSST>'+ConvType(aICMSST[07],15,2)+'</vICMSST>'\r\n\t    Elseif cCsosn$\"201,202,203,900\"\r\n\t    \tcString += '<modBCST>0</modBCST>'\r\n\t\t\tcString += '<vBCST>'+ConvType(0,15,2)+'</vBCST>'\r\n\t\t\tcString += '<pICMSST>'+ConvType(0,5,2)+'</pICMSST>'\r\n\t\t\tcString += '<vICMSST>'+ConvType(0,15,2)+'</vICMSST>'\r\n\t\t\t\r\n\t\t\tIF cVeramb >= \"4.00\" .AND. Len(aICMSST)>0 \r\n\t\t\t   IF cCsosn$ \"201\"\r\n\t\t\t\t\tcString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\t\t\t\r\n\t\t\t\t//pCredSN Alíquota aplicável de cálculo do crédito\r\n             // vCredICMSSN Valor crédito do ICMS\t\r\n\t\t\t   elseIf  cCsosn$ \"202,203\"\r\n\t\t\t        cString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\t\t   Endif\t\r\n\t\t\tEndif\r\n\t\tEndif\r\n\t\t\r\n\t\tIf cCsosn$\"500\"   \r\n\t\t\tIf Empty(cUltAqui) \r\n\t\t\t\tSPEDRastro2(aProd[20],aProd[19],aProd[02],@nBaseIcm,@nValICM,,,lCalcMed,@nAlqICM,,,,,,,,,,,@nBfcpant,@nAfcpant,@nVfcpant)        \r\n\t\t\t\r\n\t\t\t\tIf nBaseIcm > 0 .and. nValICM>0\r\n\t\t\t\t\tnBaseIcm := aProd[09]*nBaseIcm\r\n\t\t\t\t\tnValICM  := aProd[09]*nValICM\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t//multiplica o valor facp anterior.\r\n\t\t\t\tIf\tnBfcpant > 0 .and. nVfcpant>0\r\n\t\t\t\t\tnBfcpant  := aProd[09]*nBfcpant\r\n\t\t\t\t\tnVfcpant  := aProd[09]*nVfcpant\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tif lRetEfet\r\n\t\t\t\r\n\t\t\t\tIf nBaseIcm > 0\r\n\t\t\t\t\tcString += '<vBCSTRet>'+ConvType(nBaseIcm,15,2)+'</vBCSTRet>' \r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<vBCSTRet>'+ConvType(0,15,2)+'</vBCSTRet>'\r\n\t\t\t\tEndif\r\n\t\t\t\tIf nValICM > 0\r\n\t\t\t\t\tcString += '<vICMSSTRet>'+ConvType(nValICM,15,2)+'</vICMSSTRet>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<vICMSSTRet>'+ConvType(0,15,2)+'</vICMSSTRet>'\r\n\t\t\t\tEndif \r\n\t\t\t\t\r\n\t\t\t\tIf cVeramb >= \"4.00\" .AND. Len(aICMSST)>0\t\r\n\t\t\t\t\tcString += '<pST>'+ConvType((aICMSST[06]+aICMSST[14]),5,2)+'</pST>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<pST>'+ConvType((nAlqICM),5,2)+'</pST>'\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf lTagProduc \r\n\t\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\t\tEndif\r\n\r\n\t\t\t\tcString += '<vBCFCPSTRet>'+ConvType(nBfcpant,15,2)+'</vBCFCPSTRet>'\r\n\t\t\t\tcString += '<pFCPSTRet>'+ConvType(nAfcpant,5,2)+'</pFCPSTRet>'\r\n\t\t\t\tcString += '<vFCPSTRet>'+ConvType(nVfcpant,15,2)+'</vFCPSTRet>'\r\n\t\t\tendif\r\n\t\t\t\r\n\t\t\t//Tratamento implementado para atender o DECRETO Nº 54.308, DE 6 DE NOVEMBRO DE 2018. (publicado no DOE n.º 212, de 7 de novembro de 2018)\t\t\t\t\t\r\n\t\t\tIf cIndFinal == \"1\"\t.and. Len(aIcms)>0\t\t\t\t \r\n\t\t\t\tcString += '<pRedBCEfet>'+ConvType(aICMS[4],8,4)+'</pRedBCEfet>'\r\n\t\t\t\tcString += '<vBCEfet>'+ConvType( aICMS[5] ,16,2)+'</vBCEfet>'\r\n\t\t\t\tcString += '<pICMSEfet>'+ConvType(aICMS[6],8,4)+'</pICMSEfet>'\r\n\t\t\t\tcString += '<vICMSEfet>'+ConvType(aICMS[7],16,2)+'</vICMSEfet>'\r\n\t\t\tEndif\r\n\t\tEndif\r\n\t\t\r\n\t\tIF cVeramb >= \"4.00\" .AND. cCsosn$\"201,202,900\" .AND. Len(aICMSST)>0\t\r\n\t\t\tcString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\tEndIf\t\r\n\t\t\r\n\t\tIf cCsosn$\"101,201,900,\" .And. Len(aIcms)>0\t   \r\n\t\t\tcString += '<pCredSN>'+ConvType(aICMS[06],5,2)+'</pCredSN>'    \r\n\t\t\tcString += '<vCredICMSSN>'+ConvType(aICMS[07],15,2)+'</vCredICMSSN>'\r\n\t\tElseIf cCsosn$\"101,201,900,\" .And. Len(aIcms)<=0\t  \r\n\t\t\tcString += '<pCredSN>'+ConvType(0,5,2)+'</pCredSN>'\r\n\t\t\tcString += '<vCredICMSSN>'+ConvType(0,15,2)+'</vCredICMSSN>'\r\n\t\tEndif\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\t\r\n\tElseIf ( Len(aIcms) >0 .And. Len(aIcmsST)> 0 ).And. ( aICMSST[11] == \"2\" .And. aIcms[13] == \"2\" ) .And. aCST[01] $ \"10-90\"\r\n\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSPART</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\t\t\r\n\t\t//cString += '<pmvast>'+ConvType(aICMSST[08],6,2)+'</pmvast>'\r\n\t\tcString += '</cpl>'\t\t\t\t\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>' \r\n\t\tcString += '<modBC>'+ConvType(aICMS[03])+'</modBC>'\t\t\r\n\t\tcString += '<vBC>'+ConvType(aICMS[05],15,2)+'</vBC>'\r\n\t\t//cString += '<pRedBC>'+ConvType(aICMS[04],5,2)+'</pRedBC>'\t\t\r\n\t\tIf cVeramb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMS[06],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMS[06],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tcString += '<valor>'+ConvType(aICMS[07],15,2)+'</valor>'\r\n\t\tcString += '<modBCST>'+ConvType(aICMSST[03])+'</modBCST>'\t\t\r\n\t\t//cString += '<pRedBCST>'+ConvType(aICMSST[04],5,2)+'</pRedBCST>'\t\r\n\t\tcString += '<vBCST>'+ConvType(aICMSST[05],15,2)+'</vBCST>'\t\r\n\t\tIf cVeramb >= \"3.10\"\t\r\n\t\t\tcString += '<aliquotaST>'+ConvType(aICMSST[06],7,4)+'</aliquotaST>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquotaST>'+ConvType(aICMSST[06],5,2)+'</aliquotaST>'\r\n\t\tEndif\r\n\t\tcString += '<valorST>'+ConvType(aICMSST[07],15,2)+'</valorST>'\t\t\r\n\t\tIf cVeramb >= \"3.10\"\r\n\t\t\tcString += '<pBCOp>'+ConvType(aICMS[04],7,4)+'</pBCOp>'\r\n\t\tElse\r\n\t\t\tcString += '<pBCOp>'+ConvType(aICMS[04],5,2)+'</pBCOp>'\r\n\t\tEndIf\r\n\t\tcString += '<UFST>'+aDest[09]+'</UFST>'\t\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\t\r\n\tElse\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMS</codigo>'\r\n\t\tIf Len(aIcms)>0\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += '<orig>'+ConvType(aICMS[01])+'</orig>'\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\t\r\n\t\t\t// No caso de diferimento (CST 51) o cliente que deverá escolher a opção 90\r\n\t\t\t//   caso esteja utilizando a versão 2.00 da NF-e, enquanto não houver adequação.\r\n\t\t\t// o sistema não pode forçar o CST 90\r\n\t\t\tcString += '<CST>'+ConvType(aICMS[02])+'</CST>'\r\n\t\t\t\r\n\t   \t\tIf(aCST[1] $ '40,41,50') .Or. ((aCST[1] == '51') .And. lArt186)\r\n\t   \t\t\tcString += '<vBC>'+'0'+'</vBC>'     \r\n\t\t\t\tIf Len(aICMSZFM)>0 .And. aCST[1] $ '40|41|50'\r\n\t\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMSZFM[02])+'</motDesICMS>'\r\n\t\t\t\t\tcMotDesICMS:= ConvType(aICMSZFM[02])\t\t\t\t\t\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMS[11])+'</motDesICMS>' \r\n\t\t\t\t\tcMotDesICMS:= ConvType(aICMS[11])\r\n\t\t\t\tEndIf\t\t\r\n\t\t\tElse\r\n\t\t\t\tIf aICMS[04] == 100 .And. aICMS[02] == \"20\"\r\n\t\t\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\t\t\tElse\r\n\t\t    \t\tcString += '<vBC>'+ConvType(iIf(lIcmDevol,aICMS[05],0),15,2)+'</vBC>'\r\n\t\t    \tEndIf\r\n\t\r\n\t   \t\tEndIf\t\r\n\t\t\tcString += '<modBC>'+ConvType(aICMS[03])+'</modBC>'\r\n\t\t\t\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\" .And. !Empty(aAdi[14][03])\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\t\t\t\t\t\r\n\t\t\tElse\r\n    \t\t\tcString += '<pRedBC>'+ConvType(aICMS[04],8,4)+'</pRedBC>'\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf ( aCST[1] == '51' .And. lArt186 )\r\n\t\t\t\tcString += '<aliquota>0</aliquota>'\t\t\r\n\t\t\tElse\r\n\t\t\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\t\t\tcString += '<aliquota>'+ConvType(iIf(lIcmDevol,aICMS[06],0),7,4)+'</aliquota>'\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<aliquota>'+ConvType(iIf(lIcmDevol,aICMS[06],0),5,2)+'</aliquota>'\r\n\t\t\t\tEndIf\t\t\t\r\n\t\t\tEndIf\t\t\t\t\r\n\t\t\r\n\t\t\tIf aICMS[04] == 100 .And. aICMS[02] == \"20\"\r\n\t\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\t\tElseIf ( aCST[1] == '51' .And. lArt186 )\r\n\t\t\t\tIf !Empty(aICMS[12]) .and. !Empty(aICMS[07]) .and. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) $ \"RS\"\r\n\t\t\t\t\tcString += '<pDif>100.00</pDif>'\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .And. aICMS[03] == \"2\"\r\n\t\t\t\t\tcString += '<vICMSOp>0</vICMSOp>'\r\n\t\t\t\t\tcString += '<pDif>100.00</pDif>'\r\n\t\t\t\t\tcString += '<vICMSDif>0</vICMSDif>'\r\n\t\t\t\tEndIf\t\r\n\t\t\t\tcString += '<valor>0</valor>'\t\t\t\t\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t\tIf cVerAmb >= \"3.10\" .and. aCST[1] $ '51' .and. !Empty(aICMS[12]) .and. !lArt186\r\n\r\n\t\t\t\t\t// Foi retirado o tratamento feito para o diferimento = 3. Pois, apos atualizacao do fiscal, o valor do diferimento e gravado em um campo sem necessidade de fazer calculo\r\n\r\n\t\t\t\t\t/*If\taICMS[14] == \"3\"\t\r\n\t\t\t\t\t\tcString += NfeTag('<vICMSOp>' ,ConvType(iIf(lIcmDevol,aICMS[07],0)+aICMS[12],15,2))\r\n\t\t\t\t  \t\tcString += NfeTag('<pDif>' ,ConvType(aICMS[12]/( aICMS[12]+iIf(lIcmDevol,aICMS[07],0))*100,8,4))\r\n\t\t\t\t  \t\tcString += NfeTag('<vICMSDif>' ,ConvType(aICMS[12],15,2))\r\n\t\t\t\t  \t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,(aICMS[07]+aICMS[12])-aICMS[12],0),15,2)+'</valor>'\r\n\t\t\t\t\tElse*/\r\n\t\t\t\t\t\r\n\t\t\t\t\tcString += NfeTag('<vICMSOp>' ,ConvType(iIf(lIcmDevol,aICMS[07],0),15,2))\r\n\t\t\t\t\t//cString += NfeTag('<pDif>' ,ConvType(aICMS[12]/iIf(lIcmDevol,aICMS[07],0)*100,8,4))\r\n\t\t\t\t\tcString += NfeTag('<pDif>' ,ConvType(aICMS[19],8,4))\r\n\t\t\t\t\tcString += NfeTag('<vICMSDif>' ,ConvType(aICMS[12],15,2))\r\n\t\t\t\t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,aICMS[07]-aICMS[12],0),15,2)+'</valor>'\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t//EndIf\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tnVIcmDif += iIf(lIcmDevol,aICMS[07]-aICMS[12],0)\r\n\t\t\t\t\t/*Na versão 3.10, para CST=51, O Valor do ICMS(vICMS) deve ser a diferença do Valor do ICMS da Operação (vICMSOp) e o Valor do ICMS diferido (vICMSDif),\r\n\t\t\t\t\tpara não apresentar a rejeição 353-Valor do ICMS no CST=51 não corresponde a diferença do ICMS operação e ICMS diferido*/\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. aCST[1] $ '51' .and. Empty(aICMS[12]) .and. Empty(aICMS[07])\r\n\t\t\t\t\tcString += '<vICMSOp>0</vICMSOp>'\r\n\t\t\t\t\tcString += '<pDif>100.00</pDif>'\r\n\t\t\t\t\tcString += '<vICMSDif>0</vICMSDif>'\r\n\t\t\t\t\tcString += '<valor>0</valor>'\r\n\t\t\t\t\tnVIcmDif += 0\r\n\t\t\t\t//Regra para quando não tiver icms diferido com CST=51 (F4_icmsdif = 2 e F4_picmdif = 0) \r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. aCST[1] $ '51' .and. Empty(aICMS[12]) .and. !Empty(aICMS[07])\r\n\t\t\t\t\tcString += NfeTag('<vICMSOp>' ,ConvType(iIf(lIcmDevol,aICMS[07],0),15,2))\r\n\t\t\t\t\tcString += '<pDif>0</pDif>'\r\n\t\t\t\t\tcString += '<vICMSDif>0</vICMSDif>'\r\n\t\t\t\t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,aICMS[07]-aICMS[12],0),15,2)+'</valor>' \r\n\t\t\t\t\tnVIcmDif += 0\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '40') .and. alltrim(aICMS[11]) == \"8\" // F4_MOTICMS = 8=Venda Orgao Publico\r\n\t\t\t\t\tcString += '<valor>'+ConvType(aICMS[15],15,2)+'</valor>'\r\n\t\t\t\tElseIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '40') .and. (alltrim(aICMS[11]) == \"9\" .or. alltrim(aICMS[11]) == \"90\") // F4_MOTICMS = 9=Outros. (NT 2011/004)ou 90=Solicitado pelo Fisco.\r\n\t\t\t\t\tIf aICMS[15] > 0\r\n\t\t\t\t\t   cString += '<valor>'+ConvType(aICMS[15],15,2)+'</valor>'\r\n\t\t\t\t\tElse\t\t\t\t\r\n\t\t\t\t\t\tcString += '<valor>'+ConvType(aICMS[07],15,2)+'</valor>'\t\t\r\n\t\t\t\t   EndIf\r\n\t\t\t\tElse\t\t\t\t\r\n\t\t\t\t\tcString += '<valor>'+ConvType(iIf(lIcmDevol,aICMS[07],0),15,2)+'</valor>'\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\tif !empty(cMotDesICMS)\r\n\t\t\t\t\tif  aICMS[15] >\t0 \r\n\t\t\t\t\t\tnDesonICM := ConvType(aICMS[15],15,2)\r\n\t\t\t\t\t\tnVicmsDeson += iIf(lIcmDevol,aICMS[15],0)\r\n\t\t\t\t\tElseiF Len(aICMSZFM)>0 .And. aCST[1] $ '40|41|50'\r\n\t\t\t\t\t\tnDesonICM := ConvType(aICMSZFM[3],15,2)\t\t\t\t\t\t\r\n\t\t\t\t\t\tnVicmsDeson += iIf(lIcmDevol,aICMSZFM[3],0)\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tnDesonICM :=   ConvType(aICMS[07],15,2)\t\t\t\t\t\r\n\t\t\t\t\t\tnVicmsDeson += iIf(lIcmDevol,aICMS[07],0)\r\n\t\t\t\t\tendif\r\n\t\t\t\tendif\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '20,70,90') .and. !Empty(aICMS[11])\r\n\t\t\t\tcString += NfeTag('<motDesICMS>' ,ConvType(aICMS[11]))\r\n\t\t\t\tIf aICMS[04] == 100 .And. aICMS[02] == \"20\"\r\n\t\t\t\t\tcString += NfeTag('<vICMSDeson>' ,ConvType(0,15,2))\r\n\t\t\t\t\tnVicmsDeson += 0\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += '<vICMSDeson>'+ConvType(iIf(lIcmDevol,aICMS[15],0),15,2)+'</vICMSDeson>'\r\n\t\t\t\t\tnVicmsDeson\t+= IIf(lIcmDevol,aICMS[15],0)\r\n\r\n\t\t\t\t\tIf(aCST[1] $ '20') .And. !empty(aICMS[11])\r\n\t\t\t\t\t\tcMotDesICMS := ConvType(aICMS[11])\r\n\t\t\t\t\t\tnDesonICM := ConvType(aICMS[15],15,2)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tEndif\t\t\t\t\t\t\t\r\n\t\t\tElseIf cVerAmb >= \"3.10\" .and. (aCST[1] $ '40') .and. alltrim(aICMS[11]) == \"8\" // F4_MOTICMS = 8=Venda Orgao Publico \r\n\t\t\t\tcString\t\t+= NfeTag('<vICMSDeson>',ConvType(aICMS[15],15,2))\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf (aCST[1] $ '10' .and. (IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\") .and. !Empty(aICMS[12]));\r\n\t\t\t\t.Or. (aICMS[12] > 0 .And. aDest[9] == 'RS' .And. SM0->M0_ESTENT == 'RS' .And. aCST[1] $ '51' .And. aICMS[19] > 12)\r\n\t\t\t\tnIcmsDif\t+= aICMS[12]\r\n\t\t\t\tnPIcmsDif\t:= aICMS[19]\r\n\t\t\tEndIf\r\n\r\n\t\t\tcString += '<qtrib>'+ConvType(aICMS[09],16,4)+'</qtrib>'\r\n\t\t\tcString += '<vltrib>'+ConvType(aICMS[10],15,4)+'</vltrib>'\t\r\n\t\t\t//Criação de campos relativos ao FCP (Fundo de Combate à Pobreza) para operações internas ou interestaduais com ST.\r\n\t\t\tIF cVeramb >= \"4.00\" .and. aCST[1] $'00,10,20,41,51,70,90' \r\n\t\t\t   IF  aCST[1] <> '00'\r\n\t\t\t\t\tcString += '<vBCFCP>'+ConvType(aICMS[16],15,2)+'</vBCFCP>'\r\n\t\t\t\tEndIf\r\n\t\t\t\tcString += '<pFCP>'+ConvType(aICMS[17],5,2)+'</pFCP>'\r\n\t\t\t\tcString += '<vFCP>'+ConvType(aICMS[18],15,2)+'</vFCP>'\t\r\n\t\t\tEndIf\t\r\n\t\t\tcString += '</Tributo>'\r\n\t\tElse\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>'\t\r\n\t\t\tcString += '<modBC>'+ConvType(3)+'</modBC>'\r\n\t\t\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\"\r\n\t\t\t\tIf !Empty(aAdi[14][03])\r\n\t\t\t\t\tcString += '<pRedBC>'+ConvType(aAdi[14][03],7,4)+'</pRedBC>'\r\n\t\t\t    Else\r\n\t\t\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\t\t\tEndIf\r\n\t\t\tElseif aProd[23]==\"20\" .And. aProd[22]>0\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aProd[22],7,4)+'</pRedBC>'\r\n\t\t\tElseif allTrim(aCST[01]) $ \"51,70,90\"\r\n\t\t\t\tcString += '<pRedBC>'+ConvType(aProd[22],7,4)+'</pRedBC>'\r\n\t\t\tEndif\t\r\n\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\t\t\r\n\t\t\tIf Len(aICMSZFM)>0 .And. aCST[1] $ '40|41|50'\r\n\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMSZFM[02])+'</motDesICMS>'  \t\t\t\r\n\t\t\t\tnValDeson := aICMSZFM[01]-aProd[31]-aProd[32]\r\n\t\t\t\tnVicmsDeson += nValDeson\r\n\t\t\t\tcString += '<valor>'+ConvType(nValDeson,15,4)+'</valor>'\t\t\t\t\r\n\t\t\tElse\r\n\t\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\t\tEndIf\t\r\n\r\n\t\t\tcString += '<qtrib>'+ConvType(0,16,4)+'</qtrib>'\r\n\t\t\tcString += '<vltrib>'+ConvType(0,15,4)+'</vltrib>'\r\n\t\t\tcString += '</Tributo>'\r\n\t\tEndIf\r\n\t\tcString += '</imposto>'\r\n\tEndif\r\n\r\n\tIf Len(aComb) > 0 .And. cVeramb >= \"4.00\" .and. aCST[1] $ \"60\" .And. aComb[01] $ NfeProdANP()\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSST'+ aCST[1] + '</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<orig>'+ConvType(aCST[02])+'</orig>'\r\n\t\tcString += '</cpl>'\t\t\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>'      \r\n\t\t\r\n\t\tIf Empty(cUltAqui)\r\n\t\t\tSPEDRastro2(aProd[20],aProd[19],aProd[02],@nBaseIcm,@nValICM,,,,,,,,,,,,,,,@nBfcpant,@nAfcpant,@nVfcpant)             \r\n\t\tEndIf\r\n\t\t\r\n\t\tif lRetEfet\r\n\r\n\t\t\tIf aComb[19] > 0\t\r\n\t\t\t\tcString += '<vBCSTRet>'+ConvType(aComb[19],15,2)+'</vBCSTRet>' \r\n\t\t\t\tcString += '<vICMSSTRet>'+ConvType(aComb[20],15,2)+'</vICMSSTRet>'\r\n\t\t\t\tnAlqICM := aComb[23]\r\n\t\t\tElseIf nBaseIcm > 0\r\n\t\t\t\tcString += '<vBCSTRet>'+ConvType(nBaseIcm,15,2)+'</vBCSTRet>' \r\n\t\t\t\tcString += '<vICMSSTRet>'+ConvType(nValICM,15,2)+'</vICMSSTRet>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<vBCSTRet>'+ConvType(0,15,2)+'</vBCSTRet>'\r\n\t\t\t\tcString += '<vICMSSTRet>'+ConvType(0,15,2)+'</vICMSSTRet>'\r\n\t\t\tEndif\t\t\r\n\t\t\r\n\t\t\tIf lTagProduc \r\n\t\t\t\t//cString += '<pST>'+ConvType(aICMS[6]+ aICMS[17],5,2)+'</pST>'\r\n\t\t\t\tcString += '<pST>'+ConvType((nAlqICM),5,2)+'</pST>'\r\n\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\tEndif\r\n\r\n\t\t\tcString += '<vBCFCPSTRet>'+ConvType(nBfcpant,15,2)+'</vBCFCPSTRet>'\r\n\t\t\tcString += '<pFCPSTRet>'+ConvType(nAfcpant,5,2)+'</pFCPSTRet>'\r\n\t\t\tcString += '<vFCPSTRet>'+ConvType(nVfcpant,15,2)+'</vFCPSTRet>'\r\n\t\tendif\t\r\n\t\t\r\n\t\t//Tratamento implementado para atender o DECRETO Nº 54.308, DE 6 DE NOVEMBRO DE 2018. (publicado no DOE n.º 212, de 7 de novembro de 2018)\t\r\n\t\t\t\r\n\t\tIf cIndFinal == \"1\"\t.and. Len(aIcms)>0\t\t\t\t\t\t \r\n\t\t\tcString += '<pRedBCEfet>'+ConvType(aICMS[4],8,4)+'</pRedBCEfet>'\r\n\t\t\tcString += '<vBCEfet>'+ConvType( aICMS[5] ,16,2)+'</vBCEfet>'\r\n\t\t\tcString += '<pICMSEfet>'+ConvType(aICMS[6],8,4)+'</pICMSEfet>'\r\n\t\t\tcString += '<vICMSEfet>'+ConvType(aICMS[7],16,2)+'</vICMSEfet>'\r\n\t\tEndif\r\n\t\t\r\n\t\tcString += '<vBCSTDest>'+ConvType(aComb[21],15,2)+'</vBCSTDest>' \t   \t\r\n\t\tcString += '<vICMSSTDest>'+ConvType(aComb[22],15,2)+'</vICMSSTDest>'\r\n\t\t\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\tEndIf\t\r\n\t\r\n\tIf Len(aIcmsST)>0\t\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSST</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],8,4)+'</pmvast>'\r\n\t\tElse\r\n\t\t\tcString += '<pmvast>'+ConvType(aICMSST[08],6,2)+'</pmvast>'\r\n\t\tEndIf\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aICMSST[02])+'</CST>'\t\r\n\t\tcString += '<modBC>'+ConvType(aICMSST[03])+'</modBC>'\r\n\t\tcString += '<pRedBC>'+ConvType(aICMSST[04],7,4)+'</pRedBC>'\r\n\t\tcString += '<vBC>'+ConvType(aICMSST[05],15,2)+'</vBC>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMSST[06],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(aICMSST[06],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tIf Len(aICMSZFM)>0 .And. aCST[1] $ '30-40'\r\n\t\t\tif !empty( aICMSZFM[02] )\r\n\t\t\t\tcString += NfeTag('<motDesICMS>' ,ConvType(aICMSZFM[02]))\r\n\t\t\t\tcString\t+= \"<vICMSDeson>\" + ConvType(aICMSZFM[3],15,2) + \"</vICMSDeson>\"\r\n\t\t\tendif\t\r\n\t\t\tnVicmsDeson\t+= IIf(lIcmDevol,aICMSZFM[3],0)\r\n\t\tElse\r\n\t\t\tif !empty( aICMSST[17] )\r\n\t\t\t\tcString += '<motDesICMS>'+ConvType(aICMSST[17])+'</motDesICMS>'\r\n\t\t\t\tcString\t+= \"<vICMSDeson>\" + ConvType(aICMSST[12],15,2) + \"</vICMSDeson>\"\r\n\t\t\tendif\r\n\t\t\tcMotDesICMS:= ConvType(aICMSST[17])\r\n\t\tEndIf\r\n\t\tcString += '<valor>'+ConvType(aICMSST[07],15,2)+'</valor>'\r\n\t\tcString += '<qtrib>'+ConvType(aICMSST[09],16,4)+'</qtrib>'\r\n\t\tcString += '<vltrib>'+ConvType(aICMSST[10],15,4)+'</vltrib>'\r\n\t\t\r\n\t\tIf cVeramb >= \"4.00\" .and. aCST[1] =='60' \r\n\t\t\tif lRetEfet\r\n\t\t\t\tcString += '<pST>'+ConvType((aICMSST[06]+aICMSST[14]),5,2)+'</pST>'\r\n\t\t\t\tIf lTagProduc \r\n\t\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\t\tEndif\r\n\t\t\tendif\t\r\n\t\tEndIf\r\n\t\r\n\t\t//Criação de campos relativos ao FCP (Fundo de Combate à Pobreza) para operações internas ou interestaduais com ST.\r\n\t\tIF cVeramb >= \"4.00\" .and. aCST[1] $'10,30,70,90' //.and. !Empty(aICMS[13])\r\n\t\t\t\tcString += '<vBCFCPST>'+ConvType(aICMSST[13],15,2)+'</vBCFCPST>'\r\n\t\t\t\tcString += '<pFCPST>'+ConvType(aICMSST[14],5,2)+'</pFCPST>'\r\n\t\t\t\tcString += '<vFCPST>'+ConvType(aICMSST[15],15,2)+'</vFCPST>'\t\r\n\t\tEndIf\t\r\n\t\t\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\t\t\r\n\tELse\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ICMSST</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<pmvast>0</pmvast>'\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(aCST[01])+'</CST>'          \r\n\t\tIf (aCST[01] = \"60\" .or. cCsosn$ \"500\")\t\t\r\n\t\t\t//Se o parâmetro  MV_ULTAQUI que trata a última aquisição não estiver preenchido usa o modelo antigo de rastro.\r\n\t\t\tIf Empty(cUltAqui) \r\n\t\t\t\tSPEDRastro2(aProd[20],aProd[19],aProd[02],@nBaseIcm,@nValICM,,,lCalcMed,@nAlqICM,,,,,,,,,,,@nBfcpant,@nAfcpant,@nVfcpant)\r\n\t\t\t\t\r\n\t\t\t\tIf nBaseIcm > 0 .and. nValICM>0\r\n\t\t\t\t\tnBaseIcm := aProd[09]*nBaseIcm\r\n\t\t\t\t\tnValICM  := aProd[09]*nValICM\r\n\t\t\t    EndIf\r\n\t\t\t     //Multiplica o valor facp anterior pela quantidade de item.\r\n\t\t\t    If\tnBfcpant > 0 .and. nVfcpant>0\r\n\t\t\t     \tnBfcpant  := aProd[09]*nBfcpant\r\n\t\t\t     \tnVfcpant  := aProd[09]*nVfcpant\r\n\t\t\t    EndIf\r\n\t\t\tendif\r\n\t\t\t\t\r\n\t\t\tIf nBaseIcm > 0 .and. nValICM > 0\t.and. nAlqICM > 0\r\n\t\t   \t\tIf Len(cMensFis) > 0 .And. SubStr(cMensFis, Len(cMensFis), 1) <> \" \"\r\n\t\t\t\t\tcMensFis += \" \"\r\n\t\t\t\tEndIf\r\n\t\t\t    If cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SP\"\r\n\t\t\t\t\t// cMensFis += \"Imposto Recolhido por Substituição - Artigo 274 do RICMS (Lei 6.374/89, art.67,Paragrafo 1o., e Ajuste SINIEF-4/93',cláusa terceira, na redação do Ajuste SINIEF-1/94) 'Cod.Produto:  \" +ConvType(aProd[02])+\" ' Valor da Base de ST: R$ \" +str(nBaseIcm,15,2)+\" Valor de ICMS ST: R$ \"+str(nValICM,15,2)+\" \"\r\n\t\t\t\t\tif Empty(At(\"Artigo 274 do RICMS\", cMensFis))\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Artigo 274 do RICMS (Lei 6.374/89, art.67,Paragrafo 1o., e Ajuste SINIEF-4/93',cláusa terceira, na redação do Ajuste SINIEF-1/94) &|\"+ConvType(aProd[02])+\"|\"+AllTrim(str(nValICM,15,2))+\"|&\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcMensFis := AllTrim(cMensFis) + \"|\"+ConvType(aProd[02])+\"|\"+AllTrim(str(nValICM,15,2))+\"|&\"\r\n\t\t\t\t\tendif\r\n\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"PR\"  \r\n\t\t\t\t\tif SF4->F4_CODIGO > \"500\"  /* TES de Saída */  \r\n\t\t\t\t\t\t//Decreto 6080/2012 com o Regulamento do ICMS está revogado\r\n\t\t\t\t\t\tcMensFis += \" Imposto Recolhido por Substituição - ART. 5º, II , ANEXO IX ,DO RICMS/PR DECRETO 7871/2017 - DOE PR de 02.10.2017, onde o 'Cod.Produto:  \" +ConvType(aProd[02])+\" '  Valor da Base de ST: R$ \" +Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\telse //entrada\r\n\t\t\t\t\t\tcMensFis += \" Imposto Recolhido por Substituição - ART. 5º, I  , ANEXO IX ,DO RICMS/PR DECRETO 7871/2017 - DOE PR de 02.10.2017, onde o 'Cod.Produto:  \" +ConvType(aProd[02])+\" '  Valor da Base de ST: R$ \" +Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\tendif\r\n\t\t\t\t\t/* Conforme consulta realizado no chamado TIBIKO\r\n\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Artigo 471 do RICMS (Parágrafo 1o, alínea B, inciso II, onde o 'Cod.Produto:  \" +ConvType(aProd[02])+\" ' Valor da Base de ST: R$ \" +str(nBaseIcm,15,2)+\" Valor de ICMS ST: R$ \"+str(nValICM,15,2)+\" \"\r\n\t\t\t\t\t*/\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SC\"  \r\n\t\t\t\t\tlPesFisica := IIF(SA1->A1_PESSOA==\"F\",.T.,.F.)\r\n\t\t\t\t\tlNContrICM := IIf(Empty(SA1->A1_INSCR) .Or. \"ISENT\"$SA1->A1_INSCR .Or. \"RG\"$SA1->A1_INSCR .Or. ( SA1->(FieldPos(\"A1_CONTRIB\"))>0 .And. SA1->A1_CONTRIB == \"2\"),.T.,.F.)\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf !lPesFisica .And. !lNContrICM \r\n\t\t\t\t\t\tcMensFis += \"Imposto Retido por Substituição Tributária - RICMS-SC/01 - Anexo 3. 'Cod.Produto: \" +ConvType(aProd[02])+\" '  Valor da Base de ST: R$ \" +str(nBaseIcm,15,2)+\"  Valor de ICMS ST: R$ \"+str(nValICM,15,2)+\" \"\r\n\t\t\t\t\tEndIf\t \t\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"AM\"\r\n\t\t\t\t \tlNContrICM := IIf(Empty(SA1->A1_INSCR) .Or. \"ISENT\"$SA1->A1_INSCR .Or. \"RG\"$SA1->A1_INSCR .Or. ( SA1->(FieldPos(\"A1_CONTRIB\"))>0 .And. SA1->A1_CONTRIB == \"2\"),.T.,.F.)\r\n\t\t\t\t \t\r\n\t\t\t\t \tIf (lNContrICM .And. SA1->A1_EST <> \"AM\") .Or. SA1->A1_EST == \"AM\"  //Conforme consulta (TGVUIP).\r\n\t\t\t\t \t\tcMensFis += \"Mercadoria já tributada nas demais fases de comercialização - Convênio ou Protocolo ICMS nº \"+Alltrim(aProd[28])+ \". Cod.Produto: \" +ConvType(aProd[02])+\".\"\r\n\t\t\t\t \tEndIf\r\n\t\t\t\t\r\n\t\t\t\tElseIF cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"RS\"\t\t\t \r\n\t\t\t\t \tif !Empty(aProd[28])\t\t\t\t \t\r\n\t\t\t\t \t\tcMensFis += \"Imposto recolhido por ST nos termos do (Convênio ou Protocolo ICMS nº \"+ Alltrim(aProd[28]) +\") RICMS-RS. Valor da Base de ICMS ST R$\"+ cValToChar(nBaseIcm) +\" e valor do ICMS ST R$ \"+ cValToChar(nValICM) +\". Cod.Produto: \" +ConvType(aProd[02])+\".\" \r\n\t\t\t\t \telse\r\n\t\t\t\t \t\tcMensFis += \"Imposto recolhido por ST nos termos do RICMS-RS. Valor da Base de ICMS ST R$\"+ cValToChar(nBaseIcm) +\" e Valor do ICMS ST R$\"+ cValToChar(nValICM) +\". Cod.Produto: \" +ConvType(aProd[02])+\".\"\r\n\t\t\t\t \tendIf\t\t\t\t\t \t\r\n\t\t\t\tElseIf cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"ES\" .And. Len(aICMS) > 0 .And. ( nBaseIcm+nValICM > 0 )\r\n\t\t\t\t\t\r\n\t\t\t\t\tnValIcmDif := ( (nBaseIcm *  17 )/ 100 ) -  aIcms[7]\r\n\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição RICMS. Cod.Produto:  \" +ConvType(aProd[02])+\" Base de cálculo da retenção - R$ \" + Alltrim(str(nBaseIcm,15,2))+\". \" \r\n\t\t\t\t\tcMensFis += \"ICMS da operação própria do contribuinte substituto - R$ \"+Alltrim(str(aIcms[7],15,2))+\". \"\r\n\t\t\t\t\tcMensFis += \"ICMS retido pelo contribuinte substituto - R$ \" +Alltrim(str(nValIcmDif,15,2))+\". \"\r\n\t\t\t\tElseIf cArt274 == \"1\"  .And. IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"MG\" .And. Len(aICMS) > 0 .And. ( nBaseIcm+nValICM > 0 )  // Conforme Chamado TIABCS\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Empty(cUltAqui)\r\n\t\t\t\t\t\tnVICPRST := ( (nBaseIcm * 18 )/ 100 ) - aIcms[7]\r\n\t\t\t\t\tEndif\r\n\t\t\t\t\t\r\n\t\t\t\t\taTotICMSST[1] += nBaseIcm\r\n\t\t\t\t\taTotICMSST[2] += nValICM\r\n\t\t\t\t\taTotICMSST[3] += nVICPRST\r\n\r\n\t\t\t\t\tIf nTotProd == nItProd\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - ICMS retido pelo cliente S.T. DECRETO 43708 19/12/2009.\"\r\n\t\t\t\t\t\tcMensFis += \" Valor da Base de ST: R$ \"+Alltrim(str(aTotICMSST[1],15,2))+\".\"\r\n\t\t\t\t\t\tcMensFis += \" Valor de ICMS ST: R$ \"+Alltrim(str(aTotICMSST[2],15,2))+\".\"\r\n\t\t\t\t\t\tcMensFis += \" Valor de ICMS: R$\"+Alltrim(str(aTotICMSST[3],15,2))+\".\"\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tElseIf IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SP\" \r\n\t\t\t\t\tIf cIndFinal == \"1\"\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Contempla o artigo 313-Z19 do RICMS-SP.\"\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t//Artigo somente para o estado de SP - DSERTSS1-6532\r\n\t\t\t\t\t\t//http://tdn.totvs.com.br/pages/releaseview.action?pageId=267795989\r\n\t\t\t\t\t\tcMensFis += \"Imposto Recolhido por Substituição - Contempla os artigos 273, 313 do RICMS. Valor da Base de ST: R$ \"+Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\tElseIf IIF(!lEndFis,ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"RJ\"\r\n\t\t\t\t\tif aComb[01] $ NfeProdANP()\r\n\t\t\t\t\t\t//http://jiraproducao.totvs.com.br/browse/DSERTSS1-11434\r\n\t\t\t\t\t\tcMensFis += \"ICMS a ser repassado nos termos do Capítulo V do Convênio ICMS 110/07. Valor da Base de ST: R$ \"+Alltrim(str(nBaseIcm,15,2))+\" Valor de ICMS ST: R$ \"+Alltrim(str(nValICM,15,2))+\" \"\r\n\t\t\t\t\telseif cArt274 == \"1\"\r\n\t\t\t\t\t\tcMensFis += \"ICMS RECOLHIDO ANTECIPADO POR SUBS. TRIBUTARIA CONF. INC. II ART 27 DO LIVRO II, E ITEM 23 DO ANEXO I DO LIVRO II DO RICMS\"\t\r\n\t\t\t\t\tendif\r\n\t\t\t\tEndIf\r\n\t        \r\n\t        \r\n\t        EndIf\r\n\t        \r\n\t   \t\tcString += '<modBC>0</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\tElse\r\n\t\t\tcString += '<modBC>0</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\t\r\n\t\tEndif\r\n\t\tIf nBaseIcm > 0\r\n\t\t\tcString += '<vBC>'+ConvType(nBaseIcm,15,2)+'</vBC>' \r\n\t\tElse\r\n\t\t\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\t\tEndif\r\n\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\tIf nValICM > 0\r\n\t\t\tcString += '<valor>'+ConvType(nValICM,15,2)+'</valor>'\r\n\t\tElse\r\n\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\tEndif   \r\n\t\r\n\t\tcString += '<qtrib>'+ConvType(0,16,4)+'</qtrib>'\r\n\t\tcString += '<vltrib>'+ConvType(0,15,4)+'</vltrib>'\r\n\t\t\r\n\t\tIf cVeramb >= \"4.00\" .and. aCST[1] =='60'\r\n\t\t\t\r\n\t\t\tif lRetEfet\r\n\t\t\t\tcString += '<pST>'+ConvType((nAlqICM),5,2)+'</pST>'\r\n\t\t\t\t//cString += '<pST>'+ConvType(aICMS[6]+ aICMS[17],5,2)+'</pST>'\r\n\t\t\t\tIf lTagProduc \r\n\t\t\t\t\tcString += '<vICMSSubstituto>'+ConvType(nVICPRST,15,2)+'</vICMSSubstituto>'\r\n\t\t\t\tEndif\r\n\t\t\t\t//Tratamento implementado para atender o DECRETO Nº 54.308, DE 6 DE NOVEMBRO DE 2018. (publicado no DOE n.º 212, de 7 de novembro de 2018)\t\r\n\t\t\t\tcString += '<vBCFCPSTRet>'+ConvType(nBfcpant,15,2)+'</vBCFCPSTRet>'\r\n\t\t\t\tcString += '<pFCPSTRet>'+ConvType(nAfcpant,5,2)+'</pFCPSTRet>'\r\n\t\t\t\tcString += '<vFCPSTRet>'+ConvType(nVfcpant,15,2)+'</vFCPSTRet>'\r\n\t\t\tendif\t\r\n\t\t\t\r\n\t\t\tIf cIndFinal == \"1\"\t.and. Len(aIcms)>0\t\t\t\t \r\n\t\t\t\tcString += '<pRedBCEfet>'+ConvType(aICMS[4],8,4)+'</pRedBCEfet>'\r\n\t\t\t\tcString += '<vBCEfet>'+ConvType( aICMS[5] ,16,2)+'</vBCEfet>'\r\n\t\t\t\tcString += '<pICMSEfet>'+ConvType(aICMS[6],8,4)+'</pICMSEfet>'\r\n\t\t\t\tcString += '<vICMSEfet>'+ConvType(aICMS[7],16,2)+'</vICMSEfet>'\r\n\t\t\tEndif\r\n\t\tEndif\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\t\t\r\n\t\t\t\r\n\tEndIf\r\n\t\r\n\t//A sefaz nao permite referenciar nota de difal antes de 2016 da a Rejeiçao 699  \r\n\tIf len(aItemVinc) > 0 \r\n\t\tlDateRefNf := FsDateConv(aItemVinc[01],\"YYYY\") >= \"2016\" \r\n\tElse \r\n\t\tlDateRefNf := .T.\t\t  \t\t\t\r\n\tEndif\r\n\t\r\n\tIf (cIdDest == \"2\" .and. cIndFinal == \"1\" .and. cIndIEDest == \"9\") .and. (Len(aISSQN)== 0) .and. ;\r\n\t   (cAmbiente == \"2\" .or. (cAmbiente == \"1\" .and. FsDateConv(aNota[03],\"YYYY\") >= \"2016\" .and. lDateRefNf)) .and. ;\r\n\t   (iif(Len(aComb) > 0 .And. !Empty(aComb[01]),aComb[01] $ NfeCodANP(),.T.))\r\n\t\t\r\n\t\tIf Len(aICMUFDest) > 0 .And. !(aNota[04] == \"0\" .and. aNota[5] == \"N\" .And. aICMUFDest[05] == 0)\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>ICMSUFDest</codigo>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<VBC>'+ConvType(aICMUFDest[01],15,2)+'</VBC>' //vBCUFDest\r\n\t\t\tIF cVeramb >= \"4.00\"\r\n\t\t\t\tcString += '<vBCFCPUFDest>'+ConvType(aICMUFDest[01],15,2)+'</vBCFCPUFDest>' //vBCFCPUFDest\r\n\t\t\tEndif\r\n\t\t\tcString += '<pFCPUF>'+ConvType(aICMUFDest[02],7,4)+'</pFCPUF>' //pFCPUFDest\r\n\t\t\tcString += '<Aliquota>'+ConvType(aICMUFDest[03],7,4)+'</Aliquota>' //pICMSUFDest\r\n\t\t\tcString += '<AliquotaInter>'+ConvType(aICMUFDest[04],6,2)+'</AliquotaInter>' //pICMSInter\r\n\t\t\tcString += '<pICMSInter>'+ConvType(aICMUFDest[05],8,4)+'</pICMSInter>'//pICMSInterPart\r\n\t\t\tcString += '<ValorFCP>'+ConvType(aICMUFDest[06],15,2)+'</ValorFCP>' //vFCPUFDest\r\n\t\t\tcString += '<ValorICMSDes>'+ConvType(aICMUFDest[07],15,2)+'</ValorICMSDes>' //vICMSUFDest\r\n\t\t\tcString += '<ValorICMSRem>'+ConvType(aICMUFDest[08],15,2)+'</ValorICMSRem>' //vICMSUFRemet\r\n\t\t\tcString += '</Tributo>'\r\n\t\t\tcString += '</imposto>'\r\n\r\n\t\t\tnvBCUFDest    += aICMUFDest[01]\r\n\t\t\tnpFCPUFDest   := aICMUFDest[02]\r\n\t\t\tnpICMSUFDest  := aICMUFDest[03]\t\t\r\n\t\t\tnpICMSIntP    := aICMUFDest[05]\r\n\t\t\tnvFCPUFDest   += aICMUFDest[06]\r\n\t\t\tnvICMSUFDest  += aICMUFDest[07]\r\n\t\t\tnvICMSUFRemet += aICMUFDest[08]\r\n\r\n\t\t\t// <AliquotaInter> padrão 4,7 ou 12. Em caso de pedido com produtos com aliquotas diferentes, as alíquotas serão separadas em vírgula para exibição. (Ex.: 4.00%, 7.00%)\r\n\t\t\tIf (aICMUFDest[04] == 4 .or. aICMUFDest[04] == 7 .or. aICMUFDest[04] == 12) .and. !ConvType(aICMUFDest[04])$cMensDifal\r\n\t\t\t\tIif (empty(cMensDifal),cMensDifal += ConvType(aICMUFDest[04],6,2)+'%',cMensDifal += ', '+ ConvType(aICMUFDest[04],6,2)+'%')\t\r\n\t\t\tEndif\r\n\t\t\t\r\n\t\tElseif Len(aICMUFDest) == 0\r\n\t\t\t\r\n\t\t\t/*Para os casos em que não há calculo de Difal na CD2( ICMS Isento), o grupo ICMSUFDEST deve ser gerado com valores zerados, para\r\n\t\t\tnão apresentar a rejeição 694: Não informado o grupo de ICMS para a UF de destino [nItem:999].\r\n\t\t\tApenas as tags pICMSUInter e pICMSInterPart devem ser geradas com valores para não apresentar erro de schema\r\n\t\t\tTAG pICMSInter - SD2_PICM\r\n\t\t\tTAG pICMSInterPart - MV_PPDIFAL\r\n\t\t\t*/\r\n\t\t\tIf (valType(aPPDifal)== \"A\" .and. Len(aPPDifal)>0 .and. Year(aNota[03]) >= aPPDifal[1][1])\r\n\t\t\t\r\n\t\t\t\tnUltimo := Len(aPPDifal)\r\n\t\t\r\n\t\t\t\tIF !Empty(aItemVinc) .and. (nPos := aScan(aPPDifal,{|x| x[1]== Year(aItemVinc[01])})) > 0 // Verifica o ano da nota vinculada para pegar a aliquota do parâmetro\r\n\t\t\t\t\taPICMSInter:= aPPDifal[nPos][2]\r\n\t\t\t\tElseIf (nPos := aScan(aPPDifal,{|x| x[1]== Year(aNota[03])})) > 0\r\n\t\t\t\t\taPICMSInter:= aPPDifal[nPos][2]\t\t\t\t\r\n\t\t\t\tElseIf Year(aNota[03] ) > aPPDifal[nUltimo][1]\t\t\r\n\t\t\t\t\taPICMSInter:= aPPDifal[nUltimo][2]\t\t\t\t\r\n\t\t\t\tEndif\r\n\t\t\t\r\n\t\t\t\tIf Alltrim(Str(aProd[33])) == \"4\" .Or. Alltrim(Str(aProd[33])) == \"7\" .Or. Alltrim(Str(aProd[33])) == \"12\"\r\n\t\t\t\t\tcString += '<imposto>'\r\n\t\t\t\t\tcString += '<codigo>ICMSUFDest</codigo>'\r\n\t\t\t\t\tcString += '<Tributo>'\r\n\t\t\t\t\tcString += '<VBC>'+ConvType(0,15,2)+'</VBC>' //vBCUFDest\r\n\t\t\t\t\tcString += '<vBCFCPUFDest>'+ConvType(0,15,2)+'</vBCFCPUFDest>' //vBCFCPUFDest\r\n\t\t\t\t\tcString += '<pFCPUF>'+ConvType(0,7,4)+'</pFCPUF>' //pFCPUFDest\r\n\t\t\t\t\tcString += '<Aliquota>'+ConvType(0,7,4)+'</Aliquota>' //pICMSUFDest\r\n\t\t\t\t\tcString += '<AliquotaInter>'+ConvType(aProd[33],6,2)+'</AliquotaInter>' //pICMSInter\r\n\t\t\t\t\tcString += '<pICMSInter>'+ConvType(aPICMSInter,8,4)+'</pICMSInter>'//pICMSInterPart\r\n\t\t\t\t\tcString += '<ValorFCP>'+ConvType(0,15,2)+'</ValorFCP>' //vFCPUFDest\r\n\t\t\t\t\tcString += '<ValorICMSDes>'+ConvType(0,15,2)+'</ValorICMSDes>' //vICMSUFDest\r\n\t\t\t\t\tcString += '<ValorICMSRem>'+ConvType(0,15,2)+'</ValorICMSRem>' //vICMSUFRemet\r\n\t\t\t\t\tcString += '</Tributo>'\r\n\t\t\t\t\tcString += '</imposto>'\r\n\t\t\t\t\t\r\n\t\t\t\t\tnvBCUFDest    += 0 \r\n\t\t\t\t\tnpFCPUFDest   += 0\r\n\t\t\t\t\tnpICMSUFDest  += 0\r\n\t\t\t\t\tnpICMSInter   += 0\r\n\t\t\t\t\tnpICMSIntP    += 0\r\n\t\t\t\t\tnvFCPUFDest\t+= 0\r\n\t\t\t\t\tnvICMSUFDest  += 0\r\n\t\t\t\t\tnvICMSUFRemet += 0\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\t\t\r\n\t\tEndIf\r\n\tEndIf\t\t\r\n\t\t\t\t\t\t\t\r\n\tIf Len(aIPI)>0 \r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>IPI</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += NfeTag('<clEnq>',ConvType(AIPI[01]))\r\n\t\tcString += NfeTag('<cSelo>',ConvType(AIPI[02]))\r\n\t\tcString += NfeTag('<qSelo>',ConvType(AIPI[03]))\r\n\t\tcString += NfeTag('<cEnq>' ,ConvType(AIPI[04]))\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(AIPI[05])+'</CST>'\r\n\t\tcString += '<modBC>'+ConvType(AIPI[11])+'</modBC>'\r\n\t\tcString += '<pRedBC>'+ConvType(AIPI[12],7,4)+'</pRedBC>'\r\n\t\tcString += '<vBC>'  +ConvType(AIPI[06],15,2)+'</vBC>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tcString += '<vlTrib>'+ConvType(AIPI[08],15,4)+'</vlTrib>'\r\n\t\tcString += '<qTrib>'+ConvType(AIPI[07],16,4)+'</qTrib>'\r\n\t\tcString += '<valor>'+ConvType(AIPI[10],15,2)+'</valor>'\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\tElseIf Len(aCSTIPI) > 0  .And. !Empty(cIpiCst)\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>IPI</codigo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += NfeTag('<cEnq>' ,aprod[40])\r\n\t\tcString += '</cpl>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<CST>'+ConvType(cIpiCst)+'</CST>'\r\n\t\tcString += '<modBC>'+ConvType(3)+'</modBC>'\r\n\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\tcString += '<vBC>'  +ConvType(0,15,2)+'</vBC>'\r\n\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\t\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '</imposto>'\r\n\tEndIf\r\nElse\r\n\tIf Len(aISSQN)>0 .and. !Empty(aISSQN[01])\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>ISS</codigo>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<vBC>'+ConvType(aISSQN[01],15,2)+'</vBC>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<aliquota>'+ConvType(aISSQN[02],7,4)+'</aliquota>'\r\n\t\tElse\r\n\t\t\tcString += '<aliquota>'+ConvType(aISSQN[02],5,2)+'</aliquota>'\r\n\t\tEndIf\r\n\t\tcString += '<Valor>'+ConvType(aISSQN[03],15,4)+'</Valor>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += NfeTag('<deducao>',ConvType(aISSQN[07],15,2))//SF3->F3_ISSSUB + SF3->F3_ISSMAT\r\n\t\t\tcString += NfeTag('<outro>',ConvType(0,15,2))//atualmente nao existe valor de Outras retencoes \r\n\t\t\tcString += NfeTag('<descIncond>',ConvType(0,15,2))//atualmente nao existe valor de Desconto Incondicionado\r\n\t\t\tcString += NfeTag('<descCond>',ConvType(0,15,2))//atualmente nao existe valor de Desconto condicionado\r\n\t\t\tcString += NfeTag('<Issret>',ConvType(aISSQN[09],15,2))\t\t\t\t\r\n\t\tEndIf\r\n\t\tcString += '</Tributo>'\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<cmunfg>'+ConvType(SM0->M0_CODMUN)+'</cmunfg>'\t\r\n\t\tcString += '<clistserv>'+aISSQN[05]+'</clistserv>'\r\n\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\tcString += '<Indiss>'+aISSQN[08]+'</Indiss>'\r\n\t\t\tcString += NfeTag('<codserv>',ConvType(aProd[34],20))//B1_TRIBMUN\r\n\t\t\tcString += NfeTag('<cmunInc>',ConvType(cMunPres,7))\r\n\t\t\t//cPais Código do País onde o serviço foi prestado\r\n\t\t\t//Tabela do BACEN. Informar somente se o município da prestação do serviço for \"9999999\".\r\n\t\t\tIF cMunPres == \"9999999\"\r\n\t\t\t\tcString += NfeTag('<codpais>',aDest[11])\r\n\t\t\tEndIf\t\r\n\t\t\tcString += NfeTag('<processo>',ConvType(cMVNumProc,30))\r\n\t\t\tcString += '<incentivo>'+ConvType(cMVINCEFIS,1)+'</incentivo>'\r\n\t\tElse\r\n\t\t\tcString += '<cSitTrib>'+ConvType(aISSQN[06])+'</cSitTrib>'\r\n\t\tEndIf\t\t \t\r\n\t\tcString += '</cpl>'\t\t\r\n\t\tcString += '</imposto>'\r\n\tEndIf\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tIf Len(aIPI)>0 \r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>IPI</codigo>'\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += NfeTag('<clEnq>',ConvType(AIPI[01]))\r\n\t\t\tcString += NfeTag('<cSelo>',ConvType(AIPI[02]))\r\n\t\t\tcString += NfeTag('<qSelo>',ConvType(AIPI[03]))\r\n\t\t\tcString += NfeTag('<cEnq>' ,ConvType(AIPI[04]))\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<CST>'+ConvType(AIPI[05])+'</CST>'\r\n\t\t\tcString += '<modBC>'+ConvType(AIPI[11])+'</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(AIPI[12],7,4)+'</pRedBC>'\r\n\t\t\tcString += '<vBC>'  +ConvType(AIPI[06],15,2)+'</vBC>'\r\n\t\t\tIf cVerAmb >= \"3.10\"\r\n\t\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],7,4)+'</aliquota>'\r\n\t\t\tElse\r\n\t\t\t\tcString += '<aliquota>'+ConvType(AIPI[09],5,2)+'</aliquota>'\r\n\t\t\tEndIf\r\n\t\t\tcString += '<vlTrib>'+ConvType(AIPI[08],15,4)+'</vlTrib>'\r\n\t\t\tcString += '<qTrib>'+ConvType(AIPI[07],16,4)+'</qTrib>'\r\n\t\t\tcString += '<valor>'+ConvType(AIPI[10],15,2)+'</valor>'\r\n\t\t\tcString += '</Tributo>'\r\n\t\t\tcString += '</imposto>'\r\n\t\tElseIf Len(aCSTIPI) > 0  .And. !Empty(cIpiCst)\r\n\t\t\tcString += '<imposto>'\r\n\t\t\tcString += '<codigo>IPI</codigo>'\r\n\t\t\tcString += '<cpl>'\r\n\t\t\tcString += NfeTag('<cEnq>' ,aprod[40])\r\n\t\t\tcString += '</cpl>'\r\n\t\t\tcString += '<Tributo>'\r\n\t\t\tcString += '<CST>'+ConvType(cIpiCst)+'</CST>'\r\n\t\t\tcString += '<modBC>'+ConvType(3)+'</modBC>'\r\n\t\t\tcString += '<pRedBC>'+ConvType(0,5,2)+'</pRedBC>'\r\n\t\t\tcString += '<vBC>'  +ConvType(0,15,2)+'</vBC>'\r\n\t\t\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\t\t\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\t\t\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\t\t\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\t\tcString += '</Tributo>'\r\n\t\t\tcString += '</imposto>'\r\n\t\tEndIf\r\n\tEndIf\r\nEndIf\r\ncString += '<imposto>'\r\ncString += '<codigo>PIS</codigo>'\r\nIf Len(aPIS)>0\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aPIS[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aPIS[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aPIS[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aPIS[03],5,2)+'</aliquota>'\r\n\tEndif\r\n\tcString += '<vlTrib>'+ConvType(aPIS[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aPIS[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aPIS[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tnValPis += aPIS[04]\r\nElse\r\n\tcString += '<Tributo>'\r\n\t\r\n\tIf len(aPisAlqZ) > 0 .and. !empty(aPisAlqZ[01])\r\n\t\tcString += '<CST>'+ConvType(aPisAlqZ[01])+'</CST>'\r\n\tElse\r\n\t\tcString += '<CST>08</CST>'\r\n\tEndIf\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\nEndIf\r\ncString += '</imposto>'\r\nIf Len(aPISST)>0\r\n\tcString += '<imposto>'\r\n\tcString += '<codigo>PISST</codigo>'\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aPISST[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aPISST[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aPISST[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aPISST[03],5,2)+'</aliquota>'\r\n\tEndIf\r\n\tcString += '<vlTrib>'+ConvType(aPISST[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aPISST[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aPISST[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tcString += '</imposto>'\r\n\tnValPis += aPISST[04]\r\nEndIf\r\ncString += '<imposto>'\r\ncString += '<codigo>COFINS</codigo>'\r\nIf Len(aCOFINS)>0\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aCOFINS[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aCOFINS[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINS[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINS[03],5,2)+'</aliquota>'\r\n\tEndIf\r\n\tcString += '<vlTrib>'+ConvType(aCOFINS[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aCOFINS[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aCOFINS[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tnValCof += aCOFINS[04]\r\nElse\r\n\tcString += '<Tributo>'\r\n\t\r\n\tIf len(aCofAlqZ) > 0 .and. !Empty(aCofAlqZ[01])\r\n\t\tcString += '<CST>'+ConvType(aCofAlqZ[01])+'</CST>'\r\n\tElse\r\n\t\tcString += '<CST>08</CST>'\r\n\tEndIf                       \r\n\t\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(0,15,2)+'</vBC>'\r\n\tcString += '<aliquota>'+ConvType(0,5,2)+'</aliquota>'\r\n\tcString += '<vlTrib>'+ConvType(0,15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(0,16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(0,15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\nEndIf\r\ncString += '</imposto>'\r\n\r\nIf Len(aCOFINSST)>0\r\n\tcString += '<imposto>'\r\n\tcString += '<codigo>COFINSST</codigo>'\t\r\n\tcString += '<Tributo>'\r\n\tcString += '<CST>'+ConvType(aCOFINSST[01])+'</CST>'\r\n\tcString += '<modBC></modBC>'\r\n\tcString += '<pRedBC>'+ConvType(0,7,4)+'</pRedBC>'\r\n\tcString += '<vBC>'+ConvType(aCOFINSST[02],15,2)+'</vBC>'\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINSST[03],7,4)+'</aliquota>'\r\n\tElse\r\n\t\tcString += '<aliquota>'+ConvType(aCOFINSST[03],5,2)+'</aliquota>'\r\n\tEndIf\r\n\tcString += '<vlTrib>'+ConvType(aCOFINSST[06],15,4)+'</vlTrib>'\r\n\tcString += '<qTrib>'+ConvType(aCOFINSST[05],16,4)+'</qTrib>'\r\n\tcString += '<valor>'+ConvType(aCOFINSST[04],15,2)+'</valor>'\r\n\tcString += '</Tributo>'\r\n\tcString += '</imposto>'\r\n\tnValCof += aCOFINSST[04]\r\nEndIf \r\n \tIf lMvPisCofD  .And. aDest[9] == 'PR'  // Lei Est. PR 17.127/12 informar todos os impostos na Danfe\r\n\t\tcMensFis += \" Conforme Lei Estadual PR 17.127/12 segue o Valor Pis / Cofins:\"\r\n\t\tcMensFis += \" Valor Pis R$ \" + ConvType(nValPis,15,2) \r\n\t\tcMensFis += \" Valor Cofins R$ \" + ConvType(nValCof,15,2)\r\nEndIf\r\n\r\nIf nIcmsDif > 0 .And. aDest[9] == 'PR' .And. aCST[1] $ '10' .And. SM0->M0_ESTENT == 'PR'\r\n\tcMensFis += \"Diferimento Parcial conforme Anexo VIII, Art. 28 do RICMS/PR - Decreto 7871/2017. ICMS Diferido em \" + ConvType(nPIcmsDif,6,2) +  \"% no valor de R$\" + ConvType(nIcmsDif,15,2) + \". \"\r\nEndIf\r\n\r\nIf nIcmsDif > 0 .And. aDest[9] == 'RS' .And. SM0->M0_ESTENT == 'RS' .And. aCST[1] $ '51' .And. nPIcmsDif > 12\r\n\tnValDifer += nIcmsDif\r\nEndif\r\n\r\nIf !lIssQn\r\n\t// Tratamento de imposto de importacao quando \r\n\tIf Len(aDI)>0 .And. ConvType(aDI[04][1]) == \"I19\"\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>II</codigo>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<vBC>'      +ConvType(aDI[17][03],15,2)+'</vBC>'\r\n\t\tcString += '<Valor>'    +ConvType(aDI[19][03],15,2)+'</Valor>'\r\n\t\tcString += '</Tributo>'\t\t\t\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<vDespAdu>' +ConvType(aDI[18][03],15,2)+'</vDespAdu>'\r\n\t\tcString += '<vIOF>'     +ConvType(aDI[20][03],15,2)+'</vIOF>'\r\n\t\tcString += '</cpl>'\t\t\t\t\t\t\r\n\t\tcString += '</imposto>'\r\n\tElseIf Len(aDI)>0\r\n\t\tcString += '<imposto>'\r\n\t\tcString += '<codigo>II</codigo>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<vBC>'      +ConvType(aDI[15][03],15,2)+'</vBC>'\r\n\t\tcString += '<Valor>'    +ConvType(aDI[14][03],15,2)+'</Valor>'\r\n\t\tcString += '</Tributo>'\t\t\t\r\n\t\tcString += '<cpl>'\r\n\t\tcString += '<vDespAdu>' +ConvType(aDI[13][03],15,2)+'</vDespAdu>'\r\n\t\tcString += '<vIOF>'     +ConvType(aDI[16][03],15,2)+'</vIOF>'\r\n\t\tcString += '</cpl>'\t\t\t\t\t\t\r\n\t\tcString += '</imposto>'\t\r\n\tEndIf\r\nEndIf\r\n\t\r\n//Anfavea Itens\r\nIf lAnfavea\r\n\tIf !Empty(aAnfI) .And. !Empty(aAnfI[01])\r\n\t\tcString += '<AnfaveaProd>'\r\n\t\tcString += \t'<![CDATA[<id'\r\n\t\tIf !Empty(aAnfI[01])\r\n\t\t\tcString += \t' item=\"' \t\t+ convType(Iif(lAnfProd,aAnfI[01],aAnfI[26])) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[02])\r\n\t\t\tcString += \t' ped=\"'\t\t+ convType(aAnfI[02]) + '\"'\r\n\t    Endif\r\n\t\tIf !Empty(aAnfI[03])\r\n\t\t\tcString += \t' sPed=\"'\t\t+ convType(aAnfI[03]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[04])\r\n\t\t\tcString += \t' alt=\"'\t\t+ convType(aAnfI[04]) + '\"'\r\n\t\tEndif\t\r\n\t\tIf !Empty(aAnfI[05])\r\n\t\t\tcString += \t' tpF=\"'\t\t+ convType(aAnfI[05]) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><div'\r\n\t\tIf !Empty(aAnfI[06])\r\n\t\t\tcString += \t' uM=\"'  \t\t+ convType(aAnfI[06]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[07])\r\n\t\t\tcString += \t' dVD=\"'\t\t+ convType(aAnfI[07]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[08])\r\n\t\t\tcString += \t' pedR=\"'\t\t+ convType(aAnfI[08]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[09])\r\n\t\t\tcString += \t' pE=\"'\t\t\t+ convType(aAnfI[09]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[10])\r\n\t\t\tcString += \t' psB=\"'\t\t+ convType(Alltrim(Str(aAnfI[10],TAMSX3(\"B1_PESO\")[1],TAMSX3(\"B1_PESO\")[2]))) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[11])\r\n\t\t\tcString += \t' psL=\"'\t\t+ convType(Alltrim(Str(aAnfI[11],TAMSX3(\"B1_PESO\")[1],TAMSX3(\"B1_PESO\")[2]))) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><entg'\r\n\t\tIf !Empty(aAnfI[12])\r\n\t\t\tcString += \t' tCh=\"'\t\t+ convType(Iif(aAnfI[12]==\"PeA\",'P&A',aAnfI[12])) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[13])\r\n\t\t\tcString += \t' ch=\"'\t\t\t+ convType(aAnfI[13]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[14])\r\n\t\t\tcString += \t' hCh=\"'\t\t+ convType(aAnfI[14]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[15])\r\n\t\t\tcString += \t' qtEm=\"'\t\t+ convType(Alltrim(Str(aAnfI[15],14,2))) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[16])\r\n\t\t\tcString += \t' qtlt=\"'\t\t+ convType(Alltrim(Str(aAnfI[16],14,2))) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><dest'\r\n\t\tIf !Empty(aAnfI[17])\r\n\t\t\tcString += \t' dca=\"'\t\t+ convType(aAnfI[17]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[18])\r\n\t\t\tcString += \t' ptU=\"'\t\t+ convType(aAnfI[18]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[19])\r\n\t\t\tcString += \t' trans=\"'\t\t+ convType(aAnfI[19]) + '\"'\r\n\t\tEndif\r\n\t\tcString += \t'/><ctl'\r\n\t\tIf !Empty(aAnfI[20])\r\n\t\t\tcString += \t' ltP=\"'\t\t+ convType(aAnfI[20]) + '\"'\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[21])\r\n\t\t\tcString += \t' cPI=\"'\t\t+ convType(aAnfI[21]) + '\"'\t\r\n\t\tEndif\r\n\t\tcString += \t'/><ref'\r\n\t\tIf !Empty(aAnfI[22])\r\n\t\t\tcString += \t' nFE=\"'\t\t+ convType(aAnfI[22]) + '\"'\t\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[23])\r\n\t\t\tcString += \t' sNE=\"'\t\t+ convType(aAnfI[23]) + '\"'\t\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[24])\r\n\t\t\tcString += \t' cdEm=\"'\t\t+ convType(aAnfI[24]) + '\"'\t\r\n\t\tEndif\r\n\t\tIf !Empty(aAnfI[25])\r\n\t\t\tcString += \t' aF=\"'\t\t\t+ convType(aAnfI[25]) + '\"'\t\r\n\t\tEndif\r\n\t\tcString += \t'/>]]>'\r\n\t\tcString += '</AnfaveaProd>'\r\n\tEndif\r\nEndif\r\n\r\nif !empty(aProd[15]) .And. !empty(cMotDesICMS) .or. ( !empty(cMotDesICMS).and. lIcmDevol .and. !Empty(nDesonICM) ) /*Conforme chamado TILXYR foi incluido o .OR. para incluir devolução na mensagem*/\r\n\tcMensDeson := 'Valor Dispensado R$ '+ cValtoChar(nDesonICM) + ', Motivo da Desoneracao do ICMS: '+cMotDesICMS+'.(Ajuste SINIEF 25/12, efeitos a partir de 20.12.12)'\r\nendif\r\n\r\n/*Nota Técnica 004 de 2011 conforme chamado - THCTB4 */\r\n/*Nota Técnica 004 de 2011 conforme chamado - THCTB4 e conforme portaria nº 275/2009 do chamado TPIPVV */\r\n\r\nif lSuframa .and. Len(aICMSZFM)>0 \r\n\tIf!(lMvNFLeiZF)\r\n\t\tif aIcmsZFM[1] > 0 .and. empty(aProd[15])\t\r\n\t\t\t\r\n\t\t\t//cMensDeson := 'Valor do ICMS abatido: R$ '+ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( '+Iif(aProd[33] > 0,AllTrim(Str(aProd[33])),'7')+'% sobre R$ ' +ConvType(aProd[10],15,2)+ ' ).'\r\n\t\t\tIf aProd[33] > 0\r\n\t\t\t\tcMensDeson := 'Valor do ICMS abatido: R$ '+ ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( '+AllTrim(Str(aProd[33]))+'% sobre R$ ' +ConvType(aProd[10] + aProd[13] + aProd[14],15,2)+ ' ).'\r\n\t\t\tElse\r\n\t\t\t\tcMensDeson := 'Valor do ICMS abatido: R$ '+ ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( '+'7% sobre R$ ' + ConvType(aProd[10]- IIF(cTipo == '1', aProd[31]+aProd[32], 0),15,2)+ ' ).'\t\r\n\t\t\tEndIf\t\r\n\t\t\t\r\n\t\telse\r\n\t\t\tcMensDeson := 'Valor do ICMS abatido: R$ '+ConvType(aIcmsZFM[1]-aProd[31]-aProd[32],15,2)+ ' ( 7% sobre R$ ' +ConvType(aProd[10],15,2)+ ' ). Valor do desconto comercial: R$ '+ConvType(aProd[15],15,2)+'.'\t\r\n\t\tendif\r\n\tElse\r\n\t\tcMensDeson := 'Remessa de Mercadoria para ZFM ou ALC conforme Portaria 275.2009'\r\n\tEndif\r\nEndif\r\n\r\nIf aProd[29] > 0\r\n\tcDedIcm := 'Valor do ICMS deduzido R$ '+ cValtoChar(aProd[29] ) + '. Conforme artigo 55 anexo I do RICMS-SP.'\r\nEndIf \r\n\r\n// Valor dos Tributos por Ente Tributante: Federal, Estadual e Municipal\r\nIf lMvEnteTrb\r\n\r\n\tIf cMvMsgTrib $ \"2-3\" .And. cTpCliente == \"F\" .And. ( ( aProd[35] + aProd[36] + aProd[37] ) > 0 )\r\n\t\r\n\t\tlProdItem\t:= .T.\t\r\n\r\n\t\tcCrgTrib\t:= 'Valor aproximado do(s) Tributo(s): '\r\n\r\n\t\t// Federal\r\n\t\tIf aProd[35] > 0\r\n\t\t\tcPercTrib\t:= PercTrib( aProd, lProdItem, \"1\", aNota )  \r\n\t\t\tcCrgTrib\t+= 'R$ ' + ConvType( aProd[35], 15, 2 ) + \" (\"+cPercTrib+\"%) Federal\"\r\n\t\tEndIf\r\n\r\n\t\t// Estadual\r\n\t\tIf aProd[36] > 0\r\n\t\t\tcPercTrib\t:= PercTrib( aProd, lProdItem, \"2\", aNota )\r\n\t\t\tIf aProd[35] > 0\r\n\t\t\t\tcCrgTrib\t+= \" e \"\r\n\t\t\tEndif\r\n\t\t\tcCrgTrib\t+= \"R$ \" + ConvType( aProd[36], 15, 2 ) + \" (\"+cPercTrib+\"%) Estadual\"\r\n\t\tEndIf\r\n\t\r\n\t\t// Municipal\r\n\t\tIf aProd[37] > 0\r\n\t\t\tcPercTrib\t:= PercTrib( aProd, lProdItem, \"3\", aNota )  \r\n\t\t\tIf aProd[35] > 0 .Or. aProd[36] > 0\r\n\t\t\t\tcCrgTrib\t+= \" e \"\r\n\t\t\tEndif\r\n\t\t\tcCrgTrib\t+= \"R$ \" + ConvType( aProd[37], 15, 2 ) + \" (\"+cPercTrib+\"%) Municipal.\"\r\n\t\tEndIf\r\n\t\t\r\n\t\tIf !Empty( cFntCtrb )\r\n\t\t   cCrgTrib += \"  Fonte: \" + cFntCtrb + \".\"\r\n\t\tEndIf\r\n\t\t\r\n\t\t\r\n\tEndif\r\n\t\r\nElse\r\n\r\n\tIf aProd[30] > 0 .And. cMvMsgTrib $ \"2-3\" .And. cTpCliente == \"F\"\r\n\t\tlProdItem := .T.\t\r\n\t\tcPercTrib := PercTrib(aProd, lProdItem,,aNota)  \r\n\t\r\n\t\tcCrgTrib := 'Valor Aproximado dos Tributos: R$ '+ ConvType(aProd[30],15,2)+ \" (\"+cPercTrib+\"%).\"\t\r\n\tEndIf\r\n\r\nEndif\r\n\r\n// Grupo opcional 'impostoDevol' para informar o valor e percentual do IPI devolvido para notas de Devolução\r\nIf Len(aIPIDevol) > 0 .and. cTPNota == \"4\" \r\n\tcString += '<IPIDEV>'\r\n\tcString += '<pdevol>'+ConvType(aIPIDevol[01],6,2)+'</pdevol>' //Percentual da mercadoria devolvida\r\n\tcString += '<vipidevol>'+ConvType(aIPIDevol[02],15,2)+'</vipidevol>' //Valor do IPI devolvido\r\n\tcString += '</IPIDEV>'\t\r\nEndIf\r\n\r\n\r\n//Tratamento para incluir a mensagem em informacoes adicionais  do Produto (PR)\r\nIf aProd[43] > 0 .and. aDest[9] == \"PR\" .and.  cVerAmb ='3.10'\r\n\tcMensFecp := NfeMFECOP(aProd[43],aDest[9],\"2\")\r\nElseIf aProd[43] > 0  .and. cVerAmb ='4.00'\r\n   cMensFecp := NfeMFECOP(aProd[43],aDest[9],\"2\",aICMS,aICMSST,cVerAmb)\r\nEndIf\r\ncString += '<infadprod>'+ConvType(aProd[25],500)+cMensDeson+cDedIcm+cCrgTrib+cMensFecp+'</infadprod>'\r\n\r\ncString += '</det>' \r\nReturn(cString)\r\n\r\nStatic Function NfeTotal(aTotal,aRet,aICMS,aICMSST,lIcmDevol,cVerAmb,aISSQN,nVicmsDeson,aNota,nVIcmDif,aAgrPis,aAgrCofins,nValLeite )\r\n\r\nLocal cString\t\t:= \"\"\r\nLocal cMVREGIESP\t:= AllTrim(GetNewPar(\"MV_REGIESP\",\"2\"))\r\n/*1 – Microempresa Municipal; 2 – Estimativa; 3 – Sociedade de Profissionais; \r\n4 – Cooperativa; 5 – Microempresário Individual (MEI); \r\n6 – Microempresário e Empresa de Pequeno Porte (ME EPP)*/\r\nLocal nX     := 0\r\nLocal nBicm := 0\r\nLOcal nVicm := 0\r\nLocal nBicmst := 0\r\nLOcal nVicmst := 0\r\nLocal nAgrPis := 0\r\nLocal nAgrCofins := 0\r\n\r\nDefault nVicmsDeson\t:= 0\r\nDefault nVIcmDif\t:= 0\r\nDefault nValLeite   := 0\r\n\r\ncString += '<total>'\r\nIf Len(aICMS)>0 \r\n\tFor nX := 1 To Len(aICMS)\r\n\t\tIf Len(aICMS[NX]) >0\r\n\t\t\tnBicm += iIf(lIcmDevol,aICMS[NX][05],0)\r\n\t\t\tnVicm += iIf(lIcmDevol,aICMS[NX][07],0)\r\n\t\tEndif\t\r\n\tNext nX\r\nEndif\r\n\r\nIf Len(aICMSST)>0 \r\n\tFor nX := 1 To Len(aICMSST)\r\n\t\tIf Len(aICMSST[NX]) >0\r\n\t\t\tnBicmst += aICMSST[NX][05]\r\n\t\t\tnVicmst += aICMSST[NX][07]\r\n\t\tEndif\t\r\n\tNext nX\r\nEndif\r\n\r\nFor nX := 1 to Len(aAgrPis)\r\n\tnAgrPis\t\t+=\taAgrPis[nX][02]\r\n\tnAgrCofins\t+=\taAgrCofins[nX][02]\r\nNext\r\n\r\ncString += '<vBC>'+ConvType(nBicm, 15,2)+'</vBC>' \r\n\r\nIf cVerAmb >= \"3.10\" .and. nVIcmDif > 0\r\n\tcString += '<vICMS>'+ConvType(nVicm-nVIcmDif,15,2)+'</vICMS>'\r\nElse\r\n\tcString += '<vICMS>'+ConvType(nVicm,15,2)+'</vICMS>'\r\nEndIf\r\n\r\ncString += '<vBCST>'+ConvType(nBicmst,15,2)+'</vBCST>'\r\ncString += '<vICMSST>'+ConvType(nVicmst,15,2)+'</vICMSST>'\r\ncString += '<despesa>'+ConvType(aTotal[01]+nAgrPis+nAgrCofins+nValLeite,15,2)+'</despesa>'\r\n//cString += '<vNF>'+ConvType(aTotal[02],15,2)+'</vNF>'\r\n//Alteração para que o valor de PIS ST e COFINS ST venha a compor o valor da nota este valor se encontra na tag vOutros  (NT 2011/004). E devolução de compra com IPI não tributado\r\ncString += '<vNF>'+ConvType(aTotal[02]+aTotal[03],15,2)+'</vNF>'\r\n\r\nIf cVerAmb >= \"3.10\" .and. Len(aISSQN)>0\r\n\tcString += NfeTag('<cRegTrib>',ConvType(cMVREGIESP,1))\r\n\tcString += '<dCompet>'+Strtran(ConvType(aNota[03]),\"-\",\"\")+'</dCompet>'\r\nEndIf\t\r\nIf Len(aRet)>0\r\n\tFor nX := 1 To Len(aRet)\r\n\t\tcString += '<TributoRetido>'\r\n\t\tcString += NfeTag('<codigo>' ,ConvType(aRet[nX,01],15,2))\r\n\t\tcString += NfeTag('<BC>'     ,ConvType(aRet[nX,02],15,2))\r\n\t\tcString += NfeTag('<valor>',ConvType(aRet[nX,03],15,2))\r\n\t\tcString += '</TributoRetido>'\r\n/*\t    If aRet[nX,01] =='PIS'\r\n\t    \tnValPis += ConvType(aRet[nX,03],15,2)\r\n\t    EndIf\r\n\t    If aRet[nX,01] =='COFINS'\r\n\t    \tnValCof += ConvType(aRet[nX,03],15,2)\r\n\t    EndIf\t\t*/\r\n\tNext nX\r\nEndIf\r\ncString += '</total>'\r\n\r\n//Variavel para ter o valor total da nota para ser utilizado na Lei da Transparencia\r\nnTotNota \t:= Val(ConvType((aTotal[02]+aTotal[03]),15,2))\r\n\r\n\r\nReturn(cString)\r\n\r\nStatic Function NfeTransp(cModFrete,aTransp,aImp,aVeiculo,aReboque,aVol,cVerAmb,aReboqu2,cMunDest)\r\n           \r\nLocal nX := 0\r\nLocal cString := \"\"\r\nLocal lMVINTTRAN := SuperGetMV(\"MV_INTTRAN\", ,.T.)  // Parametro que define se as tags <veicTransp> e <reboque>, seram geradas em operações internas.\r\nLocal lGeraTags\t := .T.\r\nDEFAULT cMunDest\t:= \"\"\r\nDEFAULT aTransp := {}\r\nDEFAULT aImp    := {}\r\nDEFAULT aVeiculo:= {}\r\nDEFAULT aReboque:= {}\r\nDEFAULT aReboqu2:= {}\r\nDEFAULT aVol    := {}\r\n\r\ncString += '<transp>'\r\nIf cVerAmb >= \"2.00\"\r\n\tIf cModFrete == \"\"\r\n\t\tcString += '<modFrete>'+\"1\"+'</modFrete>' \r\n\tElse \r\n\t\tcString += '<modFrete>'+cModFrete+'</modFrete>'\r\n\tEndif\r\nEndif\r\n\r\nIf cVerAmb == \"4.00\"\r\n\t//Se operação interestadual(idDest=2), não informar os Grupos Veiculo Transporte (id:X18; veicTransp) e Grupo Reboque (id: X22)\r\n\t//Obs1: a critério de cada UF, a regra de validação acima também pode ser aplicada nas operações internas (idDest=1) se cMun (id:C10) do Emitente <> cMun (id: E10) do Destinatário\r\n\tIf cIdDest == \"2\" .or. (cIdDest == \"1\" .And. SM0->M0_CODMUN <> cMunDest .And. !lMVINTTRAN)\r\n\t\tlGeraTags:= .F.  \r\n\tEndif\r\nEndif\r\n\r\nIf Len(aTransp)>0\r\n\tcString += '<transporta>'\r\n\t\tIf Len(aTransp[01])==14\r\n\t\t\tcString += NfeTag('<CNPJ>',aTransp[01])\r\n\t\tElseIf Len(aTransp[01])<>0\r\n\t\t\tcString += NfeTag('<CPF>',aTransp[01])\r\n\t\tEndIf\r\n\t\tcString += NfeTag('<Nome>' ,ConvType(aTransp[02]))\r\n\t\tcString += NfeTag('<IE>'    ,aTransp[03])\r\n\t\tcString += NfeTag('<Ender>',ConvType(aTransp[04]))\r\n\t\tcString += NfeTag('<Mun>'  ,ConvType(aTransp[05]))\r\n\t\tcString += NfeTag('<UF>'    ,ConvType(aTransp[06]))\r\n\tcString += '</transporta>'\r\n\tIf Len(aImp)>0 //Ver Fisco\r\n\t\tcString += '<retTransp>'\r\n\t\tcString += '<codigo>ICMS</codigo>'\r\n\t\tcString += '<Cpl>'\r\n\t\tcString += '<vServ>'+ConvType(aImp[01],15,2)+'</vServ>'\r\n\t\tcString += '<CFOP>'+ConvType(aImp[02])+'</CFOP>'\r\n\t\tcString += '<cMunFG>'+ConvType(aImp[03],7)+'</cMunFG>'\t\t\r\n\t\tcString += '</Cpl>'\r\n\t\tcString += '<CST>'+ConvType(aImp[04])+'</CST>'\r\n\t\tcString += '<MODBC>'+ConvType(aImp[05])+'</MODBC>'\r\n\t\tcString += '<PREDBC>'+ConvType(aImp[06],7,2)+'</PREDBC>'\r\n\t\tcString += '<Tributo>'\r\n\t\tcString += '<VBC>'+ConvType(aImp[07],15,2)+'</VBC>'\r\n\t\tcString += '<aliquota>'+ConvType(aImp[08],7,4)+'</aliquota>'\r\n\t\tcString += '<valor>'+ConvType(aImp[9],15,2)+'</valor>'\r\n\t\tcString += '</Tributo>'\t\t\r\n\t\t// cString += '<vltrib>'+ConvType(aImp[09],15,4)+'</vltrib>'\t\r\n\t\t// cString += '<qtrib>'+ConvType(aImp[10],16,4)+'</qtrib>'\t\t\r\n\t\tcString += '</retTransp>'\r\n\tEndIf\r\n\tIf lGeraTags\r\n\t\tIf Len(aVeiculo)>0\r\n\t\t\tcString += '<veicTransp>'\r\n\t\t\t\tcString += '<placa>'+ConvType(aVeiculo[01])+'</placa>'\r\n\t\t\t\tcString += '<UF>'   +ConvType(aVeiculo[02])+'</UF>'\r\n\t\t\t\tcString += NfeTag('<RNTC>',ConvType(aVeiculo[03]))\r\n\t\t\tcString += '</veicTransp>'\r\n\t\tEndIf\r\n\t\tIf Len(aReboque)>0\r\n\t\t\tcString += '<reboque>'\r\n\t\t\t\tcString += '<placa>'+ConvType(aReboque[01])+'</placa>'\r\n\t\t\t\tcString += '<UF>'   +ConvType(aReboque[02])+'</UF>'\r\n\t\t\t\tcString += NfeTag('<RNTC>',ConvType(aReboque[03]))\r\n\t\t\tcString += '</reboque>'\r\n\t\t\tIf Len(aReboqu2)>0\r\n\t\t\t\tcString += '<reboque>'\r\n\t\t\t\tcString += '<placa>'+ConvType(aReboqu2[01])+'</placa>'\r\n\t\t\t\tcString += '<UF>'   +ConvType(aReboqu2[02])+'</UF>'\r\n\t\t\t\tcString += NfeTag('<RNTC>',ConvType(aReboqu2[03]))\r\n\t\t\t\tcString += '</reboque>'\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\t\t\r\nElseIf lGeraTags .And. Len(aVeiculo)>0\r\n\t\tcString += '<veicTransp>'\r\n\t\t\tcString += '<placa>'+ConvType(aVeiculo[01])+'</placa>'\r\n\t\t\tcString += '<UF>'   +ConvType(aVeiculo[02])+'</UF>'\r\n\t\t\tcString += NfeTag('<RNTC>',ConvType(aVeiculo[03]))\r\n\t\tcString += '</veicTransp>'\r\nEndIf\r\nFor nX := 1 To Len(aVol)\t\t\r\n\tcString += '<vol>'\r\n\t\tcString += NfeTag('<qVol>',ConvType(aVol[nX][02]))\r\n\t\tcString += NfeTag('<esp>' ,ConvType(aVol[nX][01],30,0))\r\n\t\tif len( aVol[nX] ) >= 5 \r\n\t\t\tcString += NfeTag('<marca>' ,ConvType(aVol[nX][05]))\r\n\t\tendif\r\n\t\tif len( aVol[nX] ) >= 6 \r\n\t\t\tcString += NfeTag('<nVol>'  ,ConvType(aVol[nX][06]))\r\n\t\tendif\r\n\t\tcString += NfeTag('<pesoL>' ,ConvType(aVol[nX][03],15,3))\r\n\t\tcString += NfeTag('<pesoB>' ,ConvType(aVol[nX][04],15,3))\r\n\t\t//cString += '<nLacre>'+aVol[07]+'</nLacre>'\r\n\tcString += '</vol>'\r\nNext nX\r\ncString += '</transp>'\r\nReturn(cString)\r\n\r\nStatic Function NfeCob(aDupl,aFat,cFatura)\r\n\r\nLocal cString := \"\"\r\nLocal nX := 0 \r\nLocal nValorfat := 0  \r\nLocal cValorDesc := \"0\"  \r\nlocal lDatDupl\t\t:= SuperGetMV(\"MV_DATDUPL\",.F.,.F.) \r\nDEFAULT cFatura\t:= \"\"\r\nDEFAULT aDupl\t:= {}  \r\nDEFAULT aFat\t:= {}\r\n               \r\n//Ordeno as duplicatas por data de vencimento\r\nIf Len(aDupl) > 1\r\n\taDupl := SortArray(aDupl,,,{|x,y| x[2] < y[2] .and. x[3] > y[3] })\r\nEndIf\t\r\n\r\nIf Len(aDupl)>0\r\n\r\n\tcString += '<cobr>'\r\n\t\r\n\tIf Len(aFat)>0\r\n\t\tcString += '<fat>'\r\n\t\tcString += '<nFatura>'+ConvType(aFat[01][01])+'</nFatura>'\r\n\t\tcString += '<vOriginal>'+ConvType(aFat[01][02],15,2)+'</vOriginal>'\r\n\t\tcString += '<vDesconto>'+ConvType(aFat[01][03],15,2)+'</vDesconto>'\r\n\t\tcString += '<vLiquido>' +ConvType(aFat[01][04],15,2)+'</vLiquido>'\r\n\t\tcString += '</fat>'\r\n\telse\r\n\t\tFor nX := 1 To Len(aDupl)\r\n\t\t\tnValorfat:= nValorfat + aDupl[nX][03]\r\n\t\tNext nX\t\r\n\t\t\r\n\t\tcString += '<fat>'\r\n\t\tcString += '<nFatura>'+ConvType(cFatura)+'</nFatura>'\r\n\t\tcString += '<vOriginal>'+ConvType(nValorfat,15,2)+'</vOriginal>'\r\n\t\tcString += '<vDesconto>'+cValorDesc+'</vDesconto>'\r\n\t\tcString += '<vLiquido>' +ConvType(nValorfat,15,2)+'</vLiquido>'\r\n\t\tcString += '</fat>'\r\n\tEndIf\r\n\t\r\n\t\r\n\tFor nX := 1 To Len(aDupl)\r\n\t\tcString += '<dup>'\r\n\t\tcString += '<Dup>'+ConvType(PADL(nX,3,\"0\"))+'</Dup>'\r\n\t\tIf (aDupl[nX][02] < DATE()) .and. lDatDupl\r\n\t\t\tcString += '<dtVenc>'+ConvType(DATE())+'</dtVenc>'\t\r\n\t\tElse\r\n\t\t\tcString += '<dtVenc>'+ConvType(aDupl[nX][02])+'</dtVenc>'\r\n\t\tEndIf\r\n\t\tcString += '<vDup>'+ConvType(aDupl[nX][03],15,2)+'</vDup>'\r\n\t\tcString += '</dup>'\r\n\tNext nX\t\r\n\tcString += '</cobr>'\r\nEndIf\r\n\r\nReturn(cString)\r\n\r\nStatic Function NfeInfAd(cMsgCli,cMsgFis,aPedido,aExp,cAnfavea,aMotivoCont,aNfSa,aNfVinc,aProd,aDI,aNfVincRur,aRet,cNfRefcup,cSerRefcup,cTipo,nIPIConsig,nSTConsig,lBrinde,cVerAmb,aRefECF,nVicmsDeson,nvFCPUFDest,nvICMSUFDest,nvICMSUFRemet,nvBCUFDest,aICMUFDest,nValIpiBene,npFCPUFDest,npICMSUFDest,npICMSInter,npICMSIntP,aObsCont,aValTotOpe,cMensDifal,aProcRef,aDest,nTotCrdP,cMensCpl)\r\nLocal cString   \t\t:= \"\"\r\nLocal cCfor     \t\t:= \"\"\r\nLocal cLojaEn   \t\t:= \"\"\r\nLocal cCnpjen   \t\t:= \"\"\r\nLocal cDocEn    \t\t:= \"\"\r\nLocal cSerieEn  \t\t:= \"\"\r\nLocal cChave1   \t\t:= \"\"\r\nLocal cValidCh\t\t\t:= \"\"\r\nLocal cInfRem\t\t\t:= \"\"\r\nLocal cNfVinc\t\t\t:= \"\"\r\nLocal cEcfVinc\t\t\t:= \"\"\r\nLocal cChvNFe\t\t\t:= \"\"\r\nLocal cNfVincRur\t\t:= \"\"\r\nLocal cPercTrib \t\t:= \"\"\r\nLocal aEEC     \t\t\t:= {}\r\nLocal aNcm    \t\t\t:= {}\r\nLocal aDadosDest\t\t:= {}\r\nLocal aInfoDest\t\t\t:= {}\r\nLocal nX        \t\t:= 0\r\nLocal nY        \t\t:= 0\r\nLocal nZ\t\t\t\t:= 0\r\nLocal nW\t\t\t\t:= 0\r\nLocal nPos\t\t\t\t:= 0\r\nLocal nValII\t\t\t:= 0\r\nLocal nVlrTotal \t\t:= 0\r\nLocal lEasy\t\t\t\t:= SuperGetMV(\"MV_EASY\") == \"S\"\r\nLocal lImpRet\t\t\t:= GetNewPar(\"MV_IMPRET\",.F.)\r\nLocal lProdItem\t\t\t:= .F.\t//Define se esta configurado para gerar a mensagem da Lei da Transparencia por Produto ou somente nas informacoes Complementares.\r\nLocal lEECFAT\t\t\t:= SuperGetMv(\"MV_EECFAT\")\r\nLocal lEIC0064\t\t\t:= GetNewPar(\"MV_EIC0064\",.F.)\r\nLocal lMsnOk    \t\t:= .F.\r\n\r\n\r\nDEFAULT cAnfavea\t\t:= \"\"\r\nDEFAULT aPedido \t\t:= {}\r\nDEFAULT aExp\t\t\t:= {}\r\nDEFAULT aNfSa\t\t\t:= {}\r\nDEFAULT aNfVinc \t\t:= {}\r\nDEFAULT aProd\t\t\t:= {}  \r\nDEFAULT aDI \t\t\t:= {}  \r\nDEFAULT aNfVincRur \t\t:= {}  \r\nDEFAULT aRefECF\t\t\t:= {} \r\nDEFAULT nIPIConsig \t\t:= 0  \r\nDEFAULT nSTConsig \t\t:= 0  \r\nDEFAULT nvFCPUFDest\t\t:= 0\r\nDEFAULT nvICMSUFDest\t:= 0\r\nDEFAULT nvICMSUFRemet\t:= 0\r\nDEFAULT npFCPUFDest   \t:= 0 \r\nDEFAULT npICMSUFDest  \t:= 0 \r\nDEFAULT npICMSInter   \t:= 0 \r\nDEFAULT npICMSIntP    \t:= 0 \t\r\nDEFAULT nValIpiBene\t\t:= 0\r\nDEFAULT nTotCrdP        := 0\r\nDEFAULT cAnfavea\t\t:= \"\"\r\nDEFAULT nvBCUFDest \t\t:= 0\r\nDEFAULT aICMUFDest \t\t:= {} \r\nDEFAULT aObsCont   \t\t:= {}\t\r\nDEFAULT aProcRef   \t\t:= {}\t\r\nDEFAULT aDest      \t\t:= {}\r\n\r\ncString += '<infAdic>'\r\n\r\nIf AliasIndic(\"EYY\")\r\n\taEEC:= AvGetNfRem(aNfSa[2],aNfSa[1])\t \r\nEndif\r\n\r\n//array aEEC:= AvGetNfRem\r\n//documento   1\r\n//serie       2\r\n//fornecedor  3\r\n//loja        4\r\nIf len(aEEC) > 0\r\n\tFor nY := 1 To Len(aEEC)        \r\n\t   \tdbSelectArea(\"SF1\")\r\n\t\tdbSetOrder(1)\r\n\t\tIf DbSeek(xFilial(\"SF1\")+aEEC[ny][2][1]+aEEC[ny][2][2]+aEEC[ny][2][3]+aEEC[ny][2][4])\r\n\t\t\tIf cValidCh <> (xFilial(\"SF1\")+aEEC[ny][2][1]+aEEC[ny][2][2]+aEEC[ny][2][3]+aEEC[ny][2][4])\r\n\t\t\t\tcCfor      := SF1->F1_FORNECE\r\n\t\t\t    cLojaEn    := SF1->F1_LOJA\r\n\t\t\t    dEmisEn    := SF1->F1_EMISSAO  \r\n\t\t\t\tcDocEn\t   := SF1->F1_DOC\r\n\t\t\t\tcSerieEn   := SF1->F1_SERIE\r\n\t\t\t    cValidCh   := (xFilial(\"SF1\")+aEEC[ny][2][1]+aEEC[ny][2][2]+aEEC[ny][2][3]+aEEC[ny][2][4])\r\n\t\t\t    \r\n\t\t\t    dbSelectArea(\"SA2\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf DbSeek(xFilial(\"SA2\")+cCfor+cLojaEn)\r\n\t\t\t\t\tcCnpjen    := SA2->A2_CGC\r\n\t\t\t\tEndIf   \r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea( \"SD1\" )\r\n\t\t\t\tdbSetOrder( 1 )\r\n\t\t\t\tcChave1 := xFilial( \"SD1\" ) + cDocEn + cSerieEn + cCfor + cLojaEn\r\n\r\n\t\t\t\tif( dbSeek( cChave1 ) )\r\n\t\t\t\t\tdbSelectArea( \"SB1\" )\r\n\t\t\t   \t\tdbSetOrder( 1 )\r\n\r\n\t\t\t\t\twhile !SD1->(eof()) .and. cChave1 == xFilial( \"SD1\" ) + SD1->D1_DOC + SD1->D1_SERIE + SD1->D1_FORNECE + SD1->D1_LOJA\r\n\t\t\t\t\t\tif( dbSeek( xFilial( \"SB1\" ) + SD1->D1_COD ) )\r\n\t\t\t\t\t\t\tnPos := aScan( aNcm,{ |x|x[2] == SB1->B1_POSIPI } )\r\n\r\n\t\t\t\t\t\t\tif( nPos > 0 )\r\n\t\t\t\t\t\t\t\taNcm[nPos,03] += SD1->D1_QUANT\r\n\t\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\t\taadd( aNcm,{ cChave1,SB1->B1_POSIPI,SD1->D1_QUANT,SB1->B1_UM } )\r\n\t\t\t\t\t\t\tendIf\r\n\t\t\t\t\t\tendIf\r\n\r\n\t\t\t\t\t\tSD1->( dbSkip() )\r\n\t\t\t\t\tendDo\r\n\t\t\t\t\t\r\n\t\t\t\t\tif( nY > 1 )\r\n\t\t\t\t\t\tcInfRem += \"CNPJ-CPF Rem.\"+\": \"+cCnpjen+\"/\"\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tcInfRem := \"CNPJ-CPF Rem.\"+\": \"+cCnpjen+\"/\"\r\n\t\t\t\t\tendIf\r\n\t\t\t\t\t \t\t\t\t\t \r\n\t\t\t\t\tcInfRem += \"Numero NF\"+\": \"+cDocEn+\"/\"+\"Serie\"+\": \"+cSerieEn+\"/\"+\"Data Emissao\"+\": \"+StrZero(Day(dEmisEn),2)+'-'+StrZero(Month(dEmisEn),2)+'-'+StrZero(Year(dEmisEn),4)\r\n\t\t\t\t\t \r\n\t\t\t\t\tfor nX := 1 to len( aNcm )\r\n\t\t\t\t\t\tcInfRem += +\"/\"+\"NCM-SH\"+\": \"+aNcm[nx,02]+\"/\"+\"UM\"+\": \"+aNcm[nx,04]+\"/\"+\"Quantidade\"+\": \"+AllTrim(Str(aNcm[nx,03]))\r\n\t\t\t\t\tnext nX\r\n\t\t\t\tendIf\r\n\t\t\tEndif\r\n\t\tEndIf\r\n\tNext ny\r\nEndIf \r\n\r\n/*\r\nREQUISITO PAF-ECF - Controle de Lojas\r\nEssa função insere o MD-5 do PAFLISTA.TXT\r\nno inicio da mensagem no campo \"Mensagens Adicionais\"\r\n*/\r\nIf ExistFunc(\"STFMMD5Nfe\")\r\n\tSTFMMD5Nfe(@cMsgFis)\r\nEndIf\r\n\r\nIf Len(cMsgFis)>0    \r\n\tcString += '<Fisco>'+ConvType(cMsgFis,Len(cMsgFis))+'</Fisco>'\r\nEndIf\r\n\r\ncString += '<Cpl>[ContrTSS='+StrZero(Year(ddatabase),4)+'-'+StrZero(Month(ddatabase),2)+'-'+StrZero(Day(ddatabase),2)+'#'+AllTrim(Time())+'#'+AllTrim(UsrFullName())+']'\r\n\r\nIf Len(cInfRem)>0\r\n\tcString += ConvType(cInfRem,Len(cInfRem))+\" \"\r\nEndIf\r\n\r\nIf !Empty(cMensCpl)\r\n\tcString += cMensCpl + \" \"\r\nEndIF\r\n\r\nIf Len(aMotivoCont)>0\r\n\t//cString += ConvType(\"DANFE emitida em contingencia devido a problemas técnicos - será necessária a substituição.\",Len(\"DANFE emitida em contingencia devido a problemas técnicos - será necessária a substituição.\"))+\" \"\r\n\tcString += \"Motivo da contingencia: \"+ConvType(aMotivoCont[1],Len(aMotivoCont[1]))+\", com \"\r\n\tcString += ConvType(\"inicío em\",Len(\"inicío em\"))+\" \"+StrZero(Day(aMotivoCont[2]),2)+\"/\"+StrZero(Month(aMotivoCont[2]),2)+\"/\"+StrZero(Year(aMotivoCont[2]),4)+\" \"\r\n\tcString += ConvType(\"às\",2)+\" \"+ConvType(aMotivoCont[3],Len(aMotivoCont[3]))+\".\"\r\nEndIf \r\nIf Len(cMsgCli)>0 .and. !Empty(cMsgCli)\r\n\tcString += ConvType(cMsgCli,Len(cMsgCli))+\" \"  \r\n\t//A Nota Fiscal de devolução deve ser preenchida com a nota e a data Original de acordo com a legislação:\r\n\t//Fundamento: Artigo 136 do RICMS-SP - O contribuinte,  excetuado o produtor,  emitirá Nota Fiscal (Lei nº 6374/89,  art. 67,  \r\n\t//Parágrafo 1º,  e Convênio de 15.12.70 - SINIEF, arts. 54 e 56, na redação do Ajuste SINlEF- 3/94, cláusula primeira, XII):.\r\n\tIF (SM0->M0_ESTENT) $ \"SP\" .AND. cTipo=='0' .And. !Empty(cSerRefcup + cNfRefcup)\r\n\t\tSFT->(dbSetOrder(6))\r\n\t\tIf SFT->(dbSeek(xFilial(\"SFT\")+\"S\"+cNfRefcup+cSerRefcup))\r\n\t\t\tcString += \" Artigo 136 do RICMS-SP Emissao Original NF-e: \"+cSerRefcup+\" \"+cNfRefcup+\" \"+Dtoc(SFT->FT_EMISSAO)+\" \" \r\n\t\tEndIf\t\t\r\n\tEndif\r\nEndIf   \r\n\r\nif SM0->M0_ESTENT == 'SP' .and. Len(aNfVinc) > 0\r\n\taSort(aNfVinc, , , {|x,y| x[4]+x[3] < y[4]+y[3] } ) //Ordena por CNPJ + Doc para aglutinar/totalizar os documentos por CNPJ\r\nEndIf\r\n\r\nIf Len( aNfVinc ) > 0 //Nota de espécie NFE ou NCE ou CTE vinculada\r\n\tFor nZ := 1  to Len( aNfVinc )\r\n\t\tIf !( aNfVinc[nZ][2] + aNfVinc[nZ][3] ) $ cChvNFe\r\n\t\t\tif !Empty(aNfVinc[nZ][6]) .and. \"CTE\" == UPPER(Alltrim(aNfVinc[nZ][6]))\r\n\t\t\t\tcString += \"Emissao Original CT-e: \"\r\n\t\t\telseif !Empty(aNfVinc[nZ][6]) .and. \"NFCE\" == UPPER(Alltrim(aNfVinc[nZ][6]))\r\n\t\t\t\tcString += \"Emissao Original NFC-e: \"\r\n\t\t\tElse\r\n\t\t\t\tif SM0->M0_ESTENT == 'SP' .And. !(aNfSa[5] $ \"I/P/C\") .And. !Empty(aNfVinc[nZ][13])\r\n\t\t\t\t\t//Busca pela chave: Codigo + Loja + Tipo de cadastro (1-cliente/2-fornecedor)\r\n\t\t\t\t\tif (nPos := aScan(aDadosDest,{|x| x[1]+x[2]+x[10] == aNfVinc[nZ][12]+aNfVinc[nZ][13]+AllTrim(Str(aNfVinc[nZ][11])) }) ) == 0\r\n\t\t\t\t\t\tIf At(\"#valor\",cString) > 0 //Verifica se houve uma troca de Cliente/fornecedor para totalizar o anterior\r\n\t\t\t\t\t\t\tcString :=  StrTran( cString, \"#valor\", ConvType(nVlrTotal,15,2))\r\n\t\t\t\t\t\t\tnVlrTotal := 0\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\tIf aNfVinc[nZ][11]==1\r\n\t\t\t\t\t\t\taInfoDest := GetAdvFVal(\"SA1\", { \"A1_COD\",\"A1_LOJA\",\"A1_NOME\", \"A1_MUN\", \"A1_EST\", \"A1_END\", \"A1_BAIRRO\", \"A1_CGC\", \"A1_INSCR\"}, xFilial(\"SA1\")+aNfVinc[nZ][12]+aNfVinc[nZ][13], 1, { \"\", \"\", \"\", \"\", \"\", \"\", \"\" })\r\n\t\t\t\t\t\t\taAdd(aInfoDest, \"1\")\r\n\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\taInfoDest := GetAdvFVal(\"SA2\", { \"A2_COD\",\"A2_LOJA\",\"A2_NOME\", \"A2_MUN\", \"A2_EST\", \"A2_END\", \"A2_BAIRRO\", \"A2_CGC\", \"A2_INSCR\"}, xFilial(\"SA1\")+aNfVinc[nZ][12]+aNfVinc[nZ][13], 1, { \"\", \"\", \"\", \"\", \"\", \"\", \"\" })\r\n\t\t\t\t\t\t\taAdd(aInfoDest, \"2\")\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\taAdd(aDadosDest,aInfoDest)\r\n\t\t\t\t\t\tnPos := Len(aDadosDest)\r\n\r\n\t\t\t\t\t\tcString += 'Retorno recebidos no Total R$ #valor , '\r\n\t\t\t\t\t\tcString += 'atraves da ' + Alltrim(aDadosDest[nPos,3]) + ', estabelecida na cidade de ' + alltrim(aDadosDest[nPos,4]) + '/' + alltrim(aDadosDest[nPos,5]) + ', na '\r\n\t\t\t\t\t\tcString += alltrim(aDadosDest[nPos,6]) + ', ' + alltrim(aDadosDest[nPos,7]) + ', inscrita no CNPJ sob nº ' + alltrim(aDadosDest[nPos,8]) + ' e Inscricao Estadual '\r\n\t\t\t\t\t\tcString += alltrim(aDadosDest[nPos,9]) + ' atraves das NFs: '\r\n\t\t\t\t\t\tlMsnOk:= .T.\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcString += \"NF-e: \"\r\n\t\t\t\tElse\r\n\t\t\t\t\tcString += \"Emissão Original NF-e: \"\r\n\t\t\t\tendIf\r\n\t\t\tendif\r\n\r\n\t\t\tcChvNFe += aNfVinc[nZ][2] + aNfVinc[nZ][3] + \"|\"\r\n\t\t\tcNfVinc := ( aNfVinc[nZ][2] + \" \" + aNfVinc[nZ][3] + \" \" + StrZero( Day( aNfVinc[nZ][1] ), 2 ) + \"-\" + StrZero( Month( aNfVinc[nZ][1] ), 2 ) + \"-\" + StrZero( Year( aNfVinc[nZ][1] ), 4 ) + \", \" )\r\n\t\t\tcString += ConvType( cNfVinc, Len( cNfVinc ) ) + \" \"\r\n\t\t\tif SM0->M0_ESTENT == 'SP'  \r\n\t\t\t\tIf Len (aNfVinc[nZ] ) >= 8 .and.  !Empty(aNfVinc[nZ][08]) .And. Len(aValTotOpe) > 0\r\n\t\t\t\t\tnW := Ascan( aValTotOpe, { | e | e[1] == aNfVinc[nZ][7] } )\r\n\t\t\t\t\tIf nW > 0\r\n\t\t\t\t\t\tcString += \"Valor da Operacao do Documento de Origem: \" + ConvType(aValTotOpe[nW][2],15,2) +' '\r\n\t\t\t\t\t\tnVlrTotal:= nVlrTotal + aValTotOpe[nW][2]\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tendif\r\n\t\t\tendif \r\n\t\tEndIf\r\n\tNext nZ\r\n\r\n\tIf lMsnOk //Para totalizar o ultimo cliete/fornecedor\r\n\t\tcString :=  StrTran( cString, \"#valor\", ConvType(nVlrTotal,15,2))\r\n\tEndIf\r\n\r\nEndIf\r\n\r\nIf Len( aRefECF ) > 0\t \t//Nota de espécie ECF vinculada\r\n\tcString += \"Emissao Original CF: \"\r\n\tFor nX := 1  to Len( aRefECF )\r\n\t\tIf !( Alltrim(aRefECF[nX][1]) + Alltrim(aRefECF[nX][2]) + Alltrim(aRefECF[nX][3]) ) $ cChvNFe\r\n\t\t\tcChvNFe += Alltrim(aRefECF[nX][1]) + Alltrim(aRefECF[nX][2]) + Alltrim(aRefECF[nX][3]) + \"|\"\r\n\t\t\tcEcfVinc := Alltrim(aRefECF[nX][2]) + \" \" + Alltrim(aRefECF[nX][1]) +\" \"+ Alltrim(aRefECF[nX][3])\r\n\t\t\tcString += ConvType( cEcfVinc, Len( cEcfVinc ) ) + \" \"\r\n\t\tEndIf\r\n\tNext Nx\r\nEndIf\r\n\r\nIf Len( aNfVincRur ) > 0 \t//Nota de espécie NFP vinculada \r\n\tcString += \"Emissao Original NFP: \"\r\n\tFor nX := 1  to Len( aNfVincRur )\r\n\t\tIf !( aNfVincRur[nX][2] + aNfVincRur[nX][3] ) $ cChvNFe\r\n\t\t\tcChvNFe += aNfVincRur[nX][2] + aNfVincRur[nX][3] + \"|\"\r\n\t\t\tcNfVincRur := ( aNfVincRur[nX][2] + \" \" + aNfVincRur[nX][3] + \" \" + StrZero( Day( aNfVincRur[nx][1] ), 2 ) + \"-\" + StrZero( Month( aNfVincRur[Nx][1] ), 2 ) + \"-\" + StrZero( Year( aNfVincRur[Nx][1] ), 4 ) + \", \" )\r\n\t\t\tcString += ConvType( cNfVincRur, Len( cNfVincRur ) ) + \" \"\r\n\t\tEndIf\r\n\tNext Nx\r\nEndIf\r\n\r\nnValII := 0\r\nFor nX := 1 To Len(aProd)\r\n\tIf Substr(ConvType(aProd[nX,7]),1,1) $ \"3\" \r\n\t\tIf Len(aDI[nx]) > 0 \r\n\t\t\tnValII += aDI[nX][19][03]\r\n\t\tEndIf\r\n\tEndIf\r\nNext\r\nIf nValII > 0\r\n\tIf lEasy .And. IIF(!GetNewPar(\"MV_SPEDEND\",.F.),ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"SP\" .and. lEIC0064\r\n\t\tcString += (\"Valor total do Imposto de Importacao : R$ \" + ConvType(nValII,15,2))\r\n\t\tcString += (\" .O valor do Imposto de Importacao nao esta embutido no valor dos produtos, somente ao valor total da NF-e.\")\r\n\tElse\r\n\t\tcString += (\"Valor total do Imposto de Importacao : R$ \" + ConvType(nValII,15,2))\r\n\tEndIf\t\r\nEndif\r\n\r\nIf Len(aRet) > 0 .And. lImpRet\r\n\tcString += \"Retencoes: \"\r\n\tFor nX :=1 to Len(aRet)\r\n\t\tDo Case\r\n\t\t\tCase aRet[nX,1] == \"PIS\"\r\n\t\t\t\tcString += \"PIS: \"+ConvType(aRet[nX,3],15,2)+ \"  \"\r\n\t\t\tCase aRet[nX,1] == \"COFINS\"\r\n\t\t\t\tcString += \t\"COFINS: \" + ConvType(aRet[nX,3],15,2) + \"  \"\r\n\t\t\tCase aRet[nX,1] == \"CSLL\"\r\n\t\t\t\tcString += \"CSLL: \" + ConvType(aRet[nX,3],15,2) + \"  \"\r\n\t\t\tCase aRet[nX,1] == \"IRRF\"\r\n\t\t\t\tcString += \"IR: \" + ConvType(aRet[nX,3],15,2) + \"  \"\r\n\t\t\tCase aRet[nX,1] == \"INSS\"\r\n\t\t\t\tcString += \"INSS: \" + ConvType(aRet[nX,3],15,2) \r\n\t\tEndCase\r\n\tNext\r\nEndIf \r\n\r\nIf nIPIConsig > 0\r\n\tcString += \"Valor do IPI: R$ \" + AllTrim(Transform(nIPIConsig, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf \r\nIf nSTConsig > 0\r\n\tcString += \"Valor do ICMS ST: R$ \" + AllTrim(Transform(nSTConsig, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nendIf\t\r\nIf nValIpiBene > 0 // Quando lIpiBenef = T leva IPI em vOutro e Inf. Adic.\r\n\tcString += \"Valor do IPI: R$ \" + AllTrim(Transform(nValIpiBene, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf\r\n\r\nIf nTotCrdP > 0 // valor de crédito Presumido -  Art.75, XXXII do RICMS/MG\r\n\tcString += \"Valor de crédito Presumido: R$ \" + AllTrim(Transform(nTotCrdP, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf\r\n\r\n// Valor dos tributos por Ente Tributante\r\nIf lMvEnteTrb\r\n\r\n\tIf cMvMsgTrib $ \"1-3\" .And. cTpCliente == \"F\" .And. ( ( nTotFedCrg + nTotEstCrg + nTotMunCrg ) > 0 )\r\n\r\n\t\tcString\t\t+= 'Valor Aproximado do(s) Tributo(s): '\r\n\r\n\t\tIf nTotFedCrg > 0\r\n\t\t\tcPercTrib\t:= PercTrib( Nil , .F., \"1\" )\r\n\t\t\tcString\t\t+= 'R$ ' + ConvType( nTotFedCrg, 15, 2 ) + \" (\"+cPercTrib+\"%) Federal\"\r\n\t\tEndIf\r\n\t\r\n\t\tIf nTotEstCrg > 0\r\n\t\t\tcPercTrib\t:= PercTrib( Nil , .F., \"2\" )\r\n\t\t\tIf nTotFedCrg > 0\r\n\t\t\t\tcString\t+= ' e '\r\n\t\t\tEndif\r\n\t\t\tcString\t\t+= 'R$ ' + ConvType( nTotEstCrg, 15, 2 ) + \" (\"+cPercTrib+\"%) Estadual\"\r\n\t\tEndIf\r\n\t\r\n\t\tIf nTotMunCrg > 0\r\n\t\t\tcPercTrib\t:= PercTrib( Nil , .F., \"3\" )\r\n\t\t\tIf ( nTotFedCrg + nTotEstCrg ) > 0\r\n\t\t\t\tcString\t+= ' e '\r\n\t\t\tEndif\r\n\t\t\tcString\t\t+= 'R$ ' + ConvType( nTotMunCrg, 15, 2 ) + \" (\"+cPercTrib+\"%) Municipal.\"\r\n\t\tEndIf\r\n\t                             \r\n\t\tIf !Empty( cFntCtrb )\r\n\t\t\tIf ( nTotFedCrg + nTotEstCrg + nTotMunCrg ) > 0\r\n\t\t\t\tcString += \" \"\r\n\t\t\tEndif\r\n\t\t\tcString += \"Fonte: \" + cFntCtrb + \".\"\r\n\t\tEndif\r\n\r\n\tEndif\r\n\t\t\r\nElse\r\n\r\n\tIf cMvMsgTrib $ \"1-3\" .And. nTotalCrg > 0 .And. cTpCliente == \"F\"\r\n\t\tlProdItem := .F.\r\n\t\tcPercTrib := PercTrib( nil , lProdItem)   \r\n\t\t\r\n\t\tIf !Empty(cFntCtrb)\r\n\t\t\tcString += 'Valor Aproximado dos Tributos: R$ ' +ConvType(nTotalCrg,15,2)+ \" (\"+cPercTrib+\"%). Fonte: \"+cFntCtrb+\".\"\r\n\t\tElse\r\n\t\t\tcString += 'Valor Aproximado dos Tributos: R$ ' +ConvType(nTotalCrg,15,2)+ \" (\"+cPercTrib+\"%).\"\r\n\t\tEndIf \r\n\tEndIf\r\n\r\nEndif\r\n\r\n//Tratamento para atender o DECRETO Nº 35.679, de 13 de Outubro de 2010 - Pernambuco para o Ramo de Auto Peças - TRGTM2\r\nIf lCustoEntr\r\n\tcString += \"ICMS apurado nos termos do Decreto nº 35.679, de 13 de Outubro de 2010.\"\r\nEndIf\r\n\r\n//Tratamento para adcionar o valor do ICMS desonerado para informação complementar da Danfe.\r\nIf nVicmsDeson >0\r\n\tcString += \"Valor do ICMS Desonerado: R$ \" + AllTrim(Transform(nVicmsDeson, \"@ze 9,999,999,999,999.99\")) + \". \"\r\nEndIf\r\nIf nvFCPUFDest > 0 .or.  nvICMSUFDest > 0 .or. nvICMSUFRemet > 0 .or. nvBCUFDest  > 0     \r\n \tIF (IIF(!(GetNewPar(\"MV_SPEDEND\",.F.)),ConvType(SM0->M0_ESTCOB),ConvType(SM0->M0_ESTENT)) == \"BA\" )   \r\n    cString +=\"Valor da BC do ICMS na UF de destino: R$ \"+ConvType(nvBCUFDest,15,2)+\". \"  \r\n \t\tcString +=\"Percentual do ICMS relativo ao Fundo de Combate a Pobreza - FCP na UF de destino: \"+ConvType(npFCPUFDest)+\"%. \"     //2  pFCPUFDest     nao\r\n \t\tcString +=\"Alíquota interna da UF de destino:  \"+ConvType(npICMSUFDest)+\"%. \"                                                  //3  pICMSUFDest    nao\r\n \t\tcString +=\"Alíquota interestadual das UF envolvidas: \"+cMensDifal+ \". \"\r\n \t\tcString +=\"Percentual provisório de partilha do ICMS Interestadual: \" +ConvType(npICMSIntP)+\"%. \"\r\n \tEndIf                                                                                                                             \t //5  pICMSInterPart nao\r\n \t\tcString +=\"Valor do ICMS relativo ao Fundo de Combate a Pobreza - FCP da UF de destino: R$ \"+ConvType(nvFCPUFDest,15,2)+\". \"       //6  vFCPUFDest\r\n \t\tcString +=\"Valor do ICMS Interestadual para a UF de destino: R$ \"+ConvType(nvICMSUFDest,15,2)+\". \"                                 //7  vICMSUFDest\r\n \t\tcString +=\"Valor do ICMS Interestadual para a UF do remetente: R$ \"+ConvType(nvICMSUFRemet,15,2)+\".\"                               //8  vICMSUFRemet\r\nEndIf \r\n\t\r\ncString:=If(Substr(cString,Len(cString)-1,1) $ \",\",Substr(cString,1,Len(cString)-2),cString)\r\ncString += '</Cpl>' \r\nIf !Empty(AllTrim(cAnfavea))\r\n\tcString += \"<AnfaveaCPL>\" + cAnfavea + \"</AnfaveaCPL>\"\r\nEndIf\r\n\r\nFor nX := 1 To Len(aObsCont)\r\n\tcString += '<obsCont>'\r\n\tcString += '<xCampo>'+Substr(aObsCont[nX][1], 1, 20)+ '</xCampo>'\r\n\tcString += '<xTexto>'+Substr(aObsCont[nX][2], 1, 60)+ '</xTexto>'\r\n\tcString += '</obsCont>'\t\r\nNext nX\r\n\r\n//Processo referenciado\r\nFor nX := 1 To Len(aProcRef)\r\n\tcString += '<procRef>'\r\n\tcString += '<nProc>'+aProcRef[nX][1]+ '</nProc>'\r\n\tcString += '<indProc>'+aProcRef[nX][2]+ '</indProc>'\r\n\tcString += '</procRef>'\t\r\nNext nX\r\n\r\ncString += '</infAdic>'\r\n       \r\n// Tratamento TAG Exportação integração com EEC Average \r\nIf Len(aExp)>0 .And. !Empty(aExp[01])\r\n\tIf lEECFAT\r\n\t/*Se versão 2.00 considera o retorno das posições 1 e 2\r\n\t\tSe versão 3.10, considera array da posição 4 do primeiro item\r\n\t*/\r\n\t\tIf cVerAmb == \"2.00\"\r\n\t\t\tcString += '<exporta>'\r\n\t\t\tcString += '<UFEmbarq>'+ConvType(aExp[01][01][03])+ '</UFEmbarq>'\r\n\t\t\tcString += '<locembarq>'+ConvType(aExp[01][02][03])+ '</locembarq>'\r\n\t\t\tcString += '</exporta>'\t\r\n\t\tEndIf\r\n\t\tIf ( cTipo == \"1\") //Somente se nota de saída ou devolução.\r\n\t\t\tIf !Empty(aExp[01][04][03])\r\n\t\t\t\tcString += '<exporta>'\r\n\t\t\t\tcString += '<UFEmbarq>'+ConvType(aExp[01][04][03][01][03])+ '</UFEmbarq>'\r\n\t\t\t\tcString += '<locembarq>'+ConvType(aExp[01][04][03][02][03])+ '</locembarq>'\t\t\t\t\r\n\t\t\t\tcString += NfeTag('<locdespacho>' ,ConvType(aExp[01][04][03][03][03]))\r\n\t\t\t\tcString += '</exporta>'\r\n\t\t\tEndIf\r\n\t\tEndIf\t\t\r\n\tElseIf ( cTipo == \"1\") \r\n\t\tcString += '<exporta>'\r\n\t\tcString += '<UFEmbarq>'+ConvType(aExp[01][01][01][03])+ '</UFEmbarq>'\r\n\t\tcString += '<locembarq>'+ConvType(aExp[01][01][02][03])+ '</locembarq>'\r\n\t\tIf cVerAmb >= \"3.10\" .And. !Empty(aExp[01][01][07][03])\r\n\t\t\tcString += NfeTag('<locdespacho>' ,ConvType(aExp[01][01][07][03]))\r\n\t\tEndIf\r\n\t\tcString += '</exporta>'\t\r\n\tEndIf\r\nEndIf\r\n\r\nIf Len(aPedido)>0\r\n\tIf cVerAmb >= \"3.10\"\r\n\t\tIf !Empty(aPedido[01]) .or. !Empty(aPedido[02]) .or. !Empty(aPedido[03])\r\n\t\t\tcString += '<compra>'\r\n\t\t\tcString += NfeTag('<nEmp>',aPedido[01])\r\n\t\t\tcString += NfeTag('<Pedido>',aPedido[02])\r\n\t\t\tcString += NfeTag('<Contrato>',aPedido[03])\r\n\t\t\tcString += '</compra>'\r\n\t\tEndIf\r\n\tElse\r\n\t\tcString += '<compra>'\r\n\t\tcString += '<nEmp>'+aPedido[01]+'</nEmp>'\r\n\t\tcString += '<Pedido>'+aPedido[02]+'</Pedido>'\r\n\t\tcString += '<Contrato>'+aPedido[03]+'</Contrato>'\r\n\t\tcString += '</compra>'\r\n\tEndIf\r\nEndIf\t\r\n\r\naSize(aInfoDest,0)\r\naInfoDest := Nil\r\naSize(aDadosDest,0)\r\naDadosDest := Nil\r\n\r\nReturn(cString)\r\n\r\nStatic Function ConvType(xValor,nTam,nDec)\r\n\r\nLocal cNovo := \"\"\r\nDEFAULT nDec := 0\r\nDo Case\r\n\tCase ValType(xValor)==\"N\"\r\n\t\tIf xValor <> 0\r\n\t\t\tcNovo := AllTrim(Str(xValor,nTam,nDec))\t\r\n\t\tElse\r\n\t\t\tcNovo := \"0\"\r\n\t\tEndIf\r\n\tCase ValType(xValor)==\"D\"\r\n\t\tcNovo := FsDateConv(xValor,\"YYYYMMDD\")\r\n\t\tcNovo := SubStr(cNovo,1,4)+\"-\"+SubStr(cNovo,5,2)+\"-\"+SubStr(cNovo,7)\r\n\tCase ValType(xValor)==\"C\"\r\n\t\tIf nTam==Nil\r\n\t\t\txValor := AllTrim(xValor)\r\n\t\tEndIf\r\n\t\tDEFAULT nTam := 60\r\n\t\tcNovo := AllTrim(NoAcento(SubStr(xValor,1,nTam)))\r\nEndCase\r\nReturn(cNovo)\r\n\r\nStatic Function Inverte(uCpo, nDig)\r\nLocal cRet\t:= \"\"\r\nDefault nDig := 9\r\n/*\r\nLocal cCpo\t:= uCpo\r\nLocal cByte\t:= \"\"\r\nLocal nAsc\t:= 0\r\nLocal nI\t\t:= 0\r\nLocal aChar\t:= {}\r\nLocal nDiv\t:= 0\r\n*/\r\ncRet\t:=\tGCifra(Val(uCpo),nDig)\r\n/*\r\nAadd(aChar,\t{\"0\", \"9\"})\r\nAadd(aChar,\t{\"1\", \"8\"})\r\nAadd(aChar,\t{\"2\", \"7\"})\r\nAadd(aChar,\t{\"3\", \"6\"})\r\nAadd(aChar,\t{\"4\", \"5\"})\r\nAadd(aChar,\t{\"5\", \"4\"})\r\nAadd(aChar,\t{\"6\", \"3\"})\r\nAadd(aChar,\t{\"7\", \"2\"})\r\nAadd(aChar,\t{\"8\", \"1\"})\r\nAadd(aChar,\t{\"9\", \"0\"})\r\n\r\nFor nI:= 1 to Len(cCpo)\r\n   cByte := Upper(Subs(cCpo,nI,1))\r\n   If (Asc(cByte) >= 48 .And. Asc(cByte) <= 57) .Or. ;\t// 0 a 9\r\n   \t\t(Asc(cByte) >= 65 .And. Asc(cByte) <= 90) .Or. ;\t// A a Z\r\n   \t\tEmpty(cByte)\t// \" \"\r\n\t   nAsc\t:= Ascan(aChar,{|x| x[1] == cByte})\r\n   \tIf nAsc > 0\r\n   \t\tcRet := cRet + aChar[nAsc,2]\t// Funcao Inverte e chamada pelo rdmake de conversao\r\n\t   EndIf\r\n\tElse\r\n\t\t// Caracteres <> letras e numeros: mantem o caracter\r\n\t\tcRet := cRet + cByte\r\n\tEndIf\r\nNext\r\n*/\r\nReturn(cRet)\r\n\r\nStatic Function NfeTag(cTag,cConteudo)\r\n\r\nLocal cRetorno := \"\"\r\nIf (!Empty(AllTrim(cConteudo)) .And. IsAlpha(AllTrim(cConteudo))) .Or. Val(AllTrim(cConteudo))<>0\r\n\tcRetorno := cTag+AllTrim(cConteudo)+SubStr(cTag,1,1)+\"/\"+SubStr(cTag,2)\r\nEndIf\r\nReturn(cRetorno)\r\n\r\nStatic Function VldIE(cInsc,lContr,lIsent)\r\n\r\nLocal cRet\t:=\t\"\"\r\nLocal nI\t:=\t1\r\nDEFAULT lContr  :=      .T.\r\nDEFAULT lIsent  :=      .T.\r\nFor nI:=1 To Len(cInsc)\r\n\tIf Isdigit(Subs(cInsc,nI,1)) .Or. IsAlpha(Subs(cInsc,nI,1))\r\n\t\tcRet+=Subs(cInsc,nI,1)\r\n\tEndif\r\nNext\r\ncRet := AllTrim(cRet)\r\nIf \"ISENT\"$Upper(cRet)\r\n\tcRet := \"\"\r\nEndIf\r\nIf lContr .And. Empty(cRet) .And. lIsent\r\n\tcRet := \"ISENTO\"\r\nEndIf\r\nIf !lContr\r\n\tcRet := \"\"\r\nEndIf\r\nReturn(cRet)\r\n\r\n\r\nstatic FUNCTION NoAcento(cString)\r\nLocal cChar  := \"\"\r\nLocal nX     := 0 \r\nLocal nY     := 0\r\nLocal cVogal := \"aeiouAEIOU\"\r\nLocal cAgudo := \"áéíóú\"+\"ÁÉÍÓÚ\"\r\nLocal cCircu := \"âêîôû\"+\"ÂÊÎÔÛ\"\r\nLocal cTrema := \"äëïöü\"+\"ÄËÏÖÜ\"\r\nLocal cCrase := \"àèìòù\"+\"ÀÈÌÒÙ\" \r\nLocal cTio   := \"ãõÃÕ\"\r\nLocal cCecid := \"çÇ\"\r\nLocal cMaior := \"&lt;\"\r\nLocal cMenor := \"&gt;\"\r\n\r\nFor nX:= 1 To Len(cString)\r\n\tcChar:=SubStr(cString, nX, 1)\r\n\tIF cChar$cAgudo+cCircu+cTrema+cCecid+cTio+cCrase\r\n\t\tnY:= At(cChar,cAgudo)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\r\n\t\tnY:= At(cChar,cCircu)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\r\n\t\tnY:= At(cChar,cTrema)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\r\n\t\tnY:= At(cChar,cCrase)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(cVogal,nY,1))\r\n\t\tEndIf\t\t\r\n\t\tnY:= At(cChar,cTio)\r\n\t\tIf nY > 0          \r\n\t\t\tcString := StrTran(cString,cChar,SubStr(\"aoAO\",nY,1))\r\n\t\tEndIf\t\t\r\n\t\tnY:= At(cChar,cCecid)\r\n\t\tIf nY > 0\r\n\t\t\tcString := StrTran(cString,cChar,SubStr(\"cC\",nY,1))\r\n\t\tEndIf\r\n\tEndif\r\nNext\r\n\r\nIf cMaior$ cString \r\n\tcString := strTran( cString, cMaior, \"\" ) \r\nEndIf\r\nIf cMenor$ cString \r\n\tcString := strTran( cString, cMenor, \"\" )\r\nEndIf\r\n\r\ncString := StrTran( cString, CRLF, \" \" )\r\n\r\nReturn cString\r\n\r\n/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³MyGetEnd  ³ Autor ³ Liber De Esteban             ³ Data ³ 19/03/09 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Verifica se o participante e do DF, ou se tem um tipo de endereco ³±±\r\n±±³          ³ que nao se enquadra na regra padrao de preenchimento de endereco  ³±±\r\n±±³          ³ por exemplo: Enderecos de Area Rural (essa verificção e feita     ³±±\r\n±±³          ³ atraves do campo ENDNOT).                                         ³±±\r\n±±³          ³ Caso seja do DF, ou ENDNOT = 'S', somente ira retornar o campo    ³±±\r\n±±³          ³ Endereco (sem numero ou complemento). Caso contrario ira retornar ³±±\r\n±±³          ³ o padrao do FisGetEnd                                             ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Obs.     ³ Esta funcao so pode ser usada quando ha um posicionamento de      ³±±\r\n±±³          ³ registro, pois será verificado o ENDNOT do registro corrente      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ SIGAFIS                                                           ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/\r\nStatic Function MyGetEnd(cEndereco,cAlias)\r\n\r\nLocal cCmpEndN\t:= SubStr(cAlias,2,2)+\"_ENDNOT\"\r\nLocal cCmpEst\t:= SubStr(cAlias,2,2)+\"_EST\"\r\nLocal aRet\t\t:= {\"\",0,\"\",\"\"}\r\n\r\n//Campo ENDNOT indica que endereco participante mao esta no formato <logradouro>, <numero> <complemento>\r\n//Se tiver com 'S' somente o campo de logradouro sera atualizado (numero sera SN)\r\nIf (&(cAlias+\"->\"+cCmpEst) == \"DF\") .Or. ((cAlias)->(FieldPos(cCmpEndN)) > 0 .And. &(cAlias+\"->\"+cCmpEndN) == \"1\")\r\n\taRet[1] := cEndereco\r\n\taRet[3] := \"SN\"\r\nElse\r\n\taRet := FisGetEnd(cEndereco, (&(cAlias+\"->\"+cCmpEst)))\r\nEndIf\r\n\r\nReturn aRet\r\n\r\n\r\nStatic Function NFSeIde(aNotaServ,cNatOper,cTipoRPS,cModXml)\r\nLocal cString  := \"\"\r\nLocal cRegTrib := \"\"\r\nLocal cOptSimp := \"\"\r\nLocal cIncCult := \"\"\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString += '<InfRps>'\r\n\tcString += '<IdentificacaoRps>'\r\n\tcString += '<Numero>'+ConvType(Val(aNotaServ[02]),15)+'</Numero>'\r\n\tcString += '<Serie>'+AllTrim(aNotaServ[01])+'</Serie>'             \r\n\tcString += '<Tipo>'+cTipoRPS+'</Tipo>'\r\n\tcString += '</IdentificacaoRps>' \r\n\tcString += '<DataEmissao>'+ConvType(aNotaServ[03])+\"T\"+Time()+'</DataEmissao>'\r\n\tcString += '<NaturezaOperacao>'+cNatOper+'</NaturezaOperacao>'\r\n\tcString += '<RegimeEspecialTributacao>'+cRegTrib+'</RegimeEspecialTributacao>'\r\n\tcString += '<OptanteSimplesNacional>'+cOptSimp+'</OptanteSimplesNacional>'\r\n\tcString += '<IncentivadorCultural>'+cIncCult+'</IncentivadorCultural>'\r\n\tcString += '<Status>'+\"1\"+'</Status>'\r\n\t//cString += '<RpsSubstituido>'\r\n\t//cString += '<Numero>'+ConvType(Val(aNotaServ[02]),15)+'</Numero>'\r\n\t//cString += '<Serie>'+AllTrim(aNotaServ[01])+'</Serie>'             \r\n\t//cString += '<Tipo>'+cTipoRPS+'</Tipo>'\r\n\t//cString += '</RpsSubstituido>' \r\n\t\r\nElse//ISSNET\r\n\tcString += '<tc:InfRps>'\r\n\tcString += '<tc:IdentificacaoRps>'\r\n\tcString += '<tc:Numero>'+ConvType(Val(aNotaServ[02]),15)+'</tc:Numero>'\r\n\t//cString += '<tc:Serie>'+'8'+'</tc:Serie>'             \r\n\tcString += '<tc:Serie>'+AllTrim(aNotaServ[01])+'</tc:Serie>'             \r\n\tcString += '<tc:Tipo>'+cTipoRPS+'</tc:Tipo>'\r\n\tcString += '</tc:IdentificacaoRps>' \r\n\tcString += '<tc:DataEmissao>'+ConvType(aNotaServ[03])+\"T\"+Time()+'</tc:DataEmissao>'\r\n\tcString += '<tc:NaturezaOperacao>'+cNatOper+'</tc:NaturezaOperacao>'\r\n\tcString += '<tc:RegimeEspecialTributacao>'+cRegTrib+'</tc:RegimeEspecialTributacao>'\r\n\tcString += '<tc:OptanteSimplesNacional>'+cOptSimp+'</tc:OptanteSimplesNacional>'\r\n\tcString += '<tc:IncentivadorCultural>'+cIncCult+'</tc:IncentivadorCultural>'\r\n\tcString += '<tc:Status>'+\"1\"+'</tc:Status>'\r\n\t//cString += '<tc:RpsSubstituido>'\r\n\t//cString += '<tc:Numero>'+ConvType(Val(aNotaServ[02]),15)+'</tc:Numero>'\r\n\t//cString += '<tc:Serie>'+AllTrim(aNotaServ[01])+'</tc:Serie>'             \r\n\t//cString += '<tc:Tipo>'+cTipoRPS+'</tc:Tipo>'\r\n\t//cString += '</tc:RpsSubstituido>' \r\nEndIf\r\nReturn( cString )\r\n\r\nStatic Function NFSeServ(aISSQN,aRet,nDed,nIssRet,cRetIss,cServ,cMunPres,cModXml,cTpPessoa)\r\nLocal cString    := \"\"\r\nLocal nBase      := 0\r\nLocal nValLiq    := 0\r\nLocal nOutRet    := 0\r\n\r\n//Base de Cálculo \r\nnBase      := aISSQN[02]-nDed-aISSQN[06]\r\n//Valor Líquido\r\nIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\"  // Tratamento realizado para o municipio de Belo Horizonte- MG quando o Tomador for Órgão Público\r\n\tnValLiq    := aISSQN[02]-aRet[06]-aISSQN[06]-aISSQN[05]\r\nElse\r\n\tnValLiq    := aISSQN[02]-aRet[06]-aISSQN[06]\r\nEndIf\r\n//Outras retenções\r\nnOutRet    := aRet[06]-aRet[05]-aRet[04]-aRet[03]-aRet[02]-aRet[01]\r\n\r\nIf nOutRet > 0\r\n\tnOutRet:= nOutRet-nIssRet\r\nEndIf\r\n\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString += '<Servico>'\r\n\tcString += '<Valores>'\r\n\tcString += '<ValorServicos>'+ConvType(aISSQN[02],15,2)+'</ValorServicos>'\r\n\tcString += NfeTag('<ValorDeducoes>',ConvType(nDed,15,2))\r\n\tcString += NfeTag('<ValorPis>',ConvType(aRet[03],15,2))\r\n\tcString += NfeTag('<ValorCofins>',ConvType(aRet[04],15,2))\r\n\tcString += NfeTag('<ValorInss>',ConvType(aRet[05],15,2))\r\n\tcString += NfeTag('<ValorIr>',ConvType(aRet[01],15,2))\r\n\tcString += NfeTag('<ValorCsll>',ConvType(aRet[02],15,2))\r\n\tcString += '<IssRetido>'+cRetIss+'</IssRetido>'\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\"\r\n\t\tcString += NfeTag('<ValorIss>0.00</ValorIss>') \r\n\tElse\r\n\t\tcString += NfeTag('<ValorIss>',ConvType((aISSQN[05]),15,2)) \r\n\tEndIf\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\" \r\n\t\tcString += NfeTag('<ValorIssRetido>0.00</ValorIssRetido>') \r\n\tElse\r\n\t\tcString += NfeTag('<ValorIssRetido>',ConvType(nIssRet,15,2)) \r\n\tEndIf\r\n\tcString += NfeTag('<OutrasRetencoes>',ConvType(nOutRet,15,2))\r\n\tcString += '<BaseCalculo>'+ConvType(nBase,15,2)+'</BaseCalculo>'\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\" \r\n\t\tcString += NfeTag('<Aliquota>0.00</Aliquota>')\r\n\tElse\r\n\t\tcString += NfeTag('<Aliquota>',ConvType(aISSQN[04],5,2))\r\n\tEndIf\r\n\tcString += NfeTag('<ValorLiquidoNfse>',ConvType(nValLiq,15,2))\r\n\tcString += NfeTag('<DescontoIncondicionado>',ConvType((aISSQN[06]),15,2))\r\n\tIf SM0->M0_CODMUN == \"3106200\" .And. cTpPessoa == \"EP\" \r\n\t\tcString += NfeTag('<DescontoCondicionado>',ConvType((aISSQN[05]),15,2))\r\n\tEndIf\r\n\t//cString += '<DescontoCondicionado>'++'</DescontoCondicionado>'\r\n\tcString += '</Valores>'\r\n\t//cString += '<ItemListaServico>'+ConvType(StrTran(aISSQN[01],\".\",\"\"),4)+'</ItemListaServico>'\r\n\tcString += '<ItemListaServico>'+ConvType(aISSQN[01],5)+'</ItemListaServico>'\r\n\tcString += NfeTag('<CodigoCnae>',ConvType(aISSQN[03],7))\r\n\t//cString += '<CodigoTributacaoMunicipio>'+'710'+'</CodigoTributacaoMunicipio>'\r\n\tcString += '<CodigoTributacaoMunicipio>'+ConvType(aISSQN[07],20)+'</CodigoTributacaoMunicipio>'\r\n\tcString += '<Discriminacao>'+ConvType(cServ,2000)+'</Discriminacao>'\r\n\tcString += '<CodigoMunicipio>'+ConvType(cMunPres,7)+'</CodigoMunicipio>'\r\n\tcString += '</Servico>'\r\n\t\r\nElse //ISSNET\r\n\tcString += '<tc:Servico>'\r\n\tcString += '<tc:Valores>'\r\n\tcString += '<tc:ValorServicos>'+ConvType(aISSQN[02],15,2)+'</tc:ValorServicos>'\r\n\tcString += NfeTag('<tc:ValorDeducoes>',ConvType(nDed,15,2))\r\n\tcString += NfeTag('<tc:ValorPis>',ConvType(aRet[03],15,2))\r\n\tcString += NfeTag('<tc:ValorCofins>',ConvType(aRet[04],15,2))\r\n\tcString += NfeTag('<tc:ValorInss>',ConvType(aRet[05],15,2))\r\n\tcString += NfeTag('<tc:ValorIr>',ConvType(aRet[01],15,2))\r\n\tcString += NfeTag('<tc:ValorCsll>',ConvType(aRet[02],15,2))\r\n\tcString += '<tc:IssRetido>'+cRetIss+'</tc:IssRetido>'\r\n\tIf aISSQN[05] > 0\r\n\t\tcString += NfeTag('<tc:ValorIss>',ConvType((aISSQN[05]),15,2))\r\n\tElse\r\n\t\tcString += '<tc:ValorIss>0.00</tc:ValorIss>'\r\n\tEndIf\t\t\r\n\tcString += NfeTag('<tc:ValorIssRetido>',ConvType(nIssRet,15,2))\r\n\tcString += NfeTag('<tc:OutrasRetencoes>',ConvType(nOutRet,15,2))\r\n\tcString += '<tc:BaseCalculo>'+ConvType(nBase,15,2)+'</tc:BaseCalculo>'\r\n\tIf  aISSQN[04] > 0\t\r\n\t\tcString += NfeTag('<tc:Aliquota>',ConvType(aISSQN[04],5,2))\r\n\telse\r\n\t\tcString += '<tc:Aliquota>0.00</tc:Aliquota>'\r\n\tendif\t\t\r\n\tcString += NfeTag('<tc:ValorLiquidoNfse>',ConvType(nValLiq,15,2))\r\n\tcString += '<tc:DescontoIncondicionado>'+ConvType((aISSQN[06]),15,2)+'</tc:DescontoIncondicionado>'\r\n\tcString += '<tc:DescontoCondicionado>0</tc:DescontoCondicionado>'\r\n\tcString += '</tc:Valores>'\r\n\t//cString += '<tc:ItemListaServico>'+ConvType(StrTran(aISSQN[01],\".\",\"\"),4)+'</tc:ItemListaServico>'\r\n\tcString += '<tc:ItemListaServico>'+ConvType(aISSQN[01],4)+'</tc:ItemListaServico>'\r\n\tcString += NfeTag('<tc:CodigoCnae>',ConvType(aISSQN[03],7))\r\n\t//cString += '<tc:CodigoTributacaoMunicipio>'+'710'+'</tc:CodigoTributacaoMunicipio>'\r\n\tcString += '<tc:CodigoTributacaoMunicipio>'+ConvType(aISSQN[07],20)+'</tc:CodigoTributacaoMunicipio>'\r\n\tcString += '<tc:Discriminacao>'+ConvType(cServ,2000)+'</tc:Discriminacao>'\r\n\tcString += '<tc:MunicipioPrestacaoServico>'+Iif(Len(cMunPres) == 9,substr(cMunPres,3,7),ConvType(cMunPres,7))+'</tc:MunicipioPrestacaoServico>'\r\n\t//cString += '<tc:MunicipioPrestacaoServico>999</tc:MunicipioPrestacaoServico>'\r\n\tcString += '</tc:Servico>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NFSePrest(cModXml)\r\nLocal cString    := \"\"\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString +='<Prestador>'\r\n\tcString += '<Cnpj>'+SM0->M0_CGC+'</Cnpj>'\r\n\tcString += NfeTag('<InscricaoMunicipal>',ConvType(SM0->M0_INSCM))\r\n\tcString +='</Prestador>'\r\nElse //ISSNET\r\n\tcString +='<tc:Prestador>'\r\n\tcString +='<tc:CpfCnpj>'\r\n\tcString += '<tc:Cnpj>'+SM0->M0_CGC+'</tc:Cnpj>'\r\n\tcString +='</tc:CpfCnpj>'\r\n\tcString += NfeTag('<tc:InscricaoMunicipal>',ConvType(SM0->M0_INSCM))\r\n\tcString +='</tc:Prestador>'\r\nEndIf\r\nReturn(cString)\r\n\r\nStatic Function NFSeTom(aDest,cModXml,cMunPres)\r\nLocal cCPFCNPJ :=\"\"\r\nLocal cInscMun :=\"\"\r\nLocal cString  :=\"\"\r\n\r\n//Identifica Tipo\r\nIf RetPessoa(AllTrim(aDest[01]))==\"J\"\r\n\tcCPFCNPJ:=\"2\"\r\nElse\r\n\tcCPFCNPJ:=\"1\"\r\nEndIf\r\n//Identifica Inscricao\r\nIf AllTrim(cMunPres)==AllTrim(SM0->M0_CODMUN)\r\n\tcInscMun:=aDest[11]\r\nEndIf\r\n\r\nIf \"1\"$cModXml //BH - ABRASF\r\n\tcString +='<Tomador>'\r\n\tcString +='<IdentificacaoTomador>'\r\n\t//Estrangeiro não manda a tag de CPFCNPJ\r\n\tIf !\"EX\"$aDest[08]\r\n\t\tcString +='<CpfCnpj>'\r\n\t\t\tIf \"2\"$cCPFCNPJ\r\n\t\t\t\tcString += NfeTag('<Cnpj>',ConvType(aDest[01]))\r\n\t\t\tElse\r\n\t\t\t\tcString += NfeTag('<Cpf>',ConvType(aDest[01]))\r\n\t\t\tEndIf\r\n\t\tcString +='</CpfCnpj>'\r\n\tEndIf\r\n\tcString += NfeTag('<InscricaoMunicipal>',ConvType(cInscMun))\r\n\tcString +='</IdentificacaoTomador>'\r\n\tcString += NfeTag('<RazaoSocial>',ConvType(aDest[02],115))\r\n\t\r\n\tcString +='<Endereco>'\r\n\tcString += NfeTag('<Endereco>',ConvType(aDest[03],125))\r\n\tcString += NfeTag('<Numero>',ConvType(aDest[04],10))\r\n\tcString += NfeTag('<Complemento>',ConvType(aDest[05],60))\r\n\tcString += NfeTag('<Bairro>',ConvType(aDest[06],60))\r\n\tcString += NfeTag('<CodigoMunicipio>',ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[08]})][02]+aDest[07]))\r\n\tcString += NfeTag('<Uf>',ConvType(aDest[08]))\r\n\tcString += NfeTag('<Cep>',ConvType(aDest[09]))\r\n\tcString +='</Endereco>'\r\n\t\r\n\tcString +='<Contato>'\r\n\tcString += NfeTag('<Telefone>',AllTrim(ConvType(FisGetTel(aDest[10])[3],11)))\r\n\tcString += NfeTag('<Email>',ConvType(aDest[12],80))\r\n\tcString +='</Contato>'\r\n\tcString +='</Tomador>'\r\n\t\r\n\t//cString +='<Intermediario>'\r\n\t//cString += '<RazaoSocial>'+'</RazaoSocial>'\r\n\t//cString +='<CpfCnpj>'\r\n\t//cString += '<Cpf>'+'</Cpf>'\r\n\t//cString += '<Cnpj>'+'</Cnpj>'\r\n\t//cString +='</CpfCnpj>'\r\n\t//cString += '<InscricaoMunicipal>'+'</InscricaoMunicipal>'\r\n\t//cString +='</Intermediario>'\r\n\t\r\n\t//cString +='<Construcao>'\r\n\t//cString += '<CodigoObra>'+'</CodigoObra>'\r\n\t//cString += '<Art>'+'</Art>'  \r\n\t//cString +='</Construcao>'\r\n\tcString +='</InfRps>'\r\n\t\r\nElse //ISSNET\r\n\tcString +='<tc:Tomador>'\r\n\tcString +='<tc:IdentificacaoTomador>'\r\n\tcString +='<tc:CpfCnpj>'\r\n\tif \"EX\"$aDest[08]\r\n\t    cString += NfeTag('<tc:Cnpj>','99999999999999')\r\n\tElse\r\n\t\tIf \"2\"$cCPFCNPJ\r\n\t\t\tcString += NfeTag('<tc:Cnpj>',ConvType(aDest[01]))\r\n\t\tElse\r\n\t\t\tcString += NfeTag('<tc:Cpf>',ConvType(aDest[01]))\r\n\t\tEndIf\r\n\tEndIf\r\n\tcString +='</tc:CpfCnpj>'\r\n\tcString += NfeTag('<tc:InscricaoMunicipal>',ConvType(cInscMun))\r\n\tcString +='</tc:IdentificacaoTomador>'\r\n\tcString += NfeTag('<tc:RazaoSocial>',ConvType(aDest[02],115))\r\n\t\r\n\tcString +='<tc:Endereco>'\r\n\tcString += NfeTag('<tc:Endereco>',ConvType(aDest[03],125))\r\n\tcString += NfeTag('<tc:Numero>',ConvType(aDest[04],10))\r\n\tcString += NfeTag('<tc:Complemento>',ConvType(aDest[05],60))\r\n\tcString += NfeTag('<tc:Bairro>',ConvType(aDest[06],60))\r\n\tIf \"EX\"$aDest[08]\r\n\t\tcString += NfeTag('<tc:Cidade>','99999')\r\n\tElse\r\n\t\tcString += NfeTag('<tc:Cidade>',ConvType(aUF[aScan(aUF,{|x| x[1] == aDest[08]})][02]+aDest[07]))\r\n\tEndIf\r\n\r\n\tcString += NfeTag('<tc:Estado>',ConvType(aDest[08]))\r\n\tcString += NfeTag('<tc:Cep>',ConvType(aDest[09]))\r\n\tcString +='</tc:Endereco>'\r\n\t\r\n\tcString +='<tc:Contato>'\r\n\tcString += NfeTag('<tc:Telefone>',ConvType(aDest[10],11))\r\n\tcString += NfeTag('<tc:Email>',ConvType(aDest[12],80))\r\n\tcString +='</tc:Contato>'\r\n\tcString +='</tc:Tomador>'\r\n\t\r\n\t//cString +='<tc:Intermediario>'\r\n\t//cString += '<tc:RazaoSocial>'+'</tc:RazaoSocial>'\r\n\t//cString +='<tc:CpfCnpj>'\r\n\t//cString += '<tc:Cpf>'+'</tc:Cpf>'\r\n\t//cString += '<tc:Cnpj>'+'</tc:Cnpj>'\r\n\t//cString +='</tc:CpfCnpj>'\r\n\t//cString += '<tc:InscricaoMunicipal>'+'</tc:InscricaoMunicipal>'\r\n\t//cString +='</tc:Intermediario>'\r\n\t\r\n\t//cString +='<tc:Construcao>'\r\n\t//cString += '<tc:CodigoObra>'+'</tc:CodigoObra>'\r\n\t//cString += '<tc:Art>'+'</tc:Art>'  \r\n\t//cString +='</tc:Construcao>'\r\n\tcString +='</tc:InfRps>'\r\nEndIf\r\nReturn(cString)\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} LgxMsgNfs()\r\nFuncao que verifica os vinculos entre pedidos de venda e realiza o \r\ntratamento do texto do C5_MENNOTA quando a origem do PV é igual a 'LOGIX'\r\n\r\n@author Caio Murakami       \r\n@since 12.12.2012\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function LgxMsgNfs()\r\nLocal aAreaSC5\t:= SC5->( GetArea() )\r\nLocal aAreaSC6 := SC6->( GetArea() )\r\nLocal aArea\t\t:= GetArea()  \r\nLocal aPedVinc\t:= {} \r\nLocal nX \t\t:= 0 \r\nLocal cPedVinc\t:= \"\"  \r\nLocal cChave\t:= \"\"  \r\nLocal lAtuSC5\t:= .F. \r\nLocal cMsgNfs  := SC5->C5_MENNOTA\r\nLocal cNumPed \t:= SC5->C5_NUM \r\n\r\nIf SC6->( FieldPos(\"C6_PEDVINC\") ) > 0 .And. !Empty(SC6->C6_PEDVINC)  \r\n\t\r\n\tcPedVinc := SC6->C6_PEDVINC \r\n\t\t\r\n   SC5->( dbSetOrder(1) ) \r\n\tSC6->( dbSetOrder(1) )      \r\n\t\r\n\tIf SC5->( MsSeek( cChave := xFilial(\"SC5\") + cPedVinc ) )\t\r\n\t   \r\n\t   If SC6->( MsSeek( cChave )  )\r\n\t   \t//-- Percorre itens de pedido de venda relacionado o número do pedido com a NF , Série e Data\r\n\t   \tWhile SC6->( C6_FILIAL+C6_NUM ) == cChave .And.  !SC6->( Eof() ) \r\n\t   \t\t\r\n\t   \t\tIf !Empty(SC6->C6_NOTA)    \t\t\r\n\t   \t\t\tIf Ascan( aPedVinc, { | e | e[1]+e[2] == SC6->(C6_NOTA+C6_SERIE) } ) == 0\r\n\t\t   \t\t\tAadd( aPedVinc, { SC6->C6_NOTA , SC6->C6_SERIE , SC6->C6_DATFAT  }  ) \r\n\t\t   \t\tEndIf\r\n\t\t   \tEndIf\r\n\t\t   \t\t   \t\t\r\n\t   \t\tSC6->( dbSkip() )  \r\n\t   \t\t\r\n\t   \tEndDo\r\n\t   EndIf   \r\n\tEndIf \r\n\t//-- Atualiza mensagem do pedido, @N ( Numero da NF ) ; @S ( Série da NF) ; @D ( Data emissao )\r\n\tFor nX := 1 To Len(aPedVinc)\r\n\t\t\r\n\t\tcMsgNfs := StrTran( cMsgNfs , '@N' , aPedVinc[nX,1] \t\t \t,, 1 )\r\n\t\tcMsgNfs := StrTran( cMsgNfs , '@S' , aPedVinc[nX,2] \t\t \t,, 1 )\r\n\t\tcMsgNfs := StrTran( cMsgNfs , '@D' , dToC(aPedVinc[nX,3])\t,, 1 )\r\n\t\t\r\n\t\tIf At('@N' , cMsgNfs ) == 0\r\n\t\t\tlAtuSC5 := .T.\t \r\n\t\t\tExit\r\n\t\tEndIf\t\t\t\r\n\t\t\t   \r\n\tNext nX  \r\n\t\r\n\t//-- Atualiza C5_MENNOTA do pedido de venda posicionado inicialmente\r\n\tIf lAtuSC5 .And. SC5->( MsSeek( xFilial(\"SC5\") + cNumPed )   ) \r\n\t\tIf AllTrim(SC5->C5_MENNOTA) <> AllTrim(cMsgNfs)\r\n\t\t\tRecLock( \"SC5\" , .F. )\r\n\t\t\tSC5->C5_MENNOTA := cMsgNfs\r\n\t\t\tMsUnLock()\t\r\n\t\tEndIf\r\n\tEndIf\r\n  \r\nEndIf    \r\n \r\nRestArea( aAreaSC5 )\r\nRestArea( aAreaSC6 )\r\nRestArea( aArea    )\r\n\r\nReturn NIL  \r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} RetNfpVinc()\r\nFuncao que verifica se existe nota de NFP vinculada a Nota , e retorna o \r\narrey com as informações da nota de NFP\r\n\r\n@author Fernando Bastos       \r\n@since 03.01.2013\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function RetNfpVinc(cDocNFP,cSerieNFP,cForneceNFP,cLojaNFP)\r\n\r\nlocal nOrderSF1\t:= 0\r\nlocal nRecnoSF1\t:= 0\t\r\nlocal nOrderSD1\t:= 0\t\r\nlocal nRecnoSD1\t:= 0\r\n\r\nLocal aNfViRuNFP:={}\r\n\r\n\t// Realiza o backup do order e recno da SF1 e SD1\r\n\tnOrderSF1\t:= SF1->( indexOrd() )\r\n\tnRecnoSF1\t:= SF1->( recno() ) \r\n\t\r\n\tnOrderSD1\t:= SD1->( indexOrd() )\r\n\tnRecnoSD1\t:= SD1->( recno() )\r\n\t\t\r\n\tSD1->(dbSetOrder(1))\r\n\t\tIf SD1->(dbSeek(xFilial(\"SD1\")+SD1->D1_NFORI+SD1->D1_SERIORI))//D1_NFORI,D1_SERIORI\r\n   \t\t\t\tSF1->(dbSetOrder(1))\r\n   \t\t\t\tIf SF1->(dbSeek(xFilial(\"SF1\")+SD1->D1_DOC+SD1->D1_SERIE+SD1->D1_FORNECE+SD1->D1_LOJA) .And. AllTrim(SF1->F1_ESPECIE)==\"NFP\")\r\n\t   \t\t\taadd(aNfViRuNFP,{SD1->D1_EMISSAO,SD1->D1_SERIE,SD1->D1_DOC,SF1->F1_ESPECIE,;\r\n\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_CGC,SA2->A2_CGC),; \r\n\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_ESTENT,SA2->A2_EST),; \r\n\t\t\t\tIIF(SD1->D1_FORMUL==\"S\",SM0->M0_INSC,SA2->A2_INSCR)})\t\r\n\t\t\tEndif\r\n\t\tEndif\r\n   \t// Restaura a ordem e recno da SF1 e SD1\r\n\tSF1->( dbSetOrder( nOrderSF1 ) )\r\n\tSF1->( dbGoTo( nRecnoSF1 ) )\r\n\t\t\t        \r\n\tSD1->( dbSetOrder( nOrderSD1 ) )\r\n\tSD1->( dbGoTo( nRecnoSD1 ) )\r\n\t\t\t\t\t\t\t\t\r\nReturn (aNfViRuNFP) \r\n\r\n//------------------------------------------------------------------------\r\n/*/{Protheus.doc} MsgCliRsIcm\r\nFuncao que retorna a mensagem para ser colocada nos dados adicionais da NFe,\r\nreferente ao RICMS do RIO GRANDE do SUL:\r\nLivro II , Art.29 , Inciso VII, Alinea \"a\" numero 1\r\nLivro III, Art. 26 \r\n\r\n@author Rafael Iaquinto    \r\n@since 22.05.2013\r\n@version 1.0  \r\n\r\n@param\t\taICMS\t\tArray com informações referente ao ICMS proprio\r\n@param\t\taICMSST\tArray com informações referente ao ICMS-ST\r\n\t\t\t\r\n@return\tcMsg\t\tRetorna a Mensagem a ser utilizada.\t\r\n\r\n/*/\r\n//------------------------------------------------------------------------                                                        \r\nStatic Function MsgCliRsIcm(aICMS, aICMSST)\r\n\r\nLocal cMsg \t\t:= \"\"\r\n\r\nLocal nX\t\t\t:= \"\"\r\nLocal nValIcm\t\t:= 0\r\nLocal nValST\t\t:= 0 \r\nLocal nBaseIcm\t\t:= 0\r\nLocal nBaseST\t\t:= 0\r\n\r\nLocal lIcmsST\t\t:= .F.\r\nLocal lIcms\t\t:= .F.\r\nLocal lIcmsSemSt\t:= .F.\r\n\r\nFor nX := 1 to Len( aICMS )\r\n\t\r\n\tlIcms := .F.\r\n\t\r\n\tIf Len( aICMS[nX] ) > 0 .And. aICMS[nX][07] > 0\r\n\t\t\r\n\t\tnValIcm \t+= aICMS[nX][07] \r\n\t\tnBaseIcm\t+= aICMS[nX][05]\r\n\t\t\r\n\t\tif len( aICMSSt[nX] ) > 0 .and. aICMSSt[nX][07] > 0 \r\n\t\t\tnValST\t\t+= aICMS[nX][07] \r\n\t\t\tnBaseST\t+= aICMS[nX][05]\r\n\t\tendif\r\n\t\t\r\n\t\tlIcms := .T.\r\n\t\t\t\t\r\n\tEndIf\r\n\t\r\n\tIf Len( aICMSSt[nX] ) > 0 .And. aICMSSt[nX][07] > 0 \t\t\r\n\t\t\r\n\t\tlIcmsST := .T.\r\n\t\t\t\t\t\t\r\n\tElseIf lIcms .And. !lIcmsSemSt  \r\n\t\tlIcmsSemSt := .T.\r\n\tEndIF\r\n\t \t\r\nNext nX\r\n\r\nIf lIcmsSemSt .And. lIcmsST\r\n\r\n\tcMsg += \"Operações não sujeitas a Regime de ST, \"\r\n\tcMsg += \"Base de Cálculo do ICMS próprio: R$ \" + Alltrim( Str(nBaseIcm-nBaseST, 14, 2) )+ \", \"\r\n\tcMsg += \"Valor do ICMS próprio: R$ \" + Alltrim( Str(nValIcm-nValST, 14, 2) )+ \". \"\r\n\tcMsg += \"Operações sujeitas a Regime de ST, \" \t\t\t\r\n\tcMsg += \"Base de cálculo do ICMS próprio : R$ \" + Alltrim( Str(nBaseST, 14, 2) )+ \", \"\r\n\tcMsg += \"Valor do ICMS próprio: R$ \" + Alltrim( Str(nValST, 14, 2) )+ \". \"\r\n\t\r\nEndIf\r\n\r\n\r\nreturn cMsg\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} DocDatOrig\r\nFuncao criada para retornar para a função XmlNfeSef os valores da Nota Original quando houver controle de SubLote\r\n\r\n@param\t\tcNumLote\tNúmero do SubLote.\r\n@param\t\tcLoteClt\tNúmero do lote.\r\n@param \t\tcProduto   Codigo do produto\r\n\r\n\t\t\r\n@return\tnil\r\n\r\n@author\tEduardo Silva\r\n@since\t\t22/01/2014\r\n@version\t11.8\r\n/*/\r\n//-----------------------------------------------------------------------\r\n\r\nStatic Function DocDatOrig(cNumLote,cLoteCtl,cProduto)\r\n\r\nLocal aArea\t\t := GetArea()\r\n\r\nLocal cAliasSFT\t:= GetNextAlias()\r\nLocal cCliFor\t\t:= \"\"\r\nLocal cData\t\t:= \"\"\r\nLocal cLocCQ    \t:= PADR(SuperGetMV(\"MV_CQ\"),TAMSX3(\"D7_LOCAL\")[1])  //adequo o conteudo padrão \"98\" para \"98 \"\r\nLocal cLoja\t\t:= \"\"\r\nLocal cNfiscal\t\t:= \"\"\r\nLocal cNumCQ\t\t:= \"\"\r\nLocal cNfOrig\t\t:= \"\"\r\nLocal cSeek\t\t:= \"\"        \r\nLocal cSeek1\t\t:= \"\"        \r\nLocal cSerie\t\t:= \"\"\r\nLocal cSerieOri\t:= \"\"\r\n                     \r\ndbSelectArea(\"SB8\")\r\ndbSetOrder(2)\r\nif MsSeek(xFilial(\"SB8\")+cNumLote+cLoteCtl+cProduto)      \t\t\r\n\t\t\t\t\r\n\tdbSelectArea(\"SD7\")\r\n\tSD7->(dbSetOrder(1))\r\n\tcNumCQ := PADR(SB8->B8_DOC,LEN(SD7->D7_NUMERO))\t\t\t\t\t \t\t\r\n\tif SD7->(MsSeek(SB8->B8_FILIAL+cNumCQ+cProduto+cLocCQ))      \t\t\t\t\t\r\n\t\tcNfiscal\t:= SD7->D7_DOC\r\n\t\tcSerie \t\t:= SD7->D7_SERIE \r\n\t\tcCliFor\t:= SD7->D7_FORNECE\r\n\t\tcLoja \t\t:= SD7->D7_LOJA\r\n\telse\t\t\t\r\n\t\tcNfiscal\t:= SB8->B8_DOC\r\n\t\tcSerie\t\t:= SB8->B8_SERIE\r\n\t\tcCliFor\t:= SB8->B8_CLIFOR\r\n\t\tcLoja \t\t:= SB8->B8_LOJA \t\t\t\t\t\t\t\t\t\r\n\tendif\t\t\t\t\r\n\t\r\n\tcSeek\t:= cCliFor+cLoja+cSerie+cNfiscal\t\t\r\n\tcSeek1\t:= cNfiscal+cSerie+cCliFor+cLoja+cProduto+cLoteCtl+cNumLote\r\nendif\r\n\t\t\r\nif len (cSeek)>0 \r\n\t\t\t\r\n\tBeginSql Alias cAliasSFT\r\n\t\tSELECT FT_PRODUTO,FT_EMISSAO,FT_NFISCAL,FT_SERIE,FT_BASERET,FT_ICMSRET\r\n\t\t\tFROM %Table:SFT% SFT\r\n\t\t\tWHERE\r\n\t\t\tSFT.FT_FILIAL = %xFilial:SFT% AND\r\n\t\t\tSFT.%NotDel% AND \r\n\t\t\tFT_NFISCAL\t=%Exp:cNfiscal% AND\r\n\t\t\tFT_SERIE  \t=%Exp:cSerie% AND\r\n\t\t\tFT_TIPOMOV\t=%Exp:\"E\" % AND\r\n\t\t\tFT_CLIEFOR\t=%Exp:cCliFor% AND\r\n\t\t\tFT_LOJA\t=%Exp:cLoja% AND\r\n\t\t\tFT_ITEM\t=%Exp:SD1->D1_ITEM% AND \t\t\t\t\t\t\r\n\t\t\tFT_PRODUTO\t=%Exp:cProduto%\r\n\tEndSql\r\n\t\t\r\n\tif (cAliasSFT)->(!Eof()) \r\n\t\tcData \t\t:= (cAliasSFT)->FT_EMISSAO\r\n\t\tcNfOrig\t:= (cAliasSFT)->FT_NFISCAL\r\n\t\tcSerieOri\t:= (cAliasSFT)->FT_SERIE\t\r\n\tendif\r\n\t\t\r\n\t(cAliasSFT)->(DBCLOSEAREA())\r\n\t\r\nendif\r\n\r\nRestArea(aArea)\r\nReturn({dtoc(stod(cData)),cNfOrig,cSerieOri})\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} PercTrib\r\nRetorna a porcentagem a ser impresso no DANFE para a Lei Transparencia (Lei 12.741)\r\n\r\n\r\n@param\taProd\t\tContendo as informacoes do(s) produto(s).\r\n@param\tlProdItem\tIdentifica se a mensagem da Lei da Transparencia sera gerado\r\n\t\t\t\t\tno Produto e/ou informacoes complementares.\r\n@param\tcEnte\t\tEnte Tributante: 1-Federal / 2-Estadual / 3-Municipal\r\n@param  aNota\t\tContendo as informacoes da nota.\r\n\r\n@return cPercTrib Porcentagem do Tributo\r\n\r\n@author Douglas Parreja\r\n@since 26/06/2014\r\n@version 12\r\n/*/\r\n//-----------------------------------------------------------------------\r\n\r\nStatic Function PercTrib( aProd, lProdItem, cEnte, aNota ) \r\n\r\nLocal aArea\t\t\t:= GetArea()\r\nLocal aAreaSB1\t\t:= SB1->( GetArea() )\r\n\r\n//Local nAliquota\t\t:= 0\r\n//Local nTributo\t\t:= 0\r\n//Local nTotTrib\t\t:= 0\r\nLocal cPercTrib\t\t:= \"\"\r\nLocal nPos\t\t\t:= 30\r\nLocal nTotCargaTrib\t:= nTotalCrg\r\nLocal nAliq\t\t\t:= 0\r\n\r\nDefault aProd \t\t:= {}            \r\nDefault lProdItem \t:= .F.\r\nDefault cEnte\t\t:= \"\"\r\nDefault aNota\t\t:= {}\r\n\r\nIf lMvEnteTrb .And. ( cEnte $ \"1-2-3\" )\r\n\t\r\n\tIf cEnte == \"1\"\t// FEDERAL\r\n\r\n\t\tnPos \t\t\t:= 35\r\n\t\tnTotCargaTrib\t:= nTotFedCrg\r\n\r\n\tElseIf cEnte == \"2\"\t// ESTADUAL\r\n\r\n\t\tnPos\t\t\t:= 36\r\n\t\tnTotCargaTrib\t:= nTotEstCrg\r\n\r\n\tElse\r\n\r\n\t\tnPos \t\t\t:= 37\r\n\t\tnTotCargaTrib\t:= nTotMunCrg\r\n\r\n\tEndif\r\n\t\r\nEndif\r\n\r\nIf lProdItem\r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1) // B1_FILIAL+B1_COD\r\n\t\r\n\tIf dbSeek( xFilial(\"SB1\") + AllTrim( aProd[2] ) )\r\n\t\r\n\t\tnAliq\t:= LeiTransp(nPos,aProd, aNota)\r\n\t\tcPercTrib := ConvType( nAliq * 100 , 15, 2 )\r\n\t\t\r\n\t /*\t\r\n\txRetVal := AlqLei2741(aProd[5],aProd[6],SB1->B1_CODISS,SA1->A1_EST,SA1->A1_COD_MUN,aProd[2],aProd[1],SD2->D2_NUMLOTE,SD2->D2_LOTECTL,cMvFisCTrb,cMvFisAlCT,lMvFisFRas)\t\r\n\t\r\n\t\tIf ValType(xRetVal)== \"A\"\r\n\t\t\tcPercTrib := ConvType( xRetVal[1], 15, 2 )\r\n\t\tElseIf ValType(xRetVal)== \"N\"\r\n\t\t\tcPercTrib := ConvType( xRetVal, 15, 2 )\r\n\t\tEndIf\r\n\t\t\r\n\t\tnAliquota\t:= AlqLeiTran( \"SB1\", \"SBZ\" )[1]    \r\n\t\tnTributo\t:= ConvType( ( aProd[nPos] * nAliquota ) / 100, 15, 2 )\r\n\t\tnTotTrib\t:= Val( nTributo )\r\n\t\r\n\t\tcPercTrib\t:= ConvType( ( nTotTrib / aProd[10] ) * 100, 15, 2 )*/\r\n\t\r\n\tEndif\r\n\r\nElse\r\n\r\n\tcPercTrib\t:= ConvType( ( nTotCargaTrib / nTotNota ) * 100, 15, 2 )\r\n\r\nEndIf\t\r\n\t\r\nRestArea( aAreaSB1 )\r\nRestArea( aArea )\t\r\n\r\nReturn cPercTrib\r\n\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} LeiTransp\r\nRetorna a porcentagem a ser impresso no por documento gerado \r\nDANFE para a Lei Transparencia (Lei 12.741) \r\n\r\n\r\n@param\tnPos \tPosição ref. Aliq. Tributante: 30 - Aliquota Total\r\n\t\t\t\t\t\t\t35-Federal / 36-Estadual / 37-Municipal\r\n\r\n@return nAliq\t\tAliquota do Produto\r\n\r\n@author Douglas Parreja\r\n@since 19/12/2014\r\n@version 11.80\r\n/*/\r\n//-----------------------------------------------------------------------\r\n\r\nStatic Function LeiTransp (nPos,aProd,aNota)\r\n\r\nLocal nAliq := 0\r\nLocal aAreaSD2 := SD2->( GetArea() )\r\n\r\nDefault nPos\t:= 30\r\nDefault aProd :={}\r\nDefault aNota :={}\r\n\r\nDbSelectArea(\"SD2\")\r\nDbSetOrder(3) // D2_FILIAL+D2_DOC+D2_SERIE\r\n\r\nIf len(aProd) > 36 .and. len(aNota) > 1 .and. MsSeek( xFilial(\"SD2\") + PADR(aNota[2],TAMSX3(\"D2_DOC\")[1]) + PADR(aNota[1],TAMSX3(\"D2_SERIE\")[1]))\r\n\tnAliq := aProd[nPos] /  (SD2->D2_VALBRUT + SD2->D2_DESCON)\r\nEndif\t\r\n\r\nRestArea(aAreaSD2)\r\n\r\nReturn nAliq\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} DevCliEntr\r\nVerifica se nota de devolução utiliza cliente de entrega da nota de origem.\r\n\r\n@param\tcAliasSD1 Alias corrente do arquivo temp utilizado para a SD1\r\n\r\n@return lRet\t\tVerdadeiro se nota de devolucao utiliza cliente de entrega.\r\n\r\n@author Fabricio Romera\r\n@since 13/11/2015\r\n@version 11.80\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function DevCliEntr(cAliasSD1)\r\nLocal aArea    := GetArea()\r\nLocal aAreaSF2 := SF2->(GetArea())\r\nLocal lRet     := .F.\r\n\r\nDbSelectArea(\"SF2\")\r\nDbSetOrder(1)\r\nIf SF2->( DbSeek(xFilial(\"SF2\")+(cAliasSD1)->D1_NFORI+(cAliasSD1)->D1_SERIORI) )\r\n\tIf SF2->F2_CLIENTE <> SF1->F1_FORNECE .And. SF2->F2_CLIENT = SF1->F1_FORNECE\r\n\t\tlRet := .T.\r\n\tEnd If\r\nEnd If\r\n\r\nRestArea(aAreaSF2)\r\nRestArea(aArea)\r\nReturn lRet\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} ComplPreco\r\nVerifica se nota de complemento de preco e se a nota origem está na base\r\n@param\taAreaSDx Alias corrente do arquivo temp utilizado para a SD2/SD1\r\n@param\taAreaSFx Alias corrente do arquivo temp utilizado para a SF2/SF1\r\n@return Valor das tags vUnCom , vUnTrib\r\n@author Cleiton Genuino\r\n@since 24/11/2015\r\n@version 11.80\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function ComplPreco(cTipo,cF2Tipo,aProd)\r\nLocal aArea    := GetArea()\r\nLocal aAreaSDx := iif (cTipo== \"1\",SD2->(GetArea()),SD1->(GetArea()))\r\nLocal aAreaSFx := iif (cTipo== \"1\",SF2->(GetArea()),SF1->(GetArea()))\r\nLocal vComPreco  := \"0\"\r\nDefault cTipo   := \"\"\r\nDefault cF2Tipo := \"\"\r\nDefault aProd   := {}\r\nIF cTipo == \"1\" .And. cF2Tipo == \"C\" .And. len (aProd) > 0 .And. SF2->F2_TPCOMPL <> \"2\"\r\n\tDbSelectArea(\"SD2\")\r\n\tDbSetOrder(3)//D2_FILIAL, D2_DOC, D2_SERIE, D2_CLIENTE, D2_LOJA, D2_COD, D2_ITEM,\r\n\tIf SD2->( DbSeek(xFilial(\"SD2\")+ SD2->D2_DOC + SD2->D2_SERIE ))\r\n\t\tIf !Empty(SD2->D2_NFORI).And. !Empty(SD2->D2_SERIORI) .And. !Empty(SD2->D2_ITEMORI)\r\n\t\t\tDbSelectArea(\"SF2\")\r\n\t\t\tDbSetOrder(1)//F2_FILIAL, F2_DOC, F2_SERIE, F2_CLIENTE, F2_LOJA, F2_FORMUL, F2_TIPO,\r\n\t\t\tIF SF2->( DbSeek(xFilial(\"SF2\")+ SD2->D2_NFORI + SD2->D2_SERIORI ))\r\n\t\t\tIf !Empty(SF2->F2_CHVNFE) .And. len (SF2->F2_CHVNFE)== 44\r\n\t\t\t\tvComPreco  :=ConvType(aProd[10],15,2)\r\n\t\t\t\tEndIF\r\n\t\t\tEndIF\r\n\t\tEndif\r\n\tEndIf\r\nElse\r\n\tvComPreco := ConvType(aProd[10]/aProd[12],21,8)\r\nEndIF\r\nRestArea(aAreaSDx)\r\nRestArea(aAreaSFx)\r\nRestArea(aArea)\r\nReturn vComPreco\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfeAutXml\r\nFunção que monta o grupo autXML da NFe\r\n\r\n@param\t\tcAutXml\t String com os CPFs/CNPJs autorizados a visualizar \r\n\t\t\t\t\t\t o xml\r\n@return\tcString\t String contendo o grupo autXML  \r\n\r\n@author Natalia Sartori\r\n@since 21/12/2015\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeAutXml(cAutXml)\r\n\r\nLocal cString := \"\"\r\nLocal cSeparador := \";\"\r\nLocal cConteudo\t:= \"\"\r\nLocal nAt\t:= 0\r\nLocal nX\t:= 0\r\nLocal aAux :={}\r\n\r\n\r\nIf cSeparador $ cAutXml\r\n\tnAt:= at(cSeparador,cAutXml)\r\n\tWhile nAt > 0\r\n\t\tcConteudo := Substr(cAutXml,1,nAt-1)\r\n\t\taadd(aAux,{cConteudo})\r\n\t\tcAutXml:= Substr(cAutXml,nAt+1)\r\n\t\tnAT := at(cSeparador,cAutXml)\r\n\tEndDo\r\n\tIf !Empty(cAutXml)\r\n\t\taadd(aAux,{cAutXml})\r\n\tEndIf\r\nElse\r\n\taadd(aAux,{cAutXml})\r\nEndIf\r\n\r\nIf Len(aAux) > 0 .and. !Empty(aAux[1][1])\r\n\tFor nX := 1 to Len( aAux )\r\n\t\tcString += '<autXML>'\r\n\t\tIf Len(aAux[nX][1])== 14\r\n\t\t\tcString += '<CNPJ>'+aAux[nX][1]+'</CNPJ>'\r\n\t\tElseIf Len(aAux[nX][1])== 11\r\n\t\t\tcString += '<CPF>'+aAux[nX][1]+'</CPF>'\r\n\t\tEndIf\r\n\t\tcString += '</autXML>'\r\n\tNext nX\t\r\nEndIf\r\n\r\nReturn(cString)\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfeCodANP\r\nFunção que verifica se o código ANP permitido para gerar o grupo ICMSUFDes para\r\nnão ocorrer a  Rejeição. 695 :Informado indevidamente o grupo de ICMS para a UF de destino.\r\n\r\n@param\t\tNil  \r\n@return    cString\tString contendo os codigos ANP permitidos para gerar o grupo ICMSUFDes.\r\n                       \r\n                        Operação com combustível (tag:comb) derivado de petróleo:\r\n                        código ANP diferente de: \r\n                        820101001, 820101010, 810102001,810102004, 810102002, 810102003, 810101002, 810101001,\r\n                        810101003, 220101003, 220101004, 220101002, 220101001,220101005, 220101006, 560101001\r\n@author Valter da silva\r\n@since 11/02/2016\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeCodANP()\r\n\r\nLocal cRetorno \t:= \"\"\r\nLocal cPipe \t\t:= \"-\"\r\n\r\n\tcRetorno += \"820101001\" + cPipe \r\n\tcRetorno += \"820101010\" + cPipe \r\n\tcRetorno += \"810102001\" + cPipe \r\n\tcRetorno += \"810102004\" + cPipe \r\n\tcRetorno += \"810102002\" + cPipe \r\n\tcRetorno += \"810102003\" + cPipe \r\n\tcRetorno += \"810101002\" + cPipe \r\n\tcRetorno += \"810101001\" + cPipe \r\n\tcRetorno += \"810101003\" + cPipe \r\n\tcRetorno += \"220101003\" + cPipe \r\n\tcRetorno += \"220101004\" + cPipe \r\n\tcRetorno += \"220101002\" + cPipe \r\n\tcRetorno += \"220101001\" + cPipe \r\n\tcRetorno += \"220101005\" + cPipe \r\n\tcRetorno += \"220101006\" + cPipe\r\n\tcRetorno += \"560101001\" + cPipe\r\n\t\r\nReturn cRetorno\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfMultCup\r\nRetorna array com cupons relacionados a nota sobre cupom\r\n\r\n@param\taItemCup\tArray com itens separados por cupom referenciado\r\n@param\tcSerie\t\tSerie da nota atual\r\n@param\tcNota\t\tNumero da nota atual\r\n@param\tcClieFor\tCliente/Fornecedor da nota atual\r\n@param\tcLoja\t\tLoja da nota atual\r\n\r\n@return aRet\t\tArray com cupons referenciados na NF\r\n\r\n@author Leonardo Kichitaro\r\n@since 24/06/2015\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfMultCup(aItemCup, cSerie, cNota, cClieFor, cLoja)\r\n\r\nLocal aRet\t\t\t:= {}\r\nLocal nX\t\t\t:= 0\r\n\r\nDefault aItemCup\t:= {}\r\nDefault cSerie\t\t:= \"\"\r\nDefault cNota\t\t:= \"\"\r\nDefault cClieFor\t:= \"\"\r\nDefault cLoja\t\t:= \"\"\r\n\r\nIf Len(aItemCup) == 0\r\n\taAdd(aRet,{cSerie, cNota, cClieFor, cLoja})\r\nElse\r\n\tFor nX := 1 To Len(aItemCup)\r\n\t\tIf Len(aRet) == 0 .Or. aScan(aRet,{|x| x[1]+x[2]+x[3]+x[4] == aItemCup[nX][3]+aItemCup[nX][2]+aItemCup[nX][5]+aItemCup[nX][6]}) == 0\r\n\t\t\taAdd(aRet,{aItemCup[nX][3], aItemCup[nX][2], aItemCup[nX][5], aItemCup[nX][6]})\r\n\t\tEndIf\r\n\tNext\r\nEndIf\r\n\r\nReturn aRet\r\n\r\n//--------------------------------------------------------------------\r\n\r\n/*/{Protheus.doc}NfeMFECOP\r\nFunção  para gerar a mensagem do FECP  por estado -DF - MG - PR - RJ - RS \r\n         utilizado em informacoes complementares da nota\r\n      \r\n@param\t\tnVfecp\t      Valor numérico do FECOP referente ao valor total\r\n@param\t\tnVfecp\t      Estado da Filial Corrente.\r\n@param\t\tcFinalid  //'1' Retorna a mensagem no campo \"Informações Complementares\"\r\n                       //'2' Retorna a mensagem no campo \"Informação Adicional do Produto\"\r\n                     \r\n@return    cString\tString contendo a mensagem  \"Informações Complementares\" \r\n                        ou \"Informação Adicional do Produto Conforme o cFinalid \"\r\n\r\n                       \r\n@author Valter da silva\r\n@since 14/11/2016\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeMFECOP(nVfecp,cEstado,cDestDanf,aICMS,aICMSST,cVerAmb)\r\n\r\nlocal cMensFcop\t:= \"\"\r\nlocal cMensPadr := \"\"\r\nlocal cMensICMS := \"\"\r\nlocal cMensST\t:= \"\"\r\nLocal nX\t\t:= \"\"\r\nLocal nBaseIcm\t:= 0\r\nLocal nBaseST\t:= 0\r\nLocal nPerc\t\t:= 0\r\nLocal nValor\t:= 0\r\n\r\nDefault nVfecp := 0\r\nDefault cDestDanf     := \"1\"\r\nDefault cEstado      := \"\"\r\nDefault aICMS     := {}\r\nDefault aICMSST   := {}\r\nDefault cVerAmb   := \"\"\r\n\r\nDo Case\r\n  // MG: \"Arquivo Decreto nº 46.927, de 29 de dezembro de 2015.docx\", página 3:\r\n  //Art. 6º Nas operações sujeitas ao adicional de alíquota, o contribuinte indicará no campo “Informações \r\n  //Complementares” da nota fiscal a expressão “Adicional de alíquota – Fundo de Erradicação da Miséria\r\n  //” acompanhada do respectivo valor.\r\n\tCase cEstado== \"MG\"   // Tratamento legado de FECP\r\n\t\tIf  cDestDanf =='1'\r\n\t\t\tcMensFcop := \"Adicional de alíquota - Fundo de Erradicação da Miséria - R$ \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t   EndIf\r\n\t   \t\r\n\t//Case cEstado== \"PR\" \r\n\tCase cEstado== \"PR\" \r\n\t\t//PR: Arquivo \"Decreto Nº 3.339, de 20 de janeiro de 2016 - FECOP a partir de 01-02-2016.doc\", página 4:\r\n    \t//Art. 6º - Na Nota Fiscal Eletrônica - NF-e, modelos 55 ou 65, emitida para acobertar as operações com os produtos de que trata o art. 1º, deverá constar:\r\n    \t//I - o valor numérico do FECOP referente a cada item, no campo \"Informação Adicional do Produto\", com o seguinte formato: ##FECOP<N.\r\n    \t//NN>##, onde N.NN é o valor numérico do FECOP referente a cada item, com duas casas decimais, separadas por ponto, sem separador de milhar;\r\n    \t//II - o valor numérico do FECOP referente ao valor total, no campo \"Informações Complementares\", com o seguinte formato: ##FECOP<N.\r\n    \t//NN>##, onde N.NN é o valor numérico do FECOP referente ao valor total, com duas casas decimais, separadas por ponto, sem separador de milhar.  cValToChar(nVfecp)  \r\n\t\tIf  cDestDanf =='1' \r\n\t    \tcMensFcop := \"O valor numerico do FECOP referente ao valor total R$ \" + cValToChar(nVfecp)\r\n\t    ElseIf cDestDanf =='2'\r\n\t       cMensFcop := \"O valor numerico do FECOP referente a cada item R$ \" + cValToChar(nVfecp)\r\n\t    EndIf\r\n\t                \r\n\tCase cEstado== \"RJ\"\r\n    \tIf  cDestDanf =='1'\r\n\t\t\tcMensFcop := \"Adicional de alíquota - Fundo Estadual de Combate à Pobreza e às Desigualdades Sociais (FECP) - \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t    EndIf\r\n\t   \r\n\tCase cEstado== \"RS\" \r\n\t\tIf  cDestDanf =='1'\r\n\t    \tcMensFcop := \"Adicional de alíquota relativo ao AMPARA/RS, criado pela Lei nº 14.742/15 - R$ \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\")) \r\n\t\tEndIf\r\n\t\r\n\tOtherWise     \r\n\t\r\n\t\tIF cDestDanf =='1'\r\n\t\t\tIf\tcVerAmb == \"3.10\"\r\n\t\t\t\tcMensFcop  := \"Adicional de alíquota - Fundo Estadual de Combate à Pobreza e às Desigualdades Sociais (FECP) - \" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t\t\tElse\r\n\t\t\t\tcMensFcop  := \"Adicional de alíquota - Fundo Estadual de Combate à Pobreza e às Desigualdades Sociais  - R$\" + Alltrim(Transform(nVfecp,\"@E 999,999,999.99\"))\r\n\t\t\tEndIf\r\n  \t\tEndIf\r\n  \tEndCase\r\n\t\r\n\tIF cVerAmb == \"4.00\" \r\n\t\r\n\t\tcMensPadr:= \"(FCP):\"+ cMensFcop\r\n\r\n\t\tIf cDestDanf =='1' // Informação do fisco <infAdFisco> para fecp\r\n\t\t\tnBaseIcm:=0\r\n\t\t\tnValor  :=0\r\n\t\t\tnPerc   :=0\r\n\t\t\tFor nX := 1 to Len( aICMS )\r\n\t\t\t\tIf Len( aICMS[nX] ) > 0 .And. aICMS[nX][16] > 0 .And.  aICMS[nX][17] > 0 .And. aICMS[nX][18] > 0  \r\n\t\t\t\t\tnBaseIcm\t:= nBaseIcm +  aICMS[nX][16] \r\n\t\t\t\t\tnValor\t\t:= nValor   +  aICMS[nX][18] \r\n\t\t\t\t\tnPerc \t\t:= aICMS[nX][17]\r\n  \t\t\t\tEndIf\r\n  \t\t\tNext nX\r\n  \t\t\t\r\n  \t\t\tIf  nBaseIcm > 0 .and.  nPerc > 0\r\n  \t\t\t\tcMensICMS := AllTrim(\" Base R$ \"+ConvType(nBaseIcm,13,2)+\" Perc.(\"+ConvType(nPerc)+\"%)\")\r\n  \t\t\t\tcMensFcop := cMensPadr +\" \"+cMensICMS\r\n  \t\t\tEndIf  \r\n  \t\t\t\r\n  \t\t\tnBaseST:=0\r\n\t\t\tnValor :=0\r\n\t\t\tnPerc  :=0\r\n  \t\t\tFor nX := 1 to Len( aICMSSt )\r\n\t\t\t\tIf Len( aICMSSt[nX] ) > 0 .And. aICMSSt[nX][13] > 0 .And.  aICMSSt[nX][14] > 0 .And. aICMSSt[nX][15] > 0  \r\n\t\t\t\t\tnBaseST\t:= nBaseST  +  aICMSSt[nX][13]\r\n\t\t\t\t\tnValor\t\t:= nValor   +  aICMSSt[nX][15] \r\n\t\t\t\t\tnPerc     \t:= aICMSSt[nX][14]   \r\n\t\t\t\t\t\r\n  \t\t\t\tEndIf\r\n  \t\t\tNext nX \r\n  \t\t\t\r\n  \t\t\tIf\tnBaseST > 0 .and.  nPerc > 0\r\n  \t\t\t  \tcMensST := \"(FCPST): \"+AllTrim(\"Base R$ \"+ConvType(nBaseST,13,2)+\" Perc.(\"+ConvType(nPerc)+\"%)\")\r\n  \t\t\t\tcMensFcop := \tcMensPadr +\" \"+cMensICMS+\" \"+cMensST\r\n  \t\t\tEndIf\r\n  \t\t\t\t \r\n  \t\telseIf  cDestDanf =='2' // Informação do fisco <indAdProd> para fecp\r\n  \t\t\tIf Len(aICMS) > 0 \r\n      \t\t\tIf  (aICMS[16] > 0 .or. aICMS[17] > 0 .or.  aICMS[18] > 0)\r\n      \t\t\t\tIf cEstado <> \"PR\" \r\n      \t\t\t\t\tcMensICMS := AllTrim(\"Base R$ \"+ConvType(aICMS[16],13,2)+\" Perc.(\"+ConvType(aICMS[17])+\"%) Vlr. R$ \" + ConvType(aICMS[18],13,2))\r\n  \t\t\t\t\t\tcMensFcop := cMensPadr + \" \" + cMensICMS\r\n  \t\t\t\t\tElse\r\n  \t\t\t\t\t\tcMensICMS := AllTrim(\"Base R$ \"+ConvType(aICMS[16],13,2)+\" Perc.(\"+ConvType(aICMS[17])+\"%)\")\r\n  \t\t\t\t\t\tcMensFcop := cMensPadr + \" \" + cMensICMS\r\n  \t\t\t\t\tEndIf \r\n  \t\t\t\tEndIf\r\n  \t\t\tEndIf\r\n  \t\t\t\r\n  \t\t\tIf Len(aICMSSt) > 0 \r\n  \t\t\t\tIf  (aICMSST[13] > 0 .or. aICMSST[14] > 0 .or.  aICMSST[15] > 0)\r\n  \t\t\t\t\tIf cEstado <> \"PR\"  // Para PR. não enviamos o valor \r\n  \t\t\t\t\t\tcMensST := \"(FCPST): \" + AllTrim(\"Base R$ \"+ConvType(aICMSST[13],13,2)+\" Perc.(\"+ConvType(aICMSST[14])+\"%) Vlr. R$ \" + ConvType(aICMSST[15],13,2))\r\n  \t\t\t\t\t\tcMensFcop := \tcMensPadr +\" \"+cMensICMS+\" \"+cMensST\r\n  \t\t\t\t\tElse\r\n  \t\t\t\t\t\tcMensST := \" (FCPST): \" + AllTrim(\"Base R$ \"+ConvType(aICMSST[13],13,2)+\" Perc.(\"+ConvType(aICMSST[14])+\"%)\")\r\n  \t\t\t\t\t\tcMensFcop := cMensPadr +\" \"+cMensICMS+\" \"+cMensST\r\n  \t\t\t\t\tEndIf\r\n  \t\t\t\tEndIf\t\r\n  \t\t\tEndIf\r\n  \t\tEndIf\t  \r\n  \tEndIf\r\n  \t\r\nReturn cMensFcop\r\n\r\n//---------------------------------------------------------------------------\r\n/*/{Protheus.doc} MsgCliDFIcm\r\nFuncao que retorna a mensagem para ser colocada nos dados adicionais da NFe.\r\nTratamento legislacao do DF, quando existir intes com ICMS-ST e intens somente com ICMS  próprio\r\n\r\n@author Valter Da Silva   \r\n@since 14.11.2016\r\n@version 1.0  \r\n\r\n@param\t\taICMS\t\tArray com informações referente ao ICMS proprio\r\n@param\t\taICMSST\tArray com informações referente ao ICMS-ST\r\n\t\t\t\r\n@return\tcMsg\t\tRetorna a Mensagem a ser utilizada.\t\r\n\r\n/*/\r\nStatic Function MsgCliDFIcm(aICMS, aICMSST, lNCMOk)\r\n\r\nLocal cMsg \t\t:= \"\"\r\n\r\nLocal nX\t\t\t:= \"\"\r\nLocal nValIcm\t\t:= 0\r\nLocal nValST\t\t:= 0 \r\nLocal nBaseIcm\t\t:= 0\r\nLocal nBaseST\t\t:= 0\r\n\r\nLocal lIcmsST\t\t:= .F.\r\nLocal lIcms\t\t:= .F.\r\nLocal lIcmsSemSt\t:= .F.\r\nDEFAULT aICMS  \t:= {}\r\nDEFAULT aICMSST \t:= {}\r\n\r\nDEFAULT lNCMOk\t\t:= .F.\r\n\r\nFor nX := 1 to Len( aICMS )\r\n\t\r\n\tlIcms := .F.\r\n\t\r\n\tIf Len( aICMS[nX] ) > 0 .And. aICMS[nX][07] > 0\r\n\t\t\r\n\t\tnValIcm \t+= aICMS[nX][07] \r\n\t\tnBaseIcm\t+= aICMS[nX][05]\r\n\t\t\r\n\t\tif len( aICMSSt[nX] ) > 0 .and. aICMSSt[nX][07] > 0 \r\n\t\t\tnValST\t\t+= aICMSST[nX][07]\r\n\t\t\tnBaseST\t+= aICMSST[nX][05]\r\n\t\tendif\r\n\t\t\r\n\t\tlIcms := .T.\r\n\t\t\t\t\r\n\tEndIf\r\n\t\r\n\tIf Len( aICMSSt[nX] ) > 0 .And. aICMSSt[nX][07] > 0 \t\t\r\n\t\t\r\n\t\tlIcmsST := .T.\r\n\t\t\t\t\t\t\r\n\tElseIf lIcms .And. !lIcmsSemSt  \r\n\t\tlIcmsSemSt := .T.\r\n\tEndIF\r\n\t \t\r\nNext nX\r\n\r\nIf  lIcmsST .And. lNCMOk\r\n\tcMsg +=\"Valor das operações sujeitas ao adicional:: R$  \" + Alltrim( Str(nBaseST, 14, 2) ) \r\n\tcMsg +=\" O valor corresponde à base de cálculo do ICMS ST\"\r\nEndIf\r\n\r\nReturn cMsg\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} retUn2UM\r\nRetorna a unidade da 2a. Unidade de Medida \r\n\r\n@author Sergio S. Fuzinaka\r\n@since 12.07.2017\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\nStatic Function retUn2UM( lNoImp2UM, cCFOPExp, cCFOP, cUMDIPI, cUM)\r\n\r\nLocal cReturn := \"\"\r\n\r\n// Tratamento para operacoes dentro do País\r\nIf lNoImp2UM\r\n   If ( Left(cCFOP,1) $ \"3-7\" ) .Or. ( cCFOP $ cCFOPExp )\r\n      If !Empty( cUMDIPI )\r\n         cReturn := cUMDIPI\r\n      Else\r\n         cReturn := cUM\r\n      Endif\r\n   Else\r\n      cReturn := cUM\r\n   Endif\r\nElse\r\n   If !Empty( cUMDIPI )\r\n      cReturn := cUMDIPI\r\n   Else\r\n      cReturn := cUM\r\n   Endif\r\nEndif\r\n\r\nReturn( cReturn )\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} retQtd2UM\r\nRetorna a quantidade da 2a. Unidade de Medida\r\n\r\n@author Sergio S. Fuzinaka\r\n@since 12.07.2017\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\nStatic Function retQtd2UM( lNoImp2UM, cCFOPExp, cCFOP, nCONVDIP, nQUANT)\r\n\r\nLocal nReturn := 0\r\n\r\n// Tratamento para operacoes dentro do País\r\nIf lNoImp2UM\r\n   If ( Left(cCFOP,1) $ \"3-7\" ) .Or. ( cCFOP $ cCFOPExp )\r\n      If nCONVDIP > 0\r\n         nReturn := ( nCONVDIP * nQUANT )\r\n      Else\r\n         nReturn := nQUANT\r\n      Endif\r\n   Else\r\n      nReturn := nQUANT\r\n   Endif\r\nElse\r\n   If nCONVDIP > 0\r\n      nReturn := ( nCONVDIP * nQUANT )\r\n   Else\r\n      nReturn := nQUANT\r\n   Endif\r\nEndif\r\n\r\n//O valor é limitado a 4 casas deciamais \r\n//porque o Schema(.XSD) da Sefaz nao aceita mais que 4 casas\r\nnReturn := NoRound(nReturn,5) //bruno alterado de 4 para 5\r\n\r\nReturn( nReturn )\r\n\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} NfePag\r\nRetorna o grupo da forma de pagamento.\r\n@author Valter da Silva\r\n@since 26.03.2018\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\n\r\nStatic Function NfePag(aDetPag)\r\nLocal cString    := \"\"\r\nLocal nX         := 0  \r\nLocal nTroco     := 0 \r\nDefault aDetPag  := {}\r\n\r\nIF len(aDetPag) > 0  \r\n\tcString +='<pagamento>'\r\n\tFor nX := 1 To Len(aDetPag)\r\n\t\tcString +='<detPag>'\r\n\t\tcString += '<indForma>'+aDetPag[nX][8]+'</indForma>'\r\n\t\tcString +='<forma>'+aDetPag[nX][1]+'</forma>' \r\n\t\tIf aDetPag[nX][1] == \"90\" //SEM PAGAMENTO\r\n\t\t\tcString +='<valor>'+ConvType(0,15,2)+'</valor>'\r\n\t\telse\r\n\t\t\tcString +='<valor>'+ConvType(aDetPag[nX][2],15,2)+'</valor>'\r\n\t\tEndIf\r\n\t\t\r\n\t\tIf Len(aDetPag[nX]) > 3 \r\n\t\t\tIF\t!empty(aDetPag[nX][4]) .and. aDetPag[nX][1] $ '03-04'\r\n\t\t\t\tcString += '<cartoes>'\r\n\t\t\t\tcString += '<tpIntegra>' +aDetPag[nX][4]+ '</tpIntegra>'\r\n\t\t\t\tcString += '<cnpj>'+aDetPag[nX][5]+ '</cnpj>'\r\n\t\t\t\tcString += '<bandeira>'+aDetPag[nX][6]+'</bandeira>'\r\n\t\t\t\tcString += '<autorizacao>'+aDetPag[nX][7]+'</autorizacao>'\r\n\t\t\t\tcString += '</cartoes>'\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\tcString +='</detPag>'\r\n\t\tnTroco  += aDetPag[nX][3]\r\n\tNext    \t\r\n\tcString +='<vTroco>'+ConvType(nTroco,15,2)+'</vTroco>'\r\n\tcString +='</pagamento>'\r\nEndIf\r\nReturn(cString)\r\n\r\n/*/\r\n---------------------------------------------------------------------------\r\n{Protheus.doc} NfeTpNota\r\nRetorna o tipo da nota.\r\n@author Valter da Silva\r\n@since 26.03.2018\r\n@version 1.0  \r\n---------------------------------------------------------------------------\r\n/*/\r\nStatic Function NfeTpNota(aNota,aNfVinc,cVerAmb,aNfVincRur,aRefECF,cCFOP)\r\nLocal cTPNota     \t:= \"\"\r\nLocal cMVCfopTran \t:= SuperGetMV(\"MV_CFOPTRA\", ,\" \")   \t\t// Parametro que define as CFOP´s pra transferência de Crédito/Débito\r\nLocal nPos        \t:= 0 \r\nLocal cMVDevCfop  \t:= AllTrim(GetNewPar(\"MV_DEVCFOP\",\"\"))\r\nLocal aMVDevCfop  \t:= {}\r\n\r\nDefault cVerAmb   \t:= \"3.10\"\r\nDefault cCFOP   \t:= \"\"\r\nDefault aNota\t    := {}\r\nDefault aNfVinc   \t:= {}\r\nDefault aNfVincRur\t:= {}\r\nDefault aRefECF   \t:= {}\r\n\r\nDo Case\r\n\tCase (!Empty(aNfVinc) .And. !(aNota[5]$\"NDB\") .And. SF4->F4_AJUSTE <> \"S\")\r\n  \t\tcTPNota:= \"2\" \r\n \tCase (SubStr(SM0->M0_CODMUN,1,2)=='31' .And. SF4->F4_AJUSTE == \"S\" .And. (aNota[5]) $ \"N\" )\r\n \t\tcTPNota:= \"3\"\r\n\tCase ((aNota[5]) $ \"I-D-C-B\" .And. SF4->F4_AJUSTE == \"S\")\r\n   \t\tcTPNota:= \"3\"\r\n\t/* Referente ao chamado TIDMJV que contempla, nota de transferência de crédito / débito */\t   \t\t\r\n   \tCase ( ( AllTrim( SF4->F4_CF ) $ cMVCfopTran ) .and. ( SF4->F4_SITTRIB == \"90\" ) .and.  ( SF4->F4_AJUSTE == \"S\" ) ) \r\n\t\tcTPNota:= \"3\"\r\n\tCase (cVeramb >= \"3.10\" .and. (!Empty(aNfVinc) .Or. !Empty(aRefECF) .Or. !Empty(aNfVincRur))) .and. ( (aNota[5] $ \"D|B\" .And. SF4->F4_AJUSTE <> \"S\") .or. (aNota[5] $ \"N\" .And. SF4->F4_PODER3 == \"D\") )\r\n   \t\t  \t\t\r\n   \t\t//Retorna um array, de acordo com os dados passados no parametro MV_DEVCFOP\r\n   \t\taMVDevCfop\t:= StrTokArr( cMVDevCfop , \";\" )\t\r\n   \t\t\r\n   \t\t// Verifica a CFOP da NF de Devolucao consta no parametro MV_DEVCFOP \r\n   \t\tIF  !Empty(Alltrim(SFT->FT_CFOP))\r\n   \t\t\tnPos := Ascan( aMVDevCfop , Alltrim(SFT->FT_CFOP) ) \r\n   \t\tElse\r\n   \t\t\tnPos := Ascan( aMVDevCfop , Alltrim(cCFOP)) \r\n   \t\tEndIf \r\n   \t\t\r\n   \t\t// Se achou o conteudo, o Tipo de Nota fica igual a 1 conforme NT 2013.005.v1.03 (Chamado TQMCY6) \r\n   \t\tIf nPos > 0 \r\n   \t\t\tcTPNota:= \"1\" \r\n   \t\tElse\r\n   \t\t\tcTPNota:= \"4\" //Devolução de Mercadoria\r\n   \t\tEndIf\r\n   \t\t\r\n   \t /*Ajuste para emitir notas do tipo devolução Tag< finnfe> =4  sem necessidade de referenciar a nota original \r\n     para os  CFOP  1.201, 1.202, 1.410, 1.411, 5,921 e 6,921 . Evitando a rejeição 321- Rejeição: NF-e de devolução de mercadoria não possui\r\n     documento fiscal referenciado conforme  NT 2013/005 v 1.20.\r\n   \t */\r\n    Case (aNota[5]) $ \"D\" .and. Empty(aNfVinc).and. Alltrim(SFT->FT_CFOP) $ \"1201-1202-1410-1411-5921-6921\"\r\n   \t \tcTPNota:= \"4\" \r\n   \t\t\r\n\r\n\tOtherWise \r\n  \t\tcTPNota:= \"1\"\r\n\tEndCase\r\n\r\nReturn(cTPNota)\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} NfeProdANP\r\n\r\nGrupo ICMS60 (id:N08) informado indevidamente nas operações\r\ncom os produtos combustíveis sujeitos a repasse interestadual\r\n(tag:cProdANP).\r\n\r\n@param\t\tNil  \r\n@return    cString\tString contendo os codigos de produto ANP não permitidos para gerar o grupo ICMS60 quando cst 60.\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 21/03/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function NfeProdANP()\r\n\r\nLocal cRetorno \t:= \"\"\r\n\r\n\tcRetorno := \"210203001|320101001|320101002|320102002|320102001|320102003|320102005|320201001|\"\r\n\tcRetorno += \"320103001|220102001|320301001|320103002|820101032|820101026|820101027|820101004|\"\r\n\tcRetorno += \"820101005|820101022|820101031|820101030|820101014|820101006|820101016|820101015|\"\r\n\tcRetorno += \"820101025|820101017|820101018|820101019|820101020|820101021|420105001|420101005|\"\r\n\tcRetorno += \"420101004|420102005|420102004|420104001|820101033|820101034|420106001|820101011|\"\r\n\tcRetorno += \"820101003|820101013|820101012|420106002|830101001|420301004|420202001|420301001|\"\r\n\tcRetorno += \"420301002|410103001|410101001|410102001|430101004|510101001|510101002|510102001|\"\r\n\tcRetorno += \"510102002|510201001|510201003|510301003|510103001|510301001|\"\r\n\t\r\nReturn cRetorno\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} GetPagLoja\r\n\r\nRetornar informações de pagamentos feitas via Venda Direta/Sigaloja\r\n\r\n@param\t\taDupl     Duplicatas para o caso de não ser enviada nenhuma forma de pagamento, para entao fazer-se a validação para os tipos  //outros e //14=Duplicata Mercantil \r\n@param\t\tcChvPag   Condição de pagamento\r\n@param\t\tnTotVd    Total da venda\r\n \r\n@return    Array Contendo as formas de pagamentos utilizados no Loja.\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 09/05/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function GetPagLoja(aDupl, cChvPag, nTotVd, cIndPag, cVerAmb)\r\nLocal aRet\t\t := {}\r\nLocal aAreaSL1 \t := SL1->(GetArea())\r\nLocal aAreaSL4 \t := SL4->(GetArea())\r\nLocal aAreaSA1 \t := {}\r\nLocal aAreaSE4 \t := {}\r\nLocal aDetPag \t := {}\r\nLocal lTEF\t\t := .F.\r\nLocal isloja\t := .F.\r\nLocal cForma\t := \"\"\r\nLocal cTpIntegra := \"\"\r\nLocal cAutTef \t := \"\"\r\nLocal cTpBand    := \"\"\r\nLocal nTamA1COD  := TamSX3(\"A1_COD\")[1]\t//tamanho do campo A1_COD\r\nLocal nTamAECOD  := TamSX3(\"AE_COD\")[1]\t//tamanho do campo AE_COD\r\nLocal cA1Cgc\t := \"\"\r\nLocal lCondCN\t := .F.\t//Condição Negociada\r\nLocal nTroco\t := 0\r\n\r\nDefault aDupl \t := {}\r\nDefault cChvPag\t := \"\"\r\nDefault nTotVd\t := 0\r\n\r\nIf ExistFunc(\"LjGetPgNfe\")\r\n\taRet := LjGetPgNfe(cVerAmb)\r\nElse\r\n\tdbselectarea(\"SL1\")\r\n\tSL1->(dbsetorder(2))\t\t\t\r\n\tIf SL1->(dbseek(xFilial('SL1') + SF2->F2_SERIE + SF2->F2_DOC))\r\n\t\r\n\t\tlTEF    := ( (AllTrim(SL1->L1_VENDTEF) == \"S\") .Or. (SL1->L1_CARTAO > 0) .Or. (SL1->L1_VLRDEBI > 0) )\r\n\t\tlCondCN := Alltrim(cChvPag) == \"CN\"\r\n\r\n\t\t//Caso tenha sido utilizada NCC(Nota de Credito na venda)\r\n\t\tIf SL1->L1_CREDITO > 0\r\n\t\t\tisloja\t:= .T.\t\t\t\r\n\t\t\t\t\t    //{cForma          , Valor          , Troco, Tp Integra, CGC Adm Cartao, Cod Bandeira, Autorização TEF}\r\n\t\t\taadd(aDetPag, {GetFormPgt(\"CR\"), SL1->L1_CREDITO, 0.00 , \"2\"       , \"\"            , \"\"          , \"\", cIndPag}) \r\n\t\t\t\r\n\t\t\t//Caso em conjunto com a NCC tenha sido utilizada condição de pagamento cadastrada na SE4 que nao seja negociada, ja trato aqui\r\n\t\t\tIf !Empty(cChvPag) .And. !lCondCN .And. ((nTotVd - SL1->L1_CREDITO) > 0)\r\n\r\n\t\t\t\taAreaSE4 := SE4->(GetArea())\r\n\t\t\t\t\t//caso tenha escolhido a forma de pagamento no cadastro de condição de pagamento.\r\n\t\t\t\t\tdbSelectArea(\"SE4\")\r\n\t\t\t\t\tdbSetOrder(1)\t\r\n\t\t\t\t\tIf DbSeek(xFilial(\"SE4\") + cChvPag)\r\n\t\t\t\t\t\tcForma := GetFormPgt(Alltrim(SE4->E4_FORMA), aDupl)\r\n\t\t\t\t\t\tnTroco := IIF(SL1->L1_TROCO1 > 0, SL1->L1_TROCO1, 0.00)\r\n\t\t\t\t\t\taadd(aDetPag, {cForma, nTotVd - SL1->L1_CREDITO , nTroco, \"2\", \"\", \"\", \"\", cIndPag})   \r\n\t\t\t\t\tEndIf\t\r\n\t\t\t\tRestArea(aAreaSE4)\r\n\t\t\tEndIf\t\r\n\t\tEndIf\t\r\n\r\n\t\tdbselectarea(\"SL4\")\t\t\t\r\n\t\tSL4->(dbsetorder(1))\r\n\t\tIf lCondCN .And. SL4->(dbseek(SL1->L1_FILIAL + SL1->L1_NUM))\r\n\t\t\tisloja\t:= .T.\r\n\t\t\tWhile !SL4->(Eof()) .And. xFilial(\"SL4\") == SL4->L4_FILIAL .And. SL1->L1_NUM == SL4->L4_NUM\r\n\t\t\t\r\n\t\t\t\tcForma     := GetFormPgt(Alltrim(SL4->L4_FORMA), aDupl)\t\t\r\n\t\t\t\tcTpIntegra := IIF(lTEF, \"1\", \"2\")\r\n\t\t\t\t\t\r\n\t\t\t\t////////////////////////////////////\r\n\t\t\t\tcAutTef := AllTrim(SL4->L4_AUTORIZ)\r\n\t\t\t\tIf EmpTy(cAutTef)\r\n\t\t\t\t\tcAutTef := AllTrim(SL4->L4_NSUTEF)\r\n\t\t\t\t\tIf EmpTy(cAutTef)\r\n\t\t\t\t\t\tcAutTef := AllTrim(SL4->L4_DOCTEF)\r\n\t\t\t\t\t\tIf EmpTy(cAutTef)\r\n\t\t\t\t\t\t\tcTpIntegra := \"2\"\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\t\t/////////////////////////////////////\r\n\r\n\t\t\t\tnTroco :=  IIF(SL4->L4_TROCO > 0, SL4->L4_TROCO, 0.00)\r\n\t\t\t\t\r\n\t\t\t\tIf cTpIntegra == \"1\"\r\n\t\t\t\t\t//obtemos o codigo da administradora financeira conforme cadastrada no SA1\r\n\t\t\t\t\tcAdmFin := PadR( SubStr(SL4->L4_ADMINIS,1,nTamAECOD), nTamA1COD )\r\n\t\t\t\t\tIf !Empty(cAdmFin)\r\n\r\n\t\t\t\t\t\taAreaSA1 \t := SA1->(GetArea())\r\n\t\t\t\t\t\t\tDbSelectArea(\"SA1\")\r\n\t\t\t\t\t\t\tSA1->( DbSetOrder(1) )\t//A1_FILIAL + A1_COD + A1_LOJA\r\n\t\t\t\t\t\t\tIf SA1->(MsSeek(xFilial(\"SA1\") + cAdmFin)) .And. !Empty(SA1->A1_CGC)\r\n\t\t\t\t\t\t\t\tcA1Cgc := SA1->A1_CGC\r\n\t\t\t\t\t\t\tElse\t\r\n\t\t\t\t\t\t\t\tcA1Cgc := \"\"\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tRestArea(aAreaSA1)\r\n\t\t\t\t\tElse\t\r\n\t\t\t\t\t\tcA1Cgc := \"\"\r\n\t\t\t\t\tEndIf\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\tcTpBand := GetTBandLo(SL4->L4_INSTITU)\r\n\t\t\t\tElse\r\n\t\t\t\t\tcA1Cgc  := \"\"\r\n\t\t\t\t\tcTpBand := \"\"\r\n\t\t\t\t\tcAutTef := \"\"\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\taadd(aDetPag, {cForma, SL4->L4_VALOR, nTroco, cTpIntegra, cA1Cgc, cTpBand, cAutTef, cIndPag}) \r\n\r\n\t\t\t\tSL4->(DbSkip())\r\n\t\t\tEndDo\t\t\r\n    \tEndIf\t\r\n    EndIf\r\n\tRestArea(aAreaSL1)\r\n\tRestArea(aAreaSL4)\r\n\t\r\n\taRet := {isloja, aDetPag}\r\nEndIf\r\n\r\nReturn \taRet\r\n\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} GetFormPgt\r\n\r\nRetornar codigos de formas de pagamento exigidos pela Sefaz\r\n\r\n@param\t\tcCondPag  Condição de pagamento entre \"R$\"//DINHEIRO, \"CH\"//CHEQUE, \"CC\" //CARTAO DE CREDITO, \"CD\"//CARTAO DE DEBITO AUTOMATICO, \"CR\"//CREDITO LOJA\r\n\t\t\t\t        \t\t\t\t\t\t  \"VA\"//VALE ALIMENTAÇÃO, \"VR\"//VALE REFEIÇÃO, \"VP\"//VALE PRESENTE, \"VC\"//VALE COMBUSTIVEL, \"DM\"//Duplicata Mercantil\r\n\t\t\t\t\t\t\t\t\t\t\t\t  \"BOL\" //BOLETO BANCARIO, \"SPG\" //SEM PAGAMENTO\r\n@param\t\taDupl     Duplicatas para o caso de não ser enviada nenhuma forma de pagamento, para entao fazer-se a validação para os tipos  //outros e //14=Duplicata Mercantil \r\n\r\n@return     String  Contendo o codigo de forma de pagamento exigida epela Sefaz\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 09/05/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function GetFormPgt(cCondPag, aDupl)\r\n\r\nLocal cForma\t:= \"\"\r\n\r\nDefault cCondPag\t:= \"\"\r\nDefault aDupl\t    := {}\r\n\r\n\tIf !Empty(cCondPag)\r\n\t\tDo Case\r\n\t\t\tCase cCondPag == \"R$\"//DINHEIRO\r\n\t\t\t\tcForma := \"01\"\r\n\t\t\tCase cCondPag == \"CH\"//CHEQUE\r\n\t\t\t\tcForma := \"02\"\r\n\t\t\tCase cCondPag == \"CC\" //CARTAO DE CREDITO\r\n\t\t\t\tcForma := \"03\"\r\n\t\t\tCase cCondPag == \"CD\"//CARTAO DE DEBITO AUTOMATICO\r\n\t\t\t\tcForma := \"04\"\r\n\t\t\tCase cCondPag == \"CR\"//CREDITO LOJA\r\n\t\t\t\tcForma := \"05\"\r\n\t\t\tCase cCondPag == \"VA\"//VALE ALIMENTAÇÃO\r\n\t\t\t\tcForma := \"10\"\r\n\t\t\tCase cCondPag == \"VR\"//VALE REFEIÇÃO\r\n\t\t\t\tcForma := \"11\"\r\n\t\t\tCase cCondPag == \"VP\"//VALE PRESENTE\r\n\t\t\t\tcForma := \"12\"\r\n\t\t\tCase cCondPag == \"VC\"//VALE COMBUSTIVEL\r\n\t\t\t\tcForma := \"13\"\r\n\t\t\t//Case cCondPag == \"DM\"//Duplicata Mercantil\r\n\t\t\t//\tcForma := \"14\"\t\r\n\t\t\tCase cCondPag == \"BOL\" //BOLETO BANCARIO\r\n\t\t\t\tcForma := \"15\"\t\r\n\t\t\tCase cCondPag == \"SPG\" //SEM PAGAMENTO\r\n\t\t\t\tcForma := \"90\"\r\n\t\t\tOtherWise\r\n\t\t\t\tcForma := \"99\"\t// OUTROS\r\n\t\tEndCase\r\n\tElse\t\r\n\t\tIf Empty(cForma)\r\n\t\t\tIf Len(aDupl) == 0\r\n\t\t\t\tcForma := \"90\"  //sem pagamento\r\n\t\t\tElseIf Len(aDupl) > 0\r\n\t\t\t\tcForma := \"15\"  //15=Boleto Bancário \r\n\t\t\tEndif\r\n\t\tEndIf\r\n\tEndIf\t\r\n\r\nReturn cForma\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} GetTBandLo\r\n\r\nRetornar codigos do tipo da bandeira conforme cartao de de credito ou debito exigidos pela Sefaz\r\n\r\n@param\t\tcCondPag  Condição de pagamento entre \"R$\"//DINHEIRO, \"CH\"//CHEQUE, \"CC\" //CARTAO DE CREDITO, \"CD\"//CARTAO DE DEBITO AUTOMATICO, \"CR\"//CREDITO LOJA\r\n\t\t\t\t        \t\t\t\t\t\t  \"VA\"//VALE ALIMENTAÇÃO, \"VR\"//VALE REFEIÇÃO, \"VP\"//VALE PRESENTE, \"VC\"//VALE COMBUSTIVEL, \"DM\"//Duplicata Mercantil\r\n\t\t\t\t\t\t\t\t\t\t\t\t  \"BOL\" //BOLETO BANCARIO, \"SPG\" //SEM PAGAMENTO\r\n@param\t\taDupl     Duplicatas para o caso de não ser enviada nenhuma forma de pagamento, para entao fazer-se a validação para os tipos  //outros e //14=Duplicata Mercantil \r\n\r\n@return     String  Contendo o codigo de forma de pagamento exigida epela Sefaz\r\n                       \r\n@author Thiago Y. M. Nascimento\r\n@since 09/05/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function GetTBandLo(cBandeira)\r\n\r\nLocal c_tBand\t\t:= \"\"\t//codigo da bandeira utilizada pelo SEFAZ\r\n\r\nDefault cBandeira\t:= \"\"\r\n\r\n\tcBandeira := AllTrim( cBandeira )\r\n\tDo Case\r\n\t\tCase (\"VISA\" $ cBandeira)              //( (\"VISA\" $ cBandeira) .OR. (\"ELECTRON\" $ cBandeira) )\r\n\t\t\tc_tBand := \"01\"\r\n\t\tCase (\"MASTERCARD\" $ cBandeira)        // ( (\"MAESTRO\" $ cBandeira) .OR. (\"MASTERCARD\" $ cBandeira) )\r\n\t\t\tc_tBand := \"02\"\r\n\t\tCase (\"AMERICAN EXPRESS\" $ cBandeira)  //( (\"AMEX\" $ cBandeira) .OR. (\"EXPRESS\" $ cBandeira) )\r\n\t\t\tc_tBand := \"03\"\r\n\t\tCase (\"SOROCRED\" $ cBandeira)\r\n\t\t\tc_tBand := \"04\"\r\n\t\tCase (\"DINERS CLUB\" $ cBandeira)\r\n\t\t\tc_tBand := \"05\"\t\r\n\t\tCase (\"ELO\" $ cBandeira)\r\n\t\t\tc_tBand := \"06\"\t\r\n\t\tCase (\"HIPERCARD\" $ cBandeira)\r\n\t\t\tc_tBand := \"07\"\t\r\n\t\tCase (\"AURA\" $ cBandeira)\r\n\t\t\tc_tBand := \"08\"\t\t\r\n\t\tCase (\"CABALAURA\" $ cBandeira)\r\n\t\t\tc_tBand := \"09\"\t\t\t\r\n\t\tOtherwise\r\n\t\t\tc_tBand := \"99\"\r\n\tEndCase\r\n\r\nReturn c_tBand\r\n\r\n/*/{Protheus.doc} DadNfVinc()\r\nFuncao que verifica os dados da nota vinculadas ao documento de entrada.\r\n@author Valter Da silva     \r\n@since 02.07.2018\r\n@version 1.0 \r\n/*/\r\nStatic Function DadNfVinc(aNfVinc)\r\nLocal aAreaSC5\t:= SC5->( GetArea() )\r\nLocal aAreaSC6 := SC6->( GetArea() )\r\nLocal aDadNfVi\t:= {} \r\nLocal cNEmp\t:= \"\"  \r\nLocal cPed  \t:= \"\"  \r\nDefault aNfVinc \t:= {}\r\n\t\r\nSC5->( dbSetOrder(1) ) \r\nSC6->( dbSetOrder(1) ) \r\n\t     \r\nIf SC5->(MsSeek(xFilial(\"SC5\")+aNfVinc[1][9]))\r\n\tcNEmp:= Iif(SC5->(FieldPos(\"C5_NTEMPEN\")) > 0,Alltrim(SC5->C5_NTEMPEN),\"\")\r\nEndIf\r\n\t   \r\nIf SC6->(MsSeek(xFilial(\"SC6\")+aNfVinc[1][9]))\r\n\tcPed := AllTrim(SC6->C6_PEDCLI)\r\nEndIf   \r\n\t \r\n\taDadNfVi := {cNEmp,cPed,\"\"}\r\n \r\n\tRestArea( aAreaSC5 )\r\n\tRestArea( aAreaSC6 )\r\n\r\nReturn aDadNfVi\r\n\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} FiltEst\r\n\r\nRemove a citação á nota fiscal complementar que seja diferente do estado do emissor \r\n\r\n@param\t\taRef      Array que contém as notas de referência\r\n\r\n@param\t\tcEst\t   Estado do Emissor (obtido do SM0) \r\n\r\n@return     aRet    Possui notas de referência que podem ser citadas no xml (que são do mesmo estado que o emissor).\r\n                       \r\n@author Bruno Colisse\r\n@since 03/07/2018\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function FiltEst(aRef, cEst)\r\nLocal i := 0\r\n\r\nLocal aRet := {}\r\n\r\nfor i := 1 to len(aRef)\r\n\tif aRef[i][6] == cEst\r\n\t\taAdd(aRet, aRef[i])\r\n\tendif\r\nNext\r\nReturn aRet\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} RetInfoSBZ\r\nRetorna a Unid. Medida da DIPI e o Fator de Conv. da DIPI da SBZ caso os parâmetro recebidos estejam vazios.\r\n\r\n@param  cProduto - Produto que será localizado na SBZ\r\n@param  cUmDipi  - Unid. Medida da DIPI\r\n@param  nConvDip - Fator de Conv. da DIPI\r\n                       \r\n@author  Rafael Tenorio da Costa\r\n@since   11/06/2019\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function RetInfoSBZ(cProduto, cUmDipi, nConvDip)\r\n\r\n    Local aArea := GetArea()\r\n\r\n    DbSelectArea(\"SBZ\")\r\n    SBZ->( DbSetOrder(1) )    //BZ_FILIAL+BZ_COD\r\n    If SBZ->( DbSeek(xFilial(\"SBZ\") + cProduto) )\r\n\r\n        If Empty(cUmDipi) .And. SBZ->( ColumnPos(\"BZ_UMDIPI\") ) > 0\r\n            cUmDipi := SBZ->BZ_UMDIPI\r\n        EndIf\r\n\r\n        If nConvDip == 0 .And. SBZ->( ColumnPos(\"BZ_CONVDIP\") ) > 0\r\n            nConvDip := SBZ->BZ_CONVDIP\r\n        EndIf\r\n    EndIf\r\n    \r\n    RestArea(aArea)\r\n\r\nReturn Nil\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} getCodLan\r\nValidação com a tabela 5.2 para enviar o codigo SEM CBENEF ou NULO de acordo com a UF\r\n\r\n@param  cUF \t- Estado que será validado\r\n@param  cCST \t- CST do produto informado\r\n@author  Bruno Seiji\r\n@since   14/08/2019\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nstatic function getCodLan( cUF, cCST, cAmbiente )\r\n\r\nlocal cCodlan\t\t:= \"\"\r\nlocal lSemCbenef\t:= .F.\r\ndefault cUF \t\t:= \"\"\r\ndefault cCST \t\t:= \"\"\r\ndefault cAmbiente\t:= \"2\"\r\n\r\nif !empty(cUF) .and. !empty(cCST)\r\n\r\n\tlSemCbenef := cAmbiente == \"2\"\r\n\r\n\tdo case\r\n\t\tcase cUF == \"PR\"\r\n\t\t\tif cCST == \"90\"\r\n\t\t\t\tcCodlan := \"SEM CBENEF\"\r\n\t\t\tendif\r\n\t\tcase cUF == \"RS\"\r\n\t\t\tcCodlan := \"SEM CBENEF\"\r\n\t\t\tif cCST <> \"90\" .and. date() > CTOD(\"09/08/2020\")\r\n\t\t\t\tcCodlan := \"\"\r\n\t\t\tendif\r\n\tendCase\r\n\r\nendif\r\n\r\nreturn cCodlan\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} SpecialChar\r\nLimpa os códigos ASCII faixa 127 a 255 que falham os EncodeUTF8\r\n\r\n@param  cString\t- xml\r\n@param  cString\t- Xml sem os os codigos da tabela asci que falham os EncodeUTF8.\r\n@author  Bruno Akyo\r\n@since   28/10/2019\r\n@version 1.0 \r\n/*/\r\n//-----------------------------------------------------------------------\r\nstatic Function SpecialChar( cString )\r\nlocal nX     := 0\r\nlocal aChar  := {}\r\n\r\ndefault cString := \"\"\r\n\r\nif !empty( cString )\r\n    aAdd( aChar, 129)\r\n    aAdd( aChar, 141)\r\n    aAdd( aChar, 143)\r\n    aAdd( aChar, 144)\r\n    aAdd( aChar, 157)\r\n    for nX := 1 to len(aChar)\r\n        cString := StrTran( cString, Chr( aChar[nX] ), \".\" )\r\n    next\r\nendif\r\n\r\nreturn cString\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} PosiTriang\r\nVerifica se a operação se trata de uma triangulação\r\n\r\n@author  Felipe Sales Martinez\r\n@since   09/12/2019\r\n@version 1.0\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function PosiTriang(cAliasSD2)\r\nLocal lRet := .F.\r\nSD1->(DBSetOrder(4)) //D1_FILIAL+D1_NUMSEQ\r\nlRet := !Empty((cAliasSD2)->D2_IDENTB6) .And. SD1->(DBSeek(xFilial(\"SD1\")+(cAliasSD2)->D2_IDENTB6)) .And. SD1->(D1_DOC+D1_SERIE+D1_COD) == (cAliasSD2)->(D2_NFORI+D2_SERIORI+D2_COD)\r\nReturn lRet\r\n\r\n//-----------------------------------------------------------------------\r\n/*/{Protheus.doc} AjustaDest\r\nFunção para que quando mudar o cadastro de cliente referente ao grupo de destinatário na tabela AIF o mesmo busque dados da nota vinculada e retorna no array . \r\n@param  aDest \t - Array com o destinatário\r\n@param  aNfVinc  - Array com a nota vinculada\r\n@param  cCliefor - Fornecedor\r\n@param  cLoja    - Loja\r\n\r\n@return    aDest - Array aDeste contendo os dados da nota vinculada.\r\n\r\n@author  Valter da Silva\r\n@since   04/03/2020\r\n@version 1.0\r\n/*/\r\n//-----------------------------------------------------------------------\r\nStatic Function AjustaDest(aDest,aNfVinc,cCliefor,cLoja)\r\n\tLocal   cAliasAIF\t:= getNextAlias()\r\n\tLocal   dDataEmis   := \"\"\r\n\tLocal   aDestVinc \t:= {}\r\n\tLocal   lDestVinc   := .F.\r\n\t\r\n\tDefault cCliefor\t:= \"\"\r\n\tDefault cLoja\t    := \"\"\r\n\tDefault aDest\t    := {}\r\n\tDefault aNfVinc\t    := {}\r\n    \r\n\tif !Empty(aNfVinc)\r\n\t\tdDataEmis:= aNfVinc[1][1]\r\n    \tdDataEmis:= Dtos(dDataEmis)\r\n\tendif\r\n\r\n\tBeginSql Alias cAliasAIF\r\n\tcolumn AIF_DATA as Date\r\n\r\n\tSELECT max(AIF_DATA) AIF_DATA\r\n\t\tFROM %Table:AIF% AIF\r\n\t\tWHERE\r\n\t\t\tAIF.AIF_FILIAL = %xFilial:AIF% AND\r\n\t\t\tAIF.AIF_FILTAB = %Exp:xFilial(\"SA1\")%  AND\r\n\t\t\tAIF.AIF_TABELA = %Exp:\"SA1\" % AND\r\n        \tAIF.AIF_CODIGO = %Exp:cCliefor%  AND\r\n\t\t\tAIF.AIF_LOJA   = %Exp:cLoja%  AND\r\n\t\t\tAIF.AIF_CAMPO  IN ('A1_NOME','A1_END','A1_COMPLEM','A1_BAIRRO',' A1_COD_MUN','A1_MUN','A1_EST','A1_CEP','A1_PAIS','A1_TEL','A1_EST','A1_INSCR','A1_SUFRAMA','A1_INSCRM','A1_CONTRIB','A1_IENCONT','A1_TIPO','A1_PFISICA','A1_EMAIL')  AND\r\n\t\t\tAIF.AIF_DATA >= %Exp:dDataEmis% AND\r\n\t\t\tAIF.%NotDel% \r\n\t\tEndSql\r\n\t\t\r\n\t\tif (cAliasAIF)->(!Eof()) .and. !empty((cAliasAIF)->AIF_DATA)\r\n\t\t\tlDestVinc:=.T.\t\r\n\t\tendif\r\n\t\t\r\n\t\t(cAliasAIF)->(DBCLOSEAREA())\r\n\t\t\r\n\t\tif lDestVinc\r\n    \t\taDestVinc:= NotaVinc(aNfVinc[1][2]+aNfVinc[1][3])\r\n            \r\n\t\t\tIf !Empty(aDestVinc)\r\n\t\t\t\taDest[02]  := aDestVinc[02] // - Nome\r\n\t\t\t\taDest[03]  := aDestVinc[03] // - Logradouro\r\n\t\t\t\taDest[04]  := aDestVinc[04] // - Número\r\n\t\t\t\taDest[05]  := aDestVinc[05] // - Complemento\r\n\t\t\t\taDest[06]  := aDestVinc[06] // - Bairro\r\n\t\t\t\taDest[07]  := aDestVinc[07] // - Código do município\r\n\t\t\t\taDest[08]  := aDestVinc[08] // - Nome do município\r\n\t\t\t\taDest[09]  := aDestVinc[09] // - Sigla da UF\r\n\t\t\t\taDest[10]  := aDestVinc[10] // - Código do CEP\r\n\t\t\t\taDest[11]  := aDestVinc[11] // - Código do País\r\n\t\t\t\taDest[12]  := aDestVinc[12] // - Nome do País\r\n\t\t\t\taDest[13]  := aDestVinc[13] // - Telefone\r\n\t\t\t\taDest[14]  := iif(EMPTY(aDestVinc[15]),'ISENTO',aDestVinc[15]) // - Inscrição Estadual do Destinatário\r\n\t\t\t\taDest[15]  := aDestVinc[16] // - Inscrição na SUFRAMA\r\n\t\t\t\taDest[19]  := aDestVinc[17] // - Inscrição Municipal do Tomador do Serviço\r\n\t\t\t\taDest[16]  := aDestVinc[18] // - Email\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\r\nReturn aDest\r\n\r\nStatic Function SortArray(aArray,nIni,nLen,bCompara)\r\nLocal i\r\nLocal nTam\r\n\r\nIf ValType(aArray) == \"A\" .AND. Len(aArray) > 0\r\n\r\n\tnTam := Int(log(Len(aArray))/log(10))+1\r\n\r\n\tFor i := 1 To Len(aArray)\r\n\t\taArray[i] := {aArray[i],StrZero(i,nTam)}\r\n\tNext i\r\n\r\n\tIf ValType(nAux := Eval(bCompara,aArray[1][1],aArray[1][1])) == \"N\" .AND. nAux == 0\r\n\t\taSort(aArray,nIni,nLen,{|X,Y| nAux := Eval(bCompara,X[1],Y[1]),If(nAux == 0,X[2]<Y[2],nAux > 0)})\r\n\tEndIf\r\n\r\n\tFor i := 1 To Len(aArray)\r\n\t\taArray[i] := aClone(aArray[i][1])\r\n\tNext i\r\n\r\nEndIf\r\n\r\nReturn aArray\r\n"}}}
Content-Length: 171
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO/nfesefaz.prw"}}}
Content-Length: 110149
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO_NOVO_COMERCIAL/MT410TOK.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"rwmake.ch\"\r\n#INCLUDE \"protheus.ch\"\r\n#INCLUDE \"topconn.ch\"\r\n\r\n/*\r\nPrograma ...: MT410TOK.Prw\r\nUso ........: Validação do pedido de vendas\r\nData .......: 26/04/2019\r\nFeito por ..: Bruno Lage Ferreira \r\n\r\nMV_NDESCTP - DESCONTO NO PREÇO DE LISTA E UNITARIO\r\nNOVO\r\n*/\r\n\r\nUser Function MT410TOK()\r\n****************************************************************************************************************\r\n*   /* Programa para validar o pedido de venda tabela de preço de chapas - Qualitá */\r\n*\r\n****\r\nLocal   lRet      := .T.\r\nLocal   oProcess\r\nLocal   nOpc      := PARAMIXB[1]\r\nLocal   cQuery    := \"\"\r\nDefault lEnd      := .F.\r\n\r\n\r\nIf SubString(CNUMEMP,1,2) == \"01\" .And. (INCLUI == .T. .Or. nOpc == 1 .OR. ALTERA == .T.) .AND. (FUNNAME() <> \"GROA001\")\r\n\r\n\ta410Recalc()\r\n\r\n\toProcess := MsNewProcess():New({|lEnd| lRet := MValidPedV(@oProcess, @lEnd,@lRet) },\"Validando dados..\",\"Lendo Registros do Pedido de Vendas\",.T.) \r\n\tIf !IsBlind()     \r\n\t\tIf nOpc == 1 \r\n\t\t\tIf !Empty(M->C5_XIDMOB)\r\n\t\t\t\t\r\n\t\t\t\tcQuery := \"SELECT MAX(ZSA_IDMOB) ID FROM ZSA010 WHERE D_E_L_E_T_ =\t'' AND  ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\"'\"\r\n\t\t\t\ttcQuery cQuery alias TRB_EMOB new\r\n\t\t\t\tdbSelectArea(\"TRB_EMOB\")\r\n\t\t\t\tdbgotop()\r\n\r\n\t\t\t\tIf !EMPTY(TRB_EMOB->ID)\r\n\t\t\t\t\tAlert(\"Este P.Venda deve ser excluído pelo MogGran!\")\r\n\t\t\t\t\tdbSelectArea(\"TRB_EMOB\") \r\n\t\t\t\t\tdbCloseArea()\r\n\t\t\t\t\tReturn(.f.)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(\"TRB_EMOB\") \r\n\t\t\t\tdbCloseArea()\r\n\r\n\t\t\tEndIF\r\n\t\tEndIf\r\n\t\toProcess:Activate()\r\n\telse\r\n\t\tlRet := MValidPedV(nil, @lEnd,@lRet)\r\n\tEndIf\r\nEndIf\r\n\r\nReturn(lRet)\r\n\r\nUser Function M410LIOK()\r\n****************************************************************************************************************\r\n*    Libera ou bloquea linha do pedido de venda \r\n*\r\n****\r\nLocal lRet   := .T.\r\nLocal cQuery := \"\"\r\n\r\n/*\r\nLinhaOk\r\n*/\r\nIf SubString(CNUMEMP,1,2) == \"01\" \r\n\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",n))) ,1,2) $ 'BL' .AND. u_MTSOEST(GdFieldGet(\"C6_TES\",n)) \r\n\t\tIf Empty(GdFieldGet(\"C6_LOTECTL\",n))\r\n\t\t\tAlert(\"ERRO! BLOCO SEM LOTE!\")\r\n\t\t\tlRet := .F.\r\n\t\tEndIf\r\n\tEndIf\r\n\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",n))) ,1,2) $ 'CH' .AND. (Empty(GdFieldGet(\"C6_LOTECTL\",n)) .OR. Empty(GdFieldGet(\"C6_NUMLOTE\",n)))  \r\n\t\tAlert(\"ERRO! CHAPA COM LOTE OU SUB-LOTE EM BRANCO!\")\r\n\t\tlRet := .F.\r\n\tEndIf\r\nEndIf\r\n\r\n\r\n/*\r\nValida mobGran\r\n*/\r\ncQuery  := \" SELECT ZSA_PRCDES FROM ZSA010\r\ncQuery  += \"  WHERE D_E_L_E_T_ = ''\r\ncQuery  += \"  AND ZSA_PRCDES <> 0\r\n//cQuery  += \"  AND ZSA_STATUS = 'ATIVA'\r\ncQuery  += \"  AND ZSA_IDMOBP = '\"+ AllTrim(M->C5_XIDMOB)                    +\"'\r\ncQuery  += \"  AND ZSA_NUMCAV = '\"+ AllTrim(GdFieldGet(\"C6_YCAVALE\",n))      +\"'\r\ncQuery  += \"  AND ZSA_PROD   = '\"+ AllTrim(GdFieldGet(\"C6_PRODUTO\",n))      +\"'\r\ncQuery  += \"  AND ZSA_CLASSI = '\"+ AllTrim(GdFieldGet(\"C6_YCLASSI\",n))      +\"'\r\ncQuery  += \"  AND ZSA_LOTE   = '\"+ AllTrim(GdFieldGet(\"C6_LOTECTL\",n))      +\"'\r\n\r\ntcQuery cQuery alias TRB new\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\n\r\nIf !EMPTY(TRB->ZSA_PRCDES)\r\n\tGdFieldPut(\"C6_XOFERTA\",'S')\r\nEndIf\r\n\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n\r\n\r\nReturn(lRet)\r\n\r\nUser Function MTSOEST(cCodTes)\r\n****************************************************************************************************************\r\n*    Libera ou bloquea linha do pedido de venda \r\n*\r\n****\r\nLocal lRet := .F.\r\n\r\ndbSelectArea(\"SF4\")\r\ndbSetOrder(1)\r\ndbSeek(xFilial(\"SF4\") + cCodTes)\r\n\r\nIf SF4->F4_ESTOQUE == \"S\"\r\n\tlRet := .T.\r\n\tConOut(\"MTSOEST\" +\"|\"+ cCodTes +\"|\"+ \".T.\" )\r\nElse\r\n\tConOut(\"MTSOEST\" +\"|\"+ cCodTes +\"|\"+ \".F.\" )\r\n\tlRet := .F.\r\nEndIf\r\n\r\nReturn(lRet)\r\n\r\nUser Function GM410FIM()\r\n****************************************************************************************************************\r\n*    Libera ou bloquea pedido de venda M410STTS \r\n*\r\n****\r\nLocal lLibBlq  := .F.\r\nLocal lCalcPeso:= .F.\r\nLocal cQuery   := \"\"\r\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\r\nlOCAL nX       := 0\r\n\r\nIf SubString(CNUMEMP,1,2) == \"01\"  .AND. (FUNNAME() <> \"GROA001\")\r\n\tFor nX := 1 To Len(aCols)\r\n\t\tIf !Empty(GdFieldGet(\"C6_XMOTBLQ\",nX)) .OR. !Empty(M->C5_XMOTBLQ)\r\n\t\t\tlLibBlq   := .T.\r\n\t\tEndIf\r\n\t\t\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\t\t\r\n\t\t\tlCalcPeso := .T.\r\n\t\tEndIf\r\n\tNext nX\r\n\t\r\n\tIf lLibBlq   \r\n\t\tRecLock(\"SC5\",.F.)\r\n\t\t\tSC5->C5_BLQ  := '1'\r\n\t\tMsUnlock()\t\r\n\tEndif\r\n\r\n\tIf  M->C5_TIPO $ \"D/B\"\r\n\t\tRecLock(\"SC5\",.F.)\r\n\t\t\tSC5->C5_BLQ  := ''\r\n\t\tMsUnlock()\t\r\n\tEndIf \r\n\r\n\tIf lCalcPeso\r\n\t\r\n\t\t//Soma dos pesos brutos e liquido\r\n\t\tcQuery   := \" SELECT\tROUND(SUM(B8_YPESOLQ) + SUM(PESO_AMOSTRAS),3) PLQ, \r\n\t\tcQuery   += \" \t\t    ROUND(SUM(B8_YPESOBR) + SUM(PESO_AMOSTRAS),3) PBR \r\n\t\tcQuery   += \" FROM (\r\n\t\tcQuery   += \" SELECT\t\tISNULL(ZGO.ZGO_INVOIC,'') AS ZGO_INVOIC, \r\n\t\tcQuery   += \" \t\t\tTAB_PROFORMA.* FROM (\r\n\t\tcQuery   += \" \t\t\t SELECT\tRTRIM(LTRIM(C5_NUM)) AS C5_NUM,\r\n\t\tcQuery   += \" \t\t\t\t\tYEAR(CAST(C5_EMISSAO AS DATE) )ANO,\r\n\t\tcQuery   += \" \t\t\t\t\tCAST(C5_EMISSAO AS DATE) AS C5_EMISSAO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_NOME)) AS A1_NOME,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_END)) AS A1_END,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_BAIRRO)) AS A1_BAIRRO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDI)) AS A1_DDI,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDD)) AS A1_DDD,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_TEL)) AS A1_TEL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_CONTATO)) AS A1_CONTATO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A3_NOME)) AS A3_NOME,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(YA_PAIS_I)) AS YA_PAIS_I,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XSEAL)) AS C5_XSEAL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XBOOKIN)) AS C5_XBOOKIN,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVESSEL)) AS C5_XVESSEL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XCONTAI)) AS C5_XCONTAI,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTARE)) AS C5_XTARE,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPO)) AS C5_XPO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_LOTECTL)) AS C6_LOTECTL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_NUMLOTE)) AS C6_NUMLOTE,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_CF,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_XPESO AS PESO_AMOSTRAS,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YESPLIQ * 100 AS C6_YESPLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(B5_YCEMEIN)) AS C6_DESCRI, \r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_DESCRI))  AS C6_DESCRI_P, \r\n\t\tcQuery   += \" \t\t\t\t\tIIF(RTRIM(LTRIM(C6_YCAVALE))='','-',RTRIM(LTRIM(C6_YCAVALE)))  AS C6_YCAVALE,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_PRCVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tROUND(C6_PRCVEN / 10.764,2) AS PRCVEN_SQFT,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XVLRFIN AS VALOR_FINANCEIRO,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_QTDVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_NUMLOTE<>'',1,0) AS QTD_CHAPAS,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',0,C6_QTDVEN) AS QTD_TOTAL_FATURAR,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='M2',C6_QTDVEN,0) AS QTD_TOTAL_M2,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='PC',C6_QTDVEN,0) AS QTD_TOTAL_PC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_UM,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_UNSVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_VALOR,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',C6_VALOR,0) AS SAMPLE_DESC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_VALDESC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YCOMLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YALTLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YTOTLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOLQ FROM SB8010 WHERE D_E_L_E_T_ = '' AND C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO AND B8_LOCAL = C6_LOCAL) ,0) AS  B8_YPESOLQ,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOBR FROM SB8010 WHERE D_E_L_E_T_ = '' AND C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO AND B8_LOCAL = C6_LOCAL) ,0) AS  B8_YPESOBR,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XTESALE,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVALEXT)) AS C5_XVALEXT,\r\n\t\tcQuery   += \" \t\t\t\t\tUPPER(ISNULL(CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), C5_YOBSEXT)),'')) AS C5_YOBSEXT,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESING))  AS E4_DESING,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESCRI))  AS E4_DESPOR,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPORTLO)) AS C5_XPORTLO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTPCONT)) AS C5_XTPCONT,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XINSURA)) AS C5_XINSURA,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFIMDES)) AS C5_XFIMDES,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFRFORW)) AS C5_XFRFORW,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XWLIMIT,\r\n\t\tcQuery   += \" \t\t\t\t\tCASE \r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'S' THEN 'STANDARD'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'C' THEN 'COMMERCIAL'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'P' THEN 'PREMIUM'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = '' AND C6_CF='7949' THEN 'SAMPLE'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = ''  THEN '' \r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'A' THEN 'SAMPLE'\r\n\t\tcQuery   += \" \t\t\t\t\tEND C6_YCLASSI,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XTOTAL,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XDESCON,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XPDESTI,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT B8_LOTEFOR FROM SB8010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = '' AND SUBSTRING(B8_PRODUTO,1,2) ='BL' ),'') AS LOTE_FORNECEDOR\r\n\t\tcQuery   += \" \t\t\t FROM SC6010 SC6 INNER JOIN SC5010 SC5\r\n\t\tcQuery   += \" \t\t\t\t   ON (C6_FILIAL = C5_FILIAL AND C6_NUM = C5_NUM )\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA1010 SA1\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_COD = C5_CLIENTE AND A1_LOJA = C5_LOJACLI )\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SYA010 SYA\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_PAIS = YA_CODGI)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA3010\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_VEND=A3_COD)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SB5010 SB5\r\n\t\tcQuery   += \" \t\t\t\t   ON (C6_PRODUTO = B5_COD)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SE4010 SE4\r\n\t\tcQuery   += \" \t\t\t\t   ON (E4_CODIGO = C5_CONDPAG)\r\n\t\tcQuery   += \" \t\t\t WHERE SC6.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SC5.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SA1.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SYA.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SB5.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SE4.D_E_L_E_T_ = ''\r\n\t\t//cQuery   += \" \t\t\t   AND SC5.C5_BLQ <> '1'\r\n\t\tcQuery   += \" \t\t\t   AND C5_NUM = '\"+SC5->C5_NUM+\"'\r\n\t\tcQuery   += \" )TAB_PROFORMA\r\n\t\tcQuery   += \" \t FULL OUTER JOIN ZGO010 ZGO\r\n\t\tcQuery   += \" \t   ON (C5_NUM = ZGO_PEDIDO)\r\n\t\tcQuery   += \" WHERE C5_NUM <> ''\r\n\t\tcQuery   += \"   AND ISNULL(ZGO_INVOIC,'') LIKE '%%'\r\n\t\tcQuery   += \" )TB_PESO\r\n\t\t                                                          \r\n\t\ttcQuery cQuery alias TRB new\r\n\t\tdbSelectArea(\"TRB\")\r\n\t\tdbgotop()\r\n\t\t\r\n\t\tIF !M->C5_TIPO $ \"D/B\" .And. LEFT(AllTrim(GdFieldGet(\"C6_PRODUTO\",1)),2) <> 'BL'\r\n\t\t\tIF !EOF()\r\n\t\t\t\tdbSelectArea(\"SC5\")\t\t\r\n\t\t\t\tIf RecLock(\"SC5\",.f.)\r\n\t\t\t\t\tReplace SC5->C5_PESOL  With TRB->PLQ\r\n\t\t\t\t\tReplace SC5->C5_PBRUTO With TRB->PBR\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tIF TRB->PLQ > SC5->C5_PBRUTO \r\n\t\t\t\t\t\tAlert(\"Peso bruto esta menor que peso líquido. Favor corrigir!\")\r\n\t\t\t\t\t\tReplace SC5->C5_PBRUTO With 0\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tMsUnLock()\r\n\t\t\t\tEndIf\t\r\n\t\t\tEndIf\r\n\t\tEndIf\t\t\t\t\r\n\t\tdbSelectArea(\"TRB\") \r\n\t\tdbCloseArea()\r\n\t\t\r\n\t\t//Soma da quantidade de bandos\r\n\t\tcQuery   := \" SELECT COUNT(*) QTD FROM (\r\n\t\tcQuery   += \" SELECT DISTINCT C6_YCAVALE FROM (\r\n\t\tcQuery   += \" SELECT\t\tISNULL(ZGO.ZGO_INVOIC,'') AS ZGO_INVOIC, \r\n\t\tcQuery   += \" \t\t\tTAB_PROFORMA.* FROM (\r\n\t\tcQuery   += \" \t\t\t SELECT\tRTRIM(LTRIM(C5_NUM)) AS C5_NUM,\r\n\t\tcQuery   += \" \t\t\t\t\tYEAR(CAST(C5_EMISSAO AS DATE) )ANO,\r\n\t\tcQuery   += \" \t\t\t\t\tCAST(C5_EMISSAO AS DATE) AS C5_EMISSAO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_NOME)) AS A1_NOME,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_END)) AS A1_END,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_BAIRRO)) AS A1_BAIRRO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDI)) AS A1_DDI,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDD)) AS A1_DDD,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_TEL)) AS A1_TEL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_CONTATO)) AS A1_CONTATO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A3_NOME)) AS A3_NOME,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(YA_PAIS_I)) AS YA_PAIS_I,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XSEAL)) AS C5_XSEAL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XBOOKIN)) AS C5_XBOOKIN,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVESSEL)) AS C5_XVESSEL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XCONTAI)) AS C5_XCONTAI,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTARE)) AS C5_XTARE,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPO)) AS C5_XPO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_LOTECTL)) AS C6_LOTECTL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_NUMLOTE)) AS C6_NUMLOTE,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_CF,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_XPESO AS PESO_AMOSTRAS,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YESPLIQ * 100 AS C6_YESPLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(B5_YCEMEIN)) AS C6_DESCRI, \r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_DESCRI))  AS C6_DESCRI_P, \r\n\t\tcQuery   += \" \t\t\t\t\tIIF(RTRIM(LTRIM(C6_YCAVALE))='','-',RTRIM(LTRIM(C6_YCAVALE)))  AS C6_YCAVALE,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_PRCVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tROUND(C6_PRCVEN / 10.764,2) AS PRCVEN_SQFT,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XVLRFIN AS VALOR_FINANCEIRO,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_QTDVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_NUMLOTE<>'',1,0) AS QTD_CHAPAS,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',0,C6_QTDVEN) AS QTD_TOTAL_FATURAR,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='M2',C6_QTDVEN,0) AS QTD_TOTAL_M2,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='PC',C6_QTDVEN,0) AS QTD_TOTAL_PC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_UM,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_UNSVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_VALOR,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',C6_VALOR,0) AS SAMPLE_DESC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_VALDESC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YCOMLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YALTLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YTOTLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOLQ FROM SB8010 WHERE D_E_L_E_T_ = '' AND  C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO) ,0) AS  B8_YPESOLQ,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOBR FROM SB8010 WHERE D_E_L_E_T_ = '' AND C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO) ,0) AS  B8_YPESOBR,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XTESALE,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVALEXT)) AS C5_XVALEXT,\r\n\t\tcQuery   += \" \t\t\t\t\tUPPER(ISNULL(CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), C5_YOBSEXT)),'')) AS C5_YOBSEXT,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESING))  AS E4_DESING,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESCRI))  AS E4_DESPOR,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPORTLO)) AS C5_XPORTLO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTPCONT)) AS C5_XTPCONT,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XINSURA)) AS C5_XINSURA,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFIMDES)) AS C5_XFIMDES,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFRFORW)) AS C5_XFRFORW,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XWLIMIT,\r\n\t\tcQuery   += \" \t\t\t\t\tCASE \r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'S' THEN 'STANDARD'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'C' THEN 'COMMERCIAL'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'P' THEN 'PREMIUM'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = '' AND C6_CF='7949' THEN 'SAMPLE'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = ''  THEN '' \r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'A' THEN 'SAMPLE'\r\n\t\tcQuery   += \" \t\t\t\t\tEND C6_YCLASSI,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XTOTAL,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XDESCON,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XPDESTI,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT B8_LOTEFOR FROM SB8010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = '' AND SUBSTRING(B8_PRODUTO,1,2) ='BL' ),'') AS LOTE_FORNECEDOR\r\n\t\tcQuery   += \" \t\t\t FROM SC6010 SC6 INNER JOIN SC5010 SC5\r\n\t\tcQuery   += \" \t\t\t\t   ON (C6_FILIAL = C5_FILIAL AND C6_NUM = C5_NUM )\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA1010 SA1\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_COD = C5_CLIENTE AND A1_LOJA = C5_LOJACLI )\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SYA010 SYA\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_PAIS = YA_CODGI)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA3010\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_VEND=A3_COD)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SB5010 SB5\r\n\t\tcQuery   += \" \t\t\t\t   ON (C6_PRODUTO = B5_COD)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SE4010 SE4\r\n\t\tcQuery   += \" \t\t\t\t   ON (E4_CODIGO = C5_CONDPAG)\r\n\t\tcQuery   += \" \t\t\t WHERE SC6.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SC5.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SA1.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SYA.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SB5.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SE4.D_E_L_E_T_ = ''\r\n\t  //cQuery   += \"              --AND SC5.C5_BLQ <> '1'\r\n\t\tcQuery   += \" \t\t\t   AND C5_NUM = '\"+SC5->C5_NUM+\"'\r\n\t\tcQuery   += \" \r\n\t\tcQuery   += \" )TAB_PROFORMA\r\n\t\tcQuery   += \" \t FULL OUTER JOIN ZGO010 ZGO\r\n\t\tcQuery   += \" \t   ON (C5_NUM = ZGO_PEDIDO)\r\n\t\tcQuery   += \" WHERE C5_NUM <> ''\r\n\t   //cQuery  += \"   --AND ISNULL(ZGO_INVOIC,'') LIKE '%'+@INVOICE+'%'\r\n\t\tcQuery   += \" )TB_TOTAL_CAV\r\n\t\tcQuery   += \" WHERE C6_YCAVALE <> '-'\r\n\t\tcQuery   += \" )TB_QTD_CAV\r\n\t\t\r\n\t\t\r\n\t\ttcQuery cQuery alias TRB new\r\n\t\tdbSelectArea(\"TRB\")\r\n\t\tdbgotop()\r\n\t\t\r\n\t\tIF !EOF()\r\n\t\t\tdbSelectArea(\"SC5\")\t\t\r\n\t\t\tIf RecLock(\"SC5\",.f.)\r\n\t\t\t\tReplace SC5->C5_VOLUME1  With TRB->QTD  \r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf\t\r\n\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\tdbSelectArea(\"TRB\") \r\n\t\tdbCloseArea()\r\n\t\t\r\n\t\tIf RecLock(\"SC5\",.f.)\r\n\t\t\tIF SC5->C5_VOLUME1 == 0\r\n\t\t\t\tSC5->C5_VOLUME1 := 1\r\n\t\t\tEndIf\r\n\t\t\tMsUnLock()\r\n\t\tEndIf\t\r\n\t\t\r\n\tEndIf\r\n\r\nEndIf\r\n\r\nReturn()\r\n\r\n/*\r\nUser Function MDesTot()\r\n****************************************************************************************************************\r\n*    Programa dar o desconto  \r\n*\r\n****\r\nLocal nValorTemp := 0\r\n\r\nFor nX := 1 To Len(aCols)\r\n\t\tGdFieldPut(\"C6_DESCONT\",M->C5_DESC1,nX) \r\nNext nX\r\n\r\nReturn(.T.) \r\n*/\r\n\r\nStatic Function MValidPedV(oProcess, lEnd,lRet)\r\n****************************************************************************************************************\r\n*   /* Programa para validar o pedido de venda tabela de preço de chapas - Qualitá */\r\n*\r\n****\r\nLocal cQuery := \"\"\r\n\r\nLocal nPosCava := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_YCAVALE\"}) //Cavalete\r\nLocal nPosLOTE := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_LOTECTL\"}) //SubLote\r\nLocal nPosSUBL := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_NUMLOTE\"}) //Lote\r\nLocal nPosLOCA := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_LOCAL\"  }) //Lote\r\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\r\n\r\nLocal fTPBLQ   := .F.\r\n\r\nLocal aMsgPrc  := {}\r\nLoca  nX       := 0\r\n\r\nIf !IsBlind()     \r\n\toProcess:SetRegua1(8)\r\nEndIf\r\n\r\n/*\r\nSomente para Qualitá\r\n*/\r\nConOut(FUNNAME())\r\nIf SubString(CNUMEMP,1,2) == \"01\" .And. (INCLUI == .T. .Or. ALTERA == .T.) .AND. (FUNNAME() <> \"GROA001\")\r\n\r\n\r\n\tM->C5_XMOTBLQ := \"\"\r\n\r\n\t/*\r\n\tSomente para Mercado Externo\r\n\tValidação mercado interno campos FollowUp\r\n\t*/\r\n\tIf M->C5_YTIPO $ \"ME/MI\"\r\n\t\tIF M->C5_XSHOWFO == \"S\"\r\n\t\t\tIf Empty(M->C5_XFOLLST) .Or. Empty(M->C5_XPENDEN) .Or. Empty(M->C5_XDTLIBF)\r\n\t\t\t\tAlert(\"FollowUp='SIM'! O P.Venda não pode ser salvo sem as informações de Pendência/Situação/Data de Liberação. \")\t\r\n\t\t\t\tReturn(.F.)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\tcDesMoed := \"\"\r\n\toFont := TFont():New('Arial Black',,-18,.T.)\r\n\t\r\n\tIf     M->C5_MOEDA == 1\r\n\t\tcDesMoed := \"1 - (R$)   R E A L\"\r\n\tElseIf M->C5_MOEDA == 2\r\n\t\tcDesMoed := \"2 - ($)    D O L A R\"\r\n\tElseIf M->C5_MOEDA == 3\r\n\t\tcDesMoed := \"3 - (€)    E U R O\"\r\n\tEndIf\r\n\t\r\n\tIf !IsBlind()     \r\n\t\tDEFINE MSDIALOG _oDlgMoeda TITLE \"Moeda\" FROM u_MGETTELA(178),u_MGETTELA(181) TO u_MGETTELA(342),u_MGETTELA(577) PIXEL\r\n\t\t\t// Cria as Groups do Sistema\r\n\t\t\t@ u_MGETTELA(001),u_MGETTELA(003) TO u_MGETTELA(062),u_MGETTELA(195) LABEL \"\" PIXEL OF _oDlgMoeda\r\n\t\t\r\n\t\t\t// Cria Componentes Padroes do Sistema\r\n\t\t\t@ u_MGETTELA(009),u_MGETTELA(010) Say \"Pedido sendo salvo na moeda:\" Size u_MGETTELA(075),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgMoeda\r\n\t\t\t@ u_MGETTELA(033),u_MGETTELA(078) Say cDesMoed \t\t\t\t\t\t Size u_MGETTELA(090),u_MGETTELA(080) COLOR CLR_HMAGENTA FONT oFont PIXEL OF _oDlgMoeda\r\n\t\t\t@ u_MGETTELA(064),u_MGETTELA(156) Button \"OK\" ACTION(Close(_oDlgMoeda)) Size u_MGETTELA(037),u_MGETTELA(012) PIXEL OF _oDlgMoeda\r\n\t\tACTIVATE MSDIALOG _oDlgMoeda CENTERED \r\n\tEndIf\r\n\r\n\tConOut(\"******************************************\" )\r\n\tConOut(\"Inicio P.E = MT410TOK Qualitá\" )\r\n\tConOut(\"******************************************\" )\t\r\n\t/*\r\n\t****************************************************************\r\n\tConferencia da tabela de preço com o desconto cadastrado por classificação comercial\r\n\t****************************************************************\r\n\t*/\r\n\tdbSelectArea(\"SA1\")\r\n\tdbSetOrder(1)\r\n\tdbSeek(xFilial(\"SA1\") + M->C5_CLIENTE + M->C5_LOJACLI )\r\n\t\r\n\tIf !Empty(SA1->A1_INFDESC)\r\n\t\tAlert(\"Aviso! Este cliente possui um desconto padrão! Verifique sempre pela tela [F5].\")\r\n\tEndIf\r\n\t\r\n\tIF M->C5_TIPO $ \"D\"\r\n\t\tReturn(.T.)\r\n\tEndIf\r\n\t\r\n\tIf !IsBlind()     \r\n\t\toProcess:IncRegua1(\"[1-8] - Conferência da tabela de preço com o desconto cadastrado!\")  \r\n\tEndIf\r\n\r\n\tFor nX := 1 To Len(aCols)\r\n\t\t/*\r\n\t\tRegra geral de tabela de preços \r\n\t\t*/\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\t\t\t\r\n\t\t\tIf Empty(SA1->A1_TABELA)\r\n\r\n\t\t\t\tIf Empty(GdFieldGet(\"C6_YCLASSI\",nX))\r\n\t\t\t\t\tcClassif := \"P\"\r\n\t\t\t\tElse\r\n\t\t\t\t\tcClassif := AllTrim(GdFieldGet(\"C6_YCLASSI\",nX))\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf GdFieldGet(\"C6_XOFERTA\",nX) == 'N'\r\n\r\n\t\t\t\t\tcQuery  := \" SELECT DA1_CODTAB,DA0_DESCRI,DA0_DESGER ,DA1_PRCVEN , CASE WHEN DA1_PERDES=0  THEN 1 WHEN DA1_PERDES<>0 THEN DA1_PERDES END  DA1_PERDES \r\n\t\t\t\t\tcQuery  += \"   FROM DA0010 DA0 \r\n\t\t\t\t\tcQuery  += \"        INNER JOIN DA1010 DA1 \r\n\t\t\t\t\tcQuery  += \" ON (DA0_CODTAB = DA1_CODTAB)\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) <> 'AM'\r\n\t\t\t\t\t\tcQuery  += \"  WHERE DA0_YCLASS IN ('\"+ cClassif +\"')\r\n\t\t\t\t\t\tcQuery  += \"    AND DA1_CODPRO = '\" + AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\"\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcQuery  += \"  WHERE DA1_CODPRO = '\" + AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\"\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\tIF !EMPTY(SA1->A1_MULTTAB)\r\n\t\t\t\t\t\tcQuery  += \"    AND DA0_CODTAB IN (\"+AllTrim(SA1->A1_MULTTAB)+\")\"\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tcQuery  += \"    AND DA0_CODTAB IN ('000','001','002','003')\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcQuery  += \"    AND DA0.D_E_L_E_T_ = ''\r\n\t\t\t\t\tcQuery  += \"    AND DA1.D_E_L_E_T_ = ''\r\n\t\t\t\t\t\r\n\t\t\t\t\ttcQuery cQuery alias TRB new\r\n\t\t\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\t\t\tdbgotop()\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Empty(TRB->DA1_PRCVEN) .and. !GDDeleted(nX) \r\n\t\t\t\t\t\tAlert(\"[C6_PRCVEN] - Tabela de preço não encontrada! Linha:(\" + Alltrim(str(nX)) +\") Confira a classif. do produto ou Mult.Tabelas preços no Cad. Cliente.\" )\r\n\t\t\t\t\t\tlRet := .F. \r\n\t\t\t\t\t\t//sleep(300)\t\r\n\t\t\t\t\t\tM->C5_BLQ  := '1'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//If GdFieldGet(\"C6_PRCVEN\",nX) <  IIF(cClassif==\"P\",((TRB->DA1_PRCVEN - TRB->DA0_DESGER)),((TRB->DA1_PRCVEN * TRB->DA0_DESGER))) .and. !GDDeleted(nX)\r\n\t\t\t\t\tIf GdFieldGet(\"C6_PRCVEN\",nX) <  IIF(cClassif==\"P\",((TRB->DA1_PRCVEN - TRB->DA0_DESGER)),((TRB->DA1_PRCVEN))) .and. !GDDeleted(nX)\r\n\t\t\t\t\t\t//aAdd(aMsgPrc,\"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + Alltrim(str(nX))+\" Tabela de Preço:\" + AllTrim(TRB->DA1_CODTAB) + \"-\"+ AllTrim(TRB->DA0_DESCRI))  \r\n\t\t\t\t\t\taAdd(aMsgPrc,\"Cavalete:\"+GdFieldGet(\"C6_YCAVALE\",nX)+\" Tabela de Preço:\" + AllTrim(TRB->DA1_CODTAB) + \"-\"+ AllTrim(TRB->DA0_DESCRI) )\r\n\t\t\t\t\t\t//lRet := .F.\r\n\t\t\t\t\t\tConOut(\"******************************************\")\r\n\t\t\t\t\t\tConOut(\"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + Alltrim(str(nX)))\r\n\t\t\t\t\t\tConOut(\"******************************************\")\r\n\t\t\t\t\t\t//sleep(300)\r\n\t\t\t\t\t\tM->C5_BLQ  := '1'\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"PREÇO MENOR QUE A TABELA DE PREÇO:\"+ AllTrim(TRB->DA1_CODTAB),nX)\t\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tGdFieldPut(\"C6_PRCREF\",TRB->DA1_PRCVEN,nX)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\t\tdbCloseArea()\r\n\t\t\t\telse\r\n\t\t\t\t\tM->C5_BLQ  := ''\r\n\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIF lRet == .F. .And. !IsBlind()  \r\n\t\t\t\t\tReturn(lRet) \r\n\t\t\t\tEndIf\r\n\t\t\tElse\r\n\t\t\t\t/*\r\n\t\t\t\tUsado para definir uma tabela de preço especifica para o cliente\r\n\t\t\t\t*/\r\n\t\t\t\tIf GdFieldGet(\"C6_XOFERTA\",nX) == 'N'\r\n\t\t\t\t\r\n\t\t\t\t\tcQuery  := \" SELECT DA1_CODTAB,DA0_DESCRI,DA0_DESGER,DA1_PRCVEN , CASE WHEN DA1_PERDES=0  THEN 1 WHEN DA1_PERDES<>0 THEN DA1_PERDES END  DA1_PERDES\r\n\t\t\t\t\tcQuery  += \"   FROM DA0010 DA0 \r\n\t\t\t\t\tcQuery  += \"        INNER JOIN DA1010 DA1 \r\n\t\t\t\t\tcQuery  += \" ON (DA0_CODTAB = DA1_CODTAB)\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) <> 'AM'\r\n\t\t\t\t\t\tcQuery  += \"  WHERE DA1_CODTAB IN ('\"+ M->C5_TABELA +\"')\r\n\t\t\t\t\t\tcQuery  += \"    AND DA1_CODPRO = '\"+AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t//TABELA PADRÃO DE AMOSTRAS\r\n\t\t\t\t\t\tcQuery  += \"  WHERE DA1_CODPRO = '\"+AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\r\n\t\t\t\t\t\tcQuery  += \"    AND DA0_CODTAB IN ('000')\r\n\t\t\t\t\tEndIf-\r\n\t\t\t\r\n\t\t\t\t\tcQuery  += \"    AND DA0.D_E_L_E_T_ = ''\r\n\t\t\t\t\tcQuery  += \"    AND DA1.D_E_L_E_T_ = ''\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\ttcQuery cQuery alias TRB new\r\n\t\t\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\t\t\tdbgotop()\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Empty(TRB->DA1_PRCVEN) .and. !GDDeleted(nX)\r\n\t\t\t\t\t\tAlert(\"[C6_PRCVEN] - Tabela de preço não encontrada! Linha:(\" + Alltrim(str(nX)) +\") Confira a classif. do produto ou Mult.Tabelas preços no Cad. Cliente.\" )\r\n\t\t\t\t\t\tlRet := .F.\r\n\t\t\t\t\t\t//sleep(300)\r\n\t\t\t\t\t\tM->C5_BLQ  := '1'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf GdFieldGet(\"C6_PRCVEN\",nX) <  TRB->DA1_PRCVEN .and. !GDDeleted(nX)\r\n\t\t\t\t\t\taAdd(aMsgPrc,\"Cavalete:\"+GdFieldGet(\"C6_YCAVALE\",nX)+\" Tabela de Preço:\" + AllTrim(TRB->DA1_CODTAB) + \"-\"+ AllTrim(TRB->DA0_DESCRI) ) \r\n\t\t\t\t\t\t//lRet := .F.\r\n\t\t\t\t\t\tConOut(\"******************************************\" )\r\n\t\t\t\t\t\tConOut(\"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + Alltrim(str(nX)))\r\n\t\t\t\t\t\tConOut(\"******************************************\" )\r\n\t\t\t\t\t\t//sleep(300)\t\r\n\t\t\t\t\t\tM->C5_BLQ  := '1'\r\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"Preço menor que a tabela:\"+ AllTrim(TRB->DA1_CODTAB),nX)\t\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tGdFieldPut(\"C6_PRCREF\",TRB->DA1_PRCVEN,nX)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\t\tdbCloseArea()\r\n\t\t\t\tElse\r\n\t\t\t\t\tM->C5_BLQ  := ''\r\n\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\t\tReturn(lRet) \r\n\t\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\t\r\n\t\tEndIf\r\n\tNext nX\r\n\t\r\n\tcMSG := \"\"\r\n\t\r\n\tFor nX:=1 to Len(aMsgPrc)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\r\n\t\t\tcMSG += aMsgPrc[nX] + chr(13)+chr(10)   \r\n\tNext nX\r\n\t\r\n\t\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)  \r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\tEndIf\r\n\t\r\n\t\r\n\t/*\r\n\t***************************************************************************************\r\n\tVerifica o erro do saldo no cavalete e no pedido \r\n\t***************************************************************************************\r\n\t\r\n\tnQtdPedVend := 0\r\n\t\r\n\tFor nX := 1 To Len(aCols)\r\n\t\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\r\n\t\tnQtdPedVend := GdFieldGet(\"C6_QTDVEN\",nX))\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \r\n\t\t\tIf !GDDeleted(nX)\r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\tNext nX\r\n\t*/\r\n\t\r\n\tConOut(\"******************************************\" )\r\n\tConOut(\"P.E = MT410TOK Qualitá Validação de cavaletes\" )\r\n\tConOut(\"******************************************\" )\r\n\r\n\t/*\r\n\t****************************************************************\r\n\tConferencia do cavaletes duplicados no proprio pedido \r\n\t****************************************************************\r\n\t*/\r\n\taNumCav \t:= {}\t\t\r\n\taTodCav \t:= {}\r\n    aGriCav \t:= {}\r\n    aGriCavDup \t:= {}\r\n    aGriLSPv    := {}\r\n    aLSPvLoca   := {}\t\r\n    aCavZero    := {}\r\n    aNumCavPro  := {}\r\n\taCavBenef   := {}\r\n    \r\n\tFor nX := 1 To Len(aCols)\r\n\t\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\r\n\t\t//ALERT(SB1->B1_COD +\"||\"+ SB1->B1_GRUPO)\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \r\n\t\r\n\t\t\tIf !Empty(GdFieldGet(\"C6_YCAVALE\",nX)) .and. !GDDeleted(nX) \r\n\t\t\t\tIf Empty( aScan(aNumCav,GdFieldGet(\"C6_YCAVALE\",nX)) )\r\n\t\t\t\t \taAdd(aNumCav   ,GdFieldGet(\"C6_YCAVALE\",nX))\r\n\t\t\t\t \taAdd(aNumCavPro,{GdFieldGet(\"C6_YCAVALE\",nX),GdFieldGet(\"C6_PRODUTO\",nX)})\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\tIf !GDDeleted(nX)\r\n\t\t\t\tIf Empty(aScan(aGriCav,AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) + GdFieldGet(\"C6_YCAVALE\",nX) + GdFieldGet(\"C6_LOTECTL\",nX) + GdFieldGet(\"C6_NUMLOTE\",nX)) )\r\n\t\t\t\t\taAdd(aGriCav , AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) + GdFieldGet(\"C6_YCAVALE\",nX) + GdFieldGet(\"C6_LOTECTL\",nX) + GdFieldGet(\"C6_NUMLOTE\",nX)  )\r\n\t\t\t\t\taAdd(aGriLSPv, {GdFieldGet(\"C6_LOTECTL\",nX) , GdFieldGet(\"C6_NUMLOTE\",nX) , AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))} )\r\n\t\t\t\tElse\r\n\t\t\t\t\tIF LEFT(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)),2)<>'AM'\r\n\t\t\t\t\t\taAdd(aGriCavDup, AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+GdFieldGet(\"C6_YCAVALE\",nX) + GdFieldGet(\"C6_LOTECTL\",nX) + GdFieldGet(\"C6_NUMLOTE\",nX)  )\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tEndIf\r\n\t\t\r\n\tNext nX\r\n\t\r\n\tcMSG := \"\"\r\n\tFor nX:=1 to Len(aGriCavDup)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Duplicados no pedido atual:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\r\n\t\t\tcMSG += \"O item: \" + aGriCavDup[nX] + chr(13)+chr(10)   \r\n\tNext nX\r\n\t\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\tlRet := .F.\r\n\t\t\r\n\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\tReturn(lRet) \r\n\t\tEndIf\r\n\tEndIf\r\n\t\r\n\t/*\r\n\t****************************************************************\r\n\tConferencia se todos os itens do cavales estao completos (Se estiverem em cavaletes)\r\n\tCavalete apagado por completo\r\n\tA mesma rotina confere se existe produtos sem saldo.\r\n\t****************************************************************\r\n\t*/\r\n\tIf !IsBlind()     \r\n\t\toProcess:IncRegua1(\"[2-8] - Teste de cavales completos,apagados e sem saldo!\")\r\n\tEndIf\r\n\r\n\t/*\r\n\tSOMENTE SE O PEDIDO NAO ESTIVER FATURADO \r\n\t*/\r\n\tIF LEN(AllTrim(M->C5_NOTA)) <> 9\r\n\t\r\n\t\t/*\r\n\t\tVALIDAÇÃO DO CAMPO DA ULTIMA ATUALIZAÇÃO DO FOLLOWUP\r\n\t\t*/\r\n\t\tM->C5_XULDTAU := DDATABASE\r\n\r\n\t\tFor nX := 1 To Len(aNumCavPro)\r\n\t\t\r\n\t\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSeek(xFilial(\"SB1\")+ aNumCavPro[nX][2] )\r\n\t\t\t\r\n\t\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\t\r\n\t\t\t \tcQuery  := \"  SELECT B8_PRODUTO,B1_DESC,B8_YCAVALE,B8_LOTECTL,B8_NUMLOTE,B8_YCAVALE+B8_LOTECTL+B8_NUMLOTE+B8_LOCAL CHAVE,B8_LOCAL,B8_SALDO \r\n\t\t\t \tcQuery  += \"    FROM SB8010 SB8 INNER JOIN SB1010 SB1 ON (B8_PRODUTO = B1_COD)\r\n\t\t\t \tcQuery  += \"   WHERE SB8.D_E_L_E_T_ = ''\r\n\t\t\t \tcQuery  += \"     AND SB1.D_E_L_E_T_ = ''\r\n\t\t\t \tcQuery  += \"     AND B8_YCAVALE = '\"+aNumCavPro[nX][1]+\"'\r\n\t\t\t \tcQuery  += \"     AND B8_PRODUTO = '\"+aNumCavPro[nX][2]+\"'\r\n\t\t\t \tcQuery  += \"     AND B8_ORIGLAN = 'BD'\r\n\t\t\t \tcQuery  += \"     AND B8_SALDO   <> 0\r\n\t\t\t \t\r\n\t\t\t \ttcQuery cQuery alias TRB new\r\n\t\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\t\tdbgotop()\r\n\t\t\t\tDo While !EOF()\r\n\t\t\t\t\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tcavaletes incompletos\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIF !aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE })  \r\n\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE , TRB->B8_LOCAL} )\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tif GDDeleted(aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE }))\r\n\t\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE,TRB->B8_LOCAL} )\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tSem Saldo\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf TRB->B8_SALDO == 0  \r\n\t\t\t\t\t\taAdd(aCavZero,{ TRB->CHAVE ,AllTrim(TRB->B8_PRODUTO)+\"-\"+ AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE, TRB->B8_LOCAL} )\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\tEndDo\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t/*\r\n\t\t\t\tCavalete apagado\r\n\t\t\t\t*/\r\n\t\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\t\tdbgotop()\r\n\t\t\t\tIf EOF() .And.  !Empty(aNumCav[nX])\r\n\t\t\t\t\r\n\t\t\t\t\tIF !aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE })  \r\n\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE, TRB->B8_LOCAL} )\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tif GDDeleted(aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE }))\r\n\t\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE , TRB->B8_LOCAL} )\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\tdbCloseArea()\r\n\t\t\tEndIf\r\n\r\n\r\n\t\t\t/*\r\n\t\t\tCavalete em beneficiamento não pode \r\n\t\t\tProibe\r\n\t\t\t*/\r\n\t\t\tIf aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] }) <> 0 .AND. M->C5_TIPO = 'B'\r\n\t\t\t\taAdd(aCavBenef,{ aNumCavPro[nX][1] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][3] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][5] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][10] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][36] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][24]} )\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tNext nX\r\n\r\n\r\n\t\tcMSG := \"\"\r\n\r\n\t\t/*\r\n\t\tBeneficiamento\r\n\t\t*/\t\t\r\n\t\tFor nX:=1 to Len(aCavBenef)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Pedido de Beneficiamento com cavaletes:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\t\t\t\r\n\t\t\tcMSG +=     \"  ->\" + AllTrim(aCavBenef[nX][2]) + \" Cav.[\" + Alltrim(aCavBenef[nX][3]) + \"] Lote[\" + Alltrim(aCavBenef[nX][4]) + \"] SubLote[\" + Alltrim(aCavBenef[nX][5]) + \"] Local [\"+ Alltrim(aCavBenef[nX][6]) +\"].\"+ chr(13)+chr(10)   \r\n\t\tNext nX\r\n\r\n\t\t/*\r\n\t\tIncompletos/Apagado\r\n\t\t\r\n\t\tFor nX:=1 to Len(aTodCav)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Cavaletes incompletos/Apagado:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\t\t\t\r\n\t\t\tcMSG +=     \"  ->\" + AllTrim(aTodCav[nX][2]) + \" Cav.[\" + Alltrim(aTodCav[nX][3]) + \"] Lote[\" + Alltrim(aTodCav[nX][4]) + \"] SubLote[\" + Alltrim(aTodCav[nX][5]) + \"] Local [\"+ Alltrim(aTodCav[nX][6]) +\"].\"+ chr(13)+chr(10)   \r\n\t\tNext nX\r\n\t\t*/\r\n\t\tIf !Empty(cMSG)\r\n\t\t\tAlert(cMSG)\r\n\t\t\t//AVISO(\"Cavaletes incompletos:\", cMSG , { \"Fechar\" }, 3)\r\n\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\tlRet := .F.\r\n\r\n\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\tReturn(lRet)\r\n\t\t\tEndIf \r\n\t\tEndIf\r\n\t\r\n\t\t/*\r\n\t\tSem Saldo\r\n\t\t*/\r\n\t\tcMSG := \"\"\r\n\t\tFor nX:=1 to Len(aCavZero)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Produtos sem saldo:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\t\t\t\r\n\t\t\tcMSG +=     \"  ->\" + AllTrim(aCavZero[nX][2]) + \" Cav.[\" + Alltrim(aCavZero[nX][3]) + \"] Lote[\" + Alltrim(aCavZero[nX][4]) + \"] SubLote.[\" + Alltrim(aCavZero[nX][5]) + \"]\"+ chr(13)+chr(10)   \r\n\t\tNext nX\r\n\t\t\r\n\t\tIf !Empty(cMSG)\r\n\t\t\tIF (!Empty(C5_NOTA).Or.C5_LIBEROK=='E' .And. Empty(C5_BLQ))\r\n\t\t\t\tAlert(cMSG)\r\n\t\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\tELse \r\n\t\t\t\tAlert(cMSG)\r\n\t\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\t\t\r\n\t\t\t\tlRet := .F.\r\n\r\n\t\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\t\tReturn(lRet)\r\n\t\t\t\tEndIf \r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\tEndIf\r\n\t\r\n\t/*\r\n\t****************************************************************\r\n\tConferencia se existe estes Lote/SubLotes em um PVenda salvo\r\n\t****************************************************************\r\n\t*/\r\n\tIf !IsBlind()     \r\n\t\toProcess:IncRegua1(\"[3-8] - Conferência se existe  Lote/SubLotes em um P.Venda salvo!\")\r\n\tENDIF\r\n\r\n\tFor nX := 1 To Len(aGriLSPv)\r\n\t\t \t\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(aGriLSPv[nX][3]) )\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec .AND. !Empty(aGriLSPv[nX][1])\r\n\t\t \tcQuery  := \" SELECT C6_NUM,C6_ITEM,C6_LOTECTL,C6_NUMLOTE ,C6_DESCRI \r\n\t\t \tcQuery  += \"   FROM SC6010 SC6 INNER JOIN SC5010 SC5 ON (C5_FILIAL = C6_FILIAL AND C5_NUM = C6_NUM)\r\n\t\t \tcQuery  += \"  WHERE SC6.D_E_L_E_T_ = ''\r\n\t\t \tcQuery  += \"    AND SC5.D_E_L_E_T_ = ''\r\n\t\t \tcQuery  += \"    AND C5_TIPO = 'N'\r\n\t\t \tcQuery  += \"    AND C6_NOTA = ''\r\n\t\t \tcQuery  += \" \tAND C6_LOTECTL = '\"+aGriLSPv[nX][1]+\"'\r\n\t\t \tcQuery  += \" \tAND C6_NUMLOTE = '\"+aGriLSPv[nX][2]+\"'\r\n\t\t \tcQuery  += \"    AND C6_NUM <> '\"+AllTrim(M->C5_NUM)+\"'\r\n\t\t \t\r\n\t\t \ttcQuery cQuery alias TRB new\r\n\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\tdbgotop()\r\n\t\t\tDo While !EOF()\r\n\t\t\t\r\n\t\t\t\tIf !aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })\r\n\t\t\t\t\taAdd(aLSPvLoca,{ AllTrim(TRB->C6_NUM) , TRB->C6_ITEM,TRB->C6_LOTECTL , TRB->C6_NUMLOTE , AllTrim(TRB->C6_DESCRI) } )\r\n\t\t\t\tElse\r\n\t\t\t\t\taLSPvLoca[aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })][2] := aLSPvLoca[aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })][2] + \",\" + TRB->C6_ITEM\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\tdbSkip()\r\n\t\t\tEndDo\r\n\t\t\t\r\n\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\tdbCloseArea()\r\n\t\t\r\n\t\tEndIf\r\n\t\t\r\n\tNext nX\r\n\t\r\n\tcMSG := \"\"\r\n\tFor nX:=1 to Len(aLSPvLoca)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Itens encontrados em outro P.Venda:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\r\n\t\t\tcMSG += \"  -> P.Venda:\" + aLSPvLoca[nX][1] +\" Item:\"+ aLSPvLoca[nX][2] +\" Prod.:\" + aLSPvLoca[nX][5] + chr(13)+chr(10)   \r\n\tNext nX\r\n\t\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\t//AVISO(\"Itens encontrados em outro P.Venda:\", cMSG , { \"Fechar\" }, 3)\r\n\t\t//sleep(300)\t\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\r\n\t\tlRet := .F.\r\n\r\n\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\tReturn(lRet)\r\n\t\tEndIf \r\n\tEndIf\r\n\t\r\n\t/*\r\n\t*******************************************\r\n\tValidação Valores fiscais e descontos e totais\r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()     \r\n\t\toProcess:IncRegua1(\"[4-8] - Conferência fiscal, descontos e valores!\")\r\n\tENDIF\r\n\r\n\taDadosGrv := FCalImp(@oProcess)\r\n\t\r\n\tIf LEN(aDadosGrv)>0\r\n\t\tM->C5_XVALEXT := AllTrim(Extenso((aDadosGrv[4] + aDadosGrv[3]) ,.f.,M->C5_MOEDA,,\"3\",.t.,.f.))\r\n\t\tM->C5_XTOTAL  := (aDadosGrv[4] + aDadosGrv[3]) -  M->C5_DESCONT \r\n\t\tM->C5_XDESCON := aDadosGrv[2]  + M->C5_DESCONT \r\n\t\tM->C5_XVLRFIN := (aDadosGrv[4] + aDadosGrv[3]) -  M->C5_DESCONT \r\n\t\tM->C5_XDESPES := aDadosGrv[4]\r\n\t\t//M->C5_XSEGURO := aDadosGrv[5]\r\n\tEndIf \r\n\t\r\n\t\t\r\n\t/*\r\n\t*******************************************\r\n\tValidação do peso para Amostras \r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()  \r\n\t\toProcess:IncRegua1(\"[5-8] - Validação do peso para Amostras!\")\r\n\tEndIf\r\n\r\n\tcMSG := \"\"\r\n\t\r\n\tFor nX := 1 To Len(aCols)\r\n\t\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\r\n\t\t\tIf Empty(GdFieldGet(\"C6_XPESO\",nX)) .and. !GDDeleted(nX) .and. SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) == 'AM'\r\n\t\t\t\r\n\t\t\t\tIf Empty(cMSG)\r\n\t\t\t\t\tcMSG := \"Amostras sem Peso:\" + chr(13)+chr(10) \r\n\t\t\t\tEndIf\r\n\t\t\t\tcMSG += \"  -> Item do PV:\" + GdFieldGet(\"C6_ITEM\",nX) + \" Prod.:\" + AllTrim(GdFieldGet(\"C6_DESCRI\",nX)) + chr(13)+chr(10)  \r\n\t\t\t\t\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf !GDDeleted(nX) .and. (SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) == 'AM' .Or. AllTrim(GdFieldGet(\"C6_YCLASSI\",nX)) == \"A\")\r\n\t\t\t\tM->C5_BLQ  := '1'\r\n\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"Produto Amostra! Requer aprovação.\" ,nX)\r\n\t\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(\"Produto Amostra! Requer aprovação.\") + chr(13)+chr(10)\r\n\t\t\t\tcMSG := AllTrim(cMSG) + AllTrim(\"Produto Amostra! Requer aprovação.\") + chr(13)+chr(10)\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tEndIf\r\n\tNext nX\r\n\t\r\n\tIf M->C5_DESCONT  <> 0\r\n\t\tM->C5_BLQ  := '1'\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(\"O Campo de desconto de indenização foi preenchido. Ped. Venda requer aprovação.\" + chr(13)+chr(10))\r\n\t\tcMSG := AllTrim(cMSG) + \"O Campo de desconto de indenização foi preenchido. Ped. Venda requer aprovação.\" + chr(13)+chr(10)\r\n\tEndIf\r\n\t\r\n\tIF !EMPTY(cMSG)\r\n\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\r\n\t\tIf !IsBlind()  \r\n\t\t\tIf MsgYesNo(cMSG + chr(13)+chr(10)+ \"Deseja continuar?\" )\r\n\t\t\t\tlRet := .t.\r\n\t\t\tElse\r\n\t\t\t\tlRet := .F.\r\n\t\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\t\tReturn(lRet)\r\n\t\t\t\tEndIf \r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\r\n\tEndIf\r\n\t\r\n\t/*\r\n\t*******************************************\r\n\tValidação para não permitir salvar o pedido com chapas sem cavaletes \r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()\r\n\t\toProcess:IncRegua1(\"[6-8] - Chapas sem cavaletes!\")\r\n\tEndIf\r\n\r\n\tcMSG := \"\"\r\n\t\r\n\t/*\r\n\tNão validar para filial de SP \r\n\tnão validar para Pedidos de Transferencia\r\n\t*/\r\n\tIF M->C5_YTIPO <> \"TF\" .AND. SubString(CNUMEMP,1,8) == \"01010101\" .and. M->C5_TIPO <> 'B'\r\n\r\n\t\tFor nX := 1 To Len(aCols)\r\n\t\t\r\n\t\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )  \r\n\t\t\t\r\n\t\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\t\r\n\t\t\t\tIf Empty(GdFieldGet(\"C6_YCAVALE\",nX)) .and. !GDDeleted(nX) .and. SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) == 'CH'\r\n\t\t\t\t\r\n\t\t\t\t\tIf Empty(cMSG)\r\n\t\t\t\t\t\tcMSG := \"Chapas sem cavaletes:\" + chr(13)+chr(10) \r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcMSG += \"  -> Item do PV:\" + GdFieldGet(\"C6_ITEM\",nX) + \" Prod.:\" + AllTrim(GdFieldGet(\"C6_DESCRI\",nX)) + chr(13)+chr(10)  \r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tNext nX\r\n\t\t\r\n\t\tIf !Empty(cMSG)\r\n\t\t\tAlert(cMSG)\r\n\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)  \r\n\t\t\t\r\n\t\t\tlRet := .F.\r\n\r\n\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\tReturn(lRet)\r\n\t\t\tEndIf \r\n\t\tEndIf\r\n\r\n\tEndIf\r\n\r\n\t/*\r\n\t*******************************************\r\n\tValidação para não permitir salvar o pedido fora dos almoxarificados ou locais determinados \r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()\r\n\t\toProcess:IncRegua1(\"[7-8] - Almoxarifado não permitido !\")\r\n\tENDIF\r\n\r\n\tcMSG := \"\"\r\n\r\n\tFor nX := 1 To Len(aCols)\r\n\t\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\r\n\t\t\tIf !GdFieldGet(\"C6_LOCAL\",nX) $ \"03/05\"  .and. !GDDeleted(nX) .and. SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) $ 'CH/AM'\r\n\t\t\t\r\n\t\t\t\tIf Empty(cMSG)\r\n\t\t\t\t\tcMSG := \"Almoxarifado não permitido ! \" + chr(13)+chr(10) \r\n\t\t\t\tEndIf\r\n\t\t\t\tcMSG += \"  -> Item do PV:\" + GdFieldGet(\"C6_ITEM\",nX) + \" Prod.:\" + AllTrim(GdFieldGet(\"C6_DESCRI\",nX)) + chr(13)+chr(10)  \r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext nX\r\n\t\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\r\n\t\tlRet := .F.\r\n\r\n\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\tReturn(lRet)\r\n\t\tEndIf \r\n\tEndIf\r\n\r\n\r\n    /*\r\n\t*******************************************\r\n\tValidação dos dados de condição de pagamento\r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()\r\n\t\toProcess:IncRegua1(\"[8-8] - Validação dos dados de condição de pagamento!\")\r\n\tEndIf\r\n\r\n\tM->C5_CONDPAG := u_ClintToMob(\"PG\")\r\n\r\n\tIf ! M->C5_TIPO $ \"D/B\"\r\n\t\tdbSelectArea(\"SA1\")\r\n\t\tdbSetOrder(1)\r\n\t\tIf dbSeek(xFilial(\"SA1\")+M->C5_CLIENTE+M->C5_LOJACLI)\r\n\t\t\tIf ! AllTrim(M->C5_CONDPAG) $ AllTrim(SA1->A1_XCONDPG)\r\n\r\n\t\t\t\tIf Empty(cMSG)\r\n\t\t\t\t\tcMSG := \"Pedido bloqueado! Condição de pagamento não permitida. Cond. Pag:[\"+ M->C5_CONDPAG +\"].\" + chr(13)+chr(10) \r\n\t\t\t\tEndIf\r\n\r\n\t\t\tEndIf\r\n\t\tEndIf \r\n\r\n\tEndIf\r\n\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\tM->C5_BLQ     := \"1\"\r\n\tEndIf\r\n\t\r\n\t/*\r\n\tVALIDAÇÃO DO MOBGRAN\r\n\t*/\r\n\tIf  FunName() $ \"GROA014\" .And. INCLUI == .T.\r\n\t\t\r\n\t\tIf !Empty(M->C5_XIDMOB)\r\n\r\n\t\t\t/*\r\n\t\t\tVerifica se existe a chave no mobgran.\r\n\t\t\t*/\r\n\t\t\tcQuery  := \" SELECT * FROM ZSA010 WHERE D_E_L_E_T_ = '' AND ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\"' AND ZSA_STATUS ='ATIVA'\r\n\t\t\t\r\n\t\t\ttcQuery cQuery alias TRB new\r\n\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\tdbgotop()\r\n\t\t\t\r\n\t\t\tIf EOF() \r\n\t\t\t\tlRet := .F.\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf TRB->ZSA_STATUS <> 'ATIVA'\r\n\t\t\t\tlRet := .F.\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf lRet == .F.\r\n\t\t\t\tAlert(\"Chave não encontrada ou Status:(>>\"+ TRB->ZSA_STATUS +\"<<) no MobGran!\")\r\n\t\t\t\tReturn(lRet)\t\r\n\t\t\tEndIf\r\n\r\n\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\tdbCloseArea()\t\r\n\r\n\t\tElse\r\n\t\t\t\r\n\t\t\tlRet := .F.\r\n\t\t\tAlert(\"Chave do MobGran em branco! Favor informar um código.\")\r\n\t\t\tReturn(lRet)\r\n\r\n\t\tEndIf\r\n\r\n\tElseIf FunName() $ \"GROA013\" \r\n\t\tIf AllTrim(M->C5_XIDMOB) == '-'\r\n\t\t\tlRet := .T.\r\n\t\telse\r\n\t\t\tcQuery  := \" SELECT * FROM ZSA010 WHERE D_E_L_E_T_ = '' AND ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\"' AND ZSA_STATUS ='ATIVA'\r\n\t\t\t\r\n\t\t\ttcQuery cQuery alias TRB new\r\n\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\tdbgotop()\r\n\t\t\t\r\n\t\t\tIf EOF() \r\n\t\t\t\tlRet := .F.\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf TRB->ZSA_STATUS <> 'ATIVA'\r\n\t\t\t\tlRet := .F.\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf lRet == .F.\r\n\t\t\t\tAlert(\"Chave não encontrada ou Status:(>>\"+ TRB->ZSA_STATUS +\"<<) no MobGran!\")\r\n\t\t\t\tReturn(lRet)\t\r\n\t\t\tEndIf\t\t\t\r\n\t\t\t\r\n\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\tdbCloseArea()\t\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\t/*\r\n\tEnvio de aviso de alteração de pedidos \r\n\t*/\r\n\tIF        AllTrim(C5_XSHOWFO) = 'S';\r\n\t\t.AND. AllTrim(C5_XPENDEN) $ 'COM/LOG';\r\n\t\t.AND. AllTrim(C5_XFOLLST) = 'BOOKING SOLICITADO'\r\n\r\n\t\t/*\r\n\t\tEMAIL\r\n\t\t*/\r\n\t\tIf SC5->C5_YTIPO == \"ME\"\r\n\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\tElse\r\n\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\tEndIf\r\n\t\t\r\n\t\tConOut(\"Gerando relatório! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\r\n\t\tsleep(300)\r\n\t\tConOut(\"Gerando e-mail! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\r\n\t\t\r\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"backoffice.es@qualitagroup.com;bruno.lage@grupoqualita.com.br;arlindo.pelissari@grupoqualita.com.br\",'Pedido BOOKING SOLICITADO ! Código:' + SC5->C5_NUM ,'PEDIDO BOOKING SOLICITADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\r\n\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"bruno.lage@grupoqualita.com.br\",'Pedido BOOKING SOLICITADO ! Código:' + SC5->C5_NUM ,'PEDIDO BOOKING SOLICITADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\r\n\r\n\t\t//sleep(500)\r\n\r\n\t\t/*\r\n\t\tWHATSAPP\r\n\t\t*/\r\n\t\t/*\r\n\t\tU_SWENARWAP(\"5527981188913\", \"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM),\"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM)   ,\"RQ0003a\"           ,\"PDF\",\"\\RELINWEB\\RQ0003a.PDF\")\r\n\t\tsleep(500)\r\n\t\tU_SWENARWAP(\"5533984022125\", \"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM),\"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM)   ,\"RQ0003a\"           ,\"PDF\",\"\\RELINWEB\\RQ0003a.PDF\")\r\n\t\t*/\r\n\tEnd\r\n\r\n\t/*\r\n\tIntegração liberação Pedido de venda Com o Mobgran por tabela\r\n\tTABELA - ZSC\r\n\t*/\r\n\tIf Empty(M->C5_XMOTBLQ) \r\n\t\t//M->C5_XMOTBLQ := \"06 = Aguardando liberação do vendedor!\" + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\tM->C5_BLQ     := \"\"\r\n\t\tfTPBLQ        := .T.\r\n\tEndIf\r\n\r\n\tif (Empty(M->C5_NOTA) .OR. M->C5_NOTA == 'XXXXXXXXX' )\r\n\t\tIF (!Empty(M->C5_XIDMOB) .Or. M->C5_XIDMOB <> '-') \r\n\t\t\tu_MIntMGLib(M->C5_NUM , M->C5_XIDMOB , \"SC5\" , M->C5_XMOTBLQ , M->C5_FILIAL , M->C5_XTOTAL , fTPBLQ )\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\tConOut(\"******************************************\" )\r\n\tConOut(\"Final P.E = MT410TOK Qualitá\" )\r\n\tConOut(\"******************************************\" )\r\n\t\r\n\tSetKey(VK_F5,)\r\n\tSetKey(VK_F6,)\r\nEndIf\r\n\r\nIF (lRet == .F. .and. IsBlind()) \r\n\tlRet := .T.\r\nEndIf \r\n\r\nReturn(lRet)\r\n\r\n\r\nUser Function MIntMGLib(cPedido,XIdMobP,_cTabela, xMotBlq, cMobFilial , nXtotal , fTPBLQ)\r\n********************************************************************************************************************\r\n* /* User Integração com MobGran Liberação de pedidos por tabela ZSA ZSC */\r\n* /**/\r\n* //\r\n***\r\n\r\nLocal oJson     := JsonObject():New()\r\nLocal cCliente  := \"\"\r\nLocal cLoja     := \"\"\r\nLocal nValor    := 0\r\nLocal cCondPg   := \"\"\r\nLocal lSemFin   := .F.\r\n\r\n\t\tcQuery := \" SELECT  CAST(ZSC_RJSON AS VARCHAR(8000)) RJSON from \"+ RetSqlName(\"ZSC\")+ \" WHERE ZSC_IDMOBP = '\"+XIdMobP+\"' AND ZSC_TIPO <> 'B' AND ZSC_TIPO = '2' AND ZSC_RJSON IS NOT NULL\"\r\n\t\r\n\t\ttcQuery cQuery alias TRB_JSON new\r\n\t\tdbSelectArea(\"TRB_JSON\")\r\n\t\tdbgotop()\r\n\r\n\t\toJSon:fromJson(TRB_JSON->RJSON)\r\n\t\r\n\t\tcCliente  := iif(empty(oJson:GetJSonObject('cliente')),\"\",oJson:GetJSonObject('cliente'))\r\n\t\tcLoja     := iif(empty(oJson:GetJSonObject('loja'))   ,\"\",oJson:GetJSonObject('loja'))\r\n\r\n\t\tif !Empty(oJson:GetJSonObject('cliente'))\r\n\t\t\tnValor    := round(val(oJson:GetJSonObject('valorTotal')),2) \r\n\t\tElse\r\n\t\t\tnValor    := 0\r\n\t\tEndIf\r\n\r\n\t\tcCondPg   := iif(empty(oJson:GetJSonObject('condicaoPagamento')),\"\",oJson:GetJSonObject('condicaoPagamento'))\r\n\r\n\t\tdbSelectArea(\"TRB_JSON\") \r\n\t\tdbCloseArea()\t\r\n\t\tIf !Empty(oJson:GetJSonObject('cliente'))\r\n\t\t\tIf \tcCliente+cLoja       == m->C5_CLIENTE+m->C5_LOJACLI .And.;\r\n\t\t\t\tAllTrim(Str(nValor)) >= AllTrim(Str(nXTotal))    \t.And.;\r\n\t\t\t\tcCondPg              == m->C5_CONDPAG\r\n\r\n\t\t\t\tcQuery := \" UPDATE \"+RetSqlName(\"ZSC\")\r\n\t\t\t\tcQuery += \"    SET ZSC_TIPO = 'B'\r\n\t\t\t\tcQuery += \"  WHERE ZSC_IDMOBP  ='\"+ AllTrim(XIdMobP) +\"'\r\n\t\t\t\tcQuery += \"    AND ZSC_TIPO < '2'\r\n\t\t\t\t\r\n\t\t\t\tlSemFin:= .F.\r\n\t\t\tElse\r\n\t\t\t\tcQuery := \" UPDATE \"+RetSqlName(\"ZSC\")\r\n\t\t\t\tcQuery += \"    SET ZSC_TIPO = 'B'\r\n\t\t\t\tcQuery += \"  WHERE ZSC_IDMOBP  ='\"+ AllTrim(XIdMobP) +\"'\r\n\r\n\t\t\t\tlSemFin:= .T.\r\n\t\t\tEndIf \r\n\t\tElse\r\n\t\t\t\tcQuery := \" UPDATE \"+RetSqlName(\"ZSC\")\r\n\t\t\t\tcQuery += \"    SET ZSC_TIPO = 'B'\r\n\t\t\t\tcQuery += \"  WHERE ZSC_IDMOBP  ='\"+ AllTrim(XIdMobP) +\"'\r\n\r\n\t\t\t\tlSemFin:= .T.\t\r\n\t\tEndIf\t\r\n\t\t/*\r\n\t\tExecucao background do codigo sql\r\n\t\t*/\r\n\t\tTcSqlExec(cQuery)\r\n\r\n\t\t//regras\r\n\t\tIf fTPBLQ == .F.\r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"1\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With IIF(fTPBLQ == .F. ,xMotBlq,\"\" )\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With IIF(fTPBLQ == .F. ,\"\"    ,\"X\" )\r\n\t\t\t\t\tReplace ZSC_FLUXOM With IIF(fTPBLQ == .F. ,\"S\"    ,\"\" )\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\t\tEndIf\r\n\t\t//financeiro\r\n\t\tIf lSemFin \r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"2\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\t\t\t\r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"3\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"4\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"5\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\r\n\t\t\t/*\r\n\t\t\tPendencia Vendedor\r\n\t\t\t*/ \r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"6\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With IIF(fTPBLQ == .t. ,xMotBlq,\"\")\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\t\tReplace ZSC_FLUXOM With IIF(fTPBLQ == .t. ,\"S\"    ,\"\")\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\t\tEndIf\r\n\r\nReturn()\r\n\r\n\r\nUser Function ClintToMob(cTipo)\r\n****************************************************************************************************************\r\n* /*Gatilho C5_XIDMOB*/    \r\n*\r\n****\r\nLocal aArea     := GetArea() \r\nLocal cQuery    := \" SELECT * FROM ZSA010 WHERE D_E_L_E_T_ = '' AND ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\" ' AND ZSA_STATUS ='ATIVA'\r\nLocal cDadosRet := \"\" \r\n\r\ntcQuery cQuery alias TRBidMob new\r\ndbSelectArea(\"TRBidMob\")\r\ndbgotop()\r\n\r\nConOut(\"****PRINCIPAL**ClintToMob*************\")\r\n\r\nIf !EOF()\r\n\tIf cTipo == \"PG\"\r\n\t\tcDadosRet  := AllTrim(TRBidMob->ZSA_CPAG)\r\n\tElse\r\n\t\tcDadosRet  := AllTrim(TRBidMob->ZSA_CLIENT)\r\n\tEndIf\r\nElse\r\n\tcDadosRet := M->C5_CONDPAG\r\nEndIf\r\n\r\ndbSelectArea(\"TRBidMob\") \r\ndbCloseArea()\t\r\n\r\nRestArea(aArea)\r\n\r\nReturn(cDadosRet)\r\n\r\n                                                                       \r\nStatic Function FCalImp(oProcess) \r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\n************************************** \r\n* Calculo totais e Impostos\r\n************************************** \r\nLocal aArea     := GetArea() \r\nLocal nX        := 0 \r\n//Local nPrcTot   := 0\r\nLocal _aTotalNF := {} \r\nLocal nValDesc  := 0\r\nLocal nItem:= 0                             \r\n\r\n//IF FunName() == Alltrim(\"GROA014\")\r\n\r\n\tConOut(\"************************************\")\r\n\tConOut(\"MaFisIni\")                 \r\n\tConOut(\"************************************\")\r\n\t\r\n\t// Inicia rotina de calculo dos impostos \r\n\tMaFisIni(Iif(Empty(M->C5_CLIENT),M->C5_CLIENTE,M->C5_CLIENT),;\t// 1-Codigo Cliente/Fornecedor \r\n\t     \tM->C5_LOJAENT,;          \t\t\t\t\t\t\t\t// 2-Loja do Cliente/Fornecedor \r\n\t     \tIIf(M->C5_TIPO$\"DB\",\"F\",\"C\"),;                    \t\t// 3-C:Cliente , F:Fornecedor \r\n\t     \tM->C5_TIPO,;                    \t\t\t\t\t\t// 4-Tipo da NF \r\n\t     \tM->C5_TIPOCLI,;          \t\t\t\t\t\t\t\t// 5-Tipo do Cliente/Fornecedor \r\n\t     \tNil,; \r\n\t     \tNil,; \r\n\t     \tNil,; \r\n\t     \tNil,; \r\n\t     \t\"GROA014\") \r\n\t\r\n     If (Inclui .Or. Altera) \r\n               nItem:= 0\r\n\t   \r\n\t\t\t   ConOut(\"************************************\")\r\n\t\t\t   ConOut(\"MaFisAdd\")                                  \r\n\t\t\t   ConOut(\"************************************\") \r\n\t\t\t   \r\n\t\t\t   If !IsBlind()\r\n\t\t\t\t\toProcess:SetRegua2(len(aCols))\r\n\t\t\t   ENDIF\r\n\t\t\t   \r\n               For nX := 1 to len(aCols) \r\n                    If !GDDeleted(nX)\t\t\t\t\t\t\t//Validar se o registro nao esta deletado \r\n                         \r\n                         nItem:= nItem + 1 \t\t\t\t\t\t// Quantidade para recalcular \r\n                         \r\n                         // Adiciona dados dos produtos na rotina de calculo de impostos       \r\n                         MaFisAdd( GdFieldGet(\"C6_PRODUTO\",nX),; \r\n                                   GdFieldGet(\"C6_TES\"    ,nX),; \r\n                                   GdFieldGet(\"C6_QTDVEN\" ,nX),; \r\n                                   GdFieldGet(\"C6_PRCVEN\" ,nX),; \r\n                                   0,; //GdFieldGet(\"C6_VALDESC\",nX)\r\n                                   \"\",; \r\n                                   \"\",; \r\n                                   0,; \r\n                                   0,; \r\n                                   0,; \r\n                                   0,; \r\n                                   0,; \r\n                                   GdFieldGet(\"C6_VALOR\",nX),; \r\n                                   0,; \r\n                                   0,; \r\n                                   0)\r\n                               \r\n                         nValDesc := nValDesc + Round(GdFieldGet(\"C6_VALDESC\",nX),2)\r\n\t\t\t\t\t\t \r\n\t\t\t\t\t\t If !IsBlind()  \r\n                         \toProcess:IncRegua2(\"Cavalete [\"+GdFieldGet(\"C6_YCAVALE\",nX)+\"] Lote-Chapa: \"+AllTrim(GdFieldGet(\"C6_LOTECTL\",nX))+\"-\"+GdFieldGet(\"C6_NUMLOTE\",nX)  )\r\n                         ENDIF\r\n\r\n                         //ConOut(nValDesc)\r\n                         //ConOut(nItem)\r\n                    EndIf \r\n                \r\n               Next nX                \r\n     EndIf \r\n     \r\n     /*\r\n     _nIcmsRet := 0 \r\n     For nLo:=1 To nItem           \r\n          _nIcmsRet += MaFisRet(nLo,\"LF_ICMSRET\") // Retorna valor da ST  \r\n     Next nLo       \r\n     */\r\n\t   \r\n\t aAdd(_aTotalNF,MaFisRet(,\"NF_TOTAL\"))\r\n\t aAdd(_aTotalNF,nValDesc)\r\n\t aAdd(_aTotalNF,MaFisRet(,\"NF_BASEDUP\"))\r\n \t aAdd(_aTotalNF,M->C5_DESPESA)\r\n\t //aAdd(_aTotalNF,MaFisRet(,\"NF_SEGURO\"))  \r\n\t\r\n\t MaFisEnd() \t// Encerra rotina de calculo de impostos \r\n\r\n//EndIf\r\n\r\nRestArea(aArea) \r\n\r\nReturn(_aTotalNF)\r\n\r\n\r\nUser Function GMA410MNU() \r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal aButtons := {}\r\n\r\nIF FunName() == Alltrim(\"GROA014\")\t\r\n\t//Gerando invoice\r\n\taRotina[16][1] := \"Gerar Invoice\"\r\n\taRotina[16][2] := 'Processa({|| u_MNumInv()},,\"Gravando....\")'\r\n\t\r\n\t//\"Imprime Packing List\"\r\n\t//aRotina[20][2] := \"u_RelInWeb('RQ0002','Imprime Packing List [RQ0002]','u_fParAut(2)')\"\r\n\taRotina[17][2][5][2] := \"u_RelInWeb('RQ0002','Imprime Packing List [RQ0002]','u_fParAut(2)')\"\r\n\t\r\n\t//\"Imprime Commercial Invoice\" \r\n\t//aRotina[19][2] := \"u_RelInWeb('RQ0004','Imprime Invoice (CH/AM)[RQ0004]','u_fParAut(4)')\"\r\n\taRotina[17][2][4][2] := \"u_RelInWeb('RQ0004','Imprime Invoice (CH/AM)[RQ0004]','u_fParAut(4)')\"\r\n\t\r\n\t//\"Imprime Proforma Invoice\"\r\n\t//aRotina[18][2] := \"u_RelInWeb('RQ0003','Imprime Proforma Invoice [RQ0003]','u_fParAut(2)')\"\t \r\n\taRotina[17][2][3][2] := \"u_RelInWeb('RQ0003','Imprime Proforma Invoice [RQ0003]','u_fParAut(2)')\"\r\n\t\r\n\t//aRotina[17][2] := \"U_proformaInvoice()\"//#Brittes Alterada chamada da Funcao\r\n\t//\"Imprime Pedido de Venda\"\r\n\taRotina[17][2][1][1] := \"Pre-Nota\" \r\n\taRotina[17][2][1][2] := \"u_MATR730Q()\"\r\n\t\r\n\t//\"Imprime Romaneio\"\r\n\taRotina[17][2][2][1] := \"Imprime Invoice (BLOCOS)\"\r\n\taRotina[17][2][2][2] := \"u_RelInWeb('RQ0004_BLOCK','Imprime Invoice (BLOCOS) [RQ0004_BLOCK]'    ,'u_fParAut(4)')\"\r\n\t//aadd(aRotina,{'Imprime Invoice (BLOCOS)',\"u_RelInWeb('RQ0004_BLOCK','Imprime Invoice (BLOCOS) [RQ0004_BLOCK]'    ,'u_fParAut(4)')\" , 0 , 3,0,NIL})\r\n\t\r\nElseIf FunName() == Alltrim(\"GROA013\")\r\n\r\n\taadd(aRotina,{'Imp. Packing List',\"u_RelInWeb('RQ0002_P','Imprime Packing List [RQ0002_P]'    ,'u_fParAut(2)')\" , 0 , 3,0,NIL})\r\n\taadd(aRotina,{'Imp. Proforma'    ,\"u_RelInWeb('RQ0003_P','Imprime Proforma Invoice [RQ0003_P]','u_fParAut(2)')\" , 0 , 3,0,NIL})\t\r\n\taadd(aRotina,{'Pre-Nota'    \t ,\"u_MATR730Q()\" \t\t\t\t\t\t\t\t\t\t\t  \t\t\t\t\t, 0 , 3,0,NIL})\t\r\n\t\r\nEndIf\r\n\r\naadd(aRotina,{'Ajustes Gerais {P.Venda}',\"u_AjuGerais()\" , 0 , 3,0,NIL})\r\n\r\naadd(aRotina,{'Aprovação WhatsApp ',\"u_WAppAprov()\" , 0 , 3,0,NIL})\r\n\r\naadd(aRotina,{'Limpar FollowUp' ,\"u_ClearFol()\"  , 0 , 3,0,NIL})\t\r\n\r\nReturn aButtons\r\n\r\nUser Function ClearFol()\r\n****************************************************************************************************************\r\n*    // LIMPA FOLLOWUP PELO PERIODO SOMENTE OVADOS\r\n*\r\n****\r\nLocal cQuery:=\"\"\r\n\r\nPrivate aPerg := {}\r\nPrivate cPerg := \"MLIMPAFOLL\"\r\n\r\nAadd(aPerg,{cPerg,\"Data Incial  ?\"\t\t,\"D\",08,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Data Final   ?\"\t\t,\"D\",08,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nU_Testasx1(cPerg,aPerg,.T.)\r\n\r\nIf ! Pergunte(cPerg,.T.)\r\n\tReturn()\r\nEndIf\r\n\r\nIf Empty(mv_par01)\r\n\tAlert(\"Data inicial não pode ficar em branco!\")\r\n\tReturn()\r\nEndIf\r\n\r\nIf Empty(mv_par02)\r\n\tAlert(\"Data final não pode ficar em branco!\")\r\n\tReturn()\r\nEndIf\r\n\r\ncQuery :=  \"  UPDATE SC5010\r\ncQuery +=  \"    SET C5_XSHOWFO =\t'N'\r\ncQuery +=  \"  WHERE R_E_C_N_O_ IN(\r\ncQuery +=  \"  \t\t\t\t\t\tSELECT REC FROM (\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\tSELECT\t  R_E_C_N_O_ REC,\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  C5_FILIAL,\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  C5_NUM ,\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  C5_NOTA+'/'+C5_SERIE AS NF,\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  (SELECT F2_EMISSAO FROM SF2010 WHERE D_E_L_E_T_ = '' AND F2_FILIAL = C5_FILIAL AND F2_DOC = C5_NOTA AND F2_SERIE = C5_SERIE AND F2_CLIENTE = C5_CLIENTE AND F2_LOJA = C5_LOJACLI) DATA\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t  FROM SC5010 \r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t WHERE D_E_L_E_T_ = ''\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND C5_XSHOWFO IN('S')\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND C5_TIPO IN ('N')\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND C5_XVLRFIN <> 0\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND RTRIM(LTRIM(C5_XFOLLST)) IN ('OVADO','CARREGADO','FATURADO')\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t)TB_TEMP\r\ncQuery +=  \"  \t\t\t\t\t\t WHERE DATA BETWEEN '\"+dToS(mv_par01)+\"' AND '\"+dToS(mv_par02)+\"'\r\ncQuery +=  \"  \t\t\t\t\t\t)\r\n\r\nTcSQLExec(cQuery)\r\n\r\nAlert(\"FollowUp removidos com sucesso!\")\r\n\r\nReturn()\r\n\r\nUser Function WAppAprov()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal cProt   := \"\"\r\n//Local cProt2  := \"\"\r\nLocal cMotiv  := \"\"\r\nLocal cQuery  := \"SELECT DISTINCT UPPER(RTRIM(LTRIM(C6_XMOTBLQ))) C6_XMOTBLQ FROM SC6010 WHERE D_E_L_E_T_ ='' AND C6_FILIAL+C6_NUM = '\" + SC5->C5_FILIAL + SC5->C5_NUM + \"' AND UPPER(RTRIM(LTRIM(C6_XMOTBLQ))) <> ''\r\n\r\n\r\ntcQuery cQuery alias TRBE new\r\ndbSelectArea(\"TRBE\")\r\ndbgotop()\r\n\r\nDo While !EOF()\r\n\t\r\n\tcMotiv := cMotiv + TRBE->C6_XMOTBLQ + chr(13)+chr(10)\r\n\r\n\tdbSelectArea(\"TRBE\") \r\n\tdbSkip()\r\nEndDo\r\n\r\ndbSelectArea(\"TRBE\") \r\ndbCloseArea()\r\n\r\nIF FunName() == Alltrim(\"GROA014\")\r\n\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\nElseIf FunName() == Alltrim(\"GROA013\")\r\n\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\nEndIf\r\n\r\nsleep(4000)\r\n\r\n/*\r\nLimite de Credito\r\n*/\r\n//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0057&CLIENTES='+AllTrim(SC5->C5_CLIENTE)+AllTrim(SC5->C5_LOJACLI)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0057.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\r\n//Grupo de Faturamento Whatsapp\r\n\r\n/*\r\nTeste\r\n*/\r\n//cProt  := U_SWENARWAP(\"5551997331669\",\"Aprovação da Proforma:\" +AllTrim(SC5->C5_NUM) + chr(13)+chr(10) + \" Motivo:\" + cMotiv + chr(13)+chr(10) + \" Usuário:\" + SUBSTR(CUSUARIO,7,15), \"PROFORMA\"+AllTrim(SC5->C5_NUM),\"RQ0003\",\"PDF\",\"\\RELINWEB\\RQ0003.pdf\")\r\n\r\n/*\r\nOficial\r\n*/\r\ncProt  := U_SWENARWAP(\"5527995295180-1587589430@g.us\",\"Aprovação da Proforma:\" +AllTrim(SC5->C5_NUM) + chr(13)+chr(10) + \" Motivo:\" + cMotiv + chr(13)+chr(10) + \" Usuário:\" + SUBSTR(CUSUARIO,7,15), \"PROFORMA\"+AllTrim(SC5->C5_NUM),\"RQ0003\",\"PDF\",\"\\RELINWEB\\RQ0003.pdf\")\r\n\r\nIF cProt = \"\" .or. cProt = nil \r\n\tAlert(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde!\")\r\n\tReturn()\r\nEndIf\r\n\r\nIf  RecLock(\"WAM\",.T.) \r\n\r\n\tReplace WAM_FILIAL  With \"\" \r\n\tReplace WAM_DATA    With Date()\r\n\tReplace WAM_HORA    With Time()\r\n\tReplace WAM_ID      With cProt\r\n\tReplace WAM_MSG     With \"Aprovação da Proforma:\" +AllTrim(SC5->C5_NUM) + \"Motivo:\" + cMotiv +  \"Usuário:\" + SUBSTR(CUSUARIO,7,15) + \" Cliente: \" + AllTrim(SC5->C5_XFRFORW) \r\n\t//Replace WAM_TELL    With \"5551997331669\"\r\n\t//Replace WAM_TELL    With \"5533984022125\"\r\n\tReplace WAM_INDEX   With SC5->C5_FILIAL + SC5->C5_NUM\r\n\tReplace WAM_PERG    With \"S\"\r\n\t//Replace WAM_DATAR   With \"\"\r\n\t//Replace WAM_HORAR   With \"\"\r\n\t//Replace WAM_RESPOSV With \"\"\r\n\t\r\n\tIF SubString(CNUMEMP,1,2) == \"05\"\r\n\t\tReplace WAM_EXEC    With 'ITINGA-PV'\r\n\tElse\r\n\t\tReplace WAM_EXEC    With 'QUALITA-PV'\r\n\tEndIf\r\n\t\r\n\r\n   MsUnLock()\r\nEndIf\r\n\t\t\r\nAlert(\"WhatsApp enviado com sucesso! \" + cProt)\r\n\r\nReturn()\r\n\r\n\r\nUser Function WAppResp()\r\n****************************************************************************************************************\r\n*NÃO USADO     \r\n*\r\n**** \r\nLocal cQuery  := \"SELECT TOP 1 * FROM WAM010 WHERE D_E_L_E_T_ = '' AND WAM_INDEX = '\"+SC5->C5_FILIAL + SC5->C5_NUM+\"' ORDER BY R_E_C_N_O_ DESC\"\r\n\t\t\t\t  \r\nLocal aRetMsg := \"\"\r\n\r\ntcQuery cQuery alias TRB new\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\n\r\nIf !Empty(TRB->WAM_ID)\r\n\taRetMsg :=\tstrTokArr(U_SWREMGWAP(TRB->WAM_ID), ',' )\r\nEndIf\r\n\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n\r\nIf !\"false\" $ aRetMsg[7]\r\n\tIf (\"SIM\" $ Upper(aRetMsg[8])) .OR. ( \"APROVADO\" $ Upper(aRetMsg[8]) )\r\n\t\r\n\t \r\n\t\tRecLock(\"SC5\",.F.)\r\n\t\t\tSC5->C5_BLQ  := ''\r\n\t\tMsUnlock()\t\r\n\t\t/*\r\n\t\tdbSelectArea(\"SC6\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(SC5->C5_FILIAL + SC5->C5_NUM)\r\n\t\tWhile SC6->(!EOF()) .And. SC6->C6_FILIAL + SC6->C6_NUM == SC5->C5_FILIAL + SC5->C5_NUM\r\n\t\t                                      \r\n\t\t      MaLibDoFat(SC6->(RecNo()),SC6->C6_QTDVEN,,,.T.,.T.,.F.,.F.)\r\n\t\t\r\n\t\t   SC6->(dBSkip())\r\n\t\tEndDo\r\n\t\t*/\r\n\tEndIf\r\nElse \r\n\tAlert(\"Pedido ainda não liberado!\")\r\nEndIf\r\n\r\nReturn() \r\n\r\nUser Function AjuGerais()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nPrivate aPerg := {}\r\nPrivate cPerg := \"AJUSGERAIS\"\r\nPrivate nOpc  := 0\r\n\r\nnOpc := Aviso(\"Atenção\",\"Estes ajustes devem ser usados somente em casos especiais! Pedido: [\"+SC5->C5_NUM+\"] .\" ,{\"Confirma\",\"Abandona\"})\t\r\n\r\nIf nOpc == 2\r\n\tReturn()\r\nEndIf\r\n                  \r\nAadd(aPerg,{cPerg,\"Alterar o peso líquido:\",\"N\",12,04,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Alterar o peso bruto :\" ,\"N\",12,04,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nAadd(aPerg,{cPerg,\"Alterar qtd volume 1:\"  ,\"N\",03,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})     \r\nAadd(aPerg,{cPerg,\"Alterar qtd Box:\"       ,\"N\",03,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nU_Testasx1(cPerg,aPerg,.t.) \r\n\r\nIf ! Pergunte(cPerg,.T.)\r\n\tReturn()\r\nEndIf\r\n\r\nRecLock(\"SC5\",.F.)\r\n\tSC5->C5_PESOL    := mv_par01\r\n\tSC5->C5_PBRUTO   := mv_par02\r\n\tSC5->C5_VOLUME1  := mv_par03\r\n\tSC5->C5_VOLUME2  := mv_par04\r\nMsUnlock()\t\r\n\r\nAviso(\"Atualização:\",\"Pedido: [\"+SC5->C5_NUM+\"] atualizado com sucesso!\" ,{\"Ok\"})\r\n\r\nReturn()\r\n\r\n\r\nUser Function MNumInv()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal cNumInvo := GetMv(\"MV_XNUMINV\")\r\nLocal cQuery   := \"\"\r\n\r\nIF EMPTY(SC5->C5_YINVOIC)\r\n\t\r\n\tProcRegua(3) \r\n\t\r\n\tPutMv(\"MV_XNUMINV\",Soma1(cNumInvo))\r\n\t\r\n\tIncProc(\"Criando Invoice:\" + cNumInvo) \r\n\tSleep( 1000 ) \r\n\t\r\n\tIncProc(\"Salvando...\" + cNumInvo)\r\n\tSleep( 1000 ) \r\n\t\r\n\tIncProc(\"Liberando....\" + cNumInvo)\r\n\tSC5->(reclock(\"SC5\", .F.))\r\n\tSC5->C5_YINVOIC := cNumInvo\t\t\t\t\t\t\t\t\t\r\n\tSC5->(msUnLock())\r\n\tSleep( 1000 )\r\n\t\r\n\tAVISO(\"Invoice\", \"Invoice gerada com sucesso! Número=\" + cNumInvo  , { \"Fechar\" }, 1)\r\n\t\r\n\t//U_GROA014A()\r\n\t//AxInclui(\"SZO\")\r\n\t\r\n\tdbSelectArea(\"ZGO\")\r\n\tdbSetOrder(1)\r\n\tIf dbSeek(xFilial(\"ZGO\") + SC5->C5_NUM + SC5->C5_CLIENTE + SC5->C5_LOJACLI)\r\n\t\tZGO->(reclock(\"ZGO\", .F.))\r\n\t\tZGO->ZGO_INVOIC := cNumInvo\t\t\t\t\t\t\t\t\t\r\n\t\tZGO->(msUnLock())\r\n\t\t//U_GROA014A()\r\n\tElse\r\n\t\tZGO->(reclock(\"ZGO\", .T.))\r\n\t\tZGO->ZGO_FILIAL := xFilial(\"ZGO\")\r\n\t\tZGO->ZGO_INVOIC := cNumInvo\t\r\n\t\tZGO->ZGO_PEDIDO := SC5->C5_NUM\r\n\t\tZGO->ZGO_CLIENT := SC5->C5_CLIENTE\r\n\t\tZGO->ZGO_LOJA\t:= SC5->C5_LOJACLI\t\t\t\t\t\t\r\n\t\tZGO->(msUnLock())\r\n\tEndIf\r\n\t\r\n\tcQuery := \"SELECT CAST(M2_DATA AS DATE) DATA, MAX(M2_MOEDA2) 'DOLAR' , MAX(M2_MOEDA3) 'EURO'\r\n\tcQuery += \"  FROM SM2010\r\n\tcQuery += \"  WHERE D_E_L_E_T_ = ''\r\n\tcQuery += \"    AND M2_DATA  = '\"+DToS(dDataBase)+\"'\r\n\tcQuery += \"   GROUP BY M2_DATA\r\n\t\r\n\tTcQuery cQuery Alias TMP_MOEDA New\r\n\tdbSelectArea(\"TMP_MOEDA\")\r\n\t\r\n\tSC5->(reclock(\"SC5\", .F.))\r\n\tSC5->C5_MENNOTA := AllTrim(SC5->C5_MENNOTA) + \" //INVOICE:\" + SC5->C5_YINVOIC + \"-\" + LEFT(DToS(dDataBase),4) +  \"  TAXA DO DOLAR R$:\" + AllTrim(STR(TMP_MOEDA->DOLAR)) + \" CNTR:\" + AllTrim(SC5->C5_XCONTAI) \r\n\tSC5->(msUnLock())\r\n\t\r\n\tdbSelectArea(\"TMP_MOEDA\")\r\n\tdbCloseArea()            \r\nElse \r\n\r\n\tAVISO(\"Invoice\", \"Já existe invoice para esse pedido! Número=\" + SC5->C5_YINVOIC  , { \"Fechar\" }, 1)\r\n\r\nEndIf\t\r\n\r\nReturn()\r\n\r\n\r\nUser Function fParAut(nTipo)\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal cRet := \"\"\r\n\r\nIf nTipo = 2\r\n\tcRet :=  \"&FILIAL=\" + AllTrim(SC5->C5_FILIAL) +\"&NUMPED=\" + AllTrim(SC5->C5_NUM) \r\nElse\r\n\tdbSelectArea(\"ZGO\")\r\n\tdbSetorder(1)\r\n\tIf dbSeek(xFilial(\"ZGO\")+AllTrim(SC5->C5_NUM))\r\n\t\tcRet := \"&FILIAL=\" + AllTrim(ZGO->ZGO_FILIAL) +\"&INVOICE=\" + AllTrim(ZGO->ZGO_INVOIC)\r\n\tElse\r\n\t\tAlert(\"Pedido de venda sem Invoice!\")\r\n\tEndIf\r\nEndIf\r\n\r\nReturn(cRet)\r\n\r\n\r\nUser Function GA410CONS() \r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal aButtons := {}\r\n\r\nSetKey(VK_F5,{||u_MCONSUTDET()})\r\nSetKey(VK_F6,{||u_GERAMSGPAD()})\r\n\r\naAdd(aButtons, {\"\", {|| u_MCONSUTDET()}, \"[F5] Consulta GrPlus\", \"[F5] Consulta GrPlus\"})\r\naAdd(aButtons, {\"\", {|| u_GERAMSGPAD()}, \"[F6] Gera Msg Padrão\", \"[F6] Gera Msg Padrão\"})\r\n\r\nReturn aButtons\r\n\r\nUser Function GERAMSGPAD()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal cQuery   := \"\"         \r\n//Local aPeso    := {}\r\n//Local nResult  := 0     \r\n//Local cBoleto  := \"\"\r\nLocal cMsgNota := \"\"    \r\n//Local cMsgNota2:= \"\"                         \r\nLocal cNotas   := \"\"\r\nLocal aGriCavDW:= {}\r\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\r\nLocal cInCavDw := \"\"\r\nLocal nX       := 0\r\n\r\n/*\r\nMensagem foi retirada de uso conforme chamado numero 1109\r\nControle de drawback em tempo Real.\r\n*/\r\nIF TYPE(\"aCols\") == \"A\"\r\n\tFor nX := 1 To Len(aCols)\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \r\n\t\t\tIf !GDDeleted(nX) .and. LEFT(GdFieldGet(\"C6_LOTECTL\",nX),2)=='DW'\r\n\t\t\t\tIf Empty(aScan(aGriCavDW,GdFieldGet(\"C6_LOTECTL\",nX)) )\r\n\t\t\t\t\taAdd(aGriCavDW , GdFieldGet(\"C6_LOTECTL\",nX)  )\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext nX\r\n\tIf !Empty(aGriCavDW)\r\n\t\tFor nX := 1 To Len(aGriCavDW)\t\t\r\n\t\t\taGriCavDW[nX] := LEFT(AllTrim(aGriCavDW[nX]),8)\r\n\t\t\tcInCavDw := cInCavDw +  \"'\"+AllTrim(aGriCavDW[nX])+\"',\"\r\n\t\tNext nX\r\n\t\tcInCavDw := Left(cInCavDw,Len(cInCavDw)-1)\r\n\tEndIf\r\n\t\r\n\r\n\tIf !Empty(cInCavDw)\r\n\t\t\r\n\t\tcQuery := \" SELECT DISTINCT DOC ,\r\n\t\tcQuery += \" \t\t\t\tEMISSAO\r\n\t\tcQuery += \"   FROM(\r\n \t\tcQuery += \" \t SELECT\r\n \t\tcQuery += \" \t\t\tLOTE,\r\n\t\tcQuery += \" \t\t\tIIF(EMISSAO<>'',EMISSAO,ISNULL((SELECT TOP 1 D1_EMISSAO FROM SD1010 WHERE D_E_L_E_T_ = '' AND D1_LOTECTL = LEFT(LOTE, LEN(RTRIM(LTRIM(LOTE)))-1) AND LEFT(D1_COD,2) = 'BL'),'')) EMISSAO,\r\n \t\tcQuery += \" \t\t\tIIF(DOC<>'',DOC,ISNULL((SELECT TOP 1 D1_DOC FROM SD1010 WHERE D_E_L_E_T_ = '' AND D1_LOTECTL = LEFT(LOTE, LEN(RTRIM(LTRIM(LOTE)))-1) AND LEFT(D1_COD,2) = 'BL'),'')) DOC\r\n \t\tcQuery += \" \t   FROM (\r\n \t\tcQuery += \" \t\t\tSELECT\tLOTE,\r\n \t\tcQuery += \" \t\t\t\t\tIIF(FORNECE<>'000011','', DOC) DOC,\r\n \t\tcQuery += \" \t\t\t\t\tEMISSAO,\r\n\t\tcQuery += \" \t\t\t\t\tD1_SERIE,\r\n \t\tcQuery += \" \t\t\t\t\tFORNECE\r\n \t\tcQuery += \" \t\t\t\t\tFROM (\t\r\n \t\tcQuery += \" \t\t\t\t\t\t\tSELECT DISTINCT D1_LOTECTL LOTE, \t\t\t\t\r\n \t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_DOC DOC,\r\n\t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_EMISSAO EMISSAO, \r\n \t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_SERIE,\r\n \t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_FORNECE  FORNECE\r\n \t\tcQuery += \" \t\t\t\t\t\t\tFROM SD1010 \r\n \t\tcQuery += \" \t\t\t\t\t\t\tWHERE D_E_L_E_T_ = '' \r\n \t\tcQuery += \" \t\t\t\t\t\t\tAND D1_LOTECTL IN (\"+cInCavDw+\")\r\n \t\tcQuery += \" \t\t\t\t\t\t )TB_TEMP\r\n \t\tcQuery += \" \t\t  )TAB_TEMP\r\n \t\tcQuery += \" \t)TAB_TEMP_FIM\r\n \t\tcQuery += \" WHERE DOC <> ''\r\n\t\t\r\n\t\tTcQuery cQuery Alias TMP_NOTA New\r\n\t\tdbSelectArea(\"TMP_NOTA\")\r\n\t\t\r\n\t\tDo While !EOF()\r\n\t\t\r\n\t\t\tcNotas := cNotas + AllTrim(TMP_NOTA->DOC) + \"-\" + dtoc(STOd(TMP_NOTA->EMISSAO))+ \" ,\"  \r\n\t\t\r\n\t\t\tdbSelectArea(\"TMP_NOTA\")\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\t\t\r\n\t\tdbSelectArea(\"TMP_NOTA\")\r\n\t\tdbCloseArea()\r\n\t\r\n\t\t//cMsgNota += \"ESTA NOTA FISCAL CONTEM INSUMOS IMPORTADOS ADQUIRIDOS DE ITINGA MINERACAO LTDA. PELA NF:\"+cNOtas+\" AMPARADO PELO REGIME DRAWBACK INTEGRADO - MODALIDADE SUSPENSAO, TIPO INTERMEDIARIO ATO CONCESSÓRIO Nº 20190019344 DE 08/05/2019.///\"   \r\n\tEndIf\r\n\t\r\n\tcQuery := \"SELECT CAST(M2_DATA AS DATE) DATA, MAX(M2_MOEDA2) 'DOLAR' , MAX(M2_MOEDA3) 'EURO'\r\n\tcQuery += \"  FROM SM2010\r\n\tcQuery += \"  WHERE D_E_L_E_T_ = ''\r\n\tcQuery += \"    AND M2_DATA  = '\"+DToS(dDataBase)+\"'\r\n\tcQuery += \"  GROUP BY M2_DATA \r\n\t\r\n\tTcQuery cQuery Alias TMP_MOEDA New\r\n\tdbSelectArea(\"TMP_MOEDA\")\r\n\t\r\n\tcMsgNota += \"INVOICE:\" + AllTrim(M->C5_YINVOIC) + \"-\" + LEFT(DToS(dDataBase),4) +  \"  TAXA DO DOLAR R$:\" + AllTrim(STR(TMP_MOEDA->DOLAR)) + \" CNTR:\" + AllTrim(M->C5_XCONTAI) + \" LACRE:\" + AllTrim(M->C5_XSEAL)\r\n\t\t        \r\n\tdbSelectArea(\"TMP_MOEDA\")\r\n\tdbCloseArea()                       \r\n\t\r\n\tIf !Empty(m->C5_MENNOTA)\r\n\t\tIf MsgYesNo(\"O campo [C5_MENNOTA], já possui informção. Deseja subistituir a mensagem original?\" )\r\n\t\t\tm->C5_MENNOTA := memoline(AllTrim(cMsgNota),254,1,,.T.)\r\n\t\t\tm->C5_MSG2    := memoline(AllTrim(cMsgNota),254,2,,.T.)\r\n\t\tEndIf\t\t\r\n\tElse\r\n\t\tm->C5_MENNOTA := memoline(AllTrim(cMsgNota),254,1,,.T.)\r\n\t\tm->C5_MSG2    := memoline(AllTrim(cMsgNota),254,2,,.T.)\r\n\tEndIf\r\n\t\r\nElse\r\n\r\n\tSetKey(VK_F5,)\r\n\tSetKey(VK_F6,)\r\n\r\nEndIf\r\n\r\nReturn\r\n\r\nStatic Function MAltVlrAut(cNumItem,cNumChapa) \r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal nEdit1\t := 0\r\nLocal oEdit1\r\n\r\nLocal nEdit2\t := 0\r\nLocal oEdit2\r\n\r\nLocal nEdit3\t := SA1->A1_INFDESC\r\nLocal oEdit3\r\n\r\n//Local nEdit4\t := 0\r\n//Local oEdit4\r\n\r\nLocal lNExec     := .F.\r\nLocal lNDele     := .F.\r\n\r\nLocal nX         := 0\r\n\r\n// Variaveis Private da Funcao\r\nPrivate _oDlgVlr\t\t\t\t// Dialog Principal\r\n\r\n// Variaveis que definem a Acao do Formulario                    \r\nDEFINE MSDIALOG _oDlgVlr TITLE \" ITEM \" + cNumItem   FROM u_MGETTELA(223),u_MGETTELA(173) TO u_MGETTELA(359),u_MGETTELA(520) PIXEL\r\n\r\n\t// Cria as Groups do Sistema\r\n\t@ u_MGETTELA(003),u_MGETTELA(005) TO u_MGETTELA(044),u_MGETTELA(168) LABEL \"\" PIXEL OF _oDlgVlr\r\n\r\n\t// Cria Componentes Padroes do Sistema\r\n\t@ u_MGETTELA(010),u_MGETTELA(008) Say \"Valor Negociado:\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t@ u_MGETTELA(010),u_MGETTELA(050) MsGet oEdit1 Var nEdit1            Size u_MGETTELA(35)  ,u_MGETTELA(009) picture(\"@E 9,999,999.99999\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t\r\n\t@ u_MGETTELA(010),u_MGETTELA(085) Say \"Desconto padrão: {%}\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t@ u_MGETTELA(010),u_MGETTELA(130) MsGet oEdit3 Var nEdit3            Size u_MGETTELA(35) ,u_MGETTELA(009) when(.f.) picture(\"@E 99.99\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t\r\n\t@ u_MGETTELA(028),u_MGETTELA(008) Say \"Novo desconto: {%}\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t@ u_MGETTELA(028),u_MGETTELA(050) MsGet oEdit2 Var nEdit2            Size u_MGETTELA(35) ,u_MGETTELA(009) picture(\"@E 99.99999\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t\r\n\t//@ u_MGETTELA(028),u_MGETTELA(085) Say \"Desconto: {Vlr}\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t//@ u_MGETTELA(028),u_MGETTELA(130) MsGet oEdit4 Var nEdit4            Size u_MGETTELA(35) ,u_MGETTELA(009) picture(\"@E 9999.99\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t\r\n\t@ u_MGETTELA(047),u_MGETTELA(131) Button \"Ok\" \t\tSize u_MGETTELA(037),u_MGETTELA(012)  ACTION( lNExec := .T. , Close(_oDlgVlr))  PIXEL OF _oDlgVlr\r\n\t//@ u_MGETTELA(047),u_MGETTELA(085) Button \"Deletar\" \tSize u_MGETTELA(037),u_MGETTELA(012)  ACTION( lNDele := .T. , Close(_oDlgVlr))  PIXEL OF _oDlgVlr\r\n\t//@ u_MGETTELA(050),u_MGETTELA(007) Say \"O valor irá subistituir todas as chapas do cavalete! \"  Size u_MGETTELA(113),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\r\nACTIVATE MSDIALOG _oDlgVlr CENTERED\r\n\r\n\r\nIf lNDele\r\n\tFor nX := 1 To Len(aCols)\r\n\t\tIf AllTrim(GdFieldGet(\"C6_YCAVALE\",nX)) == AllTrim(cNumCav)\t\t\t\r\n\t\t\t aCols[nX][Len(aHeader)+1] := .T.\r\n\t\tEndIf\r\n\tNext nX\r\nEndIf\r\n\r\nIf lNExec\r\n\t\r\n\tIf !Empty(nEdit1) .Or. !Empty(nEdit2)\r\n\t\tFor nX := 1 To Len(aCols)\r\n\t\t\r\n\t\t\tIf !Empty(nEdit1)\r\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRUNIT\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX) //C6_PRUNIT 23/09/2019\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t\tEndIf\r\n\t\t\tElse\r\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\r\n\t\t\t\t\t\t//GdFieldPut(\"C6_PRUNIT\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX) //C6_PRUNIT 23/09/2019\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tNext nX\r\n\tEndIf\r\n\t\r\n\t/*\r\n\tIf !Empty(nEdit1) .Or. !Empty(nEdit2) .Or. !Empty(nEdit4)\r\n\t\tFor nX := 1 To Len(aCols)\r\n\t\t\tIf Empty(nEdit4 )\r\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRUNIT\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX) //C6_PRUNIT 23/09/2019\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t\tEndIf\r\n\t\t\tElse \r\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//nEdit4 := round(nEdit4 / cNumChapa,2)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tnEdit2 := (nEdit4*100)/GdFieldGet(\"C6_VALOR\",nX)  \r\n\t\t\t\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tNext nX\r\n\tElse\r\n\t\tIf !Empty(nEdit3)\r\n\t\t\t\r\n\t\t\t//For nX := 1 To Len(aCols)\r\n\t\t\t//\tIf AllTrim(GdFieldGet(\"C6_YCAVALE\",nX)) == AllTrim(cNumCav)\t\t\t\r\n\t\t\t//\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit3,nX)\r\n\t\t\t//\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCREF\",nX) ,nEdit1) * nEdit3) /100,2),nX)\r\n\t\t\t//\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,GdFieldGet(\"C6_PRCREF\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCREF\",nX) ,nEdit1) * nEdit2) /100   ,nX)\r\n\t\t\t//\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t//\tEndIf\r\n\t\t\t//Next nX\r\n\t\t\t\r\n\t\tEndIf\r\n\tEndIf\r\n\t*/\r\n\t \r\nEndIf\r\n\r\n\r\nReturn \r\n\r\n\r\nUser Function MCONSUTDET()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\n// Variaveis Locais da Função\r\nLocal cEdit1\t := Space(100)\r\nLocal cEdit2\t := Space(100)\r\nLocal cEdit3\t := Space(100)\r\nLocal oEdit1\r\nLocal oEdit2\r\nLocal oEdit3\r\n\r\nLocal nX         := 0\r\n\r\n// Variaveis Private da Funcão\r\nPrivate _oDlg\t  // Dialog Principal\r\n\r\n// Variaveis que definem a Acao do Formulario\r\nPrivate VISUAL := .F.                        \r\nPrivate INCLUI := .F.                        \r\nPrivate ALTERA := .F.                        \r\nPrivate DELETA := .F.        \r\n\r\n// Privates das ListBoxes\r\nPrivate aListBox1 := {}\r\nPrivate oListBox1\r\nPrivate aFlist   := {}\r\n\r\n/*\r\nInicializando Variaveis \r\n*/\r\n\r\niF TYPE(\"aCols\") == \"A\"\r\n\r\n\tIF !(M-> C5_TIPO $ \"D,B\")   //Se for nota de devolucao\r\n\t\tcEdit1  := Posicione(\"SA1\",1,XFilial(\"SA1\")+M->C5_CLIENTE+M->C5_LOJACLI,\"A1_NOME\")                   // Retorna o nome do Cliente\r\n\tELSE\r\n\t\tcEdit1  := POSICIONE(\"SA2\",1,XFILIAL(\"SA2\")+M->C5_CLIENTE+M->C5_LOJACLI,\"A2_NOME\")\t\t\t\t\t // Retorna o nome do Fornecedor      \r\n\tENDIF\r\n\tcEdit2 := Posicione(\"SE4\",1,XFilial(\"SE4\")+M->C5_CONDPAG,\"E4_DESCRI\") \r\n\tcEdit3 := Posicione(\"SA3\",1,XFilial(\"SA3\")+M->C5_VEND1,\"A3_NOME\") \r\n\t\r\n\tDEFINE MSDIALOG _oDlg TITLE \"CONSULTA DETALHADA GRPLUS\" FROM u_MGETTELA(333),u_MGETTELA(275) TO u_MGETTELA(734),u_MGETTELA(795) PIXEL\r\n\t\r\n\t// Cria Componentes Padroes do Sistema\r\n\t@ u_MGETTELA(006),u_MGETTELA(005) Say \"NOME DO CLIENTE:\" Size u_MGETTELA(042),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(006),u_MGETTELA(052) MsGet oEdit1 Var cEdit1 when(.f.) Size u_MGETTELA(200),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(021),u_MGETTELA(006) Say \"COND. PAGAMENTO:\" Size u_MGETTELA(046),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(021),u_MGETTELA(052) MsGet oEdit2 Var cEdit2 when(.f.) Size u_MGETTELA(057),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(021),u_MGETTELA(114) Say \"NOME VENDEDOR:\" Size u_MGETTELA(055),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(021),u_MGETTELA(165) MsGet oEdit3 Var cEdit3 when(.f.) Size u_MGETTELA(087),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(180),u_MGETTELA(215) Button \"OK\"  Size u_MGETTELA(037),u_MGETTELA(012) ACTION(Close(_oDlg)) PIXEL OF _oDlg\r\n\t\r\n\t@ u_MGETTELA(035),u_MGETTELA(006) ListBox oListBox1 Fields ;\r\n\t\tHEADER \"ITEM\",\"CAVALETE\",\"P.LIQUIDO\",\"P.BRUTO\",\"QTD CHAPAS\",\"QTD RECORTE/AMOSTRAS\";\r\n\t\tSize u_MGETTELA(247),u_MGETTELA(140) Of _oDlg Pixel;\r\n\t\tColSizes 05,80,50,50,50,20\r\n\r\n\t\toListBox1:bLDblClick := {||  iif(fLibFunc(aFlist[oListBox1:nAT,01])==.t., MAltVlrAut(aFlist[oListBox1:nAT,01],aFlist[oListBox1:nAT,04]) , Alert(\"Produto oferta não pode ser alterado!\") )  }\r\n\r\n\t// Chamadas das ListBox do Sistema\r\n\tfListBox1()\r\n\t\r\n\tFor nX := 1 To Len(aFlist)\r\n\t\tIf AllTrim(aFlist[nX][1]) == AllTrim(GdFieldGet(\"C6_ITEM\",n))\r\n\t\t\t//oListBox1:Select(nX)\r\n\t\t\t//oListBox1:bLine := { || aFlist[ oListBox1:nX ] }\r\n\t\t\toListBox1:nAt := Nx\r\n\t\tEndIf\r\n\tNext Nx\r\n\t\r\n\tACTIVATE MSDIALOG _oDlg CENTERED \r\n\r\nElse\r\n\r\n\t//Alert(\"ok\")\r\n\tSetKey(VK_F5,)\r\n\tSetKey(VK_F6,)\r\nEndIf\r\n\r\nReturn(.T.)\r\n\r\nStatic Function fLibFunc(cNumItem)\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal nX   := 0\r\nLocal lRet := .T.\r\n\r\nFor nX := 1 To Len(aCols)\r\n\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\r\n\t\tIF GdFieldGet(\"C6_XOFERTA\",nX) == \"S\"\t\r\n\t\t\tlRet := .F.\r\n\t\tEndIf\r\n\tEndIf\r\nNext nX\r\n\r\nReturn(lRet)\r\n\r\nStatic Function fListBox1()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\n//Local nPos   := 0\r\nLocal nTotBr   := 0\r\nLocal nTotLQ   := 0\r\nLocal nTotCh   := 0\r\n//Local nTotDF := 0\r\nLocal nTotAM   := 0\r\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\r\nLocal nx       := 0\r\n\r\noListBox1:SetArray(aFlist)\r\n\r\n/*\r\nPreenche o dados de peso bruto e peso liquido por cavaletes\r\n e quantidade de chapas\r\n*/\r\nFor nX := 1 To Len(aCols)\r\n\r\n\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t//\"0005/0006/0034/0035/0036\"\r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1)\r\n\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\r\n\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\tIf !GDDeleted(nX) \r\n\t\t\t/*\r\n\t\t\tIf !aScan(aFlist,{|x|alltrim(x[1]) == GdFieldGet(\"C6_YCAVALE\",nX)  })\t\t\r\n\t\t\t\tAadd(aFlist,{GdFieldGet(\"C6_YCAVALE\",nX) ,;\r\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOLQ\"))    ,;\r\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOBR\"))  ,;\r\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0, fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YQTDBD\") ),;\r\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_QTDVEN\",nX),0 )  })\r\n\t\t\tElse\r\n\t\t\t\tnPos := aScan(aFlist,{|x|alltrim(x[1])==GdFieldGet(\"C6_YCAVALE\",nX) })\r\n\t\t\t \taFlist[nPos][2] := aFlist[nPos][2] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOLQ\"))\r\n\t\t\t \taFlist[nPos][3] := aFlist[nPos][3] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX),fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOBR\"))\r\n\t\t\t \taFlist[nPos][4] := aFlist[nPos][4] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0, fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YQTDBD\") )\r\n\t\t\t \taFlist[nPos][5] := aFlist[nPos][5] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_QTDVEN\",nX), IIF(AllTrim(GdFieldGet(\"C6_YCLASSI\",nX))==\"A\" .AND. Empty(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))),1,0 )) //\r\n\t\t\tEndIf\r\n\t\t\t*/\r\n\t\t\t\r\n\t\t\tAadd(aFlist,{GdFieldGet(\"C6_ITEM\",nX) ,;\r\n\t\t\t\t\t\t GdFieldGet(\"C6_YCAVALE\",nX) ,; \r\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),GdFieldGet(\"C6_PRODUTO\",nX),GdFieldGet(\"C6_LOCAL\",nX),\"B8_YPESOLQ\"))    ,;\r\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),GdFieldGet(\"C6_PRODUTO\",nX),GdFieldGet(\"C6_LOCAL\",nX),\"B8_YPESOBR\"))  ,;\r\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0, fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),GdFieldGet(\"C6_PRODUTO\",nX),GdFieldGet(\"C6_LOCAL\",nX),\"B8_YQTDBD\") ),;\r\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_QTDVEN\",nX),0 )  })\r\n\t\t\t\r\n\t\tEndIf\r\n\tElse \r\n\t\r\n\t//IIF(AllTrim(GdFieldGet(\"C6_YCLASSI\",nX))==\"A\" .AND. Empyt(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))),1,0)\r\n\t\r\n\tAadd(aFlist,{     \"-\",;\r\n\t\t\t\t\t  \"-\",;\r\n\t\t\t\t \t   0 ,;\r\n\t\t\t\t       0 ,;\r\n\t\t\t\t       0 ,;\r\n\t\t\t\t       0  })\r\n\t\r\n\tEndIf\r\nNext Nx\r\n\r\nIf Len(aFlist)>0\r\n\tFor nX := 1 To Len(aFlist)\r\n\t\tIf Alltrim(aFlist[nX][2]) = \"\"\r\n\t\t\taFlist[nX][2] := \"RECORTES\" \r\n\t\tEndIf\r\n\tNext Nx\r\n\t\r\n\tFor nX := 1 To Len(aFlist)\r\n\t\tnTotLQ := nTotLQ + aFlist[nX][3]\r\n\t\tnTotBr := nTotBr + aFlist[nX][4]\r\n\t\tnTotCh := nTotCh + aFlist[nX][5]\r\n\t\tnTotAM := nTotAM + aFlist[nX][6]\r\n\tNext Nx\r\n\t\r\n\tAadd(aFlist,{\"---------\",\"--------------------------------------------\",\"----------------------------------\",\"----------------------------------\",\"----------------------------------\",\"------------------------------------------\"})\r\n\tAadd(aFlist,{\"(=)\",\"  Total:\",nTotLQ,nTotBr,nTotCh,nTotAM})\r\n\tAadd(aFlist,{\"(=)\",\"  Weigth Limit: \"+ AllTrim(Str(M->C5_XWLIMIT)),M->C5_XWLIMIT - nTotLQ  ,M->C5_XWLIMIT - nTotBr,\"\",\"\"})\r\nEndIf\r\n\r\noListBox1:bLine := {|| {;\r\n\t\t\t\t\taFlist[oListBox1:nAT,01],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,02],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,03],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,04],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,05],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,06]}}\r\n\t\r\nReturn        \r\n           \r\n\r\nStatic Function fPqLotSub(cLote,cSubLote,cCodProd,cCodLocal,cTipRet)\r\n****************************************************************************************************************\r\n*    //fPqCvlt(GdFieldGet(\"C6_YCAVALE\",nX)) -- quantiade de cavaletes amostras\r\n*    //\r\n****\r\nLocal nVlrRest := 0\r\n\r\ncQuery  := \" SELECT \"+ cTipRet +\" VLRET\"\r\ncQuery  += \"   FROM SB8010 \r\ncQuery  += \"  WHERE D_E_L_E_T_ = ''\r\ncQuery  += \"    AND B8_LOTECTL = '\"+ AllTrim(cLote)     +\"' \r\ncQuery  += \"    AND B8_NUMLOTE = '\"+ AllTrim(cSubLote)  +\"'\r\ncQuery  += \"    AND B8_PRODUTO = '\"+ AllTrim(cCodProd)  +\"'\r\ncQuery  += \"    AND B8_LOCAL   = '\"+ AllTrim(cCodLocal) +\"'\r\ncQuery  += \"    AND B8_SALDO <> 0\r\n\r\ntcQuery cQuery alias TRB new\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\n\r\nnVlrRest := TRB->VLRET\r\n\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n\r\nReturn nVlrRest\r\n\r\n\r\nStatic Function fPqCvlt(cCavalete)\r\n****************************************************************************************************************\r\n*    //fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOBR\")\r\n*    \r\n****\r\nLocal nVlrRest := 0\r\n\r\ncQuery  := \" SELECT COUNT(*) AS VLR_CONT\r\ncQuery  += \"    FROM SB8010 \r\ncQuery  += \"   WHERE D_E_L_E_T_ = ''\r\ncQuery  += \"     AND B8_YCAVALE = '\"+AllTrim(cCavalete)+\"'\r\ncQuery  += \"     AND B8_YCLASSI = 'A'\r\ncQuery  += \"     AND B8_SALDO <> 0\r\n\r\ntcQuery cQuery alias TRB new\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\n\r\nnVlrRest := TRB->VLR_CONT\r\n\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n\r\nReturn nVlrRest\r\n\r\n\r\nUser Function MINFORFIN(dSetDate,cSetCodPG)\r\n****************************************************************************************************************\r\n*    //Informações Financeiras \r\n*    \r\n****\r\nPrivate _oInforFin\t\t\t\t// Dialog Principal\r\n                       \r\nPrivate oPG    := LoadBitmap(GetResources(), \"BR_VERMELHO\")\r\nPrivate oNPG   := LoadBitmap(GetResources(), \"BR_VERDE\")\r\nPrivate oNADA  := LoadBitmap(GetResources(), \"BR_CINZA\")\r\n\r\n// Privates das ListBoxes\r\nPrivate aListBoxFin := {}\r\nPrivate oListBoxFin\r\n\r\nDEFINE MSDIALOG _oInforFin TITLE \"Informações Financeiras\" FROM u_MGETTELA(178),u_MGETTELA(181) TO u_MGETTELA(403),u_MGETTELA(967) PIXEL\r\n\r\n\t// Cria Componentes Padroes do Sistema\r\n\t@ u_MGETTELA(093),u_MGETTELA(308) Button \"Cancelar\" Size u_MGETTELA(037),u_MGETTELA(012) ACTION(Close(_oInforFin)) PIXEL OF _oInforFin\r\n\t@ u_MGETTELA(093),u_MGETTELA(351) Button \"Salvar\" Size u_MGETTELA(037),u_MGETTELA(012)   ACTION(fSaveDtBl(),Close(_oInforFin)) PIXEL OF _oInforFin\r\n\r\n\t\t@ u_MGETTELA(003),u_MGETTELA(005) ListBox oListBoxFin Fields ;\r\n\t\tHEADER \"\",\"RECNO\",\"PREFIXO\",\"NUMERO\",\"TIPO\",\"PARCELA\",\"VALOR\",\"EMISSAO NF\",\"VENCIMENTO\",\"DATA BAIXA\",\"VENCIMENTO B/L\",\"VENCIMENTO B/L REAL\" ;\r\n\t\tSize u_MGETTELA(383),u_MGETTELA(088) Of _oInforFin Pixel;\r\n\t\tColSizes 08,20,40,40,40,40,40,40,40,40,50,40\r\n\t\t\r\n\t\t//oListBoxFin:bLDblClick := {||  MAltVlrAut(aFlist[oListBoxFin:nAT,01]) } alterar a função\r\n\t\t\r\n\r\n\t// Chamadas das ListBox do Sistema\r\n\tfListFin1(dSetDate,cSetCodPG)\r\n\r\nACTIVATE MSDIALOG _oInforFin CENTERED \r\n\r\nReturn(.T.)\r\n\r\n\r\nStatic Function fSaveDtBl()\r\n****************************************************************************************************************\r\n* //\r\n* //\r\n* \r\n****\r\nLocal lGravou  := .F.\r\nLocal cCodTitu := \"\"\r\nLocal nX       := 0\r\n\r\nFor nX:=1 to Len(aListBoxFin)\r\n\tIf !Empty(aListBoxFin[nX][12])\r\n\t\t\r\n\t\tdbSelectArea(\"SE1\")\r\n\t\tdbGoto(aListBoxFin[nX][2]) \r\n\t\tSE1->(reclock(\"SE1\", .F.))\r\n\t\t\tSE1->E1_VENCTO  := aListBoxFin[nX][11] \r\n\t\t\tSE1->E1_VENCREA := aListBoxFin[nX][12]\r\n\t\tSE1->(msUnLock())\r\n\t\t\r\n\t\tlGravou:=.T.\r\n\t\tcCodTitu := cCodTitu + aListBoxFin[nX][04]+\"-\"+aListBoxFin[nX][06]+ \" | \" + chr(13)+chr(10) \r\n\t\t\r\n\tEndIf\r\nNext nX\r\n\r\nIf lGravou\r\n\tAVISO(\"Títulos gravados com sucesso:\", cCodTitu , { \"Fechar\" }, 3)\r\nEndIF\r\n\r\nReturn()\r\n\r\nStatic Function fListFin1(dSetDate,cSetCodPG)\r\n****************************************************************************************************************\r\n* //\r\n* //\r\n* \r\n****\r\nLocal cQuery  := \"\"\r\n//Local aTPAVA  := {}\r\nLocal aRetAva := \"\"\r\n\r\ndbSelectArea(\"SF2\")\r\ndbSetOrder(2)\r\nIF dbSeek(xFilial(\"SF2\") + M->C5_CLIENTE + M->C5_LOJACLI + M->C5_NOTA + M->C5_SERIE + \"N\")\r\n\r\n\taTPadv := Condicao(M->C5_XVLRFIN,cSetCodPG,,SF2->F2_EMISSAO,) //FSepCond(M->C5_XVLRFIN,cSetCodPG,SF2->F2_EMISSAO)\r\n\r\n\tdbSelectArea(\"SE4\")\r\n\tdbSetOrder(1)\r\n\tIf dbSeek(xFilial(\"SE4\")+ cSetCodPG )\r\n\t\taRetAva := strtokarr (AllTrim(SE4->E4_TPAVA), \",\")\r\n\tEndIf\r\n\r\n\tIf Len(aRetAva) <> 0\r\n\t\tIf Len(aRetAva) <> Len(aTPadv)\r\n\t\t\tAlert(\"Verifique a condição de pagamento: (\" + AllTrim(cSetCodPG) + \"). O campo tp. avançado está diferente das quantidade de parcelas.\" )\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\tcQuery := \" \tSELECT\tR_E_C_N_O_ RECNO, \r\n\tcQuery += \" \t\t\tE1_FILIAL,\r\n\tcQuery += \" \t\t\tE1_PREFIXO,\r\n\tcQuery += \" \t\t\tE1_TIPO,\r\n\tcQuery += \" \t\t\tE1_NUM,\r\n\tcQuery += \" \t\t\tE1_PARCELA,\r\n\tcQuery += \" \t\t\tE1_EMISSAO,\r\n\tcQuery += \" \t\t\tE1_VENCREA,\r\n\tcQuery += \" \t\t\tE1_BAIXA,\r\n\tcQuery += \" \t\t\tE1_VALOR\r\n\tcQuery += \" \t  FROM SE1010 \r\n\tcQuery += \" \t WHERE E1_NUM     = '\"+M->C5_NOTA+\"'\r\n\tcQuery += \" \t   AND D_E_L_E_T_ = ''\r\n\t//cQuery += \" \t   AND E1_BAIXA   = ''\r\n\tcQuery += \" \t   AND E1_EMISSAO = '\"+dtoS(SF2->F2_EMISSAO)+\"'\r\n\tcQuery += \" \t   AND E1_TIPO IN ('NF')\r\n\tcQuery += \" \t   AND E1_CLIENTE = '\"+M->C5_CLIENTE+\"'\r\n\tcQuery += \" \t   AND E1_LOJA    = '\"+M->C5_LOJACLI+\"'\r\n\tcQuery += \" \t   AND E1_SERIE   = '\"+M->C5_SERIE+\"' \r\n\r\n\tTcQuery cQuery Alias TMP_FIM New\r\n\tdbSelectArea(\"TMP_FIM\")\r\n\t\r\n\tnPosAt := 0\r\n\tcTipoAvan := \"\"\r\n\t\r\n\tDo While !EOF()\r\n\t\r\n\t\tnPosAt := nPosAt + 1\r\n\t\tIf Len(aRetAva)<>0\r\n\t\t\tcTipoAvan := aRetAva[nPosAt] \r\n\t\t\t\r\n\t\t\tIf AllTrim(cTipoAvan) <> \"A\"\r\n\t\t\t\taTPadv := Condicao(M->C5_XVLRFIN,cSetCodPG,,dSetDate+1,)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\t\tAadd(aListBoxFin,{\tiif(!Empty(aRetAva),IIF(EMPTY(TMP_FIM->E1_BAIXA),oNPG,oPG),oNADA),;\r\n\t\t\t\t\t\t\tTMP_FIM->RECNO,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_PREFIXO,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_NUM,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_TIPO,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_PARCELA,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_VALOR,;\r\n\t\t\t\t\t\t\tStoD(TMP_FIM->E1_EMISSAO),;\r\n\t\t\t\t\t\t\tStoD(TMP_FIM->E1_VENCREA),;\r\n\t\t\t\t\t\t\tStoD(TMP_FIM->E1_BAIXA),;\r\n\t\t\t\t\t\t\tiif(!Empty(aRetAva),IIf(Empty(TMP_FIM->E1_BAIXA), aTPadv[nPosAt][1]             ,sToD(\"\") ),sToD(\"\")),;\r\n\t\t\t\t\t\t\tiif(!Empty(aRetAva),IIf(Empty(TMP_FIM->E1_BAIXA), DataValida(aTPadv[nPosAt][1]) ,sToD(\"\") ),sToD(\"\"));\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\r\n\t\tdbSelectArea(\"TMP_FIM\")\r\n\t\tdbSkip()\r\n\tEndDo\r\n\t\r\n\tdbSelectArea(\"TMP_FIM\")\r\n\tdbCloseArea()\r\n\r\n\tif Empty(aListBoxFin)\r\n\t\r\n\t\tAadd(aListBoxFin,{\t\toNADA,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\tStoD(\"\"),;\r\n\t\t\t\t\t\t\t\tStoD(\"\"),;\r\n\t\t\t\t\t\t\t\tStoD(\"\"),;\r\n\t\t\t\t\t\t\t\tStoD(\"\"),;\r\n\t\t\t\t\t\t\t\tsToD(\"\");\r\n\t\t\t\t\t\t\t\t})\r\n\t\r\n\tEndIf \r\n\r\n\toListBoxFin:SetArray(aListBoxFin)\r\n\t\r\n\toListBoxFin:bLine := {|| {;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,01],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,02],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,03],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,04],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,05],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,06],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,07],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,08],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,09],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,10],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,11],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,12]}}\r\n\t\r\n\r\nEndIf\r\n\r\nReturn()\r\n"}}}
Content-Length: 186
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO_NOVO_COMERCIAL/MT410TOK.prw"}}}
Content-Length: 53494
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/07_FINANCEIRO/IMPORT.PRW","languageId":"advpl","version":1,"text":"#INCLUDE \"PROTHEUS.CH\"\r\n#INCLUDE \"APWIZARD.CH\"\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³Import    ºAutor  ³Jonas L. Souza Jr   º Data ³  02/16/10   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³ Programa de importacao de tabelas                          º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\n\r\nUser Function Import\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Declaracao de variaveis                                 ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLocal oWizard\r\n\tLocal nMetGlob\r\n\tLocal nMetParc\r\n\tLocal oRadioArq\r\n\tLocal nRadioArq\t\t:= 1\r\n\r\n\tLocal cText\r\n\tLocal cFile\t\t\t:= replicate( \" \", 80 )\r\n\tLocal cHeader \t\t:= \"Importação de dados\"\r\n\tLocal cTpArq\t\t:= \"Delimitado (*.csv)|*.CSV|\"\r\n\tLocal cDelim\t\t:= AllTrim(SuperGetMV(\"MV_TPDELI\",.F.,';'))\r\n\tLocal nLinCabec\t\t:= 1 // Padrão sem linha de cabeçalho\r\n\tLocal cCabec\t\t:= \"\" // String com o cabeçalho do arquivo original, se houver\r\n\tLocal nQtdCab\t\t:= 1 // String com o cabeçalho do arquivo original, se houver\r\n\tLocal cNmAlias\t\t:= \"Clientes (SA1)\"\r\n\tLocal cTipo\t\t\t:= \"1\"\r\n\r\n\tPrivate INCLUI\t:= .T.\r\n\tPrivate ALTERA\t:= .F.\r\n\r\n\tcText \t:= \t \"Esta rotina tem por objetivo importar registros, através \" + ; \r\n\t\"de um arquivo padrão CSV (delimitado) , e armazena-los na tabela \"+ ; \r\n\t\"correspondente do sistema.\"+ CRLF + ; \r\n\t\"Os nomes das colunas devem ser os mesmos nomes de campos a serem atualizados.\"+ CRLF + CRLF + ; \r\n\t\"Ao final da importação será gerado um arquivo de log contendo as \"+ ; \r\n\t\"inconsistências.\"\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Primeiro Painel - Abertura     ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tDEFINE WIZARD oWizard \tTITLE \"Importção de dados\" ;\r\n\tHEADER cHeader ; \r\n\tMESSAGE \"Apresentação.\" ;\r\n\tTEXT cText ;\r\n\tNEXT { || .T. } ;\r\n\tFINISH {|| .T.} PANEL\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Segundo Painel - Arquivo e Contrato ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tCREATE PANEL oWizard \tHEADER cHeader ;\r\n\tMESSAGE \"Selecione os tabela que deseja importar\" ;\r\n\tBACK {|| .T. } ;\r\n\tNEXT {|| .T. } ;\r\n\tFINISH {|| .F. } ;\r\n\tPANEL         \r\n\r\n\toPanel := oWizard:GetPanel( 2 )\r\n\r\n\t@ 15, 08 GROUP oGrpCon \tTO 120, 230 LABEL \"Cadastro a ser importado\" OF oPanel PIXEL DESIGN\r\n\r\n\t@ 25,35 Radio oRadioArq Var nRadioArq Items \"Clientes (SA1)\",;\r\n\t\"Produtos (SB1)\",;\r\n\t\"Fornecedores (SA2)\",;\r\n\t\"Vendedores (SA3)\",;\r\n\t\"Contas a Receber - em aberto (SE1)\",;\r\n\t\"Contas a Pagar - em aberto (SE2)\",;\r\n\t\"Saldos Iniciais - Estoque (SB9)\",;\r\n\t\"Saldos Lote/SubLote (SD5)\" ;\r\n\t3D \tSize 170,10 Of oPanel PIXEL DESIGN ;\r\n\tON CHANGE ImpChgRadio(nRadioArq,@cNmAlias)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Segundo Painel - Arquivo e Contrato ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tCREATE PANEL oWizard \tHEADER cHeader ;\r\n\tMESSAGE \"Selecione o arquivo para importação.\" ;\r\n\tBACK {|| .T. } ;\r\n\tNEXT {|| ! empty( cDelim ) .and. ! empty( cFile ) } ;\r\n\tFINISH {|| .F. } ;\r\n\tPANEL         \r\n\r\n\toPanel := oWizard:GetPanel( 3 )\r\n\r\n\t@ 10, 08 GROUP oGrpCon \tTO 40, 280 LABEL \"Selecione um arquivo.\" ; \r\n\tOF oPanel ;\r\n\tPIXEL ;\r\n\tDESIGN\r\n\r\n\t@ 20, 15 MSGET oArq \tVAR cFile WHEN .F. OF oPanel SIZE 140, 10 PIXEL ;\r\n\tMESSAGE \"Utilize o botão ao lado para selecionar\" ; \r\n\r\n\tDEFINE SBUTTON oButArq \tFROM 21, 160 ;\r\n\tTYPE 14 ;\r\n\tACTION cFile := cGetFile(cTpArq, , 0, \"SERVIDOR\\\", .T., GETF_LOCALFLOPPY + GETF_LOCALHARD + GETF_NETWORKDRIVE) ; \r\n\tOF oPanel ;\r\n\tENABLE\r\n\r\n\t@ 50, 08 GROUP oGrpCon \tTO 130, 280 LABEL \"Informe as configurações do arquivo.\" ; \r\n\tOF oPanel ;\r\n\tPIXEL ;\r\n\tDESIGN\r\n\r\n\t@ 60,20 SAY \"Delimitador\" OF oPanel SIZE 35,8 PIXEL   \r\n\t@ 60,60 MSGET oDelim\tVAR cDelim  ;\r\n\tPICTURE \"@!\" ;\r\n\tVALID !empty(cDelim) ;\r\n\tMESSAGE \"Informe um delimitador de campo.\" ; \r\n\tOF oPanel SIZE 10,8 PIXEL \r\n\r\n\t@ 80,20 SAY \"Tipo\" OF oPanel SIZE 35,8 PIXEL   \r\n\t@ 80,60 COMBOBOX oTipo  Var cTipo ITEMS {\"1=Somente Log\",\"2=Log + Importação\"} \tSIZE 200,010 OF oPanel PIXEL  \r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Terceiro Painel - Confirmacao  / Processamento ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tCREATE PANEL oWizard \tHEADER cHeader ;\r\n\tMESSAGE \"Confirmação dos dados e início de processamento.\" ; \r\n\tBACK {|| .T. } ;\r\n\tNEXT {|| .T. } ;\r\n\tFINISH {|| .F. } ;\r\n\tPANEL         \r\n\r\n\toPanel := oWizard:GetPanel( 4 )\r\n\r\n\t@ 010, 010 SAY \"Arquivo\" OF oPanel SIZE 140, 8 PIXEL   \r\n\t@ 010, 050 SAY cFile  OF oPanel SIZE 140, 8 COLOR CLR_HBLUE PIXEL  \r\n\r\n\t@ 030, 010 SAY  \"Delimitador\" OF oPanel SIZE 140, 8 PIXEL   \r\n\t@ 030, 050 SAY  cDelim  OF oPanel SIZE 140, 8 COLOR CLR_HBLUE PIXEL\t\r\n\r\n\r\n\t@ 050, 010 SAY  \"Alias\" OF oPanel SIZE 140, 8 PIXEL   \r\n\t@ 050, 050 SAY  cNmAlias  OF oPanel SIZE 140, 8 COLOR CLR_HBLUE PIXEL\t\r\n\r\n\r\n\t@ 070, 010 SAY  \"Tipo Proc.:\" OF oPanel SIZE 140, 8 PIXEL   \r\n\t@ 070, 050 SAY  IIf(cTipo==\"1\",\"Somente Log\",\"Log+Importação\")  OF oPanel SIZE 140, 8 COLOR CLR_HBLUE PIXEL\t\r\n\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Quarto Painel - Processamento                  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tCREATE PANEL oWizard \tHEADER cHeader ;\r\n\tMESSAGE \"Processamento da Importação.\" ; \r\n\tBACK {|| .F. } ;\r\n\tNEXT {|| .T. } ;\r\n\tFINISH {|| .T. } ;\r\n\tEXEC {|| CursorWait(), IMPCADPro( oMetGlob, nRadioArq, cFile, cDelim, cTipo ), CursorArrow() } ;\r\n\tPANEL \r\n\r\n\toPanel := oWizard:GetPanel( 5 )\r\n\r\n\t@ 25, 30 SAY \"Importação\" OF oPanel SIZE 140, 8 PIXEL   \r\n\t@ 40, 30 METER oMetGlob \tVAR nMetGlob ;\r\n\tTOTAL 100 ;\r\n\tSIZE 224,10 OF oPanel PIXEL UPDATE DESIGN ;\r\n\tBARCOLOR CLR_BLACK,CLR_WHITE ;\r\n\tCOLOR CLR_WHITE,CLR_BLACK ;\r\n\tNOPERCENTAGE \r\n\r\n\r\n\tACTIVATE WIZARD oWizard CENTER\r\n\r\nReturn NIL\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³IMPCADPro ºAutor  ³Jonas L. Souza Jr   º Data ³  02/16/10   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³Importacao do arquivo selecionado                           º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\n\r\nStatic Function IMPCADPro( oMetGlob, nRadioArq, cFile, cDelim,cTipo )\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Declaracao de Variaveis                                             ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLocal aArea\t\t:= GetArea()\r\n\tLocal lFirst\t:= .T.\r\n\tLocal cLinha \t:= \"\"\r\n\t\r\n\tLocal nHdl    \t:= \t0\r\n\tLocal cEnvServ\t:= GetEnvServer()\r\n\tLocal cIniFile\t:= GetADV97()\r\n\tLocal cEnd\t\t:= GetPvProfString(cEnvServ,\"StartPath\",\"\",cIniFile)   \r\n\tLocal cDtHr \t:= DtoS(dDataBase)+\"-\"+Substr(time(),1,2)+\"-\"+Substr(time(),4,2)+\"-\"+Substr(time(),7,2)\r\n\tLocal cPath\t\t:= \"\\IMPORT\\\"\r\n\tLocal cTipoLog\t:= \"Import_\"\r\n\tLocal cNomeLog\t:=\tcPath+cTipoLog+cDtHr+\"_Log.txt\"\r\n\tLocal cArq\t\t:=\tcEnd+cNomeLog              \r\n\tLocal cLin\t\t:= \"\"   \r\n\tLocal cCdAlias\t:= \"\"\r\n\tLocal nQtReg\t:= 0\r\n\tLocal nQtNOk\t:= 0\r\n\tLocal nQtOk\t\t:= 0\r\n\tLocal aLog\t\t:= {}\r\n\tLocal lGrava\t:= (cTipo == \"2\")   \r\n\tLocal cRotina\t:= \"\"\r\n\tLocal nCont\t\t:= 0\r\n\r\n    Private aHeader\t:= {}\r\n    Private n       \r\n\r\n\tMAKEDIR(cEnd+cPath)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Validacao do arquivo para importacao             ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\n\tIf !File(cFile) .OR. Empty(cFile)\r\n\t\tApMsgStop(\"Problemas com arquivo informado!\")\r\n\t\tRestArea(aArea)\r\n\t\tReturn\r\n\tEndIf\r\n\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Identifica Alias de importacao                      ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tDo Case\r\n\t\tCase nRadioArq == 1\t\t// \"Clientes (SA1)\",;\r\n\t\tcCdAlias\t:= \"SA1\"\r\n\t\tcRotina\t\t:= \"MATA030\"\r\n\r\n\t\tCase nRadioArq == 2\t\t// \"Produtos (SB1)\",;\r\n\t\tcCdAlias\t:= \"SB1\"\r\n\t\tcRotina\t\t:= \"MATA010\"\r\n\r\n\t\tCase nRadioArq == 3\t\t// \"Fornecedores (SA2)\",;\r\n\t\tcCdAlias\t:= \"SA2\"\r\n\t\tcRotina\t\t:= \"MATA020\"\r\n\r\n\t\tCase nRadioArq == 4\t\t// \"Vendedores (SA3)\",;\r\n\t\tcCdAlias\t:= \"SA3\"\r\n\t\tcRotina\t\t:= \"MATA040\"\r\n\r\n\t\tCase nRadioArq == 5\t\t// \"Contas a Receber - em aberto (SE1)\",;\r\n\t\tcCdAlias\t:= \"SE1\"\r\n\t\tcRotina\t\t:= \"FINA040\"\r\n\r\n\t\tCase nRadioArq == 6\t\t// \"Contas a Pagar - em aberto (SE2)\" \r\n\t\tcCdAlias\t:= \"SE2\"\r\n\t\tcRotina\t\t:= \"FINA050\"\r\n\r\n\t\tCase nRadioArq == 7\t\t// \"Saldos Iniciais - Estoque (SB9)\"\r\n\t\tcCdAlias\t:= \"SB9\"\r\n\t\tcRotina\t\t:= \"MATA220\"\r\n\r\n\t\tCase nRadioArq == 8\t\t// \"Saldos Lote/SubLote (SD5)\"\r\n\t\tcCdAlias\t:= \"SD5\"\r\n\t\tcRotina\t\t:= \"MATA390\"\r\n\r\n\t\tOtherWise\r\n\t\tApMsgStop(\"Nao existe tratamento para importação deste tipo de arquivo!\")\r\n\t\tReturn\r\n\tEndCase\r\n\r\n\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Inicia Log                            ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tAAdd(aLog, Replicate( '=', 80 ) )\r\n\tAAdd(aLog, 'INICIANDO O LOG - I M P O R T A C A O   D E   D A D O S' )\r\n\tAAdd(aLog, Replicate( '-', 80 ) )\r\n\tAAdd(aLog, 'DATABASE...........: ' + DtoC( dDataBase ) )\r\n\tAAdd(aLog, 'DATA...............: ' + DtoC( Date() ) )\r\n\tAAdd(aLog, 'HORA...............: ' + Time() )\r\n\tAAdd(aLog, 'ENVIRONMENT........: ' + GetEnvServer() )\r\n\tAAdd(aLog, 'PATCH..............: ' + GetSrvProfString( 'StartPath', '' ) )\r\n\tAAdd(aLog, 'ROOT...............: ' + GetSrvProfString( 'RootPath', '' ) )\r\n\tAAdd(aLog, 'VERSÃO.............: ' + GetVersao() )\r\n\tAAdd(aLog, 'MÓDULO.............: ' + 'SIGA' + cModulo )\r\n\tAAdd(aLog, 'EMPRESA / FILIAL...: ' + SM0->M0_CODIGO + '/' + SM0->M0_CODFIL )\r\n\tAAdd(aLog, 'NOME EMPRESA.......: ' + Capital( Trim( SM0->M0_NOME ) ) )\r\n\tAAdd(aLog, 'NOME FILIAL........: ' + Capital( Trim( SM0->M0_FILIAL ) ) )\r\n\tAAdd(aLog, 'USUÁRIO............: ' + SubStr( cUsuario, 7, 15 ) )\r\n\tAAdd(aLog, 'TABELA IMPORT......: ' + cCdAlias )\r\n\tAAdd(aLog, 'ARQUIVO IMPORT.....: ' + cFile )\r\n\tAAdd(aLog, 'DELIMITADOR........: ' + cDelim )\r\n\tAAdd(aLog, 'MODO PROCESSAMENTO.: ' + IIf(lGrava,\"Atualizacao\",\"Simulacao\") )\r\n\tAAdd(aLog, Replicate( ':', 80 ) )\r\n\tAAdd(aLog, '' )\r\n\r\n\tAAdd(aLog, \"Import = INICIO - Data \"+DtoC(dDataBase)+ \" as \"+Time() )\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Leitura do arquivo                        ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tFT_FUSE(cFile)\r\n\tnTot := FT_FLASTREC()\r\n\tnAtu := 0\r\n\r\n\toMetGlob:SetTotal(nTot)\r\n\tCursorWait()     \r\n\r\n\tFT_FGOTOP()\r\n\tWhile !FT_FEOF()\r\n\t\tnAtu++\r\n\t\toMetGlob:Set(nAtu)\r\n\r\n\t\tcLinha := LeLinha() //FT_FREADLN()\r\n\r\n\t\tIf Empty(cLinha)\r\n\t\t\tFT_FSKIP()\r\n\t\t\tLoop\r\n\t\tEndIf\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Tratamento de colunas                     ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\taCols := {}\r\n\t\taCols := TrataCols(cLinha,cDelim)\r\n\t\tIf lFirst\r\n\t\t\taHeader := aClone(aCols)\r\n\t\t\tlFirst  := .F.\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ\u0002¿\r\n\t\t\t//³Valida nomes das colunas                   ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ\u0002Ù\r\n\t\t\tcCpos := ImpVldCols(cCdAlias,aHeader)\r\n\t\t\tIf !Empty(cCpos)\r\n\t\t\t\tApMsgStop(\"Problemas na estrutura do arquivo, faltam as seguintes colunas \"+cCpos)\r\n\t\t\t\tReturn\r\n\t\t\tEndIf\r\n\r\n\t\tElse\r\n\r\n\t\t\tnQtReg++\r\n\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Validacao de campos obrigatorios                     ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tcMsg := ImpObrigat(cCdAlias,aCols,aHeader)\r\n\t\t\tIf !Empty(cMsg)\r\n\t\t\t\tAtuLog(\"NO MOT: CAMPOS OBRIGATORIOS - REGISTRO IGNORADO - \"+cMsg,@aLog,nAtu)\r\n\t\t\t\tnQtNOk++\r\n\t\t\t\tFT_FSKIP()\r\n\t\t\t\tLoop\r\n\t\t\tEndIf\r\n\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³Chamada de rotina automatica de inclusao                ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf lGrava\r\n\t\t\t\taRet := {}\r\n\t\t\t\taRet := ImpGrava(cCdAlias,cRotina,aCols,aHeader)\r\n\t\t\t\tIf aRet[1]\r\n\t\t\t\t\tnQtOk++\r\n\t\t\t\t\tAtuLog(\"OK MOT:REGISTRO INCLUIDO\"+aRet[2],@aLog,nAtu)\r\n\r\n\t\t\t\tElse\r\n\t\t\t\t\tAtuLog(\"NO MOT: PROBLEMAS NA GRAVACAO ROTINA AUTOMATICA - \"+cRotina+\" - \"+aRet[2],@aLog,nAtu)\r\n\t\t\t\t\tnQtNOk++\r\n\r\n\t\t\t\tEndIF\r\n\t\t\tElse\r\n\t\t\t\tnQtOk++\r\n\t\t\t\tAtuLog(\"OK MOT:REGISTRO INCLUIDO\",@aLog,nAtu)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\r\n\t\tFT_FSKIP()\r\n\tEnd\r\n\tFT_FUSE()\r\n\r\n\tAAdd(aLog, \"Import = Total de Registros = \"+ Alltrim(Str(nQtReg)))\r\n\tAAdd(aLog, \"Import = Registros Nao importados = \"+ Alltrim(Str(nQtNOk)))\r\n\tAAdd(aLog, \"Import = Registros importados = \"+ Alltrim(Str(nQtOk)))\r\n\r\n\r\n\tAAdd(aLog, \"Import = FIM Data \"+DtoC(dDataBase)+ \" as \"+Time() )\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ\u0001¿\r\n\t//³Finaliza arquivo de Log                         ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ\u0001Ù\r\n\tnHdl  := \tfCreate(cArq)\r\n\tIf nHdl == -1\r\n\t\tMsgAlert(\"O arquivo  \"+cArq+\" nao pode ser criado!\",\"Atencao!\")\r\n\t\tfClose(nHdl)\r\n\t\tfErase(cArq)\r\n\t\tRestArea(aArea)\r\n\t\tReturn()\r\n\tEndIf\r\n\r\n\tFor nCont:=1 to Len(aLog)\r\n\r\n\t\tcLin += aLog[nCont] + CHR(13)+CHR(10)\r\n\r\n\t\tIf fWrite(nHdl,cLin,Len(cLin)) != Len(cLin)\r\n\t\t\tfClose(nHdl)\r\n\t\t\tfErase(cArq)\r\n\t\t\tcLin:=\"\"\r\n\t\t\tRestArea(aArea)\r\n\t\t\tReturn()\r\n\t\tEndIf\r\n\r\n\t\tcLin:=\"\"\r\n\tNext\r\n\r\n\tfClose(nHdl)\r\n\r\n\tApMsgInfo(\"Verifique arquivo de log \"+cArq)\r\n\r\n\tRestArea(aArea)\r\nReturn\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³AtuLog    ºAutor  ³Jonas L. Souza Jr   º Data ³  07/20/09   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³Atualiza Array de Log                                       º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function AtuLog(cMsg,aLog,nAtu)\r\n\r\n\tAAdd(aLog, \" Import = Linha \"+StrZero(nAtu,12)+\" = \"+;\r\n\t\" LOG = \"+cMsg )\r\nReturn\r\n\r\n\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³LeLinha   ºAutor  ³Jonas L. Souza Jr   º Data ³  02/16/10   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³Tratamento de leitura de linha TXT, principalmente para     º±±\r\n±±º          ³casos de ultrapassar 1Kb por linha                          º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function LeLinha()\r\n\tLocal cLinhaTmp := \"\"\r\n\tLocal cLinhaM100 := \"\"\r\n\r\n\tcLinhaTmp := FT_FReadLN()\r\n\r\n\tIf !Empty(cLinhaTmp)\r\n\t\tcIdent:= Substr(cLinhaTmp,1,1)\r\n\t\tIf Len(cLinhaTmp) < 1023\r\n\t\t\tcLinhaM100 := cLinhaTmp\r\n\t\tElse\r\n\t\t\tcLinAnt := cLinhaTmp\r\n\t\t\tcLinhaM100 += cLinAnt\r\n\t\t\tFt_FSkip()\r\n\t\t\tcLinProx:= Ft_FReadLN()\r\n\t\t\tIf Len(cLinProx) >= 1023 .and. Substr(cLinProx,1,1) <> cIdent\r\n\t\t\t\tWhile Len(cLinProx) >= 1023 .and. Substr(cLinProx,1,1) <> cIdent .and. !Ft_fEof()\r\n\t\t\t\t\tcLinhaM100 += cLinProx\r\n\t\t\t\t\tFt_FSkip()\r\n\t\t\t\t\tcLinProx := Ft_fReadLn()\r\n\t\t\t\t\tIf Len(cLinProx) < 1023 .and. Substr(cLinProx,1,1) <> cIdent\r\n\t\t\t\t\t\tcLinhaM100 += cLinProx\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEnddo\r\n\t\t\tElse\r\n\t\t\t\tcLinhaM100 += cLinProx\r\n\t\t\tEndif\r\n\t\tEndif\r\n\tEndif\r\n\r\nReturn(cLinhaM100)\r\n\r\n\r\n\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³TrataCols ºAutor  ³Jonas L. Souza Jr   º Data ³  07/20/09   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³Retorna array com as colunas da linha informada             º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function TrataCols(cLinha,cSep)\r\n\tLocal aRet \t\t:= {}\r\n\tLocal nPosSep\t:= 0\r\n\r\n\r\n\tnPosSep\t:= At(cSep,cLinha)\r\n\tWhile nPosSep <> 0\r\n\t\tAAdd(aRet, SubStr(cLinha,1,nPosSep-1)  )\r\n\t\tcLinha := SubStr(cLinha,nPosSep+1)\r\n\t\tnPosSep\t:= At(cSep,cLinha)\r\n\tEndDo\t\r\n\tAAdd(aRet, cLinha )\r\nReturn aRet\r\n\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³RetCol    ºAutor  ³Jonas L. Souza Jr   º Data ³  07/20/09   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³Retorna conteudo de coluna especifica                       º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function RetCol(cCpo,aCols,aHeader)\r\n\tLocal cRet \t:= \"\"\r\n\tLocal nPos\t:= 0\r\n\tLocal aSX3Area\t:= SX3->(GetArea())\r\n\r\n\tnPos := AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(cCpo)) })\r\n\r\n\tIf !Empty(nPos)\r\n\t\tIf Upper(AllTrim(aCols[nPos])) <> \"NULL\"\r\n\r\n\t\t\tDbSelectArea(\"SX3\")\r\n\t\t\tDbSetOrder(2)\r\n\t\t\tIf MsSeek(cCpo)\r\n\t\t\t\tIf SX3->X3_TIPO == \"D\"\r\n\t\t\t\t\tcRet := StoD(AllTrim(aCols[nPos]))\r\n\t\t\t\tElseIf SX3->X3_TIPO == \"N\"\r\n\t\t\t\t\tcRet := Val(AllTrim(aCols[nPos]))\r\n\t\t\t\tElse\r\n\t\t\t\t\tcRet := PadR(Upper(AllTrim(aCols[nPos])),TamSX3(cCpo)[1])\r\n\t\t\t\tEndIf\r\n\t\t\tElse\r\n\t\t\t\tcRet := Upper(AllTrim(aCols[nPos]))\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\tSX3->(RestArea(aSX3Area))\r\nReturn cRet\r\n\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³ImpVldColsºAutor  ³Jonas L. Souza Jr   º Data ³  02/16/10   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³Analise de colunas obrigatorias para cada alias             º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function ImpVldCols(cCdAlias,aHeader)\r\n\tLocal cRet \t\t:= \"\"\r\n\tLocal cFilSA1 \t:= \"\"\r\n\r\n\tDo Case\r\n\t\tCase cCdAlias == \"SA1\"\r\n\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A1_LOJA\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A1_LOJA\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A1_NOME\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A1_NOME\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A1_NREDUZ\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A1_NREDUZ\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A1_END\")) })\t\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A1_END\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A1_TIPO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A1_TIPO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A1_EST\")) })\t\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A1_EST\"\r\n\t\tEndIf\r\n\r\n\t\tCase cCdAlias == \"SB1\"\r\n\t\t//B1_FILIAL;B1_COD;B1_DESC;B1_TIPO;B1_UM;B1_LOCPAD;B1_GRUPO;B1_GARANT;B1_ORIGEM;B1_POSIPI\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B1_COD\")) })\t\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B1_COD\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B1_DESC\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B1_DESC\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B1_TIPO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B1_TIPO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B1_UM\")) })\t\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B1_UM\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B1_LOCPAD\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B1_LOCPAD\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B1_GRUPO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B1_GRUPO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B1_GARANT\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B1_GARANT\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B1_ORIGEM\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B1_ORIGEM\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B1_POSIPI\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B1_POSIPI\"\r\n\t\tEndIf\r\n\t\t\r\n\r\n\r\n\t\tCase cCdAlias == \"SA2\"\r\n\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A2_LOJA\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A2_LOJA\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A2_NOME\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A2_NOME\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A2_NREDUZ\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A2_NREDUZ\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A2_END\")) })\t\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A2_END\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A2_EST\")) })\t\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A2_EST\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A2_MUN\")) })\t\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A2_MUN\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A2_TIPO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A2_TIPO\"\r\n\t\tEndIf\r\n\r\n\t\tCase cCdAlias == \"SA3\"\r\n\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"A3_NOME\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"A3_NOME\"\r\n\t\tEndIf\r\n\r\n\t\tCase cCdAlias == \"SE1\"\r\n\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_NUM\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_NUM\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_TIPO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_TIPO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_NATUREZ\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_NATUREZ\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_CLIENTE\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_CLIENTE\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_LOJA\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_LOJA\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_EMISSAO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_EMISSAO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_VENCTO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_VENCTO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_VENCREA\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_VENCREA\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_VALOR\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_VALOR\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E1_VLCRUZ\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E1_VLCRUZ\"\r\n\t\tEndIf\r\n\r\n\t\tCase cCdAlias == \"SE2\"                                                          \r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_NUM\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_NUM\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_TIPO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_TIPO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_NATUREZ\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_NATUREZ\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_FORNECE\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_FORNECE\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_LOJA\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_LOJA\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_EMISSAO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_EMISSAO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_VENCTO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_VENCTO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_VENCREA\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_VENCREA\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_VALOR\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_VALOR\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"E2_VLCRUZ\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"E2_VLCRUZ\"\r\n\t\tEndIf\r\n\r\n\t\tCase cCdAlias == \"SB9\"\r\n\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B9_COD\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B9_COD\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B9_LOCAL\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B9_LOCAL\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"B9_QINI\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"B9_QINI\"\r\n\t\tEndIf\r\n\r\n\t\tCase cCdAlias == \"SD5\"\r\n\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"D5_PRODUTO\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"D5_PRODUTO\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"D5_LOCAL\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"D5_LOCAL\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"D5_DATA\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"D5_DATA\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"D5_QUANT\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"D5_QUANT\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"D5_LOTECTL\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"D5_LOTECTL\"\r\n\t\tEndIf\r\n\t\tIf AScan(aHeader,{|x| Upper(AllTrim(x)) == Upper(Alltrim(\"D5_DTVALID\")) })\t== 0\r\n\t\t\tcRet += IIf(Empty(cRet),\"\",\"/\")+\"D5_DTVALID\"\r\n\t\tEndIf\r\n\r\n\tEndCase\r\n\r\nReturn cRet\r\n\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³ImpObrigatºAutor  ³Jonas L. Souza JR   º Data ³  02/16/10   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³Valida preenchimento/conteudo de campos obrigatorios        º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function ImpObrigat(cCdAlias,aCols,aHeader)\r\n\tLocal cRet \t\t:= \"\"\r\n\r\n\tDo Case\r\n\t\tCase cCdAlias == \"SA1\"\r\n\t\tIf Empty(RetCol(\"A1_LOJA\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A1_LOJA esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A1_NOME\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A1_NOME esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A1_NREDUZ\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A1_NREDUZ esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A1_END\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A1_END esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A1_TIPO\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A1_TIPO esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A1_EST\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A1_EST esta vazia! \"\r\n\t\tEndIf\r\n\r\n\r\n\t\tCase cCdAlias == \"SB1\"\r\n\t\tIf Empty(RetCol(\"B1_COD\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna B1_COD esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"B1_DESC\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna B1_DESC esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"B1_TIPO\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna B1_TIPO esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"B1_UM\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna B1_UM esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"B1_LOCPAD\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna B1_LOCPAD esta vazia! \"\r\n\t\tEndIf\r\n\r\n\r\n\t\tCase cCdAlias == \"SA2\"\r\n\t\tIf Empty(RetCol(\"A2_LOJA\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A2_LOJA esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A2_NOME\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A2_NOME esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A2_NREDUZ\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A2_NREDUZ esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A2_END\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A2_END esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A2_EST\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A2_EST esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A2_MUN\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A2_MUN esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"A2_TIPO\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A2_TIPO esta vazia! \"\r\n\t\tEndIf\r\n\r\n\t\tCase cCdAlias == \"SA3\"\r\n\t\tIf Empty(RetCol(\"A3_NOME\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna A3_NOME esta vazia! \"\r\n\t\tEndIf\r\n\r\n\r\n\t\tCase cCdAlias == \"SE1\"\r\n\r\n\t\tIf Empty(RetCol(\"E1_NUM\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_NUM esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E1_TIPO\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_TIPO esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E1_NATUREZ\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_NATUREZ esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E1_CLIENTE\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_CLIENTE esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E1_LOJA\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_LOJA esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E1_EMISSAO\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_EMISSAO esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E1_VENCTO\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_VENCTO esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E1_VENCREA\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_VENCREA esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E1_VALOR\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_VALOR esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E1_VLCRUZ\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E1_VLCRUZ esta vazia! \"\r\n\t\tEndIf\r\n\r\n\r\n\t\tCase cCdAlias == \"SE2\"\r\n\t\tIf Empty(RetCol(\"E2_NUM\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_NUM esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E2_TIPO\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_TIPO esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E2_NATUREZ\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_NATUREZ esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E2_FORNECE\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_FORNECE esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E2_LOJA\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_LOJA esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E2_EMISSAO\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_EMISSAO esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E2_VENCTO\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_VENCTO esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E2_VENCREA\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_VENCREA esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E2_VALOR\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_VALOR esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"E2_VLCRUZ\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna E2_VLCRUZ esta vazia! \"\r\n\t\tEndIf\r\n\r\n\r\n\t\tCase cCdAlias == \"SB9\"                       \r\n\t\tIf Empty(RetCol(\"B9_COD\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna B9_COD esta vazia! \"\r\n\t\tEndIf\r\n\t\tIf Empty(RetCol(\"B9_LOCAL\",aCols,aHeader))\r\n\t\t\tcRet += \" / Coluna B9_LOCAL esta vazia! \"\r\n\t\tEndIf\r\n\r\n\tEndCase\r\n\r\nReturn cRet\r\n\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³ImpGrava  ºAutor  ³Jonas L. Souza Jr   º Data ³  02/16/10   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³Chamada da rotina automatica de gravacao                    º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\n\r\nStatic Function ImpGrava(cCdAlias,cRotina,aCols,aHeader)\r\n\tLocal nX\t\t\t:= 0\r\n\tLocal cRotAuto\t\t:= \"\"\r\n\tLocal lOk\t\t\t:= .F.\r\n\tLocal cMsg\t\t\t:= \"\"\r\n\tLocal lGeraNumSeq\t:= .T.\r\n\tLocal cArqErro\t\t:= \"ERRO_AUTO.TXT\"\r\n\tLocal lTemFilial\t:= .F.\r\n\tLocal cCpoFilial \t:= IIf( SubStr(cCdAlias,1,1) == \"S\", SubStr(cCdAlias,2,2), cCdAlias) + \"_FILIAL\"\r\n\tLocal cFilAlias\t\t:= SM0->M0_CODFIL\r\n\tPrivate lMsHelpAuto := .T.                                         \r\n\tPrivate lMsErroAuto := .F.    \r\n\tPrivate aReg\t\t:= {}\r\n\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Monta array com os campos do registro                          ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tFor nX:=1 to Len(aHeader)\r\n\t\tAAdd(aReg, {\tUpper(Alltrim(aHeader[nX]))\t\t\t\t\t    ,;\r\n\t\tRetCol(Alltrim(aHeader[nX]),aCols,aHeader)\t\t,;\r\n\t\tNil} )\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Verifica se possui campo sequencial informado                       ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tIf cCdAlias == \"SA1\" .AND. Upper(Alltrim(aHeader[nX])) == \"A1_COD\" .AND. !Empty(RetCol(Alltrim(aHeader[nX]),aCols,aHeader))\r\n\t\t\tlGeraNumSeq\t:= .F.\r\n\t\tEndIf\r\n\t\tIf cCdAlias == \"SA2\" .AND. Upper(Alltrim(aHeader[nX])) == \"A2_COD\" .AND. !Empty(RetCol(Alltrim(aHeader[nX]),aCols,aHeader))\r\n\t\t\tlGeraNumSeq\t:= .F.\r\n\t\tEndIf\r\n\t\tIf cCdAlias == \"SA3\" .AND. Upper(Alltrim(aHeader[nX])) == \"A3_COD\" .AND. !Empty(RetCol(Alltrim(aHeader[nX]),aCols,aHeader))\r\n\t\t\tlGeraNumSeq\t:= .F.\r\n\t\tEndIf\r\n\r\n\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³Verifica se informou filial no arquivo              ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tIf Upper(Alltrim(aHeader[nX])) == cCpoFilial\r\n\t\t\tlTemFilial := .T.\r\n\t\tEndIf\r\n\tNext\r\n\r\n\tIf lGeraNumSeq\r\n\t\tIf cCdAlias == \"SA1\"\r\n\t\t\tAAdd(aReg, {\t\"A1_COD\"\t\t\t\t\t    ,;\r\n\t\t\tGetSxeNum(\"SA1\",\"A1_COD\")\t\t,;\r\n\t\t\tNil} )\r\n\t\t\tConfirmSx8()\r\n\t\tEndIf\r\n\t\tIf cCdAlias == \"SA2\"\r\n\t\t\tAAdd(aReg, {\t\"A2_COD\"\t\t\t\t\t    ,;\r\n\t\t\tGetSxeNum(\"SA2\",\"A2_COD\")\t\t,;\r\n\t\t\tNil} )\r\n\t\t\tConfirmSx8()\r\n\t\tEndIf\r\n\t\tIf cCdAlias == \"SA3\"\r\n\t\t\tAAdd(aReg, {\t\"A3_COD\"\t\t\t\t\t    ,;\r\n\t\t\tGetSxeNum(\"SA3\",\"A3_COD\")\t\t,;\r\n\t\t\tNil} )\r\n\t\t\tConfirmSx8()\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\r\n\tIf !lTemFilial\r\n\t\tDbSelectArea(cCdAlias)\r\n\t\tAAdd(aReg, {\tcCpoFilial\t ,;\r\n\t\t\t\t\t\tcFilAlias\t ,;\r\n\t\t\t\t\t\tNil} )\r\n\tEndIf\r\n\r\n\t/*\r\n\tValidação da data vencimento \r\n\t*/\r\n\tIf aReg[12][1] == 'E2_VENCREA'\r\n\t\tIf dDatabase > aReg[12][2]\r\n\t\t\tAlert(\"Título vencido. Esta informação não será importada!\")\r\n\t\t\tcMsg := \"Título vencido. Esta informação não será importada!\"\r\n\t\t\tReturn {lOk, cMsg }\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³Chamada da rotina automatica                                     ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tDbSelectArea(cCdAlias)\r\n\r\n\tcRotAuto := \"MSExecAuto({|x,y| \"+cRotina+\"(x,y)},aReg,3)\"\r\n\r\n\t            \r\n\t&cRotAuto\r\n\r\n\tIf lMsErroAuto\r\n\t\t//MostraErro()\r\n\t\tcMsg := MemoRead(  GetSrvProfString(\"Startpath\",\"\") + '\\' + cArqErro )\r\n\tElse\r\n\t\tlOk := .T.\r\n\tEndIf\r\n\r\nReturn {lOk, cMsg }\r\n\r\n\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³ImpChgRadioºAutor ³Jonas L. Souza Jr   º Data ³  02/16/10   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³tratamento de mudanca to tipo de arquivo para importacao    º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ Totvs                                                      º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function ImpChgRadio(nRadioArq,cNmAlias)\r\n\tDo Case\r\n\t\tCase nRadioArq == 1\t\t\r\n\t\tcNmAlias := \"Clientes (SA1)\"\r\n\t\tCase nRadioArq == 2\t\t \r\n\t\tcNmAlias := \"Produtos (SB1)\"\r\n\t\tCase nRadioArq == 3\t\t \r\n\t\tcNmAlias := \"Fornecedores (SA2)\"\r\n\t\tCase nRadioArq == 4\t\t \r\n\t\tcNmAlias := \"Vendedores (SA3)\"\r\n\t\tCase nRadioArq == 5\t\t \r\n\t\tcNmAlias := \"Contas a Receber - em aberto (SE1)\"\r\n\t\tCase nRadioArq == 6\t\t \r\n\t\tcNmAlias := \"Contas a Pagar - em aberto (SE2)\" \r\n\t\tCase nRadioArq == 7\r\n\t\tcNmAlias := \"Saldos Iniciais - Estoque (SB9)\"\r\n\t\tCase nRadioArq == 8\r\n\t\tcNmAlias := \"Saldos Lote/SubLote (SD5)\"\r\n\t\tOtherWise\t\r\n\t\tcNmAlias := \"Processamento nao implementado\" \r\n\tEndCase\r\n\r\nReturn"}}}
Content-Length: 168
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/07_FINANCEIRO/IMPORT.PRW"}}}
Content-Length: 41841
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/07_FINANCEIRO/ITMRFIN010.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"MATR540.CH\"\r\n#INCLUDE \"PROTHEUS.CH\"\r\n#INCLUDE \"TOPCONN.CH\"\r\n\r\n/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ MATR540  ³ Autor ³ Marco Bianchi            ³ Data ³ 23/05/06 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Relatorio de Comissoes.                                       ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe   ³ MATR540(void)                                                 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Generico                                                      ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/\r\n\r\nUser Function ITMRFIN010()\r\n\r\n\tLocal oReport\r\n\tPrivate cAliasQry := GetNextAlias()\r\n\r\n\t#IFDEF TOP\r\n\tPrivate cAlias    := cAliasQry\r\n\t#ELSE\r\n\tPrivate cAlias    := \"SE3\"\r\n\t#ENDIF\r\n\r\n\tMatr540R3()\r\n\r\nReturn\r\n\r\n/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ MATR540R3³ Autor ³ Claudinei M. Benzi       ³ Data ³ 13.04.92 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Relatorio de Comissoes.                                       ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Sintaxe   ³ MATR540(void)                                                 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ Generico                                                      ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±± \r\n±±ÚÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³ DATA   ³ BOPS ³Programad.³ALTERACAO                                      ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³05.02.03³XXXXXX³Eduardo Ju³Inclusao de Queries para filtros em TOPCONNECT.³±±\r\n±±ÀÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/\r\n\r\nStatic Function Matr540R3()\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Define Variaveis                                             ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLocal wnrel\r\n\tLocal titulo    := STR0001  //\"Relatorio de Comissoes\"\r\n\tLocal cDesc1    := STR0002  //\"Emissao do relatorio de Comissoes.\"\r\n\tLocal tamanho   := \"G\"\r\n\tLocal limite    := 220\r\n\tLocal cString   := \"SE3\"\r\n\tLocal cAliasAnt := Alias()\r\n\tLocal cOrdemAnt := IndexOrd()\r\n\tLocal nRegAnt   := Recno()\r\n\tLocal cDescVend := \" \"\r\n\r\n\tPrivate aReturn := { OemToAnsi(STR0003), 1,OemToAnsi(STR0004), 1, 2, 1, \"\",1 }  //\"Zebrado\"###\"Administracao\"\r\n\tPrivate nomeprog:= \"ITMRFIN010\"\r\n\tPrivate aLinha  := { },nLastKey := 0\r\n\tPrivate cPerg   := \"MTR540\"\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Verifica as perguntas selecionadas                           ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tAjustaSX1()\r\n\tPergunte(\"MTR540\",.F.)\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis utilizadas para parametros                          ³\r\n\t//³ mv_par01        \t// Pela <E>missao,<B>aixa ou <A>mbos      ³\r\n\t//³ mv_par02        \t// A partir da data                       ³\r\n\t//³ mv_par03        \t// Ate a Data                             ³\r\n\t//³ mv_par04 \t    \t// Do Vendedor                            ³\r\n\t//³ mv_par05\t     \t// Ao Vendedor                            ³\r\n\t//³ mv_par06\t     \t// Quais (a Pagar/Pagas/Ambas)            ³\r\n\t//³ mv_par07\t     \t// Incluir Devolucao ?                    ³\r\n\t//³ mv_par08\t     \t// Qual moeda                             ³\r\n\t//³ mv_par09\t     \t// Comissao Zerada ?                      ³\r\n\t//³ mv_par10\t     \t// Abate IR Comiss                        ³\r\n\t//³ mv_par11\t     \t// Quebra pag.p/Vendedor                  ³\r\n\t//³ mv_par12\t     \t// Tipo de Relatorio (Analitico/Sintetico)³\r\n\t//³ mv_par13\t     \t// Imprime detalhes origem                ³\r\n\t//³ mv_par14         // Nome cliente\t\t\t\t\t\t\t  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Envia controle para a funcao SETPRINT                        ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\twnrel := \"ITMRFIN010\"\r\n\twnrel := SetPrint(cString,wnrel,cPerg,titulo,cDesc1,\"\",\"\",.F.,\"\",.F.,Tamanho)\r\n\r\n\tIf nLastKey==27\r\n\t\tdbClearFilter()\r\n\t\tReturn\r\n\tEndif\r\n\tSetDefault(aReturn,cString)\r\n\tIf nLastKey ==27\r\n\t\tdbClearFilter()\r\n\t\tReturn\r\n\tEndif\r\n\r\n\tRptStatus({|lEnd| C540Imp(@lEnd,wnRel,cString)},Titulo)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Retorna para area anterior, indice anterior e registro ant.  ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tDbSelectArea(caliasAnt)\r\n\tDbSetOrder(cOrdemAnt)\r\n\tDbGoto(nRegAnt)\r\nReturn\r\n\r\n/*ÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÚÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÂÄÄÄÄÄÄÂÄÄÄÄÄÄÄÄÄÄ¿±±\r\n±±³Fun‡…o    ³ C540IMP  ³ Autor ³ Rosane Luciane Chene  ³ Data ³ 09.11.95 ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³Descri‡…o ³ Chamada do Relatorio                                       ³±±\r\n±±ÃÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´±±\r\n±±³ Uso      ³ MATR540\t\t\t                                          ³±±\r\n±±ÀÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß*/\r\nStatic Function C540Imp(lEnd,WnRel,cString)\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Define Variaveis                                             ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tLocal CbCont,cabec1,cabec2\r\n\tLocal tamanho  := \"G\"\r\n\tLocal limite   := 220\r\n\tLocal nomeprog := \"ITMRFIN010\"\r\n\tLocal imprime  := .T.\r\n\tLocal cPict    := \"\"\r\n\tLocal cTexto,j :=0,nTipo:=0\r\n\tLocal cCodAnt,nCol:=0\r\n\tLocal nAc1:=0,nAc2:=0,nAg1:=0,nAg2:=0,nAc3:=0,nAg3:=0,nAc4:=0,nAg4:=0,lFirstV:=.T.\r\n\tLocal nTregs,nMult,nAnt,nAtu,nCnt,cSav20,cSav7\r\n\tLocal lContinua:= .T.\r\n\tLocal cNFiscal :=\"\"\r\n\tLocal aCampos  :={}\r\n\tLocal lImpDev  := .F.\r\n\tLocal cBase    := \"\"\r\n\tLocal cNomArq, cCondicao, cFilialSE1, cFilialSE3, cChave, cFiltroUsu\r\n\tLocal nDecs    := GetMv(\"MV_CENT\"+(IIF(mv_par08 > 1 , STR(mv_par08,1),\"\")))\r\n\tLocal nBasePrt :=0, nComPrt:=0 \r\n\tLocal aStru    := SE3->(dbStruct()), ni\r\n\tLocal nDecPorc := TamSX3(\"E3_PORC\")[2]\r\n\tLocal nVlrTitulo := 0\r\n\r\n\tLocal cDocLiq   := \"\"\r\n\tLocal cTitulo  := \"\" \r\n\tLocal dEmissao := CTOD( \"\" ) \r\n\tLocal nTotLiq  := 0\r\n\tLocal aLiquid  := {}\r\n\tLocal aValLiq  := {}\r\n\tLocal aLiqProp := {}\r\n\tLocal ny\r\n\tLocal aColuna := IIF(cPaisLoc <> \"MEX\",{15,19,42,46,83,95,107,119,130,137,153,169,176,195,203},{28,35,58,62,99,111,123,135,146,153,169,185,192,211,219})\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Variaveis utilizadas para Impressao do Cabecalho e Rodape    ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tcbtxt    := Space(10)\r\n\tcbcont   := 00\r\n\tli       := 80\r\n\tm_pag    := 01\r\n\timprime  := .T.\r\n\r\n\tnTipo := IIF(aReturn[4]==1,15,18)\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Definicao dos cabecalhos                                     ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf mv_par12 == 1\r\n\t\tIf mv_par01 == 1\r\n\t\t\ttitulo := OemToAnsi(STR0005)+OemToAnsi(STR0006)+\" (\"+OemToAnsi(STR0019)+\") \"+ \" - \" + GetMv(\"MV_MOEDA\" + STR(mv_par08,1)) //\"RELATORIO DE COMISSOES \"###\"(PGTO PELA EMISSAO)\"\r\n\t\tElseif mv_par01 == 2\r\n\t\t\ttitulo := OemToAnsi(STR0005)+OemToAnsi(STR0007)+\" (\"+OemToAnsi(STR0019)+\") \"+ \" - \" + GetMv(\"MV_MOEDA\" + STR(mv_par08,1))  //\"RELATORIO DE COMISSOES \"###\"(PGTO PELA BAIXA)\"\r\n\t\tElse\r\n\t\t\ttitulo := OemToAnsi(STR0008)+\" (\"+OemToAnsi(STR0019)+\") \"+ \" - \" + GetMv(\"MV_MOEDA\" + STR(mv_par08,1))  //\"RELATORIO DE COMISSOES\"\r\n\t\tEndif\r\n\r\n\t\tcabec1:=OemToAnsi(STR0009)\t//\"PRF NUMERO   PARC. CODIGO DO              LJ  NOME                                 DT.BASE     DATA        DATA        DATA       NUMERO          VALOR           VALOR      %           VALOR    TIPO\"\r\n\t\tcabec2:=OemToAnsi(STR0010)\t//\"    TITULO         CLIENTE                                                         COMISSAO    VENCTO      BAIXA       PAGTO      PEDIDO         TITULO            BASE               COMISSAO   COMISSAO\"\r\n\t\t// XXX XXXXXXxxxxxx X XXXXXXxxxxxxxxxxxxxx   XX  012345678901234567890123456789012345 XX/XX/XXxx  XX/XX/XXxx  XX/XX/XXxx  XX/XX/XXxx XXXXXX 12345678901,23  12345678901,23  99.99  12345678901,23     X       AJUSTE\r\n\t\t// 0         1         2         3         4         5         6         7         8         9         10        11        12        13        14        15        16        17        18        19        20        21\r\n\t\t// 0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789\r\n\t\tIf cPaisLoc == \"MEX\"\r\n\t\t\tCabec1 := Substr(Cabec1,1,10) + Space(16) + Substr(Cabec1,11)\r\n\t\t\tCabec2 := Substr(Cabec2,1,10) + Space(16) + Substr(Cabec2,11)\r\n\t\tEndIf\t\t\t\t\t\t\t\t\r\n\tElse\r\n\t\tIf mv_par01 == 1\r\n\t\t\ttitulo := OemToAnsi(STR0005)+OemToAnsi(STR0006)+\" (\"+OemToAnsi(STR0020)+\") \"+ \" - \" + GetMv(\"MV_MOEDA\" + STR(mv_par08,1)) //\"RELATORIO DE COMISSOES \"###\"(PGTO PELA EMISSAO)\"\r\n\t\tElseif mv_par01 == 2\r\n\t\t\ttitulo := OemToAnsi(STR0005)+OemToAnsi(STR0007)+\" (\"+OemToAnsi(STR0020)+\") \"+ \" - \" + GetMv(\"MV_MOEDA\" + STR(mv_par08,1))  //\"RELATORIO DE COMISSOES \"###\"(PGTO PELA BAIXA)\"\r\n\t\tElse\r\n\t\t\ttitulo := OemToAnsi(STR0008)+\" (\"+OemToAnsi(STR0020)+\") \"+ \" - \" + GetMv(\"MV_MOEDA\" + STR(mv_par08,1))  //\"RELATORIO DE COMISSOES\"\r\n\t\tEndif\r\n\t\tcabec1:=OemToAnsi(STR0021) //\"CODIGO VENDEDOR                                           TOTAL            TOTAL      %            TOTAL           TOTAL           TOTAL\"\r\n\t\tcabec2:=OemToAnsi(STR0022) //\"                                                         TITULO             BASE                COMISSAO              IR          (-) IR\"\r\n\t\t//\"XXXXXX XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX 123456789012,23  123456789012,23  99.99  123456789012,23 123456789012,23 123456789012,23\r\n\t\t//\"0         1         2         3         4         5         6         7         8         9         10        11        12        13        14        15        16        17        18        19        20        21\r\n\t\t//\"0123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890123456789\r\n\tEndIf\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Monta condicao para filtro do arquivo de trabalho            ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\r\n\tDbSelectArea(\"SE3\")\t// Posiciona no arquivo de comissoes\r\n\tDbSetOrder(2)\t\t\t// Por Vendedor\r\n\tcFilialSE3 := xFilial()\r\n\tcNomArq :=CriaTrab(\"\",.F.)\r\n\r\n\tcCondicao := \"SE3->E3_FILIAL=='\" + cFilialSE3 + \"'\"\r\n\tcCondicao += \".And.SE3->E3_VEND>='\" + mv_par04 + \"'\"\r\n\tcCondicao += \".And.SE3->E3_VEND<='\" + mv_par05 + \"'\"\r\n\tcCondicao += \".And.DtoS(SE3->E3_EMISSAO)>='\" + DtoS(mv_par02) + \"'\"\r\n\tcCondicao += \".And.DtoS(SE3->E3_EMISSAO)<='\" + DtoS(mv_par03) + \"'\" \r\n\r\n\tIf mv_par01 == 1\r\n\t\tcCondicao += \".And.SE3->E3_BAIEMI!='B'\"  // Baseado pela emissao da NF\r\n\tElseif mv_par01 == 2\r\n\t\tcCondicao += \" .And.SE3->E3_BAIEMI=='B'\"  // Baseado pela baixa do titulo\r\n\tEndif \r\n\r\n\tIf mv_par06 == 1 \t\t// Comissoes a pagar\r\n\t\tcCondicao += \".And.Dtos(SE3->E3_DATA)=='\"+Dtos(Ctod(\"\"))+\"'\"\r\n\tElseIf mv_par06 == 2 // Comissoes pagas\r\n\t\tcCondicao += \".And.Dtos(SE3->E3_DATA)!='\"+Dtos(Ctod(\"\"))+\"'\"\r\n\tEndif\r\n\r\n\tIf mv_par09 == 1 \t\t// Nao Inclui Comissoes Zeradas\r\n\t\tcCondicao += \".And.SE3->E3_COMIS<>0\"\r\n\tEndIf\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Cria expressao de filtro do usuario                          ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf ( ! Empty(aReturn[7]) )\r\n\t\tcFiltroUsu := &(\"{ || \" + aReturn[7] +  \" }\")\r\n\tElse\r\n\t\tcFiltroUsu := { || .t. }\r\n\tEndif\r\n\r\n\tnAg1 := nAg2 := nAg3 := nAg4 := 0\r\n\r\n\t#IFDEF TOP\r\n\tIf TcSrvType() != \"AS/400\"\r\n\t\tcOrder := SqlOrder(SE3->(IndexKey()))\r\n\r\n\t\tcQuery := \"SELECT * \"\r\n\t\tcQuery += \"  FROM \"+\tRetSqlName(\"SE3\")\r\n\t\tcQuery += \" WHERE E3_FILIAL = '\" + xFilial(\"SE3\") + \"' AND \"\r\n\t\tcQuery += \"\tE3_VEND >= '\"  + mv_par04 + \"' AND E3_VEND <= '\"  + mv_par05 + \"' AND \" \r\n\t\tcQuery += \"\tE3_EMISSAO >= '\" + Dtos(mv_par02) + \"' AND E3_EMISSAO <= '\"  + Dtos(mv_par03) + \"' AND \" \r\n\r\n\t\tIf mv_par01 == 1\r\n\t\t\tcQuery += \"E3_BAIEMI <> 'B' AND \"  //Baseado pela emissao da NF\r\n\t\tElseif mv_par01 == 2\r\n\t\t\tcQuery += \"E3_BAIEMI =  'B' AND \"  //Baseado pela baixa do titulo  \r\n\t\tEndIf\t\r\n\r\n\t\tIf mv_par06 == 1 \t\t//Comissoes a pagar\r\n\t\t\tcQuery += \"E3_DATA = '\" + Dtos(Ctod(\"\")) + \"' AND \"\r\n\t\tElseIf mv_par06 == 2 //Comissoes pagas\r\n\t\t\tcQuery += \"E3_DATA <> '\" + Dtos(Ctod(\"\")) + \"' AND \"\r\n\t\tEndif \r\n\r\n\t\tIf mv_par09 == 1 \t\t//Nao Inclui Comissoes Zeradas\r\n\t\t\tcQuery+= \"E3_COMIS <> 0 AND \"\r\n\t\tEndIf  \r\n\r\n\t\tcQuery += \"D_E_L_E_T_ <> '*' \"   \r\n\r\n\t\tcQuery += \" ORDER BY \"+ cOrder\r\n\r\n\t\tcQuery := ChangeQuery(cQuery)\r\n\r\n\t\tdbSelectArea(\"SE3\")\r\n\t\tdbCloseArea()\r\n\t\tdbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), 'SE3', .F., .T.)\r\n\r\n\t\tFor ni := 1 to Len(aStru)\r\n\t\t\tIf aStru[ni,2] != 'C'\r\n\t\t\t\tTCSetField('SE3', aStru[ni,1], aStru[ni,2],aStru[ni,3],aStru[ni,4])\r\n\t\t\tEndif\r\n\t\tNext \r\n\tElse\r\n\r\n\t\t#ENDIF\t\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³ Cria arquivo de trabalho                                     ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tcChave := IndexKey()\r\n\t\tcNomArq :=CriaTrab(\"\",.F.)\r\n\t\tIndRegua(\"SE3\",cNomArq,cChave,,cCondicao, OemToAnsi(STR0016)) //\"Selecionando Registros...\"\r\n\t\tnIndex := RetIndex(\"SE3\")\r\n\t\tDbSelectArea(\"SE3\") \r\n\t\t#IFNDEF TOP\r\n\t\tDbSetIndex(cNomArq+OrdBagExT())\r\n\t\t#ENDIF\r\n\t\tDbSetOrder(nIndex+1)\r\n\r\n\t\t#IFDEF TOP\r\n\tEndIf\r\n\t#ENDIF\t\r\n\r\n\tSetRegua(RecCount())\t\t// Total de Elementos da regua \r\n\tDbGotop()\r\n\tWhile !Eof()\r\n\t\tIF lEnd\r\n\t\t\t@Prow()+1,001 PSAY OemToAnsi(STR0011)  //\"CANCELADO PELO OPERADOR\"\r\n\t\t\tlContinua := .F.\r\n\t\t\tExit\r\n\t\tEndIF\r\n\t\tIncRegua()\r\n\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t//³ Processa condicao do filtro do usuario                       ³\r\n\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\tIf ! Eval(cFiltroUsu)\r\n\t\t\tDbskip()\r\n\t\t\tLoop\r\n\t\tEndif\r\n\r\n\t\tnAc1 := nAc2 := nAc3 := nAc4 := 0\r\n\t\tlFirstV:= .T.\r\n\t\tcVend  := SE3->E3_VEND\r\n\r\n\t\tWhile !Eof() .AND. SE3->E3_VEND == cVend\r\n\t\t\tIncRegua()\r\n\t\t\tcDocLiq:= \"\"\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³ Processa condicao do filtro do usuario                       ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIf ! Eval(cFiltroUsu)\r\n\t\t\t\tDbskip()\r\n\t\t\t\tLoop\r\n\t\t\tEndif  \r\n\r\n\t\t\tIf li > 55\r\n\t\t\t\tcabec(titulo,cabec1,cabec2,nomeprog,tamanho,nTipo)\r\n\t\t\tEndIF\r\n\r\n\t\t\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t\t\t//³ Seleciona o Codigo do Vendedor e Imprime o seu Nome          ³\r\n\t\t\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\t\t\tIF lFirstV\r\n\t\t\t\tdbSelectArea(\"SA3\")\r\n\t\t\t\tdbSeek(xFilial()+SE3->E3_VEND)\r\n\t\t\t\tIf mv_par12 == 1\r\n\t\t\t\t\tcDescVend := SE3->E3_VEND + \" \" + A3_NOME \r\n\t\t\t\t\t@li, 00 PSAY OemToAnsi(STR0012) + cDescVend //\"Vendedor : \"\r\n\t\t\t\t\tli+=2\r\n\t\t\t\tElse\r\n\t\t\t\t\t@li, 00 PSAY SE3->E3_VEND\r\n\t\t\t\t\t@li, 07 PSAY A3_NOME \r\n\t\t\t\tEndIf\r\n\t\t\t\tdbSelectArea(\"SE3\")\r\n\t\t\t\tlFirstV := .F.\r\n\t\t\tEndIF\r\n\r\n\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSeek(xFilial()+SE3->E3_PREFIXO+SE3->E3_NUM+SE3->E3_PARCELA+SE3->E3_TIPO)\r\n\r\n\t\t\t// Se nao imprime detalhes da origem, desconsidera titulos faturados\r\n\t\t\tIf mv_par13 <> 1 .And. !Empty(SE1->E1_FATURA) .And. SE1->E1_FATURA <> \"NOTFAT\"\r\n\t\t\t\tSE3->( dbSkip() )\r\n\t\t\t\tLoop\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf mv_par12 == 1\r\n\t\t\t\t@li, 00 PSAY SE3->E3_PREFIXO\r\n\t\t\t\t@li, 04 PSAY SE3->E3_NUM\r\n\t\t\t\t@li, aColuna[1] PSAY SE3->E3_PARCELA\r\n\t\t\t\t@li, aColuna[2] PSAY SE3->E3_CODCLI\r\n\t\t\t\t@li, aColuna[3] PSAY SE3->E3_LOJA\r\n\r\n\t\t\t\tdbSelectArea(\"SA1\")\r\n\t\t\t\tdbSeek(xFilial()+SE3->E3_CODCLI+SE3->E3_LOJA)\r\n\t\t\t\t@li, aColuna[4] PSAY IF(mv_par14 == 1,Substr(SA1->A1_NREDUZ,1,35),Substr(SA1->A1_NOME,1,35))\r\n\r\n\t\t\t\tdbSelectArea(\"SE3\")\r\n\t\t\t\t@li, aColuna[5] PSAY SE3->E3_EMISSAO\r\n\t\t\tEndIf\r\n\r\n\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSeek(xFilial()+SE3->E3_PREFIXO+SE3->E3_NUM+SE3->E3_PARCELA+SE3->E3_TIPO)\r\n\t\t\tnVlrTitulo := Round(xMoeda(SE1->E1_VALOR,SE1->E1_MOEDA,MV_PAR08,SE1->E1_EMISSAO,nDecs+1),nDecs)\r\n\t\t\tdVencto    := SE1->E1_VENCTO  \r\n\t\t\tdEmissao   := SE1->E1_EMISSAO \r\n\t\t\taLiquid\t  := {}\r\n\t\t\taValLiq\t\t:= {}\r\n\t\t\taLiqProp\t  \t:= {}\r\n\t\t\tnTotLiq\t\t:= 0\r\n\t\t\tIf mv_par13 == 1 .And. !Empty(SE1->E1_NUMLIQ) .And. FindFunction(\"FA440LIQSE1\")\r\n\t\t\t\tcLiquid := SE1->E1_NUMLIQ\t\t\t\r\n\t\t\t\tcDocLiq := SE1->E1_NUMLIQ\r\n\t\t\t\t// Obtem os registros que deram origem ao titulo gerado pela liquidacao\r\n\t\t\t\tFa440LiqSe1(SE1->E1_NUMLIQ,@aLiquid,@aValLiq)\r\n\t\t\t\tFor ny := 1 to Len(aValLiq)\r\n\t\t\t\t\tnTotLiq += aValLiq[ny,2]\r\n\t\t\t\tNext\r\n\t\t\t\tFor ny := 1 to Len(aValLiq)\r\n\t\t\t\t\taAdd(aLiqProp,(nVlrTitulo/nTotLiq)*aValLiq[ny,2])\r\n\t\t\t\tNext\r\n\t\t\tEndif\r\n\t\t\t/*\r\n\t\t\tNas comissoes geradas por baixa pego a data da emissao da comissao que eh igual a data da baixa do titulo.\r\n\t\t\tIsto somente dara diferenca nas baixas parciais\r\n\t\t\t*/\t \r\n\r\n\t\t\tIf SE3->E3_BAIEMI == \"B\"\r\n\t\t\t\tdBaixa     := SE3->E3_EMISSAO\r\n\t\t\tElse\r\n\t\t\t\tdBaixa     := SE1->E1_BAIXA\r\n\t\t\tEndif\r\n\r\n\t\t\tIf Eof()\r\n\r\n\t\t\t\tdbSelectArea(\"SF1\")\r\n\t\t\t\tdbSetOrder(1)\r\n\r\n\t\t\t\tdbSelectArea(\"SF2\")\r\n\t\t\t\tdbSetorder(1)\r\n\r\n\t\t\t\tIf AllTrim(SE3->E3_TIPO) == \"NCC\"\r\n\t\t\t\t\tSF1->(dbSeek(xFilial(\"SF1\")+SE3->E3_NUM+SE3->E3_PREFIXO+SE3->E3_CODCLI+SE3->E3_LOJA,.t.))\r\n\t\t\t\t\tnVlrTitulo := Round(xMoeda(SF1->F1_VALMERC,SF1->F1_MOEDA,mv_par07,SF1->F1_DTDIGIT,nDecs+1,SF1->F1_TXMOEDA),nDecs)\r\n\t\t\t\t\tdEmissao   := SF1->F1_DTDIGIT\r\n\t\t\t\tElse\r\n\t\t\t\t\tdbSeek(xFilial()+SE3->E3_NUM+SE3->E3_PREFIXO)       \r\n\t\t\t\t\tnVlrTitulo := Round(xMoeda(F2_VALFAT,SF2->F2_MOEDA,mv_par07,SF2->F2_EMISSAO,nDecs+1,SF2->F2_TXMOEDA),nDecs)\r\n\t\t\t\t\tdEmissao   := SF2->F2_EMISSAO\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tdVencto    := \" \"\r\n\t\t\t\tdBaixa     := \" \"\r\n\r\n\t\t\t\tdEmissao   := SF2->F2_EMISSAO \r\n\r\n\t\t\t\tIf Eof()\r\n\t\t\t\t\tnVlrTitulo := 0\r\n\t\t\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tcFilialSE1 := xFilial()\r\n\t\t\t\t\tdbSeek(cFilialSE1+SE3->E3_PREFIXO+SE3->E3_NUM)\r\n\t\t\t\t\tWhile ( !Eof() .And. SE3->E3_PREFIXO == SE1->E1_PREFIXO .And.;\r\n\t\t\t\t\tSE3->E3_NUM == SE1->E1_NUM .And.;\r\n\t\t\t\t\tSE3->E3_FILIAL == cFilialSE1 )\r\n\t\t\t\t\t\tIf ( SE1->E1_TIPO == SE3->E3_TIPO  .And. ;\r\n\t\t\t\t\t\tSE1->E1_CLIENTE == SE3->E3_CODCLI .And. ;\r\n\t\t\t\t\t\tSE1->E1_LOJA == SE3->E3_LOJA )\r\n\t\t\t\t\t\t\tnVlrTitulo += Round(xMoeda(SE1->E1_VALOR,SE1->E1_MOEDA,MV_PAR08,SE1->E1_EMISSAO,nDecs+1),nDecs)\r\n\t\t\t\t\t\t\tdVencto    := \" \"\r\n\t\t\t\t\t\t\tdBaixa     := \" \"\r\n\t\t\t\t\t\t\tIf Empty(dEmissao)\r\n\t\t\t\t\t\t\t\tdEmissao := SE1->E1_EMISSAO\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\tdbSelectArea(\"SE1\")\r\n\t\t\t\t\t\tdbSkip()\r\n\t\t\t\t\tEndDo\r\n\t\t\t\tEndIf\r\n\t\t\tEndif\r\n\r\n\r\n\t\t\tIf Empty(dEmissao)\r\n\t\t\t\tdEmissao := NIL\r\n\t\t\tEndIf\r\n\r\n\t\t\t//Preciso destes valores para pasar como parametro na funcao TM(), e como \r\n\t\t\t//usando a xmoeda direto na impressao afetaria a performance (deveria executar\r\n\t\t\t//duas vezes, uma para imprimir e outra para pasar para a picture), elas devem]\r\n\t\t\t//ser inicializadas aqui. Bruno.\r\n\r\n\t\t\tnBasePrt:=\tRound(xMoeda(SE3->E3_BASE ,1,MV_PAR08,dEmissao,nDecs+1),nDecs)\r\n\t\t\tnComPrt :=\tRound(xMoeda(SE3->E3_COMIS,1,MV_PAR08,dEmissao,nDecs+1),nDecs)\r\n\r\n\t\t\tIf nBasePrt < 0 .And. nComPrt < 0\r\n\t\t\t\tnVlrTitulo := nVlrTitulo * -1\r\n\t\t\tEndif\t\r\n\r\n\t\t\tdbSelectArea(\"SE3\")\r\n\r\n\t\t\tIf mv_par12 == 1\r\n\t\t\t\t@ li,aColuna[6]  PSAY dVencto\r\n\t\t\t\t@ li,aColuna[7]  PSAY dBaixa\r\n\t\t\t\t@ li,aColuna[8]  PSAY SE3->E3_DATA\r\n\t\t\t\t@ li,aColuna[9]  PSAY SE3->E3_PEDIDO\tPicture \"@!\"\r\n\t\t\t\t@ li,aColuna[10] PSAY nVlrTitulo\t\tPicture tm(nVlrTitulo,14,nDecs)\r\n\t\t\t\t@ li,aColuna[11] PSAY nBasePrt \t\t\tPicture tm(nBasePrt,14,nDecs)\r\n\t\t\t\tIf cPaisLoc<>\"BRA\"\r\n\t\t\t\t\t@ li,aColuna[12] PSAY SE3->E3_PORC\t\tPicture tm(SE3->E3_PORC,6,nDecPorc)\r\n\t\t\t\tElse\r\n\t\t\t\t\t@ li,aColuna[12] PSAY SE3->E3_PORC\t\tPicture tm(SE3->E3_PORC,6)\r\n\t\t\t\tEndif\r\n\t\t\t\t@ li,aColuna[13] PSAY nComPrt\t\t\tPicture tm(nComPrt,14,nDecs)\r\n\t\t\t\t@ li,aColuna[14] PSAY SE3->E3_BAIEMI\r\n\r\n\t\t\t\tIf ( SE3->E3_AJUSTE == \"S\" .And. MV_PAR07==1)\r\n\t\t\t\t\t@ li,aColuna[15] PSAY STR0018 //\"AJUSTE \"\r\n\t\t\t\tEndIf\r\n\t\t\t\tli++\r\n\t\t\t\t// Imprime titulos que deram origem ao titulo gerado por liquidacao\r\n\t\t\t\tIf mv_par13 == 1\r\n\t\t\t\t\tFor nI := 1 To Len(aLiquid)\r\n\t\t\t\t\t\tIf li > 55\r\n\t\t\t\t\t\t\tcabec(titulo,cabec1,cabec2,nomeprog,tamanho,nTipo)\r\n\t\t\t\t\t\tEndIF\r\n\t\t\t\t\t\tIf nI == 1\r\n\t\t\t\t\t\t\t@ ++li, 0 PSAY __PrtThinLine()\r\n\t\t\t\t\t\t\t@ ++li, 0 PSAY STR0023 +SE1->E1_NUMLIQ // \"Detalhes : Titulos de origem da liquidação \"\r\n\t\t\t\t\t\t\t@ ++li,10 PSAY STR0024 // \"Prefixo    Numero          Parc    Tipo    Cliente   Loja    Nome                                       Valor Titulo      Data Liq.         Valor Liquidação      Valor Base Liq.\"\r\n\t\t\t\t\t\t\t//         Prefixo    Numero          Parc    Tipo    Cliente   Loja    Nome                                       Valor Titulo      Data Liq.         Valor Liquidação      Valor Base Liq.\r\n\t\t\t\t\t\t\t//         XXX        XXXXXXXXXXXX    XXX     XXXX    XXXXXXXXXXXXXX    XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX  999999999999999     99/99/9999          999999999999999      999999999999999 \r\n\t\t\t\t\t\t\t@ ++li, 0 PSAY __PrtThinLine()\r\n\t\t\t\t\t\t\tli++\r\n\t\t\t\t\t\tEndif\r\n\t\t\t\t\t\tcDocLiq  := SE1->E1_NUMLIQ\r\n\t\t\t\t\t\tSE1->(MsGoto(aLiquid[nI]))\r\n\t\t\t\t\t\tSA1->(MsSeek(xFilial(\"SA1\")+SE1->E1_CLIENTE+SE1->E1_LOJA))\r\n\t\t\t\t\t\t@li,  10 PSAY SE1->E1_PREFIXO\r\n\t\t\t\t\t\t@li,  21 PSAY SE1->E1_NUM\r\n\t\t\t\t\t\t@li,  37 PSAY SE1->E1_PARCELA\r\n\t\t\t\t\t\t@li,  45 PSAY SE1->E1_TIPO\r\n\t\t\t\t\t\t@li,  53 PSAY SE1->E1_CLIENTE\r\n\t\t\t\t\t\t@li,  64 PSAY SE1->E1_LOJA\r\n\t\t\t\t\t\t@li,  71 PSAY IF(mv_par14 == 1,Substr(SA1->A1_NREDUZ,1,35),Substr(SA1->A1_NOME,1,35))\r\n\t\t\t\t\t\t@li, 111 PSAY SE1->E1_VALOR PICTURE Tm(SE1->E1_VALOR,15,nDecs)\r\n\t\t\t\t\t\t@li, 132 PSAY aValLiq[nI,1] \r\n\t\t\t\t\t\t@li, 151 PSAY aValLiq[nI,2] PICTURE Tm(SE1->E1_VALOR,15,nDecs)\r\n\t\t\t\t\t\t@li, 172 PSAY aLiqProp[nI] PICTURE Tm(SE1->E1_VALOR,15,nDecs)\r\n\t\t\t\t\t\tli++\r\n\t\t\t\t\tNext\r\n\t\t\t\t\t// Imprime o separador da ultima linha\r\n\t\t\t\t\tIf Len(aLiquid) >= 1\r\n\t\t\t\t\t\t@ li++, 0 PSAY __PrtThinLine()\r\n\t\t\t\t\tEndif\r\n\t\t\t\tEndif\t\r\n\t\t\tEndIf\r\n\t\t\tnAc1 += nBasePrt\r\n\t\t\tnAc2 += nComPrt\r\n\t\t\tIf cTitulo <> SE3->E3_PREFIXO+SE3->E3_NUM+SE3->E3_PARCELA+SE3->E3_TIPO+SE3->E3_VEND+SE3->E3_CODCLI+SE3->E3_LOJA  .And. Empty(cDocLiq)\r\n\t\t\t\tnAc3   += nVlrTitulo\r\n\t\t\t\tcTitulo:= SE3->E3_PREFIXO+SE3->E3_NUM+SE3->E3_PARCELA+SE3->E3_TIPO+SE3->E3_VEND+SE3->E3_CODCLI+SE3->E3_LOJA\r\n\t\t\t\tcDocLiq:= \"\"\r\n\t\t\tEndIf\r\n\r\n\t\t\t//<TLM> Márcio Chaves - Impressao dos Itens Referente a NF da comissão gerada.\r\n\t\t\tcQuery :=\t\"SELECT D2_FILIAL,D2_COD,D2_UM,D2_QUANT,D2_DOC,D2_SERIE,D2_LOTECTL FROM SD2050\"\r\n\t\t\tcQuery +=\t\" WHERE D2_FILIAL = '\"+xFilial()+\"' AND D2_DOC = '\"+SE3->E3_NUM+\"' AND D2_SERIE = '\"+SE3->E3_PREFIXO+\"'\"\r\n\t\t\tcQuery +=\t\" AND D_E_L_E_T_ = '' ORDER BY D2_ITEM\"\r\n\r\n\t\t\tTcQuery cQuery Alias ITNF New\r\n\r\n\t\t\tDbSelectArea(\"ITNF\")\r\n\t\t\tDbGoTop()\r\n\t\t\t//+------------------------------------------------+\r\n\t\t\t//| Se nao existir dados para gerar o relatorio    |\r\n\t\t\t//+------------------------------------------------+\r\n\t\t\tIf ITNF->(EOF())\r\n\t\t\t\tITNF->(DbCloseArea())\r\n\t\t\tElse\r\n\t\t\t\t@li, 10 PSAY \t\"Itens NF       Bloco nº        Qtd. \"+Alltrim(ITNF->D2_UM)+\"    Nome do material\"\r\n\t\t\t\tli++   \r\n\t\t\t\tWhile (!Eof())\r\n\t\t\t\t\t@li, 10 Psay ITNF->D2_DOC\r\n\t\t\t\t\t@li, 25 Psay ITNF->D2_LOTECTL\r\n\t\t\t\t\t@li, 43 Psay Alltrim(Transform(ITNF->D2_QUANT, \"@E 99,999.999\"))\r\n\t\t\t\t\t@li, 52 Psay Posicione(\"SB1\",1,xFilial(\"SB1\")+Alltrim(ITNF->D2_COD),\"SB1->B1_DESC\")\r\n\t\t\t\t\tli++\t\t\t\r\n\t\t\t\t\tDBSKIP()\r\n\t\t\t\tEnd\r\n\t\t\t\tITNF->(DbCloseArea())\t\t\t\r\n\t\t\tEndIf\r\n\r\n\t\t\tdbSelectArea(\"SE3\")\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\r\n\t\tIf mv_par12 == 1\r\n\t\t\tli++\r\n\r\n\t\t\tIf li > 55\r\n\t\t\t\tcabec(titulo,cabec1,cabec2,nomeprog,tamanho,nTipo)\r\n\t\t\tEndIF\r\n\t\t\t@ li, 00  PSAY OemToAnsi(STR0013)+cDescVend  //\"TOTAL DO VENDEDOR --> \"\r\n\t\t\t@ li,aColuna[10]-1  PSAY nAc3 \tPicTure tm(nAc3,15,nDecs)\r\n\t\t\t@ li,aColuna[11]-1  PSAY nAc1 \tPicTure tm(nAc1,15,nDecs)\r\n\r\n\t\t\tIf nAc1 != 0\r\n\t\t\t\tIf cPaisLoc==\"BRA\"\r\n\t\t\t\t\t@ li, aColuna[12] PSAY NoRound((nAc2/nAc1)*100,2)   PicTure \"999.99\"\r\n\t\t\t\tElse\r\n\t\t\t\t\t@ li, aColuna[12] PSAY NoRound((nAc2/nAc1)*100)   PicTure \"999.99\"\r\n\t\t\t\tEndif\r\n\t\t\tEndif\r\n\r\n\t\t\t@ li, aColuna[13]-1  PSAY nAc2 PicTure tm(nAc2,15,nDecs)\r\n\t\t\tli++\r\n\r\n\t\t\tIf mv_par10 > 0 .And. (nAc2 * mv_par10 / 100) > GetMV(\"MV_VLRETIR\") //IR\r\n\t\t\t\t@ li, 00  PSAY OemToAnsi(STR0015)  //\"TOTAL DO IR       --> \"\r\n\t\t\t\tnAc4 += (nAc2 * mv_par10 / 100)\t\t\t\t\r\n\t\t\t\t@ li, aColuna[13]-1  PSAY nAc4 PicTure tm(nAc2 * mv_par10 / 100,15,nDecs)\r\n\t\t\t\tli ++\r\n\t\t\t\t@ li, 00  PSAY OemToAnsi(STR0017)  //\"TOTAL (-) IR      --> \"\r\n\t\t\t\t@ li, aColuna[13]-1 PSAY nAc2 - nAc4 PicTure tm(nAc2,15,nDecs)\r\n\t\t\t\tli ++\r\n\t\t\tEndIf\r\n\r\n\t\t\t@ li, 00  PSAY __PrtThinLine()\r\n\r\n\t\t\tIf mv_par11 == 1  // Quebra pagina por vendedor (padrao)\r\n\t\t\t\tli := 60  \r\n\t\t\tElse\r\n\t\t\t\tli+= 2\r\n\t\t\tEndif\r\n\t\tElse\r\n\t\t\tIf li > 55\r\n\t\t\t\tcabec(titulo,cabec1,cabec2,nomeprog,tamanho,nTipo)\r\n\t\t\tEndIF\r\n\t\t\t@ li,048  PSAY nAc3 \tPicTure tm(nAc3,15,nDecs)\r\n\t\t\t@ li,065  PSAY nAc1 \tPicTure tm(nAc1,15,nDecs)\r\n\t\t\tIf nAc1 != 0\r\n\t\t\t\tIf cPaisLoc==\"BRA\"\r\n\t\t\t\t\t@ li, 081 PSAY NoRound((nAc2/nAc1)*100,2)  PicTure \"999.99\"\r\n\t\t\t\tElse\r\n\t\t\t\t\t@ li, 081 PSAY NoRound((nAc2/nAc1)*100)   PicTure \"999.99\"\r\n\t\t\t\tEndif\r\n\t\t\tEndif\r\n\t\t\t@ li, 089  PSAY nAc2 PicTure tm(nAc2,15,nDecs)\r\n\t\t\tIf mv_par10 > 0 .And. (nAc2 * mv_par10 / 100) > GetMV(\"MV_VLRETIR\") //IR\r\n\t\t\t\tnAc4 += (nAc2 * mv_par10 / 100)\r\n\t\t\t\t@ li, 105  PSAY nAc4 PicTure tm(nAc2 * mv_par10 / 100,15,nDecs)\r\n\t\t\t\t@ li, 121 PSAY nAc2 - nAc4 PicTure tm(nAc2,15,nDecs)\r\n\t\t\tEndIf\r\n\t\t\tli ++\r\n\t\tEndIf\r\n\r\n\t\tdbSelectArea(\"SE3\")\r\n\t\tnAg1 += nAc1\r\n\t\tnAg2 += nAc2\r\n\t\tnAg3 += nAc3\r\n\t\tnAg4 += nAc4\r\n\tEndDo\r\n\r\n\tIf (nAg1+nAg2+nAg3+nAg4) != 0\r\n\t\tIf li > 55\r\n\t\t\tcabec(titulo,cabec1,cabec2,nomeprog,tamanho,nTipo)\r\n\t\tEndif\r\n\r\n\t\tIf mv_par12 == 1\r\n\t\t\t@li,  00 PSAY OemToAnsi(STR0014)  //\"TOTAL  GERAL      --> \"\r\n\t\t\t@li, aColuna[10]-1 PSAY nAg3\tPicture tm(nAg3,15,nDecs)\r\n\t\t\t@li, aColuna[11]-1 PSAY nAg1\tPicture tm(nAg1,15,nDecs)\r\n\t\t\tIf cPaisLoc==\"BRA\"\r\n\t\t\t\t@li, aColuna[12] PSAY NoRound((nAg2/nAg1)*100,2) Picture \"999.99\"\r\n\t\t\tElse\r\n\t\t\t\t@li, aColuna[12] PSAY NoRound((nAg2/nAg1)*100) Picture \"999.99\"\r\n\t\t\tEndif\r\n\t\t\t@li, aColuna[13]-1 PSAY nAg2 Picture tm(nAg2,15,nDecs)\r\n\t\t\tIf mv_par10 > 0 .And. (nAg2 * mv_par10 / 100) > GetMV(\"MV_VLRETIR\")//IR\r\n\t\t\t\tli ++\r\n\t\t\t\t@ li, 00  PSAY OemToAnsi(STR0015)  //\"TOTAL DO IR       --> \"\r\n\t\t\t\t@ li, 175  PSAY nAg4 PicTure tm((nAg2 * mv_par10 / 100),15,nDecs)\r\n\t\t\t\tli ++\r\n\t\t\t\t@ li, 00  PSAY OemToAnsi(STR0017)  //\"TOTAL (-) IR       --> \"\r\n\t\t\t\t@ li, 175  PSAY nAg2 - nAg4 Picture tm(nAg2,15,nDecs)\r\n\t\t\tEndIf\r\n\t\tElse\r\n\t\t\t@li,000  PSAY __PrtThinLine()\r\n\t\t\tli ++\r\n\t\t\t@li,000 PSAY OemToAnsi(STR0014)  //\"TOTAL  GERAL      --> \"\r\n\t\t\t@li,048 PSAY nAg3\tPicture tm(nAg3,15,nDecs)\r\n\t\t\t@li,065 PSAY nAg1\tPicture tm(nAg1,15,nDecs)\r\n\t\t\tIf cPaisLoc==\"BRA\"\r\n\t\t\t\t@li,081 PSAY NoRound((nAg2/nAg1)*100,2) Picture \"999.99\"\r\n\t\t\tElse\r\n\t\t\t\t@li,081 PSAY NoRound((nAg2/nAg1)*100) Picture \"999.99\"\r\n\t\t\tEndif\r\n\t\t\t@li,089 PSAY nAg2 Picture tm(nAg2,15,nDecs)\r\n\t\t\tIf mv_par10 > 0 .And. (nAg2 * mv_par10 / 100) > GetMV(\"MV_VLRETIR\")//IR\r\n\t\t\t\t@ li,105  PSAY nAg4 PicTure tm((nAg2 * mv_par10 / 100),15,nDecs)\r\n\t\t\t\t@ li,121  PSAY nAg2 - nAg4 Picture tm(nAg2,15,nDecs)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\troda(cbcont,cbtxt,\"G\")\r\n\tEndIF\r\n\r\n\t#IFDEF TOP\r\n\tIf TcSrvType() != \"AS/400\"\r\n\t\tdbSelectArea(\"SE3\")\r\n\t\tDbCloseArea()\r\n\t\tchkfile(\"SE3\")\r\n\tElse\t\r\n\t\t#ENDIF\r\n\t\tfErase(cNomArq+OrdBagExt())\r\n\t\t#IFDEF TOP\r\n\tEndif\r\n\t#ENDIF\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Restaura a integridade dos dados                             ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tDbSelectArea(\"SE3\")\r\n\tRetIndex(\"SE3\")\r\n\tDbSetOrder(2)\r\n\tdbClearFilter()\r\n\r\n\t//ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿\r\n\t//³ Se em disco, desvia para Spool                               ³\r\n\t//ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ\r\n\tIf aReturn[5] = 1\r\n\t\tSet Printer To\r\n\t\tdbCommitAll()\r\n\t\tourspool(wnrel)\r\n\tEndif\r\n\r\n\tMS_FLUSH()\r\n\r\n/*\r\nÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜ\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\n±±ÉÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍËÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍ»±±\r\n±±ºPrograma  ³AjustaSX1 ºAutor  ³Ana Paula N. Silva  º Data ³  20/09/07   º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÊÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºDesc.     ³                                                            º±±\r\n±±º          ³                                                            º±±\r\n±±ÌÍÍÍÍÍÍÍÍÍÍØÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¹±±\r\n±±ºUso       ³ MATR540                                                    º±±\r\n±±ÈÍÍÍÍÍÍÍÍÍÍÏÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼±±\r\n±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±\r\nßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßß\r\n*/\r\nStatic Function AjustaSX1()\r\n\tLocal aHelpPor := {}\r\n\tLocal aHelpEng := {}\r\n\tLocal aHelpSpa := {}\r\n\tLocal aAreaSX1 := GetArea()\r\n\r\n\tDbSelectArea(\"SX1\")\r\n\tDbSetOrder(1)\r\n\r\n\tDbSeek(PadR(\"MTR540\",Len(SX1->X1_GRUPO)) + \"09\")\r\n\tRecLock(\"SX1\",.F.)\r\n\tReplace X1_PRESEL With 1\r\n\tReplace X1_DEF01 With \"Não\"\r\n\tReplace X1_DEFSPA1 With \"No\"\r\n\tReplace X1_DEFENG1 With \"No\" \r\n\r\n\tReplace X1_DEF02 With \" \"\r\n\tReplace X1_DEFSPA2 With \" \"\r\n\tReplace X1_DEFENG2 With \" \" \r\n\r\n\taHelpPor := {}\r\n\taHelpEng := {}\r\n\taHelpSpa := {}\r\n\tAADD(aHelpPor,'Indica que não será impresso')\r\n\tAADD(aHelpPor,'comissões zeradas.')\r\n\tAADD(aHelpSpa,'Indica que no se imprimirán') \r\n\tAADD(aHelpSpa,'comisiones en cero.')\r\n\tAADD(aHelpEng,'Indicates the system will not')\r\n\tAADD(aHelpEng,'print commissions zeroed.')\r\n\r\n\r\n\tPutSX1Help(\"P.MTR54009.\",aHelpPor,aHelpEng,aHelpSpa)\r\n\r\n\taHelpPor := {}\r\n\taHelpEng := {}\r\n\taHelpSpa := {}\r\n\tAADD(aHelpPor,'Informe os códigos dos vendedores dos ')\r\n\tAADD(aHelpPor,'quais se deseja emitir a relação de ')\r\n\tAADD(aHelpPor,'comissões.')\r\n\tAADD(aHelpPor,'Tecla [F3] disponível para consultar ')\r\n\tAADD(aHelpPor,'o Cadastro de Vendedores.')\r\n\tAADD(aHelpEng,'Informe os códigos dos vendedores dos ')\r\n\tAADD(aHelpPor,'quais se deseja emitir a relação de ')\r\n\tAADD(aHelpPor,'comissões.')\r\n\tAADD(aHelpEng,'Tecla [F3] disponível para consultar ')\r\n\tAADD(aHelpEng,'o Cadastro de Vendedores.')\r\n\tAADD(aHelpSpa,'Informe os códigos dos vendedores dos ')\r\n\tAADD(aHelpPor,'quais se deseja emitir a relação de ')\r\n\tAADD(aHelpPor,'comissões.')\r\n\tAADD(aHelpSpa,'Tecla [F3] disponível para consultar ')\r\n\tAADD(aHelpSpa,'o Cadastro de Vendedores.')\r\n\tPutSX1Help(\"P.MTR540P9R104.\",aHelpPor,aHelpEng,aHelpSpa)\r\n\r\n\taHelpPor := {}\r\n\taHelpEng := {}\r\n\taHelpSpa := {}\r\n\tAADD(aHelpPor,'Informe se saltará por vendedor.')\r\n\tAADD(aHelpSpa,'Informe se saltará por vendedor.') \r\n\tAADD(aHelpEng,'Informe se saltará por vendedor.')\r\n\tPutSX1Help(\"P.MTR540P9R109.\",aHelpPor,aHelpEng,aHelpSpa)\r\n\r\n\tSX1->(MsUnLock())\r\n\tRestArea(aAreaSX1)\r\n\r\nReturn"}}}
Content-Length: 172
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/07_FINANCEIRO/ITMRFIN010.prw"}}}
Content-Length: 1392
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/08_GRPLUS/GROA0311.PRW","languageId":"advpl","version":1,"text":"#INCLUDE \"rwmake.ch\"\r\n#INCLUDE \"protheus.ch\"\r\n#INCLUDE \"TOPCONN.CH\"\r\n\r\n/*\r\nPonto de entrada que permite alterar o conteúdo da\r\ntotalizador da nota fiscal de entrada B1_POSIPI\r\n*/\r\n\r\nUser Function GROA0311()\r\n***********************************************************************************************************\r\n*\r\n*\r\n***\r\n\r\n    Local nX := 1\r\n\r\n    DbSelectArea(\"SX3\")\r\n    DbSetOrder(2)\r\n\r\n    If DbSeek(\"B1_POSIPI\")\r\n        \r\n        aAdd(aHeadSD1, {;\r\n            SX3->X3_TITULO,;\r\n            SX3->X3_CAMPO,;\r\n            SX3->X3_PICTURE,;\r\n            SX3->X3_TAMANHO,;\r\n            SX3->X3_DECIMAL,;\r\n            \"ALLWAYSTRUE()\",;\r\n            ,;\r\n            SX3->X3_TIPO,;\r\n            SX3->X3_F3,;\r\n            \"\";\r\n        })\r\n\r\n    EndIf\r\n\r\n    For nX := 1 To Len(aColSD1)\r\n\r\n        // Inclui nova coluna de delete\r\n        aAdd(aColSD1[nX], .F.)\r\n        // Atualiza conteúdo do campo que antes era de delete\r\n        aColSD1[nX][Len(aColSD1[nX]) - 1] := Posicione(\"SB1\", 1, xFilial(\"SB1\") + aColSD1[nX][1], \"B1_POSIPI\")\r\n\r\n    Next\r\n\r\nReturn Nil\r\n"}}}
Content-Length: 166
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/08_GRPLUS/GROA0311.PRW"}}}
Content-Length: 31437
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/08_GRPLUS/GROR002.PRW","languageId":"advpl","version":1,"text":"#INCLUDE \"PROTHEUS.CH\"\r\n#INCLUDE \"TOPCONN.CH\"\r\n#INCLUDE \"TBICONN.CH\"\r\n#INCLUDE \"RPTDEF.CH\"\r\n\r\n#DEFINE\tTAM_CUSTOM 0 \t//Tamanho customizavel pelo usuario, informado em nHeight/nWidth. Aplicavel apenas em impressoes do tipo PDF. oficio 2 216 x 330\r\n#DEFINE\tTAM_CARTA 1 \t//Letter   \t216mm x 279mm  637 x 823\r\n#DEFINE\tTAM_TABLOID 3 \t//Tabloid  \t279mm x 432mm  823 x 1275\r\n#DEFINE\tTAM_EXECUTIVE 7\t//Executive 184mm x 267mm  543 x 788\r\n#DEFINE\tTAM_A3 8\t\t//A3     \t297mm x 420mm  876 x 1240\r\n#DEFINE\tTAM_A4 9\t\t//A4     \t210mm x 297mm  620 x 876\r\n#DEFINE pMoeda1 \"@E 999,999.99\"\r\n#DEFINE pMoeda2 \"@E 999,999,999.99\"\r\n#DEFINE __NTAM1  10\r\n#DEFINE __NTAM2  25\r\n#DEFINE __NTAM3  40\r\n#DEFINE __NTAM4  10\r\n#DEFINE __NTAM5  20\r\n#DEFINE __NTAM6  10\r\n#DEFINE __NTAM7  5\r\n#DEFINE __NTAM8  15\r\n#DEFINE __NTAM9  15\r\n#DEFINE __NTAM10 15\r\n#DEFINE EXTPDF \".pdf\"\r\n#DEFINE EXTREL \".rel\"\r\n\r\n//-------------------------------------------------------------------\r\n/*/ { Protheus.doc } GROR002\r\nRelatorio Proforma Invoice - Pedido de VEnda\r\n\r\n@author Diego Muniz Cerqueira\r\n@since 21/11/2016\r\n@version 1.0\r\n/*/\r\n//-------------------------------------------------------------------\r\nUser Function GROR002(lWeb)\r\n\r\n\tDefault lWeb := .F.\r\n\r\n\tIf lWeb\r\n\t\tReturn Execute(lWeb)\r\n\tElse\r\n\t\tProcessa({|| Execute(lWeb)}, \"Aguarde...\", \"Gerando proforma invoice...\", .F.)\r\n\tEndIf\r\n\t\t\r\nReturn Nil\r\n\r\nStatic Function Execute(lWeb)\r\n\r\n\tLocal cPath        := \"c:\\temp\\\"\r\n\tLocal cPathLogo    := getNewPar(\"GR_PATLOGO\",\"../../data/devgranito/logo/\")\r\n\tLocal cRelatorio   := \"proformaInvoice.html\" \t\r\n\tLocal cPathSrv \t   := lower(getMV(\"MV_RELT\"))\r\n\tLocal cFileName\t   := lower(\"proformaInvoice_\" + criaTrab(nil,.f.))\r\n\tLocal lSrvUnix     := IsSrvUnix()\r\n\tLocal cProXDoc\t   := getNewPar(\"GR_PROXDOC\",\"\")\r\n\tLocal oUtil\t\t   := util():new()\r\n\tLocal cError\t   := \"\"\r\n\tLocal cPedido\t   := \"\"\r\n\tLocal cHtml\t\t   := ''\r\n\tLocal cArqHtml     := \"\\relatorios\\exportacao\\proformaInvoice.html\"\r\n\tLocal cRazao\t   := ''\r\n\tLocal cEnd\t\t   := ''\r\n\tLocal cCidade\t   := ''\r\n\tLocal cEstado\t   := ''\r\n\tLocal cCEP\t\t   := ''\r\n\tLocal cFone\t\t   := ''\r\n\tLocal cCnpj\t\t   := ''\r\n\tLocal cInsc\t\t   := ''\r\n\tLocal cObs\t\t   := ''\r\n\tLocal cSite        := Lower(GetMV(\"GR_SITEREL\"))\r\n\tLocal cSQL\t\t   := ''\r\n\tLocal qQUERY\t   := ''\r\n\tLocal cHTMLProduto := ''\r\n\tLocal nContador\t   := 1\r\n\tLocal nTotalPreco  := 0\r\n\tLocal nTotalDesco  := 0\r\n\tLocal nTotalQtd    := 0\r\n\tLocal nTotalCav    := 0\r\n\tLocal nTtPesoBru   := 0\r\n\tLocal nTtPesoLiq   := 0\r\n\tLocal nVlrSeguro   := 0\r\n\tLocal nVlrFrete    := 0\r\n\tLocal nTotalChapa  := 0\r\n\tLocal lHabCalc     := GETNEWPAR(\"GR_HABCALC\", .F.) // Se calcula volume, peso líquido e bruto\r\n\tLocal lPulaLin     := GETNEWPAR(\"GR_TAMINVO\", .T.) // Se ajusta tamanho da grid de produtos\r\n\tLocal nHandle      := 0\r\n\tLocal cJavaScript  := \"\"\r\n\tLocal nDesconto    := 0 \r\n\tLocal nPercDesc\t   := 0\r\n\t\r\n\tDefault lWeb := .F.\r\n\r\n\tU_TOTVSES()\r\n\r\n\tIf lSrvUnix\r\n\t\tcPathSrv := strTran(cPathSrv,\"\\\",\"/\")\r\n\tEndIf\r\n\r\n\t// Carrega Template\r\n\tnHandle := FT_FUse(cArqHtml)\r\n\tIf nHandle == -1\r\n\t\tIf lWeb\r\n\t\t\tConout(\"Falha ao abrir o arquivo de layout! Favor verIficar se existe o arquivo \" + cArqHtml + \".\")\r\n\t\tElse\r\n\t\t\tMsgStop(\"Falha ao abrir o arquivo de layout! Favor verIficar se existe o arquivo \" + cArqHtml + \".\")\r\n\t\tEndIf\r\n\t\tReturn Nil\r\n\tEndIf\r\n\t\r\n\tFT_FGOTOP()\r\n\tWhile !FT_FEof()\r\n\t\tcHtml += FT_FReadln()\r\n\t\tFT_FSkip()\r\n\tEnddo\r\n\tFT_FUse()\r\n\r\n\tIf lWeb\r\n\t\tcPedido := SC5->C5_NUM //paramixb:PEDIDO\t\t\r\n\tElse\r\n\t\tProcRegua(0)\t\r\n\t\tIncProc(1)\t\r\n\t\tIncProc(1)\r\n\r\n\t\tcPedido := SC5->C5_NUM\r\n\t\tCPYS2T(\"\\relatorios\\logo.png\" , cPath)\r\n\t\taDir  := Directory(cPath, \"D\")\r\n\t\tIf Len(aDir) = 0\r\n\t\t\tMakeDir(cPath)\t\r\n\t\tEndIf\r\n\r\n\t\tcHtml := strTran(cHtml, \"DIRLOGO/logo.png\", cPathLogo + \"logo.png\")\t\t\r\n\tEndIf\r\n\r\n\tIf getNewPar(\"GR_LOGOFIL\", .F.)\r\n\t\tcHtml := strTran(cHtml, \"logo.png\", AllTrim(cEmpAnt) + AllTrim(cFilAnt) + \".png\")\r\n\tEndIf\r\n\r\n\tcRazao\t:= allTrim(RetField('SM0', 1, cEmpAnt + cFilAnt, 'M0_NOMECOM'))\r\n\tcEnd\t:= allTrim(RetField('SM0', 1, cEmpAnt + cFilAnt, 'M0_EndCOB')) + \", \"\r\n\tcEnd\t+= allTrim(RetField('SM0', 1, cEmpAnt + cFilAnt, 'M0_COMPCOB'))\r\n\tcCidade\t:= allTrim(RetField('SM0', 1, cEmpAnt + cFilAnt, 'M0_CIDCOB'))\r\n\tcEstado\t:= allTrim(RetField('SM0', 1, cEmpAnt + cFilAnt, 'M0_ESTCOB'))\r\n\tcCEP\t:= allTrim(RetField('SM0', 1, cEmpAnt + cFilAnt, 'M0_CEPCOB'))\r\n\tcFone\t:= allTrim(RetField('SM0', 1, cEmpAnt + cFilAnt, 'M0_TEL'))\r\n\tcCnpj\t:= allTrim(RetField('SM0', 1, cEmpAnt + cFilAnt, 'M0_CGC'))\r\n\tcInsc\t:= allTrim(RetField('SM0', 1, cEmpAnt + cFilAnt, 'M0_INSC'))\r\n\r\n\tcHtml := strTran(cHtml, \"{{empresa_emissora}}\", cRazao)\r\n\tcHtml := strTran(cHtml, \"{{Endereco_emissora}}\", cEnd)\r\n\tcHtml := strTran(cHtml, \"{{cep_emissora}}\", cCEP)\r\n\tcHtml := strTran(cHtml, \"{{municipio_emissora}}\", cCidade)\r\n\tcHtml := strTran(cHtml, \"{{uf_emissora}}\", cEstado)\r\n\tcHtml := strTran(cHtml, \"{{telefone_emissora}}\", cFone)\r\n\tcHtml := strTran(cHtml, \"{{site}}\", cSite)\r\n\r\n\tZGO->(dbSetOrder(1))\r\n\r\n\t\tIf ZGO->(msSeek(xFilial(\"ZGO\")+cPedido))\r\n\r\n\t\t\t// dados da exportaï¿½ï¿½o\r\n\t\t\t\t\t\r\n\t\t\tcObs  := AllTrim(ZGO->ZGO_OBSERV)\r\n\t\t\t\r\n\t\t\tcHtml := strTran(cHtml, \"{{invoice}}\", Posicione(\"SC5\", 1, xFilial(\"SC5\") + ZGO->ZGO_PEDIDO, \"C5_YINVOIC\"))\r\n\t\t\tcHtml := strTran(cHtml, \"{{orcamento}}\", Posicione(\"SC5\", 1, xFilial(\"SC5\") + ZGO->ZGO_PEDIDO, \"C5_COTACAO\"))\r\n\t\t\tcHtml := strTran(cHtml, \"{{po}}\", ZGO->ZGO_ORDEM)\r\n\t\t\tcHtml := strTran(cHtml, \"{{booking}}\", ZGO->ZGO_RESERV)\r\n\t\r\n\t\t\tcHtml := strTran(cHtml, \"{{port_origin}}\", Posicione(\"SY9\", 2, xFilial(\"SY9\") + ZGO->ZGO_ORIGEM, \"Y9_DESCR\"))\r\n\t\t\tcHtml := strTran(cHtml, \"{{port_destination}}\", Posicione(\"SY9\", 2, xFilial(\"SY9\") + ZGO->ZGO_DESTIN, \"Y9_DESCR\"))\r\n\t\t\tcHtml := strTran(cHtml, \"{{destination}}\", Posicione(\"SY9\", 2, xFilial(\"SY9\") + ZGO->ZGO_DESFIN, \"Y9_DESCR\"))\r\n\t\t\tcHtml := strTran(cHtml, \"{{vessel}}\", ZGO->ZGO_EMBARC)\r\n\t\t\tcHtml := strTran(cHtml, \"{{freight_forwarder}}\", ZGO->ZGO_AGEMAR)\r\n\t\t\tcHtml := strTran(cHtml, \"{{ship_line}}\", ZGO->ZGO_ARMADO)\r\n\t\t\tcHtml := strTran(cHtml, \"{{sales_agent}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{agent_order}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{incoterm}}\", ZGO->ZGO_INCOTE)\r\n\t\t\tcHtml := strTran(cHtml, \"{{ship_date}}\", oUtil:getFormatDate(ZGO->ZGO_DATEMB, 'mm/dd/yyyy'))\r\n\t\r\n\t\t\tIf !lHabCalc\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{total_net_weight}}\", transform(ZGO->ZGO_PESLIQ, X3Picture(\"ZGO_PESLIQ\")))\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{total_gross_weight}}\", transform(ZGO->ZGO_PESBRU, X3Picture(\"ZGO_PESBRU\")))\r\n\t\t\tEndIf\r\n\t\r\n\t\t\tcHtml := strTran(cHtml, \"{{container}}\", ZGO->ZGO_CONTAI)\r\n\t\t\tcHtml := strTran(cHtml, \"{{type}}\", ZGO->ZGO_TIPOCO)\r\n\t\t\tcHtml := strTran(cHtml, \"{{credit_memo}}\", ZGO->ZGO_CREMEM)\r\n\t\t\tcHtml := strTran(cHtml, \"{{tare}}\", transform(ZGO->ZGO_TARA, X3Picture(\"ZGO_TARA\")))\r\n\t\t\tcHtml := strTran(cHtml, \"{{door_seal}}\", ZGO->ZGO_LACRE)\r\n\t\t\tcHtml := strTran(cHtml, \"{{top_seal}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{hts}}\", ZGO->ZGO_NCM)\r\n\t\t\tcHtml := strTran(cHtml, \"{{bill_landing}}\", ZGO->ZGO_BL)\r\n\t\t\t\r\n\t\tEndif\t\r\n\r\n\t\tSC5->(dbSetOrder(1))\r\n\t\t\r\n\t\tIf SC5->(msSeek(xFilial(\"SC5\")+cPedido))\r\n\t\t\r\n\t\t\t// dados do pedido de vEnda\r\n\t\t\t\r\n\t\t\tcHtml := strTran(cHtml, \"{{date}}\", oUtil:getFormatDate(SC5->C5_EMISSAO, 'mm/dd/yyyy') )\r\n\t\t\tcHtml := strTran(cHtml, \"{{insurance}}\", transform(SC5->C5_SEGURO, X3Picture(\"C5_SEGURO\")))\r\n\t\t\tcHtml := strTran(cHtml, \"{{freight}}\", transform(SC5->C5_FRETE, X3Picture(\"C5_FRETE\")))\r\n\t\t\tcHtml := strTran(cHtml, \"{{extra_expenses}}\", transform(SC5->C5_DESPESA, X3Picture(\"C5_DESPESA\")))\r\n\t\t\t\r\n\t\t\tnPercDesc  := SC5->C5_DESC1\r\n\t\t\tnDesconto  := SC5->C5_DESCONT\r\n\t\t\tnVlrSeguro := SC5->C5_SEGURO\r\n\t\t\tnVlrFrete  := SC5->C5_FRETE\r\n\t\t\t\r\n\t\t\tSE4->(dbSetOrder(1))\r\n\t\t\t\r\n\t\t\tIf SE4->(msSeek(xFilial(\"SE4\")+SC5->C5_CONDPAG))\r\n\t\t\t\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{payment_term}}\", SE4->E4_DESCRI)\r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tEndIf\r\n\r\n\t\tcFkBanco := \"\"\r\n\r\n\t\tSA6->(dbSetOrder(1))\r\n\t\t\r\n\t\tIf SA6->(msSeek(xFilial(\"SA6\")+ZGO->(ZGO_BANCO+ZGO_AGENCI+ZGO_NUMCON)))\r\n\t\t\r\n\t\t\tcFkBanco := SA6->(A6_YCOD + A6_YAGENCI + A6_YNUMCON)\r\n\t\t\r\n\t\t\t//dados do banco\r\n\t\t\t\r\n\t\t\tcHtml := strTran(cHtml, \"{{bank_1}}\", SA6->A6_YBANEXP)\r\n\t\t\tcHtml := strTran(cHtml, \"{{swIft_1}}\", SA6->A6_YCODEXP)\r\n\t\t\tcHtml := strTran(cHtml, \"{{account}}\", SA6->A6_YCONEXT)\r\n\t\t\tcHtml := strTran(cHtml, \"{{fedwire}}\", SA6->A6_YFEDWIR)\r\n\t\t\tcHtml := strTran(cHtml, \"{{bank_2}}\", SA6->A6_YCORRES)\r\n\t\t\tcHtml := strTran(cHtml, \"{{swIft_2}}\", SA6->A6_YBICSWI)\r\n\t\t\tcHtml := strTran(cHtml, \"{{iban}}\", SA6->A6_YIBAN)\r\n\t\t\tcHtml := strTran(cHtml, \"{{chips_uid}}\", SA6->A6_YCHIPSU)\r\n\t\t\t\r\n\t\tElse\r\n\t\t\r\n\t\t\tcHtml := strTran(cHtml, \"{{bank_1}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{swIft_1}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{account}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{fedwire}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{bank_2}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{swIft_2}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{iban}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{chips_uid}}\", \" \")\r\n\t\t\t\r\n\t\tEndIf\r\n\t\t\t\t\t\t\t\t\r\n\t\tIf !Empty(cFkBanco)\r\n\t\t\r\n\t\t\tIf SA6->(msSeek(xFilial(\"SA6\") + cFkBanco))\r\n\t\t\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_bank_1}}\", SA6->A6_YBANEXP)\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_swIft_1}}\", SA6->A6_YCODEXP)\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_account}}\", SA6->A6_YCONEXT)\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_fedwire}}\", SA6->A6_YFEDWIR)\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_bank_2}}\", SA6->A6_YCORRES)\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_swIft_2}}\", SA6->A6_YBICSWI)\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_iban}}\", SA6->A6_YIBAN)\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_chips_uid}}\", SA6->A6_YCHIPSU)\r\n\t\t\r\n\t\t\tElse\r\n\t\t\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_bank_1}}\", \" \")\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_swIft_1}}\", \" \")\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_account}}\", \" \")\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_fedwire}}\", \" \")\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_bank_2}}\", \" \")\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_swIft_2}}\", \" \")\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_iban}}\", \" \")\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{sec_chips_uid}}\", \" \")\r\n\t\t\r\n\t\t\tEndIf\t\r\n\r\n\t\tElse\r\n\r\n\t\t\tcHtml := strTran(cHtml, \"{{sec_bank_1}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{sec_swIft_1}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{sec_account}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{sec_fedwire}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{sec_bank_2}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{sec_swIft_2}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{sec_iban}}\", \" \")\r\n\t\t\tcHtml := strTran(cHtml, \"{{sec_chips_uid}}\", \" \")\r\n\r\n\t\tEndIf\t\r\n\t\t\r\n\t\tSA1->(dbSetOrder(1))\r\n\t\t\r\n\t\tIf SA1->(msSeek(xFilial(\"SA1\")+ZGO->(ZGO_CLIENT+ZGO_LOJA)))\r\n\t\t\r\n\t\t\t//dados do cliente\r\n\t\t\t\r\n\t\t\tcHtml := strTran(cHtml, \"{{empresa}}\", SA1->A1_NOME)\r\n\t\t\tcHtml := strTran(cHtml, \"{{Endereco}}\", SA1->A1_End)\r\n\t\t\tcHtml := strTran(cHtml, \"{{cep}}\", SA1->A1_CEP)\r\n\t\t\tcHtml := strTran(cHtml, \"{{municipio}}\", SA1->A1_MUN)\r\n\t\t\tcHtml := strTran(cHtml, \"{{uf}}\", SA1->A1_EST)\r\n\t\t\t\r\n\t\t\tSYA->(dbSetOrder(1))\r\n\t\t\t\r\n\t\t\tIf SYA->(msSeek(xFilial(\"SYA\")+SA1->A1_PAIS))\r\n\t\t\t\r\n\t\t\t\tcHtml := strTran(cHtml, \"{{pais}}\", SYA->YA_DESCR)\r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tcHtml := strTran(cHtml, \"{{telefone}}\", SA1->A1_TEL)\r\n\t\t\tcHtml := strTran(cHtml, \"{{contato}}\", SA1->A1_CONTATO)\r\n\t\t\t\r\n\t\tEndIf\r\n\t\t\r\n\t//EndIf\r\n\r\n\t//----------------------------------------------------\r\n\t// Soma pesos dos cavaletes.\r\n\t//----------------------------------------------------\r\n\r\n\tIf lHabCalc\r\n\r\n\t\tcSQL := \"    SELECT SUM(DISTINCT ZG3_TARA) ZG3_TARA, SUM(DISTINCT ZG3_PESOLQ) ZG3_PESOLQ, SUM(DISTINCT ZG3_PESOBR) ZG3_PESOBR \"\r\n\t\tcSQL += \"      FROM \" + RETSQLNAME(\"SC6\") + \" SC6\" + CHR(10)\r\n\t\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"SB1\") + \" SB1\" + CHR(10)                        \r\n\t\tcSQL += \"        ON SB1.B1_FILIAL  = '\" + xFilial(\"SB1\") + \"'\" + CHR(10)\r\n\t\tcSQL += \"       AND SB1.B1_COD     = C6_PRODUTO\" + CHR(10)\r\n\t\tcSQL += \"       AND SB1.D_E_L_E_T_ = ''\" + CHR(10)             \r\n\t\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"SBM\") + \" SBM\" + CHR(10)                        \r\n\t\tcSQL += \"        ON SBM.BM_FILIAL  = '\" + xFilial(\"SBM\") + \"'\" + CHR(10)\r\n\t\tcSQL += \"       AND SBM.BM_GRUPO   = SB1.B1_GRUPO\" + CHR(10)\r\n\t\tcSQL += \"       AND SBM.D_E_L_E_T_ = ''\" + CHR(10)                \r\n\t\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"SC9\") + \" SC9\" + CHR(10)\r\n\t\tcSQL += \"        ON SC9.C9_FILIAL  = '\" + xFilial(\"SC9\") + \"'\" + CHR(10)\r\n\t\tcSQL += \"       AND SC9.C9_PEDIDO  = C6_NUM\" + CHR(10)\r\n\t\tcSQL += \"       AND SC9.C9_ITEM    = C6_ITEM\" + CHR(10)\r\n\t\tcSQL += \"       AND SC9.C9_PRODUTO = C6_PRODUTO\" + CHR(10)\r\n\t\tcSQL += \"       AND SC9.C9_LOTECTL = C6_LOTECTL\" + CHR(10)\r\n\t\tcSQL += \"       AND SC9.C9_NUMLOTE = C6_NUMLOTE\" + CHR(10)\r\n\t\tcSQL += \"       AND SC9.D_E_L_E_T_ = ''\" + CHR(10)                                 \r\n\t\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"SB8\") + \" SB8\" + CHR(10)\r\n\t\tcSQL += \"        ON SB8.B8_FILIAL  = '\" + xFilial(\"SB8\") + \"'\" + CHR(10)\r\n\t\tcSQL += \"       AND SB8.B8_PRODUTO = C9_PRODUTO\" + CHR(10)\r\n\t\tcSQL += \"       AND SB8.B8_LOTECTL = C9_LOTECTL\" + CHR(10)\r\n\t\tcSQL += \"       AND SB8.B8_NUMLOTE = C9_NUMLOTE\" + CHR(10)                  \r\n\t\tcSQL += \"       AND SB8.D_E_L_E_T_ = ''\" + CHR(10)             \r\n\r\n\t\t// Consulta cavaletes pra calcular o peso\r\n\t\tcSql += \" LEFT JOIN \" + RetSqlName(\"ZG3\") + \" ZG3 \" + Chr(10)\r\n\t\tcSql += \"        ON ZG3.ZG3_FILIAL = '\" + xFilial(\"ZG3\") + \"' \"\r\n\t\tcSql += \"       AND ZG3.ZG3_CODIGO = SB8.B8_YCAVALE \"\r\n\t\tcSql += \"       AND ZG3.D_E_L_E_T_ = '' \"\r\n\t\t\t\t\t\r\n\t\tcSQL += \"     WHERE SC6.C6_FILIAL  = '\" + xFilial(\"SC6\") + \"'\" + CHR(10)\r\n\t\tcSQL += \"       AND SC6.C6_NUM  = '\" + cPedido + \"'\" + CHR(10)\r\n\t\tcSQL += \"       AND SC6.D_E_L_E_T_ = ''\" + CHR(10)\r\n\t\tcSQL += \"       AND SC9.C9_QTDLIB > 0\" + CHR(10)\r\n\r\n\t\tIf !(Empty(cProXDoc))\r\n\r\n\t\t\tcSQL += \"       AND SBM.BM_YTIPO IN \" + cProXDoc + CHR(10)\r\n\r\n\t\tEndIf\r\n\r\n\t\tcSql += \" GROUP BY ZG3_CODIGO\"\r\n\r\n\t\tTCQUERY cSQL NEW ALIAS qQUERY\r\n\r\n\t\tnTtPesoBru := 0\r\n\t\tnTtPesoLiq := 0\r\n\r\n\t\tWhile qQUERY->(!Eof())\r\n\r\n\t\t\tnTtPesoBru  += qQUERY->ZG3_PESOBR\r\n\t\t\tnTtPesoLiq  += qQUERY->ZG3_PESOLQ\r\n\r\n\t\t\tqQUERY->(DbSkip())\r\n\r\n\t\tEndDo\r\n\r\n\t\tqQUERY->(DbCloseArea())\r\n\r\n\tEndIf\r\n\r\n\t//----------------------------------------------------\r\n\t// Consulta produtos do pedido de vEnda.\r\n\t//----------------------------------------------------\r\n\r\n\tcSQL := \"    SELECT C6_PRODUTO, B1_PESO, B1_PESBRU, \" + CHR(10)\r\n\tcSQL += \"           CASE\" + CHR(10)\r\n\tcSQL += \"                WHEN EX6_YDESCI <> '' THEN RTRIM(EX6_YDESCI)\" + CHR(10)\r\n\tcSQL += \"                WHEN B5_YCEMEIN <> '' THEN RTRIM(B5_YCEMEIN) Else RTRIM(B5_CEME)\" + CHR(10) \r\n\tcSQL += \"           End + ' - ' + RTRIM(ISNULL(ZG4_DESCRI,'')) AS B5_CEME, C6_DESCRI,\" + CHR(10)\r\n\tcSQL += \"           COUNT(C6_PRODUTO) AS QTD_CHAPA,\" + CHR(10)\r\n\tcSQL += \"           COUNT(DISTINCT B8_YCAVALE) AS QTD_CAVALE,\" + CHR(10)\r\n\tcSQL += \"     \t\tSUM(DISTINCT C6_QTDVEN) AS C6_QTDVEN,\" + CHR(10) \r\n\tcSQL += \"     \t\tSUM(C9_QTDLIB) AS C9_QTDLIB,\" + CHR(10) \r\n\tcSQL += \"     \t\tSUM(C6_YTOTBRU) as C6_YTOTBRU,\" + CHR(10)\r\n\tcSQL += \"     \t\tSUM(C6_YTOTLIQ) as C6_YTOTLIQ,\" + CHR(10)\r\n\tcSQL += \"     \t\tZGO_PESLIQ, ZGO_PESBRU, ZGO_TARA,\" + CHR(10)\r\n\r\n\t// Soma peso dos cavaletes\r\n\t// cSql += \"           SUM(DISTINCT ZG3_TARA) ZG3_TARA, SUM(DISTINCT ZG3_PESOLQ) ZG3_PESOLQ, SUM(DISTINCT ZG3_PESOBR) ZG3_PESOBR, \"\r\n\r\n\tcSQL += \"     \t\tSUM(C6_VALDESC) AS C6_VALDESC, C6_PRUNIT, AVG(C6_PRCVEN) AS C6_PRCVEN\" + CHR(10)\r\n\tcSQL += \"      FROM \" + RETSQLNAME(\"SC6\") + \" SC6\" + CHR(10)\r\n\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"SB1\") + \" SB1\" + CHR(10)                        \r\n\tcSQL += \"        ON SB1.B1_FILIAL  = '\" + xFilial(\"SB1\") + \"'\" + CHR(10)\r\n\tcSQL += \"       AND SB1.B1_COD     = C6_PRODUTO\" + CHR(10)\r\n\tcSQL += \"       AND SB1.D_E_L_E_T_ = ''\" + CHR(10)             \r\n\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"SBM\") + \" SBM\" + CHR(10)                        \r\n\tcSQL += \"        ON SBM.BM_FILIAL  = '\" + xFilial(\"SBM\") + \"'\" + CHR(10)\r\n\tcSQL += \"       AND SBM.BM_GRUPO   = SB1.B1_GRUPO\" + CHR(10)\r\n\tcSQL += \"       AND SBM.D_E_L_E_T_ = ''\" + CHR(10)                \r\n\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"SB5\") + \" SB5\" + CHR(10)                        \r\n\tcSQL += \"        ON SB5.B5_FILIAL  = '\" + xFilial(\"SB5\") + \"'\" + CHR(10)\r\n\tcSQL += \"       AND SB5.B5_COD     = C6_PRODUTO\" + CHR(10)\r\n\tcSQL += \"       AND SB5.D_E_L_E_T_ = ''\" + CHR(10)                \r\n\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"SC9\") + \" SC9\" + CHR(10)\r\n\tcSQL += \"        ON SC9.C9_FILIAL  = '\" + xFilial(\"SC9\") + \"'\" + CHR(10)\r\n\tcSQL += \"       AND SC9.C9_PEDIDO  = C6_NUM\" + CHR(10)\r\n\tcSQL += \"       AND SC9.C9_ITEM    = C6_ITEM\" + CHR(10)\r\n\tcSQL += \"       AND SC9.C9_PRODUTO = C6_PRODUTO\" + CHR(10)\r\n\tcSQL += \"       AND SC9.C9_LOTECTL = C6_LOTECTL\" + CHR(10)\r\n\tcSQL += \"       AND SC9.C9_NUMLOTE = C6_NUMLOTE\" + CHR(10)\r\n\tcSQL += \"       AND SC9.D_E_L_E_T_ = ''\" + CHR(10)                                 \r\n\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"SB8\") + \" SB8\" + CHR(10)\r\n\tcSQL += \"        ON SB8.B8_FILIAL  = '\" + xFilial(\"SB8\") + \"'\" + CHR(10)\r\n\tcSQL += \"       AND SB8.B8_PRODUTO = C9_PRODUTO\" + CHR(10)\r\n\tcSQL += \"       AND SB8.B8_LOTECTL = C9_LOTECTL\" + CHR(10)\r\n\tcSQL += \"       AND SB8.B8_NUMLOTE = C9_NUMLOTE\" + CHR(10)                  \r\n\tcSQL += \"       AND SB8.D_E_L_E_T_ = ''\" + CHR(10)             \r\n\r\n\t// Consulta cavaletes pra calcular o peso\r\n\t// cSql += \" LEFT JOIN \" + RetSqlName(\"ZG3\") + \" ZG3 \" + Chr(10)\r\n\t// cSql += \"        ON ZG3.ZG3_CODIGO = SB8.B8_YCAVALE \"\r\n\t// cSql += \"       AND ZG3.D_E_L_E_T_ = '' \"\r\n\t\t\t\t\r\n\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"EX6\") + \" EX6\" + CHR(10)\r\n\tcSQL += \"        ON EX6.EX6_FILIAL = '\" + xFilial(\"EX6\") + \"'\" + CHR(10)\r\n\tcSQL += \"       AND EX6.EX6_COD_I  = C6_PRODUTO\" + CHR(10)\r\n\tcSQL += \"       AND EX6.EX6_CLIENT = C6_CLI\" + CHR(10)\r\n\tcSQL += \"       AND EX6.EX6_CLLOJA = C6_LOJA\" + CHR(10)\r\n\tcSQL += \"       AND EX6.EX6_YCLASS = B8_YCLASSI\" + CHR(10)\r\n\tcSQL += \"       AND EX6.D_E_L_E_T_ = ''\" + CHR(10)                \r\n\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"ZGO\") + \" ZGO\" + CHR(10)\r\n\tcSQL += \"        ON ZGO.ZGO_FILIAL = '\" + xFilial(\"ZGO\") + \"'\" + CHR(10)\r\n\tcSQL += \"       AND ZGO.ZGO_PEDIDO = C9_PEDIDO\" + CHR(10)\r\n\tcSQL += \"       AND ZGO.D_E_L_E_T_ = ''\" + CHR(10)\r\n\tcSQL += \" LEFT JOIN \" + RETSQLNAME(\"ZG4\") + \" ZG4\" + CHR(10)\r\n\tcSQL += \"        ON ZG4.ZG4_FILIAL = '\" + xFilial(\"ZG4\") + \"'\" + CHR(10)\r\n\tcSQL += \"       AND ZG4.ZG4_CODIGO = B8_YCLASSI\" + CHR(10)       \r\n\tcSQL += \"       AND ZG4.D_E_L_E_T_ = ''\" + CHR(10)\r\n\tcSQL += \"     WHERE SC6.C6_FILIAL  = '\" + xFilial(\"SC6\") + \"'\" + CHR(10)\r\n\tcSQL += \"       AND SC6.C6_NUM  = '\" + cPedido + \"'\" + CHR(10)\r\n\tcSQL += \"       AND SC6.D_E_L_E_T_ = ''\" + CHR(10)\r\n\tcSQL += \"       AND SC9.C9_QTDLIB > 0\" + CHR(10)\r\n\r\n\tIf !(Empty(cProXDoc))\r\n\r\n\t\tcSQL += \"       AND SBM.BM_YTIPO IN \" + cProXDoc + CHR(10)\r\n\r\n\tEndIf\r\n\r\n\tcSQL += \"  GROUP BY C6_PRODUTO,  B1_PESO, B1_PESBRU, C6_DESCRI, B5_CEME, ZGO_PESLIQ, ZGO_PESBRU, ZGO_TARA, C6_VALDESC, C6_PRUNIT, ZG4_DESCRI, EX6_YDESCI, B5_YCEMEIN\" + CHR(10)\r\n\tcSQL += \"  ORDER BY C6_DESCRI DESC\" + CHR(10)\r\n\r\n\tTCQUERY cSQL NEW ALIAS qQUERY\r\n\r\n\tnTotalChapa := 0\r\n\r\n\tqQUERY->(dbGoTop())\r\n\r\n\twhile qQUERY->(!eof())     \r\n\r\n\t\tIf \"AMOSTRA\" $ qQUERY->B5_CEME\r\n\t\t\r\n\t\t\tcHTMLProduto += \"<tr>\"\r\n\t\t\tcHTMLProduto += \"<td style='border-right: 1px solid; border-left: 1px solid'>\" + cValToChar(nContador++) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(0, X3Picture(\"C5_DESPESA\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(0, X3Picture(\"C5_DESPESA\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='border-right: 1px solid'>\" + qQUERY->C6_DESCRI + \" \" + cValToChar(qQUERY->C6_QTDVEN) + \" PCS </td>\"\t\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(qQUERY->C6_PRCVEN, X3Picture(\"C6_PRCVEN\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(qQUERY->C6_PRCVEN / 10.764, X3Picture(\"C6_PRCVEN\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(qQUERY->C6_QTDVEN*C6_PRCVEN, X3Picture(\"C6_VALOR\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"</tr>\"\r\n\t\t\t\r\n\t\t\tnTotalPreco  += Round(qQUERY->C6_QTDVEN * C6_PRCVEN, TamSX3(\"C6_VALOR\")[2])\r\n\t\t\tnTotalDesco  += qQUERY->C6_VALDESC\r\n\t\t\tnTotalQtd    += 0\r\n\t\t\tnTotalCav    += 0\r\n\r\n\t\t\tnTtPesoLiq += qQUERY->C9_QTDLIB * qQUERY->B1_PESO\r\n\t\t\tnTtPesoBru += qQUERY->C9_QTDLIB * qQUERY->B1_PESBRU\r\n\r\n\t\t\t// nTtPesoBru  += 0\r\n\t\t\t// nTtPesoLiq  += 0\r\n\t\t\t\r\n\t\tElse\r\n\r\n\t\t\tnTotalChapa += qQUERY->QTD_CHAPA\r\n\t\t\r\n\t\t\tcHTMLProduto += \"<tr>\"\r\n\t\t\tcHTMLProduto += \"<td style='border-right: 1px solid; border-left: 1px solid'>\" + cValToChar(nContador++) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(qQUERY->C9_QTDLIB, X3Picture(\"C9_QTDLIB\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(qQUERY->C9_QTDLIB * 10.764, X3Picture(\"C9_QTDLIB\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='border-right: 1px solid'>\" + qQUERY->B5_CEME + \" - (\" + cValToChar(qQUERY->QTD_CAVALE) + \" BUNDLES) \" + cValToChar(qQUERY->QTD_CHAPA) + \" SLABS</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(qQUERY->C6_PRUNIT, X3Picture(\"C6_PRUNIT\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(qQUERY->C6_PRUNIT / 10.764, X3Picture(\"C6_PRUNIT\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>\" + transform(qQUERY->C9_QTDLIB*C6_PRUNIT, X3Picture(\"C6_PRUNIT\")) + \"</td>\"\r\n\t\t\tcHTMLProduto += \"</tr>\"\r\n\t\t\tnTotalPreco  += Round(qQUERY->C9_QTDLIB * C6_PRUNIT, TamSX3(\"C6_VALOR\")[2])\r\n\t\t\tnTotalDesco  += qQUERY->C6_VALDESC\r\n\t\t\tnTotalQtd    += qQUERY->C9_QTDLIB\r\n\t\t\tnTotalCav    += qQUERY->QTD_CAVALE\r\n\r\n\t\t\tIf !lHabCalc\r\n\t\t\t\tnTtPesoBru += qQUERY->ZGO_PESBRU\r\n\t\t\t\tnTtPesoLiq += qQUERY->ZGO_PESLIQ\r\n\t\t\tEndIf\r\n\r\n\t\t\t// nTtPesoBru  += qQUERY->ZGO_PESBRU\r\n\t\t\t// nTtPesoLiq  += qQUERY->ZGO_PESLIQ\r\n\t\t\t\r\n\t\tEndIf\r\n\t\t\r\n\t\tqQUERY->(dbSkip())\r\n\t\t\r\n\tEndDo\r\n\r\n\tIf nContador > 32 .And. lPulaLin\r\n\r\n\t\twhile nContador%44 != 0\r\n\t\t\r\n\t\t\tcHTMLProduto += \"<tr>\"\r\n\t\t\tcHTMLProduto += \"<td style='border-right: 1px solid; border-left: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"</tr>\"\r\n\t\t\t\r\n\t\t\tnContador++\r\n\t\t\t\r\n\t\tEndDo\r\n\t\t\r\n\tElseIf lPulaLin\r\n\r\n\t\twhile nContador%23 != 0\r\n\t\t\r\n\t\t\tcHTMLProduto += \"<tr>\"\r\n\t\t\tcHTMLProduto += \"<td style='border-right: 1px solid; border-left: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\t\tcHTMLProduto += \"</tr>\"\r\n\t\t\t\r\n\t\t\tnContador++\r\n\t\t\t\r\n\t\tEndDo\r\n\t\t\r\n\tEndIf\r\n\r\n\tIf At(\"{{observacao}}\", cHtml) > 0\r\n\r\n\t\tcHtml := strTran(cHtml, \"{{observacao}}\", cObs)\r\n\r\n\tElse\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\tcHTMLProduto += \"<tr>\"\r\n\t\tcHTMLProduto += \"<td style='border-right: 1px solid; border-left: 1px solid'></td>\"\r\n\t\tcHTMLProduto += \"<td style='border-right: 1px solid'></td>\"\r\n\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'>NOTE:</td>\"\r\n\t\tcHTMLProduto += \"<td style='text-align:left; border-right: 1px solid'>\" + cObs + \"</td>\"\r\n\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\tcHTMLProduto += \"<td style='text-align:right; border-right: 1px solid'></td>\"\r\n\t\tcHTMLProduto += \"</tr>\"\r\n\t\t\r\n\tEndIf\r\n\r\n\tqQUERY->(dbCloseArea())\r\n\r\n\tcHtml := strTran(cHtml, \"{{number_packages}}\", cValToChar(nTotalCav))\r\n\r\n\tcHtml := strTran(cHtml, \"{{msg}}\", \"NO COMPLAINT REGARGING <br>QUALITY WILL BE ACCEPTED <br>AFTER 60 DAYS FROM B/L DATE.\")\r\n\tcHtml := strTran(cHtml, \"{{msg_2}}\", \"We confirm this is product of Brazil origin.<br>We certIfy that the wood used in our packing is totally free from bark and apparently free form live plant.\")\r\n\r\n\tcHtml := strTran(cHtml, \"{{tag_produtos}}\", cHTMLProduto)\r\n\r\n\tcHtml := strTran(cHtml, \"{{measures_m2}}\", transform(nTotalQtd, \"@E 9,999,999.999\"))\r\n\tcHtml := strTran(cHtml, \"{{measures_ft2}}\", transform(nTotalQtd * 10.764, \"@E 9,999,999.999\"))\r\n\r\n\tnTtDesconto := nDesconto + (nPercDesc * nTotalPreco / 100)\r\n\r\n\tcHtml := strTran(cHtml, \"{{desconto}}\", transform(nTtDesconto, \"@E 9,999,999.99\"))\r\n\r\n\tcHtml := strTran(cHtml, \"{{fob_price}}\", transform(nTotalPreco, \"@E 9,999,999.99\"))\r\n\tcHtml := strTran(cHtml, \"{{credit_note}}\", transform(nTotalDesco, \"@E 9,999,999.99\"))\r\n\tcHtml := strTran(cHtml, \"{{total_price}}\", transform(nTotalPreco-nTotalDesco-nTtDesconto+nVlrSeguro+nVlrFrete, \"@E 9,999,999.99\"))\r\n\tcHtml := strTran(cHtml, \"{{total_extenso}}\", StrTran(extenso(nTotalPreco-nTotalDesco-nTtDesconto+nVlrSeguro+nVlrFrete,,2,,\"3\"), \"DOLARES\", \"DOLLARS\"))\r\n\r\n\t// If lHabCalc\r\n\t\tcHtml := strTran(cHtml, \"{{total_net_weight}}\", transform(nTtPesoLiq, \"@E 9,999,999.999\"))\r\n\t\tcHtml := strTran(cHtml, \"{{total_gross_weight}}\", transform(nTtPesoBru, \"@E 9,999,999.999\"))\r\n\t// EndIf\r\n\r\n\tcHtml := strTran(cHtml, \"{{measures_m2}}\", transform(nTotalQtd, \"@E 9,999,999.999\"))\r\n\tcHtml := strTran(cHtml, \"{{measures_ft2}}\", transform(nTotalQtd * 10.764, \"@E 9,999,999.999\"))\r\n\tcHtml := strTran(cHtml, \"{{total_chapa}}\", transform(nTotalChapa, \"@E 9,999,999\"))\r\n\tcHtml := strTran(cHtml, \"{{observacao}}\", cObs)\r\n\r\n\toUtil:destroy()\r\n\r\n\tcHtml := FwCutOff(cHtml) // FwCutOff(<cString >, <lNoAccent >)-> NIL\r\n\r\n\tIf lWeb\r\n\t\tReturn( { cFileName + EXTPDF, cError, cHtml } )\r\n\tElse\r\n\r\n\t\tcJavaScript += \"<meta http-equiv='Content-Type' content='application/pdf; charset=utf-8'>\r\n\t\tcJavaScript += \"<script src='https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js'></script>\r\n\t\tcJavaScript += \"<script type='text/javascript'>\r\n\t\tcJavaScript += \"\tfunction openpdf(){\t\t\r\n\t\tcJavaScript += \"\t\t$.ajax({\r\n\t\tcJavaScript += \"\t\t\tmethod: 'post',\r\n\t\tcJavaScript += \"\t\t\turl: 'http://interno.grplus.com.br/rest/servico/ReportServico.php',\r\n\t\tcJavaScript += '\t\t\tdata: \"' + cHtml + '\",'\r\n\t\tcJavaScript += \"\t\t\txhrFields: {\r\n\t\tcJavaScript += \"\t\t\t\tresponseType: 'blob'\r\n\t\tcJavaScript += \"\t\t\t},\r\n\t\tcJavaScript += \"\t\t\tsuccess: function (data) {\r\n\t\tcJavaScript += \"\t\t\t\tvar a = document.createElement('a');\r\n\t\tcJavaScript += \"\t\t\t\tvar url = window.URL.createObjectURL(data);\r\n\t\tcJavaScript += \"\t\t\t\ta.href = url;\r\n\t\tcJavaScript += \"\t\t\t\ta.download = 'relatorio.pdf';\r\n\t\tcJavaScript += \"\t\t\t\tdocument.body.append(a);\r\n\t\tcJavaScript += \"\t\t\t\tlocation.href = url;\r\n\t\tcJavaScript += \"\t\t\t}\t\t\t\t\r\n\t\tcJavaScript += \"\t\t});\r\n\t\tcJavaScript += \"\t}\r\n\t\tcJavaScript += \"</script>\r\n\t\tcJavaScript += \"</head>\r\n\t\tcJavaScript += \"<body onload='openpdf()'>\r\n\t\tcJavaScript += EncodeUTF8('<div align=\"center\"><img src=\"http://interno.grplus.com.br/data/img/load.gif\"><h2 style=\"font-family: Verdana; color: orange\">Favor aguardar enquanto o relatório é gerado...</h2></div>')\r\n\t\tcJavaScript += \"</body>\r\n\r\n\t\t// Grava arquivo alterado\r\n\t\tcArquivoNovo := cPath + cRelatorio\r\n\t\tnHandle := FCreate(cArquivoNovo)\t\t\r\n\t\tFWrite(nHandle, cJavaScript)\t\t\r\n\t\tFClose(nHandle)\r\n\r\n\t\tShellExecute(\"Open\", cArquivoNovo, \" /k dir\", \"C:\\temp\\\", 1 )\r\n\tEndIf\r\n\r\nReturn Nil\r\n"}}}
Content-Length: 165
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/08_GRPLUS/GROR002.PRW"}}}
Content-Length: 9267
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/08_GRPLUS/GROR015.PRW","languageId":"advpl","version":1,"text":"#INCLUDE \"PROTHEUS.CH\"\n#INCLUDE \"TOPCONN.CH\"\n#INCLUDE \"TBICONN.CH\"\n#INCLUDE \"RPTDEF.CH\"\n#INCLUDE \"FWPrintSetup.ch\"\n\n//-------------------------------------------------------------------\n/*/ { Protheus.doc } GROR015\nImpressão de Etiqueta\n\n@author Kenny Roger Martins\n@since 11/04/2017\n@version 1.0\n/*/\n//-------------------------------------------------------------------\n\nUser Function GROR015()\n**********************************************************************\n*\n*\n****\t\nLocal cSql      := \"\"\nLocal qQuery    := \"\"\t\nLocal cPergunte := Padr(\"GROR015\",10)\t\n\n\t//U_TOTVSES()\n\t\n\tAtuSx1(cPergunte)\n\n\tIf Pergunte(cPergunte, .T.)\n\t\n\t\tcSql := \"     SELECT * ,(SELECT TOP 1 D1_DOC \" + CHR(10)\n\t\tcSql += \" \t\t\t\t FROM SD1010 \" + CHR(10)\n\t\tcSql += \" \t\t\t\t \t\t\tWHERE D_E_L_E_T_ = ''\" + CHR(10) \n\t\tcSql += \" \t\t\t\t \t\t\t  AND D1_SERIE = '2' \" + CHR(10)\n\t\tcSql += \" \t\t\t\t \t\t\t  AND D1_UM = 'M2'\" + CHR(10)\n\t\tcSql += \" \t\t\t\t \t\t\t  AND D1_LOTECTL = SB8.B8_LOTECTL \" + CHR(10)\n\t\tcSql += \" \t\t\t\t \t\t\t  AND D1_NUMLOTE = SB8.B8_NUMLOTE \" + CHR(10)\n\t\tcSql += \" \t\t\t\t ) NFT, \" + CHR(10)\n\t\t\n\t\n\t\tcSql += \" \t\t\t\t (SELECT TOP 1 D1_LOTEFOR \" + CHR(10)\n \t\tcSql += \" \t\t\t\t \t\t\t\tFROM SD1010 \" + CHR(10)\n\t\tcSql += \" \t\t\t\t \t\t\t\tWHERE D_E_L_E_T_ = '' \" + CHR(10)\n\t\tcSql += \" \t\t\t\t \t\t\t\t\tAND LEFT(D1_COD,2) = 'BL' \" + CHR(10)\n \t\tcSql += \" \t\t\t\t \t\t\t\t\tAND dbo.F_LOTECTL(D1_LOTECTL) = dbo.F_LOTECTL(SB8.B8_LOTECTL) \" + CHR(10)\n\t\tcSql += \" \t\t\t\t \t\t\t\t\tAND D1_LOTEFOR <> '' \" + CHR(10)\n \t\tcSql += \" \t\t\t\t \t\t ) BLOCO_PEDREIRA \" + CHR(10)\n\t\t\n\t\t\n\t\t\n\t\tcSql += \"       FROM \" + RETSQLNAME(\"SB8\") + \" SB8 \" + CHR(10)\n\t\tcSql += \" INNER JOIN \" + RETSQLNAME(\"SB1\") + \" SB1 \" + CHR(10)\n\t\tcSql += \"         ON SB1.B1_FILIAL  = '\" + xFilial(\"SB1\") + \"' \" + CHR(10)\t\n\t\tcSql += \"        AND SB1.B1_COD     = SB8.B8_PRODUTO \" + CHR(10)\t\n\t\tcSql += \"        AND SB1.D_E_L_E_T_ = '' \" + CHR(10) \n\t\tcSql += \" INNER JOIN \" + RETSQLNAME(\"SBM\") + \" SBM \" + CHR(10)\n\t\tcSql += \"         ON SBM.BM_FILIAL  = '\" + xFilial(\"SBM\") + \"' \" + CHR(10)\t\n\t\tcSql += \"        AND SBM.BM_GRUPO   = SB1.B1_GRUPO \" + CHR(10)\t\n\t\tcSql += \"        AND SBM.BM_YTIPO   IN ('C','L') \" + CHR(10)\t\t\t\n\t\tcSql += \"        AND SBM.D_E_L_E_T_ = '' \" + CHR(10) \n\t\tcSql += \" INNER JOIN \" + RETSQLNAME(\"SB5\") + \" SB5 \" + CHR(10)\n\t\tcSql += \"         ON SB5.B5_FILIAL  = '\" + xFilial(\"SB5\") + \"' \" + CHR(10)\t\n\t\tcSql += \"        AND SB5.B5_COD     = SB8.B8_PRODUTO \" + CHR(10)\t\t\n\t\tcSql += \"        AND SB5.D_E_L_E_T_ = '' \" + CHR(10) \n\t\tcSql += \"      WHERE SB8.B8_FILIAL  = '\" + xFilial(\"SB8\") + \"' \" + CHR(10)\n\t\tcSql += \"        AND SB8.B8_PRODUTO BETWEEN '\" + MV_PAR01 + \"' AND '\" + MV_PAR02 + \"' \" + CHR(10) \n\t\tcSql += \"        AND SB8.B8_LOTECTL BETWEEN '\" + MV_PAR03 + \"' AND '\" + MV_PAR04 + \"' \" + CHR(10) \n\t\tcSql += \"        AND SB8.B8_NUMLOTE BETWEEN '\" + MV_PAR05 + \"' AND '\" + MV_PAR06 + \"' \" + CHR(10) \n\n\t\t\n\t\t//cSql += \"        AND SB8.B8_SALDO   > 0 \" + CHR(10) \n\t\n\n\t\tcSql += \"        AND SB8.D_E_L_E_T_ = '' \" + CHR(10) \n\t\t\n\t\tTCQUERY cSQL NEW ALIAS qQUERY\n\t\n\t\tMsAguarde({|| setEtiqueta(qQUERY) },\"Impressão de etiqueta...\",\"Aguarde...\")\n\t\n\t\tqQUERY->(DbCloseArea())\t\n\t\t\n\tEndIf\n\t\t\t\nReturn Nil\n\n\nStatic Function setEtiqueta(qQUERY)\n**********************************************************************\n*\n*\n****\nLocal cCodBar   := \"\"\nLocal cLote     := \"\"\nLocal cDescpro  := \"\"\nLocal cMedida   := \"\"\n\nLocal nQuant\t:= 1\nLocal cImpress  := \"\" //\"PDFCreator\"\nLocal cModBarr  := AllTrim(GetNewPar(\"GR_MODBARR\", \"CODE128\"))                                   \nLocal cLogo \t:= \"lgrl99.bmp\"\nLocal cCima     := \"cima.bmp\"\nLocal cBaixo    := \"baixo.bmp\"\nLocal oFont06\t:= TFont():New('Consolas',,06,,.F.,,,,.T.,.F.,.F.)\nLocal oFont06N\t:= TFont():New('Consolas',,06,,.T.,,,,.T.,.F.,.F.)\nLocal oFont08\t:= TFont():New('Consolas',,08,,.F.,,,,.T.,.F.,.F.)\nLocal oFont08N\t:= TFont():New('Consolas',,08,,.T.,,,,.T.,.F.,.F.)\nLocal oFont10\t:= TFont():New('Consolas',,10,,.F.,,,,.T.,.F.,.F.)\nLocal oFont10N\t:= TFont():New('Consolas',,10,,.T.,,,,.T.,.F.,.F.)\nLocal oFont12\t:= TFont():New('Consolas',,12,,.F.,,,,.T.,.F.,.F.)\nLocal oFont12N\t:= TFont():New('Consolas',,12,,.T.,,,,.T.,.F.,.F.)\nLocal oFont14N\t:= TFont():New('Consolas',,14,,.T.,,,,.T.,.F.,.F.)\nLocal cCodAuto  := GetNewPar(\"GR_CODAUTO\", \"\")\t\nLocal nDirecao  := 1\n\nLocal lAdjustToLegacy := .F.\nLocal lDisableSetup   := .F.\n\n\tMsProcTxt(\"Iniciando impressão...\")\n\n\tPrivate oPrinter := FWMSPrinter():New(\"produto\"+Alltrim(__cUserID)+\".etq\", IMP_SPOOL, lAdjustToLegacy, \"/spool/\", lDisableSetup,,, Alltrim(cImpress))\n\n\toPrinter:SetMargin(001,001,001,001)\n\n\t// Direção da seta.\n\n\tIf MV_PAR07 == 1\n\t\tnDirecao := 2\n\tElse\n\t\tnDirecao := MV_PAR07\n\tEndIf\n\t\t\n\tWhile qQUERY->(!(EOF()))\n\t\n\t\tIf Empty(cCodAuto)\n\t\n\t\t\tcCodBar  := U_GETCODBAR(qQUERY->B5_YTIPMAT, qQUERY->B8_LOTECTL, qQUERY->B8_NUMLOTE)\n\t\t\t\n\t\t\tIf Left(cCodBar,1)==\"W\" \n\t\t\t\tcCodBar := \"D\"+cCodBar \n\t\t\tEndIF\n\n\t\tElse\n\n\t\t\tIf Empty(qQUERY->(B8_YCODBAR))\n\t\t\t\n\t\t\t\tcCodBar  := &(cCodAuto)\n\n\t\t\t\tSB8->(DbGoTo(qQUERY->(R_E_C_N_O_)))\n\t\t\t\t\n\t\t\t\tRecLock(\"SB8\", .F.)\n\t\t\t\tSB8->B8_YCODBAR := cCodBar\n\t\t\t\tSB8->(MsUnLock())\n\n\t\t\t\tConfirmSX8()\n\n\t\t\tElse\n\n\t\t\t\tcCodBar := qQUERY->(B8_YCODBAR)\n\n\t\t\tEndIf\n\n\t\tEndIf\n\t\t\n\t\tcLote    := AllTrim(qQUERY->B8_LOTECTL) + \"/\" + AllTrim(qQUERY->B8_NUMLOTE) \n\t\tcMedida  := AllTrim(Transform(qQUERY->B8_YCOMLIQ, \"@E 999.99\")) + \" x \" + AllTrim(Transform(qQUERY->B8_YALTLIQ, \"@E 999.99\")) + \" = \" + AllTrim(Transform(qQUERY->B8_YCOMLIQ * qQUERY->B8_YALTLIQ, \"@E 999.99\"))\t\t\n\n\t\tMsProcTxt(\"Imprimindo etiqueta \" + cCodBar + \"...\")\n\n\t\toPrinter:StartPage()\n\n\t\toPrinter:Code128B(022, 030, cCodBar, 022)\n\n\t\toPrinter:Say(030, 040, cCodBar, oFont08N)\n\n\t\toPrinter:Say(012, 152, cLote, oFont14N)\n\n\t\toPrinter:Say(022, 152, \"NFT  | BLOCO\", oFont10N)\n\n\t\toPrinter:Say(030, 152, CVALTOCHAR(VAL(qQUERY->NFT)) + \"-\" + StrZero(Val(qQUERY->B8_NUMLOTE), 3) + \" | \" + AllTrim(qQUERY->BLOCO_PEDREIRA)  , oFont10N)\n\t\t\n\t\tIf Mod(nDirecao,2) == 0\n\t\t\toPrinter:SayBitmap(008, 284, cCima , 08, 22)\n\t\tElse\n\t\t\toPrinter:SayBitmap(008, 284, cBaixo, 08, 22)\n\t\tEndIf\t\t\n\n\t\tnDirecao += 1\n\n\t\toPrinter:EndPage()\n\t\t\t\t\t\n\t\tqQUERY->(DbSkip())\n\t\t\n\tEndDo\n\t\t\n\toPrinter:Preview()\n\t//oPrinter:Print()\n\nReturn Nil\n\n/*---------+----------+-------+-----------------------+------+------------+\n|Função    |AtuSx1    | Autor |KENNY ROGER MARTINS    | Data | 27.04.2017 |\n+----------+----------+-------+-----------------------+------+------------+\n|Descrição |Cria perguntas                                                |\n+----------+--------------------------------------------------------------+\n|Uso       |Gestão de Rochas Ornamentais                                  |\n+----------+-------------------------------------------------------------*/\nStatic Function AtuSx1(cPerg)\n\n\tLocal aDados := {}\n\t\n\taAdd( aDados, {cPerg,'01','Material De ?',        '','','MV_CH0','C',15,0,0,'G','','MV_PAR01','','','','','','','','','','','','','','','','','','','','','','','','','SB1','','','','',''} )\n\taAdd( aDados, {cPerg,'02','Material Até ?',       '','','MV_CH0','C',15,0,0,'G','','MV_PAR02','','','','ZZZZZZZZZZZZZZZ','','','','','','','','','','','','','','','','','','','','','SB1','','','','',''} )\n\taAdd( aDados, {cPerg,'03','Lote De ?',            '','','MV_CH0','C',10,0,0,'G','','MV_PAR03','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''} )\n\taAdd( aDados, {cPerg,'04','Lote Ate ?',           '','','MV_CH0','C',10,0,0,'G','','MV_PAR04','','','','ZZZZZZZZZZ','','','','','','','','','','','','','','','','','','','','','','','','','',''} )\n\taAdd( aDados, {cPerg,'05','SubLote De ?',         '','','MV_CH0','C',06,0,0,'G','','MV_PAR05','','','','','','','','','','','','','','','','','','','','','','','','','','','','','',''} )\n\taAdd( aDados, {cPerg,'06','SubLote Ate ?',        '','','MV_CH0','C',06,0,0,'G','','MV_PAR06','','','','ZZZZZZ','','','','','','','','','','','','','','','','','','','','','','','','','',''} )\n\taAdd( aDados, {cPerg,'07','Direção da Seta ?',    '','','MV_CH0','C',01,0,0,'C','','MV_PAR07','Automático','','','','','Para Cima','','','','','Para Baixo','','','','','','','','','','','','','','','','','','',''} )\t\n\t//aAdd( aDados, {cPerg,'07','Somente com Saldo',    '','','MV_CH0','N',01,0,0,'C','','MV_PAR08','Sim','','','','','Não','','','','','','','','','','','','','','','','','','','','','','','',''} )\n\n\tU_AtuSx1(aDados)\t\n\nReturn Nil\n"}}}
Content-Length: 165
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/08_GRPLUS/GROR015.PRW"}}}
Content-Length: 53662
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/10_LIB/LIBWHATSAPP.PRW","languageId":"advpl","version":1,"text":"#include \"protheus.ch\"\r\n#include \"rwmake.ch\"\r\n#include \"tbiconn.ch\"  \r\n#INCLUDE \"TOTVS.CH\"\r\n#INCLUDE \"topconn.ch\"\r\n\r\n/*\r\nPrograma ...: LIBWHATSAPP.Prw\r\nUso ........: Programa verifica a provação do pedido automaticamente pelo WhatsApp\r\nData .......: 23/03/2020\r\nFeito por ..: Bruno Lage Ferreira\r\nCopyright @1998-2001,2021\r\n\r\nQ-Liberação Faturamento\r\n5527995295180-1587589430@g.us\r\nlogistica.es@qualitagroup.com;comercial.es@grupoqualita.com.br\r\n\r\nQ-N2 - Liberação Compras\r\n5527995295180-1594316108@g.us\r\npedido.compra@grupoqualita.com.br\r\n\r\nQ-N1 - Liberação Compras\r\n5527995295180-1587589523@g.us\r\npedido.compra@grupoqualita.com.br\r\n*/ \r\n\r\nUser Function LIBWHATSAPP()  \r\n************************************************************************************************************\r\n*\r\n*\r\n*\r\n***\r\nLocal cQuery   := \"\"\r\nLocal lAutoZAP := .F.\r\n\r\nLocal aLogAuto := {}\r\n\r\nLocal oJson\r\nLocal cErr     := \"\"\r\n/*\r\nLocal lMsg     := \"\"\r\n*/\r\nLocal cMessage := \"\"\r\nLocal lEnvProt := .F.\r\nLocal nAux\r\n\r\nConOut( \">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>   WHATSAPP APROVAÇÃO   <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\" )\r\n\r\nIf Select(\"SX2\")==0  \r\n\tPREPARE ENVIRONMENT EMPRESA \"01\" FILIAL \"01\" TABLES \"WAM\",\"SC5\"\r\n\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" Iniciando JOB de liberação de Retorno pelo WHATSAPP.\")\r\n\tlAutoZAP := .T.\r\nEndIf\r\n\r\n\r\n/*\r\n******************************************************************************************\r\nchamada do Modulo AutoStart\r\nTODOS OS COMANDOS VIA PROCEDUTE\r\n*/\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************         INICIANDO AUTOSTART          **********************\")\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************************************************************************\")\r\n\r\nTCSPEXEC(\"WHATSAPP_AUTOSTART\")\r\n   \r\n/*\r\n*\r\n******************************************************************************************\r\n*/\r\ncQuery :=  \" SELECT  \r\ncQuery +=  \" \t\tWAM_FILIAL,\r\ncQuery +=  \" \t\tWAM_DATA,\r\ncQuery +=  \" \t\tWAM_HORA,\r\ncQuery +=  \" \t\tWAM_ID,\r\ncQuery +=  \" \t\tRTRIM(LTRIM(ISNULL(CONVERT(VARCHAR(2047), CONVERT(VARBINARY(2047), WAM_MSG)),''))) WAM_MSG,\r\ncQuery +=  \" \t\tWAM_TELL,\r\ncQuery +=  \" \t\tWAM_INDEX,\r\ncQuery +=  \" \t\tWAM_PERG,\r\ncQuery +=  \" \t\tWAM_DATAR,\r\ncQuery +=  \" \t\tWAM_HORAR,\r\ncQuery +=  \" \t\tWAM_RESPOS,\r\ncQuery +=  \" \t\tWAM_EXEC,\r\ncQuery +=  \" \t\tWAM_NIVEL\r\ncQuery +=  \" \t\tFROM WAM010 WHERE D_E_L_E_T_ = '' AND CAST(WAM_DATA AS DATE) > CAST(GETDATE()-4 AS DATE) AND WAM_PERG = 'S' AND WAM_EXEC LIKE '%QUALITA%'\r\n\r\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBRA\", .F., .T.)\r\ndbSelectArea(\"TRBRA\")\r\ndbgotop()\r\nDo While !EOF()\r\n\r\n\tIf !Empty(TRBRA->WAM_ID)\t\r\n\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\"Protocolo: [\"+ AllTrim(TRBRA->WAM_ID) + \"] INDEX:\" + TRBRA->WAM_INDEX )\r\n\t\t\r\n\t\t// Cria o objeto JSON e popula ele a partir da string\r\n\t\t\r\n\t\toJson := JSonObject():New()\r\n\t\tcErr  := oJSon:fromJson(U_SWREMGWAP(AllTrim(TRBRA->WAM_ID)))\r\n\t\t\r\n\t\tsleep(400)\r\n\t\t\r\n\t\tConOut(oJson:GetJSonObject('quote_message'))\r\n\t\t\r\n\t\tIf !Empty(cErr)\r\n\t\t  \tConout(cErr + \"Protocolo:\" + AllTrim(TRBRA->WAM_ID))\r\n\t\t  \t\r\n\t\t  \t// Descarta o objeto \r\n\t\t  \tFreeObj(oJson)\r\n\t\t  \r\n\t\t  \tdbSelectArea(\"TRBRA\")\r\n\t\t  \tdbSkip()\r\n\t\tEndif\r\n\t\t\r\n\t\t// Agora vamos ler as propriedades com GetJSonObject()\r\n\t\t aRetMsg :=\tstrTokArr(U_SWREMGWAP(TRBRA->WAM_ID), ',' )\r\n\tEndIf\r\n\t\r\n\t\r\n\t/*\r\n\t**********************************************************************************************************************\r\n\tTratamento das liberação \r\n\t - Mapa de Cotação\r\n\t - Pedido de Compra\r\n\t - Pedido de Vendas\r\n\t**********************************************************************************************************************\r\n\t*/\r\n\tIF AllTrim(TRBRA->WAM_EXEC) == \"QUALITA-MC\"\r\n\t\t\r\n\t\t/*\r\n\t\t***************************************************\r\n\t\tNIVEL 1\r\n\t\t***************************************************\r\n\t\t*/\r\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"1\"\r\n\t\t\t\r\n\t\t\t/*\r\n\t\t\tProcessamento dos retorno Mapa de cotação-MC\r\n\t\t\t*/\r\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\t\r\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\t\r\n\t\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\t\tlEnvProt := .T.\r\n\t\t\t\t\r\n\t\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\t\tdbSelectArea(\"SC8\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0025_V&cCotacao=' + SC8->C8_NUM +'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConOut(\"Gerando relatório! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcProt := U_SWENARWAP(\"5527995295180-1594316108@g.us\", \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"                                                                     ,\"MC\"+ SC8->C8_NUM             ,\"MC-\" + SC7->C7_NUM  ,\"PDF\",\"\\RELINWEB\\MC-\"+ SC8->C8_NUM +\".PDF\")\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t30 segundos\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIF cProt = \"\" .or. cProt = nil \r\n\t\t\t\t\t\t\tConOut(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde! MC-\"+ SC8->C8_NUM +\".PDF\")\r\n\t\t\t\t\t\t\tReturn()\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf  RecLock(\"WAM\",.T.) \r\n\t\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \r\n\t\t\t\t\t\t\tReplace WAM_DATA    With Date()\r\n\t\t\t\t\t\t\tReplace WAM_HORA    With Time()\r\n\t\t\t\t\t\t\tReplace WAM_ID      With cProt\r\n\t\t\t\t\t\t\tReplace WAM_MSG     With \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"\r\n\t\t\t\t\t\t\tReplace WAM_INDEX   With SC8->C8_FILIAL + SC8->C8_NUM\r\n\t\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\r\n\t\t\t\t\t\t\tReplace WAM_NIVEL   With \"2\"\r\n\t\t\t\t\t\t\tIF SubString(CNUMEMP,1,2) == \"05\"\r\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'ITINGA-MC'\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'QUALITA-MC'\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t   MsUnLock()\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como já lido. \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como já lido\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tColoca a MSg mais não mostra data nem hora de liberação\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C8_MSGLIB='\"+ \"NÃO LIBERADO: \" + Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"   FROM \" + RetSqlName(\"SC8\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'COTAÇÃO NÃO LIBERADA!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado (Mapa de Cotação NÃO liberado):\" + TRBRA->WAM_INDEX )\t\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\r\n\t\tEndIf\r\n\t\t\r\n\t\t/*\r\n\t\t***************************************************\r\n\t\tNIVEL 2\r\n\t\t***************************************************\r\n\t\t*/\r\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"2\"\r\n\t\t\t\r\n\t\t\t/*\r\n\t\t\tProcessamento dos retorno Mapa de cotação-MC\r\n\t\t\t*/\r\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\t\r\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\t\r\n\t\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\t\tlEnvProt := .T.\r\n\t\t\t\t\r\n\t\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\t\tdbSelectArea(\"SC8\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGravando aprovação na SC8\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C8_DATALIB='\"+ DToS(dDataBase) +\"',C8_HORALIB='\"+ LEFT(AllTrim(TIME()),5) +\"',C8_MSGLIB='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC8\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0025_V&cCotacao=' + SC8->C8_NUM +'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConOut(\"Gerando relatório! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação Liberado!     Código:' + SC8->C8_NUM       ,'COTAÇÃO LIBERADA! Código:'              + SC8->C8_NUM + ', liberado!'+ \"<br>\" +'CÓDIGO:' + SC8->C8_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda:\" + AllTrim(SC8->C8_NUM) )\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tColoca a MSg mais não mostra data nem hora de liberação\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C8_MSGLIB='\"+ \"NÃO LIBERADO: \" + Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"   FROM \" + RetSqlName(\"SC8\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'COTAÇÃO NÃO LIBERADA!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado (Mapa de Cotação NÃO liberado):\" + TRBRA->WAM_INDEX )\t\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\r\n\t\tEndIf\r\n\r\n\tElseIf AllTrim(TRBRA->WAM_EXEC) == \"QUALITA-PC\"\r\n\t\r\n\t\t/*\r\n\t\t***************************************************\r\n\t\tNIVEL 1\r\n\t\t***************************************************\r\n\t\t*/\r\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"1\"\r\n\t\r\n\t\t\t/*\r\n\t\t\tProcessamento dos retorno Pedido de Compra-PC\r\n\t\t\t*/\r\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\t\r\n\t\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\t\tlEnvProt := .T.\r\n\t\t\t\t\r\n\t\t\t\tIf \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\t\tdbSelectArea(\"SC7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGera dados do pedido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tu_ImpPc(2)\r\n\t\t\t\t\t\tWaitRunSrv('\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcProt := U_SWENARWAP(\"5527995295180-1594316108@g.us\", \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"                                                                     ,\"PC-2-\" + SC7->C7_NUM         ,\"PC-2-\" + SC7->C7_NUM   ,\"PDF\",\"\\RELINWEB\\PC-\" + SC7->C7_NUM + \".PDF\")\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t30 segundos\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\t        \t\t\t\t\t\t                  \r\n\t\t\t\t\t\tIF cProt = \"\" .or. cProt = nil \r\n\t\t\t\t\t\t\tConOut(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde! PC-\"+SC7->C7_NUM+\".PDF\")\r\n\t\t\t\t\t\t\tReturn()\r\n\t\t\t\t\t\tEndIf                 \r\n\t\t\t\t\t\t                      \r\n\t\t\t\t\t\tIf  RecLock(\"WAM\",.T.) \r\n\t\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \r\n\t\t\t\t\t\t\tReplace WAM_DATA    With Date()\r\n\t\t\t\t\t\t\tReplace WAM_HORA    With Time()\r\n\t\t\t\t\t\t\tReplace WAM_ID      With cProt\r\n\t\t\t\t\t\t\tReplace WAM_MSG     With \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\" \r\n\t\t\t\t\t\t\tReplace WAM_INDEX   With SC7->C7_FILIAL + SC7->C7_NUM\r\n\t\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\r\n\t\t\t\t\t\t\tReplace WAM_NIVEL   With \"2\"\r\n\t\t\t\t\t\t\tIF SubString(CNUMEMP,1,2) == \"05\"\r\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'ITINGA-PC'\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'QUALITA-PC'\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t   MsUnLock()\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\tdbSelectArea(\"SC7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGravando aprovação na SC7\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\r\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGera dados do pedido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t//u_ImpPc(2)\r\n\t\t\t\t\t\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"almoxarifado@grupoqualita.com.br;emelly.couto@grupoqualita.com.br;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + SC7->C7_NUM + ', não liberado!'+ \"<br>\" +'CÓDIGO:' + SC7->C7_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RXX0022.PDF')\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Não Liberado! Código:' + SC7->C7_NUM , 'Pedido Não Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t\tEndIf\t\r\n\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tEndIf\r\n\t\r\n\t\r\n\t\t/*\r\n\t\t***************************************************\r\n\t\tNIVEL 2\r\n\t\t***************************************************\r\n\t\t*/\r\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"2\"\r\n\t\r\n\t\t\t/*\r\n\t\t\tProcessamento dos retorno Pedido de Compra-PC\r\n\t\t\t*/\r\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\t\r\n\t\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\t\tlEnvProt := .T.\r\n\t\t\t\t\r\n\t\t\t\tIf \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\t\tdbSelectArea(\"SC7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGravando aprovação na SC7\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C7_DATALIB='\"+ DToS(dDataBase) +\"',C7_HORALIB='\"+ LEFT(AllTrim(TIME()),5) +\"',C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGera dados do pedido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tu_ImpPc(2)\r\n\t\t\t\t\t\tWaitRunSrv('\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Liberado! Código:' + SC7->C7_NUM , 'Pedido Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF')\r\n\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\tdbSelectArea(\"SC7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGravando aprovação na SC7\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\r\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGera dados do pedido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t//u_ImpPc(2)\r\n\t\t\t\t\t\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"almoxarifado@grupoqualita.com.br;emelly.couto@grupoqualita.com.br;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + SC7->C7_NUM + ', não liberado!'+ \"<br>\" +'CÓDIGO:' + SC7->C7_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RXX0022.PDF')\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Não Liberado! Código:' + SC7->C7_NUM , 'Pedido Não Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t\tEndIf\t\r\n\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tEndIf\r\n\t\r\n\t\r\n\tElse\r\n\t\t/*\r\n\t\tProcessamento dos retornos Pedido de Venda PV \r\n\t\t*/\r\n\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\r\n\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\r\n\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\tlEnvProt := .T.\r\n\t\t\t\r\n\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\tdbSelectArea(\"SC5\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\tRecLock(\"SC5\",.F.)\r\n\t\t\t\t\t\tSC5->C5_BLQ  := ''\r\n\t\t\t\t\tMsUnlock()\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\r\n\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\r\n\t\t\t\t\tIf SC5->C5_YTIPO == \"ME\"\r\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tConOut(\"Gerando relatório! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\r\n\t\t\t\t\tsleep(300)\r\n\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\r\n\t\t\t\t\t\r\n\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"logistica.es@qualitagroup.com;bruno.lage@grupoqualita.com.br\",'Pedido Liberado! Código:' + SC5->C5_NUM ,'PEDIDO LIBERADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\r\n\t\t\t\t\t\r\n\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda:\" + TRBRA->WAM_INDEX )\t\r\n\t\t\t\tEndIf\r\n\t\t\tElse\r\n\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\r\n\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"logistica.es@qualitagroup.com;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'PEDIDO NÃO LIBERADO!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\r\n\t\t\t\t\t\r\n\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda (NÃO liberado):\" + TRBRA->WAM_INDEX )\t\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\r\n\t\r\n\t// Descarta o objeto \r\n\tFreeObj(oJson)\r\n\r\n\tdbSelectArea(\"TRBRA\")\r\n\tdbSkip()\r\nEndDo\r\n\r\ndbSelectArea(\"TRBRA\") \r\ndbCloseArea()\r\n\r\n\r\n/*\r\n******************************************************************************************\r\nchamada do Modulo AutoStart\r\nTODOS OS COMANDOS VIA PROCEDUTE\r\n*/\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************         INICIANDO AUTOSTART          **********************\")\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************************************************************************\")\r\n\r\nTCSPEXEC(\"WHATSAPP_AUTOSTART\")\r\n   \r\n\r\n/*\r\n******************************************************************************************\r\nResposta do Modulo MNT\r\nABERTURA E DISTRIBUIÇÃO\r\n*/\r\ncQuery   := \" SELECT  ISNULL((SELECT USR_ID     FROM DADOSADV_Q..SYS_USR WHERE USR_MSBLQL <> 1 AND USR_CARGO = WAM_TELL),'') ID_USUARIO,\r\ncQuery   += \" \t  \t  ISNULL((SELECT USR_CODIGO FROM DADOSADV_Q..SYS_USR WHERE USR_MSBLQL <> 1 AND USR_CARGO = WAM_TELL),'') USUARIO,\r\ncQuery   += \" \t  \t  R_E_C_N_O_ RECNO,\r\ncQuery   += \" \t\t  UPPER(RTRIM(LTRIM(SUBSTRING(RETORNO,IIF(CHARINDEX(',',UPPER(RETORNO))=0,0,CHARINDEX(',',UPPER(RETORNO))+1),LEN(RETORNO)  ))) ) \t  MSG,*\r\ncQuery   += \"   FROM DADOSADV_Q..WAM010\r\ncQuery   += \"\tCROSS APPLY\r\ncQuery   += \"\t(\r\ncQuery   += \"\tSELECT RETORNO = dbo.FnWhatRetMSG(WAM_ID)\r\ncQuery   += \"\t) x\r\ncQuery   += \"  WHERE D_E_L_E_T_ = ''\r\ncQuery   += \"    AND WAM_EXEC = 'MNT'\r\ncQuery   += \"    AND WAM_PERG = 'N'\r\ncQuery   += \"    AND WAM_NIVEL = 0\r\n//cQuery   += \"  --AND dbo.FnWhatRetMSG(WAM_ID) <> ''\r\n\r\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBMNT\", .F., .T.)\r\ndbSelectArea(\"TRBMNT\")\r\ndbgotop()\r\nDo While !EOF()\r\n\r\n\t\t\t\r\n\t\t\tPrivate\taSolic          :={}\t\r\n\t\t\tPrivate lMSHelpAuto     := .T. // Nao apresenta erro em tela\r\n\t\t\tPrivate lMSErroAuto     := .F. //   Caso a variavel torne-se .T. apos MsExecAuto, apresenta erro em tela\r\n\t\t\tPrivate lAutoErrNoFile\t:= .T.\r\n\t\t\tPrivate cErroTemp       := \"\"\r\n\t\t\tPrivate cArquivo        := \"\"\r\n\t\t\tPrivate cProt           := \"\"\r\n\t\r\n\t\t\taSolic := {\t{\"TQB_CODBEM\" , TRBMNT->WAM_RESPOS    \t,Nil},;             \t// Codigo do Bem a  ser  relacionado na Solicitacao de Servico\r\n\t\t\t\t\t\t{\"TQB_DTABER\" , dDataBase     \t\t\t,Nil},; \t\t\r\n\t\t\t\t\t\t{\"TQB_HOABER\" , LEFT(TIME(), 5 )        ,Nil},; \t\r\n\t\t\t\t\t\t{\"TQB_USUARI\" , TRBMNT->USUARIO   \t\t,Nil},; \t\t\r\n\t\t\t\t\t\t{\"TQB_CDSOLI\" , TRBMNT->ID_USUARIO\t\t,Nil},; \t\t\r\n\t\t\t\t\t\t{\"TQB_DESCSS\" , TRBMNT->MSG \t\t\t,Nil}} \t\t\t\t\t//  Descricao da  Solicitacao\r\n\r\n\t\t\tMSExecAuto( {|x,z,y,w| MNTA280(x,z,y,w)}, , , aSolic )\t\t\r\n\r\n\t\t\tIf lMsErroAuto\r\n\t\t\t\t//U_SWENV(\"5533984022125\" , Mostraerro()  , \"ERRO MNT\" )\r\n\t\t\t\tConOut(\"************* ERRO MNT INICIO *************\")\r\n\t\t\t\t//U_SWENV(TRBMNT->WAM_TELL, \"Erro no cadastro da S. Serviço!\"  , \"ERRO MNT\" )\r\n\r\n\t\t\t\t//Pegando log do ExecAuto\r\n\t\t\t\taLogAuto := GetAutoGRLog()\r\n\r\n\t\t\t\t/*\r\n\t\t\t\t//Percorrendo o Log e incrementando o texto (para usar o CRLF você deve usar a include \"Protheus.ch\")\r\n\t\t\t\t//nAux \t\t:= 0\r\n\t\t\t\t//aLogAuto    :={}\r\n\t\t\t\t*/\t\r\n\t\t\t\tFor nAux := 1 To Len(aLogAuto) \r\n\t\t\t\t\tcErroTemp += aLogAuto[nAux] + CHR(13)+CHR(10)\r\n\t\t\t\tNext nAux\r\n\r\n\t\t\t\tIf cErroTemp == \"\"\r\n\t\t\t\t\tcErroTemp := \"Sem informações de erro.\"\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tcArquivo := \"\\_LOGWHATSMNT\\\" + \"MNT_ERRO\" + dToS(dDataBase) +'_'+ Replace(time(),':','_') + \".txt\"\r\n\t\t\t\t\r\n\t\t\t\tConOut(cArquivo)\r\n\t\t\t\tConOut(cErroTemp)\r\n\r\n\t\t\t\tSleep(3000)\r\n\r\n\t\t\t\t//Criando o arquivo txt\r\n\t\t\t\tMemoWrite(cArquivo, cErroTemp )\r\n\r\n\t\t\t\t//cErroTemp := Mostraerro(\"\\_LOGWHATSMNT\\\", cArquivo)\r\n\t\t\t\t\r\n\t\t\t\tConOut(cErroTemp)\r\n\t\t\t\tSleep(3000)\r\n\r\n\t\t\t\tU_SWENARWAP(AllTrim(TRBMNT->WAM_TELL),\"Erro no cadastro da S. Serviço!\",\"Erro no cadastro da S. Serviço!\",\"MNT_ERRO\",\"TXT\",cArquivo)\r\n\r\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\r\n\t\t\t\tcQuery   += \"    SET WAM_NIVEL = 3\r\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010  \r\n\t\t\t\tcQuery   += \"  WHERE D_E_L_E_T_ = ''\r\n\t\t\t\tcQuery   += \"    AND WAM_EXEC = 'MNT'\r\n\t\t\t\tcQuery   += \"    AND WAM_PERG = 'N'\r\n\t\t\t\tcQuery   += \"    AND WAM_NIVEL = 0\r\n\r\n\t\t\t\tTcSQLExec(cQuery)   \r\n\r\n\t\t\t\tConOut(\"************* ERRO MNT FIM*************\")\r\n\t\t\tElse\r\n\t\t\t\r\n\t\t\t\tdbSelectArea(\"TQB\")\r\n\t\t\t\tcCodigoSS := TQB->TQB_SOLICI\r\n\t\t\t\tConOut(\"************* CONFIRMAÇÃO DA SS MNT INICIO *************\")\r\n\t\t\t\tConOut(\"****Codigo..:\"+cCodigoSS)\r\n\t\t\t\tConOut(\"********************************************************\")\r\n\r\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"Solicitação cadastrada com sucesso! Código:\" +cCodigoSS, \"SOLICITAÇÃO DE SERVIÇO\" )\r\n\r\n\t\t\t\tSleep(3000)\r\n\r\n\t\t\t\t/*\r\n\t\t\t\tDistriburir \r\n\t\t\t\tResponsável pela Manutenção\r\n\t\t\t\t*/\r\n\t\t\t\tdbSelectArea(\"ST9\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tdbSeek(xFilial(\"ST9\") + TRBMNT->WAM_RESPOS)\r\n\r\n\t\t\t\tcErroTemp := \"NOVA SOLICITAÇÃO DE SERVIÇO PARA DISTRIBUIÇÃO\" + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"CÓDIGO........:\" + cCodigoSS                   + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"DATA..........:\" + dToC(dDataBase)             + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"HORA..........:\" + Replace(time(),':',':')     + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"EQUIPAMENTO ID:\" + TRBMNT->WAM_RESPOS          + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"EQUIPAMENTO...:\" + AllTrim(ST9->T9_NOME)       + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"PROBLEMA......:\" + AllTrim(TRBMNT->MSG)        + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"COMO APROVAR..:\" + \"CIV/MEC/ELE/ , 1/2/3, COMPLEMENTO DA DESCRIÇÃO DO PROBLEMA\" \r\n\r\n\t\t\t\tcArquivo := \"\\_LOGWHATSMNT\\\" + \"MNT_DIST\" + cCodigoSS + dToS(dDataBase) +'_'+ Replace(time(),':','_') + \".txt\"\r\n\t\t\t\tMemoWrite(cArquivo, cErroTemp )\r\n\r\n\t\t\t\t/*\r\n\t\t\t\tTelefone fixo com a pessoa que vai distibuir \r\n\t\t\t\t*/ \r\n\t\t\t\tcNumDist := \"27997857938\"\r\n\t\t\t\t                \r\n\r\n\t\t\t\tcProt := U_SWENARWAP(AllTrim(cNumDist),\"Distribuir:\" + cCodigoSS,\"SS_\"+cCodigoSS,\"SS_\"+cCodigoSS,\"TXT\",cArquivo)\r\n\r\n\t\t\t\tIf  RecLock(\"WAM\",.T.) \r\n\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \r\n\t\t\t\t\t\tReplace WAM_DATA    With Date()\r\n\t\t\t\t\t\tReplace WAM_HORA    With Time()\r\n\t\t\t\t\t\tReplace WAM_ID      With cProt\r\n\t\t\t\t\t\tReplace WAM_MSG     With cErroTemp\r\n\t\t\t\t\t\tReplace WAM_INDEX   With cCodigoSS\r\n\t\t\t\t\t\tReplace WAM_TELL    With cNumDist\r\n\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\r\n\t\t\t\t\t\tReplace WAM_NIVEL   With \"0\"\r\n\t\t\t\t\t\tReplace WAM_EXEC    With 'MNT-DIST'\r\n\t\t\t\t\tMsUnLock()\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\r\n\t\t\t\tcQuery   += \"    SET WAM_NIVEL = 1 , WAM_HORAR  = Left(Cast(GETDATE() as Time ),5), WAM_DATAR  = Replace(Cast(GETDATE() as date ),'-',''),WAM_INDEX = '\"+AllTrim(cCodigoSS)+\"'\r\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010  \r\n\t\t\t\tcQuery   += \"  WHERE D_E_L_E_T_ = ''\r\n\t\t\t\tcQuery   += \"    AND WAM_EXEC = 'MNT'\r\n\t\t\t\tcQuery   += \"    AND WAM_PERG = 'N'\r\n\t\t\t\tcQuery   += \"    AND WAM_NIVEL = 0\r\n\r\n\t\t\t\tTcSQLExec(cQuery)   \r\n\r\n\r\n\t\t\t\tConOut(\"************* CONFIRMAÇÃO DA SS MNT FIM *************\")\r\n\t\t\t\tConOut(\"****Codigo..:\"+cCodigoSS)\r\n\t\t\t\tConOut(\"********************************************************\")\r\n\t\t\tEndif\t\r\n\r\n\tdbSelectArea(\"TRBMNT\")\r\n\tdbSkip()\r\nEndDo\r\n\r\n\r\n\r\ndbSelectArea(\"TRBMNT\") \r\ndbCloseArea()\r\n\r\n/**\r\n*********************************************************************************\r\nRetorno da DISTRIBUIÇÃO\r\nMNT\r\n*/\r\nPrivate aRespDist := {}\r\n\r\ncQuery   := \" SELECT UPPER(RETORNO) DIST,\r\ncQuery   += \"        CAST(GETDATE() AS DATE)         DATA,\r\ncQuery   += \" \t     FORMAT(GETDATE(),'hh:mm')       HORA,\r\ncQuery   += \" \t     R_E_C_N_O_         \t\t\t RECNO,\r\ncQuery   += \" \t\t *\r\ncQuery   += \"   FROM DADOSADV_Q..WAM010\r\ncQuery   += \"\tCROSS APPLY\r\ncQuery   += \"\t(\r\ncQuery   += \"\tSELECT RETORNO = dbo.FnWhatRetMSG(WAM_ID)\r\ncQuery   += \"\t) x\r\ncQuery   += \"  WHERE D_E_L_E_T_ = ''\r\ncQuery   += \"    AND WAM_EXEC = 'MNT-DIST'\r\ncQuery   += \"    AND WAM_PERG = 'S'\r\ncQuery   += \"    AND UPPER(RETORNO) <> ''\r\ncQuery   += \"    AND CAST(GETDATE()-3 AS DATE) <= CAST(WAM_DATA AS DATE)\r\n\r\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBMNT\", .F., .T.)\r\ndbSelectArea(\"TRBMNT\")\r\ndbgotop()\r\nDo While !EOF()\r\n\t\r\n\taRespDist := strtokarr (AllTrim(TRBMNT->DIST), \",\")\r\n\t\r\n\tIf Len(aRespDist) < 2\r\n\t\tU_SWENV(TRBMNT->WAM_TELL, \"Ditribuição errada tente novamente! Quantidade de parâmetros não atende.\", \"DIST-ERRO1\" )\r\n\t\tSleep(10000)\r\n\tElse\r\n\t\tIf !aRespDist[1] $ \"CIV/MEC/ELE\"\r\n\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"O primeiro parâmetro deve ser [CIV/MEC/ELE]. \", \"DIST-ERRO2\" )\r\n\t\t\tSleep(10000)\r\n\t\tElse\r\n\t\t\tIf !aRespDist[2] $ \"1/2/3\"\r\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"O Segundo parâmetro deve ser [1/2/3]. \", \"DIST-ERRO3\" )\r\n\t\t\t\tSleep(10000)\r\n\t\t\tElse\r\n\t\t\t\t//U_SWENV(TRBMNT->WAM_TELL, \"ok\", \"DIST-OK\" )\r\n\t\t\t\tdbSelectArea(\"TQB\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tdbSeek(xFilial(\"TQB\") + AllTrim(TRBMNT->WAM_INDEX) )\r\n\t\t\t\tIf  RecLock(\"TQB\",.F.)\r\n\t\t\t\t\tReplace TQB_CDSERV  With aRespDist[1]\r\n\t\t\t\t\tReplace TQB_CDEXEC  With \"LUAN SANTOS\"\r\n\t\t\t\t\tReplace TQB_PRIORI  With aRespDist[2]\r\n\t\t\t\t\tMsUnLock()\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//CONOUT(MSMM(TQB->TQB_CODMSS,80) + CHR(13)+CHR(10) + \"DATA.:\" + dToC(dDataBase)  + CHR(13)+CHR(10) + \"HORA..:\" + Replace(time(),':',':') + AllTrim(TRBMNT->DIST),80)\r\n\t\t\t\tMSMM(,,, MSMM(TQB->TQB_CODMSS,80) + CHR(13)+CHR(10) + \"DATA.:\" + dToC(dDataBase)  + CHR(13)+CHR(10) + \"HORA..:\" + Replace(time(),':',':') + CHR(13)+CHR(10) + AllTrim(TRBMNT->DIST),1,,,\"TQB\",\"TQB_CODMSS\")\r\n\t\t\t\t\r\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\r\n\t\t\t\tcQuery   += \"    SET WAM_PERG = 'N',WAM_HORAR  = Left(Cast(GETDATE() as Time ),5), WAM_DATAR  = Replace(Cast(GETDATE() as date ),'-','')\r\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010\r\n\t\t\t\tcQuery   += \"  WHERE R_E_C_N_O_ = \"+ AllTrim(Str(TRBMNT->RECNO))\r\n\r\n\t\t\t\tCONOUT(cQuery)\r\n\r\n\t\t\t\tTcSQLExec(cQuery) \r\n\r\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"SS classificada com sucesso! Código:\"+AllTrim(TRBMNT->WAM_INDEX) , \"DIST-SUCESSO\" )\r\n\t\t\t\tU_SWENV(\"27998282193\"   , \"SS classificada com sucesso! Código:\"+AllTrim(TRBMNT->WAM_INDEX) , \"DIST-SUCESSO\" )\r\n\t\t\t\t//Sleep(10000)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf \r\n\r\n\tdbSelectArea(\"TRBMNT\")\r\n\tdbSkip()\r\nEndDo\r\n\r\ndbSelectArea(\"TRBMNT\") \r\ndbCloseArea()\r\n\r\n/*\r\nVerificação de erro \r\nCAVALETES DIFRENTE DO PEDIDO DE VENDA\r\n*/\r\ncQuery   := \" SELECT \t'P' TIPO,\r\ncQuery   += \" \t\t\tC6_NUM,\r\ncQuery   += \" \t\t\tB8_YCAVALE\r\ncQuery   += \"   FROM (\r\ncQuery   += \"          SELECT C6_NUM ,C6_ITEM,B8_PRODUTO,B8_LOTECTL,C6_NUMLOTE,C6_YCAVALE,B8_YCAVALE,ROUND(C6_QTDVEN,4,0) C6_QTDVEN , ROUND(B8_SALDO,4,0) B8_SALDO,\r\ncQuery   += \"                         ( SELECT \r\ncQuery   += \"                             ROUND(SUM(SB.B8_YTOTLIQ),4,0) \r\ncQuery   += \"                                 FROM SB8010 SB \r\ncQuery   += \"                             WHERE   SB.D_E_L_E_T_='' \r\ncQuery   += \"                                 AND SB.B8_PRODUTO = SC6.C6_PRODUTO \r\ncQuery   += \"                                 AND SC6.C6_LOTECTL = RTRIM(LTRIM(SB.B8_LOTECTL))+RTRIM(LTRIM(SB.B8_YCLASSI)) \r\ncQuery   += \"                                 AND SC6.C6_NUMLOTE<>SB.B8_NUMLOTE \r\ncQuery   += \"                                 AND SC6.C6_NUMLOTE=SB.B8_YCAVALE\r\ncQuery   += \"                          ) SALDO_CHAPA\r\ncQuery   += \"                FROM SC6010 SC6 INNER JOIN SB8010 SB8\r\ncQuery   += \"                  ON (B8_PRODUTO = C6_PRODUTO AND B8_LOTECTL = C6_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE)\r\ncQuery   += \"              WHERE SC6.D_E_L_E_T_ = ''\r\ncQuery   += \"                AND SB8.D_E_L_E_T_ = ''\r\ncQuery   += \"                AND SC6.C6_NOTA = ''\r\ncQuery   += \"                AND SB8.B8_ORIGLAN = 'BD'\r\ncQuery   += \"                AND B8_LOCAL = C6_LOCAL\r\ncQuery   += \"          ) TB\r\ncQuery   += \" WHERE\r\ncQuery   += \"      (TB.C6_QTDVEN <> TB.B8_SALDO \r\ncQuery   += \"      OR \r\ncQuery   += \"      TB.SALDO_CHAPA<>TB.C6_QTDVEN)\r\n\r\ncQuery   += \"  UNION ALL\r\n\r\ncQuery   += \" SELECT \t'E' TIPO,\r\ncQuery   += \" \t\t\t'' C6_NUM,\r\ncQuery   += \" \t\t\tIIF(B8_YCAVALE='', B8_NUMLOTE,B8_YCAVALE) B8_YCAVALE \r\ncQuery   += \"     FROM (\r\ncQuery   += \"             SELECT \r\ncQuery   += \"                 ISNULL(( SELECT \r\ncQuery   += \"                     ROUND(SUM(SB.B8_YTOTLIQ),4,0) \r\ncQuery   += \"                         FROM SB8010 SB \r\ncQuery   += \"                     WHERE   SB.D_E_L_E_T_='' \r\ncQuery   += \"                         AND SB.B8_PRODUTO = SB8.B8_PRODUTO \r\ncQuery   += \"                         AND SB8.B8_LOTECTL = RTRIM(LTRIM(SB.B8_LOTECTL))+RTRIM(LTRIM(SB.B8_YCLASSI)) \r\ncQuery   += \"                         AND SB8.B8_NUMLOTE<>SB.B8_NUMLOTE \r\ncQuery   += \"                         AND SB8.B8_NUMLOTE=SB.B8_YCAVALE\r\ncQuery   += \"                  ),0) SALDO_CHAPA,\r\ncQuery   += \"                  ROUND(SB8.B8_SALDO,4,0) SALDO_BUNDLE,\r\ncQuery   += \"                  * \r\ncQuery   += \"             FROM SB8010 SB8 \r\ncQuery   += \"                     WHERE SB8.B8_FILIAL='010101' \r\n//cQuery   += \"                     AND CAST(SB8.B8_NUMLOTE AS INT) BETWEEN 100 AND 999999 \r\ncQuery   += \"                       AND SB8.B8_NUMLOTE = SB8.B8_YCAVALE\r\ncQuery   += \"  \t\t\t\t\t    AND SB8.B8_YCAVALE <> ''\r\ncQuery   += \"                       AND SB8.B8_SALDO>0 \r\ncQuery   += \"                       AND SB8.D_E_L_E_T_=''\r\ncQuery   += \"         )TB\r\ncQuery   += \"     WHERE SALDO_BUNDLE<>SALDO_CHAPA\r\n\r\ncQuery   += \"  UNION ALL \r\n\r\ncQuery   += \"  SELECT 'F' TIPO,\r\ncQuery   += \"  \t   D2_NUMLOTE B8_YCAVALE,\r\ncQuery   += \"  \t   CHAVE_DOC C6_NUM\r\ncQuery   += \"    FROM (\r\ncQuery   += \"  \t\tSELECT *,\r\ncQuery   += \"  \t\t\t   (SELECT ROUND(SUM(B8_YQTDBD),5,0) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI\r\ncQuery   += \"  \t\t  FROM (\r\ncQuery   += \"  \t\t\t\tSELECT  D2_FILIAL+D2_DOC+D2_SERIE CHAVE_DOC,\r\ncQuery   += \"  \t\t\t\t\t\tCAST(D2_EMISSAO AS DATE) EMISSAO,\r\ncQuery   += \"  \t\t\t\t\t\tD2_COD,\r\ncQuery   += \"  \t\t\t\t\t\tD2_NUMLOTE ,\r\ncQuery   += \"  \t\t\t\t\t\tD2_LOTECTL,\t\t\t\t\t\t\r\ncQuery   += \"  \t\t\t\t\t\tD2_FILIAL,\r\ncQuery   += \"  \t\t\t\t\t\tROUND(SUM(D2_QUANT),5,0) QTD_FAT\r\ncQuery   += \"  \t\t\t\t\tFROM SD2010 \r\ncQuery   += \"  \t\t\t\t\tWHERE D_E_L_E_T_ = '' \r\ncQuery   += \"  \t\t\t\t\t  AND D2_COD LIKE 'CH%'\r\ncQuery   += \"  \t\t\t\t\t  AND D2_QTDEDEV = 0\r\ncQuery   += \"  \t\t\t\tGROUP BY D2_FILIAL+D2_DOC+D2_SERIE,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_NUMLOTE,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_LOTECTL,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_PEDIDO,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_ITEMPV,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_FILIAL,\r\ncQuery   += \"  \t\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE),\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_COD\r\ncQuery   += \"  \t\t\t\t)TAB_BASE\r\ncQuery   += \"  \t\t)TAB_2\r\ncQuery   += \"  WHERE  ROUND(QTD_FAT,0,0) <> ROUND(QTD_SB8_ORI,0,0)\r\ncQuery   += \"    AND CHAVE_DOC NOT IN (\r\ncQuery   += \"  \t\t\t\t\t\t'0101010000064491',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000067471',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000070511',\r\ncQuery   += \"  \t\t\t\t\t\t'0101010000071041',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000072551',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000077821',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000077821',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000083191',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000085411'  \r\ncQuery   += \"  \t\t\t\t\t\t)\r\n\r\ncQuery   += \"  ORDER BY B8_YCAVALE,C6_NUM\r\n\r\n\r\n/*\r\nQUERY USADA PARA ACHAR OS VALORES SB8 <> DO FATURADO\r\n\r\nSELECT 'F' TIPO,\r\n\t   D2_NUMLOTE B8_YCAVALE,\r\n\t   CHAVE_DOC C6_NUM\r\n\t   , *\r\n\t   ,'http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+D2_FILIAL+'&NUMPED='+D2_PEDIDO+'&rs:Format=pdf' as LINK\r\n  FROM (\r\n\t\tSELECT *,\r\n\t\t\t   (SELECT RTRIM(LTRIM(B1_DESC))  FROM SB1010 WHERE D_E_L_E_T_ = ''  AND B1_COD = D2_COD) DESCRICAO,\r\n\t\t\t   (SELECT C6_PRCVEN  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) PRC_VEN,\r\n\t\t\t   (SELECT C6_QTDVEN  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) QTD_PV_NOR,\r\n\t\t\t   (SELECT ROUND(C6_QTDVEN,0,0)  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) QTD_PV,\r\n\t\t\t   (SELECT C6_YCLASSI  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) CLASSIF,\r\n\t\t\t   (SELECT C6_YCAVALE FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) CAVALETE,\r\n\t\t\t   (SELECT SUM(B8_YQTDBD) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI_NOR,\r\n\t\t\t   (SELECT ROUND(SUM(B8_YQTDBD),0,0) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI\r\n\t\t  FROM (\r\n\t\t\t\tSELECT  D2_FILIAL+D2_DOC+D2_SERIE CHAVE_DOC,\r\n\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE) EMISSAO,\r\n\t\t\t\t\t\tD2_COD,\r\n\t\t\t\t\t\tD2_NUMLOTE ,\r\n\t\t\t\t\t\tD2_LOTECTL,\t\t\t\t\t\t\r\n\t\t\t\t\t\tD2_PEDIDO,\r\n\t\t\t\t\t\tD2_ITEMPV,\r\n\t\t\t\t\t\tD2_FILIAL,\r\n\t\t\t\t\t\tROUND(SUM(D2_QUANT),0,0) QTD_FAT\r\n\t\t\t\t\tFROM SD2010 \r\n\t\t\t\t\tWHERE D_E_L_E_T_ = '' \r\n\t\t\t\t\t -- AND D2_DOC = '000009057' \r\n\t\t\t\t\t  AND D2_COD LIKE 'CH%'\r\n\t\t\t\tGROUP BY D2_FILIAL+D2_DOC+D2_SERIE,\r\n\t\t\t\t\t\t\tD2_NUMLOTE,\r\n\t\t\t\t\t\t\tD2_LOTECTL,\r\n\t\t\t\t\t\t\tD2_PEDIDO,\r\n\t\t\t\t\t\t\tD2_ITEMPV,\r\n\t\t\t\t\t\t\tD2_FILIAL,\r\n\t\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE),\r\n\t\t\t\t\t\t\tD2_COD\r\n\t\t\t\t)TAB_BASE\r\n\t\t)TAB_2\r\nWHERE  ROUND(QTD_FAT,0,0) <> ROUND(QTD_SB8_ORI,0,0)\r\n  AND CHAVE_DOC NOT IN (\r\n\t\t\t\t\t\t'0101010000064491',  \r\n\t\t\t\t\t\t'0101010000067471',  \r\n\t\t\t\t\t\t'0101010000070511',\r\n\t\t\t\t\t\t'0101010000071041',  \r\n\t\t\t\t\t\t'0101010000072551',  \r\n\t\t\t\t\t\t'0101010000077821',  \r\n\t\t\t\t\t\t'0101010000077821',  \r\n\t\t\t\t\t\t'0101010000083191',  \r\n\t\t\t\t\t\t'0101010000085411'  \r\n\t\t\t\t\t\t)\r\nORDER BY EMISSAO, CHAVE_DOC\r\n\r\n*/\r\n\r\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBERRO\", .F., .T.)\r\ndbSelectArea(\"TRBERRO\")\r\ndbgotop()\r\nDo While !EOF()\r\n\r\n\tIF TRBERRO->TIPO == 'P'\r\n\t\t/*\r\n\t\tAVISO PARA BRUNO\r\n\t\t*/\r\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE  , \"ERRO:\" +AllTrim(TRBERRO->B8_YCAVALE)  )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tAVISO PARA ARLINDO\r\n\t\t*/\r\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE  , \"ERRO:\" +AllTrim(TRBERRO->B8_YCAVALE)  )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tEMAIL\r\n\t\t*/\r\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",'ERRO URGENTE ! PV:' + TRBERRO->C6_NUM , \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE ,'')\r\n\tENDIF\r\n\r\n\tIF TRBERRO->TIPO == 'E'\r\n\t\t/*\r\n\t\tAVISO PARA BRUNO\r\n\t\t*/\r\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) CAVALETE -  BUNDLE:\" + AllTrim(TRBERRO->B8_YCAVALE)    )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tAVISO PARA ARLINDO\r\n\t\t*/\r\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) CAVALETE - BUNDLE:\" + AllTrim(TRBERRO->B8_YCAVALE)     )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tEMAIL\r\n\t\t*/\r\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",\"ERRO URGENTE ! CAVALETE:\" + TRBERRO->B8_YCAVALE ,'')\r\n\tENDIF\r\n\r\n\t\r\n\tIF TRBERRO->TIPO == 'F'\r\n\t\t/*\r\n\t\tAVISO PARA BRUNO\r\n\t\t*/\r\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + AllTrim(TRBERRO->C6_NUM)    )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tAVISO PARA ARLINDO\r\n\t\t*/\r\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + AllTrim(TRBERRO->C6_NUM)     )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tEMAIL\r\n\t\t*/\r\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",\"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + TRBERRO->C6_NUM ,'')\r\n\tENDIF\r\n\r\n\tdbSelectArea(\"TRBERRO\")\r\n\tdbSkip()\r\nEndDo\r\n\r\ndbSelectArea(\"TRBERRO\") \r\ndbCloseArea()\r\n\r\n/*\r\nCaso exista alguma aprovação ou reprovação \r\no sistema envia o protocolo por e-mail\r\n*/\r\nIF lEnvProt\r\n\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0060&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0060.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t  \r\n\t//ConOut(\"Gerando protocolo...\" )\r\n\t//Sleep(3000)\r\n\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"diego.sirtori@grupoqualita.com.br\",'Relaório de Protocolo','Anexo relatório de protocolos!','D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0060.PDF')\r\nEndIf\r\n\r\nIf lAutoZAP\r\n\tRpcClearEnv()\r\n\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" FIM do JOB liberação de Retornos pelo WHATSAPP.\")\r\nElse\r\n\t// Caso não seja job, informa na a atualização\r\n\tAlert(\"Fim da liberação de Retorno pelo WHATSAPP. (Chamada Manual)\")\r\nEndif\r\n\r\nReturn\r\n"}}}
Content-Length: 166
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/10_LIB/LIBWHATSAPP.PRW"}}}
Content-Length: 17333
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/10_LIB/MSupPesq.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MSUPPESQ.prw\r\nObjetivo        : Pesquisa de Produtos\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MSUPPESQ(cPStart)\r\n/*****************************************************************************************\r\n* Programa principal \r\n*\r\n***/              \r\nLocal lRet := .F.\r\n\r\nPrivate oEdit1\r\nPrivate oEdit2\r\nPrivate oEdit3\r\n   \r\nPrivate cEdit1\t := IIf(Empty(cPStart),Space(15),cPStart)\r\nPrivate cEdit2\t := Space(60)\r\nPrivate cEdit3\t := Space(04)\r\n\r\nPrivate oBoxLib\r\n\r\n// Definindo os objetos de marcação\r\nPrivate oNoMarked   := LoadBitmap( GetResources(), \"LBNO\" )\r\nPrivate oMarked     := LoadBitmap( GetResources(), \"LBOK\" )\r\n\r\n//Inicializando o aGrd com valores minimos \r\nPrivate aGrd := {{LoadBitmap(GetResources(), \"BR_CINZA\"   ),oNoMarked,\"\",\"\",\"\",0,\"\",\"\",\"\",\"\",\"\"}} \r\n\r\nPrivate aArrCor := {}     \r\nPrivate cCodRet := \"\"\r\n\r\n//Carregando as cores utilizadas \r\naAdd(aArrCor,LoadBitmap(GetResources(), \"BR_VERDE\" )) // 1\r\naAdd(aArrCor,LoadBitmap(GetResources(), \"BR_CINZA\" )) // 2 \r\naAdd(aArrCor,LoadBitmap(GetResources(), \"BR_LARANJA\"))// 3\r\n\r\nSetKey(VK_F9 , {|| MsgRun(\"Processando registros...\",\"\",{|| CursorWait(), fPeProGr(cEdit1,cEdit2,cEdit3),oBoxLib:SetFocus(),CursorArrow()})})\r\nSetKey(VK_F10, {|| fReCoPro(cCodRet),Close(_oDlg) })\r\n\r\n/*\t\r\nSetKey(VK_F6, {|| fConEst(xFilial(\"SB2\")) })\r\nSetKey(VK_F8, {|| MsgRun(\"Visualizando registro...\",\"\",{|| CursorWait(), fVisProd(cEdit1),CursorArrow()}) })\r\n*/\r\nDEFINE MSDIALOG _oDlg TITLE \"Pesquisa de Produtos\" FROM U_MGETTELA(219),U_MGETTELA(180) TO U_MGETTELA(613),U_MGETTELA(966+200) PIXEL\r\n\r\n\t// Cria Componentes Padroes do Sistema\r\n\t@ U_MGETTELA(001),U_MGETTELA(009) Say \"Código:\" Size U_MGETTELA(020),U_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ U_MGETTELA(001),U_MGETTELA(078) Say \"Descrição:\" Size U_MGETTELA(027),U_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ U_MGETTELA(000),U_MGETTELA(323) Say \"Grupo:\" Size U_MGETTELA(018),U_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t\r\n\t@ U_MGETTELA(010),U_MGETTELA(009) MsGet oEdit1 Var cEdit1              Size U_MGETTELA(060),U_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ U_MGETTELA(010),U_MGETTELA(078) MsGet oEdit2 Var cEdit2 Picture \"@!\" Size U_MGETTELA(235),U_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t\t//oEdit2:SetFocus()\r\n\t@ U_MGETTELA(010),U_MGETTELA(323) MsGet oEdit3 Var cEdit3 F3(\"SBM\")    Size U_MGETTELA(062),U_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t\r\n\t@ U_MGETTELA(177),U_MGETTELA(201) Button \"Visualizar\" \t\tAction(MsgRun(\"Visualizando registro...\",\"\",{|| CursorWait(), fVisProd(cEdit1)              ,CursorArrow() }))   Size U_MGETTELA(037),U_MGETTELA(012) PIXEL OF _oDlg\r\n\t@ U_MGETTELA(177),U_MGETTELA(252) Button \"Pesquisar [F9]\"  \tAction(MsgRun(\"Processando registros...\",\"\",{|| CursorWait(), fPeProGr(cEdit1,cEdit2,cEdit3),CursorArrow() }))   Size U_MGETTELA(037),U_MGETTELA(012) PIXEL OF _oDlg\r\n\t@ U_MGETTELA(177),U_MGETTELA(301) Button \"Estoque\"    \t\tAction(fConEst(aGrd[oBoxLib:nAt,9])) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t     Size U_MGETTELA(037),U_MGETTELA(012) PIXEL OF _oDlg\r\n\t@ U_MGETTELA(177),U_MGETTELA(347) Button \"OK [F10]\"         Action(fReCoPro(cCodRet),Close(_oDlg)) \t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t  \t Size U_MGETTELA(037),U_MGETTELA(012) PIXEL OF _oDlg\r\n\r\n\t@ U_MGETTELA(026),U_MGETTELA(009) ListBox oBoxLib  Fields Headers \t\" \"\t\t\t,; \r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\" \"\t\t\t,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Codigo\"\t,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Descricao\"\t,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"UM\"\t\t,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Grupo\"\t\t,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Local\"\t\t,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Qtd Atual\"\t,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Filial\"    ,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"Nome\"      ,;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"End.Aproximado\";\r\n\t\tSize U_MGETTELA(376+100),U_MGETTELA(145) ON DBLCLICK (FLocaArr(aGrd[oBoxLib:nAt,3])) Pixel Of _oDlg\r\n\t  \t\r\n\t\toBoxLib:SetArray(aGrd)\r\n\t\toBoxLib:bLine := {|| {  aGrd[oBoxLib:nAt,01],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,02],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,03],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,04],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,05],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,06],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,07],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,08],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,09],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,10],;\r\n\t\t\t\t\t\t\t\taGrd[oBoxLib:nAt,11];\r\n\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\r\n\t\tIf !Empty(cPStart)\r\n\t\t\tfPeProGr(cEdit1,cEdit2,cEdit3)\r\n\t\t\tFLocaArr(cEdit1) \r\n\t\tEndIf\r\n\r\nACTIVATE MSDIALOG _oDlg CENTERED \r\n\r\n\r\nSetKey(VK_F9,Nil)\r\nSetKey(VK_F10,Nil)\r\n \r\n/*\r\nSetKey(VK_F9,Nil)\r\nSetKey(VK_F6,Nil) \r\nSetKey(VK_F8,Nil)\r\n*/\r\n\r\nIF !Empty(cCodRet)\r\n\tlRet := .T.                       \r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1)                                   \r\n\tdbSeek( xFilial(\"SB1\") + cCodRet )\t\t\r\nElse\r\n\tlRet := .F.\t    \r\nEndIf\t\r\n\r\nReturn(lRet)          \r\n\r\n\r\nStatic Function fVisProd(cCodRet)\r\n/*****************************************************************************************\r\n*  Sair\r\n*\r\n***/   \r\n\r\nIF Empty(cCodRet)\r\n\tReturn(.t.)\r\nEndIf\r\n\r\ndbSelectArea(\"SB1\")\r\ndbSetOrder(1)\r\ndbSeek(xFilial(\"SB1\")+AllTrim(cCodRet))\r\nA010Visul(\"SB1\" )\r\n\r\nReturn(.t.)\r\n                   \r\nStatic Function fReCoPro(cCodRet)\r\n/*****************************************************************************************\r\n*  Sair\r\n*\r\n***/   \r\n                                \r\nIF !Empty(cCodRet)\t\r\n\tlRet := .T.                       \r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1)                                   \r\n\tdbSeek( xFilial(\"SB1\") + cCodRet )\t\t\r\nElse\r\n\tlRet := .F.\t    \r\nEndIf\t\r\n\r\nReturn\r\n\r\nStatic Function fVerFoto()\r\n/*****************************************************************************************\r\n*  Funcao visualização das fotos \r\n*\r\n***/                                          \r\nLocal oDlgFoto  \r\nLocal oBmp\t\t\t                      \r\nLocal cCodPro := \"\"\r\nLocal nX      := 0\r\n\r\n\r\nFor nX := 1 To Len(aGrd)                           \r\n\tIf aGrd[nX,2] == oMarked\r\n\t\tcCodPro := aGrd[nX,3]\r\n\tEndIf \r\nNext nX                 \r\n\r\nIF !Empty(cCodPro)\r\n\tdbSelectarea(\"SB1\")\r\n\tdbSetOrder(1)                         \r\n\tIf dbSeek(xFilial(\"SB1\")+cCodPro)\r\n  \t\tDEFINE MSDIALOG oDlgFoto TITLE \"Foto: \" + SB1->B1_DESC FROM U_MGETTELA(178),U_MGETTELA(181) TO U_MGETTELA(395),U_MGETTELA(395) PIXEL \r\n  \t\t\t@ U_MGETTELA(004), U_MGETTELA(004) REPOSITORY oBmp SIZE U_MGETTELA(100), U_MGETTELA(100) PIXEL NO BORDER OF oDlgFoto\r\n\t\t\t\toBmp:lAutoSize := .T.\r\n\t\t\t\toBmp:LoadBmp(SB1->B1_BITMAP)\r\n\t\t\t\toBmp:Refresh()\t\t\t\r\n\t\tACTIVATE MSDIALOG oDlgFoto CENTERED \t\t\t\r\n\tEndIf\r\nEndIf\r\n\r\nReturn\r\n\r\n\r\nStatic Function FLocaArr(cValPes)       \r\n/*****************************************************************************************\r\n* Selecao do produto \r\n*\r\n***/ \r\nLocal lNotRepet := .T.\r\nLocal nX        := 0\r\n\r\n\r\nFor nX := 1 To Len(aGrd)\r\n\tiF !Empty(aGrd[nX,3])\r\n\t\tIf aGrd[nX,3] == cValPes\r\n\t\t\taGrd[nX,2] :=\toMarked \r\n\t\t\tcCodRet    :=   aGrd[nX,3]\r\n\t\t\t\r\n\t\t\tcEdit1     :=   cCodRet \r\n\t\t\t\r\n\t\t\tIf aGrd[nX,8] <= 0 .And. lNotRepet \r\n\t\t\t\tlNotRepet := .F.\r\n\t\t\t\tAlert(\"Este item não possui estoque em algum almoxarifado. Verifique!\")\r\n\t\t\tEndIf\r\n\t\tElse                 \r\n\t\t\taGrd[nX,2] :=   oNoMarked\r\n\t\tEndIf \r\n\tEndIf\r\nNext nX      \r\n            \r\noBoxLib:Refresh() \r\noEdit1:Refresh()\r\n\r\nReturn  \r\n\r\nStatic Function fPeProGr(cEdVa1,cEdVa2,cEdVa3)       \r\n/*****************************************************************************************\r\n* Funcao de pesquisa dos produtos na grid \r\n*§\r\n***/ \r\nLocal cQuery  := \"\"  \r\n\r\nIf  Len(AllTrim(cEdVa2)) < 3 .and. Empty(cEdVa1)\r\n\tAlert(\"Erro ! Quantiade de caracteres menor que 3! Digite o mínimo de 3 algarismo.\")\r\n\tReturn()\r\nEndIf\r\n\r\ncQuery := \" SELECT DISTINCT * FROM (\r\n\r\ncQuery += \" \t SELECT\tRTRIM(LTRIM(B1_COD))  B1_COD,\t\r\ncQuery += \"  \t\t\tRTRIM(LTRIM(B1_DESC)) B1_DESC,\r\ncQuery += \"  \t\t\tB1_UM,\r\ncQuery += \"  \t\t\tB1_ENDAPRO,\r\ncQuery += \"  \t\t\tRTRIM(LTRIM(BM_DESC)) BM_DESC,\r\ncQuery += \"  \t\t\tISNULL(B2_LOCAL,'') + '-' + ISNULL(RTRIM(LTRIM((SELECT NNR_DESCRI FROM \" + RetSqlName(\"NNR\") + \" NNR  WHERE D_E_L_E_T_ = '' AND NNR_CODIGO = B2_LOCAL AND LEFT(NNR_FILIAL,4) =  LEFT(B2_FILIAL,4) ))),'') LOCALax,\r\ncQuery += \"  \t\t\tISNULL(B2_QATU,0) B2_QATU,\r\ncQuery += \"  \t\t\tB1_MSBLQL,\r\ncQuery += \"  \t\t\tISNULL(B2_FILIAL ,'') B2_FILIAL\r\n//cQuery += \" \t\t\tISNULL((SELECT B2_FILIAL FROM \" + RetSqlName(\"SB2\") + \" SB2 WHERE D_E_L_E_T_ = '' AND B2_FILIAL = '\" + + \"' AND B1_COD = B2_COD ),'\"+xFilial(\"SB2\")+\"') FILIAL_SB2\r\ncQuery += \" \t   FROM \" + RetSqlName(\"SB1\") + \"  SB1 INNER JOIN \" + RetSqlName(\"SBM\") + \" SBM \r\ncQuery += \" \t\t ON (B1_GRUPO = BM_GRUPO)\r\ncQuery += \"  \t\t   FULL JOIN \" + RetSqlName(\"SB2\") + \" SB2\r\ncQuery += \"  \t\tON (B1_COD = B2_COD)\r\ncQuery += \" \t  WHERE SBM.D_E_L_E_T_ <> '*' \r\ncQuery += \" \t\tAND SB1.D_E_L_E_T_ <> '*' \r\ncQuery += \" \t\tAND ISNULL(SB2.D_E_L_E_T_,'') <> '*'\r\n\r\nIf !Empty(cEdVa1)\r\n\tcQuery += \" \tAND B1_COD LIKE '%\"+ Replace(AllTrim(cEdVa1),\"'\",\"\") +\"%'   \"\r\nEndIf                                                         \r\nIf !Empty(cEdVa2)\r\n\tcQuery += \" \tAND B1_DESC LIKE '%\"+ Replace(AllTrim(cEdVa2),\"'\",\"\") +\"%'   \"\r\nEndIf                                                         \r\nIf !Empty(cEdVa3)\r\n\tcQuery += \" \tAND B1_GRUPO = '\" + Replace(AllTrim(cEdVa3),\"'\",\"\") + \"'\" \r\nEndIf\r\n\r\ncQuery += \" \t\t)TB_TEMP \r\n\r\n//cQuery += \" WHERE FILIAL_SB2 = '\" + SubString(CNUMEMP,3,6) + \"'\r\n\r\ncQuery += \" ORDER BY B1_COD   \r\n\r\n/*\t                     \r\ncQuery := \" SELECT\tRTRIM(LTRIM(B1_COD))  B1_COD,\t\r\ncQuery += \" \t\tRTRIM(LTRIM(B1_DESC)) B1_DESC,\r\ncQuery += \" \t\tB1_UM,\r\ncQuery += \" \t\tRTRIM(LTRIM(BM_DESC)) BM_DESC,\r\ncQuery += \" \t\tISNULL(B2_LOCAL,'') + '-' + ISNULL(RTRIM(LTRIM((SELECT NNR_DESCRI FROM \" + RetSqlName(\"NNR\") + \" NNR  WHERE D_E_L_E_T_ = '' AND NNR_CODIGO = B2_LOCAL AND LEFT(NNR_FILIAL,4) =  LEFT(B2_FILIAL,4) ))),'') LOCAL,\r\ncQuery += \" \t\tISNULL(B2_QATU,0) B2_QATU,\r\ncQuery += \" \t\tB1_MSBLQL\r\ncQuery += \"   FROM \" + RetSqlName(\"SB1\") + \"  SB1 INNER JOIN \" + RetSqlName(\"SBM\") + \" SBM \r\ncQuery += \"     ON (B1_GRUPO = BM_GRUPO)\r\ncQuery += \" \t   FULL JOIN \" + RetSqlName(\"SB2\") + \" SB2\r\ncQuery += \" \tON (B1_COD = B2_COD)\r\ncQuery += \"  WHERE SBM.D_E_L_E_T_ <> '*' \r\ncQuery += \"    AND SB1.D_E_L_E_T_ <> '*' \r\ncQuery += \"    AND ISNULL(SB2.D_E_L_E_T_,'') <> '*'\r\ncQuery += \"    AND (SB2.B2_FILIAL = '\"+xFilial(\"SB2\")+\"' OR ISNULL(SB2.B2_FILIAL,'X') = 'X')\r\n//cQuery += \"    AND LEFT(B1_COD,2) NOT IN ('BL','AM','CH','FA')\r\n\t                     \r\nIf !Empty(cEdVa1)\r\n\tcQuery += \" AND B1_COD LIKE '%\"+ AllTrim(cEdVa1) +\"%'   \"\r\nEndIf                                                         \r\nIf !Empty(cEdVa2)\r\n\tcQuery += \" AND B1_DESC LIKE '%\"+ AllTrim(cEdVa2) +\"%'   \"\r\nEndIf                                                         \r\nIf !Empty(cEdVa3)\r\n\tcQuery += \" AND B1_GRUPO = '\" + AllTrim(cEdVa3) + \"'\" \r\nEndIf\r\n\r\ncQuery += \" ORDER BY B1_COD                   \r\n*/             \r\n\r\ncQuery := ChangeQuery(cQuery)\r\nTCQUERY cQuery NEW ALIAS \"TRB1\"                               \r\n\r\naGrd \t:= {}         \r\n\r\ncCodRet := \"\"\r\n\r\ndbSelectArea(\"TRB1\")\r\ndbGoTop()\r\nDo While !EoF()      \r\n                         \r\n\tIf TRB1->B1_MSBLQL = '1'\r\n\t\tnCdCor  := 2\r\n\tElse\r\n\t\tnCdCor  := 1\r\n\tEndIf           \r\n\r\n\tIf AllTrim(TRB1->LOCALax)== '-'\r\n\t\tnCdCor  := 3\r\n\tEndIf\r\n\r\n\taAdd(aGrd, {aArrCor[nCdCor]\t        ,;\r\n\t\t\t\toNoMarked \t\t        ,;\r\n\t\t\t\tTRB1->B1_COD \t        ,;\r\n\t\t\t\tAllTrim(TRB1->B1_DESC)\t,; \r\n\t\t\t\tTRB1->B1_UM\t\t        ,;\r\n\t\t\t\tAlltrim(TRB1->BM_DESC)\t,;\r\n\t\t\t\tTRB1->LOCALax \t        ,;\r\n\t\t\t\tTRB1->B2_QATU \t        ,;\r\n\t\t\t\tTRB1->B2_FILIAL         ,;\r\n\t\t\t\tFWFilialName(SubString(CNUMEMP,1,2),TRB1->B2_FILIAL,1),;\r\n\t\t\t\tAllTrim(TRB1->B1_ENDAPRO);\r\n\t\t\t\t})\t\r\n\t\t\t\t\r\n\tdbSelectArea(\"TRB1\")\r\n\tdbSkip()\r\nEndDo          \r\n\r\nif Len(aGrd) <= 0\r\n\taGrd := {\t{LoadBitmap(GetResources(),\"BR_CINZA\"),;\r\n\t\t\t\toNoMarked,;\r\n\t\t\t\t\"\",;\r\n\t\t\t\t\"\",;\r\n\t\t\t\t\"\",;\r\n\t\t\t\t\"\",;\r\n\t\t\t\t\"\",;\r\n\t\t\t\t0 ,;\r\n\t\t\t\t\"\",;\r\n\t\t\t\t\"\",;\r\n\t\t\t\t\"\";\r\n\t\t\t\t}}\r\nEndIf\r\n\r\ndbSelectArea(\"TRB1\")\r\ndbCloseArea()  \r\n \r\noBoxLib:SetArray(aGrd)  \r\noBoxLib:bLine := {|| {\taGrd[oBoxLib:nAt,01],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,02],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,03],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,04],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,05],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,06],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,07],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,08],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,09],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,10],;\r\n\t\t\t\t\t\taGrd[oBoxLib:nAt,11];\r\n\t\t\t\t\t\t}}  \r\noBoxLib:Refresh()             \r\n\t\r\nReturn\r\n\r\nStatic Function fConEst(cEmpFil)       \r\n/*****************************************************************************************\r\n* Funcao de consulta estoque\r\n*\r\n***/   \r\nLocal cCodPro\r\nLocal cCodLocal \r\nLocal nX        := 0\r\n//Local NPOSLOTE  \r\n\r\nFor nX := 1 To Len(aGrd)                           \r\n\tIf aGrd[nX,2] == oMarked .and. AllTrim(aGrd[oBoxLib:nAt,7]) == AllTrim(aGrd[nX,7]) \r\n\t\tcCodPro   := aGrd[nX,3]\r\n\t\tcCodLocal := SUBSTR(aGrd[oBoxLib:nAt,7],1, AT(\"-\",aGrd[oBoxLib:nAt,7]) -1)\r\n\tEndIf \r\nNext nX \r\n\r\nIf !Empty(cCodPro)\r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1)\r\n\tdbSeek(xFilial(\"SB1\")+ cCodPro)\r\n\tIf SB1->B1_RASTRO = 'N'\r\n\t\tMaViewSB2(cCodPro,cEmpFil)\r\n\tElse\r\n\t\tF4Lote(,,,   '',cCodPro,cCodLocal,NIL,'',1)\r\n\tEndIf\r\nEndIf\r\n\t\r\nReturn\r\n                                                                                                                 \r\n\r\nStatic Function fConProd()\r\n/*****************************************************************************************\r\n* Função de consulta produtos \r\n*\r\n***/\r\nLocal cCodPro := \"\"\r\nLocal nX      := 0\r\n                   \r\n\r\nFor nX := 1 To Len(aGrd)                           \r\n\tIf aGrd[nX,2] == oMarked\r\n\t\tcCodPro := aGrd[nX,3]\r\n\tEndIf \r\nNext nX \r\n                            \r\nIf !Empty(cCodPro)\r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1)\r\n\tdbGoTop()\r\n\tIf DbSeek(xFilial(\"SB1\")+cCodPro)\r\n\t\tA010Visul(\"SB1\",,2)\r\n\tEndIf\r\nEndIf\r\n\t\r\nReturn                                                                                               \r\n\r\nStatic Function Flegenda()\r\n/******************************************************************************************\r\n* Função Consulta Legendas\r\n*\r\n***/\r\nLocal oDlgLeg                                     \r\nLocal oListLeg\r\nLocal aGrdLeg := {}\r\n                         \r\naAdd(aGrdLeg,{aArrCor[3 ],\"Preço de venda normal.\"})\r\naAdd(aGrdLeg,{aArrCor[1 ],\"Preço promocional.\"})\r\naAdd(aGrdLeg,{aArrCor[5 ],\"Tabela de preços não encontrada ou produto não encontrado na tabela de preços.\"}) \r\naAdd(aGrdLeg,{aArrCor[11],\"A pesquina não encontrou nenhum resultado\"})   \r\n\r\n\r\nDEFINE MSDIALOG oDlgLeg TITLE \"Legenda\" FROM U_MGETTELA(275),U_MGETTELA(294) TO U_MGETTELA(468),U_MGETTELA(787) PIXEL\t\r\n\t@ U_MGETTELA(005),U_MGETTELA(003) ListBox oListLeg Fields HEADER \" \",\"Descrição\" Size U_MGETTELA(242),U_MGETTELA(070) ;\r\n\t\tOf oDlgLeg Pixel;\r\n\t\t\t\t\t\r\n\t\toListLeg:SetArray(aGrdLeg)                                                                                 \r\n\t\toListLeg:bLine := {|| {\taGrdLeg[oListLeg:nAt,1],;\r\n\t\t\t\t\t\t\t\taGrdLeg[oListLeg:nAt,2] }}\r\n\t\toListLeg:lHScroll := .F. \r\n\t\toListLeg:lVScroll := .F.\r\n\t@ U_MGETTELA(084),U_MGETTELA(208) Button \"Fechar\" Size U_MGETTELA(037),U_MGETTELA(012) Action (Close(oDlgLeg))PIXEL OF oDlgLeg\r\nACTIVATE MSDIALOG oDlgLeg CENTERED                                                                               \r\n\r\nReturn\r\n"}}}
Content-Length: 666
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":73},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MSUPPESQ.prw\r\nObjetivo        : Pesquisa de Produtos\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 666
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":74},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : Pesquisa de Produtos\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 647
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":75},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 648
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":76},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 649
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":77},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.E\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 650
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":78},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.En\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 651
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":79},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Ent\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 653
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":81},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entra\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 660
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":88},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada comp\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 661
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":89},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compi\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 662
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":90},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compil\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 663
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":91},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compila\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 674
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":101},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para re\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 680
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":107},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 681
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":108},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover m\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 684
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":111},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 687
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":114},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 688
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":115},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de a\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 690
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":117},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de avi\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 693
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":120},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 695
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":122},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 696
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":123},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e e\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 703
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":130},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventura\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 701
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":132},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventu\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 706
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":137},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual er\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 709
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":140},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 712
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":143},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 716
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":147},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entr\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 720
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":151},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrda d\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 721
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":152},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrda da\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 720
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":161},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 721
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":162},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada n\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 724
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":165},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada nda \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 723
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":172},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 725
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":174},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 726
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":175},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 727
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":176},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 728
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":177},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 732
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":181},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 736
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":185},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo con\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 737
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":186},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo cone\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 740
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":188},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexç\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 744
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":191},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção \r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 746
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":193},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nf\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 747
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":194},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 12/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 745
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":196},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : /02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 746
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":197},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 0/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 747
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":198},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2006 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 745
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":200},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/20 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 747
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":202},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 11:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 746
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":203},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 1:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 747
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":204},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:29\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 745
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":206},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 746
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":207},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:4\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 747
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":208},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:40\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 745
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":210},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 746
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":211},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:3\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 747
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":212},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 751
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":213},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 755
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":214},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\n\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 759
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":218},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 762
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":221},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi fei\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 763
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":222},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feit\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 769
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":228},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 770
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":229},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma r\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 772
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":231},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma rre\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 774
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":237},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reuni\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 778
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":240},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 784
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":246},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 788
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":250},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 789
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":251},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com F\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 792
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":254},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Feli\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 793
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":255},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felip\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 794
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":256},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 795
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":257},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 798
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":260},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe da \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 796
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":262},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe d\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 798
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":264},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 802
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":268},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do cone\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 805
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":270},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexç\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 808
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":272},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexção\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 804
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":276},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexa\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 805
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":277},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexao\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 807
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":279},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonf\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 809
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":281},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 811
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":283},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 813
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":285},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e ra\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 814
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":286},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raq\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 820
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":292},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 821
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":293},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 822
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":294},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da q\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 834
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":308},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 835
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":309},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para e\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 836
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":310},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para ex\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 839
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":313},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemp\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 840
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":314},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exempl\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 842
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":316},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplem\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 840
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":318},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exempl\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 841
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":319},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemple\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 840
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":320},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exempl\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 841
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":321},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exempli\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 847
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":327},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 853
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":333},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 857
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":334},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\n\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 858
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":335},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nF\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 859
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":336},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFe\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 861
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":338},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFeli\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 864
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":341},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 868
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":345},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe test\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 873
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":350},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 878
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":355},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o compo\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 876
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":357},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o com\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 881
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":362},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comporta\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 890
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":371},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 893
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":374},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do mpo\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 891
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":376},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do m\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 892
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":377},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do mo\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 890
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":379},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 893
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":382},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do pon\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 899
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":388},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 904
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":393},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entra\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 907
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":396},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 909
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":398},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada re\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 914
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":403},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retorna\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 918
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":407},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 919
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":408},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 920
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":409},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 922
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":411},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 924
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":413},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. em\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 922
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":415},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 926
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":419},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 929
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":422},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 930
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":423},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg.\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 931
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":424},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 935
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":428},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que \r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 937
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":430},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que so\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 938
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":431},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que sol\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 939
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":432},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que solu\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 940
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":433},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que soluc\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 941
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":434},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que soluci\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 949
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":442},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que solucionou o p\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 953
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":446},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que solucionou o probl\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 954
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":447},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que solucionou o proble\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 957
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":450},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que solucionou o problema.\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 149
{"jsonrpc":"2.0","id":41,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":42,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":43,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":44,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 149
{"jsonrpc":"2.0","id":45,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"fsencoding","value":"cp1252"}}}
Content-Length: 147
{"jsonrpc":"2.0","id":46,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"autocomplete","value":"LS"}}}
Content-Length: 154
{"jsonrpc":"2.0","id":47,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"notificationlevel","value":"none"}}}
Content-Length: 146
{"jsonrpc":"2.0","id":48,"method":"$totvsserver/changeSetting","params":{"changeSettingInfo":{"scope":"advpls","key":"linter","value":"enabled"}}}
Content-Length: 76
{"jsonrpc":"2.0","method":"$/setTraceNotification","params":{"value":"off"}}
Content-Length: 163
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/10_LIB/MSupPesq.prw"}}}
Content-Length: 919
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/03_CONEX%C3%83ONFE/MT140SAI.prw","languageId":"advpl","version":1,"text":"/* ####################################################################### *\\\r\n|| #           PONTO DE ENTRADA UTILIZADO PELO IMPORTADOR CONEXÃONFE     # ||\r\n|| #                                                                     # ||\r\n|| #    É EXECUTADO NO FINAL DA INCLUSÃO DE UMA PRÉ-NOTA PARA ATUALIZAR  # ||\r\n|| #     A SITUAÇÃO DO XML E GERAR O ARQUIVO JSON COM CONEXÃONF-E        # ||\r\n\\* ####################################################################### */\r\n\r\nUser Function MT140SAI()\r\n\r\n    // Deve ser chamado como primeira instrução. \r\n    U_GTPE016()\r\n\r\n    // Regras já existentes ou novas devem ficar abaixo deste ponto. \r\n\r\nReturn Nil \r\n"}}}
Content-Length: 372
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"git:/d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/03_CONEX%C3%83ONFE/MT140SAI.prw?%7B%22path%22%3A%22d%3A%5C%5CTOTVS%2012%5C%5CMicrosiga%5C%5CProtheus%5C%5CProjetoVSCode%5C%5C03_CONEX%C3%83ONFE%5C%5CMT140SAI.prw%22%2C%22ref%22%3A%22~%22%7D","languageId":"advpl","version":1,"text":""}}}
Content-Length: 175
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/03_CONEX%C3%83ONFE/MT140SAI.prw"}}}
Content-Length: 330
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"git:/d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/03_CONEX%C3%83ONFE/MT140SAI.prw?%7B%22path%22%3A%22d%3A%5C%5CTOTVS%2012%5C%5CMicrosiga%5C%5CProtheus%5C%5CProjetoVSCode%5C%5C03_CONEX%C3%83ONFE%5C%5CMT140SAI.prw%22%2C%22ref%22%3A%22~%22%7D"}}}
Content-Length: 110149
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO_NOVO_COMERCIAL/MT410TOK.prw","languageId":"advpl","version":1,"text":"#INCLUDE \"rwmake.ch\"\r\n#INCLUDE \"protheus.ch\"\r\n#INCLUDE \"topconn.ch\"\r\n\r\n/*\r\nPrograma ...: MT410TOK.Prw\r\nUso ........: Validação do pedido de vendas\r\nData .......: 26/04/2019\r\nFeito por ..: Bruno Lage Ferreira \r\n\r\nMV_NDESCTP - DESCONTO NO PREÇO DE LISTA E UNITARIO\r\nNOVO\r\n*/\r\n\r\nUser Function MT410TOK()\r\n****************************************************************************************************************\r\n*   /* Programa para validar o pedido de venda tabela de preço de chapas - Qualitá */\r\n*\r\n****\r\nLocal   lRet      := .T.\r\nLocal   oProcess\r\nLocal   nOpc      := PARAMIXB[1]\r\nLocal   cQuery    := \"\"\r\nDefault lEnd      := .F.\r\n\r\n\r\nIf SubString(CNUMEMP,1,2) == \"01\" .And. (INCLUI == .T. .Or. nOpc == 1 .OR. ALTERA == .T.) .AND. (FUNNAME() <> \"GROA001\")\r\n\r\n\ta410Recalc()\r\n\r\n\toProcess := MsNewProcess():New({|lEnd| lRet := MValidPedV(@oProcess, @lEnd,@lRet) },\"Validando dados..\",\"Lendo Registros do Pedido de Vendas\",.T.) \r\n\tIf !IsBlind()     \r\n\t\tIf nOpc == 1 \r\n\t\t\tIf !Empty(M->C5_XIDMOB)\r\n\t\t\t\t\r\n\t\t\t\tcQuery := \"SELECT MAX(ZSA_IDMOB) ID FROM ZSA010 WHERE D_E_L_E_T_ =\t'' AND  ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\"'\"\r\n\t\t\t\ttcQuery cQuery alias TRB_EMOB new\r\n\t\t\t\tdbSelectArea(\"TRB_EMOB\")\r\n\t\t\t\tdbgotop()\r\n\r\n\t\t\t\tIf !EMPTY(TRB_EMOB->ID)\r\n\t\t\t\t\tAlert(\"Este P.Venda deve ser excluído pelo MogGran!\")\r\n\t\t\t\t\tdbSelectArea(\"TRB_EMOB\") \r\n\t\t\t\t\tdbCloseArea()\r\n\t\t\t\t\tReturn(.f.)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(\"TRB_EMOB\") \r\n\t\t\t\tdbCloseArea()\r\n\r\n\t\t\tEndIF\r\n\t\tEndIf\r\n\t\toProcess:Activate()\r\n\telse\r\n\t\tlRet := MValidPedV(nil, @lEnd,@lRet)\r\n\tEndIf\r\nEndIf\r\n\r\nReturn(lRet)\r\n\r\nUser Function M410LIOK()\r\n****************************************************************************************************************\r\n*    Libera ou bloquea linha do pedido de venda \r\n*\r\n****\r\nLocal lRet   := .T.\r\nLocal cQuery := \"\"\r\n\r\n/*\r\nLinhaOk\r\n*/\r\nIf SubString(CNUMEMP,1,2) == \"01\" \r\n\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",n))) ,1,2) $ 'BL' .AND. u_MTSOEST(GdFieldGet(\"C6_TES\",n)) \r\n\t\tIf Empty(GdFieldGet(\"C6_LOTECTL\",n))\r\n\t\t\tAlert(\"ERRO! BLOCO SEM LOTE!\")\r\n\t\t\tlRet := .F.\r\n\t\tEndIf\r\n\tEndIf\r\n\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",n))) ,1,2) $ 'CH' .AND. (Empty(GdFieldGet(\"C6_LOTECTL\",n)) .OR. Empty(GdFieldGet(\"C6_NUMLOTE\",n)))  \r\n\t\tAlert(\"ERRO! CHAPA COM LOTE OU SUB-LOTE EM BRANCO!\")\r\n\t\tlRet := .F.\r\n\tEndIf\r\nEndIf\r\n\r\n\r\n/*\r\nValida mobGran\r\n*/\r\ncQuery  := \" SELECT ZSA_PRCDES FROM ZSA010\r\ncQuery  += \"  WHERE D_E_L_E_T_ = ''\r\ncQuery  += \"  AND ZSA_PRCDES <> 0\r\n//cQuery  += \"  AND ZSA_STATUS = 'ATIVA'\r\ncQuery  += \"  AND ZSA_IDMOBP = '\"+ AllTrim(M->C5_XIDMOB)                    +\"'\r\ncQuery  += \"  AND ZSA_NUMCAV = '\"+ AllTrim(GdFieldGet(\"C6_YCAVALE\",n))      +\"'\r\ncQuery  += \"  AND ZSA_PROD   = '\"+ AllTrim(GdFieldGet(\"C6_PRODUTO\",n))      +\"'\r\ncQuery  += \"  AND ZSA_CLASSI = '\"+ AllTrim(GdFieldGet(\"C6_YCLASSI\",n))      +\"'\r\ncQuery  += \"  AND ZSA_LOTE   = '\"+ AllTrim(GdFieldGet(\"C6_LOTECTL\",n))      +\"'\r\n\r\ntcQuery cQuery alias TRB new\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\n\r\nIf !EMPTY(TRB->ZSA_PRCDES)\r\n\tGdFieldPut(\"C6_XOFERTA\",'S')\r\nEndIf\r\n\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n\r\n\r\nReturn(lRet)\r\n\r\nUser Function MTSOEST(cCodTes)\r\n****************************************************************************************************************\r\n*    Libera ou bloquea linha do pedido de venda \r\n*\r\n****\r\nLocal lRet := .F.\r\n\r\ndbSelectArea(\"SF4\")\r\ndbSetOrder(1)\r\ndbSeek(xFilial(\"SF4\") + cCodTes)\r\n\r\nIf SF4->F4_ESTOQUE == \"S\"\r\n\tlRet := .T.\r\n\tConOut(\"MTSOEST\" +\"|\"+ cCodTes +\"|\"+ \".T.\" )\r\nElse\r\n\tConOut(\"MTSOEST\" +\"|\"+ cCodTes +\"|\"+ \".F.\" )\r\n\tlRet := .F.\r\nEndIf\r\n\r\nReturn(lRet)\r\n\r\nUser Function GM410FIM()\r\n****************************************************************************************************************\r\n*    Libera ou bloquea pedido de venda M410STTS \r\n*\r\n****\r\nLocal lLibBlq  := .F.\r\nLocal lCalcPeso:= .F.\r\nLocal cQuery   := \"\"\r\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\r\nlOCAL nX       := 0\r\n\r\nIf SubString(CNUMEMP,1,2) == \"01\"  .AND. (FUNNAME() <> \"GROA001\")\r\n\tFor nX := 1 To Len(aCols)\r\n\t\tIf !Empty(GdFieldGet(\"C6_XMOTBLQ\",nX)) .OR. !Empty(M->C5_XMOTBLQ)\r\n\t\t\tlLibBlq   := .T.\r\n\t\tEndIf\r\n\t\t\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\t\t\r\n\t\t\tlCalcPeso := .T.\r\n\t\tEndIf\r\n\tNext nX\r\n\t\r\n\tIf lLibBlq   \r\n\t\tRecLock(\"SC5\",.F.)\r\n\t\t\tSC5->C5_BLQ  := '1'\r\n\t\tMsUnlock()\t\r\n\tEndif\r\n\r\n\tIf  M->C5_TIPO $ \"D/B\"\r\n\t\tRecLock(\"SC5\",.F.)\r\n\t\t\tSC5->C5_BLQ  := ''\r\n\t\tMsUnlock()\t\r\n\tEndIf \r\n\r\n\tIf lCalcPeso\r\n\t\r\n\t\t//Soma dos pesos brutos e liquido\r\n\t\tcQuery   := \" SELECT\tROUND(SUM(B8_YPESOLQ) + SUM(PESO_AMOSTRAS),3) PLQ, \r\n\t\tcQuery   += \" \t\t    ROUND(SUM(B8_YPESOBR) + SUM(PESO_AMOSTRAS),3) PBR \r\n\t\tcQuery   += \" FROM (\r\n\t\tcQuery   += \" SELECT\t\tISNULL(ZGO.ZGO_INVOIC,'') AS ZGO_INVOIC, \r\n\t\tcQuery   += \" \t\t\tTAB_PROFORMA.* FROM (\r\n\t\tcQuery   += \" \t\t\t SELECT\tRTRIM(LTRIM(C5_NUM)) AS C5_NUM,\r\n\t\tcQuery   += \" \t\t\t\t\tYEAR(CAST(C5_EMISSAO AS DATE) )ANO,\r\n\t\tcQuery   += \" \t\t\t\t\tCAST(C5_EMISSAO AS DATE) AS C5_EMISSAO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_NOME)) AS A1_NOME,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_END)) AS A1_END,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_BAIRRO)) AS A1_BAIRRO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDI)) AS A1_DDI,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDD)) AS A1_DDD,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_TEL)) AS A1_TEL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_CONTATO)) AS A1_CONTATO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A3_NOME)) AS A3_NOME,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(YA_PAIS_I)) AS YA_PAIS_I,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XSEAL)) AS C5_XSEAL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XBOOKIN)) AS C5_XBOOKIN,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVESSEL)) AS C5_XVESSEL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XCONTAI)) AS C5_XCONTAI,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTARE)) AS C5_XTARE,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPO)) AS C5_XPO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_LOTECTL)) AS C6_LOTECTL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_NUMLOTE)) AS C6_NUMLOTE,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_CF,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_XPESO AS PESO_AMOSTRAS,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YESPLIQ * 100 AS C6_YESPLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(B5_YCEMEIN)) AS C6_DESCRI, \r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_DESCRI))  AS C6_DESCRI_P, \r\n\t\tcQuery   += \" \t\t\t\t\tIIF(RTRIM(LTRIM(C6_YCAVALE))='','-',RTRIM(LTRIM(C6_YCAVALE)))  AS C6_YCAVALE,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_PRCVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tROUND(C6_PRCVEN / 10.764,2) AS PRCVEN_SQFT,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XVLRFIN AS VALOR_FINANCEIRO,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_QTDVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_NUMLOTE<>'',1,0) AS QTD_CHAPAS,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',0,C6_QTDVEN) AS QTD_TOTAL_FATURAR,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='M2',C6_QTDVEN,0) AS QTD_TOTAL_M2,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='PC',C6_QTDVEN,0) AS QTD_TOTAL_PC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_UM,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_UNSVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_VALOR,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',C6_VALOR,0) AS SAMPLE_DESC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_VALDESC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YCOMLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YALTLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YTOTLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOLQ FROM SB8010 WHERE D_E_L_E_T_ = '' AND C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO AND B8_LOCAL = C6_LOCAL) ,0) AS  B8_YPESOLQ,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOBR FROM SB8010 WHERE D_E_L_E_T_ = '' AND C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO AND B8_LOCAL = C6_LOCAL) ,0) AS  B8_YPESOBR,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XTESALE,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVALEXT)) AS C5_XVALEXT,\r\n\t\tcQuery   += \" \t\t\t\t\tUPPER(ISNULL(CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), C5_YOBSEXT)),'')) AS C5_YOBSEXT,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESING))  AS E4_DESING,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESCRI))  AS E4_DESPOR,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPORTLO)) AS C5_XPORTLO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTPCONT)) AS C5_XTPCONT,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XINSURA)) AS C5_XINSURA,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFIMDES)) AS C5_XFIMDES,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFRFORW)) AS C5_XFRFORW,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XWLIMIT,\r\n\t\tcQuery   += \" \t\t\t\t\tCASE \r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'S' THEN 'STANDARD'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'C' THEN 'COMMERCIAL'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'P' THEN 'PREMIUM'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = '' AND C6_CF='7949' THEN 'SAMPLE'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = ''  THEN '' \r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'A' THEN 'SAMPLE'\r\n\t\tcQuery   += \" \t\t\t\t\tEND C6_YCLASSI,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XTOTAL,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XDESCON,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XPDESTI,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT B8_LOTEFOR FROM SB8010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = '' AND SUBSTRING(B8_PRODUTO,1,2) ='BL' ),'') AS LOTE_FORNECEDOR\r\n\t\tcQuery   += \" \t\t\t FROM SC6010 SC6 INNER JOIN SC5010 SC5\r\n\t\tcQuery   += \" \t\t\t\t   ON (C6_FILIAL = C5_FILIAL AND C6_NUM = C5_NUM )\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA1010 SA1\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_COD = C5_CLIENTE AND A1_LOJA = C5_LOJACLI )\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SYA010 SYA\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_PAIS = YA_CODGI)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA3010\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_VEND=A3_COD)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SB5010 SB5\r\n\t\tcQuery   += \" \t\t\t\t   ON (C6_PRODUTO = B5_COD)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SE4010 SE4\r\n\t\tcQuery   += \" \t\t\t\t   ON (E4_CODIGO = C5_CONDPAG)\r\n\t\tcQuery   += \" \t\t\t WHERE SC6.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SC5.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SA1.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SYA.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SB5.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SE4.D_E_L_E_T_ = ''\r\n\t\t//cQuery   += \" \t\t\t   AND SC5.C5_BLQ <> '1'\r\n\t\tcQuery   += \" \t\t\t   AND C5_NUM = '\"+SC5->C5_NUM+\"'\r\n\t\tcQuery   += \" )TAB_PROFORMA\r\n\t\tcQuery   += \" \t FULL OUTER JOIN ZGO010 ZGO\r\n\t\tcQuery   += \" \t   ON (C5_NUM = ZGO_PEDIDO)\r\n\t\tcQuery   += \" WHERE C5_NUM <> ''\r\n\t\tcQuery   += \"   AND ISNULL(ZGO_INVOIC,'') LIKE '%%'\r\n\t\tcQuery   += \" )TB_PESO\r\n\t\t                                                          \r\n\t\ttcQuery cQuery alias TRB new\r\n\t\tdbSelectArea(\"TRB\")\r\n\t\tdbgotop()\r\n\t\t\r\n\t\tIF !M->C5_TIPO $ \"D/B\" .And. LEFT(AllTrim(GdFieldGet(\"C6_PRODUTO\",1)),2) <> 'BL'\r\n\t\t\tIF !EOF()\r\n\t\t\t\tdbSelectArea(\"SC5\")\t\t\r\n\t\t\t\tIf RecLock(\"SC5\",.f.)\r\n\t\t\t\t\tReplace SC5->C5_PESOL  With TRB->PLQ\r\n\t\t\t\t\tReplace SC5->C5_PBRUTO With TRB->PBR\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tIF TRB->PLQ > SC5->C5_PBRUTO \r\n\t\t\t\t\t\tAlert(\"Peso bruto esta menor que peso líquido. Favor corrigir!\")\r\n\t\t\t\t\t\tReplace SC5->C5_PBRUTO With 0\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tMsUnLock()\r\n\t\t\t\tEndIf\t\r\n\t\t\tEndIf\r\n\t\tEndIf\t\t\t\t\r\n\t\tdbSelectArea(\"TRB\") \r\n\t\tdbCloseArea()\r\n\t\t\r\n\t\t//Soma da quantidade de bandos\r\n\t\tcQuery   := \" SELECT COUNT(*) QTD FROM (\r\n\t\tcQuery   += \" SELECT DISTINCT C6_YCAVALE FROM (\r\n\t\tcQuery   += \" SELECT\t\tISNULL(ZGO.ZGO_INVOIC,'') AS ZGO_INVOIC, \r\n\t\tcQuery   += \" \t\t\tTAB_PROFORMA.* FROM (\r\n\t\tcQuery   += \" \t\t\t SELECT\tRTRIM(LTRIM(C5_NUM)) AS C5_NUM,\r\n\t\tcQuery   += \" \t\t\t\t\tYEAR(CAST(C5_EMISSAO AS DATE) )ANO,\r\n\t\tcQuery   += \" \t\t\t\t\tCAST(C5_EMISSAO AS DATE) AS C5_EMISSAO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_NOME)) AS A1_NOME,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_END)) AS A1_END,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_BAIRRO)) AS A1_BAIRRO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDI)) AS A1_DDI,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDD)) AS A1_DDD,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_TEL)) AS A1_TEL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_CONTATO)) AS A1_CONTATO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A3_NOME)) AS A3_NOME,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(YA_PAIS_I)) AS YA_PAIS_I,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XSEAL)) AS C5_XSEAL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XBOOKIN)) AS C5_XBOOKIN,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVESSEL)) AS C5_XVESSEL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XCONTAI)) AS C5_XCONTAI,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTARE)) AS C5_XTARE,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPO)) AS C5_XPO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_LOTECTL)) AS C6_LOTECTL,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_NUMLOTE)) AS C6_NUMLOTE,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_CF,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_XPESO AS PESO_AMOSTRAS,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YESPLIQ * 100 AS C6_YESPLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(B5_YCEMEIN)) AS C6_DESCRI, \r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_DESCRI))  AS C6_DESCRI_P, \r\n\t\tcQuery   += \" \t\t\t\t\tIIF(RTRIM(LTRIM(C6_YCAVALE))='','-',RTRIM(LTRIM(C6_YCAVALE)))  AS C6_YCAVALE,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_PRCVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tROUND(C6_PRCVEN / 10.764,2) AS PRCVEN_SQFT,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XVLRFIN AS VALOR_FINANCEIRO,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_QTDVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_NUMLOTE<>'',1,0) AS QTD_CHAPAS,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',0,C6_QTDVEN) AS QTD_TOTAL_FATURAR,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='M2',C6_QTDVEN,0) AS QTD_TOTAL_M2,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='PC',C6_QTDVEN,0) AS QTD_TOTAL_PC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_UM,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_UNSVEN,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_VALOR,\r\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',C6_VALOR,0) AS SAMPLE_DESC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_VALDESC,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YCOMLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YALTLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tC6_YTOTLIQ,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOLQ FROM SB8010 WHERE D_E_L_E_T_ = '' AND  C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO) ,0) AS  B8_YPESOLQ,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOBR FROM SB8010 WHERE D_E_L_E_T_ = '' AND C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO) ,0) AS  B8_YPESOBR,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XTESALE,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVALEXT)) AS C5_XVALEXT,\r\n\t\tcQuery   += \" \t\t\t\t\tUPPER(ISNULL(CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), C5_YOBSEXT)),'')) AS C5_YOBSEXT,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESING))  AS E4_DESING,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESCRI))  AS E4_DESPOR,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPORTLO)) AS C5_XPORTLO,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTPCONT)) AS C5_XTPCONT,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XINSURA)) AS C5_XINSURA,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFIMDES)) AS C5_XFIMDES,\r\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFRFORW)) AS C5_XFRFORW,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XWLIMIT,\r\n\t\tcQuery   += \" \t\t\t\t\tCASE \r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'S' THEN 'STANDARD'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'C' THEN 'COMMERCIAL'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'P' THEN 'PREMIUM'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = '' AND C6_CF='7949' THEN 'SAMPLE'\r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = ''  THEN '' \r\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'A' THEN 'SAMPLE'\r\n\t\tcQuery   += \" \t\t\t\t\tEND C6_YCLASSI,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XTOTAL,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XDESCON,\r\n\t\tcQuery   += \" \t\t\t\t\tC5_XPDESTI,\r\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT B8_LOTEFOR FROM SB8010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = '' AND SUBSTRING(B8_PRODUTO,1,2) ='BL' ),'') AS LOTE_FORNECEDOR\r\n\t\tcQuery   += \" \t\t\t FROM SC6010 SC6 INNER JOIN SC5010 SC5\r\n\t\tcQuery   += \" \t\t\t\t   ON (C6_FILIAL = C5_FILIAL AND C6_NUM = C5_NUM )\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA1010 SA1\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_COD = C5_CLIENTE AND A1_LOJA = C5_LOJACLI )\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SYA010 SYA\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_PAIS = YA_CODGI)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA3010\r\n\t\tcQuery   += \" \t\t\t\t   ON (A1_VEND=A3_COD)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SB5010 SB5\r\n\t\tcQuery   += \" \t\t\t\t   ON (C6_PRODUTO = B5_COD)\r\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SE4010 SE4\r\n\t\tcQuery   += \" \t\t\t\t   ON (E4_CODIGO = C5_CONDPAG)\r\n\t\tcQuery   += \" \t\t\t WHERE SC6.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SC5.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SA1.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SYA.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SB5.D_E_L_E_T_ = ''\r\n\t\tcQuery   += \" \t\t\t   AND SE4.D_E_L_E_T_ = ''\r\n\t  //cQuery   += \"              --AND SC5.C5_BLQ <> '1'\r\n\t\tcQuery   += \" \t\t\t   AND C5_NUM = '\"+SC5->C5_NUM+\"'\r\n\t\tcQuery   += \" \r\n\t\tcQuery   += \" )TAB_PROFORMA\r\n\t\tcQuery   += \" \t FULL OUTER JOIN ZGO010 ZGO\r\n\t\tcQuery   += \" \t   ON (C5_NUM = ZGO_PEDIDO)\r\n\t\tcQuery   += \" WHERE C5_NUM <> ''\r\n\t   //cQuery  += \"   --AND ISNULL(ZGO_INVOIC,'') LIKE '%'+@INVOICE+'%'\r\n\t\tcQuery   += \" )TB_TOTAL_CAV\r\n\t\tcQuery   += \" WHERE C6_YCAVALE <> '-'\r\n\t\tcQuery   += \" )TB_QTD_CAV\r\n\t\t\r\n\t\t\r\n\t\ttcQuery cQuery alias TRB new\r\n\t\tdbSelectArea(\"TRB\")\r\n\t\tdbgotop()\r\n\t\t\r\n\t\tIF !EOF()\r\n\t\t\tdbSelectArea(\"SC5\")\t\t\r\n\t\t\tIf RecLock(\"SC5\",.f.)\r\n\t\t\t\tReplace SC5->C5_VOLUME1  With TRB->QTD  \r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf\t\r\n\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\tdbSelectArea(\"TRB\") \r\n\t\tdbCloseArea()\r\n\t\t\r\n\t\tIf RecLock(\"SC5\",.f.)\r\n\t\t\tIF SC5->C5_VOLUME1 == 0\r\n\t\t\t\tSC5->C5_VOLUME1 := 1\r\n\t\t\tEndIf\r\n\t\t\tMsUnLock()\r\n\t\tEndIf\t\r\n\t\t\r\n\tEndIf\r\n\r\nEndIf\r\n\r\nReturn()\r\n\r\n/*\r\nUser Function MDesTot()\r\n****************************************************************************************************************\r\n*    Programa dar o desconto  \r\n*\r\n****\r\nLocal nValorTemp := 0\r\n\r\nFor nX := 1 To Len(aCols)\r\n\t\tGdFieldPut(\"C6_DESCONT\",M->C5_DESC1,nX) \r\nNext nX\r\n\r\nReturn(.T.) \r\n*/\r\n\r\nStatic Function MValidPedV(oProcess, lEnd,lRet)\r\n****************************************************************************************************************\r\n*   /* Programa para validar o pedido de venda tabela de preço de chapas - Qualitá */\r\n*\r\n****\r\nLocal cQuery := \"\"\r\n\r\nLocal nPosCava := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_YCAVALE\"}) //Cavalete\r\nLocal nPosLOTE := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_LOTECTL\"}) //SubLote\r\nLocal nPosSUBL := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_NUMLOTE\"}) //Lote\r\nLocal nPosLOCA := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_LOCAL\"  }) //Lote\r\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\r\n\r\nLocal fTPBLQ   := .F.\r\n\r\nLocal aMsgPrc  := {}\r\nLoca  nX       := 0\r\n\r\nIf !IsBlind()     \r\n\toProcess:SetRegua1(8)\r\nEndIf\r\n\r\n/*\r\nSomente para Qualitá\r\n*/\r\nConOut(FUNNAME())\r\nIf SubString(CNUMEMP,1,2) == \"01\" .And. (INCLUI == .T. .Or. ALTERA == .T.) .AND. (FUNNAME() <> \"GROA001\")\r\n\r\n\r\n\tM->C5_XMOTBLQ := \"\"\r\n\r\n\t/*\r\n\tSomente para Mercado Externo\r\n\tValidação mercado interno campos FollowUp\r\n\t*/\r\n\tIf M->C5_YTIPO $ \"ME/MI\"\r\n\t\tIF M->C5_XSHOWFO == \"S\"\r\n\t\t\tIf Empty(M->C5_XFOLLST) .Or. Empty(M->C5_XPENDEN) .Or. Empty(M->C5_XDTLIBF)\r\n\t\t\t\tAlert(\"FollowUp='SIM'! O P.Venda não pode ser salvo sem as informações de Pendência/Situação/Data de Liberação. \")\t\r\n\t\t\t\tReturn(.F.)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\tcDesMoed := \"\"\r\n\toFont := TFont():New('Arial Black',,-18,.T.)\r\n\t\r\n\tIf     M->C5_MOEDA == 1\r\n\t\tcDesMoed := \"1 - (R$)   R E A L\"\r\n\tElseIf M->C5_MOEDA == 2\r\n\t\tcDesMoed := \"2 - ($)    D O L A R\"\r\n\tElseIf M->C5_MOEDA == 3\r\n\t\tcDesMoed := \"3 - (€)    E U R O\"\r\n\tEndIf\r\n\t\r\n\tIf !IsBlind()     \r\n\t\tDEFINE MSDIALOG _oDlgMoeda TITLE \"Moeda\" FROM u_MGETTELA(178),u_MGETTELA(181) TO u_MGETTELA(342),u_MGETTELA(577) PIXEL\r\n\t\t\t// Cria as Groups do Sistema\r\n\t\t\t@ u_MGETTELA(001),u_MGETTELA(003) TO u_MGETTELA(062),u_MGETTELA(195) LABEL \"\" PIXEL OF _oDlgMoeda\r\n\t\t\r\n\t\t\t// Cria Componentes Padroes do Sistema\r\n\t\t\t@ u_MGETTELA(009),u_MGETTELA(010) Say \"Pedido sendo salvo na moeda:\" Size u_MGETTELA(075),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgMoeda\r\n\t\t\t@ u_MGETTELA(033),u_MGETTELA(078) Say cDesMoed \t\t\t\t\t\t Size u_MGETTELA(090),u_MGETTELA(080) COLOR CLR_HMAGENTA FONT oFont PIXEL OF _oDlgMoeda\r\n\t\t\t@ u_MGETTELA(064),u_MGETTELA(156) Button \"OK\" ACTION(Close(_oDlgMoeda)) Size u_MGETTELA(037),u_MGETTELA(012) PIXEL OF _oDlgMoeda\r\n\t\tACTIVATE MSDIALOG _oDlgMoeda CENTERED \r\n\tEndIf\r\n\r\n\tConOut(\"******************************************\" )\r\n\tConOut(\"Inicio P.E = MT410TOK Qualitá\" )\r\n\tConOut(\"******************************************\" )\t\r\n\t/*\r\n\t****************************************************************\r\n\tConferencia da tabela de preço com o desconto cadastrado por classificação comercial\r\n\t****************************************************************\r\n\t*/\r\n\tdbSelectArea(\"SA1\")\r\n\tdbSetOrder(1)\r\n\tdbSeek(xFilial(\"SA1\") + M->C5_CLIENTE + M->C5_LOJACLI )\r\n\t\r\n\tIf !Empty(SA1->A1_INFDESC)\r\n\t\tAlert(\"Aviso! Este cliente possui um desconto padrão! Verifique sempre pela tela [F5].\")\r\n\tEndIf\r\n\t\r\n\tIF M->C5_TIPO $ \"D\"\r\n\t\tReturn(.T.)\r\n\tEndIf\r\n\t\r\n\tIf !IsBlind()     \r\n\t\toProcess:IncRegua1(\"[1-8] - Conferência da tabela de preço com o desconto cadastrado!\")  \r\n\tEndIf\r\n\r\n\tFor nX := 1 To Len(aCols)\r\n\t\t/*\r\n\t\tRegra geral de tabela de preços \r\n\t\t*/\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\t\t\t\r\n\t\t\tIf Empty(SA1->A1_TABELA)\r\n\r\n\t\t\t\tIf Empty(GdFieldGet(\"C6_YCLASSI\",nX))\r\n\t\t\t\t\tcClassif := \"P\"\r\n\t\t\t\tElse\r\n\t\t\t\t\tcClassif := AllTrim(GdFieldGet(\"C6_YCLASSI\",nX))\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIf GdFieldGet(\"C6_XOFERTA\",nX) == 'N'\r\n\r\n\t\t\t\t\tcQuery  := \" SELECT DA1_CODTAB,DA0_DESCRI,DA0_DESGER ,DA1_PRCVEN , CASE WHEN DA1_PERDES=0  THEN 1 WHEN DA1_PERDES<>0 THEN DA1_PERDES END  DA1_PERDES \r\n\t\t\t\t\tcQuery  += \"   FROM DA0010 DA0 \r\n\t\t\t\t\tcQuery  += \"        INNER JOIN DA1010 DA1 \r\n\t\t\t\t\tcQuery  += \" ON (DA0_CODTAB = DA1_CODTAB)\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) <> 'AM'\r\n\t\t\t\t\t\tcQuery  += \"  WHERE DA0_YCLASS IN ('\"+ cClassif +\"')\r\n\t\t\t\t\t\tcQuery  += \"    AND DA1_CODPRO = '\" + AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\"\t\t\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tcQuery  += \"  WHERE DA1_CODPRO = '\" + AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\"\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\tIF !EMPTY(SA1->A1_MULTTAB)\r\n\t\t\t\t\t\tcQuery  += \"    AND DA0_CODTAB IN (\"+AllTrim(SA1->A1_MULTTAB)+\")\"\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tcQuery  += \"    AND DA0_CODTAB IN ('000','001','002','003')\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcQuery  += \"    AND DA0.D_E_L_E_T_ = ''\r\n\t\t\t\t\tcQuery  += \"    AND DA1.D_E_L_E_T_ = ''\r\n\t\t\t\t\t\r\n\t\t\t\t\ttcQuery cQuery alias TRB new\r\n\t\t\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\t\t\tdbgotop()\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Empty(TRB->DA1_PRCVEN) .and. !GDDeleted(nX) \r\n\t\t\t\t\t\tAlert(\"[C6_PRCVEN] - Tabela de preço não encontrada! Linha:(\" + Alltrim(str(nX)) +\") Confira a classif. do produto ou Mult.Tabelas preços no Cad. Cliente.\" )\r\n\t\t\t\t\t\tlRet := .F. \r\n\t\t\t\t\t\t//sleep(300)\t\r\n\t\t\t\t\t\tM->C5_BLQ  := '1'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t//If GdFieldGet(\"C6_PRCVEN\",nX) <  IIF(cClassif==\"P\",((TRB->DA1_PRCVEN - TRB->DA0_DESGER)),((TRB->DA1_PRCVEN * TRB->DA0_DESGER))) .and. !GDDeleted(nX)\r\n\t\t\t\t\tIf GdFieldGet(\"C6_PRCVEN\",nX) <  IIF(cClassif==\"P\",((TRB->DA1_PRCVEN - TRB->DA0_DESGER)),((TRB->DA1_PRCVEN))) .and. !GDDeleted(nX)\r\n\t\t\t\t\t\t//aAdd(aMsgPrc,\"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + Alltrim(str(nX))+\" Tabela de Preço:\" + AllTrim(TRB->DA1_CODTAB) + \"-\"+ AllTrim(TRB->DA0_DESCRI))  \r\n\t\t\t\t\t\taAdd(aMsgPrc,\"Cavalete:\"+GdFieldGet(\"C6_YCAVALE\",nX)+\" Tabela de Preço:\" + AllTrim(TRB->DA1_CODTAB) + \"-\"+ AllTrim(TRB->DA0_DESCRI) )\r\n\t\t\t\t\t\t//lRet := .F.\r\n\t\t\t\t\t\tConOut(\"******************************************\")\r\n\t\t\t\t\t\tConOut(\"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + Alltrim(str(nX)))\r\n\t\t\t\t\t\tConOut(\"******************************************\")\r\n\t\t\t\t\t\t//sleep(300)\r\n\t\t\t\t\t\tM->C5_BLQ  := '1'\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"PREÇO MENOR QUE A TABELA DE PREÇO:\"+ AllTrim(TRB->DA1_CODTAB),nX)\t\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tGdFieldPut(\"C6_PRCREF\",TRB->DA1_PRCVEN,nX)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\t\tdbCloseArea()\r\n\t\t\t\telse\r\n\t\t\t\t\tM->C5_BLQ  := ''\r\n\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIF lRet == .F. .And. !IsBlind()  \r\n\t\t\t\t\tReturn(lRet) \r\n\t\t\t\tEndIf\r\n\t\t\tElse\r\n\t\t\t\t/*\r\n\t\t\t\tUsado para definir uma tabela de preço especifica para o cliente\r\n\t\t\t\t*/\r\n\t\t\t\tIf GdFieldGet(\"C6_XOFERTA\",nX) == 'N'\r\n\t\t\t\t\r\n\t\t\t\t\tcQuery  := \" SELECT DA1_CODTAB,DA0_DESCRI,DA0_DESGER,DA1_PRCVEN , CASE WHEN DA1_PERDES=0  THEN 1 WHEN DA1_PERDES<>0 THEN DA1_PERDES END  DA1_PERDES\r\n\t\t\t\t\tcQuery  += \"   FROM DA0010 DA0 \r\n\t\t\t\t\tcQuery  += \"        INNER JOIN DA1010 DA1 \r\n\t\t\t\t\tcQuery  += \" ON (DA0_CODTAB = DA1_CODTAB)\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) <> 'AM'\r\n\t\t\t\t\t\tcQuery  += \"  WHERE DA1_CODTAB IN ('\"+ M->C5_TABELA +\"')\r\n\t\t\t\t\t\tcQuery  += \"    AND DA1_CODPRO = '\"+AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\t//TABELA PADRÃO DE AMOSTRAS\r\n\t\t\t\t\t\tcQuery  += \"  WHERE DA1_CODPRO = '\"+AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\r\n\t\t\t\t\t\tcQuery  += \"    AND DA0_CODTAB IN ('000')\r\n\t\t\t\t\tEndIf-\r\n\t\t\t\r\n\t\t\t\t\tcQuery  += \"    AND DA0.D_E_L_E_T_ = ''\r\n\t\t\t\t\tcQuery  += \"    AND DA1.D_E_L_E_T_ = ''\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\ttcQuery cQuery alias TRB new\r\n\t\t\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\t\t\tdbgotop()\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf Empty(TRB->DA1_PRCVEN) .and. !GDDeleted(nX)\r\n\t\t\t\t\t\tAlert(\"[C6_PRCVEN] - Tabela de preço não encontrada! Linha:(\" + Alltrim(str(nX)) +\") Confira a classif. do produto ou Mult.Tabelas preços no Cad. Cliente.\" )\r\n\t\t\t\t\t\tlRet := .F.\r\n\t\t\t\t\t\t//sleep(300)\r\n\t\t\t\t\t\tM->C5_BLQ  := '1'\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tIf GdFieldGet(\"C6_PRCVEN\",nX) <  TRB->DA1_PRCVEN .and. !GDDeleted(nX)\r\n\t\t\t\t\t\taAdd(aMsgPrc,\"Cavalete:\"+GdFieldGet(\"C6_YCAVALE\",nX)+\" Tabela de Preço:\" + AllTrim(TRB->DA1_CODTAB) + \"-\"+ AllTrim(TRB->DA0_DESCRI) ) \r\n\t\t\t\t\t\t//lRet := .F.\r\n\t\t\t\t\t\tConOut(\"******************************************\" )\r\n\t\t\t\t\t\tConOut(\"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + Alltrim(str(nX)))\r\n\t\t\t\t\t\tConOut(\"******************************************\" )\r\n\t\t\t\t\t\t//sleep(300)\t\r\n\t\t\t\t\t\tM->C5_BLQ  := '1'\r\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"Preço menor que a tabela:\"+ AllTrim(TRB->DA1_CODTAB),nX)\t\r\n\t\t\t\t\tELSE\r\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\r\n\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\tGdFieldPut(\"C6_PRCREF\",TRB->DA1_PRCVEN,nX)\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\t\tdbCloseArea()\r\n\t\t\t\tElse\r\n\t\t\t\t\tM->C5_BLQ  := ''\r\n\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\t\tReturn(lRet) \r\n\t\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\t\r\n\t\tEndIf\r\n\tNext nX\r\n\t\r\n\tcMSG := \"\"\r\n\t\r\n\tFor nX:=1 to Len(aMsgPrc)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\r\n\t\t\tcMSG += aMsgPrc[nX] + chr(13)+chr(10)   \r\n\tNext nX\r\n\t\r\n\t\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)  \r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\tEndIf\r\n\t\r\n\t\r\n\t/*\r\n\t***************************************************************************************\r\n\tVerifica o erro do saldo no cavalete e no pedido \r\n\t***************************************************************************************\r\n\t\r\n\tnQtdPedVend := 0\r\n\t\r\n\tFor nX := 1 To Len(aCols)\r\n\t\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\r\n\t\tnQtdPedVend := GdFieldGet(\"C6_QTDVEN\",nX))\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \r\n\t\t\tIf !GDDeleted(nX)\r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\tNext nX\r\n\t*/\r\n\t\r\n\tConOut(\"******************************************\" )\r\n\tConOut(\"P.E = MT410TOK Qualitá Validação de cavaletes\" )\r\n\tConOut(\"******************************************\" )\r\n\r\n\t/*\r\n\t****************************************************************\r\n\tConferencia do cavaletes duplicados no proprio pedido \r\n\t****************************************************************\r\n\t*/\r\n\taNumCav \t:= {}\t\t\r\n\taTodCav \t:= {}\r\n    aGriCav \t:= {}\r\n    aGriCavDup \t:= {}\r\n    aGriLSPv    := {}\r\n    aLSPvLoca   := {}\t\r\n    aCavZero    := {}\r\n    aNumCavPro  := {}\r\n\taCavBenef   := {}\r\n    \r\n\tFor nX := 1 To Len(aCols)\r\n\t\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\r\n\t\t//ALERT(SB1->B1_COD +\"||\"+ SB1->B1_GRUPO)\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \r\n\t\r\n\t\t\tIf !Empty(GdFieldGet(\"C6_YCAVALE\",nX)) .and. !GDDeleted(nX) \r\n\t\t\t\tIf Empty( aScan(aNumCav,GdFieldGet(\"C6_YCAVALE\",nX)) )\r\n\t\t\t\t \taAdd(aNumCav   ,GdFieldGet(\"C6_YCAVALE\",nX))\r\n\t\t\t\t \taAdd(aNumCavPro,{GdFieldGet(\"C6_YCAVALE\",nX),GdFieldGet(\"C6_PRODUTO\",nX)})\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\tIf !GDDeleted(nX)\r\n\t\t\t\tIf Empty(aScan(aGriCav,AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) + GdFieldGet(\"C6_YCAVALE\",nX) + GdFieldGet(\"C6_LOTECTL\",nX) + GdFieldGet(\"C6_NUMLOTE\",nX)) )\r\n\t\t\t\t\taAdd(aGriCav , AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) + GdFieldGet(\"C6_YCAVALE\",nX) + GdFieldGet(\"C6_LOTECTL\",nX) + GdFieldGet(\"C6_NUMLOTE\",nX)  )\r\n\t\t\t\t\taAdd(aGriLSPv, {GdFieldGet(\"C6_LOTECTL\",nX) , GdFieldGet(\"C6_NUMLOTE\",nX) , AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))} )\r\n\t\t\t\tElse\r\n\t\t\t\t\tIF LEFT(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)),2)<>'AM'\r\n\t\t\t\t\t\taAdd(aGriCavDup, AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+GdFieldGet(\"C6_YCAVALE\",nX) + GdFieldGet(\"C6_LOTECTL\",nX) + GdFieldGet(\"C6_NUMLOTE\",nX)  )\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tEndIf\r\n\t\t\r\n\tNext nX\r\n\t\r\n\tcMSG := \"\"\r\n\tFor nX:=1 to Len(aGriCavDup)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Duplicados no pedido atual:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\r\n\t\t\tcMSG += \"O item: \" + aGriCavDup[nX] + chr(13)+chr(10)   \r\n\tNext nX\r\n\t\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\tlRet := .F.\r\n\t\t\r\n\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\tReturn(lRet) \r\n\t\tEndIf\r\n\tEndIf\r\n\t\r\n\t/*\r\n\t****************************************************************\r\n\tConferencia se todos os itens do cavales estao completos (Se estiverem em cavaletes)\r\n\tCavalete apagado por completo\r\n\tA mesma rotina confere se existe produtos sem saldo.\r\n\t****************************************************************\r\n\t*/\r\n\tIf !IsBlind()     \r\n\t\toProcess:IncRegua1(\"[2-8] - Teste de cavales completos,apagados e sem saldo!\")\r\n\tEndIf\r\n\r\n\t/*\r\n\tSOMENTE SE O PEDIDO NAO ESTIVER FATURADO \r\n\t*/\r\n\tIF LEN(AllTrim(M->C5_NOTA)) <> 9\r\n\t\r\n\t\t/*\r\n\t\tVALIDAÇÃO DO CAMPO DA ULTIMA ATUALIZAÇÃO DO FOLLOWUP\r\n\t\t*/\r\n\t\tM->C5_XULDTAU := DDATABASE\r\n\r\n\t\tFor nX := 1 To Len(aNumCavPro)\r\n\t\t\r\n\t\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSeek(xFilial(\"SB1\")+ aNumCavPro[nX][2] )\r\n\t\t\t\r\n\t\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\t\r\n\t\t\t \tcQuery  := \"  SELECT B8_PRODUTO,B1_DESC,B8_YCAVALE,B8_LOTECTL,B8_NUMLOTE,B8_YCAVALE+B8_LOTECTL+B8_NUMLOTE+B8_LOCAL CHAVE,B8_LOCAL,B8_SALDO \r\n\t\t\t \tcQuery  += \"    FROM SB8010 SB8 INNER JOIN SB1010 SB1 ON (B8_PRODUTO = B1_COD)\r\n\t\t\t \tcQuery  += \"   WHERE SB8.D_E_L_E_T_ = ''\r\n\t\t\t \tcQuery  += \"     AND SB1.D_E_L_E_T_ = ''\r\n\t\t\t \tcQuery  += \"     AND B8_YCAVALE = '\"+aNumCavPro[nX][1]+\"'\r\n\t\t\t \tcQuery  += \"     AND B8_PRODUTO = '\"+aNumCavPro[nX][2]+\"'\r\n\t\t\t \tcQuery  += \"     AND B8_ORIGLAN = 'BD'\r\n\t\t\t \tcQuery  += \"     AND B8_SALDO   <> 0\r\n\t\t\t \t\r\n\t\t\t \ttcQuery cQuery alias TRB new\r\n\t\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\t\tdbgotop()\r\n\t\t\t\tDo While !EOF()\r\n\t\t\t\t\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tcavaletes incompletos\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIF !aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE })  \r\n\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE , TRB->B8_LOCAL} )\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tif GDDeleted(aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE }))\r\n\t\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE,TRB->B8_LOCAL} )\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\t/*\r\n\t\t\t\t\tSem Saldo\r\n\t\t\t\t\t*/\r\n\t\t\t\t\tIf TRB->B8_SALDO == 0  \r\n\t\t\t\t\t\taAdd(aCavZero,{ TRB->CHAVE ,AllTrim(TRB->B8_PRODUTO)+\"-\"+ AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE, TRB->B8_LOCAL} )\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\t\tdbSkip()\r\n\t\t\t\tEndDo\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t/*\r\n\t\t\t\tCavalete apagado\r\n\t\t\t\t*/\r\n\t\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\t\tdbgotop()\r\n\t\t\t\tIf EOF() .And.  !Empty(aNumCav[nX])\r\n\t\t\t\t\r\n\t\t\t\t\tIF !aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE })  \r\n\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE, TRB->B8_LOCAL} )\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tif GDDeleted(aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE }))\r\n\t\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE , TRB->B8_LOCAL} )\r\n\t\t\t\t\t\tEndIf \r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\tdbCloseArea()\r\n\t\t\tEndIf\r\n\r\n\r\n\t\t\t/*\r\n\t\t\tCavalete em beneficiamento não pode \r\n\t\t\tProibe\r\n\t\t\t*/\r\n\t\t\tIf aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] }) <> 0 .AND. M->C5_TIPO = 'B'\r\n\t\t\t\taAdd(aCavBenef,{ aNumCavPro[nX][1] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][3] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][5] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][10] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][36] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][24]} )\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tNext nX\r\n\r\n\r\n\t\tcMSG := \"\"\r\n\r\n\t\t/*\r\n\t\tBeneficiamento\r\n\t\t*/\t\t\r\n\t\tFor nX:=1 to Len(aCavBenef)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Pedido de Beneficiamento com cavaletes:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\t\t\t\r\n\t\t\tcMSG +=     \"  ->\" + AllTrim(aCavBenef[nX][2]) + \" Cav.[\" + Alltrim(aCavBenef[nX][3]) + \"] Lote[\" + Alltrim(aCavBenef[nX][4]) + \"] SubLote[\" + Alltrim(aCavBenef[nX][5]) + \"] Local [\"+ Alltrim(aCavBenef[nX][6]) +\"].\"+ chr(13)+chr(10)   \r\n\t\tNext nX\r\n\r\n\t\t/*\r\n\t\tIncompletos/Apagado\r\n\t\t\r\n\t\tFor nX:=1 to Len(aTodCav)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Cavaletes incompletos/Apagado:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\t\t\t\r\n\t\t\tcMSG +=     \"  ->\" + AllTrim(aTodCav[nX][2]) + \" Cav.[\" + Alltrim(aTodCav[nX][3]) + \"] Lote[\" + Alltrim(aTodCav[nX][4]) + \"] SubLote[\" + Alltrim(aTodCav[nX][5]) + \"] Local [\"+ Alltrim(aTodCav[nX][6]) +\"].\"+ chr(13)+chr(10)   \r\n\t\tNext nX\r\n\t\t*/\r\n\t\tIf !Empty(cMSG)\r\n\t\t\tAlert(cMSG)\r\n\t\t\t//AVISO(\"Cavaletes incompletos:\", cMSG , { \"Fechar\" }, 3)\r\n\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\tlRet := .F.\r\n\r\n\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\tReturn(lRet)\r\n\t\t\tEndIf \r\n\t\tEndIf\r\n\t\r\n\t\t/*\r\n\t\tSem Saldo\r\n\t\t*/\r\n\t\tcMSG := \"\"\r\n\t\tFor nX:=1 to Len(aCavZero)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Produtos sem saldo:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\t\t\t\r\n\t\t\tcMSG +=     \"  ->\" + AllTrim(aCavZero[nX][2]) + \" Cav.[\" + Alltrim(aCavZero[nX][3]) + \"] Lote[\" + Alltrim(aCavZero[nX][4]) + \"] SubLote.[\" + Alltrim(aCavZero[nX][5]) + \"]\"+ chr(13)+chr(10)   \r\n\t\tNext nX\r\n\t\t\r\n\t\tIf !Empty(cMSG)\r\n\t\t\tIF (!Empty(C5_NOTA).Or.C5_LIBEROK=='E' .And. Empty(C5_BLQ))\r\n\t\t\t\tAlert(cMSG)\r\n\t\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\tELse \r\n\t\t\t\tAlert(cMSG)\r\n\t\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\t\t\r\n\t\t\t\tlRet := .F.\r\n\r\n\t\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\t\tReturn(lRet)\r\n\t\t\t\tEndIf \r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\tEndIf\r\n\t\r\n\t/*\r\n\t****************************************************************\r\n\tConferencia se existe estes Lote/SubLotes em um PVenda salvo\r\n\t****************************************************************\r\n\t*/\r\n\tIf !IsBlind()     \r\n\t\toProcess:IncRegua1(\"[3-8] - Conferência se existe  Lote/SubLotes em um P.Venda salvo!\")\r\n\tENDIF\r\n\r\n\tFor nX := 1 To Len(aGriLSPv)\r\n\t\t \t\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(aGriLSPv[nX][3]) )\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec .AND. !Empty(aGriLSPv[nX][1])\r\n\t\t \tcQuery  := \" SELECT C6_NUM,C6_ITEM,C6_LOTECTL,C6_NUMLOTE ,C6_DESCRI \r\n\t\t \tcQuery  += \"   FROM SC6010 SC6 INNER JOIN SC5010 SC5 ON (C5_FILIAL = C6_FILIAL AND C5_NUM = C6_NUM)\r\n\t\t \tcQuery  += \"  WHERE SC6.D_E_L_E_T_ = ''\r\n\t\t \tcQuery  += \"    AND SC5.D_E_L_E_T_ = ''\r\n\t\t \tcQuery  += \"    AND C5_TIPO = 'N'\r\n\t\t \tcQuery  += \"    AND C6_NOTA = ''\r\n\t\t \tcQuery  += \" \tAND C6_LOTECTL = '\"+aGriLSPv[nX][1]+\"'\r\n\t\t \tcQuery  += \" \tAND C6_NUMLOTE = '\"+aGriLSPv[nX][2]+\"'\r\n\t\t \tcQuery  += \"    AND C6_NUM <> '\"+AllTrim(M->C5_NUM)+\"'\r\n\t\t \t\r\n\t\t \ttcQuery cQuery alias TRB new\r\n\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\tdbgotop()\r\n\t\t\tDo While !EOF()\r\n\t\t\t\r\n\t\t\t\tIf !aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })\r\n\t\t\t\t\taAdd(aLSPvLoca,{ AllTrim(TRB->C6_NUM) , TRB->C6_ITEM,TRB->C6_LOTECTL , TRB->C6_NUMLOTE , AllTrim(TRB->C6_DESCRI) } )\r\n\t\t\t\tElse\r\n\t\t\t\t\taLSPvLoca[aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })][2] := aLSPvLoca[aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })][2] + \",\" + TRB->C6_ITEM\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\t\tdbSkip()\r\n\t\t\tEndDo\r\n\t\t\t\r\n\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\tdbCloseArea()\r\n\t\t\r\n\t\tEndIf\r\n\t\t\r\n\tNext nX\r\n\t\r\n\tcMSG := \"\"\r\n\tFor nX:=1 to Len(aLSPvLoca)\r\n\t\t\tIf Empty(cMSG)\r\n\t\t\t\tcMSG := \"Itens encontrados em outro P.Venda:\" + chr(13)+chr(10) \r\n\t\t\tEndIf\r\n\t\t\tcMSG += \"  -> P.Venda:\" + aLSPvLoca[nX][1] +\" Item:\"+ aLSPvLoca[nX][2] +\" Prod.:\" + aLSPvLoca[nX][5] + chr(13)+chr(10)   \r\n\tNext nX\r\n\t\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\t//AVISO(\"Itens encontrados em outro P.Venda:\", cMSG , { \"Fechar\" }, 3)\r\n\t\t//sleep(300)\t\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\r\n\t\tlRet := .F.\r\n\r\n\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\tReturn(lRet)\r\n\t\tEndIf \r\n\tEndIf\r\n\t\r\n\t/*\r\n\t*******************************************\r\n\tValidação Valores fiscais e descontos e totais\r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()     \r\n\t\toProcess:IncRegua1(\"[4-8] - Conferência fiscal, descontos e valores!\")\r\n\tENDIF\r\n\r\n\taDadosGrv := FCalImp(@oProcess)\r\n\t\r\n\tIf LEN(aDadosGrv)>0\r\n\t\tM->C5_XVALEXT := AllTrim(Extenso((aDadosGrv[4] + aDadosGrv[3]) ,.f.,M->C5_MOEDA,,\"3\",.t.,.f.))\r\n\t\tM->C5_XTOTAL  := (aDadosGrv[4] + aDadosGrv[3]) -  M->C5_DESCONT \r\n\t\tM->C5_XDESCON := aDadosGrv[2]  + M->C5_DESCONT \r\n\t\tM->C5_XVLRFIN := (aDadosGrv[4] + aDadosGrv[3]) -  M->C5_DESCONT \r\n\t\tM->C5_XDESPES := aDadosGrv[4]\r\n\t\t//M->C5_XSEGURO := aDadosGrv[5]\r\n\tEndIf \r\n\t\r\n\t\t\r\n\t/*\r\n\t*******************************************\r\n\tValidação do peso para Amostras \r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()  \r\n\t\toProcess:IncRegua1(\"[5-8] - Validação do peso para Amostras!\")\r\n\tEndIf\r\n\r\n\tcMSG := \"\"\r\n\t\r\n\tFor nX := 1 To Len(aCols)\r\n\t\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\r\n\t\t\tIf Empty(GdFieldGet(\"C6_XPESO\",nX)) .and. !GDDeleted(nX) .and. SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) == 'AM'\r\n\t\t\t\r\n\t\t\t\tIf Empty(cMSG)\r\n\t\t\t\t\tcMSG := \"Amostras sem Peso:\" + chr(13)+chr(10) \r\n\t\t\t\tEndIf\r\n\t\t\t\tcMSG += \"  -> Item do PV:\" + GdFieldGet(\"C6_ITEM\",nX) + \" Prod.:\" + AllTrim(GdFieldGet(\"C6_DESCRI\",nX)) + chr(13)+chr(10)  \r\n\t\t\t\t\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf !GDDeleted(nX) .and. (SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) == 'AM' .Or. AllTrim(GdFieldGet(\"C6_YCLASSI\",nX)) == \"A\")\r\n\t\t\t\tM->C5_BLQ  := '1'\r\n\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"Produto Amostra! Requer aprovação.\" ,nX)\r\n\t\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(\"Produto Amostra! Requer aprovação.\") + chr(13)+chr(10)\r\n\t\t\t\tcMSG := AllTrim(cMSG) + AllTrim(\"Produto Amostra! Requer aprovação.\") + chr(13)+chr(10)\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tEndIf\r\n\tNext nX\r\n\t\r\n\tIf M->C5_DESCONT  <> 0\r\n\t\tM->C5_BLQ  := '1'\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(\"O Campo de desconto de indenização foi preenchido. Ped. Venda requer aprovação.\" + chr(13)+chr(10))\r\n\t\tcMSG := AllTrim(cMSG) + \"O Campo de desconto de indenização foi preenchido. Ped. Venda requer aprovação.\" + chr(13)+chr(10)\r\n\tEndIf\r\n\t\r\n\tIF !EMPTY(cMSG)\r\n\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\r\n\t\tIf !IsBlind()  \r\n\t\t\tIf MsgYesNo(cMSG + chr(13)+chr(10)+ \"Deseja continuar?\" )\r\n\t\t\t\tlRet := .t.\r\n\t\t\tElse\r\n\t\t\t\tlRet := .F.\r\n\t\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\t\tReturn(lRet)\r\n\t\t\t\tEndIf \r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\r\n\tEndIf\r\n\t\r\n\t/*\r\n\t*******************************************\r\n\tValidação para não permitir salvar o pedido com chapas sem cavaletes \r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()\r\n\t\toProcess:IncRegua1(\"[6-8] - Chapas sem cavaletes!\")\r\n\tEndIf\r\n\r\n\tcMSG := \"\"\r\n\t\r\n\t/*\r\n\tNão validar para filial de SP \r\n\tnão validar para Pedidos de Transferencia\r\n\t*/\r\n\tIF M->C5_YTIPO <> \"TF\" .AND. SubString(CNUMEMP,1,8) == \"01010101\" .and. M->C5_TIPO <> 'B'\r\n\r\n\t\tFor nX := 1 To Len(aCols)\r\n\t\t\r\n\t\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\t\tdbSelectArea(\"SB1\")\r\n\t\t\tdbSetOrder(1)\r\n\t\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )  \r\n\t\t\t\r\n\t\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\t\r\n\t\t\t\tIf Empty(GdFieldGet(\"C6_YCAVALE\",nX)) .and. !GDDeleted(nX) .and. SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) == 'CH'\r\n\t\t\t\t\r\n\t\t\t\t\tIf Empty(cMSG)\r\n\t\t\t\t\t\tcMSG := \"Chapas sem cavaletes:\" + chr(13)+chr(10) \r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\tcMSG += \"  -> Item do PV:\" + GdFieldGet(\"C6_ITEM\",nX) + \" Prod.:\" + AllTrim(GdFieldGet(\"C6_DESCRI\",nX)) + chr(13)+chr(10)  \r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tNext nX\r\n\t\t\r\n\t\tIf !Empty(cMSG)\r\n\t\t\tAlert(cMSG)\r\n\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)  \r\n\t\t\t\r\n\t\t\tlRet := .F.\r\n\r\n\t\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\t\tReturn(lRet)\r\n\t\t\tEndIf \r\n\t\tEndIf\r\n\r\n\tEndIf\r\n\r\n\t/*\r\n\t*******************************************\r\n\tValidação para não permitir salvar o pedido fora dos almoxarificados ou locais determinados \r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()\r\n\t\toProcess:IncRegua1(\"[7-8] - Almoxarifado não permitido !\")\r\n\tENDIF\r\n\r\n\tcMSG := \"\"\r\n\r\n\tFor nX := 1 To Len(aCols)\r\n\t\r\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t\t//\"0005/0006/0034/0035/0036\"\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\t\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\r\n\t\t\tIf !GdFieldGet(\"C6_LOCAL\",nX) $ \"03/05\"  .and. !GDDeleted(nX) .and. SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) $ 'CH/AM'\r\n\t\t\t\r\n\t\t\t\tIf Empty(cMSG)\r\n\t\t\t\t\tcMSG := \"Almoxarifado não permitido ! \" + chr(13)+chr(10) \r\n\t\t\t\tEndIf\r\n\t\t\t\tcMSG += \"  -> Item do PV:\" + GdFieldGet(\"C6_ITEM\",nX) + \" Prod.:\" + AllTrim(GdFieldGet(\"C6_DESCRI\",nX)) + chr(13)+chr(10)  \r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext nX\r\n\t\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\t\r\n\t\tlRet := .F.\r\n\r\n\t\tIF lRet == .F. .and. !IsBlind()  \r\n\t\t\tReturn(lRet)\r\n\t\tEndIf \r\n\tEndIf\r\n\r\n\r\n    /*\r\n\t*******************************************\r\n\tValidação dos dados de condição de pagamento\r\n\t*******************************************\r\n\t*/\r\n\tIf !IsBlind()\r\n\t\toProcess:IncRegua1(\"[8-8] - Validação dos dados de condição de pagamento!\")\r\n\tEndIf\r\n\r\n\tM->C5_CONDPAG := u_ClintToMob(\"PG\")\r\n\r\n\tIf ! M->C5_TIPO $ \"D/B\"\r\n\t\tdbSelectArea(\"SA1\")\r\n\t\tdbSetOrder(1)\r\n\t\tIf dbSeek(xFilial(\"SA1\")+M->C5_CLIENTE+M->C5_LOJACLI)\r\n\t\t\tIf ! AllTrim(M->C5_CONDPAG) $ AllTrim(SA1->A1_XCONDPG)\r\n\r\n\t\t\t\tIf Empty(cMSG)\r\n\t\t\t\t\tcMSG := \"Pedido bloqueado! Condição de pagamento não permitida. Cond. Pag:[\"+ M->C5_CONDPAG +\"].\" + chr(13)+chr(10) \r\n\t\t\t\tEndIf\r\n\r\n\t\t\tEndIf\r\n\t\tEndIf \r\n\r\n\tEndIf\r\n\r\n\tIf !Empty(cMSG)\r\n\t\tAlert(cMSG)\r\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\tM->C5_BLQ     := \"1\"\r\n\tEndIf\r\n\t\r\n\t/*\r\n\tVALIDAÇÃO DO MOBGRAN\r\n\t*/\r\n\tIf  FunName() $ \"GROA014\" .And. INCLUI == .T.\r\n\t\t\r\n\t\tIf !Empty(M->C5_XIDMOB)\r\n\r\n\t\t\t/*\r\n\t\t\tVerifica se existe a chave no mobgran.\r\n\t\t\t*/\r\n\t\t\tcQuery  := \" SELECT * FROM ZSA010 WHERE D_E_L_E_T_ = '' AND ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\"' AND ZSA_STATUS ='ATIVA'\r\n\t\t\t\r\n\t\t\ttcQuery cQuery alias TRB new\r\n\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\tdbgotop()\r\n\t\t\t\r\n\t\t\tIf EOF() \r\n\t\t\t\tlRet := .F.\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf TRB->ZSA_STATUS <> 'ATIVA'\r\n\t\t\t\tlRet := .F.\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\t\tIf lRet == .F.\r\n\t\t\t\tAlert(\"Chave não encontrada ou Status:(>>\"+ TRB->ZSA_STATUS +\"<<) no MobGran!\")\r\n\t\t\t\tReturn(lRet)\t\r\n\t\t\tEndIf\r\n\r\n\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\tdbCloseArea()\t\r\n\r\n\t\tElse\r\n\t\t\t\r\n\t\t\tlRet := .F.\r\n\t\t\tAlert(\"Chave do MobGran em branco! Favor informar um código.\")\r\n\t\t\tReturn(lRet)\r\n\r\n\t\tEndIf\r\n\r\n\tElseIf FunName() $ \"GROA013\" \r\n\t\tIf AllTrim(M->C5_XIDMOB) == '-'\r\n\t\t\tlRet := .T.\r\n\t\telse\r\n\t\t\tcQuery  := \" SELECT * FROM ZSA010 WHERE D_E_L_E_T_ = '' AND ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\"' AND ZSA_STATUS ='ATIVA'\r\n\t\t\t\r\n\t\t\ttcQuery cQuery alias TRB new\r\n\t\t\tdbSelectArea(\"TRB\")\r\n\t\t\tdbgotop()\r\n\t\t\t\r\n\t\t\tIf EOF() \r\n\t\t\t\tlRet := .F.\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf TRB->ZSA_STATUS <> 'ATIVA'\r\n\t\t\t\tlRet := .F.\r\n\t\t\tEndIf\r\n\r\n\t\t\tIf lRet == .F.\r\n\t\t\t\tAlert(\"Chave não encontrada ou Status:(>>\"+ TRB->ZSA_STATUS +\"<<) no MobGran!\")\r\n\t\t\t\tReturn(lRet)\t\r\n\t\t\tEndIf\t\t\t\r\n\t\t\t\r\n\t\t\tdbSelectArea(\"TRB\") \r\n\t\t\tdbCloseArea()\t\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\t/*\r\n\tEnvio de aviso de alteração de pedidos \r\n\t*/\r\n\tIF        AllTrim(C5_XSHOWFO) = 'S';\r\n\t\t.AND. AllTrim(C5_XPENDEN) $ 'COM/LOG';\r\n\t\t.AND. AllTrim(C5_XFOLLST) = 'BOOKING SOLICITADO'\r\n\r\n\t\t/*\r\n\t\tEMAIL\r\n\t\t*/\r\n\t\tIf SC5->C5_YTIPO == \"ME\"\r\n\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\tElse\r\n\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\tEndIf\r\n\t\t\r\n\t\tConOut(\"Gerando relatório! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\r\n\t\tsleep(300)\r\n\t\tConOut(\"Gerando e-mail! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\r\n\t\t\r\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"backoffice.es@qualitagroup.com;bruno.lage@grupoqualita.com.br;arlindo.pelissari@grupoqualita.com.br\",'Pedido BOOKING SOLICITADO ! Código:' + SC5->C5_NUM ,'PEDIDO BOOKING SOLICITADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\r\n\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"bruno.lage@grupoqualita.com.br\",'Pedido BOOKING SOLICITADO ! Código:' + SC5->C5_NUM ,'PEDIDO BOOKING SOLICITADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\r\n\r\n\t\t//sleep(500)\r\n\r\n\t\t/*\r\n\t\tWHATSAPP\r\n\t\t*/\r\n\t\t/*\r\n\t\tU_SWENARWAP(\"5527981188913\", \"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM),\"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM)   ,\"RQ0003a\"           ,\"PDF\",\"\\RELINWEB\\RQ0003a.PDF\")\r\n\t\tsleep(500)\r\n\t\tU_SWENARWAP(\"5533984022125\", \"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM),\"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM)   ,\"RQ0003a\"           ,\"PDF\",\"\\RELINWEB\\RQ0003a.PDF\")\r\n\t\t*/\r\n\tEnd\r\n\r\n\t/*\r\n\tIntegração liberação Pedido de venda Com o Mobgran por tabela\r\n\tTABELA - ZSC\r\n\t*/\r\n\tIf Empty(M->C5_XMOTBLQ) \r\n\t\t//M->C5_XMOTBLQ := \"06 = Aguardando liberação do vendedor!\" + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\r\n\t\tM->C5_BLQ     := \"\"\r\n\t\tfTPBLQ        := .T.\r\n\tEndIf\r\n\r\n\tif (Empty(M->C5_NOTA) .OR. M->C5_NOTA == 'XXXXXXXXX' )\r\n\t\tIF (!Empty(M->C5_XIDMOB) .Or. M->C5_XIDMOB <> '-') \r\n\t\t\tu_MIntMGLib(M->C5_NUM , M->C5_XIDMOB , \"SC5\" , M->C5_XMOTBLQ , M->C5_FILIAL , M->C5_XTOTAL , fTPBLQ )\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\tConOut(\"******************************************\" )\r\n\tConOut(\"Final P.E = MT410TOK Qualitá\" )\r\n\tConOut(\"******************************************\" )\r\n\t\r\n\tSetKey(VK_F5,)\r\n\tSetKey(VK_F6,)\r\nEndIf\r\n\r\nIF (lRet == .F. .and. IsBlind()) \r\n\tlRet := .T.\r\nEndIf \r\n\r\nReturn(lRet)\r\n\r\n\r\nUser Function MIntMGLib(cPedido,XIdMobP,_cTabela, xMotBlq, cMobFilial , nXtotal , fTPBLQ)\r\n********************************************************************************************************************\r\n* /* User Integração com MobGran Liberação de pedidos por tabela ZSA ZSC */\r\n* /**/\r\n* //\r\n***\r\n\r\nLocal oJson     := JsonObject():New()\r\nLocal cCliente  := \"\"\r\nLocal cLoja     := \"\"\r\nLocal nValor    := 0\r\nLocal cCondPg   := \"\"\r\nLocal lSemFin   := .F.\r\n\r\n\t\tcQuery := \" SELECT  CAST(ZSC_RJSON AS VARCHAR(8000)) RJSON from \"+ RetSqlName(\"ZSC\")+ \" WHERE ZSC_IDMOBP = '\"+XIdMobP+\"' AND ZSC_TIPO <> 'B' AND ZSC_TIPO = '2' AND ZSC_RJSON IS NOT NULL\"\r\n\t\r\n\t\ttcQuery cQuery alias TRB_JSON new\r\n\t\tdbSelectArea(\"TRB_JSON\")\r\n\t\tdbgotop()\r\n\r\n\t\toJSon:fromJson(TRB_JSON->RJSON)\r\n\t\r\n\t\tcCliente  := iif(empty(oJson:GetJSonObject('cliente')),\"\",oJson:GetJSonObject('cliente'))\r\n\t\tcLoja     := iif(empty(oJson:GetJSonObject('loja'))   ,\"\",oJson:GetJSonObject('loja'))\r\n\r\n\t\tif !Empty(oJson:GetJSonObject('cliente'))\r\n\t\t\tnValor    := round(val(oJson:GetJSonObject('valorTotal')),2) \r\n\t\tElse\r\n\t\t\tnValor    := 0\r\n\t\tEndIf\r\n\r\n\t\tcCondPg   := iif(empty(oJson:GetJSonObject('condicaoPagamento')),\"\",oJson:GetJSonObject('condicaoPagamento'))\r\n\r\n\t\tdbSelectArea(\"TRB_JSON\") \r\n\t\tdbCloseArea()\t\r\n\t\tIf !Empty(oJson:GetJSonObject('cliente'))\r\n\t\t\tIf \tcCliente+cLoja       == m->C5_CLIENTE+m->C5_LOJACLI .And.;\r\n\t\t\t\tAllTrim(Str(nValor)) >= AllTrim(Str(nXTotal))    \t.And.;\r\n\t\t\t\tcCondPg              == m->C5_CONDPAG\r\n\r\n\t\t\t\tcQuery := \" UPDATE \"+RetSqlName(\"ZSC\")\r\n\t\t\t\tcQuery += \"    SET ZSC_TIPO = 'B'\r\n\t\t\t\tcQuery += \"  WHERE ZSC_IDMOBP  ='\"+ AllTrim(XIdMobP) +\"'\r\n\t\t\t\tcQuery += \"    AND ZSC_TIPO < '2'\r\n\t\t\t\t\r\n\t\t\t\tlSemFin:= .F.\r\n\t\t\tElse\r\n\t\t\t\tcQuery := \" UPDATE \"+RetSqlName(\"ZSC\")\r\n\t\t\t\tcQuery += \"    SET ZSC_TIPO = 'B'\r\n\t\t\t\tcQuery += \"  WHERE ZSC_IDMOBP  ='\"+ AllTrim(XIdMobP) +\"'\r\n\r\n\t\t\t\tlSemFin:= .T.\r\n\t\t\tEndIf \r\n\t\tElse\r\n\t\t\t\tcQuery := \" UPDATE \"+RetSqlName(\"ZSC\")\r\n\t\t\t\tcQuery += \"    SET ZSC_TIPO = 'B'\r\n\t\t\t\tcQuery += \"  WHERE ZSC_IDMOBP  ='\"+ AllTrim(XIdMobP) +\"'\r\n\r\n\t\t\t\tlSemFin:= .T.\t\r\n\t\tEndIf\t\r\n\t\t/*\r\n\t\tExecucao background do codigo sql\r\n\t\t*/\r\n\t\tTcSqlExec(cQuery)\r\n\r\n\t\t//regras\r\n\t\tIf fTPBLQ == .F.\r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"1\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With IIF(fTPBLQ == .F. ,xMotBlq,\"\" )\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With IIF(fTPBLQ == .F. ,\"\"    ,\"X\" )\r\n\t\t\t\t\tReplace ZSC_FLUXOM With IIF(fTPBLQ == .F. ,\"S\"    ,\"\" )\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\t\tEndIf\r\n\t\t//financeiro\r\n\t\tIf lSemFin \r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"2\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\t\t\t\r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"3\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"4\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"5\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\r\n\t\t\t/*\r\n\t\t\tPendencia Vendedor\r\n\t\t\t*/ \r\n\t\t\tIf  RecLock(\"ZSC\",.T.)\r\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\r\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\r\n\t\t\t\t\tReplace ZSC_TIPO   With \"6\"\r\n\t\t\t\t\tReplace ZSC_MSGRET With IIF(fTPBLQ == .t. ,xMotBlq,\"\")\r\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\r\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\r\n\t\t\t\t\tReplace ZSC_FLUXOM With IIF(fTPBLQ == .t. ,\"S\"    ,\"\")\r\n\t\t\t\tMsUnLock()\r\n\t\t\tEndIf \r\n\t\tEndIf\r\n\r\nReturn()\r\n\r\n\r\nUser Function ClintToMob(cTipo)\r\n****************************************************************************************************************\r\n* /*Gatilho C5_XIDMOB*/    \r\n*\r\n****\r\nLocal aArea     := GetArea() \r\nLocal cQuery    := \" SELECT * FROM ZSA010 WHERE D_E_L_E_T_ = '' AND ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\" ' AND ZSA_STATUS ='ATIVA'\r\nLocal cDadosRet := \"\" \r\n\r\ntcQuery cQuery alias TRBidMob new\r\ndbSelectArea(\"TRBidMob\")\r\ndbgotop()\r\n\r\nConOut(\"****PRINCIPAL**ClintToMob*************\")\r\n\r\nIf !EOF()\r\n\tIf cTipo == \"PG\"\r\n\t\tcDadosRet  := AllTrim(TRBidMob->ZSA_CPAG)\r\n\tElse\r\n\t\tcDadosRet  := AllTrim(TRBidMob->ZSA_CLIENT)\r\n\tEndIf\r\nElse\r\n\tcDadosRet := M->C5_CONDPAG\r\nEndIf\r\n\r\ndbSelectArea(\"TRBidMob\") \r\ndbCloseArea()\t\r\n\r\nRestArea(aArea)\r\n\r\nReturn(cDadosRet)\r\n\r\n                                                                       \r\nStatic Function FCalImp(oProcess) \r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\n************************************** \r\n* Calculo totais e Impostos\r\n************************************** \r\nLocal aArea     := GetArea() \r\nLocal nX        := 0 \r\n//Local nPrcTot   := 0\r\nLocal _aTotalNF := {} \r\nLocal nValDesc  := 0\r\nLocal nItem:= 0                             \r\n\r\n//IF FunName() == Alltrim(\"GROA014\")\r\n\r\n\tConOut(\"************************************\")\r\n\tConOut(\"MaFisIni\")                 \r\n\tConOut(\"************************************\")\r\n\t\r\n\t// Inicia rotina de calculo dos impostos \r\n\tMaFisIni(Iif(Empty(M->C5_CLIENT),M->C5_CLIENTE,M->C5_CLIENT),;\t// 1-Codigo Cliente/Fornecedor \r\n\t     \tM->C5_LOJAENT,;          \t\t\t\t\t\t\t\t// 2-Loja do Cliente/Fornecedor \r\n\t     \tIIf(M->C5_TIPO$\"DB\",\"F\",\"C\"),;                    \t\t// 3-C:Cliente , F:Fornecedor \r\n\t     \tM->C5_TIPO,;                    \t\t\t\t\t\t// 4-Tipo da NF \r\n\t     \tM->C5_TIPOCLI,;          \t\t\t\t\t\t\t\t// 5-Tipo do Cliente/Fornecedor \r\n\t     \tNil,; \r\n\t     \tNil,; \r\n\t     \tNil,; \r\n\t     \tNil,; \r\n\t     \t\"GROA014\") \r\n\t\r\n     If (Inclui .Or. Altera) \r\n               nItem:= 0\r\n\t   \r\n\t\t\t   ConOut(\"************************************\")\r\n\t\t\t   ConOut(\"MaFisAdd\")                                  \r\n\t\t\t   ConOut(\"************************************\") \r\n\t\t\t   \r\n\t\t\t   If !IsBlind()\r\n\t\t\t\t\toProcess:SetRegua2(len(aCols))\r\n\t\t\t   ENDIF\r\n\t\t\t   \r\n               For nX := 1 to len(aCols) \r\n                    If !GDDeleted(nX)\t\t\t\t\t\t\t//Validar se o registro nao esta deletado \r\n                         \r\n                         nItem:= nItem + 1 \t\t\t\t\t\t// Quantidade para recalcular \r\n                         \r\n                         // Adiciona dados dos produtos na rotina de calculo de impostos       \r\n                         MaFisAdd( GdFieldGet(\"C6_PRODUTO\",nX),; \r\n                                   GdFieldGet(\"C6_TES\"    ,nX),; \r\n                                   GdFieldGet(\"C6_QTDVEN\" ,nX),; \r\n                                   GdFieldGet(\"C6_PRCVEN\" ,nX),; \r\n                                   0,; //GdFieldGet(\"C6_VALDESC\",nX)\r\n                                   \"\",; \r\n                                   \"\",; \r\n                                   0,; \r\n                                   0,; \r\n                                   0,; \r\n                                   0,; \r\n                                   0,; \r\n                                   GdFieldGet(\"C6_VALOR\",nX),; \r\n                                   0,; \r\n                                   0,; \r\n                                   0)\r\n                               \r\n                         nValDesc := nValDesc + Round(GdFieldGet(\"C6_VALDESC\",nX),2)\r\n\t\t\t\t\t\t \r\n\t\t\t\t\t\t If !IsBlind()  \r\n                         \toProcess:IncRegua2(\"Cavalete [\"+GdFieldGet(\"C6_YCAVALE\",nX)+\"] Lote-Chapa: \"+AllTrim(GdFieldGet(\"C6_LOTECTL\",nX))+\"-\"+GdFieldGet(\"C6_NUMLOTE\",nX)  )\r\n                         ENDIF\r\n\r\n                         //ConOut(nValDesc)\r\n                         //ConOut(nItem)\r\n                    EndIf \r\n                \r\n               Next nX                \r\n     EndIf \r\n     \r\n     /*\r\n     _nIcmsRet := 0 \r\n     For nLo:=1 To nItem           \r\n          _nIcmsRet += MaFisRet(nLo,\"LF_ICMSRET\") // Retorna valor da ST  \r\n     Next nLo       \r\n     */\r\n\t   \r\n\t aAdd(_aTotalNF,MaFisRet(,\"NF_TOTAL\"))\r\n\t aAdd(_aTotalNF,nValDesc)\r\n\t aAdd(_aTotalNF,MaFisRet(,\"NF_BASEDUP\"))\r\n \t aAdd(_aTotalNF,M->C5_DESPESA)\r\n\t //aAdd(_aTotalNF,MaFisRet(,\"NF_SEGURO\"))  \r\n\t\r\n\t MaFisEnd() \t// Encerra rotina de calculo de impostos \r\n\r\n//EndIf\r\n\r\nRestArea(aArea) \r\n\r\nReturn(_aTotalNF)\r\n\r\n\r\nUser Function GMA410MNU() \r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal aButtons := {}\r\n\r\nIF FunName() == Alltrim(\"GROA014\")\t\r\n\t//Gerando invoice\r\n\taRotina[16][1] := \"Gerar Invoice\"\r\n\taRotina[16][2] := 'Processa({|| u_MNumInv()},,\"Gravando....\")'\r\n\t\r\n\t//\"Imprime Packing List\"\r\n\t//aRotina[20][2] := \"u_RelInWeb('RQ0002','Imprime Packing List [RQ0002]','u_fParAut(2)')\"\r\n\taRotina[17][2][5][2] := \"u_RelInWeb('RQ0002','Imprime Packing List [RQ0002]','u_fParAut(2)')\"\r\n\t\r\n\t//\"Imprime Commercial Invoice\" \r\n\t//aRotina[19][2] := \"u_RelInWeb('RQ0004','Imprime Invoice (CH/AM)[RQ0004]','u_fParAut(4)')\"\r\n\taRotina[17][2][4][2] := \"u_RelInWeb('RQ0004','Imprime Invoice (CH/AM)[RQ0004]','u_fParAut(4)')\"\r\n\t\r\n\t//\"Imprime Proforma Invoice\"\r\n\t//aRotina[18][2] := \"u_RelInWeb('RQ0003','Imprime Proforma Invoice [RQ0003]','u_fParAut(2)')\"\t \r\n\taRotina[17][2][3][2] := \"u_RelInWeb('RQ0003','Imprime Proforma Invoice [RQ0003]','u_fParAut(2)')\"\r\n\t\r\n\t//aRotina[17][2] := \"U_proformaInvoice()\"//#Brittes Alterada chamada da Funcao\r\n\t//\"Imprime Pedido de Venda\"\r\n\taRotina[17][2][1][1] := \"Pre-Nota\" \r\n\taRotina[17][2][1][2] := \"u_MATR730Q()\"\r\n\t\r\n\t//\"Imprime Romaneio\"\r\n\taRotina[17][2][2][1] := \"Imprime Invoice (BLOCOS)\"\r\n\taRotina[17][2][2][2] := \"u_RelInWeb('RQ0004_BLOCK','Imprime Invoice (BLOCOS) [RQ0004_BLOCK]'    ,'u_fParAut(4)')\"\r\n\t//aadd(aRotina,{'Imprime Invoice (BLOCOS)',\"u_RelInWeb('RQ0004_BLOCK','Imprime Invoice (BLOCOS) [RQ0004_BLOCK]'    ,'u_fParAut(4)')\" , 0 , 3,0,NIL})\r\n\t\r\nElseIf FunName() == Alltrim(\"GROA013\")\r\n\r\n\taadd(aRotina,{'Imp. Packing List',\"u_RelInWeb('RQ0002_P','Imprime Packing List [RQ0002_P]'    ,'u_fParAut(2)')\" , 0 , 3,0,NIL})\r\n\taadd(aRotina,{'Imp. Proforma'    ,\"u_RelInWeb('RQ0003_P','Imprime Proforma Invoice [RQ0003_P]','u_fParAut(2)')\" , 0 , 3,0,NIL})\t\r\n\taadd(aRotina,{'Pre-Nota'    \t ,\"u_MATR730Q()\" \t\t\t\t\t\t\t\t\t\t\t  \t\t\t\t\t, 0 , 3,0,NIL})\t\r\n\t\r\nEndIf\r\n\r\naadd(aRotina,{'Ajustes Gerais {P.Venda}',\"u_AjuGerais()\" , 0 , 3,0,NIL})\r\n\r\naadd(aRotina,{'Aprovação WhatsApp ',\"u_WAppAprov()\" , 0 , 3,0,NIL})\r\n\r\naadd(aRotina,{'Limpar FollowUp' ,\"u_ClearFol()\"  , 0 , 3,0,NIL})\t\r\n\r\nReturn aButtons\r\n\r\nUser Function ClearFol()\r\n****************************************************************************************************************\r\n*    // LIMPA FOLLOWUP PELO PERIODO SOMENTE OVADOS\r\n*\r\n****\r\nLocal cQuery:=\"\"\r\n\r\nPrivate aPerg := {}\r\nPrivate cPerg := \"MLIMPAFOLL\"\r\n\r\nAadd(aPerg,{cPerg,\"Data Incial  ?\"\t\t,\"D\",08,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Data Final   ?\"\t\t,\"D\",08,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nU_Testasx1(cPerg,aPerg,.T.)\r\n\r\nIf ! Pergunte(cPerg,.T.)\r\n\tReturn()\r\nEndIf\r\n\r\nIf Empty(mv_par01)\r\n\tAlert(\"Data inicial não pode ficar em branco!\")\r\n\tReturn()\r\nEndIf\r\n\r\nIf Empty(mv_par02)\r\n\tAlert(\"Data final não pode ficar em branco!\")\r\n\tReturn()\r\nEndIf\r\n\r\ncQuery :=  \"  UPDATE SC5010\r\ncQuery +=  \"    SET C5_XSHOWFO =\t'N'\r\ncQuery +=  \"  WHERE R_E_C_N_O_ IN(\r\ncQuery +=  \"  \t\t\t\t\t\tSELECT REC FROM (\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\tSELECT\t  R_E_C_N_O_ REC,\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  C5_FILIAL,\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  C5_NUM ,\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  C5_NOTA+'/'+C5_SERIE AS NF,\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  (SELECT F2_EMISSAO FROM SF2010 WHERE D_E_L_E_T_ = '' AND F2_FILIAL = C5_FILIAL AND F2_DOC = C5_NOTA AND F2_SERIE = C5_SERIE AND F2_CLIENTE = C5_CLIENTE AND F2_LOJA = C5_LOJACLI) DATA\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t  FROM SC5010 \r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t WHERE D_E_L_E_T_ = ''\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND C5_XSHOWFO IN('S')\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND C5_TIPO IN ('N')\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND C5_XVLRFIN <> 0\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND RTRIM(LTRIM(C5_XFOLLST)) IN ('OVADO','CARREGADO','FATURADO')\r\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t)TB_TEMP\r\ncQuery +=  \"  \t\t\t\t\t\t WHERE DATA BETWEEN '\"+dToS(mv_par01)+\"' AND '\"+dToS(mv_par02)+\"'\r\ncQuery +=  \"  \t\t\t\t\t\t)\r\n\r\nTcSQLExec(cQuery)\r\n\r\nAlert(\"FollowUp removidos com sucesso!\")\r\n\r\nReturn()\r\n\r\nUser Function WAppAprov()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal cProt   := \"\"\r\n//Local cProt2  := \"\"\r\nLocal cMotiv  := \"\"\r\nLocal cQuery  := \"SELECT DISTINCT UPPER(RTRIM(LTRIM(C6_XMOTBLQ))) C6_XMOTBLQ FROM SC6010 WHERE D_E_L_E_T_ ='' AND C6_FILIAL+C6_NUM = '\" + SC5->C5_FILIAL + SC5->C5_NUM + \"' AND UPPER(RTRIM(LTRIM(C6_XMOTBLQ))) <> ''\r\n\r\n\r\ntcQuery cQuery alias TRBE new\r\ndbSelectArea(\"TRBE\")\r\ndbgotop()\r\n\r\nDo While !EOF()\r\n\t\r\n\tcMotiv := cMotiv + TRBE->C6_XMOTBLQ + chr(13)+chr(10)\r\n\r\n\tdbSelectArea(\"TRBE\") \r\n\tdbSkip()\r\nEndDo\r\n\r\ndbSelectArea(\"TRBE\") \r\ndbCloseArea()\r\n\r\nIF FunName() == Alltrim(\"GROA014\")\r\n\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\nElseIf FunName() == Alltrim(\"GROA013\")\r\n\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\nEndIf\r\n\r\nsleep(4000)\r\n\r\n/*\r\nLimite de Credito\r\n*/\r\n//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0057&CLIENTES='+AllTrim(SC5->C5_CLIENTE)+AllTrim(SC5->C5_LOJACLI)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0057.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\r\n//Grupo de Faturamento Whatsapp\r\n\r\n/*\r\nTeste\r\n*/\r\n//cProt  := U_SWENARWAP(\"5551997331669\",\"Aprovação da Proforma:\" +AllTrim(SC5->C5_NUM) + chr(13)+chr(10) + \" Motivo:\" + cMotiv + chr(13)+chr(10) + \" Usuário:\" + SUBSTR(CUSUARIO,7,15), \"PROFORMA\"+AllTrim(SC5->C5_NUM),\"RQ0003\",\"PDF\",\"\\RELINWEB\\RQ0003.pdf\")\r\n\r\n/*\r\nOficial\r\n*/\r\ncProt  := U_SWENARWAP(\"5527995295180-1587589430@g.us\",\"Aprovação da Proforma:\" +AllTrim(SC5->C5_NUM) + chr(13)+chr(10) + \" Motivo:\" + cMotiv + chr(13)+chr(10) + \" Usuário:\" + SUBSTR(CUSUARIO,7,15), \"PROFORMA\"+AllTrim(SC5->C5_NUM),\"RQ0003\",\"PDF\",\"\\RELINWEB\\RQ0003.pdf\")\r\n\r\nIF cProt = \"\" .or. cProt = nil \r\n\tAlert(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde!\")\r\n\tReturn()\r\nEndIf\r\n\r\nIf  RecLock(\"WAM\",.T.) \r\n\r\n\tReplace WAM_FILIAL  With \"\" \r\n\tReplace WAM_DATA    With Date()\r\n\tReplace WAM_HORA    With Time()\r\n\tReplace WAM_ID      With cProt\r\n\tReplace WAM_MSG     With \"Aprovação da Proforma:\" +AllTrim(SC5->C5_NUM) + \"Motivo:\" + cMotiv +  \"Usuário:\" + SUBSTR(CUSUARIO,7,15) + \" Cliente: \" + AllTrim(SC5->C5_XFRFORW) \r\n\t//Replace WAM_TELL    With \"5551997331669\"\r\n\t//Replace WAM_TELL    With \"5533984022125\"\r\n\tReplace WAM_INDEX   With SC5->C5_FILIAL + SC5->C5_NUM\r\n\tReplace WAM_PERG    With \"S\"\r\n\t//Replace WAM_DATAR   With \"\"\r\n\t//Replace WAM_HORAR   With \"\"\r\n\t//Replace WAM_RESPOSV With \"\"\r\n\t\r\n\tIF SubString(CNUMEMP,1,2) == \"05\"\r\n\t\tReplace WAM_EXEC    With 'ITINGA-PV'\r\n\tElse\r\n\t\tReplace WAM_EXEC    With 'QUALITA-PV'\r\n\tEndIf\r\n\t\r\n\r\n   MsUnLock()\r\nEndIf\r\n\t\t\r\nAlert(\"WhatsApp enviado com sucesso! \" + cProt)\r\n\r\nReturn()\r\n\r\n\r\nUser Function WAppResp()\r\n****************************************************************************************************************\r\n*NÃO USADO     \r\n*\r\n**** \r\nLocal cQuery  := \"SELECT TOP 1 * FROM WAM010 WHERE D_E_L_E_T_ = '' AND WAM_INDEX = '\"+SC5->C5_FILIAL + SC5->C5_NUM+\"' ORDER BY R_E_C_N_O_ DESC\"\r\n\t\t\t\t  \r\nLocal aRetMsg := \"\"\r\n\r\ntcQuery cQuery alias TRB new\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\n\r\nIf !Empty(TRB->WAM_ID)\r\n\taRetMsg :=\tstrTokArr(U_SWREMGWAP(TRB->WAM_ID), ',' )\r\nEndIf\r\n\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n\r\nIf !\"false\" $ aRetMsg[7]\r\n\tIf (\"SIM\" $ Upper(aRetMsg[8])) .OR. ( \"APROVADO\" $ Upper(aRetMsg[8]) )\r\n\t\r\n\t \r\n\t\tRecLock(\"SC5\",.F.)\r\n\t\t\tSC5->C5_BLQ  := ''\r\n\t\tMsUnlock()\t\r\n\t\t/*\r\n\t\tdbSelectArea(\"SC6\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(SC5->C5_FILIAL + SC5->C5_NUM)\r\n\t\tWhile SC6->(!EOF()) .And. SC6->C6_FILIAL + SC6->C6_NUM == SC5->C5_FILIAL + SC5->C5_NUM\r\n\t\t                                      \r\n\t\t      MaLibDoFat(SC6->(RecNo()),SC6->C6_QTDVEN,,,.T.,.T.,.F.,.F.)\r\n\t\t\r\n\t\t   SC6->(dBSkip())\r\n\t\tEndDo\r\n\t\t*/\r\n\tEndIf\r\nElse \r\n\tAlert(\"Pedido ainda não liberado!\")\r\nEndIf\r\n\r\nReturn() \r\n\r\nUser Function AjuGerais()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nPrivate aPerg := {}\r\nPrivate cPerg := \"AJUSGERAIS\"\r\nPrivate nOpc  := 0\r\n\r\nnOpc := Aviso(\"Atenção\",\"Estes ajustes devem ser usados somente em casos especiais! Pedido: [\"+SC5->C5_NUM+\"] .\" ,{\"Confirma\",\"Abandona\"})\t\r\n\r\nIf nOpc == 2\r\n\tReturn()\r\nEndIf\r\n                  \r\nAadd(aPerg,{cPerg,\"Alterar o peso líquido:\",\"N\",12,04,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\nAadd(aPerg,{cPerg,\"Alterar o peso bruto :\" ,\"N\",12,04,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nAadd(aPerg,{cPerg,\"Alterar qtd volume 1:\"  ,\"N\",03,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})     \r\nAadd(aPerg,{cPerg,\"Alterar qtd Box:\"       ,\"N\",03,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\r\n\r\nU_Testasx1(cPerg,aPerg,.t.) \r\n\r\nIf ! Pergunte(cPerg,.T.)\r\n\tReturn()\r\nEndIf\r\n\r\nRecLock(\"SC5\",.F.)\r\n\tSC5->C5_PESOL    := mv_par01\r\n\tSC5->C5_PBRUTO   := mv_par02\r\n\tSC5->C5_VOLUME1  := mv_par03\r\n\tSC5->C5_VOLUME2  := mv_par04\r\nMsUnlock()\t\r\n\r\nAviso(\"Atualização:\",\"Pedido: [\"+SC5->C5_NUM+\"] atualizado com sucesso!\" ,{\"Ok\"})\r\n\r\nReturn()\r\n\r\n\r\nUser Function MNumInv()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal cNumInvo := GetMv(\"MV_XNUMINV\")\r\nLocal cQuery   := \"\"\r\n\r\nIF EMPTY(SC5->C5_YINVOIC)\r\n\t\r\n\tProcRegua(3) \r\n\t\r\n\tPutMv(\"MV_XNUMINV\",Soma1(cNumInvo))\r\n\t\r\n\tIncProc(\"Criando Invoice:\" + cNumInvo) \r\n\tSleep( 1000 ) \r\n\t\r\n\tIncProc(\"Salvando...\" + cNumInvo)\r\n\tSleep( 1000 ) \r\n\t\r\n\tIncProc(\"Liberando....\" + cNumInvo)\r\n\tSC5->(reclock(\"SC5\", .F.))\r\n\tSC5->C5_YINVOIC := cNumInvo\t\t\t\t\t\t\t\t\t\r\n\tSC5->(msUnLock())\r\n\tSleep( 1000 )\r\n\t\r\n\tAVISO(\"Invoice\", \"Invoice gerada com sucesso! Número=\" + cNumInvo  , { \"Fechar\" }, 1)\r\n\t\r\n\t//U_GROA014A()\r\n\t//AxInclui(\"SZO\")\r\n\t\r\n\tdbSelectArea(\"ZGO\")\r\n\tdbSetOrder(1)\r\n\tIf dbSeek(xFilial(\"ZGO\") + SC5->C5_NUM + SC5->C5_CLIENTE + SC5->C5_LOJACLI)\r\n\t\tZGO->(reclock(\"ZGO\", .F.))\r\n\t\tZGO->ZGO_INVOIC := cNumInvo\t\t\t\t\t\t\t\t\t\r\n\t\tZGO->(msUnLock())\r\n\t\t//U_GROA014A()\r\n\tElse\r\n\t\tZGO->(reclock(\"ZGO\", .T.))\r\n\t\tZGO->ZGO_FILIAL := xFilial(\"ZGO\")\r\n\t\tZGO->ZGO_INVOIC := cNumInvo\t\r\n\t\tZGO->ZGO_PEDIDO := SC5->C5_NUM\r\n\t\tZGO->ZGO_CLIENT := SC5->C5_CLIENTE\r\n\t\tZGO->ZGO_LOJA\t:= SC5->C5_LOJACLI\t\t\t\t\t\t\r\n\t\tZGO->(msUnLock())\r\n\tEndIf\r\n\t\r\n\tcQuery := \"SELECT CAST(M2_DATA AS DATE) DATA, MAX(M2_MOEDA2) 'DOLAR' , MAX(M2_MOEDA3) 'EURO'\r\n\tcQuery += \"  FROM SM2010\r\n\tcQuery += \"  WHERE D_E_L_E_T_ = ''\r\n\tcQuery += \"    AND M2_DATA  = '\"+DToS(dDataBase)+\"'\r\n\tcQuery += \"   GROUP BY M2_DATA\r\n\t\r\n\tTcQuery cQuery Alias TMP_MOEDA New\r\n\tdbSelectArea(\"TMP_MOEDA\")\r\n\t\r\n\tSC5->(reclock(\"SC5\", .F.))\r\n\tSC5->C5_MENNOTA := AllTrim(SC5->C5_MENNOTA) + \" //INVOICE:\" + SC5->C5_YINVOIC + \"-\" + LEFT(DToS(dDataBase),4) +  \"  TAXA DO DOLAR R$:\" + AllTrim(STR(TMP_MOEDA->DOLAR)) + \" CNTR:\" + AllTrim(SC5->C5_XCONTAI) \r\n\tSC5->(msUnLock())\r\n\t\r\n\tdbSelectArea(\"TMP_MOEDA\")\r\n\tdbCloseArea()            \r\nElse \r\n\r\n\tAVISO(\"Invoice\", \"Já existe invoice para esse pedido! Número=\" + SC5->C5_YINVOIC  , { \"Fechar\" }, 1)\r\n\r\nEndIf\t\r\n\r\nReturn()\r\n\r\n\r\nUser Function fParAut(nTipo)\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal cRet := \"\"\r\n\r\nIf nTipo = 2\r\n\tcRet :=  \"&FILIAL=\" + AllTrim(SC5->C5_FILIAL) +\"&NUMPED=\" + AllTrim(SC5->C5_NUM) \r\nElse\r\n\tdbSelectArea(\"ZGO\")\r\n\tdbSetorder(1)\r\n\tIf dbSeek(xFilial(\"ZGO\")+AllTrim(SC5->C5_NUM))\r\n\t\tcRet := \"&FILIAL=\" + AllTrim(ZGO->ZGO_FILIAL) +\"&INVOICE=\" + AllTrim(ZGO->ZGO_INVOIC)\r\n\tElse\r\n\t\tAlert(\"Pedido de venda sem Invoice!\")\r\n\tEndIf\r\nEndIf\r\n\r\nReturn(cRet)\r\n\r\n\r\nUser Function GA410CONS() \r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal aButtons := {}\r\n\r\nSetKey(VK_F5,{||u_MCONSUTDET()})\r\nSetKey(VK_F6,{||u_GERAMSGPAD()})\r\n\r\naAdd(aButtons, {\"\", {|| u_MCONSUTDET()}, \"[F5] Consulta GrPlus\", \"[F5] Consulta GrPlus\"})\r\naAdd(aButtons, {\"\", {|| u_GERAMSGPAD()}, \"[F6] Gera Msg Padrão\", \"[F6] Gera Msg Padrão\"})\r\n\r\nReturn aButtons\r\n\r\nUser Function GERAMSGPAD()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal cQuery   := \"\"         \r\n//Local aPeso    := {}\r\n//Local nResult  := 0     \r\n//Local cBoleto  := \"\"\r\nLocal cMsgNota := \"\"    \r\n//Local cMsgNota2:= \"\"                         \r\nLocal cNotas   := \"\"\r\nLocal aGriCavDW:= {}\r\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\r\nLocal cInCavDw := \"\"\r\nLocal nX       := 0\r\n\r\n/*\r\nMensagem foi retirada de uso conforme chamado numero 1109\r\nControle de drawback em tempo Real.\r\n*/\r\nIF TYPE(\"aCols\") == \"A\"\r\n\tFor nX := 1 To Len(aCols)\r\n\t\tdbSelectArea(\"SB1\")\r\n\t\tdbSetOrder(1)\r\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \r\n\t\t\tIf !GDDeleted(nX) .and. LEFT(GdFieldGet(\"C6_LOTECTL\",nX),2)=='DW'\r\n\t\t\t\tIf Empty(aScan(aGriCavDW,GdFieldGet(\"C6_LOTECTL\",nX)) )\r\n\t\t\t\t\taAdd(aGriCavDW , GdFieldGet(\"C6_LOTECTL\",nX)  )\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tNext nX\r\n\tIf !Empty(aGriCavDW)\r\n\t\tFor nX := 1 To Len(aGriCavDW)\t\t\r\n\t\t\taGriCavDW[nX] := LEFT(AllTrim(aGriCavDW[nX]),8)\r\n\t\t\tcInCavDw := cInCavDw +  \"'\"+AllTrim(aGriCavDW[nX])+\"',\"\r\n\t\tNext nX\r\n\t\tcInCavDw := Left(cInCavDw,Len(cInCavDw)-1)\r\n\tEndIf\r\n\t\r\n\r\n\tIf !Empty(cInCavDw)\r\n\t\t\r\n\t\tcQuery := \" SELECT DISTINCT DOC ,\r\n\t\tcQuery += \" \t\t\t\tEMISSAO\r\n\t\tcQuery += \"   FROM(\r\n \t\tcQuery += \" \t SELECT\r\n \t\tcQuery += \" \t\t\tLOTE,\r\n\t\tcQuery += \" \t\t\tIIF(EMISSAO<>'',EMISSAO,ISNULL((SELECT TOP 1 D1_EMISSAO FROM SD1010 WHERE D_E_L_E_T_ = '' AND D1_LOTECTL = LEFT(LOTE, LEN(RTRIM(LTRIM(LOTE)))-1) AND LEFT(D1_COD,2) = 'BL'),'')) EMISSAO,\r\n \t\tcQuery += \" \t\t\tIIF(DOC<>'',DOC,ISNULL((SELECT TOP 1 D1_DOC FROM SD1010 WHERE D_E_L_E_T_ = '' AND D1_LOTECTL = LEFT(LOTE, LEN(RTRIM(LTRIM(LOTE)))-1) AND LEFT(D1_COD,2) = 'BL'),'')) DOC\r\n \t\tcQuery += \" \t   FROM (\r\n \t\tcQuery += \" \t\t\tSELECT\tLOTE,\r\n \t\tcQuery += \" \t\t\t\t\tIIF(FORNECE<>'000011','', DOC) DOC,\r\n \t\tcQuery += \" \t\t\t\t\tEMISSAO,\r\n\t\tcQuery += \" \t\t\t\t\tD1_SERIE,\r\n \t\tcQuery += \" \t\t\t\t\tFORNECE\r\n \t\tcQuery += \" \t\t\t\t\tFROM (\t\r\n \t\tcQuery += \" \t\t\t\t\t\t\tSELECT DISTINCT D1_LOTECTL LOTE, \t\t\t\t\r\n \t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_DOC DOC,\r\n\t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_EMISSAO EMISSAO, \r\n \t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_SERIE,\r\n \t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_FORNECE  FORNECE\r\n \t\tcQuery += \" \t\t\t\t\t\t\tFROM SD1010 \r\n \t\tcQuery += \" \t\t\t\t\t\t\tWHERE D_E_L_E_T_ = '' \r\n \t\tcQuery += \" \t\t\t\t\t\t\tAND D1_LOTECTL IN (\"+cInCavDw+\")\r\n \t\tcQuery += \" \t\t\t\t\t\t )TB_TEMP\r\n \t\tcQuery += \" \t\t  )TAB_TEMP\r\n \t\tcQuery += \" \t)TAB_TEMP_FIM\r\n \t\tcQuery += \" WHERE DOC <> ''\r\n\t\t\r\n\t\tTcQuery cQuery Alias TMP_NOTA New\r\n\t\tdbSelectArea(\"TMP_NOTA\")\r\n\t\t\r\n\t\tDo While !EOF()\r\n\t\t\r\n\t\t\tcNotas := cNotas + AllTrim(TMP_NOTA->DOC) + \"-\" + dtoc(STOd(TMP_NOTA->EMISSAO))+ \" ,\"  \r\n\t\t\r\n\t\t\tdbSelectArea(\"TMP_NOTA\")\r\n\t\t\tdbSkip()\r\n\t\tEndDo\r\n\t\t\r\n\t\tdbSelectArea(\"TMP_NOTA\")\r\n\t\tdbCloseArea()\r\n\t\r\n\t\t//cMsgNota += \"ESTA NOTA FISCAL CONTEM INSUMOS IMPORTADOS ADQUIRIDOS DE ITINGA MINERACAO LTDA. PELA NF:\"+cNOtas+\" AMPARADO PELO REGIME DRAWBACK INTEGRADO - MODALIDADE SUSPENSAO, TIPO INTERMEDIARIO ATO CONCESSÓRIO Nº 20190019344 DE 08/05/2019.///\"   \r\n\tEndIf\r\n\t\r\n\tcQuery := \"SELECT CAST(M2_DATA AS DATE) DATA, MAX(M2_MOEDA2) 'DOLAR' , MAX(M2_MOEDA3) 'EURO'\r\n\tcQuery += \"  FROM SM2010\r\n\tcQuery += \"  WHERE D_E_L_E_T_ = ''\r\n\tcQuery += \"    AND M2_DATA  = '\"+DToS(dDataBase)+\"'\r\n\tcQuery += \"  GROUP BY M2_DATA \r\n\t\r\n\tTcQuery cQuery Alias TMP_MOEDA New\r\n\tdbSelectArea(\"TMP_MOEDA\")\r\n\t\r\n\tcMsgNota += \"INVOICE:\" + AllTrim(M->C5_YINVOIC) + \"-\" + LEFT(DToS(dDataBase),4) +  \"  TAXA DO DOLAR R$:\" + AllTrim(STR(TMP_MOEDA->DOLAR)) + \" CNTR:\" + AllTrim(M->C5_XCONTAI) + \" LACRE:\" + AllTrim(M->C5_XSEAL)\r\n\t\t        \r\n\tdbSelectArea(\"TMP_MOEDA\")\r\n\tdbCloseArea()                       \r\n\t\r\n\tIf !Empty(m->C5_MENNOTA)\r\n\t\tIf MsgYesNo(\"O campo [C5_MENNOTA], já possui informção. Deseja subistituir a mensagem original?\" )\r\n\t\t\tm->C5_MENNOTA := memoline(AllTrim(cMsgNota),254,1,,.T.)\r\n\t\t\tm->C5_MSG2    := memoline(AllTrim(cMsgNota),254,2,,.T.)\r\n\t\tEndIf\t\t\r\n\tElse\r\n\t\tm->C5_MENNOTA := memoline(AllTrim(cMsgNota),254,1,,.T.)\r\n\t\tm->C5_MSG2    := memoline(AllTrim(cMsgNota),254,2,,.T.)\r\n\tEndIf\r\n\t\r\nElse\r\n\r\n\tSetKey(VK_F5,)\r\n\tSetKey(VK_F6,)\r\n\r\nEndIf\r\n\r\nReturn\r\n\r\nStatic Function MAltVlrAut(cNumItem,cNumChapa) \r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal nEdit1\t := 0\r\nLocal oEdit1\r\n\r\nLocal nEdit2\t := 0\r\nLocal oEdit2\r\n\r\nLocal nEdit3\t := SA1->A1_INFDESC\r\nLocal oEdit3\r\n\r\n//Local nEdit4\t := 0\r\n//Local oEdit4\r\n\r\nLocal lNExec     := .F.\r\nLocal lNDele     := .F.\r\n\r\nLocal nX         := 0\r\n\r\n// Variaveis Private da Funcao\r\nPrivate _oDlgVlr\t\t\t\t// Dialog Principal\r\n\r\n// Variaveis que definem a Acao do Formulario                    \r\nDEFINE MSDIALOG _oDlgVlr TITLE \" ITEM \" + cNumItem   FROM u_MGETTELA(223),u_MGETTELA(173) TO u_MGETTELA(359),u_MGETTELA(520) PIXEL\r\n\r\n\t// Cria as Groups do Sistema\r\n\t@ u_MGETTELA(003),u_MGETTELA(005) TO u_MGETTELA(044),u_MGETTELA(168) LABEL \"\" PIXEL OF _oDlgVlr\r\n\r\n\t// Cria Componentes Padroes do Sistema\r\n\t@ u_MGETTELA(010),u_MGETTELA(008) Say \"Valor Negociado:\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t@ u_MGETTELA(010),u_MGETTELA(050) MsGet oEdit1 Var nEdit1            Size u_MGETTELA(35)  ,u_MGETTELA(009) picture(\"@E 9,999,999.99999\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t\r\n\t@ u_MGETTELA(010),u_MGETTELA(085) Say \"Desconto padrão: {%}\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t@ u_MGETTELA(010),u_MGETTELA(130) MsGet oEdit3 Var nEdit3            Size u_MGETTELA(35) ,u_MGETTELA(009) when(.f.) picture(\"@E 99.99\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t\r\n\t@ u_MGETTELA(028),u_MGETTELA(008) Say \"Novo desconto: {%}\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t@ u_MGETTELA(028),u_MGETTELA(050) MsGet oEdit2 Var nEdit2            Size u_MGETTELA(35) ,u_MGETTELA(009) picture(\"@E 99.99999\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t\r\n\t//@ u_MGETTELA(028),u_MGETTELA(085) Say \"Desconto: {Vlr}\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t//@ u_MGETTELA(028),u_MGETTELA(130) MsGet oEdit4 Var nEdit4            Size u_MGETTELA(35) ,u_MGETTELA(009) picture(\"@E 9999.99\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\t\r\n\t@ u_MGETTELA(047),u_MGETTELA(131) Button \"Ok\" \t\tSize u_MGETTELA(037),u_MGETTELA(012)  ACTION( lNExec := .T. , Close(_oDlgVlr))  PIXEL OF _oDlgVlr\r\n\t//@ u_MGETTELA(047),u_MGETTELA(085) Button \"Deletar\" \tSize u_MGETTELA(037),u_MGETTELA(012)  ACTION( lNDele := .T. , Close(_oDlgVlr))  PIXEL OF _oDlgVlr\r\n\t//@ u_MGETTELA(050),u_MGETTELA(007) Say \"O valor irá subistituir todas as chapas do cavalete! \"  Size u_MGETTELA(113),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\r\n\r\nACTIVATE MSDIALOG _oDlgVlr CENTERED\r\n\r\n\r\nIf lNDele\r\n\tFor nX := 1 To Len(aCols)\r\n\t\tIf AllTrim(GdFieldGet(\"C6_YCAVALE\",nX)) == AllTrim(cNumCav)\t\t\t\r\n\t\t\t aCols[nX][Len(aHeader)+1] := .T.\r\n\t\tEndIf\r\n\tNext nX\r\nEndIf\r\n\r\nIf lNExec\r\n\t\r\n\tIf !Empty(nEdit1) .Or. !Empty(nEdit2)\r\n\t\tFor nX := 1 To Len(aCols)\r\n\t\t\r\n\t\t\tIf !Empty(nEdit1)\r\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRUNIT\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX) //C6_PRUNIT 23/09/2019\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t\tEndIf\r\n\t\t\tElse\r\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\r\n\t\t\t\t\t\t//GdFieldPut(\"C6_PRUNIT\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX) //C6_PRUNIT 23/09/2019\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tNext nX\r\n\tEndIf\r\n\t\r\n\t/*\r\n\tIf !Empty(nEdit1) .Or. !Empty(nEdit2) .Or. !Empty(nEdit4)\r\n\t\tFor nX := 1 To Len(aCols)\r\n\t\t\tIf Empty(nEdit4 )\r\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRUNIT\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX) //C6_PRUNIT 23/09/2019\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t\tEndIf\r\n\t\t\tElse \r\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//nEdit4 := round(nEdit4 / cNumChapa,2)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tnEdit2 := (nEdit4*100)/GdFieldGet(\"C6_VALOR\",nX)  \r\n\t\t\t\t\r\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\r\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t\tEndIf\r\n\t\t\tEndIf\r\n\t\tNext nX\r\n\tElse\r\n\t\tIf !Empty(nEdit3)\r\n\t\t\t\r\n\t\t\t//For nX := 1 To Len(aCols)\r\n\t\t\t//\tIf AllTrim(GdFieldGet(\"C6_YCAVALE\",nX)) == AllTrim(cNumCav)\t\t\t\r\n\t\t\t//\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit3,nX)\r\n\t\t\t//\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCREF\",nX) ,nEdit1) * nEdit3) /100,2),nX)\r\n\t\t\t//\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,GdFieldGet(\"C6_PRCREF\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCREF\",nX) ,nEdit1) * nEdit2) /100   ,nX)\r\n\t\t\t//\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\r\n\t\t\t//\tEndIf\r\n\t\t\t//Next nX\r\n\t\t\t\r\n\t\tEndIf\r\n\tEndIf\r\n\t*/\r\n\t \r\nEndIf\r\n\r\n\r\nReturn \r\n\r\n\r\nUser Function MCONSUTDET()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\n// Variaveis Locais da Função\r\nLocal cEdit1\t := Space(100)\r\nLocal cEdit2\t := Space(100)\r\nLocal cEdit3\t := Space(100)\r\nLocal oEdit1\r\nLocal oEdit2\r\nLocal oEdit3\r\n\r\nLocal nX         := 0\r\n\r\n// Variaveis Private da Funcão\r\nPrivate _oDlg\t  // Dialog Principal\r\n\r\n// Variaveis que definem a Acao do Formulario\r\nPrivate VISUAL := .F.                        \r\nPrivate INCLUI := .F.                        \r\nPrivate ALTERA := .F.                        \r\nPrivate DELETA := .F.        \r\n\r\n// Privates das ListBoxes\r\nPrivate aListBox1 := {}\r\nPrivate oListBox1\r\nPrivate aFlist   := {}\r\n\r\n/*\r\nInicializando Variaveis \r\n*/\r\n\r\niF TYPE(\"aCols\") == \"A\"\r\n\r\n\tIF !(M-> C5_TIPO $ \"D,B\")   //Se for nota de devolucao\r\n\t\tcEdit1  := Posicione(\"SA1\",1,XFilial(\"SA1\")+M->C5_CLIENTE+M->C5_LOJACLI,\"A1_NOME\")                   // Retorna o nome do Cliente\r\n\tELSE\r\n\t\tcEdit1  := POSICIONE(\"SA2\",1,XFILIAL(\"SA2\")+M->C5_CLIENTE+M->C5_LOJACLI,\"A2_NOME\")\t\t\t\t\t // Retorna o nome do Fornecedor      \r\n\tENDIF\r\n\tcEdit2 := Posicione(\"SE4\",1,XFilial(\"SE4\")+M->C5_CONDPAG,\"E4_DESCRI\") \r\n\tcEdit3 := Posicione(\"SA3\",1,XFilial(\"SA3\")+M->C5_VEND1,\"A3_NOME\") \r\n\t\r\n\tDEFINE MSDIALOG _oDlg TITLE \"CONSULTA DETALHADA GRPLUS\" FROM u_MGETTELA(333),u_MGETTELA(275) TO u_MGETTELA(734),u_MGETTELA(795) PIXEL\r\n\t\r\n\t// Cria Componentes Padroes do Sistema\r\n\t@ u_MGETTELA(006),u_MGETTELA(005) Say \"NOME DO CLIENTE:\" Size u_MGETTELA(042),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(006),u_MGETTELA(052) MsGet oEdit1 Var cEdit1 when(.f.) Size u_MGETTELA(200),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(021),u_MGETTELA(006) Say \"COND. PAGAMENTO:\" Size u_MGETTELA(046),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(021),u_MGETTELA(052) MsGet oEdit2 Var cEdit2 when(.f.) Size u_MGETTELA(057),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(021),u_MGETTELA(114) Say \"NOME VENDEDOR:\" Size u_MGETTELA(055),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(021),u_MGETTELA(165) MsGet oEdit3 Var cEdit3 when(.f.) Size u_MGETTELA(087),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\r\n\t@ u_MGETTELA(180),u_MGETTELA(215) Button \"OK\"  Size u_MGETTELA(037),u_MGETTELA(012) ACTION(Close(_oDlg)) PIXEL OF _oDlg\r\n\t\r\n\t@ u_MGETTELA(035),u_MGETTELA(006) ListBox oListBox1 Fields ;\r\n\t\tHEADER \"ITEM\",\"CAVALETE\",\"P.LIQUIDO\",\"P.BRUTO\",\"QTD CHAPAS\",\"QTD RECORTE/AMOSTRAS\";\r\n\t\tSize u_MGETTELA(247),u_MGETTELA(140) Of _oDlg Pixel;\r\n\t\tColSizes 05,80,50,50,50,20\r\n\r\n\t\toListBox1:bLDblClick := {||  iif(fLibFunc(aFlist[oListBox1:nAT,01])==.t., MAltVlrAut(aFlist[oListBox1:nAT,01],aFlist[oListBox1:nAT,04]) , Alert(\"Produto oferta não pode ser alterado!\") )  }\r\n\r\n\t// Chamadas das ListBox do Sistema\r\n\tfListBox1()\r\n\t\r\n\tFor nX := 1 To Len(aFlist)\r\n\t\tIf AllTrim(aFlist[nX][1]) == AllTrim(GdFieldGet(\"C6_ITEM\",n))\r\n\t\t\t//oListBox1:Select(nX)\r\n\t\t\t//oListBox1:bLine := { || aFlist[ oListBox1:nX ] }\r\n\t\t\toListBox1:nAt := Nx\r\n\t\tEndIf\r\n\tNext Nx\r\n\t\r\n\tACTIVATE MSDIALOG _oDlg CENTERED \r\n\r\nElse\r\n\r\n\t//Alert(\"ok\")\r\n\tSetKey(VK_F5,)\r\n\tSetKey(VK_F6,)\r\nEndIf\r\n\r\nReturn(.T.)\r\n\r\nStatic Function fLibFunc(cNumItem)\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\nLocal nX   := 0\r\nLocal lRet := .T.\r\n\r\nFor nX := 1 To Len(aCols)\r\n\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\r\n\t\tIF GdFieldGet(\"C6_XOFERTA\",nX) == \"S\"\t\r\n\t\t\tlRet := .F.\r\n\t\tEndIf\r\n\tEndIf\r\nNext nX\r\n\r\nReturn(lRet)\r\n\r\nStatic Function fListBox1()\r\n****************************************************************************************************************\r\n*    \r\n*\r\n****\r\n//Local nPos   := 0\r\nLocal nTotBr   := 0\r\nLocal nTotLQ   := 0\r\nLocal nTotCh   := 0\r\n//Local nTotDF := 0\r\nLocal nTotAM   := 0\r\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\r\nLocal nx       := 0\r\n\r\noListBox1:SetArray(aFlist)\r\n\r\n/*\r\nPreenche o dados de peso bruto e peso liquido por cavaletes\r\n e quantidade de chapas\r\n*/\r\nFor nX := 1 To Len(aCols)\r\n\r\n\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \r\n\t//\"0005/0006/0034/0035/0036\"\r\n\tdbSelectArea(\"SB1\")\r\n\tdbSetOrder(1)\r\n\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\r\n\t\r\n\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\r\n\t\tIf !GDDeleted(nX) \r\n\t\t\t/*\r\n\t\t\tIf !aScan(aFlist,{|x|alltrim(x[1]) == GdFieldGet(\"C6_YCAVALE\",nX)  })\t\t\r\n\t\t\t\tAadd(aFlist,{GdFieldGet(\"C6_YCAVALE\",nX) ,;\r\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOLQ\"))    ,;\r\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOBR\"))  ,;\r\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0, fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YQTDBD\") ),;\r\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_QTDVEN\",nX),0 )  })\r\n\t\t\tElse\r\n\t\t\t\tnPos := aScan(aFlist,{|x|alltrim(x[1])==GdFieldGet(\"C6_YCAVALE\",nX) })\r\n\t\t\t \taFlist[nPos][2] := aFlist[nPos][2] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOLQ\"))\r\n\t\t\t \taFlist[nPos][3] := aFlist[nPos][3] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX),fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOBR\"))\r\n\t\t\t \taFlist[nPos][4] := aFlist[nPos][4] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0, fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YQTDBD\") )\r\n\t\t\t \taFlist[nPos][5] := aFlist[nPos][5] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_QTDVEN\",nX), IIF(AllTrim(GdFieldGet(\"C6_YCLASSI\",nX))==\"A\" .AND. Empty(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))),1,0 )) //\r\n\t\t\tEndIf\r\n\t\t\t*/\r\n\t\t\t\r\n\t\t\tAadd(aFlist,{GdFieldGet(\"C6_ITEM\",nX) ,;\r\n\t\t\t\t\t\t GdFieldGet(\"C6_YCAVALE\",nX) ,; \r\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),GdFieldGet(\"C6_PRODUTO\",nX),GdFieldGet(\"C6_LOCAL\",nX),\"B8_YPESOLQ\"))    ,;\r\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),GdFieldGet(\"C6_PRODUTO\",nX),GdFieldGet(\"C6_LOCAL\",nX),\"B8_YPESOBR\"))  ,;\r\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0, fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),GdFieldGet(\"C6_PRODUTO\",nX),GdFieldGet(\"C6_LOCAL\",nX),\"B8_YQTDBD\") ),;\r\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_QTDVEN\",nX),0 )  })\r\n\t\t\t\r\n\t\tEndIf\r\n\tElse \r\n\t\r\n\t//IIF(AllTrim(GdFieldGet(\"C6_YCLASSI\",nX))==\"A\" .AND. Empyt(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))),1,0)\r\n\t\r\n\tAadd(aFlist,{     \"-\",;\r\n\t\t\t\t\t  \"-\",;\r\n\t\t\t\t \t   0 ,;\r\n\t\t\t\t       0 ,;\r\n\t\t\t\t       0 ,;\r\n\t\t\t\t       0  })\r\n\t\r\n\tEndIf\r\nNext Nx\r\n\r\nIf Len(aFlist)>0\r\n\tFor nX := 1 To Len(aFlist)\r\n\t\tIf Alltrim(aFlist[nX][2]) = \"\"\r\n\t\t\taFlist[nX][2] := \"RECORTES\" \r\n\t\tEndIf\r\n\tNext Nx\r\n\t\r\n\tFor nX := 1 To Len(aFlist)\r\n\t\tnTotLQ := nTotLQ + aFlist[nX][3]\r\n\t\tnTotBr := nTotBr + aFlist[nX][4]\r\n\t\tnTotCh := nTotCh + aFlist[nX][5]\r\n\t\tnTotAM := nTotAM + aFlist[nX][6]\r\n\tNext Nx\r\n\t\r\n\tAadd(aFlist,{\"---------\",\"--------------------------------------------\",\"----------------------------------\",\"----------------------------------\",\"----------------------------------\",\"------------------------------------------\"})\r\n\tAadd(aFlist,{\"(=)\",\"  Total:\",nTotLQ,nTotBr,nTotCh,nTotAM})\r\n\tAadd(aFlist,{\"(=)\",\"  Weigth Limit: \"+ AllTrim(Str(M->C5_XWLIMIT)),M->C5_XWLIMIT - nTotLQ  ,M->C5_XWLIMIT - nTotBr,\"\",\"\"})\r\nEndIf\r\n\r\noListBox1:bLine := {|| {;\r\n\t\t\t\t\taFlist[oListBox1:nAT,01],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,02],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,03],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,04],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,05],;\r\n\t\t\t\t\taFlist[oListBox1:nAT,06]}}\r\n\t\r\nReturn        \r\n           \r\n\r\nStatic Function fPqLotSub(cLote,cSubLote,cCodProd,cCodLocal,cTipRet)\r\n****************************************************************************************************************\r\n*    //fPqCvlt(GdFieldGet(\"C6_YCAVALE\",nX)) -- quantiade de cavaletes amostras\r\n*    //\r\n****\r\nLocal nVlrRest := 0\r\n\r\ncQuery  := \" SELECT \"+ cTipRet +\" VLRET\"\r\ncQuery  += \"   FROM SB8010 \r\ncQuery  += \"  WHERE D_E_L_E_T_ = ''\r\ncQuery  += \"    AND B8_LOTECTL = '\"+ AllTrim(cLote)     +\"' \r\ncQuery  += \"    AND B8_NUMLOTE = '\"+ AllTrim(cSubLote)  +\"'\r\ncQuery  += \"    AND B8_PRODUTO = '\"+ AllTrim(cCodProd)  +\"'\r\ncQuery  += \"    AND B8_LOCAL   = '\"+ AllTrim(cCodLocal) +\"'\r\ncQuery  += \"    AND B8_SALDO <> 0\r\n\r\ntcQuery cQuery alias TRB new\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\n\r\nnVlrRest := TRB->VLRET\r\n\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n\r\nReturn nVlrRest\r\n\r\n\r\nStatic Function fPqCvlt(cCavalete)\r\n****************************************************************************************************************\r\n*    //fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOBR\")\r\n*    \r\n****\r\nLocal nVlrRest := 0\r\n\r\ncQuery  := \" SELECT COUNT(*) AS VLR_CONT\r\ncQuery  += \"    FROM SB8010 \r\ncQuery  += \"   WHERE D_E_L_E_T_ = ''\r\ncQuery  += \"     AND B8_YCAVALE = '\"+AllTrim(cCavalete)+\"'\r\ncQuery  += \"     AND B8_YCLASSI = 'A'\r\ncQuery  += \"     AND B8_SALDO <> 0\r\n\r\ntcQuery cQuery alias TRB new\r\ndbSelectArea(\"TRB\")\r\ndbgotop()\r\n\r\nnVlrRest := TRB->VLR_CONT\r\n\r\ndbSelectArea(\"TRB\") \r\ndbCloseArea()\r\n\r\nReturn nVlrRest\r\n\r\n\r\nUser Function MINFORFIN(dSetDate,cSetCodPG)\r\n****************************************************************************************************************\r\n*    //Informações Financeiras \r\n*    \r\n****\r\nPrivate _oInforFin\t\t\t\t// Dialog Principal\r\n                       \r\nPrivate oPG    := LoadBitmap(GetResources(), \"BR_VERMELHO\")\r\nPrivate oNPG   := LoadBitmap(GetResources(), \"BR_VERDE\")\r\nPrivate oNADA  := LoadBitmap(GetResources(), \"BR_CINZA\")\r\n\r\n// Privates das ListBoxes\r\nPrivate aListBoxFin := {}\r\nPrivate oListBoxFin\r\n\r\nDEFINE MSDIALOG _oInforFin TITLE \"Informações Financeiras\" FROM u_MGETTELA(178),u_MGETTELA(181) TO u_MGETTELA(403),u_MGETTELA(967) PIXEL\r\n\r\n\t// Cria Componentes Padroes do Sistema\r\n\t@ u_MGETTELA(093),u_MGETTELA(308) Button \"Cancelar\" Size u_MGETTELA(037),u_MGETTELA(012) ACTION(Close(_oInforFin)) PIXEL OF _oInforFin\r\n\t@ u_MGETTELA(093),u_MGETTELA(351) Button \"Salvar\" Size u_MGETTELA(037),u_MGETTELA(012)   ACTION(fSaveDtBl(),Close(_oInforFin)) PIXEL OF _oInforFin\r\n\r\n\t\t@ u_MGETTELA(003),u_MGETTELA(005) ListBox oListBoxFin Fields ;\r\n\t\tHEADER \"\",\"RECNO\",\"PREFIXO\",\"NUMERO\",\"TIPO\",\"PARCELA\",\"VALOR\",\"EMISSAO NF\",\"VENCIMENTO\",\"DATA BAIXA\",\"VENCIMENTO B/L\",\"VENCIMENTO B/L REAL\" ;\r\n\t\tSize u_MGETTELA(383),u_MGETTELA(088) Of _oInforFin Pixel;\r\n\t\tColSizes 08,20,40,40,40,40,40,40,40,40,50,40\r\n\t\t\r\n\t\t//oListBoxFin:bLDblClick := {||  MAltVlrAut(aFlist[oListBoxFin:nAT,01]) } alterar a função\r\n\t\t\r\n\r\n\t// Chamadas das ListBox do Sistema\r\n\tfListFin1(dSetDate,cSetCodPG)\r\n\r\nACTIVATE MSDIALOG _oInforFin CENTERED \r\n\r\nReturn(.T.)\r\n\r\n\r\nStatic Function fSaveDtBl()\r\n****************************************************************************************************************\r\n* //\r\n* //\r\n* \r\n****\r\nLocal lGravou  := .F.\r\nLocal cCodTitu := \"\"\r\nLocal nX       := 0\r\n\r\nFor nX:=1 to Len(aListBoxFin)\r\n\tIf !Empty(aListBoxFin[nX][12])\r\n\t\t\r\n\t\tdbSelectArea(\"SE1\")\r\n\t\tdbGoto(aListBoxFin[nX][2]) \r\n\t\tSE1->(reclock(\"SE1\", .F.))\r\n\t\t\tSE1->E1_VENCTO  := aListBoxFin[nX][11] \r\n\t\t\tSE1->E1_VENCREA := aListBoxFin[nX][12]\r\n\t\tSE1->(msUnLock())\r\n\t\t\r\n\t\tlGravou:=.T.\r\n\t\tcCodTitu := cCodTitu + aListBoxFin[nX][04]+\"-\"+aListBoxFin[nX][06]+ \" | \" + chr(13)+chr(10) \r\n\t\t\r\n\tEndIf\r\nNext nX\r\n\r\nIf lGravou\r\n\tAVISO(\"Títulos gravados com sucesso:\", cCodTitu , { \"Fechar\" }, 3)\r\nEndIF\r\n\r\nReturn()\r\n\r\nStatic Function fListFin1(dSetDate,cSetCodPG)\r\n****************************************************************************************************************\r\n* //\r\n* //\r\n* \r\n****\r\nLocal cQuery  := \"\"\r\n//Local aTPAVA  := {}\r\nLocal aRetAva := \"\"\r\n\r\ndbSelectArea(\"SF2\")\r\ndbSetOrder(2)\r\nIF dbSeek(xFilial(\"SF2\") + M->C5_CLIENTE + M->C5_LOJACLI + M->C5_NOTA + M->C5_SERIE + \"N\")\r\n\r\n\taTPadv := Condicao(M->C5_XVLRFIN,cSetCodPG,,SF2->F2_EMISSAO,) //FSepCond(M->C5_XVLRFIN,cSetCodPG,SF2->F2_EMISSAO)\r\n\r\n\tdbSelectArea(\"SE4\")\r\n\tdbSetOrder(1)\r\n\tIf dbSeek(xFilial(\"SE4\")+ cSetCodPG )\r\n\t\taRetAva := strtokarr (AllTrim(SE4->E4_TPAVA), \",\")\r\n\tEndIf\r\n\r\n\tIf Len(aRetAva) <> 0\r\n\t\tIf Len(aRetAva) <> Len(aTPadv)\r\n\t\t\tAlert(\"Verifique a condição de pagamento: (\" + AllTrim(cSetCodPG) + \"). O campo tp. avançado está diferente das quantidade de parcelas.\" )\r\n\t\tEndIf\r\n\tEndIf\r\n\r\n\tcQuery := \" \tSELECT\tR_E_C_N_O_ RECNO, \r\n\tcQuery += \" \t\t\tE1_FILIAL,\r\n\tcQuery += \" \t\t\tE1_PREFIXO,\r\n\tcQuery += \" \t\t\tE1_TIPO,\r\n\tcQuery += \" \t\t\tE1_NUM,\r\n\tcQuery += \" \t\t\tE1_PARCELA,\r\n\tcQuery += \" \t\t\tE1_EMISSAO,\r\n\tcQuery += \" \t\t\tE1_VENCREA,\r\n\tcQuery += \" \t\t\tE1_BAIXA,\r\n\tcQuery += \" \t\t\tE1_VALOR\r\n\tcQuery += \" \t  FROM SE1010 \r\n\tcQuery += \" \t WHERE E1_NUM     = '\"+M->C5_NOTA+\"'\r\n\tcQuery += \" \t   AND D_E_L_E_T_ = ''\r\n\t//cQuery += \" \t   AND E1_BAIXA   = ''\r\n\tcQuery += \" \t   AND E1_EMISSAO = '\"+dtoS(SF2->F2_EMISSAO)+\"'\r\n\tcQuery += \" \t   AND E1_TIPO IN ('NF')\r\n\tcQuery += \" \t   AND E1_CLIENTE = '\"+M->C5_CLIENTE+\"'\r\n\tcQuery += \" \t   AND E1_LOJA    = '\"+M->C5_LOJACLI+\"'\r\n\tcQuery += \" \t   AND E1_SERIE   = '\"+M->C5_SERIE+\"' \r\n\r\n\tTcQuery cQuery Alias TMP_FIM New\r\n\tdbSelectArea(\"TMP_FIM\")\r\n\t\r\n\tnPosAt := 0\r\n\tcTipoAvan := \"\"\r\n\t\r\n\tDo While !EOF()\r\n\t\r\n\t\tnPosAt := nPosAt + 1\r\n\t\tIf Len(aRetAva)<>0\r\n\t\t\tcTipoAvan := aRetAva[nPosAt] \r\n\t\t\t\r\n\t\t\tIf AllTrim(cTipoAvan) <> \"A\"\r\n\t\t\t\taTPadv := Condicao(M->C5_XVLRFIN,cSetCodPG,,dSetDate+1,)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\t\t\r\n\t\tAadd(aListBoxFin,{\tiif(!Empty(aRetAva),IIF(EMPTY(TMP_FIM->E1_BAIXA),oNPG,oPG),oNADA),;\r\n\t\t\t\t\t\t\tTMP_FIM->RECNO,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_PREFIXO,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_NUM,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_TIPO,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_PARCELA,;\r\n\t\t\t\t\t\t\tTMP_FIM->E1_VALOR,;\r\n\t\t\t\t\t\t\tStoD(TMP_FIM->E1_EMISSAO),;\r\n\t\t\t\t\t\t\tStoD(TMP_FIM->E1_VENCREA),;\r\n\t\t\t\t\t\t\tStoD(TMP_FIM->E1_BAIXA),;\r\n\t\t\t\t\t\t\tiif(!Empty(aRetAva),IIf(Empty(TMP_FIM->E1_BAIXA), aTPadv[nPosAt][1]             ,sToD(\"\") ),sToD(\"\")),;\r\n\t\t\t\t\t\t\tiif(!Empty(aRetAva),IIf(Empty(TMP_FIM->E1_BAIXA), DataValida(aTPadv[nPosAt][1]) ,sToD(\"\") ),sToD(\"\"));\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\r\n\t\tdbSelectArea(\"TMP_FIM\")\r\n\t\tdbSkip()\r\n\tEndDo\r\n\t\r\n\tdbSelectArea(\"TMP_FIM\")\r\n\tdbCloseArea()\r\n\r\n\tif Empty(aListBoxFin)\r\n\t\r\n\t\tAadd(aListBoxFin,{\t\toNADA,;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\t\"\",;\r\n\t\t\t\t\t\t\t\tStoD(\"\"),;\r\n\t\t\t\t\t\t\t\tStoD(\"\"),;\r\n\t\t\t\t\t\t\t\tStoD(\"\"),;\r\n\t\t\t\t\t\t\t\tStoD(\"\"),;\r\n\t\t\t\t\t\t\t\tsToD(\"\");\r\n\t\t\t\t\t\t\t\t})\r\n\t\r\n\tEndIf \r\n\r\n\toListBoxFin:SetArray(aListBoxFin)\r\n\t\r\n\toListBoxFin:bLine := {|| {;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,01],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,02],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,03],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,04],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,05],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,06],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,07],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,08],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,09],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,10],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,11],;\r\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,12]}}\r\n\t\r\n\r\nEndIf\r\n\r\nReturn()\r\n"}}}
Content-Length: 104797
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"git:/d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO_NOVO_COMERCIAL/MT410TOK.prw?%7B%22path%22%3A%22d%3A%5C%5CTOTVS%2012%5C%5CMicrosiga%5C%5CProtheus%5C%5CProjetoVSCode%5C%5C06_FATURAMENTO_NOVO_COMERCIAL%5C%5CMT410TOK.prw%22%2C%22ref%22%3A%22~%22%7D","languageId":"advpl","version":1,"text":"#INCLUDE \"rwmake.ch\"\n#INCLUDE \"protheus.ch\"\n#INCLUDE \"topconn.ch\"\n\n/*\nPrograma ...: MT410TOK.Prw\nUso ........: Validação do pedido de vendas\nData .......: 26/04/2019\nFeito por ..: Bruno Lage Ferreira \n\nMV_NDESCTP - DESCONTO NO PREÇO DE LISTA E UNITARIO\nNOVO\n*/\n\nUser Function MT410TOK()\n****************************************************************************************************************\n*   /* Programa para validar o pedido de venda tabela de preço de chapas - Qualitá */\n*\n****\nLocal   lRet      := .T.\nLocal   oProcess\nLocal   nOpc      := PARAMIXB[1]\nLocal   cQuery    := \"\"\nDefault lEnd      := .F.\n\n\nIf SubString(CNUMEMP,1,2) == \"01\" .And. (INCLUI == .T. .Or. nOpc == 1 .OR. ALTERA == .T.) .AND. (FUNNAME() <> \"GROA001\")\n\n\ta410Recalc()\n\n\toProcess := MsNewProcess():New({|lEnd| lRet := MValidPedV(@oProcess, @lEnd,@lRet) },\"Validando dados..\",\"Lendo Registros do Pedido de Vendas\",.T.) \n\tIf !IsBlind()     \n\t\tIf nOpc == 1 \n\t\t\tIf !Empty(M->C5_XIDMOB)\n\t\t\t\t\n\t\t\t\tcQuery := \"SELECT MAX(ZSA_IDMOB) ID FROM ZSA010 WHERE D_E_L_E_T_ =\t'' AND  ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\"'\"\n\t\t\t\ttcQuery cQuery alias TRB_EMOB new\n\t\t\t\tdbSelectArea(\"TRB_EMOB\")\n\t\t\t\tdbgotop()\n\n\t\t\t\tIf !EMPTY(TRB_EMOB->ID)\n\t\t\t\t\tAlert(\"Este P.Venda deve ser excluído pelo MogGran!\")\n\t\t\t\t\tdbSelectArea(\"TRB_EMOB\") \n\t\t\t\t\tdbCloseArea()\n\t\t\t\t\tReturn(.f.)\n\t\t\t\tEndIf\n\n\t\t\t\tdbSelectArea(\"TRB_EMOB\") \n\t\t\t\tdbCloseArea()\n\n\t\t\tEndIF\n\t\tEndIf\n\t\toProcess:Activate()\n\telse\n\t\tlRet := MValidPedV(nil, @lEnd,@lRet)\n\tEndIf\nEndIf\n\nReturn(lRet)\n\nUser Function M410LIOK()\n****************************************************************************************************************\n*    Libera ou bloquea linha do pedido de venda \n*\n****\nLocal lRet   := .T.\nLocal cQuery := \"\"\n\n/*\nLinhaOk\n*/\nIf SubString(CNUMEMP,1,2) == \"01\" \n\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",n))) ,1,2) $ 'BL' .AND. u_MTSOEST(GdFieldGet(\"C6_TES\",n)) \n\t\tIf Empty(GdFieldGet(\"C6_LOTECTL\",n))\n\t\t\tAlert(\"ERRO! BLOCO SEM LOTE!\")\n\t\t\tlRet := .F.\n\t\tEndIf\n\tEndIf\n\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",n))) ,1,2) $ 'CH' .AND. (Empty(GdFieldGet(\"C6_LOTECTL\",n)) .OR. Empty(GdFieldGet(\"C6_NUMLOTE\",n)))  \n\t\tAlert(\"ERRO! CHAPA COM LOTE OU SUB-LOTE EM BRANCO!\")\n\t\tlRet := .F.\n\tEndIf\nEndIf\n\n\n/*\nValida mobGran\n*/\ncQuery  := \" SELECT ZSA_PRCDES FROM ZSA010\ncQuery  += \"  WHERE D_E_L_E_T_ = ''\ncQuery  += \"  AND ZSA_PRCDES <> 0\n//cQuery  += \"  AND ZSA_STATUS = 'ATIVA'\ncQuery  += \"  AND ZSA_IDMOBP = '\"+ AllTrim(M->C5_XIDMOB)                    +\"'\ncQuery  += \"  AND ZSA_NUMCAV = '\"+ AllTrim(GdFieldGet(\"C6_YCAVALE\",n))      +\"'\ncQuery  += \"  AND ZSA_PROD   = '\"+ AllTrim(GdFieldGet(\"C6_PRODUTO\",n))      +\"'\ncQuery  += \"  AND ZSA_CLASSI = '\"+ AllTrim(GdFieldGet(\"C6_YCLASSI\",n))      +\"'\ncQuery  += \"  AND ZSA_LOTE   = '\"+ AllTrim(GdFieldGet(\"C6_LOTECTL\",n))      +\"'\n\ntcQuery cQuery alias TRB new\ndbSelectArea(\"TRB\")\ndbgotop()\n\nIf !EMPTY(TRB->ZSA_PRCDES)\n\tGdFieldPut(\"C6_XOFERTA\",'S')\nEndIf\n\ndbSelectArea(\"TRB\") \ndbCloseArea()\n\n\nReturn(lRet)\n\nUser Function MTSOEST(cCodTes)\n****************************************************************************************************************\n*    Libera ou bloquea linha do pedido de venda \n*\n****\nLocal lRet := .F.\n\ndbSelectArea(\"SF4\")\ndbSetOrder(1)\ndbSeek(xFilial(\"SF4\") + cCodTes)\n\nIf SF4->F4_ESTOQUE == \"S\"\n\tlRet := .T.\n\tConOut(\"MTSOEST\" +\"|\"+ cCodTes +\"|\"+ \".T.\" )\nElse\n\tConOut(\"MTSOEST\" +\"|\"+ cCodTes +\"|\"+ \".F.\" )\n\tlRet := .F.\nEndIf\n\nReturn(lRet)\n\nUser Function GM410FIM()\n****************************************************************************************************************\n*    Libera ou bloquea pedido de venda M410STTS \n*\n****\nLocal lLibBlq  := .F.\nLocal lCalcPeso:= .F.\nLocal cQuery   := \"\"\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\nlOCAL nX       := 0\n\nIf SubString(CNUMEMP,1,2) == \"01\"  .AND. (FUNNAME() <> \"GROA001\")\n\tFor nX := 1 To Len(aCols)\n\t\tIf !Empty(GdFieldGet(\"C6_XMOTBLQ\",nX)) .OR. !Empty(M->C5_XMOTBLQ)\n\t\t\tlLibBlq   := .T.\n\t\tEndIf\n\t\t\n\t\tdbSelectArea(\"SB1\")\n\t\tdbSetOrder(1)\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\n\t\t\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\t\t\n\t\t\tlCalcPeso := .T.\n\t\tEndIf\n\tNext nX\n\t\n\tIf lLibBlq   \n\t\tRecLock(\"SC5\",.F.)\n\t\t\tSC5->C5_BLQ  := '1'\n\t\tMsUnlock()\t\n\tEndif\n\n\tIf  M->C5_TIPO $ \"D/B\"\n\t\tRecLock(\"SC5\",.F.)\n\t\t\tSC5->C5_BLQ  := ''\n\t\tMsUnlock()\t\n\tEndIf \n\n\tIf lCalcPeso\n\t\n\t\t//Soma dos pesos brutos e liquido\n\t\tcQuery   := \" SELECT\tROUND(SUM(B8_YPESOLQ) + SUM(PESO_AMOSTRAS),3) PLQ, \n\t\tcQuery   += \" \t\t    ROUND(SUM(B8_YPESOBR) + SUM(PESO_AMOSTRAS),3) PBR \n\t\tcQuery   += \" FROM (\n\t\tcQuery   += \" SELECT\t\tISNULL(ZGO.ZGO_INVOIC,'') AS ZGO_INVOIC, \n\t\tcQuery   += \" \t\t\tTAB_PROFORMA.* FROM (\n\t\tcQuery   += \" \t\t\t SELECT\tRTRIM(LTRIM(C5_NUM)) AS C5_NUM,\n\t\tcQuery   += \" \t\t\t\t\tYEAR(CAST(C5_EMISSAO AS DATE) )ANO,\n\t\tcQuery   += \" \t\t\t\t\tCAST(C5_EMISSAO AS DATE) AS C5_EMISSAO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_NOME)) AS A1_NOME,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_END)) AS A1_END,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_BAIRRO)) AS A1_BAIRRO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDI)) AS A1_DDI,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDD)) AS A1_DDD,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_TEL)) AS A1_TEL,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_CONTATO)) AS A1_CONTATO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A3_NOME)) AS A3_NOME,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(YA_PAIS_I)) AS YA_PAIS_I,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XSEAL)) AS C5_XSEAL,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XBOOKIN)) AS C5_XBOOKIN,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVESSEL)) AS C5_XVESSEL,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XCONTAI)) AS C5_XCONTAI,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTARE)) AS C5_XTARE,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPO)) AS C5_XPO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_LOTECTL)) AS C6_LOTECTL,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_NUMLOTE)) AS C6_NUMLOTE,\n\t\tcQuery   += \" \t\t\t\t\tC6_CF,\n\t\tcQuery   += \" \t\t\t\t\tC6_XPESO AS PESO_AMOSTRAS,\n\t\tcQuery   += \" \t\t\t\t\tC6_YESPLIQ * 100 AS C6_YESPLIQ,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(B5_YCEMEIN)) AS C6_DESCRI, \n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_DESCRI))  AS C6_DESCRI_P, \n\t\tcQuery   += \" \t\t\t\t\tIIF(RTRIM(LTRIM(C6_YCAVALE))='','-',RTRIM(LTRIM(C6_YCAVALE)))  AS C6_YCAVALE,\n\t\tcQuery   += \" \t\t\t\t\tC6_PRCVEN,\n\t\tcQuery   += \" \t\t\t\t\tROUND(C6_PRCVEN / 10.764,2) AS PRCVEN_SQFT,\n\t\tcQuery   += \" \t\t\t\t\tC5_XVLRFIN AS VALOR_FINANCEIRO,\n\t\tcQuery   += \" \t\t\t\t\tC6_QTDVEN,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_NUMLOTE<>'',1,0) AS QTD_CHAPAS,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',0,C6_QTDVEN) AS QTD_TOTAL_FATURAR,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='M2',C6_QTDVEN,0) AS QTD_TOTAL_M2,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='PC',C6_QTDVEN,0) AS QTD_TOTAL_PC,\n\t\tcQuery   += \" \t\t\t\t\tC6_UM,\n\t\tcQuery   += \" \t\t\t\t\tC6_UNSVEN,\n\t\tcQuery   += \" \t\t\t\t\tC6_VALOR,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',C6_VALOR,0) AS SAMPLE_DESC,\n\t\tcQuery   += \" \t\t\t\t\tC6_VALDESC,\n\t\tcQuery   += \" \t\t\t\t\tC6_YCOMLIQ,\n\t\tcQuery   += \" \t\t\t\t\tC6_YALTLIQ,\n\t\tcQuery   += \" \t\t\t\t\tC6_YTOTLIQ,\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOLQ FROM SB8010 WHERE D_E_L_E_T_ = '' AND C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO AND B8_LOCAL = C6_LOCAL) ,0) AS  B8_YPESOLQ,\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOBR FROM SB8010 WHERE D_E_L_E_T_ = '' AND C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO AND B8_LOCAL = C6_LOCAL) ,0) AS  B8_YPESOBR,\n\t\tcQuery   += \" \t\t\t\t\tC5_XTESALE,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVALEXT)) AS C5_XVALEXT,\n\t\tcQuery   += \" \t\t\t\t\tUPPER(ISNULL(CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), C5_YOBSEXT)),'')) AS C5_YOBSEXT,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESING))  AS E4_DESING,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESCRI))  AS E4_DESPOR,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPORTLO)) AS C5_XPORTLO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTPCONT)) AS C5_XTPCONT,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XINSURA)) AS C5_XINSURA,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFIMDES)) AS C5_XFIMDES,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFRFORW)) AS C5_XFRFORW,\n\t\tcQuery   += \" \t\t\t\t\tC5_XWLIMIT,\n\t\tcQuery   += \" \t\t\t\t\tCASE \n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'S' THEN 'STANDARD'\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'C' THEN 'COMMERCIAL'\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'P' THEN 'PREMIUM'\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = '' AND C6_CF='7949' THEN 'SAMPLE'\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = ''  THEN '' \n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'A' THEN 'SAMPLE'\n\t\tcQuery   += \" \t\t\t\t\tEND C6_YCLASSI,\n\t\tcQuery   += \" \t\t\t\t\tC5_XTOTAL,\n\t\tcQuery   += \" \t\t\t\t\tC5_XDESCON,\n\t\tcQuery   += \" \t\t\t\t\tC5_XPDESTI,\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT B8_LOTEFOR FROM SB8010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = '' AND SUBSTRING(B8_PRODUTO,1,2) ='BL' ),'') AS LOTE_FORNECEDOR\n\t\tcQuery   += \" \t\t\t FROM SC6010 SC6 INNER JOIN SC5010 SC5\n\t\tcQuery   += \" \t\t\t\t   ON (C6_FILIAL = C5_FILIAL AND C6_NUM = C5_NUM )\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA1010 SA1\n\t\tcQuery   += \" \t\t\t\t   ON (A1_COD = C5_CLIENTE AND A1_LOJA = C5_LOJACLI )\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SYA010 SYA\n\t\tcQuery   += \" \t\t\t\t   ON (A1_PAIS = YA_CODGI)\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA3010\n\t\tcQuery   += \" \t\t\t\t   ON (A1_VEND=A3_COD)\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SB5010 SB5\n\t\tcQuery   += \" \t\t\t\t   ON (C6_PRODUTO = B5_COD)\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SE4010 SE4\n\t\tcQuery   += \" \t\t\t\t   ON (E4_CODIGO = C5_CONDPAG)\n\t\tcQuery   += \" \t\t\t WHERE SC6.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SC5.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SA1.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SYA.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SB5.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SE4.D_E_L_E_T_ = ''\n\t\t//cQuery   += \" \t\t\t   AND SC5.C5_BLQ <> '1'\n\t\tcQuery   += \" \t\t\t   AND C5_NUM = '\"+SC5->C5_NUM+\"'\n\t\tcQuery   += \" )TAB_PROFORMA\n\t\tcQuery   += \" \t FULL OUTER JOIN ZGO010 ZGO\n\t\tcQuery   += \" \t   ON (C5_NUM = ZGO_PEDIDO)\n\t\tcQuery   += \" WHERE C5_NUM <> ''\n\t\tcQuery   += \"   AND ISNULL(ZGO_INVOIC,'') LIKE '%%'\n\t\tcQuery   += \" )TB_PESO\n\t\t                                                          \n\t\ttcQuery cQuery alias TRB new\n\t\tdbSelectArea(\"TRB\")\n\t\tdbgotop()\n\t\t\n\t\tIF !M->C5_TIPO $ \"D/B\" .And. LEFT(AllTrim(GdFieldGet(\"C6_PRODUTO\",1)),2) <> 'BL'\n\t\t\tIF !EOF()\n\t\t\t\tdbSelectArea(\"SC5\")\t\t\n\t\t\t\tIf RecLock(\"SC5\",.f.)\n\t\t\t\t\tReplace SC5->C5_PESOL  With TRB->PLQ\n\t\t\t\t\tReplace SC5->C5_PBRUTO With TRB->PBR\n\t\t\t\t\t/*\n\t\t\t\t\tIF TRB->PLQ > SC5->C5_PBRUTO \n\t\t\t\t\t\tAlert(\"Peso bruto esta menor que peso líquido. Favor corrigir!\")\n\t\t\t\t\t\tReplace SC5->C5_PBRUTO With 0\n\t\t\t\t\tEndIf\n\t\t\t\t\t*/\n\t\t\t\t\tMsUnLock()\n\t\t\t\tEndIf\t\n\t\t\tEndIf\n\t\tEndIf\t\t\t\t\n\t\tdbSelectArea(\"TRB\") \n\t\tdbCloseArea()\n\t\t\n\t\t//Soma da quantidade de bandos\n\t\tcQuery   := \" SELECT COUNT(*) QTD FROM (\n\t\tcQuery   += \" SELECT DISTINCT C6_YCAVALE FROM (\n\t\tcQuery   += \" SELECT\t\tISNULL(ZGO.ZGO_INVOIC,'') AS ZGO_INVOIC, \n\t\tcQuery   += \" \t\t\tTAB_PROFORMA.* FROM (\n\t\tcQuery   += \" \t\t\t SELECT\tRTRIM(LTRIM(C5_NUM)) AS C5_NUM,\n\t\tcQuery   += \" \t\t\t\t\tYEAR(CAST(C5_EMISSAO AS DATE) )ANO,\n\t\tcQuery   += \" \t\t\t\t\tCAST(C5_EMISSAO AS DATE) AS C5_EMISSAO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_NOME)) AS A1_NOME,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_END)) AS A1_END,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_BAIRRO)) AS A1_BAIRRO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDI)) AS A1_DDI,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_DDD)) AS A1_DDD,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_TEL)) AS A1_TEL,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A1_CONTATO)) AS A1_CONTATO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(A3_NOME)) AS A3_NOME,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(YA_PAIS_I)) AS YA_PAIS_I,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XSEAL)) AS C5_XSEAL,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XBOOKIN)) AS C5_XBOOKIN,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVESSEL)) AS C5_XVESSEL,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XCONTAI)) AS C5_XCONTAI,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTARE)) AS C5_XTARE,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPO)) AS C5_XPO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_LOTECTL)) AS C6_LOTECTL,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_NUMLOTE)) AS C6_NUMLOTE,\n\t\tcQuery   += \" \t\t\t\t\tC6_CF,\n\t\tcQuery   += \" \t\t\t\t\tC6_XPESO AS PESO_AMOSTRAS,\n\t\tcQuery   += \" \t\t\t\t\tC6_YESPLIQ * 100 AS C6_YESPLIQ,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(B5_YCEMEIN)) AS C6_DESCRI, \n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C6_DESCRI))  AS C6_DESCRI_P, \n\t\tcQuery   += \" \t\t\t\t\tIIF(RTRIM(LTRIM(C6_YCAVALE))='','-',RTRIM(LTRIM(C6_YCAVALE)))  AS C6_YCAVALE,\n\t\tcQuery   += \" \t\t\t\t\tC6_PRCVEN,\n\t\tcQuery   += \" \t\t\t\t\tROUND(C6_PRCVEN / 10.764,2) AS PRCVEN_SQFT,\n\t\tcQuery   += \" \t\t\t\t\tC5_XVLRFIN AS VALOR_FINANCEIRO,\n\t\tcQuery   += \" \t\t\t\t\tC6_QTDVEN,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_NUMLOTE<>'',1,0) AS QTD_CHAPAS,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',0,C6_QTDVEN) AS QTD_TOTAL_FATURAR,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='M2',C6_QTDVEN,0) AS QTD_TOTAL_M2,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_UM='PC',C6_QTDVEN,0) AS QTD_TOTAL_PC,\n\t\tcQuery   += \" \t\t\t\t\tC6_UM,\n\t\tcQuery   += \" \t\t\t\t\tC6_UNSVEN,\n\t\tcQuery   += \" \t\t\t\t\tC6_VALOR,\n\t\tcQuery   += \" \t\t\t\t\tIIF(C6_CF='7949',C6_VALOR,0) AS SAMPLE_DESC,\n\t\tcQuery   += \" \t\t\t\t\tC6_VALDESC,\n\t\tcQuery   += \" \t\t\t\t\tC6_YCOMLIQ,\n\t\tcQuery   += \" \t\t\t\t\tC6_YALTLIQ,\n\t\tcQuery   += \" \t\t\t\t\tC6_YTOTLIQ,\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOLQ FROM SB8010 WHERE D_E_L_E_T_ = '' AND  C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO) ,0) AS  B8_YPESOLQ,\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT TOP 1 B8_YPESOBR FROM SB8010 WHERE D_E_L_E_T_ = '' AND C6_LOTECTL = B8_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE AND C6_YCAVALE = B8_YCAVALE AND B8_PRODUTO = C6_PRODUTO) ,0) AS  B8_YPESOBR,\n\t\tcQuery   += \" \t\t\t\t\tC5_XTESALE,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XVALEXT)) AS C5_XVALEXT,\n\t\tcQuery   += \" \t\t\t\t\tUPPER(ISNULL(CONVERT(VARCHAR(MAX), CONVERT(VARBINARY(MAX), C5_YOBSEXT)),'')) AS C5_YOBSEXT,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESING))  AS E4_DESING,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(E4_DESCRI))  AS E4_DESPOR,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XPORTLO)) AS C5_XPORTLO,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XTPCONT)) AS C5_XTPCONT,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XINSURA)) AS C5_XINSURA,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFIMDES)) AS C5_XFIMDES,\n\t\tcQuery   += \" \t\t\t\t\tRTRIM(LTRIM(C5_XFRFORW)) AS C5_XFRFORW,\n\t\tcQuery   += \" \t\t\t\t\tC5_XWLIMIT,\n\t\tcQuery   += \" \t\t\t\t\tCASE \n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'S' THEN 'STANDARD'\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'C' THEN 'COMMERCIAL'\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'P' THEN 'PREMIUM'\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = '' AND C6_CF='7949' THEN 'SAMPLE'\n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = ''  THEN '' \n\t\tcQuery   += \" \t\t\t\t\t\tWHEN RTRIM(LTRIM(C6_YCLASSI)) = 'A' THEN 'SAMPLE'\n\t\tcQuery   += \" \t\t\t\t\tEND C6_YCLASSI,\n\t\tcQuery   += \" \t\t\t\t\tC5_XTOTAL,\n\t\tcQuery   += \" \t\t\t\t\tC5_XDESCON,\n\t\tcQuery   += \" \t\t\t\t\tC5_XPDESTI,\n\t\tcQuery   += \" \t\t\t\t\tISNULL((SELECT B8_LOTEFOR FROM SB8010 WHERE D_E_L_E_T_ = '' AND B8_LOTECTL = C6_LOTECTL AND B8_NUMLOTE = '' AND SUBSTRING(B8_PRODUTO,1,2) ='BL' ),'') AS LOTE_FORNECEDOR\n\t\tcQuery   += \" \t\t\t FROM SC6010 SC6 INNER JOIN SC5010 SC5\n\t\tcQuery   += \" \t\t\t\t   ON (C6_FILIAL = C5_FILIAL AND C6_NUM = C5_NUM )\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA1010 SA1\n\t\tcQuery   += \" \t\t\t\t   ON (A1_COD = C5_CLIENTE AND A1_LOJA = C5_LOJACLI )\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SYA010 SYA\n\t\tcQuery   += \" \t\t\t\t   ON (A1_PAIS = YA_CODGI)\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SA3010\n\t\tcQuery   += \" \t\t\t\t   ON (A1_VEND=A3_COD)\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SB5010 SB5\n\t\tcQuery   += \" \t\t\t\t   ON (C6_PRODUTO = B5_COD)\n\t\tcQuery   += \" \t\t\t\t   INNER JOIN SE4010 SE4\n\t\tcQuery   += \" \t\t\t\t   ON (E4_CODIGO = C5_CONDPAG)\n\t\tcQuery   += \" \t\t\t WHERE SC6.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SC5.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SA1.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SYA.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SB5.D_E_L_E_T_ = ''\n\t\tcQuery   += \" \t\t\t   AND SE4.D_E_L_E_T_ = ''\n\t  //cQuery   += \"              --AND SC5.C5_BLQ <> '1'\n\t\tcQuery   += \" \t\t\t   AND C5_NUM = '\"+SC5->C5_NUM+\"'\n\t\tcQuery   += \" \n\t\tcQuery   += \" )TAB_PROFORMA\n\t\tcQuery   += \" \t FULL OUTER JOIN ZGO010 ZGO\n\t\tcQuery   += \" \t   ON (C5_NUM = ZGO_PEDIDO)\n\t\tcQuery   += \" WHERE C5_NUM <> ''\n\t   //cQuery  += \"   --AND ISNULL(ZGO_INVOIC,'') LIKE '%'+@INVOICE+'%'\n\t\tcQuery   += \" )TB_TOTAL_CAV\n\t\tcQuery   += \" WHERE C6_YCAVALE <> '-'\n\t\tcQuery   += \" )TB_QTD_CAV\n\t\t\n\t\t\n\t\ttcQuery cQuery alias TRB new\n\t\tdbSelectArea(\"TRB\")\n\t\tdbgotop()\n\t\t\n\t\tIF !EOF()\n\t\t\tdbSelectArea(\"SC5\")\t\t\n\t\t\tIf RecLock(\"SC5\",.f.)\n\t\t\t\tReplace SC5->C5_VOLUME1  With TRB->QTD  \n\t\t\t\tMsUnLock()\n\t\t\tEndIf\t\n\t\tEndIf\n\t\t\t\t\t\t\n\t\tdbSelectArea(\"TRB\") \n\t\tdbCloseArea()\n\t\t\n\t\tIf RecLock(\"SC5\",.f.)\n\t\t\tIF SC5->C5_VOLUME1 == 0\n\t\t\t\tSC5->C5_VOLUME1 := 1\n\t\t\tEndIf\n\t\t\tMsUnLock()\n\t\tEndIf\t\n\t\t\n\tEndIf\n\nEndIf\n\nReturn()\n\n/*\nUser Function MDesTot()\n****************************************************************************************************************\n*    Programa dar o desconto  \n*\n****\nLocal nValorTemp := 0\n\nFor nX := 1 To Len(aCols)\n\t\tGdFieldPut(\"C6_DESCONT\",M->C5_DESC1,nX) \nNext nX\n\nReturn(.T.) \n*/\n\nStatic Function MValidPedV(oProcess, lEnd,lRet)\n****************************************************************************************************************\n*   /* Programa para validar o pedido de venda tabela de preço de chapas - Qualitá */\n*\n****\nLocal cQuery := \"\"\n\nLocal nPosCava := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_YCAVALE\"}) //Cavalete\nLocal nPosLOTE := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_LOTECTL\"}) //SubLote\nLocal nPosSUBL := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_NUMLOTE\"}) //Lote\nLocal nPosLOCA := aScan(aHeader, {|x| AllTrim(x[2]) == \"C6_LOCAL\"  }) //Lote\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\n\nLocal fTPBLQ   := .F.\n\nLocal aMsgPrc  := {}\nLoca  nX       := 0\n\nIf !IsBlind()     \n\toProcess:SetRegua1(8)\nEndIf\n\n/*\nSomente para Qualitá\n*/\nConOut(FUNNAME())\nIf SubString(CNUMEMP,1,2) == \"01\" .And. (INCLUI == .T. .Or. ALTERA == .T.) .AND. (FUNNAME() <> \"GROA001\")\n\n\n\tM->C5_XMOTBLQ := \"\"\n\n\t/*\n\tSomente para Mercado Externo\n\tValidação mercado interno campos FollowUp\n\t*/\n\tIf M->C5_YTIPO $ \"ME/MI\"\n\t\tIF M->C5_XSHOWFO == \"S\"\n\t\t\tIf Empty(M->C5_XFOLLST) .Or. Empty(M->C5_XPENDEN) .Or. Empty(M->C5_XDTLIBF)\n\t\t\t\tAlert(\"FollowUp='SIM'! O P.Venda não pode ser salvo sem as informações de Pendência/Situação/Data de Liberação. \")\t\n\t\t\t\tReturn(.F.)\n\t\t\tEndIf\n\t\tEndIf\n\tEndIf\n\n\tcDesMoed := \"\"\n\toFont := TFont():New('Arial Black',,-18,.T.)\n\t\n\tIf     M->C5_MOEDA == 1\n\t\tcDesMoed := \"1 - (R$)   R E A L\"\n\tElseIf M->C5_MOEDA == 2\n\t\tcDesMoed := \"2 - ($)    D O L A R\"\n\tElseIf M->C5_MOEDA == 3\n\t\tcDesMoed := \"3 - (€)    E U R O\"\n\tEndIf\n\t\n\tIf !IsBlind()     \n\t\tDEFINE MSDIALOG _oDlgMoeda TITLE \"Moeda\" FROM u_MGETTELA(178),u_MGETTELA(181) TO u_MGETTELA(342),u_MGETTELA(577) PIXEL\n\t\t\t// Cria as Groups do Sistema\n\t\t\t@ u_MGETTELA(001),u_MGETTELA(003) TO u_MGETTELA(062),u_MGETTELA(195) LABEL \"\" PIXEL OF _oDlgMoeda\n\t\t\n\t\t\t// Cria Componentes Padroes do Sistema\n\t\t\t@ u_MGETTELA(009),u_MGETTELA(010) Say \"Pedido sendo salvo na moeda:\" Size u_MGETTELA(075),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgMoeda\n\t\t\t@ u_MGETTELA(033),u_MGETTELA(078) Say cDesMoed \t\t\t\t\t\t Size u_MGETTELA(090),u_MGETTELA(080) COLOR CLR_HMAGENTA FONT oFont PIXEL OF _oDlgMoeda\n\t\t\t@ u_MGETTELA(064),u_MGETTELA(156) Button \"OK\" ACTION(Close(_oDlgMoeda)) Size u_MGETTELA(037),u_MGETTELA(012) PIXEL OF _oDlgMoeda\n\t\tACTIVATE MSDIALOG _oDlgMoeda CENTERED \n\tEndIf\n\n\tConOut(\"******************************************\" )\n\tConOut(\"Inicio P.E = MT410TOK Qualitá\" )\n\tConOut(\"******************************************\" )\t\n\t/*\n\t****************************************************************\n\tConferencia da tabela de preço com o desconto cadastrado por classificação comercial\n\t****************************************************************\n\t*/\n\tdbSelectArea(\"SA1\")\n\tdbSetOrder(1)\n\tdbSeek(xFilial(\"SA1\") + M->C5_CLIENTE + M->C5_LOJACLI )\n\t\n\tIf !Empty(SA1->A1_INFDESC)\n\t\tAlert(\"Aviso! Este cliente possui um desconto padrão! Verifique sempre pela tela [F5].\")\n\tEndIf\n\t\n\tIF M->C5_TIPO $ \"D\"\n\t\tReturn(.T.)\n\tEndIf\n\t\n\tIf !IsBlind()     \n\t\toProcess:IncRegua1(\"[1-8] - Conferência da tabela de preço com o desconto cadastrado!\")  \n\tEndIf\n\n\tFor nX := 1 To Len(aCols)\n\t\t/*\n\t\tRegra geral de tabela de preços \n\t\t*/\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \n\t\t//\"0005/0006/0034/0035/0036\"\n\t\tdbSelectArea(\"SB1\")\n\t\tdbSetOrder(1)\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\n\t\t\t\t\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\t\t\t\n\t\t\tIf Empty(SA1->A1_TABELA)\n\n\t\t\t\tIf Empty(GdFieldGet(\"C6_YCLASSI\",nX))\n\t\t\t\t\tcClassif := \"P\"\n\t\t\t\tElse\n\t\t\t\t\tcClassif := AllTrim(GdFieldGet(\"C6_YCLASSI\",nX))\n\t\t\t\tEndIf\n\n\t\t\t\tIf GdFieldGet(\"C6_XOFERTA\",nX) == 'N'\n\n\t\t\t\t\tcQuery  := \" SELECT DA1_CODTAB,DA0_DESCRI,DA0_DESGER ,DA1_PRCVEN , CASE WHEN DA1_PERDES=0  THEN 1 WHEN DA1_PERDES<>0 THEN DA1_PERDES END  DA1_PERDES \n\t\t\t\t\tcQuery  += \"   FROM DA0010 DA0 \n\t\t\t\t\tcQuery  += \"        INNER JOIN DA1010 DA1 \n\t\t\t\t\tcQuery  += \" ON (DA0_CODTAB = DA1_CODTAB)\n\t\t\t\t\t\n\t\t\t\t\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) <> 'AM'\n\t\t\t\t\t\tcQuery  += \"  WHERE DA0_YCLASS IN ('\"+ cClassif +\"')\n\t\t\t\t\t\tcQuery  += \"    AND DA1_CODPRO = '\" + AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\"\t\t\n\t\t\t\t\tElse\n\t\t\t\t\t\tcQuery  += \"  WHERE DA1_CODPRO = '\" + AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\"\t\n\t\t\t\t\tEndIf\n\t\t\t\t\t\t\t\n\t\t\t\t\tIF !EMPTY(SA1->A1_MULTTAB)\n\t\t\t\t\t\tcQuery  += \"    AND DA0_CODTAB IN (\"+AllTrim(SA1->A1_MULTTAB)+\")\"\n\t\t\t\t\tELSE\n\t\t\t\t\t\tcQuery  += \"    AND DA0_CODTAB IN ('000','001','002','003')\n\t\t\t\t\tEndIf\n\t\t\t\t\tcQuery  += \"    AND DA0.D_E_L_E_T_ = ''\n\t\t\t\t\tcQuery  += \"    AND DA1.D_E_L_E_T_ = ''\n\t\t\t\t\t\n\t\t\t\t\ttcQuery cQuery alias TRB new\n\t\t\t\t\tdbSelectArea(\"TRB\")\n\t\t\t\t\tdbgotop()\n\t\t\t\t\t\n\t\t\t\t\tIf Empty(TRB->DA1_PRCVEN) .and. !GDDeleted(nX) \n\t\t\t\t\t\tAlert(\"[C6_PRCVEN] - Tabela de preço não encontrada! Linha:(\" + Alltrim(str(nX)) +\") Confira a classif. do produto ou Mult.Tabelas preços no Cad. Cliente.\" )\n\t\t\t\t\t\tlRet := .F. \n\t\t\t\t\t\t//sleep(300)\t\n\t\t\t\t\t\tM->C5_BLQ  := '1'\n\t\t\t\t\tEndIf\n\t\t\t\t\t\n\t\t\t\t\t//If GdFieldGet(\"C6_PRCVEN\",nX) <  IIF(cClassif==\"P\",((TRB->DA1_PRCVEN - TRB->DA0_DESGER)),((TRB->DA1_PRCVEN * TRB->DA0_DESGER))) .and. !GDDeleted(nX)\n\t\t\t\t\tIf GdFieldGet(\"C6_PRCVEN\",nX) <  IIF(cClassif==\"P\",((TRB->DA1_PRCVEN - TRB->DA0_DESGER)),((TRB->DA1_PRCVEN))) .and. !GDDeleted(nX)\n\t\t\t\t\t\t//aAdd(aMsgPrc,\"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + Alltrim(str(nX))+\" Tabela de Preço:\" + AllTrim(TRB->DA1_CODTAB) + \"-\"+ AllTrim(TRB->DA0_DESCRI))  \n\t\t\t\t\t\taAdd(aMsgPrc,\"Cavalete:\"+GdFieldGet(\"C6_YCAVALE\",nX)+\" Tabela de Preço:\" + AllTrim(TRB->DA1_CODTAB) + \"-\"+ AllTrim(TRB->DA0_DESCRI) )\n\t\t\t\t\t\t//lRet := .F.\n\t\t\t\t\t\tConOut(\"******************************************\")\n\t\t\t\t\t\tConOut(\"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + Alltrim(str(nX)))\n\t\t\t\t\t\tConOut(\"******************************************\")\n\t\t\t\t\t\t//sleep(300)\n\t\t\t\t\t\tM->C5_BLQ  := '1'\t\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"PREÇO MENOR QUE A TABELA DE PREÇO:\"+ AllTrim(TRB->DA1_CODTAB),nX)\t\n\t\t\t\t\tELSE\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\n\t\t\t\t\tEndIf\n\n\t\t\t\t\tGdFieldPut(\"C6_PRCREF\",TRB->DA1_PRCVEN,nX)\n\t\t\t\t\t\n\t\t\t\t\tdbSelectArea(\"TRB\") \n\t\t\t\t\tdbCloseArea()\n\t\t\t\telse\n\t\t\t\t\tM->C5_BLQ  := ''\n\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\n\t\t\t\tEndIf\n\n\t\t\t\tIF lRet == .F. .And. !IsBlind()  \n\t\t\t\t\tReturn(lRet) \n\t\t\t\tEndIf\n\t\t\tElse\n\t\t\t\t/*\n\t\t\t\tUsado para definir uma tabela de preço especifica para o cliente\n\t\t\t\t*/\n\t\t\t\tIf GdFieldGet(\"C6_XOFERTA\",nX) == 'N'\n\t\t\t\t\n\t\t\t\t\tcQuery  := \" SELECT DA1_CODTAB,DA0_DESCRI,DA0_DESGER,DA1_PRCVEN , CASE WHEN DA1_PERDES=0  THEN 1 WHEN DA1_PERDES<>0 THEN DA1_PERDES END  DA1_PERDES\n\t\t\t\t\tcQuery  += \"   FROM DA0010 DA0 \n\t\t\t\t\tcQuery  += \"        INNER JOIN DA1010 DA1 \n\t\t\t\t\tcQuery  += \" ON (DA0_CODTAB = DA1_CODTAB)\n\t\t\t\t\t\n\t\t\t\t\tIf SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) <> 'AM'\n\t\t\t\t\t\tcQuery  += \"  WHERE DA1_CODTAB IN ('\"+ M->C5_TABELA +\"')\n\t\t\t\t\t\tcQuery  += \"    AND DA1_CODPRO = '\"+AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\n\t\t\t\t\tElse\n\t\t\t\t\t\t//TABELA PADRÃO DE AMOSTRAS\n\t\t\t\t\t\tcQuery  += \"  WHERE DA1_CODPRO = '\"+AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+\"'\n\t\t\t\t\t\tcQuery  += \"    AND DA0_CODTAB IN ('000')\n\t\t\t\t\tEndIf-\n\t\t\t\n\t\t\t\t\tcQuery  += \"    AND DA0.D_E_L_E_T_ = ''\n\t\t\t\t\tcQuery  += \"    AND DA1.D_E_L_E_T_ = ''\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\ttcQuery cQuery alias TRB new\n\t\t\t\t\tdbSelectArea(\"TRB\")\n\t\t\t\t\tdbgotop()\n\t\t\t\t\t\n\t\t\t\t\tIf Empty(TRB->DA1_PRCVEN) .and. !GDDeleted(nX)\n\t\t\t\t\t\tAlert(\"[C6_PRCVEN] - Tabela de preço não encontrada! Linha:(\" + Alltrim(str(nX)) +\") Confira a classif. do produto ou Mult.Tabelas preços no Cad. Cliente.\" )\n\t\t\t\t\t\tlRet := .F.\n\t\t\t\t\t\t//sleep(300)\n\t\t\t\t\t\tM->C5_BLQ  := '1'\n\t\t\t\t\tEndIf\n\t\t\t\t\t\n\t\t\t\t\tIf GdFieldGet(\"C6_PRCVEN\",nX) <  TRB->DA1_PRCVEN .and. !GDDeleted(nX)\n\t\t\t\t\t\taAdd(aMsgPrc,\"Cavalete:\"+GdFieldGet(\"C6_YCAVALE\",nX)+\" Tabela de Preço:\" + AllTrim(TRB->DA1_CODTAB) + \"-\"+ AllTrim(TRB->DA0_DESCRI) ) \n\t\t\t\t\t\t//lRet := .F.\n\t\t\t\t\t\tConOut(\"******************************************\" )\n\t\t\t\t\t\tConOut(\"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + Alltrim(str(nX)))\n\t\t\t\t\t\tConOut(\"******************************************\" )\n\t\t\t\t\t\t//sleep(300)\t\n\t\t\t\t\t\tM->C5_BLQ  := '1'\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"Preço menor que a tabela:\"+ AllTrim(TRB->DA1_CODTAB),nX)\t\n\t\t\t\t\tELSE\n\t\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\n\t\t\t\t\tEndIf\n\n\t\t\t\t\tGdFieldPut(\"C6_PRCREF\",TRB->DA1_PRCVEN,nX)\n\t\t\t\t\t\n\t\t\t\t\tdbSelectArea(\"TRB\") \n\t\t\t\t\tdbCloseArea()\n\t\t\t\tElse\n\t\t\t\t\tM->C5_BLQ  := ''\n\t\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"\",nX)\n\t\t\t\tEndIf\n\n\t\t\t\tIF lRet == .F. .and. !IsBlind()  \n\t\t\t\t\tReturn(lRet) \n\t\t\t\tEndIf\n\t\t\t\n\t\t\tEndIf\n\t\t\t\t\n\t\tEndIf\n\tNext nX\n\t\n\tcMSG := \"\"\n\t\n\tFor nX:=1 to Len(aMsgPrc)\n\t\t\tIf Empty(cMSG)\n\t\t\t\tcMSG := \"[C6_PRCVEN] - Preço menor que o permitido para esse produto. Linha:\" + chr(13)+chr(10) \n\t\t\tEndIf\n\t\t\tcMSG += aMsgPrc[nX] + chr(13)+chr(10)   \n\tNext nX\n\t\n\t\n\tIf !Empty(cMSG)\n\t\tAlert(cMSG)  \n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\tEndIf\n\t\n\t\n\t/*\n\t***************************************************************************************\n\tVerifica o erro do saldo no cavalete e no pedido \n\t***************************************************************************************\n\t\n\tnQtdPedVend := 0\n\t\n\tFor nX := 1 To Len(aCols)\n\t\n\t\tdbSelectArea(\"SB1\")\n\t\tdbSetOrder(1)\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\n\t\n\t\tnQtdPedVend := GdFieldGet(\"C6_QTDVEN\",nX))\n\t\t\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \n\t\t\tIf !GDDeleted(nX)\n\t\t\t\t\n\t\t\tEndIf\n\t\tEndIf\n\t\t\n\tNext nX\n\t*/\n\t\n\tConOut(\"******************************************\" )\n\tConOut(\"P.E = MT410TOK Qualitá Validação de cavaletes\" )\n\tConOut(\"******************************************\" )\n\n\t/*\n\t****************************************************************\n\tConferencia do cavaletes duplicados no proprio pedido \n\t****************************************************************\n\t*/\n\taNumCav \t:= {}\t\t\n\taTodCav \t:= {}\n    aGriCav \t:= {}\n    aGriCavDup \t:= {}\n    aGriLSPv    := {}\n    aLSPvLoca   := {}\t\n    aCavZero    := {}\n    aNumCavPro  := {}\n\taCavBenef   := {}\n    \n\tFor nX := 1 To Len(aCols)\n\t\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \n\t\t//\"0005/0006/0034/0035/0036\"\n\t\tdbSelectArea(\"SB1\")\n\t\tdbSetOrder(1)\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\n\t\t\n\t\t//ALERT(SB1->B1_COD +\"||\"+ SB1->B1_GRUPO)\n\t\t\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \n\t\n\t\t\tIf !Empty(GdFieldGet(\"C6_YCAVALE\",nX)) .and. !GDDeleted(nX) \n\t\t\t\tIf Empty( aScan(aNumCav,GdFieldGet(\"C6_YCAVALE\",nX)) )\n\t\t\t\t \taAdd(aNumCav   ,GdFieldGet(\"C6_YCAVALE\",nX))\n\t\t\t\t \taAdd(aNumCavPro,{GdFieldGet(\"C6_YCAVALE\",nX),GdFieldGet(\"C6_PRODUTO\",nX)})\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\t\tIf !GDDeleted(nX)\n\t\t\t\tIf Empty(aScan(aGriCav,AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) + GdFieldGet(\"C6_YCAVALE\",nX) + GdFieldGet(\"C6_LOTECTL\",nX) + GdFieldGet(\"C6_NUMLOTE\",nX)) )\n\t\t\t\t\taAdd(aGriCav , AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) + GdFieldGet(\"C6_YCAVALE\",nX) + GdFieldGet(\"C6_LOTECTL\",nX) + GdFieldGet(\"C6_NUMLOTE\",nX)  )\n\t\t\t\t\taAdd(aGriLSPv, {GdFieldGet(\"C6_LOTECTL\",nX) , GdFieldGet(\"C6_NUMLOTE\",nX) , AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))} )\n\t\t\t\tElse\n\t\t\t\t\tIF LEFT(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)),2)<>'AM'\n\t\t\t\t\t\taAdd(aGriCavDup, AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))+GdFieldGet(\"C6_YCAVALE\",nX) + GdFieldGet(\"C6_LOTECTL\",nX) + GdFieldGet(\"C6_NUMLOTE\",nX)  )\n\t\t\t\t\tEndIf\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\t\t\n\t\tEndIf\n\t\t\n\tNext nX\n\t\n\tcMSG := \"\"\n\tFor nX:=1 to Len(aGriCavDup)\n\t\t\tIf Empty(cMSG)\n\t\t\t\tcMSG := \"Duplicados no pedido atual:\" + chr(13)+chr(10) \n\t\t\tEndIf\n\t\t\tcMSG += \"O item: \" + aGriCavDup[nX] + chr(13)+chr(10)   \n\tNext nX\n\t\n\tIf !Empty(cMSG)\n\t\tAlert(cMSG)\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\t\tlRet := .F.\n\t\t\n\t\tIF lRet == .F. .and. !IsBlind()  \n\t\t\tReturn(lRet) \n\t\tEndIf\n\tEndIf\n\t\n\t/*\n\t****************************************************************\n\tConferencia se todos os itens do cavales estao completos (Se estiverem em cavaletes)\n\tCavalete apagado por completo\n\tA mesma rotina confere se existe produtos sem saldo.\n\t****************************************************************\n\t*/\n\tIf !IsBlind()     \n\t\toProcess:IncRegua1(\"[2-8] - Teste de cavales completos,apagados e sem saldo!\")\n\tEndIf\n\n\t/*\n\tSOMENTE SE O PEDIDO NAO ESTIVER FATURADO \n\t*/\n\tIF LEN(AllTrim(M->C5_NOTA)) <> 9\n\t\n\t\t/*\n\t\tVALIDAÇÃO DO CAMPO DA ULTIMA ATUALIZAÇÃO DO FOLLOWUP\n\t\t*/\n\t\tM->C5_XULDTAU := DDATABASE\n\n\t\tFor nX := 1 To Len(aNumCavPro)\n\t\t\n\t\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \n\t\t\t//\"0005/0006/0034/0035/0036\"\n\t\t\tdbSelectArea(\"SB1\")\n\t\t\tdbSetOrder(1)\n\t\t\tdbSeek(xFilial(\"SB1\")+ aNumCavPro[nX][2] )\n\t\t\t\n\t\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\n\t\t\n\t\t\t \tcQuery  := \"  SELECT B8_PRODUTO,B1_DESC,B8_YCAVALE,B8_LOTECTL,B8_NUMLOTE,B8_YCAVALE+B8_LOTECTL+B8_NUMLOTE+B8_LOCAL CHAVE,B8_LOCAL,B8_SALDO \n\t\t\t \tcQuery  += \"    FROM SB8010 SB8 INNER JOIN SB1010 SB1 ON (B8_PRODUTO = B1_COD)\n\t\t\t \tcQuery  += \"   WHERE SB8.D_E_L_E_T_ = ''\n\t\t\t \tcQuery  += \"     AND SB1.D_E_L_E_T_ = ''\n\t\t\t \tcQuery  += \"     AND B8_YCAVALE = '\"+aNumCavPro[nX][1]+\"'\n\t\t\t \tcQuery  += \"     AND B8_PRODUTO = '\"+aNumCavPro[nX][2]+\"'\n\t\t\t \tcQuery  += \"     AND B8_ORIGLAN = 'BD'\n\t\t\t \tcQuery  += \"     AND B8_SALDO   <> 0\n\t\t\t \t\n\t\t\t \ttcQuery cQuery alias TRB new\n\t\t\t\tdbSelectArea(\"TRB\")\n\t\t\t\tdbgotop()\n\t\t\t\tDo While !EOF()\n\t\t\t\t\n\t\t\t\t\t/*\n\t\t\t\t\tcavaletes incompletos\n\t\t\t\t\t*/\n\t\t\t\t\tIF !aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE })  \n\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE , TRB->B8_LOCAL} )\n\t\t\t\t\tElse\n\t\t\t\t\t\tif GDDeleted(aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE }))\n\t\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE,TRB->B8_LOCAL} )\n\t\t\t\t\t\tEndIf \n\t\t\t\t\tEndIf\n\t\t\t\t\t\n\t\t\t\t\t/*\n\t\t\t\t\tSem Saldo\n\t\t\t\t\t*/\n\t\t\t\t\tIf TRB->B8_SALDO == 0  \n\t\t\t\t\t\taAdd(aCavZero,{ TRB->CHAVE ,AllTrim(TRB->B8_PRODUTO)+\"-\"+ AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE, TRB->B8_LOCAL} )\n\t\t\t\t\tEndIf\n\t\t\t\t\t\n\t\t\t\t\tdbSelectArea(\"TRB\") \n\t\t\t\t\tdbSkip()\n\t\t\t\tEndDo\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t/*\n\t\t\t\tCavalete apagado\n\t\t\t\t*/\n\t\t\t\tdbSelectArea(\"TRB\")\n\t\t\t\tdbgotop()\n\t\t\t\tIf EOF() .And.  !Empty(aNumCav[nX])\n\t\t\t\t\n\t\t\t\t\tIF !aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE })  \n\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE, TRB->B8_LOCAL} )\n\t\t\t\t\tElse\n\t\t\t\t\t\tif GDDeleted(aScan(aCols,{|x|x[nPosCava]+x[nPosLOTE]+x[nPosSUBL]+x[nPosLOCA] == TRB->CHAVE }))\n\t\t\t\t\t\t\taAdd(aTodCav,{ TRB->CHAVE , AllTrim(TRB->B1_DESC) , aNumCav[nX] , TRB->B8_LOTECTL , TRB->B8_NUMLOTE , TRB->B8_LOCAL} )\n\t\t\t\t\t\tEndIf \n\t\t\t\t\tEndIf\n\t\t\t\t\t\n\t\t\t\tEndIf\n\n\t\t\t\tdbSelectArea(\"TRB\") \n\t\t\t\tdbCloseArea()\n\t\t\tEndIf\n\n\n\t\t\t/*\n\t\t\tCavalete em beneficiamento não pode \n\t\t\tProibe\n\t\t\t*/\n\t\t\tIf aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] }) <> 0 .AND. M->C5_TIPO = 'B'\n\t\t\t\taAdd(aCavBenef,{ aNumCavPro[nX][1] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][3] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][5] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][10] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][36] , aCols[aScan(aCols,{|x|x[nPosCava] == aNumCavPro[nX][1] })][24]} )\n\t\t\tEndIf\n\t\t\t\n\t\tNext nX\n\n\n\t\tcMSG := \"\"\n\n\t\t/*\n\t\tBeneficiamento\n\t\t*/\t\t\n\t\tFor nX:=1 to Len(aCavBenef)\n\t\t\tIf Empty(cMSG)\n\t\t\t\tcMSG := \"Pedido de Beneficiamento com cavaletes:\" + chr(13)+chr(10) \n\t\t\tEndIf\t\t\t\n\t\t\tcMSG +=     \"  ->\" + AllTrim(aCavBenef[nX][2]) + \" Cav.[\" + Alltrim(aCavBenef[nX][3]) + \"] Lote[\" + Alltrim(aCavBenef[nX][4]) + \"] SubLote[\" + Alltrim(aCavBenef[nX][5]) + \"] Local [\"+ Alltrim(aCavBenef[nX][6]) +\"].\"+ chr(13)+chr(10)   \n\t\tNext nX\n\n\t\t/*\n\t\tIncompletos/Apagado\n\t\t\n\t\tFor nX:=1 to Len(aTodCav)\n\t\t\tIf Empty(cMSG)\n\t\t\t\tcMSG := \"Cavaletes incompletos/Apagado:\" + chr(13)+chr(10) \n\t\t\tEndIf\t\t\t\n\t\t\tcMSG +=     \"  ->\" + AllTrim(aTodCav[nX][2]) + \" Cav.[\" + Alltrim(aTodCav[nX][3]) + \"] Lote[\" + Alltrim(aTodCav[nX][4]) + \"] SubLote[\" + Alltrim(aTodCav[nX][5]) + \"] Local [\"+ Alltrim(aTodCav[nX][6]) +\"].\"+ chr(13)+chr(10)   \n\t\tNext nX\n\t\t*/\n\t\tIf !Empty(cMSG)\n\t\t\tAlert(cMSG)\n\t\t\t//AVISO(\"Cavaletes incompletos:\", cMSG , { \"Fechar\" }, 3)\n\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\t\t\tlRet := .F.\n\n\t\t\tIF lRet == .F. .and. !IsBlind()  \n\t\t\t\tReturn(lRet)\n\t\t\tEndIf \n\t\tEndIf\n\t\n\t\t/*\n\t\tSem Saldo\n\t\t*/\n\t\tcMSG := \"\"\n\t\tFor nX:=1 to Len(aCavZero)\n\t\t\tIf Empty(cMSG)\n\t\t\t\tcMSG := \"Produtos sem saldo:\" + chr(13)+chr(10) \n\t\t\tEndIf\t\t\t\n\t\t\tcMSG +=     \"  ->\" + AllTrim(aCavZero[nX][2]) + \" Cav.[\" + Alltrim(aCavZero[nX][3]) + \"] Lote[\" + Alltrim(aCavZero[nX][4]) + \"] SubLote.[\" + Alltrim(aCavZero[nX][5]) + \"]\"+ chr(13)+chr(10)   \n\t\tNext nX\n\t\t\n\t\tIf !Empty(cMSG)\n\t\t\tIF (!Empty(C5_NOTA).Or.C5_LIBEROK=='E' .And. Empty(C5_BLQ))\n\t\t\t\tAlert(cMSG)\n\t\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\t\t\tELse \n\t\t\t\tAlert(cMSG)\n\t\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\t\t\t\t\n\t\t\t\tlRet := .F.\n\n\t\t\t\tIF lRet == .F. .and. !IsBlind()  \n\t\t\t\t\tReturn(lRet)\n\t\t\t\tEndIf \n\t\t\tEndIf\n\t\tEndIf\n\t\t\n\tEndIf\n\t\n\t/*\n\t****************************************************************\n\tConferencia se existe estes Lote/SubLotes em um PVenda salvo\n\t****************************************************************\n\t*/\n\tIf !IsBlind()     \n\t\toProcess:IncRegua1(\"[3-8] - Conferência se existe  Lote/SubLotes em um P.Venda salvo!\")\n\tENDIF\n\n\tFor nX := 1 To Len(aGriLSPv)\n\t\t \t\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \n\t\t//\"0005/0006/0034/0035/0036\"\n\t\tdbSelectArea(\"SB1\")\n\t\tdbSetOrder(1)\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(aGriLSPv[nX][3]) )\n\t\t\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec .AND. !Empty(aGriLSPv[nX][1])\n\t\t \tcQuery  := \" SELECT C6_NUM,C6_ITEM,C6_LOTECTL,C6_NUMLOTE ,C6_DESCRI \n\t\t \tcQuery  += \"   FROM SC6010 SC6 INNER JOIN SC5010 SC5 ON (C5_FILIAL = C6_FILIAL AND C5_NUM = C6_NUM)\n\t\t \tcQuery  += \"  WHERE SC6.D_E_L_E_T_ = ''\n\t\t \tcQuery  += \"    AND SC5.D_E_L_E_T_ = ''\n\t\t \tcQuery  += \"    AND C5_TIPO = 'N'\n\t\t \tcQuery  += \"    AND C6_NOTA = ''\n\t\t \tcQuery  += \" \tAND C6_LOTECTL = '\"+aGriLSPv[nX][1]+\"'\n\t\t \tcQuery  += \" \tAND C6_NUMLOTE = '\"+aGriLSPv[nX][2]+\"'\n\t\t \tcQuery  += \"    AND C6_NUM <> '\"+AllTrim(M->C5_NUM)+\"'\n\t\t \t\n\t\t \ttcQuery cQuery alias TRB new\n\t\t\tdbSelectArea(\"TRB\")\n\t\t\tdbgotop()\n\t\t\tDo While !EOF()\n\t\t\t\n\t\t\t\tIf !aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })\n\t\t\t\t\taAdd(aLSPvLoca,{ AllTrim(TRB->C6_NUM) , TRB->C6_ITEM,TRB->C6_LOTECTL , TRB->C6_NUMLOTE , AllTrim(TRB->C6_DESCRI) } )\n\t\t\t\tElse\n\t\t\t\t\taLSPvLoca[aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })][2] := aLSPvLoca[aScan(aLSPvLoca,{|x|alltrim(x[1]) == AllTrim(TRB->C6_NUM) })][2] + \",\" + TRB->C6_ITEM\n\t\t\t\tEndIf\n\t\t\t\t\n\t\t\t\tdbSelectArea(\"TRB\") \n\t\t\t\tdbSkip()\n\t\t\tEndDo\n\t\t\t\n\t\t\tdbSelectArea(\"TRB\") \n\t\t\tdbCloseArea()\n\t\t\n\t\tEndIf\n\t\t\n\tNext nX\n\t\n\tcMSG := \"\"\n\tFor nX:=1 to Len(aLSPvLoca)\n\t\t\tIf Empty(cMSG)\n\t\t\t\tcMSG := \"Itens encontrados em outro P.Venda:\" + chr(13)+chr(10) \n\t\t\tEndIf\n\t\t\tcMSG += \"  -> P.Venda:\" + aLSPvLoca[nX][1] +\" Item:\"+ aLSPvLoca[nX][2] +\" Prod.:\" + aLSPvLoca[nX][5] + chr(13)+chr(10)   \n\tNext nX\n\t\n\tIf !Empty(cMSG)\n\t\tAlert(cMSG)\n\t\t//AVISO(\"Itens encontrados em outro P.Venda:\", cMSG , { \"Fechar\" }, 3)\n\t\t//sleep(300)\t\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\t\t\n\t\tlRet := .F.\n\n\t\tIF lRet == .F. .and. !IsBlind()  \n\t\t\tReturn(lRet)\n\t\tEndIf \n\tEndIf\n\t\n\t/*\n\t*******************************************\n\tValidação Valores fiscais e descontos e totais\n\t*******************************************\n\t*/\n\tIf !IsBlind()     \n\t\toProcess:IncRegua1(\"[4-8] - Conferência fiscal, descontos e valores!\")\n\tENDIF\n\n\taDadosGrv := FCalImp(@oProcess)\n\t\n\tIf LEN(aDadosGrv)>0\n\t\tM->C5_XVALEXT := AllTrim(Extenso((aDadosGrv[4] + aDadosGrv[3]) ,.f.,M->C5_MOEDA,,\"3\",.t.,.f.))\n\t\tM->C5_XTOTAL  := (aDadosGrv[4] + aDadosGrv[3]) -  M->C5_DESCONT \n\t\tM->C5_XDESCON := aDadosGrv[2]  + M->C5_DESCONT \n\t\tM->C5_XVLRFIN := (aDadosGrv[4] + aDadosGrv[3]) -  M->C5_DESCONT \n\t\tM->C5_XDESPES := aDadosGrv[4]\n\t\t//M->C5_XSEGURO := aDadosGrv[5]\n\tEndIf \n\t\n\t\t\n\t/*\n\t*******************************************\n\tValidação do peso para Amostras \n\t*******************************************\n\t*/\n\tIf !IsBlind()  \n\t\toProcess:IncRegua1(\"[5-8] - Validação do peso para Amostras!\")\n\tEndIf\n\n\tcMSG := \"\"\n\t\n\tFor nX := 1 To Len(aCols)\n\t\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \n\t\t//\"0005/0006/0034/0035/0036\"\n\t\tdbSelectArea(\"SB1\")\n\t\tdbSetOrder(1)\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\n\t\t\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\n\t\n\t\t\tIf Empty(GdFieldGet(\"C6_XPESO\",nX)) .and. !GDDeleted(nX) .and. SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) == 'AM'\n\t\t\t\n\t\t\t\tIf Empty(cMSG)\n\t\t\t\t\tcMSG := \"Amostras sem Peso:\" + chr(13)+chr(10) \n\t\t\t\tEndIf\n\t\t\t\tcMSG += \"  -> Item do PV:\" + GdFieldGet(\"C6_ITEM\",nX) + \" Prod.:\" + AllTrim(GdFieldGet(\"C6_DESCRI\",nX)) + chr(13)+chr(10)  \n\t\t\t\t\t\t\t\t\n\t\t\tEndIf\n\t\t\t\n\t\t\tIf !GDDeleted(nX) .and. (SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) == 'AM' .Or. AllTrim(GdFieldGet(\"C6_YCLASSI\",nX)) == \"A\")\n\t\t\t\tM->C5_BLQ  := '1'\n\t\t\t\tGdFieldPut(\"C6_XMOTBLQ\",\"Produto Amostra! Requer aprovação.\" ,nX)\n\t\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(\"Produto Amostra! Requer aprovação.\") + chr(13)+chr(10)\n\t\t\t\tcMSG := AllTrim(cMSG) + AllTrim(\"Produto Amostra! Requer aprovação.\") + chr(13)+chr(10)\n\t\t\tEndIf\n\t\t\t\n\t\tEndIf\n\tNext nX\n\t\n\tIf M->C5_DESCONT  <> 0\n\t\tM->C5_BLQ  := '1'\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(\"O Campo de desconto de indenização foi preenchido. Ped. Venda requer aprovação.\" + chr(13)+chr(10))\n\t\tcMSG := AllTrim(cMSG) + \"O Campo de desconto de indenização foi preenchido. Ped. Venda requer aprovação.\" + chr(13)+chr(10)\n\tEndIf\n\t\n\tIF !EMPTY(cMSG)\n\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\t\t\n\t\tIf !IsBlind()  \n\t\t\tIf MsgYesNo(cMSG + chr(13)+chr(10)+ \"Deseja continuar?\" )\n\t\t\t\tlRet := .t.\n\t\t\tElse\n\t\t\t\tlRet := .F.\n\t\t\t\tIF lRet == .F. .and. !IsBlind()  \n\t\t\t\t\tReturn(lRet)\n\t\t\t\tEndIf \n\t\t\tEndIf\n\t\tEndIf\n\n\tEndIf\n\t\n\t/*\n\t*******************************************\n\tValidação para não permitir salvar o pedido com chapas sem cavaletes \n\t*******************************************\n\t*/\n\tIf !IsBlind()\n\t\toProcess:IncRegua1(\"[6-8] - Chapas sem cavaletes!\")\n\tEndIf\n\n\tcMSG := \"\"\n\t\n\t/*\n\tNão validar para filial de SP \n\tnão validar para Pedidos de Transferencia\n\t*/\n\tIF M->C5_YTIPO <> \"TF\" .AND. SubString(CNUMEMP,1,8) == \"01010101\" .and. M->C5_TIPO <> 'B'\n\n\t\tFor nX := 1 To Len(aCols)\n\t\t\n\t\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \n\t\t\t//\"0005/0006/0034/0035/0036\"\n\t\t\tdbSelectArea(\"SB1\")\n\t\t\tdbSetOrder(1)\n\t\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )  \n\t\t\t\n\t\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\n\t\t\n\t\t\t\tIf Empty(GdFieldGet(\"C6_YCAVALE\",nX)) .and. !GDDeleted(nX) .and. SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) == 'CH'\n\t\t\t\t\n\t\t\t\t\tIf Empty(cMSG)\n\t\t\t\t\t\tcMSG := \"Chapas sem cavaletes:\" + chr(13)+chr(10) \n\t\t\t\t\tEndIf\n\t\t\t\t\tcMSG += \"  -> Item do PV:\" + GdFieldGet(\"C6_ITEM\",nX) + \" Prod.:\" + AllTrim(GdFieldGet(\"C6_DESCRI\",nX)) + chr(13)+chr(10)  \n\t\t\t\t\t\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tNext nX\n\t\t\n\t\tIf !Empty(cMSG)\n\t\t\tAlert(cMSG)\n\t\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)  \n\t\t\t\n\t\t\tlRet := .F.\n\n\t\t\tIF lRet == .F. .and. !IsBlind()  \n\t\t\t\tReturn(lRet)\n\t\t\tEndIf \n\t\tEndIf\n\n\tEndIf\n\n\t/*\n\t*******************************************\n\tValidação para não permitir salvar o pedido fora dos almoxarificados ou locais determinados \n\t*******************************************\n\t*/\n\tIf !IsBlind()\n\t\toProcess:IncRegua1(\"[7-8] - Almoxarifado não permitido !\")\n\tENDIF\n\n\tcMSG := \"\"\n\n\tFor nX := 1 To Len(aCols)\n\t\n\t\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \n\t\t//\"0005/0006/0034/0035/0036\"\n\t\tdbSelectArea(\"SB1\")\n\t\tdbSetOrder(1)\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\n\t\t\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\n\t\n\t\t\tIf !GdFieldGet(\"C6_LOCAL\",nX) $ \"03/05\"  .and. !GDDeleted(nX) .and. SubStr(AllTrim(AllTrim(GdFieldGet(\"C6_PRODUTO\",nX))) ,1,2) $ 'CH/AM'\n\t\t\t\n\t\t\t\tIf Empty(cMSG)\n\t\t\t\t\tcMSG := \"Almoxarifado não permitido ! \" + chr(13)+chr(10) \n\t\t\t\tEndIf\n\t\t\t\tcMSG += \"  -> Item do PV:\" + GdFieldGet(\"C6_ITEM\",nX) + \" Prod.:\" + AllTrim(GdFieldGet(\"C6_DESCRI\",nX)) + chr(13)+chr(10)  \n\t\t\t\t\n\t\t\tEndIf\n\t\tEndIf\n\tNext nX\n\t\n\tIf !Empty(cMSG)\n\t\tAlert(cMSG)\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\t\t\n\t\tlRet := .F.\n\n\t\tIF lRet == .F. .and. !IsBlind()  \n\t\t\tReturn(lRet)\n\t\tEndIf \n\tEndIf\n\n\n    /*\n\t*******************************************\n\tValidação dos dados de condição de pagamento\n\t*******************************************\n\t*/\n\tIf !IsBlind()\n\t\toProcess:IncRegua1(\"[8-8] - Validação dos dados de condição de pagamento!\")\n\tEndIf\n\n\tM->C5_CONDPAG := u_ClintToMob(\"PG\")\n\n\tIf ! M->C5_TIPO $ \"D/B\"\n\t\tdbSelectArea(\"SA1\")\n\t\tdbSetOrder(1)\n\t\tIf dbSeek(xFilial(\"SA1\")+M->C5_CLIENTE+M->C5_LOJACLI)\n\t\t\tIf ! AllTrim(M->C5_CONDPAG) $ AllTrim(SA1->A1_XCONDPG)\n\n\t\t\t\tIf Empty(cMSG)\n\t\t\t\t\tcMSG := \"Pedido bloqueado! Condição de pagamento não permitida. Cond. Pag:[\"+ M->C5_CONDPAG +\"].\" + chr(13)+chr(10) \n\t\t\t\tEndIf\n\n\t\t\tEndIf\n\t\tEndIf \n\n\tEndIf\n\n\tIf !Empty(cMSG)\n\t\tAlert(cMSG)\n\t\tM->C5_XMOTBLQ := AllTrim(M->C5_XMOTBLQ) + AllTrim(cMSG) + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\t\tM->C5_BLQ     := \"1\"\n\tEndIf\n\t\n\t/*\n\tVALIDAÇÃO DO MOBGRAN\n\t*/\n\tIf  FunName() $ \"GROA014\" .And. INCLUI == .T.\n\t\t\n\t\tIf !Empty(M->C5_XIDMOB)\n\n\t\t\t/*\n\t\t\tVerifica se existe a chave no mobgran.\n\t\t\t*/\n\t\t\tcQuery  := \" SELECT * FROM ZSA010 WHERE D_E_L_E_T_ = '' AND ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\"' AND ZSA_STATUS ='ATIVA'\n\t\t\t\n\t\t\ttcQuery cQuery alias TRB new\n\t\t\tdbSelectArea(\"TRB\")\n\t\t\tdbgotop()\n\t\t\t\n\t\t\tIf EOF() \n\t\t\t\tlRet := .F.\n\t\t\tEndIf\n\n\t\t\tIf TRB->ZSA_STATUS <> 'ATIVA'\n\t\t\t\tlRet := .F.\n\t\t\tEndIf\n\t\t\t\n\t\t\tIf lRet == .F.\n\t\t\t\tAlert(\"Chave não encontrada ou Status:(>>\"+ TRB->ZSA_STATUS +\"<<) no MobGran!\")\n\t\t\t\tReturn(lRet)\t\n\t\t\tEndIf\n\n\t\t\tdbSelectArea(\"TRB\") \n\t\t\tdbCloseArea()\t\n\n\t\tElse\n\t\t\t\n\t\t\tlRet := .F.\n\t\t\tAlert(\"Chave do MobGran em branco! Favor informar um código.\")\n\t\t\tReturn(lRet)\n\n\t\tEndIf\n\n\tElseIf FunName() $ \"GROA013\" \n\t\tIf AllTrim(M->C5_XIDMOB) == '-'\n\t\t\tlRet := .T.\n\t\telse\n\t\t\tcQuery  := \" SELECT * FROM ZSA010 WHERE D_E_L_E_T_ = '' AND ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\"' AND ZSA_STATUS ='ATIVA'\n\t\t\t\n\t\t\ttcQuery cQuery alias TRB new\n\t\t\tdbSelectArea(\"TRB\")\n\t\t\tdbgotop()\n\t\t\t\n\t\t\tIf EOF() \n\t\t\t\tlRet := .F.\n\t\t\tEndIf\n\n\t\t\tIf TRB->ZSA_STATUS <> 'ATIVA'\n\t\t\t\tlRet := .F.\n\t\t\tEndIf\n\n\t\t\tIf lRet == .F.\n\t\t\t\tAlert(\"Chave não encontrada ou Status:(>>\"+ TRB->ZSA_STATUS +\"<<) no MobGran!\")\n\t\t\t\tReturn(lRet)\t\n\t\t\tEndIf\t\t\t\n\t\t\t\n\t\t\tdbSelectArea(\"TRB\") \n\t\t\tdbCloseArea()\t\n\t\tEndIf\n\tEndIf\n\n\t/*\n\tEnvio de aviso de alteração de pedidos \n\t*/\n\tIF        AllTrim(C5_XSHOWFO) = 'S';\n\t\t.AND. AllTrim(C5_XPENDEN) $ 'COM/LOG';\n\t\t.AND. AllTrim(C5_XFOLLST) = 'BOOKING SOLICITADO'\n\n\t\t/*\n\t\tEMAIL\n\t\t*/\n\t\tIf SC5->C5_YTIPO == \"ME\"\n\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\tElse\n\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\tEndIf\n\t\t\n\t\tConOut(\"Gerando relatório! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\n\t\tsleep(300)\n\t\tConOut(\"Gerando e-mail! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\n\t\t\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"backoffice.es@qualitagroup.com;bruno.lage@grupoqualita.com.br;arlindo.pelissari@grupoqualita.com.br\",'Pedido BOOKING SOLICITADO ! Código:' + SC5->C5_NUM ,'PEDIDO BOOKING SOLICITADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\n\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"bruno.lage@grupoqualita.com.br\",'Pedido BOOKING SOLICITADO ! Código:' + SC5->C5_NUM ,'PEDIDO BOOKING SOLICITADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\n\n\t\t//sleep(500)\n\n\t\t/*\n\t\tWHATSAPP\n\t\t*/\n\t\t/*\n\t\tU_SWENARWAP(\"5527981188913\", \"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM),\"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM)   ,\"RQ0003a\"           ,\"PDF\",\"\\RELINWEB\\RQ0003a.PDF\")\n\t\tsleep(500)\n\t\tU_SWENARWAP(\"5533984022125\", \"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM),\"PEDIDO BOOKING SOLICITADO:\" +AllTrim(SC5->C5_NUM)   ,\"RQ0003a\"           ,\"PDF\",\"\\RELINWEB\\RQ0003a.PDF\")\n\t\t*/\n\tEnd\n\n\t/*\n\tIntegração liberação Pedido de venda Com o Mobgran por tabela\n\tTABELA - ZSC\n\t*/\n\tIf Empty(M->C5_XMOTBLQ) \n\t\t//M->C5_XMOTBLQ := \"06 = Aguardando liberação do vendedor!\" + chr(13)+chr(10) + \"***************************************\" + chr(13)+chr(10)\n\t\tM->C5_BLQ     := \"\"\n\t\tfTPBLQ        := .T.\n\tENDIF\n\n\tIF !Empty(M->C5_XIDMOB) .Or. M->C5_XIDMOB <> '-'\n\t\tu_MIntMGLib(M->C5_NUM , M->C5_XIDMOB , \"SC5\" , M->C5_XMOTBLQ , M->C5_FILIAL , M->C5_XTOTAL , fTPBLQ )\n\tEndIf\n\n\tConOut(\"******************************************\" )\n\tConOut(\"Final P.E = MT410TOK Qualitá\" )\n\tConOut(\"******************************************\" )\n\t\n\tSetKey(VK_F5,)\n\tSetKey(VK_F6,)\nEndIf\n\nIF (lRet == .F. .and. IsBlind()) \n\tlRet := .T.\nEndIf \n\nReturn(lRet)\n\n\nUser Function MIntMGLib(cPedido,XIdMobP,_cTabela, xMotBlq, cMobFilial , nXtotal , fTPBLQ)\n********************************************************************************************************************\n* /* User Integração com MobGran Liberação de pedidos por tabela ZSA ZSC */\n* /**/\n* //\n***\n\nLocal oJson     := JsonObject():New()\nLocal cCliente  := \"\"\nLocal cLoja     := \"\"\nLocal nValor    := 0\nLocal cCondPg   := \"\"\nLocal lSemFin   := .F.\n\n\t\tcQuery := \" SELECT  CAST(ZSC_RJSON AS VARCHAR(8000)) RJSON from \"+ RetSqlName(\"ZSC\")+ \" WHERE ZSC_IDMOBP = '\"+XIdMobP+\"' AND ZSC_TIPO <> 'B' AND ZSC_TIPO = '2' AND ZSC_RJSON IS NOT NULL\"\n\t\n\t\ttcQuery cQuery alias TRB_JSON new\n\t\tdbSelectArea(\"TRB_JSON\")\n\t\tdbgotop()\n\n\t\toJSon:fromJson(TRB_JSON->RJSON)\n\t\n\t\tcCliente  := iif(empty(oJson:GetJSonObject('cliente')),\"\",oJson:GetJSonObject('cliente'))\n\t\tcLoja     := iif(empty(oJson:GetJSonObject('loja'))   ,\"\",oJson:GetJSonObject('loja'))\n\n\t\tif !Empty(oJson:GetJSonObject('cliente'))\n\t\t\tnValor    := round(val(oJson:GetJSonObject('valorTotal')),2) \n\t\tElse\n\t\t\tnValor    := 0\n\t\tEndIf\n\n\t\tcCondPg   := iif(empty(oJson:GetJSonObject('condicaoPagamento')),\"\",oJson:GetJSonObject('condicaoPagamento'))\n\n\t\tdbSelectArea(\"TRB_JSON\") \n\t\tdbCloseArea()\t\n\t\tIf !Empty(oJson:GetJSonObject('cliente'))\n\t\t\tIf \tcCliente+cLoja       == m->C5_CLIENTE+m->C5_LOJACLI .And.;\n\t\t\t\tAllTrim(Str(nValor)) >= AllTrim(Str(nXTotal))    \t.And.;\n\t\t\t\tcCondPg              == m->C5_CONDPAG\n\n\t\t\t\tcQuery := \" UPDATE \"+RetSqlName(\"ZSC\")\n\t\t\t\tcQuery += \"    SET ZSC_TIPO = 'B'\n\t\t\t\tcQuery += \"  WHERE ZSC_IDMOBP  ='\"+ AllTrim(XIdMobP) +\"'\n\t\t\t\tcQuery += \"    AND ZSC_TIPO < '2'\n\t\t\t\t\n\t\t\t\tlSemFin:= .F.\n\t\t\tElse\n\t\t\t\tcQuery := \" UPDATE \"+RetSqlName(\"ZSC\")\n\t\t\t\tcQuery += \"    SET ZSC_TIPO = 'B'\n\t\t\t\tcQuery += \"  WHERE ZSC_IDMOBP  ='\"+ AllTrim(XIdMobP) +\"'\n\n\t\t\t\tlSemFin:= .T.\n\t\t\tEndIf \n\t\tElse\n\t\t\t\tcQuery := \" UPDATE \"+RetSqlName(\"ZSC\")\n\t\t\t\tcQuery += \"    SET ZSC_TIPO = 'B'\n\t\t\t\tcQuery += \"  WHERE ZSC_IDMOBP  ='\"+ AllTrim(XIdMobP) +\"'\n\n\t\t\t\tlSemFin:= .T.\t\n\t\tEndIf\t\n\t\t/*\n\t\tExecucao background do codigo sql\n\t\t*/\n\t\tTcSqlExec(cQuery)\n\n\t\t//regras\n\t\tIf fTPBLQ == .F.\n\t\t\tIf  RecLock(\"ZSC\",.T.)\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\n\t\t\t\t\tReplace ZSC_TIPO   With \"1\"\n\t\t\t\t\tReplace ZSC_MSGRET With IIF(fTPBLQ == .F. ,xMotBlq,\"\" )\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\n\t\t\t\t\tReplace ZSC_SITUAC With IIF(fTPBLQ == .F. ,\"\"    ,\"X\" )\n\t\t\t\t\tReplace ZSC_FLUXOM With IIF(fTPBLQ == .F. ,\"S\"    ,\"\" )\n\t\t\t\tMsUnLock()\n\t\t\tEndIf \n\t\tEndIf\n\t\t//financeiro\n\t\tIf lSemFin \n\t\t\tIf  RecLock(\"ZSC\",.T.)\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\n\t\t\t\t\tReplace ZSC_TIPO   With \"2\"\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\n\t\t\t\tMsUnLock()\n\t\t\tEndIf \n\t\t\t\n\t\t\tIf  RecLock(\"ZSC\",.T.)\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\n\t\t\t\t\tReplace ZSC_TIPO   With \"3\"\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\n\t\t\t\tMsUnLock()\n\t\t\tEndIf \n\n\t\t\tIf  RecLock(\"ZSC\",.T.)\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\n\t\t\t\t\tReplace ZSC_TIPO   With \"4\"\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\n\t\t\t\tMsUnLock()\n\t\t\tEndIf \n\n\t\t\tIf  RecLock(\"ZSC\",.T.)\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\n\t\t\t\t\tReplace ZSC_TIPO   With \"5\"\n\t\t\t\t\tReplace ZSC_MSGRET With \"\"\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\n\t\t\t\tMsUnLock()\n\t\t\tEndIf \n\n\t\t\t/*\n\t\t\tPendencia Vendedor\n\t\t\t*/ \n\t\t\tIf  RecLock(\"ZSC\",.T.)\n\t\t\t\t\tReplace ZSC_FILIAL With xFilial(_cTabela)\n\t\t\t\t\tReplace ZSC_CODIGO With AllTrim(cPedido)\n\t\t\t\t\tReplace ZSC_TIPO   With \"6\"\n\t\t\t\t\tReplace ZSC_MSGRET With IIF(fTPBLQ == .t. ,xMotBlq,\"\")\n\t\t\t\t\tReplace ZSC_IDMOBP With AllTrim(XIdMobP)\n\t\t\t\t\tReplace ZSC_SITUAC With \"\"\n\t\t\t\t\tReplace ZSC_FLUXOM With IIF(fTPBLQ == .t. ,\"S\"    ,\"\")\n\t\t\t\tMsUnLock()\n\t\t\tEndIf \n\t\tEndIf\n\nReturn()\n\n\nUser Function ClintToMob(cTipo)\n****************************************************************************************************************\n* /*Gatilho C5_XIDMOB*/    \n*\n****\nLocal aArea     := GetArea() \nLocal cQuery    := \" SELECT * FROM ZSA010 WHERE D_E_L_E_T_ = '' AND ZSA_IDMOBP = '\"+AllTrim(M->C5_XIDMOB)+\" ' AND ZSA_STATUS ='ATIVA'\nLocal cDadosRet := \"\" \n\ntcQuery cQuery alias TRBidMob new\ndbSelectArea(\"TRBidMob\")\ndbgotop()\n\nConOut(\"****PRINCIPAL**ClintToMob*************\")\n\nIf !EOF()\n\tIf cTipo == \"PG\"\n\t\tcDadosRet  := AllTrim(TRBidMob->ZSA_CPAG)\n\tElse\n\t\tcDadosRet  := AllTrim(TRBidMob->ZSA_CLIENT)\n\tEndIf\nElse\n\tcDadosRet := M->C5_CONDPAG\nEndIf\n\ndbSelectArea(\"TRBidMob\") \ndbCloseArea()\t\n\nRestArea(aArea)\n\nReturn(cDadosRet)\n\n                                                                       \nStatic Function FCalImp(oProcess) \n****************************************************************************************************************\n*    \n*\n****\n************************************** \n* Calculo totais e Impostos\n************************************** \nLocal aArea     := GetArea() \nLocal nX        := 0 \n//Local nPrcTot   := 0\nLocal _aTotalNF := {} \nLocal nValDesc  := 0\nLocal nItem:= 0                             \n\n//IF FunName() == Alltrim(\"GROA014\")\n\n\tConOut(\"************************************\")\n\tConOut(\"MaFisIni\")                 \n\tConOut(\"************************************\")\n\t\n\t// Inicia rotina de calculo dos impostos \n\tMaFisIni(Iif(Empty(M->C5_CLIENT),M->C5_CLIENTE,M->C5_CLIENT),;\t// 1-Codigo Cliente/Fornecedor \n\t     \tM->C5_LOJAENT,;          \t\t\t\t\t\t\t\t// 2-Loja do Cliente/Fornecedor \n\t     \tIIf(M->C5_TIPO$\"DB\",\"F\",\"C\"),;                    \t\t// 3-C:Cliente , F:Fornecedor \n\t     \tM->C5_TIPO,;                    \t\t\t\t\t\t// 4-Tipo da NF \n\t     \tM->C5_TIPOCLI,;          \t\t\t\t\t\t\t\t// 5-Tipo do Cliente/Fornecedor \n\t     \tNil,; \n\t     \tNil,; \n\t     \tNil,; \n\t     \tNil,; \n\t     \t\"GROA014\") \n\t\n     If (Inclui .Or. Altera) \n               nItem:= 0\n\t   \n\t\t\t   ConOut(\"************************************\")\n\t\t\t   ConOut(\"MaFisAdd\")                                  \n\t\t\t   ConOut(\"************************************\") \n\t\t\t   \n\t\t\t   If !IsBlind()\n\t\t\t\t\toProcess:SetRegua2(len(aCols))\n\t\t\t   ENDIF\n\t\t\t   \n               For nX := 1 to len(aCols) \n                    If !GDDeleted(nX)\t\t\t\t\t\t\t//Validar se o registro nao esta deletado \n                         \n                         nItem:= nItem + 1 \t\t\t\t\t\t// Quantidade para recalcular \n                         \n                         // Adiciona dados dos produtos na rotina de calculo de impostos       \n                         MaFisAdd( GdFieldGet(\"C6_PRODUTO\",nX),; \n                                   GdFieldGet(\"C6_TES\"    ,nX),; \n                                   GdFieldGet(\"C6_QTDVEN\" ,nX),; \n                                   GdFieldGet(\"C6_PRCVEN\" ,nX),; \n                                   0,; //GdFieldGet(\"C6_VALDESC\",nX)\n                                   \"\",; \n                                   \"\",; \n                                   0,; \n                                   0,; \n                                   0,; \n                                   0,; \n                                   0,; \n                                   GdFieldGet(\"C6_VALOR\",nX),; \n                                   0,; \n                                   0,; \n                                   0)\n                               \n                         nValDesc := nValDesc + Round(GdFieldGet(\"C6_VALDESC\",nX),2)\n\t\t\t\t\t\t \n\t\t\t\t\t\t If !IsBlind()  \n                         \toProcess:IncRegua2(\"Cavalete [\"+GdFieldGet(\"C6_YCAVALE\",nX)+\"] Lote-Chapa: \"+AllTrim(GdFieldGet(\"C6_LOTECTL\",nX))+\"-\"+GdFieldGet(\"C6_NUMLOTE\",nX)  )\n                         ENDIF\n\n                         //ConOut(nValDesc)\n                         //ConOut(nItem)\n                    EndIf \n                \n               Next nX                \n     EndIf \n     \n     /*\n     _nIcmsRet := 0 \n     For nLo:=1 To nItem           \n          _nIcmsRet += MaFisRet(nLo,\"LF_ICMSRET\") // Retorna valor da ST  \n     Next nLo       \n     */\n\t   \n\t aAdd(_aTotalNF,MaFisRet(,\"NF_TOTAL\"))\n\t aAdd(_aTotalNF,nValDesc)\n\t aAdd(_aTotalNF,MaFisRet(,\"NF_BASEDUP\"))\n \t aAdd(_aTotalNF,M->C5_DESPESA)\n\t //aAdd(_aTotalNF,MaFisRet(,\"NF_SEGURO\"))  \n\t\n\t MaFisEnd() \t// Encerra rotina de calculo de impostos \n\n//EndIf\n\nRestArea(aArea) \n\nReturn(_aTotalNF)\n\n\nUser Function GMA410MNU() \n****************************************************************************************************************\n*    \n*\n****\nLocal aButtons := {}\n\nIF FunName() == Alltrim(\"GROA014\")\t\n\t//Gerando invoice\n\taRotina[16][1] := \"Gerar Invoice\"\n\taRotina[16][2] := 'Processa({|| u_MNumInv()},,\"Gravando....\")'\n\t\n\t//\"Imprime Packing List\"\n\t//aRotina[20][2] := \"u_RelInWeb('RQ0002','Imprime Packing List [RQ0002]','u_fParAut(2)')\"\n\taRotina[17][2][5][2] := \"u_RelInWeb('RQ0002','Imprime Packing List [RQ0002]','u_fParAut(2)')\"\n\t\n\t//\"Imprime Commercial Invoice\" \n\t//aRotina[19][2] := \"u_RelInWeb('RQ0004','Imprime Invoice (CH/AM)[RQ0004]','u_fParAut(4)')\"\n\taRotina[17][2][4][2] := \"u_RelInWeb('RQ0004','Imprime Invoice (CH/AM)[RQ0004]','u_fParAut(4)')\"\n\t\n\t//\"Imprime Proforma Invoice\"\n\t//aRotina[18][2] := \"u_RelInWeb('RQ0003','Imprime Proforma Invoice [RQ0003]','u_fParAut(2)')\"\t \n\taRotina[17][2][3][2] := \"u_RelInWeb('RQ0003','Imprime Proforma Invoice [RQ0003]','u_fParAut(2)')\"\n\t\n\t//aRotina[17][2] := \"U_proformaInvoice()\"//#Brittes Alterada chamada da Funcao\n\t//\"Imprime Pedido de Venda\"\n\taRotina[17][2][1][1] := \"Pre-Nota\" \n\taRotina[17][2][1][2] := \"u_MATR730Q()\"\n\t\n\t//\"Imprime Romaneio\"\n\taRotina[17][2][2][1] := \"Imprime Invoice (BLOCOS)\"\n\taRotina[17][2][2][2] := \"u_RelInWeb('RQ0004_BLOCK','Imprime Invoice (BLOCOS) [RQ0004_BLOCK]'    ,'u_fParAut(4)')\"\n\t//aadd(aRotina,{'Imprime Invoice (BLOCOS)',\"u_RelInWeb('RQ0004_BLOCK','Imprime Invoice (BLOCOS) [RQ0004_BLOCK]'    ,'u_fParAut(4)')\" , 0 , 3,0,NIL})\n\t\nElseIf FunName() == Alltrim(\"GROA013\")\n\n\taadd(aRotina,{'Imp. Packing List',\"u_RelInWeb('RQ0002_P','Imprime Packing List [RQ0002_P]'    ,'u_fParAut(2)')\" , 0 , 3,0,NIL})\n\taadd(aRotina,{'Imp. Proforma'    ,\"u_RelInWeb('RQ0003_P','Imprime Proforma Invoice [RQ0003_P]','u_fParAut(2)')\" , 0 , 3,0,NIL})\t\n\taadd(aRotina,{'Pre-Nota'    \t ,\"u_MATR730Q()\" \t\t\t\t\t\t\t\t\t\t\t  \t\t\t\t\t, 0 , 3,0,NIL})\t\n\t\nEndIf\n\naadd(aRotina,{'Ajustes Gerais {P.Venda}',\"u_AjuGerais()\" , 0 , 3,0,NIL})\n\naadd(aRotina,{'Aprovação WhatsApp ',\"u_WAppAprov()\" , 0 , 3,0,NIL})\n\naadd(aRotina,{'Limpar FollowUp' ,\"u_ClearFol()\"  , 0 , 3,0,NIL})\t\n\nReturn aButtons\n\nUser Function ClearFol()\n****************************************************************************************************************\n*    // LIMPA FOLLOWUP PELO PERIODO SOMENTE OVADOS\n*\n****\nLocal cQuery:=\"\"\n\nPrivate aPerg := {}\nPrivate cPerg := \"MLIMPAFOLL\"\n\nAadd(aPerg,{cPerg,\"Data Incial  ?\"\t\t,\"D\",08,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\nAadd(aPerg,{cPerg,\"Data Final   ?\"\t\t,\"D\",08,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\n\nU_Testasx1(cPerg,aPerg,.T.)\n\nIf ! Pergunte(cPerg,.T.)\n\tReturn()\nEndIf\n\nIf Empty(mv_par01)\n\tAlert(\"Data inicial não pode ficar em branco!\")\n\tReturn()\nEndIf\n\nIf Empty(mv_par02)\n\tAlert(\"Data final não pode ficar em branco!\")\n\tReturn()\nEndIf\n\ncQuery :=  \"  UPDATE SC5010\ncQuery +=  \"    SET C5_XSHOWFO =\t'N'\ncQuery +=  \"  WHERE R_E_C_N_O_ IN(\ncQuery +=  \"  \t\t\t\t\t\tSELECT REC FROM (\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\tSELECT\t  R_E_C_N_O_ REC,\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  C5_FILIAL,\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  C5_NUM ,\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  C5_NOTA+'/'+C5_SERIE AS NF,\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t\t\t  (SELECT F2_EMISSAO FROM SF2010 WHERE D_E_L_E_T_ = '' AND F2_FILIAL = C5_FILIAL AND F2_DOC = C5_NOTA AND F2_SERIE = C5_SERIE AND F2_CLIENTE = C5_CLIENTE AND F2_LOJA = C5_LOJACLI) DATA\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t  FROM SC5010 \ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t WHERE D_E_L_E_T_ = ''\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND C5_XSHOWFO IN('S')\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND C5_TIPO IN ('N')\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND C5_XVLRFIN <> 0\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t\t   AND RTRIM(LTRIM(C5_XFOLLST)) IN ('OVADO','CARREGADO','FATURADO')\ncQuery +=  \"  \t\t\t\t\t\t\t\t\t)TB_TEMP\ncQuery +=  \"  \t\t\t\t\t\t WHERE DATA BETWEEN '\"+dToS(mv_par01)+\"' AND '\"+dToS(mv_par02)+\"'\ncQuery +=  \"  \t\t\t\t\t\t)\n\nTcSQLExec(cQuery)\n\nAlert(\"FollowUp removidos com sucesso!\")\n\nReturn()\n\nUser Function WAppAprov()\n****************************************************************************************************************\n*    \n*\n****\nLocal cProt   := \"\"\n//Local cProt2  := \"\"\nLocal cMotiv  := \"\"\nLocal cQuery  := \"SELECT DISTINCT UPPER(RTRIM(LTRIM(C6_XMOTBLQ))) C6_XMOTBLQ FROM SC6010 WHERE D_E_L_E_T_ ='' AND C6_FILIAL+C6_NUM = '\" + SC5->C5_FILIAL + SC5->C5_NUM + \"' AND UPPER(RTRIM(LTRIM(C6_XMOTBLQ))) <> ''\n\n\ntcQuery cQuery alias TRBE new\ndbSelectArea(\"TRBE\")\ndbgotop()\n\nDo While !EOF()\n\t\n\tcMotiv := cMotiv + TRBE->C6_XMOTBLQ + chr(13)+chr(10)\n\n\tdbSelectArea(\"TRBE\") \n\tdbSkip()\nEndDo\n\ndbSelectArea(\"TRBE\") \ndbCloseArea()\n\nIF FunName() == Alltrim(\"GROA014\")\n\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\nElseIf FunName() == Alltrim(\"GROA013\")\n\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\nEndIf\n\nsleep(4000)\n\n/*\nLimite de Credito\n*/\n//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0057&CLIENTES='+AllTrim(SC5->C5_CLIENTE)+AllTrim(SC5->C5_LOJACLI)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0057.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\n//Grupo de Faturamento Whatsapp\n\n/*\nTeste\n*/\n//cProt  := U_SWENARWAP(\"5551997331669\",\"Aprovação da Proforma:\" +AllTrim(SC5->C5_NUM) + chr(13)+chr(10) + \" Motivo:\" + cMotiv + chr(13)+chr(10) + \" Usuário:\" + SUBSTR(CUSUARIO,7,15), \"PROFORMA\"+AllTrim(SC5->C5_NUM),\"RQ0003\",\"PDF\",\"\\RELINWEB\\RQ0003.pdf\")\n\n/*\nOficial\n*/\ncProt  := U_SWENARWAP(\"5527995295180-1587589430@g.us\",\"Aprovação da Proforma:\" +AllTrim(SC5->C5_NUM) + chr(13)+chr(10) + \" Motivo:\" + cMotiv + chr(13)+chr(10) + \" Usuário:\" + SUBSTR(CUSUARIO,7,15), \"PROFORMA\"+AllTrim(SC5->C5_NUM),\"RQ0003\",\"PDF\",\"\\RELINWEB\\RQ0003.pdf\")\n\nIF cProt = \"\" .or. cProt = nil \n\tAlert(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde!\")\n\tReturn()\nEndIf\n\nIf  RecLock(\"WAM\",.T.) \n\n\tReplace WAM_FILIAL  With \"\" \n\tReplace WAM_DATA    With Date()\n\tReplace WAM_HORA    With Time()\n\tReplace WAM_ID      With cProt\n\tReplace WAM_MSG     With \"Aprovação da Proforma:\" +AllTrim(SC5->C5_NUM) + \"Motivo:\" + cMotiv +  \"Usuário:\" + SUBSTR(CUSUARIO,7,15) + \" Cliente: \" + AllTrim(SC5->C5_XFRFORW) \n\t//Replace WAM_TELL    With \"5551997331669\"\n\t//Replace WAM_TELL    With \"5533984022125\"\n\tReplace WAM_INDEX   With SC5->C5_FILIAL + SC5->C5_NUM\n\tReplace WAM_PERG    With \"S\"\n\t//Replace WAM_DATAR   With \"\"\n\t//Replace WAM_HORAR   With \"\"\n\t//Replace WAM_RESPOSV With \"\"\n\t\n\tIF SubString(CNUMEMP,1,2) == \"05\"\n\t\tReplace WAM_EXEC    With 'ITINGA-PV'\n\tElse\n\t\tReplace WAM_EXEC    With 'QUALITA-PV'\n\tEndIf\n\t\n\n   MsUnLock()\nEndIf\n\t\t\nAlert(\"WhatsApp enviado com sucesso! \" + cProt)\n\nReturn()\n\n\nUser Function WAppResp()\n****************************************************************************************************************\n*NÃO USADO     \n*\n**** \nLocal cQuery  := \"SELECT TOP 1 * FROM WAM010 WHERE D_E_L_E_T_ = '' AND WAM_INDEX = '\"+SC5->C5_FILIAL + SC5->C5_NUM+\"' ORDER BY R_E_C_N_O_ DESC\"\n\t\t\t\t  \nLocal aRetMsg := \"\"\n\ntcQuery cQuery alias TRB new\ndbSelectArea(\"TRB\")\ndbgotop()\n\nIf !Empty(TRB->WAM_ID)\n\taRetMsg :=\tstrTokArr(U_SWREMGWAP(TRB->WAM_ID), ',' )\nEndIf\n\ndbSelectArea(\"TRB\") \ndbCloseArea()\n\nIf !\"false\" $ aRetMsg[7]\n\tIf (\"SIM\" $ Upper(aRetMsg[8])) .OR. ( \"APROVADO\" $ Upper(aRetMsg[8]) )\n\t\n\t \n\t\tRecLock(\"SC5\",.F.)\n\t\t\tSC5->C5_BLQ  := ''\n\t\tMsUnlock()\t\n\t\t/*\n\t\tdbSelectArea(\"SC6\")\n\t\tdbSetOrder(1)\n\t\tdbSeek(SC5->C5_FILIAL + SC5->C5_NUM)\n\t\tWhile SC6->(!EOF()) .And. SC6->C6_FILIAL + SC6->C6_NUM == SC5->C5_FILIAL + SC5->C5_NUM\n\t\t                                      \n\t\t      MaLibDoFat(SC6->(RecNo()),SC6->C6_QTDVEN,,,.T.,.T.,.F.,.F.)\n\t\t\n\t\t   SC6->(dBSkip())\n\t\tEndDo\n\t\t*/\n\tEndIf\nElse \n\tAlert(\"Pedido ainda não liberado!\")\nEndIf\n\nReturn() \n\nUser Function AjuGerais()\n****************************************************************************************************************\n*    \n*\n****\nPrivate aPerg := {}\nPrivate cPerg := \"AJUSGERAIS\"\nPrivate nOpc  := 0\n\nnOpc := Aviso(\"Atenção\",\"Estes ajustes devem ser usados somente em casos especiais! Pedido: [\"+SC5->C5_NUM+\"] .\" ,{\"Confirma\",\"Abandona\"})\t\n\nIf nOpc == 2\n\tReturn()\nEndIf\n                  \nAadd(aPerg,{cPerg,\"Alterar o peso líquido:\",\"N\",12,04,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\nAadd(aPerg,{cPerg,\"Alterar o peso bruto :\" ,\"N\",12,04,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\n\nAadd(aPerg,{cPerg,\"Alterar qtd volume 1:\"  ,\"N\",03,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})     \nAadd(aPerg,{cPerg,\"Alterar qtd Box:\"       ,\"N\",03,00,\"G\",\"\",\"\",\"\",\"\",\"\",\"\",\"\",\"\"})\n\nU_Testasx1(cPerg,aPerg,.t.) \n\nIf ! Pergunte(cPerg,.T.)\n\tReturn()\nEndIf\n\nRecLock(\"SC5\",.F.)\n\tSC5->C5_PESOL    := mv_par01\n\tSC5->C5_PBRUTO   := mv_par02\n\tSC5->C5_VOLUME1  := mv_par03\n\tSC5->C5_VOLUME2  := mv_par04\nMsUnlock()\t\n\nAviso(\"Atualização:\",\"Pedido: [\"+SC5->C5_NUM+\"] atualizado com sucesso!\" ,{\"Ok\"})\n\nReturn()\n\n\nUser Function MNumInv()\n****************************************************************************************************************\n*    \n*\n****\nLocal cNumInvo := GetMv(\"MV_XNUMINV\")\nLocal cQuery   := \"\"\n\nIF EMPTY(SC5->C5_YINVOIC)\n\t\n\tProcRegua(3) \n\t\n\tPutMv(\"MV_XNUMINV\",Soma1(cNumInvo))\n\t\n\tIncProc(\"Criando Invoice:\" + cNumInvo) \n\tSleep( 1000 ) \n\t\n\tIncProc(\"Salvando...\" + cNumInvo)\n\tSleep( 1000 ) \n\t\n\tIncProc(\"Liberando....\" + cNumInvo)\n\tSC5->(reclock(\"SC5\", .F.))\n\tSC5->C5_YINVOIC := cNumInvo\t\t\t\t\t\t\t\t\t\n\tSC5->(msUnLock())\n\tSleep( 1000 )\n\t\n\tAVISO(\"Invoice\", \"Invoice gerada com sucesso! Número=\" + cNumInvo  , { \"Fechar\" }, 1)\n\t\n\t//U_GROA014A()\n\t//AxInclui(\"SZO\")\n\t\n\tdbSelectArea(\"ZGO\")\n\tdbSetOrder(1)\n\tIf dbSeek(xFilial(\"ZGO\") + SC5->C5_NUM + SC5->C5_CLIENTE + SC5->C5_LOJACLI)\n\t\tZGO->(reclock(\"ZGO\", .F.))\n\t\tZGO->ZGO_INVOIC := cNumInvo\t\t\t\t\t\t\t\t\t\n\t\tZGO->(msUnLock())\n\t\t//U_GROA014A()\n\tElse\n\t\tZGO->(reclock(\"ZGO\", .T.))\n\t\tZGO->ZGO_FILIAL := xFilial(\"ZGO\")\n\t\tZGO->ZGO_INVOIC := cNumInvo\t\n\t\tZGO->ZGO_PEDIDO := SC5->C5_NUM\n\t\tZGO->ZGO_CLIENT := SC5->C5_CLIENTE\n\t\tZGO->ZGO_LOJA\t:= SC5->C5_LOJACLI\t\t\t\t\t\t\n\t\tZGO->(msUnLock())\n\tEndIf\n\t\n\tcQuery := \"SELECT CAST(M2_DATA AS DATE) DATA, MAX(M2_MOEDA2) 'DOLAR' , MAX(M2_MOEDA3) 'EURO'\n\tcQuery += \"  FROM SM2010\n\tcQuery += \"  WHERE D_E_L_E_T_ = ''\n\tcQuery += \"    AND M2_DATA  = '\"+DToS(dDataBase)+\"'\n\tcQuery += \"   GROUP BY M2_DATA\n\t\n\tTcQuery cQuery Alias TMP_MOEDA New\n\tdbSelectArea(\"TMP_MOEDA\")\n\t\n\tSC5->(reclock(\"SC5\", .F.))\n\tSC5->C5_MENNOTA := AllTrim(SC5->C5_MENNOTA) + \" //INVOICE:\" + SC5->C5_YINVOIC + \"-\" + LEFT(DToS(dDataBase),4) +  \"  TAXA DO DOLAR R$:\" + AllTrim(STR(TMP_MOEDA->DOLAR)) + \" CNTR:\" + AllTrim(SC5->C5_XCONTAI) \n\tSC5->(msUnLock())\n\t\n\tdbSelectArea(\"TMP_MOEDA\")\n\tdbCloseArea()            \nElse \n\n\tAVISO(\"Invoice\", \"Já existe invoice para esse pedido! Número=\" + SC5->C5_YINVOIC  , { \"Fechar\" }, 1)\n\nEndIf\t\n\nReturn()\n\n\nUser Function fParAut(nTipo)\n****************************************************************************************************************\n*    \n*\n****\nLocal cRet := \"\"\n\nIf nTipo = 2\n\tcRet :=  \"&FILIAL=\" + AllTrim(SC5->C5_FILIAL) +\"&NUMPED=\" + AllTrim(SC5->C5_NUM) \nElse\n\tdbSelectArea(\"ZGO\")\n\tdbSetorder(1)\n\tIf dbSeek(xFilial(\"ZGO\")+AllTrim(SC5->C5_NUM))\n\t\tcRet := \"&FILIAL=\" + AllTrim(ZGO->ZGO_FILIAL) +\"&INVOICE=\" + AllTrim(ZGO->ZGO_INVOIC)\n\tElse\n\t\tAlert(\"Pedido de venda sem Invoice!\")\n\tEndIf\nEndIf\n\nReturn(cRet)\n\n\nUser Function GA410CONS() \n****************************************************************************************************************\n*    \n*\n****\nLocal aButtons := {}\n\nSetKey(VK_F5,{||u_MCONSUTDET()})\nSetKey(VK_F6,{||u_GERAMSGPAD()})\n\naAdd(aButtons, {\"\", {|| u_MCONSUTDET()}, \"[F5] Consulta GrPlus\", \"[F5] Consulta GrPlus\"})\naAdd(aButtons, {\"\", {|| u_GERAMSGPAD()}, \"[F6] Gera Msg Padrão\", \"[F6] Gera Msg Padrão\"})\n\nReturn aButtons\n\nUser Function GERAMSGPAD()\n****************************************************************************************************************\n*    \n*\n****\nLocal cQuery   := \"\"         \n//Local aPeso    := {}\n//Local nResult  := 0     \n//Local cBoleto  := \"\"\nLocal cMsgNota := \"\"    \n//Local cMsgNota2:= \"\"                         \nLocal cNotas   := \"\"\nLocal aGriCavDW:= {}\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\nLocal cInCavDw := \"\"\nLocal nX       := 0\n\n/*\nMensagem foi retirada de uso conforme chamado numero 1109\nControle de drawback em tempo Real.\n*/\nIF TYPE(\"aCols\") == \"A\"\n\tFor nX := 1 To Len(aCols)\n\t\tdbSelectArea(\"SB1\")\n\t\tdbSetOrder(1)\n\t\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\n\t\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec \n\t\t\tIf !GDDeleted(nX) .and. LEFT(GdFieldGet(\"C6_LOTECTL\",nX),2)=='DW'\n\t\t\t\tIf Empty(aScan(aGriCavDW,GdFieldGet(\"C6_LOTECTL\",nX)) )\n\t\t\t\t\taAdd(aGriCavDW , GdFieldGet(\"C6_LOTECTL\",nX)  )\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tEndIf\n\tNext nX\n\tIf !Empty(aGriCavDW)\n\t\tFor nX := 1 To Len(aGriCavDW)\t\t\n\t\t\taGriCavDW[nX] := LEFT(AllTrim(aGriCavDW[nX]),8)\n\t\t\tcInCavDw := cInCavDw +  \"'\"+AllTrim(aGriCavDW[nX])+\"',\"\n\t\tNext nX\n\t\tcInCavDw := Left(cInCavDw,Len(cInCavDw)-1)\n\tEndIf\n\t\n\n\tIf !Empty(cInCavDw)\n\t\t\n\t\tcQuery := \" SELECT DISTINCT DOC ,\n\t\tcQuery += \" \t\t\t\tEMISSAO\n\t\tcQuery += \"   FROM(\n \t\tcQuery += \" \t SELECT\n \t\tcQuery += \" \t\t\tLOTE,\n\t\tcQuery += \" \t\t\tIIF(EMISSAO<>'',EMISSAO,ISNULL((SELECT TOP 1 D1_EMISSAO FROM SD1010 WHERE D_E_L_E_T_ = '' AND D1_LOTECTL = LEFT(LOTE, LEN(RTRIM(LTRIM(LOTE)))-1) AND LEFT(D1_COD,2) = 'BL'),'')) EMISSAO,\n \t\tcQuery += \" \t\t\tIIF(DOC<>'',DOC,ISNULL((SELECT TOP 1 D1_DOC FROM SD1010 WHERE D_E_L_E_T_ = '' AND D1_LOTECTL = LEFT(LOTE, LEN(RTRIM(LTRIM(LOTE)))-1) AND LEFT(D1_COD,2) = 'BL'),'')) DOC\n \t\tcQuery += \" \t   FROM (\n \t\tcQuery += \" \t\t\tSELECT\tLOTE,\n \t\tcQuery += \" \t\t\t\t\tIIF(FORNECE<>'000011','', DOC) DOC,\n \t\tcQuery += \" \t\t\t\t\tEMISSAO,\n\t\tcQuery += \" \t\t\t\t\tD1_SERIE,\n \t\tcQuery += \" \t\t\t\t\tFORNECE\n \t\tcQuery += \" \t\t\t\t\tFROM (\t\n \t\tcQuery += \" \t\t\t\t\t\t\tSELECT DISTINCT D1_LOTECTL LOTE, \t\t\t\t\n \t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_DOC DOC,\n\t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_EMISSAO EMISSAO, \n \t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_SERIE,\n \t\tcQuery += \" \t\t\t\t\t\t\t\t\t\t\tD1_FORNECE  FORNECE\n \t\tcQuery += \" \t\t\t\t\t\t\tFROM SD1010 \n \t\tcQuery += \" \t\t\t\t\t\t\tWHERE D_E_L_E_T_ = '' \n \t\tcQuery += \" \t\t\t\t\t\t\tAND D1_LOTECTL IN (\"+cInCavDw+\")\n \t\tcQuery += \" \t\t\t\t\t\t )TB_TEMP\n \t\tcQuery += \" \t\t  )TAB_TEMP\n \t\tcQuery += \" \t)TAB_TEMP_FIM\n \t\tcQuery += \" WHERE DOC <> ''\n\t\t\n\t\tTcQuery cQuery Alias TMP_NOTA New\n\t\tdbSelectArea(\"TMP_NOTA\")\n\t\t\n\t\tDo While !EOF()\n\t\t\n\t\t\tcNotas := cNotas + AllTrim(TMP_NOTA->DOC) + \"-\" + dtoc(STOd(TMP_NOTA->EMISSAO))+ \" ,\"  \n\t\t\n\t\t\tdbSelectArea(\"TMP_NOTA\")\n\t\t\tdbSkip()\n\t\tEndDo\n\t\t\n\t\tdbSelectArea(\"TMP_NOTA\")\n\t\tdbCloseArea()\n\t\n\t\t//cMsgNota += \"ESTA NOTA FISCAL CONTEM INSUMOS IMPORTADOS ADQUIRIDOS DE ITINGA MINERACAO LTDA. PELA NF:\"+cNOtas+\" AMPARADO PELO REGIME DRAWBACK INTEGRADO - MODALIDADE SUSPENSAO, TIPO INTERMEDIARIO ATO CONCESSÓRIO Nº 20190019344 DE 08/05/2019.///\"   \n\tEndIf\n\t\n\tcQuery := \"SELECT CAST(M2_DATA AS DATE) DATA, MAX(M2_MOEDA2) 'DOLAR' , MAX(M2_MOEDA3) 'EURO'\n\tcQuery += \"  FROM SM2010\n\tcQuery += \"  WHERE D_E_L_E_T_ = ''\n\tcQuery += \"    AND M2_DATA  = '\"+DToS(dDataBase)+\"'\n\tcQuery += \"  GROUP BY M2_DATA \n\t\n\tTcQuery cQuery Alias TMP_MOEDA New\n\tdbSelectArea(\"TMP_MOEDA\")\n\t\n\tcMsgNota += \"INVOICE:\" + AllTrim(M->C5_YINVOIC) + \"-\" + LEFT(DToS(dDataBase),4) +  \"  TAXA DO DOLAR R$:\" + AllTrim(STR(TMP_MOEDA->DOLAR)) + \" CNTR:\" + AllTrim(M->C5_XCONTAI) + \" LACRE:\" + AllTrim(M->C5_XSEAL)\n\t\t        \n\tdbSelectArea(\"TMP_MOEDA\")\n\tdbCloseArea()                       \n\t\n\tIf !Empty(m->C5_MENNOTA)\n\t\tIf MsgYesNo(\"O campo [C5_MENNOTA], já possui informção. Deseja subistituir a mensagem original?\" )\n\t\t\tm->C5_MENNOTA := memoline(AllTrim(cMsgNota),254,1,,.T.)\n\t\t\tm->C5_MSG2    := memoline(AllTrim(cMsgNota),254,2,,.T.)\n\t\tEndIf\t\t\n\tElse\n\t\tm->C5_MENNOTA := memoline(AllTrim(cMsgNota),254,1,,.T.)\n\t\tm->C5_MSG2    := memoline(AllTrim(cMsgNota),254,2,,.T.)\n\tEndIf\n\t\nElse\n\n\tSetKey(VK_F5,)\n\tSetKey(VK_F6,)\n\nEndIf\n\nReturn\n\nStatic Function MAltVlrAut(cNumItem,cNumChapa) \n****************************************************************************************************************\n*    \n*\n****\nLocal nEdit1\t := 0\nLocal oEdit1\n\nLocal nEdit2\t := 0\nLocal oEdit2\n\nLocal nEdit3\t := SA1->A1_INFDESC\nLocal oEdit3\n\n//Local nEdit4\t := 0\n//Local oEdit4\n\nLocal lNExec     := .F.\nLocal lNDele     := .F.\n\nLocal nX         := 0\n\n// Variaveis Private da Funcao\nPrivate _oDlgVlr\t\t\t\t// Dialog Principal\n\n// Variaveis que definem a Acao do Formulario                    \nDEFINE MSDIALOG _oDlgVlr TITLE \" ITEM \" + cNumItem   FROM u_MGETTELA(223),u_MGETTELA(173) TO u_MGETTELA(359),u_MGETTELA(520) PIXEL\n\n\t// Cria as Groups do Sistema\n\t@ u_MGETTELA(003),u_MGETTELA(005) TO u_MGETTELA(044),u_MGETTELA(168) LABEL \"\" PIXEL OF _oDlgVlr\n\n\t// Cria Componentes Padroes do Sistema\n\t@ u_MGETTELA(010),u_MGETTELA(008) Say \"Valor Negociado:\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\n\t@ u_MGETTELA(010),u_MGETTELA(050) MsGet oEdit1 Var nEdit1            Size u_MGETTELA(35)  ,u_MGETTELA(009) picture(\"@E 9,999,999.99999\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\n\t\n\t@ u_MGETTELA(010),u_MGETTELA(085) Say \"Desconto padrão: {%}\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\n\t@ u_MGETTELA(010),u_MGETTELA(130) MsGet oEdit3 Var nEdit3            Size u_MGETTELA(35) ,u_MGETTELA(009) when(.f.) picture(\"@E 99.99\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\n\t\n\t@ u_MGETTELA(028),u_MGETTELA(008) Say \"Novo desconto: {%}\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\n\t@ u_MGETTELA(028),u_MGETTELA(050) MsGet oEdit2 Var nEdit2            Size u_MGETTELA(35) ,u_MGETTELA(009) picture(\"@E 99.99999\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\n\t\n\t//@ u_MGETTELA(028),u_MGETTELA(085) Say \"Desconto: {Vlr}\" Size u_MGETTELA(066),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\n\t//@ u_MGETTELA(028),u_MGETTELA(130) MsGet oEdit4 Var nEdit4            Size u_MGETTELA(35) ,u_MGETTELA(009) picture(\"@E 9999.99\") COLOR CLR_BLACK PIXEL OF _oDlgVlr\n\t\n\t@ u_MGETTELA(047),u_MGETTELA(131) Button \"Ok\" \t\tSize u_MGETTELA(037),u_MGETTELA(012)  ACTION( lNExec := .T. , Close(_oDlgVlr))  PIXEL OF _oDlgVlr\n\t//@ u_MGETTELA(047),u_MGETTELA(085) Button \"Deletar\" \tSize u_MGETTELA(037),u_MGETTELA(012)  ACTION( lNDele := .T. , Close(_oDlgVlr))  PIXEL OF _oDlgVlr\n\t//@ u_MGETTELA(050),u_MGETTELA(007) Say \"O valor irá subistituir todas as chapas do cavalete! \"  Size u_MGETTELA(113),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlgVlr\n\nACTIVATE MSDIALOG _oDlgVlr CENTERED\n\n\nIf lNDele\n\tFor nX := 1 To Len(aCols)\n\t\tIf AllTrim(GdFieldGet(\"C6_YCAVALE\",nX)) == AllTrim(cNumCav)\t\t\t\n\t\t\t aCols[nX][Len(aHeader)+1] := .T.\n\t\tEndIf\n\tNext nX\nEndIf\n\nIf lNExec\n\t\n\tIf !Empty(nEdit1) .Or. !Empty(nEdit2)\n\t\tFor nX := 1 To Len(aCols)\n\t\t\n\t\t\tIf !Empty(nEdit1)\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_PRUNIT\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX) //C6_PRUNIT 23/09/2019\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\n\t\t\t\tEndIf\n\t\t\tElse\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\n\t\t\t\t\t\t//GdFieldPut(\"C6_PRUNIT\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX) //C6_PRUNIT 23/09/2019\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tNext nX\n\tEndIf\n\t\n\t/*\n\tIf !Empty(nEdit1) .Or. !Empty(nEdit2) .Or. !Empty(nEdit4)\n\t\tFor nX := 1 To Len(aCols)\n\t\t\tIf Empty(nEdit4 )\n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_PRUNIT\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX) //C6_PRUNIT 23/09/2019\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\n\t\t\t\tEndIf\n\t\t\tElse \n\t\t\t\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\t//nEdit4 := round(nEdit4 / cNumChapa,2)\n\t\t\t\t\t\t\n\t\t\t\t\t\tnEdit2 := (nEdit4*100)/GdFieldGet(\"C6_VALOR\",nX)  \n\t\t\t\t\n\t\t\t\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit2,nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100,2),nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,IIF(nEdit2==0,nEdit1,GdFieldGet(\"C6_PRCVEN\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCVEN\",nX) ,nEdit1) * nEdit2) /100 )  ,nX)\n\t\t\t\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\n\t\t\t\tEndIf\n\t\t\tEndIf\n\t\tNext nX\n\tElse\n\t\tIf !Empty(nEdit3)\n\t\t\t\n\t\t\t//For nX := 1 To Len(aCols)\n\t\t\t//\tIf AllTrim(GdFieldGet(\"C6_YCAVALE\",nX)) == AllTrim(cNumCav)\t\t\t\n\t\t\t//\t\t\tGdFieldPut(\"C6_DESCONT\" ,nEdit3,nX)\n\t\t\t//\t\t\tGdFieldPut(\"C6_VALDESC\" ,Round(GdFieldGet(\"C6_QTDVEN\",nX) * (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCREF\",nX) ,nEdit1) * nEdit3) /100,2),nX)\n\t\t\t//\t\t\tGdFieldPut(\"C6_PRCVEN\"  ,GdFieldGet(\"C6_PRCREF\",nX) - (iif(Empty(nEdit1),GdFieldGet(\"C6_PRCREF\",nX) ,nEdit1) * nEdit2) /100   ,nX)\n\t\t\t//\t\t\tGdFieldPut(\"C6_VALOR\"   ,Round(GdFieldGet(\"C6_PRCVEN\",nX) * GdFieldGet(\"C6_QTDVEN\",nX),2),nX)\n\t\t\t//\tEndIf\n\t\t\t//Next nX\n\t\t\t\n\t\tEndIf\n\tEndIf\n\t*/\n\t \nEndIf\n\n\nReturn \n\n\nUser Function MCONSUTDET()\n****************************************************************************************************************\n*    \n*\n****\n// Variaveis Locais da Função\nLocal cEdit1\t := Space(100)\nLocal cEdit2\t := Space(100)\nLocal cEdit3\t := Space(100)\nLocal oEdit1\nLocal oEdit2\nLocal oEdit3\n\nLocal nX         := 0\n\n// Variaveis Private da Funcão\nPrivate _oDlg\t  // Dialog Principal\n\n// Variaveis que definem a Acao do Formulario\nPrivate VISUAL := .F.                        \nPrivate INCLUI := .F.                        \nPrivate ALTERA := .F.                        \nPrivate DELETA := .F.        \n\n// Privates das ListBoxes\nPrivate aListBox1 := {}\nPrivate oListBox1\nPrivate aFlist   := {}\n\n/*\nInicializando Variaveis \n*/\n\niF TYPE(\"aCols\") == \"A\"\n\n\tIF !(M-> C5_TIPO $ \"D,B\")   //Se for nota de devolucao\n\t\tcEdit1  := Posicione(\"SA1\",1,XFilial(\"SA1\")+M->C5_CLIENTE+M->C5_LOJACLI,\"A1_NOME\")                   // Retorna o nome do Cliente\n\tELSE\n\t\tcEdit1  := POSICIONE(\"SA2\",1,XFILIAL(\"SA2\")+M->C5_CLIENTE+M->C5_LOJACLI,\"A2_NOME\")\t\t\t\t\t // Retorna o nome do Fornecedor      \n\tENDIF\n\tcEdit2 := Posicione(\"SE4\",1,XFilial(\"SE4\")+M->C5_CONDPAG,\"E4_DESCRI\") \n\tcEdit3 := Posicione(\"SA3\",1,XFilial(\"SA3\")+M->C5_VEND1,\"A3_NOME\") \n\t\n\tDEFINE MSDIALOG _oDlg TITLE \"CONSULTA DETALHADA GRPLUS\" FROM u_MGETTELA(333),u_MGETTELA(275) TO u_MGETTELA(734),u_MGETTELA(795) PIXEL\n\t\n\t// Cria Componentes Padroes do Sistema\n\t@ u_MGETTELA(006),u_MGETTELA(005) Say \"NOME DO CLIENTE:\" Size u_MGETTELA(042),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\n\t@ u_MGETTELA(006),u_MGETTELA(052) MsGet oEdit1 Var cEdit1 when(.f.) Size u_MGETTELA(200),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\n\t@ u_MGETTELA(021),u_MGETTELA(006) Say \"COND. PAGAMENTO:\" Size u_MGETTELA(046),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\n\t@ u_MGETTELA(021),u_MGETTELA(052) MsGet oEdit2 Var cEdit2 when(.f.) Size u_MGETTELA(057),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\n\t@ u_MGETTELA(021),u_MGETTELA(114) Say \"NOME VENDEDOR:\" Size u_MGETTELA(055),u_MGETTELA(008) COLOR CLR_BLACK PIXEL OF _oDlg\n\t@ u_MGETTELA(021),u_MGETTELA(165) MsGet oEdit3 Var cEdit3 when(.f.) Size u_MGETTELA(087),u_MGETTELA(009) COLOR CLR_BLACK PIXEL OF _oDlg\n\t@ u_MGETTELA(180),u_MGETTELA(215) Button \"OK\"  Size u_MGETTELA(037),u_MGETTELA(012) ACTION(Close(_oDlg)) PIXEL OF _oDlg\n\t\n\t@ u_MGETTELA(035),u_MGETTELA(006) ListBox oListBox1 Fields ;\n\t\tHEADER \"ITEM\",\"CAVALETE\",\"P.LIQUIDO\",\"P.BRUTO\",\"QTD CHAPAS\",\"QTD RECORTE/AMOSTRAS\";\n\t\tSize u_MGETTELA(247),u_MGETTELA(140) Of _oDlg Pixel;\n\t\tColSizes 05,80,50,50,50,20\n\n\t\toListBox1:bLDblClick := {||  iif(fLibFunc(aFlist[oListBox1:nAT,01])==.t., MAltVlrAut(aFlist[oListBox1:nAT,01],aFlist[oListBox1:nAT,04]) , Alert(\"Produto oferta não pode ser alterado!\") )  }\n\n\t// Chamadas das ListBox do Sistema\n\tfListBox1()\n\t\n\tFor nX := 1 To Len(aFlist)\n\t\tIf AllTrim(aFlist[nX][1]) == AllTrim(GdFieldGet(\"C6_ITEM\",n))\n\t\t\t//oListBox1:Select(nX)\n\t\t\t//oListBox1:bLine := { || aFlist[ oListBox1:nX ] }\n\t\t\toListBox1:nAt := Nx\n\t\tEndIf\n\tNext Nx\n\t\n\tACTIVATE MSDIALOG _oDlg CENTERED \n\nElse\n\n\t//Alert(\"ok\")\n\tSetKey(VK_F5,)\n\tSetKey(VK_F6,)\nEndIf\n\nReturn(.T.)\n\nStatic Function fLibFunc(cNumItem)\n****************************************************************************************************************\n*    \n*\n****\nLocal nX   := 0\nLocal lRet := .T.\n\nFor nX := 1 To Len(aCols)\n\tIf AllTrim(GdFieldGet(\"C6_ITEM\",nX)) == AllTrim(cNumItem)\t\n\t\tIF GdFieldGet(\"C6_XOFERTA\",nX) == \"S\"\t\n\t\t\tlRet := .F.\n\t\tEndIf\n\tEndIf\nNext nX\n\nReturn(lRet)\n\nStatic Function fListBox1()\n****************************************************************************************************************\n*    \n*\n****\n//Local nPos   := 0\nLocal nTotBr   := 0\nLocal nTotLQ   := 0\nLocal nTotCh   := 0\n//Local nTotDF := 0\nLocal nTotAM   := 0\nLocal cGPExec  := GetMv(\"MV_XGPEXE\")\nLocal nx       := 0\n\noListBox1:SetArray(aFlist)\n\n/*\nPreenche o dados de peso bruto e peso liquido por cavaletes\n e quantidade de chapas\n*/\nFor nX := 1 To Len(aCols)\n\n\t//EXECUTAR SOMENTE PARA ESTES GRUPOS \n\t//\"0005/0006/0034/0035/0036\"\n\tdbSelectArea(\"SB1\")\n\tdbSetOrder(1)\n\tdbSeek(xFilial(\"SB1\")+ AllTrim(GdFieldGet(\"C6_PRODUTO\",nX)) )\n\t\n\tIF AllTrim(SB1->B1_GRUPO) $ cGPExec\n\t\tIf !GDDeleted(nX) \n\t\t\t/*\n\t\t\tIf !aScan(aFlist,{|x|alltrim(x[1]) == GdFieldGet(\"C6_YCAVALE\",nX)  })\t\t\n\t\t\t\tAadd(aFlist,{GdFieldGet(\"C6_YCAVALE\",nX) ,;\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOLQ\"))    ,;\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOBR\"))  ,;\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0, fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YQTDBD\") ),;\n\t\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_QTDVEN\",nX),0 )  })\n\t\t\tElse\n\t\t\t\tnPos := aScan(aFlist,{|x|alltrim(x[1])==GdFieldGet(\"C6_YCAVALE\",nX) })\n\t\t\t \taFlist[nPos][2] := aFlist[nPos][2] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOLQ\"))\n\t\t\t \taFlist[nPos][3] := aFlist[nPos][3] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX),fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOBR\"))\n\t\t\t \taFlist[nPos][4] := aFlist[nPos][4] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0, fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YQTDBD\") )\n\t\t\t \taFlist[nPos][5] := aFlist[nPos][5] + IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_QTDVEN\",nX), IIF(AllTrim(GdFieldGet(\"C6_YCLASSI\",nX))==\"A\" .AND. Empty(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))),1,0 )) //\n\t\t\tEndIf\n\t\t\t*/\n\t\t\t\n\t\t\tAadd(aFlist,{GdFieldGet(\"C6_ITEM\",nX) ,;\n\t\t\t\t\t\t GdFieldGet(\"C6_YCAVALE\",nX) ,; \n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),GdFieldGet(\"C6_PRODUTO\",nX),GdFieldGet(\"C6_LOCAL\",nX),\"B8_YPESOLQ\"))    ,;\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_XPESO\",nX) ,fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),GdFieldGet(\"C6_PRODUTO\",nX),GdFieldGet(\"C6_LOCAL\",nX),\"B8_YPESOBR\"))  ,;\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",0, fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),GdFieldGet(\"C6_PRODUTO\",nX),GdFieldGet(\"C6_LOCAL\",nX),\"B8_YQTDBD\") ),;\n\t\t\t\t\t\t IIF(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))==\"\",GdFieldGet(\"C6_QTDVEN\",nX),0 )  })\n\t\t\t\n\t\tEndIf\n\tElse \n\t\n\t//IIF(AllTrim(GdFieldGet(\"C6_YCLASSI\",nX))==\"A\" .AND. Empyt(AllTrim(GdFieldGet(\"C6_YCAVALE\",nX))),1,0)\n\t\n\tAadd(aFlist,{     \"-\",;\n\t\t\t\t\t  \"-\",;\n\t\t\t\t \t   0 ,;\n\t\t\t\t       0 ,;\n\t\t\t\t       0 ,;\n\t\t\t\t       0  })\n\t\n\tEndIf\nNext Nx\n\nIf Len(aFlist)>0\n\tFor nX := 1 To Len(aFlist)\n\t\tIf Alltrim(aFlist[nX][2]) = \"\"\n\t\t\taFlist[nX][2] := \"RECORTES\" \n\t\tEndIf\n\tNext Nx\n\t\n\tFor nX := 1 To Len(aFlist)\n\t\tnTotLQ := nTotLQ + aFlist[nX][3]\n\t\tnTotBr := nTotBr + aFlist[nX][4]\n\t\tnTotCh := nTotCh + aFlist[nX][5]\n\t\tnTotAM := nTotAM + aFlist[nX][6]\n\tNext Nx\n\t\n\tAadd(aFlist,{\"---------\",\"--------------------------------------------\",\"----------------------------------\",\"----------------------------------\",\"----------------------------------\",\"------------------------------------------\"})\n\tAadd(aFlist,{\"(=)\",\"  Total:\",nTotLQ,nTotBr,nTotCh,nTotAM})\n\tAadd(aFlist,{\"(=)\",\"  Weigth Limit: \"+ AllTrim(Str(M->C5_XWLIMIT)),M->C5_XWLIMIT - nTotLQ  ,M->C5_XWLIMIT - nTotBr,\"\",\"\"})\nEndIf\n\noListBox1:bLine := {|| {;\n\t\t\t\t\taFlist[oListBox1:nAT,01],;\n\t\t\t\t\taFlist[oListBox1:nAT,02],;\n\t\t\t\t\taFlist[oListBox1:nAT,03],;\n\t\t\t\t\taFlist[oListBox1:nAT,04],;\n\t\t\t\t\taFlist[oListBox1:nAT,05],;\n\t\t\t\t\taFlist[oListBox1:nAT,06]}}\n\t\nReturn        \n           \n\nStatic Function fPqLotSub(cLote,cSubLote,cCodProd,cCodLocal,cTipRet)\n****************************************************************************************************************\n*    //fPqCvlt(GdFieldGet(\"C6_YCAVALE\",nX)) -- quantiade de cavaletes amostras\n*    //\n****\nLocal nVlrRest := 0\n\ncQuery  := \" SELECT \"+ cTipRet +\" VLRET\"\ncQuery  += \"   FROM SB8010 \ncQuery  += \"  WHERE D_E_L_E_T_ = ''\ncQuery  += \"    AND B8_LOTECTL = '\"+ AllTrim(cLote)     +\"' \ncQuery  += \"    AND B8_NUMLOTE = '\"+ AllTrim(cSubLote)  +\"'\ncQuery  += \"    AND B8_PRODUTO = '\"+ AllTrim(cCodProd)  +\"'\ncQuery  += \"    AND B8_LOCAL   = '\"+ AllTrim(cCodLocal) +\"'\ncQuery  += \"    AND B8_SALDO <> 0\n\ntcQuery cQuery alias TRB new\ndbSelectArea(\"TRB\")\ndbgotop()\n\nnVlrRest := TRB->VLRET\n\ndbSelectArea(\"TRB\") \ndbCloseArea()\n\nReturn nVlrRest\n\n\nStatic Function fPqCvlt(cCavalete)\n****************************************************************************************************************\n*    //fPqLotSub(GdFieldGet(\"C6_LOTECTL\",nX),GdFieldGet(\"C6_NUMLOTE\",nX),\"B8_YPESOBR\")\n*    \n****\nLocal nVlrRest := 0\n\ncQuery  := \" SELECT COUNT(*) AS VLR_CONT\ncQuery  += \"    FROM SB8010 \ncQuery  += \"   WHERE D_E_L_E_T_ = ''\ncQuery  += \"     AND B8_YCAVALE = '\"+AllTrim(cCavalete)+\"'\ncQuery  += \"     AND B8_YCLASSI = 'A'\ncQuery  += \"     AND B8_SALDO <> 0\n\ntcQuery cQuery alias TRB new\ndbSelectArea(\"TRB\")\ndbgotop()\n\nnVlrRest := TRB->VLR_CONT\n\ndbSelectArea(\"TRB\") \ndbCloseArea()\n\nReturn nVlrRest\n\n\nUser Function MINFORFIN(dSetDate,cSetCodPG)\n****************************************************************************************************************\n*    //Informações Financeiras \n*    \n****\nPrivate _oInforFin\t\t\t\t// Dialog Principal\n                       \nPrivate oPG    := LoadBitmap(GetResources(), \"BR_VERMELHO\")\nPrivate oNPG   := LoadBitmap(GetResources(), \"BR_VERDE\")\nPrivate oNADA  := LoadBitmap(GetResources(), \"BR_CINZA\")\n\n// Privates das ListBoxes\nPrivate aListBoxFin := {}\nPrivate oListBoxFin\n\nDEFINE MSDIALOG _oInforFin TITLE \"Informações Financeiras\" FROM u_MGETTELA(178),u_MGETTELA(181) TO u_MGETTELA(403),u_MGETTELA(967) PIXEL\n\n\t// Cria Componentes Padroes do Sistema\n\t@ u_MGETTELA(093),u_MGETTELA(308) Button \"Cancelar\" Size u_MGETTELA(037),u_MGETTELA(012) ACTION(Close(_oInforFin)) PIXEL OF _oInforFin\n\t@ u_MGETTELA(093),u_MGETTELA(351) Button \"Salvar\" Size u_MGETTELA(037),u_MGETTELA(012)   ACTION(fSaveDtBl(),Close(_oInforFin)) PIXEL OF _oInforFin\n\n\t\t@ u_MGETTELA(003),u_MGETTELA(005) ListBox oListBoxFin Fields ;\n\t\tHEADER \"\",\"RECNO\",\"PREFIXO\",\"NUMERO\",\"TIPO\",\"PARCELA\",\"VALOR\",\"EMISSAO NF\",\"VENCIMENTO\",\"DATA BAIXA\",\"VENCIMENTO B/L\",\"VENCIMENTO B/L REAL\" ;\n\t\tSize u_MGETTELA(383),u_MGETTELA(088) Of _oInforFin Pixel;\n\t\tColSizes 08,20,40,40,40,40,40,40,40,40,50,40\n\t\t\n\t\t//oListBoxFin:bLDblClick := {||  MAltVlrAut(aFlist[oListBoxFin:nAT,01]) } alterar a função\n\t\t\n\n\t// Chamadas das ListBox do Sistema\n\tfListFin1(dSetDate,cSetCodPG)\n\nACTIVATE MSDIALOG _oInforFin CENTERED \n\nReturn(.T.)\n\n\nStatic Function fSaveDtBl()\n****************************************************************************************************************\n* //\n* //\n* \n****\nLocal lGravou  := .F.\nLocal cCodTitu := \"\"\nLocal nX       := 0\n\nFor nX:=1 to Len(aListBoxFin)\n\tIf !Empty(aListBoxFin[nX][12])\n\t\t\n\t\tdbSelectArea(\"SE1\")\n\t\tdbGoto(aListBoxFin[nX][2]) \n\t\tSE1->(reclock(\"SE1\", .F.))\n\t\t\tSE1->E1_VENCTO  := aListBoxFin[nX][11] \n\t\t\tSE1->E1_VENCREA := aListBoxFin[nX][12]\n\t\tSE1->(msUnLock())\n\t\t\n\t\tlGravou:=.T.\n\t\tcCodTitu := cCodTitu + aListBoxFin[nX][04]+\"-\"+aListBoxFin[nX][06]+ \" | \" + chr(13)+chr(10) \n\t\t\n\tEndIf\nNext nX\n\nIf lGravou\n\tAVISO(\"Títulos gravados com sucesso:\", cCodTitu , { \"Fechar\" }, 3)\nEndIF\n\nReturn()\n\nStatic Function fListFin1(dSetDate,cSetCodPG)\n****************************************************************************************************************\n* //\n* //\n* \n****\nLocal cQuery  := \"\"\n//Local aTPAVA  := {}\nLocal aRetAva := \"\"\n\ndbSelectArea(\"SF2\")\ndbSetOrder(2)\nIF dbSeek(xFilial(\"SF2\") + M->C5_CLIENTE + M->C5_LOJACLI + M->C5_NOTA + M->C5_SERIE + \"N\")\n\n\taTPadv := Condicao(M->C5_XVLRFIN,cSetCodPG,,SF2->F2_EMISSAO,) //FSepCond(M->C5_XVLRFIN,cSetCodPG,SF2->F2_EMISSAO)\n\n\tdbSelectArea(\"SE4\")\n\tdbSetOrder(1)\n\tIf dbSeek(xFilial(\"SE4\")+ cSetCodPG )\n\t\taRetAva := strtokarr (AllTrim(SE4->E4_TPAVA), \",\")\n\tEndIf\n\n\tIf Len(aRetAva) <> 0\n\t\tIf Len(aRetAva) <> Len(aTPadv)\n\t\t\tAlert(\"Verifique a condição de pagamento: (\" + AllTrim(cSetCodPG) + \"). O campo tp. avançado está diferente das quantidade de parcelas.\" )\n\t\tEndIf\n\tEndIf\n\n\tcQuery := \" \tSELECT\tR_E_C_N_O_ RECNO, \n\tcQuery += \" \t\t\tE1_FILIAL,\n\tcQuery += \" \t\t\tE1_PREFIXO,\n\tcQuery += \" \t\t\tE1_TIPO,\n\tcQuery += \" \t\t\tE1_NUM,\n\tcQuery += \" \t\t\tE1_PARCELA,\n\tcQuery += \" \t\t\tE1_EMISSAO,\n\tcQuery += \" \t\t\tE1_VENCREA,\n\tcQuery += \" \t\t\tE1_BAIXA,\n\tcQuery += \" \t\t\tE1_VALOR\n\tcQuery += \" \t  FROM SE1010 \n\tcQuery += \" \t WHERE E1_NUM     = '\"+M->C5_NOTA+\"'\n\tcQuery += \" \t   AND D_E_L_E_T_ = ''\n\t//cQuery += \" \t   AND E1_BAIXA   = ''\n\tcQuery += \" \t   AND E1_EMISSAO = '\"+dtoS(SF2->F2_EMISSAO)+\"'\n\tcQuery += \" \t   AND E1_TIPO IN ('NF')\n\tcQuery += \" \t   AND E1_CLIENTE = '\"+M->C5_CLIENTE+\"'\n\tcQuery += \" \t   AND E1_LOJA    = '\"+M->C5_LOJACLI+\"'\n\tcQuery += \" \t   AND E1_SERIE   = '\"+M->C5_SERIE+\"' \n\n\tTcQuery cQuery Alias TMP_FIM New\n\tdbSelectArea(\"TMP_FIM\")\n\t\n\tnPosAt := 0\n\tcTipoAvan := \"\"\n\t\n\tDo While !EOF()\n\t\n\t\tnPosAt := nPosAt + 1\n\t\tIf Len(aRetAva)<>0\n\t\t\tcTipoAvan := aRetAva[nPosAt] \n\t\t\t\n\t\t\tIf AllTrim(cTipoAvan) <> \"A\"\n\t\t\t\taTPadv := Condicao(M->C5_XVLRFIN,cSetCodPG,,dSetDate+1,)\n\t\t\tEndIf\n\t\tEndIf\n\t\t\n\t\tAadd(aListBoxFin,{\tiif(!Empty(aRetAva),IIF(EMPTY(TMP_FIM->E1_BAIXA),oNPG,oPG),oNADA),;\n\t\t\t\t\t\t\tTMP_FIM->RECNO,;\n\t\t\t\t\t\t\tTMP_FIM->E1_PREFIXO,;\n\t\t\t\t\t\t\tTMP_FIM->E1_NUM,;\n\t\t\t\t\t\t\tTMP_FIM->E1_TIPO,;\n\t\t\t\t\t\t\tTMP_FIM->E1_PARCELA,;\n\t\t\t\t\t\t\tTMP_FIM->E1_VALOR,;\n\t\t\t\t\t\t\tStoD(TMP_FIM->E1_EMISSAO),;\n\t\t\t\t\t\t\tStoD(TMP_FIM->E1_VENCREA),;\n\t\t\t\t\t\t\tStoD(TMP_FIM->E1_BAIXA),;\n\t\t\t\t\t\t\tiif(!Empty(aRetAva),IIf(Empty(TMP_FIM->E1_BAIXA), aTPadv[nPosAt][1]             ,sToD(\"\") ),sToD(\"\")),;\n\t\t\t\t\t\t\tiif(!Empty(aRetAva),IIf(Empty(TMP_FIM->E1_BAIXA), DataValida(aTPadv[nPosAt][1]) ,sToD(\"\") ),sToD(\"\"));\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\n\t\tdbSelectArea(\"TMP_FIM\")\n\t\tdbSkip()\n\tEndDo\n\t\n\tdbSelectArea(\"TMP_FIM\")\n\tdbCloseArea()\n\n\tif Empty(aListBoxFin)\n\t\n\t\tAadd(aListBoxFin,{\t\toNADA,;\n\t\t\t\t\t\t\t\t\"\",;\n\t\t\t\t\t\t\t\t\"\",;\n\t\t\t\t\t\t\t\t\"\",;\n\t\t\t\t\t\t\t\t\"\",;\n\t\t\t\t\t\t\t\t\"\",;\n\t\t\t\t\t\t\t\t\"\",;\n\t\t\t\t\t\t\t\tStoD(\"\"),;\n\t\t\t\t\t\t\t\tStoD(\"\"),;\n\t\t\t\t\t\t\t\tStoD(\"\"),;\n\t\t\t\t\t\t\t\tStoD(\"\"),;\n\t\t\t\t\t\t\t\tsToD(\"\");\n\t\t\t\t\t\t\t\t})\n\t\n\tEndIf \n\n\toListBoxFin:SetArray(aListBoxFin)\n\t\n\toListBoxFin:bLine := {|| {;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,01],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,02],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,03],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,04],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,05],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,06],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,07],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,08],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,09],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,10],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,11],;\n\t\t\t\t\taListBoxFin[oListBoxFin:nAT,12]}}\n\t\n\nEndIf\n\nReturn()\n"}}}
Content-Length: 186
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO_NOVO_COMERCIAL/MT410TOK.prw"}}}
Content-Length: 352
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"git:/d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/06_FATURAMENTO_NOVO_COMERCIAL/MT410TOK.prw?%7B%22path%22%3A%22d%3A%5C%5CTOTVS%2012%5C%5CMicrosiga%5C%5CProtheus%5C%5CProjetoVSCode%5C%5C06_FATURAMENTO_NOVO_COMERCIAL%5C%5CMT410TOK.prw%22%2C%22ref%22%3A%22~%22%7D"}}}
Content-Length: 53662
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/10_LIB/LIBWHATSAPP.PRW","languageId":"advpl","version":1,"text":"#include \"protheus.ch\"\r\n#include \"rwmake.ch\"\r\n#include \"tbiconn.ch\"  \r\n#INCLUDE \"TOTVS.CH\"\r\n#INCLUDE \"topconn.ch\"\r\n\r\n/*\r\nPrograma ...: LIBWHATSAPP.Prw\r\nUso ........: Programa verifica a provação do pedido automaticamente pelo WhatsApp\r\nData .......: 23/03/2020\r\nFeito por ..: Bruno Lage Ferreira\r\nCopyright @1998-2001,2021\r\n\r\nQ-Liberação Faturamento\r\n5527995295180-1587589430@g.us\r\nlogistica.es@qualitagroup.com;comercial.es@grupoqualita.com.br\r\n\r\nQ-N2 - Liberação Compras\r\n5527995295180-1594316108@g.us\r\npedido.compra@grupoqualita.com.br\r\n\r\nQ-N1 - Liberação Compras\r\n5527995295180-1587589523@g.us\r\npedido.compra@grupoqualita.com.br\r\n*/ \r\n\r\nUser Function LIBWHATSAPP()  \r\n************************************************************************************************************\r\n*\r\n*\r\n*\r\n***\r\nLocal cQuery   := \"\"\r\nLocal lAutoZAP := .F.\r\n\r\nLocal aLogAuto := {}\r\n\r\nLocal oJson\r\nLocal cErr     := \"\"\r\n/*\r\nLocal lMsg     := \"\"\r\n*/\r\nLocal cMessage := \"\"\r\nLocal lEnvProt := .F.\r\nLocal nAux\r\n\r\nConOut( \">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>   WHATSAPP APROVAÇÃO   <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\" )\r\n\r\nIf Select(\"SX2\")==0  \r\n\tPREPARE ENVIRONMENT EMPRESA \"01\" FILIAL \"01\" TABLES \"WAM\",\"SC5\"\r\n\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" Iniciando JOB de liberação de Retorno pelo WHATSAPP.\")\r\n\tlAutoZAP := .T.\r\nEndIf\r\n\r\n\r\n/*\r\n******************************************************************************************\r\nchamada do Modulo AutoStart\r\nTODOS OS COMANDOS VIA PROCEDUTE\r\n*/\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************         INICIANDO AUTOSTART          **********************\")\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************************************************************************\")\r\n\r\nTCSPEXEC(\"WHATSAPP_AUTOSTART\")\r\n   \r\n/*\r\n*\r\n******************************************************************************************\r\n*/\r\ncQuery :=  \" SELECT  \r\ncQuery +=  \" \t\tWAM_FILIAL,\r\ncQuery +=  \" \t\tWAM_DATA,\r\ncQuery +=  \" \t\tWAM_HORA,\r\ncQuery +=  \" \t\tWAM_ID,\r\ncQuery +=  \" \t\tRTRIM(LTRIM(ISNULL(CONVERT(VARCHAR(2047), CONVERT(VARBINARY(2047), WAM_MSG)),''))) WAM_MSG,\r\ncQuery +=  \" \t\tWAM_TELL,\r\ncQuery +=  \" \t\tWAM_INDEX,\r\ncQuery +=  \" \t\tWAM_PERG,\r\ncQuery +=  \" \t\tWAM_DATAR,\r\ncQuery +=  \" \t\tWAM_HORAR,\r\ncQuery +=  \" \t\tWAM_RESPOS,\r\ncQuery +=  \" \t\tWAM_EXEC,\r\ncQuery +=  \" \t\tWAM_NIVEL\r\ncQuery +=  \" \t\tFROM WAM010 WHERE D_E_L_E_T_ = '' AND CAST(WAM_DATA AS DATE) > CAST(GETDATE()-4 AS DATE) AND WAM_PERG = 'S' AND WAM_EXEC LIKE '%QUALITA%'\r\n\r\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBRA\", .F., .T.)\r\ndbSelectArea(\"TRBRA\")\r\ndbgotop()\r\nDo While !EOF()\r\n\r\n\tIf !Empty(TRBRA->WAM_ID)\t\r\n\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\"Protocolo: [\"+ AllTrim(TRBRA->WAM_ID) + \"] INDEX:\" + TRBRA->WAM_INDEX )\r\n\t\t\r\n\t\t// Cria o objeto JSON e popula ele a partir da string\r\n\t\t\r\n\t\toJson := JSonObject():New()\r\n\t\tcErr  := oJSon:fromJson(U_SWREMGWAP(AllTrim(TRBRA->WAM_ID)))\r\n\t\t\r\n\t\tsleep(400)\r\n\t\t\r\n\t\tConOut(oJson:GetJSonObject('quote_message'))\r\n\t\t\r\n\t\tIf !Empty(cErr)\r\n\t\t  \tConout(cErr + \"Protocolo:\" + AllTrim(TRBRA->WAM_ID))\r\n\t\t  \t\r\n\t\t  \t// Descarta o objeto \r\n\t\t  \tFreeObj(oJson)\r\n\t\t  \r\n\t\t  \tdbSelectArea(\"TRBRA\")\r\n\t\t  \tdbSkip()\r\n\t\tEndif\r\n\t\t\r\n\t\t// Agora vamos ler as propriedades com GetJSonObject()\r\n\t\t aRetMsg :=\tstrTokArr(U_SWREMGWAP(TRBRA->WAM_ID), ',' )\r\n\tEndIf\r\n\t\r\n\t\r\n\t/*\r\n\t**********************************************************************************************************************\r\n\tTratamento das liberação \r\n\t - Mapa de Cotação\r\n\t - Pedido de Compra\r\n\t - Pedido de Vendas\r\n\t**********************************************************************************************************************\r\n\t*/\r\n\tIF AllTrim(TRBRA->WAM_EXEC) == \"QUALITA-MC\"\r\n\t\t\r\n\t\t/*\r\n\t\t***************************************************\r\n\t\tNIVEL 1\r\n\t\t***************************************************\r\n\t\t*/\r\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"1\"\r\n\t\t\t\r\n\t\t\t/*\r\n\t\t\tProcessamento dos retorno Mapa de cotação-MC\r\n\t\t\t*/\r\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\t\r\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\t\r\n\t\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\t\tlEnvProt := .T.\r\n\t\t\t\t\r\n\t\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\t\tdbSelectArea(\"SC8\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0025_V&cCotacao=' + SC8->C8_NUM +'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConOut(\"Gerando relatório! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcProt := U_SWENARWAP(\"5527995295180-1594316108@g.us\", \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"                                                                     ,\"MC\"+ SC8->C8_NUM             ,\"MC-\" + SC7->C7_NUM  ,\"PDF\",\"\\RELINWEB\\MC-\"+ SC8->C8_NUM +\".PDF\")\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t30 segundos\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIF cProt = \"\" .or. cProt = nil \r\n\t\t\t\t\t\t\tConOut(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde! MC-\"+ SC8->C8_NUM +\".PDF\")\r\n\t\t\t\t\t\t\tReturn()\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tIf  RecLock(\"WAM\",.T.) \r\n\t\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \r\n\t\t\t\t\t\t\tReplace WAM_DATA    With Date()\r\n\t\t\t\t\t\t\tReplace WAM_HORA    With Time()\r\n\t\t\t\t\t\t\tReplace WAM_ID      With cProt\r\n\t\t\t\t\t\t\tReplace WAM_MSG     With \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"\r\n\t\t\t\t\t\t\tReplace WAM_INDEX   With SC8->C8_FILIAL + SC8->C8_NUM\r\n\t\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\r\n\t\t\t\t\t\t\tReplace WAM_NIVEL   With \"2\"\r\n\t\t\t\t\t\t\tIF SubString(CNUMEMP,1,2) == \"05\"\r\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'ITINGA-MC'\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'QUALITA-MC'\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t   MsUnLock()\r\n\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como já lido. \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como já lido\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tColoca a MSg mais não mostra data nem hora de liberação\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C8_MSGLIB='\"+ \"NÃO LIBERADO: \" + Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"   FROM \" + RetSqlName(\"SC8\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'COTAÇÃO NÃO LIBERADA!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado (Mapa de Cotação NÃO liberado):\" + TRBRA->WAM_INDEX )\t\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\r\n\t\tEndIf\r\n\t\t\r\n\t\t/*\r\n\t\t***************************************************\r\n\t\tNIVEL 2\r\n\t\t***************************************************\r\n\t\t*/\r\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"2\"\r\n\t\t\t\r\n\t\t\t/*\r\n\t\t\tProcessamento dos retorno Mapa de cotação-MC\r\n\t\t\t*/\r\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\t\r\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\t\r\n\t\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\t\tlEnvProt := .T.\r\n\t\t\t\t\r\n\t\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\t\tdbSelectArea(\"SC8\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGravando aprovação na SC8\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C8_DATALIB='\"+ DToS(dDataBase) +\"',C8_HORALIB='\"+ LEFT(AllTrim(TIME()),5) +\"',C8_MSGLIB='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC8\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0025_V&cCotacao=' + SC8->C8_NUM +'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConOut(\"Gerando relatório! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação Liberado!     Código:' + SC8->C8_NUM       ,'COTAÇÃO LIBERADA! Código:'              + SC8->C8_NUM + ', liberado!'+ \"<br>\" +'CÓDIGO:' + SC8->C8_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda:\" + AllTrim(SC8->C8_NUM) )\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tColoca a MSg mais não mostra data nem hora de liberação\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C8_MSGLIB='\"+ \"NÃO LIBERADO: \" + Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"   FROM \" + RetSqlName(\"SC8\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'COTAÇÃO NÃO LIBERADA!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado (Mapa de Cotação NÃO liberado):\" + TRBRA->WAM_INDEX )\t\r\n\t\t\t\t\t\r\n\t\t\t\tEndIf\r\n\t\t\t\t\r\n\t\t\tEndIf\r\n\t\t\r\n\t\tEndIf\r\n\r\n\tElseIf AllTrim(TRBRA->WAM_EXEC) == \"QUALITA-PC\"\r\n\t\r\n\t\t/*\r\n\t\t***************************************************\r\n\t\tNIVEL 1\r\n\t\t***************************************************\r\n\t\t*/\r\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"1\"\r\n\t\r\n\t\t\t/*\r\n\t\t\tProcessamento dos retorno Pedido de Compra-PC\r\n\t\t\t*/\r\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\t\r\n\t\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\t\tlEnvProt := .T.\r\n\t\t\t\t\r\n\t\t\t\tIf \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\t\tdbSelectArea(\"SC7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGera dados do pedido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tu_ImpPc(2)\r\n\t\t\t\t\t\tWaitRunSrv('\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tcProt := U_SWENARWAP(\"5527995295180-1594316108@g.us\", \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"                                                                     ,\"PC-2-\" + SC7->C7_NUM         ,\"PC-2-\" + SC7->C7_NUM   ,\"PDF\",\"\\RELINWEB\\PC-\" + SC7->C7_NUM + \".PDF\")\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\t30 segundos\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\t        \t\t\t\t\t\t                  \r\n\t\t\t\t\t\tIF cProt = \"\" .or. cProt = nil \r\n\t\t\t\t\t\t\tConOut(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde! PC-\"+SC7->C7_NUM+\".PDF\")\r\n\t\t\t\t\t\t\tReturn()\r\n\t\t\t\t\t\tEndIf                 \r\n\t\t\t\t\t\t                      \r\n\t\t\t\t\t\tIf  RecLock(\"WAM\",.T.) \r\n\t\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \r\n\t\t\t\t\t\t\tReplace WAM_DATA    With Date()\r\n\t\t\t\t\t\t\tReplace WAM_HORA    With Time()\r\n\t\t\t\t\t\t\tReplace WAM_ID      With cProt\r\n\t\t\t\t\t\t\tReplace WAM_MSG     With \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\" \r\n\t\t\t\t\t\t\tReplace WAM_INDEX   With SC7->C7_FILIAL + SC7->C7_NUM\r\n\t\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\r\n\t\t\t\t\t\t\tReplace WAM_NIVEL   With \"2\"\r\n\t\t\t\t\t\t\tIF SubString(CNUMEMP,1,2) == \"05\"\r\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'ITINGA-PC'\r\n\t\t\t\t\t\t\tElse\r\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'QUALITA-PC'\r\n\t\t\t\t\t\t\tEndIf\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t   MsUnLock()\r\n\t\t\t\t\t\tEndIf\r\n\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\tdbSelectArea(\"SC7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGravando aprovação na SC7\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\r\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGera dados do pedido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t//u_ImpPc(2)\r\n\t\t\t\t\t\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"almoxarifado@grupoqualita.com.br;emelly.couto@grupoqualita.com.br;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + SC7->C7_NUM + ', não liberado!'+ \"<br>\" +'CÓDIGO:' + SC7->C7_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RXX0022.PDF')\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Não Liberado! Código:' + SC7->C7_NUM , 'Pedido Não Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t\tEndIf\t\r\n\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tEndIf\r\n\t\r\n\t\r\n\t\t/*\r\n\t\t***************************************************\r\n\t\tNIVEL 2\r\n\t\t***************************************************\r\n\t\t*/\r\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"2\"\r\n\t\r\n\t\t\t/*\r\n\t\t\tProcessamento dos retorno Pedido de Compra-PC\r\n\t\t\t*/\r\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\t\r\n\t\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\t\tlEnvProt := .T.\r\n\t\t\t\t\r\n\t\t\t\tIf \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\t\tdbSelectArea(\"SC7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGravando aprovação na SC7\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C7_DATALIB='\"+ DToS(dDataBase) +\"',C7_HORALIB='\"+ LEFT(AllTrim(TIME()),5) +\"',C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGera dados do pedido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tu_ImpPc(2)\r\n\t\t\t\t\t\tWaitRunSrv('\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Liberado! Código:' + SC7->C7_NUM , 'Pedido Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF')\r\n\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\tElse\r\n\t\t\t\t\tdbSelectArea(\"SC7\")\r\n\t\t\t\t\tdbSetOrder(1)\r\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tMarcando o protocolo como ja lido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\t\r\n\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGravando aprovação na SC7\r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \r\n\t\t\t\t\t\tcQuery += \"    SET C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\r\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\r\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\t\r\n\t\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\t\r\n\t\t\t\t\t\t/*\r\n\t\t\t\t\t\tGera dados do pedido \r\n\t\t\t\t\t\t*/\r\n\t\t\t\t\t\t//u_ImpPc(2)\r\n\t\t\t\t\t\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//ConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\tsleep(300)\r\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"almoxarifado@grupoqualita.com.br;emelly.couto@grupoqualita.com.br;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + SC7->C7_NUM + ', não liberado!'+ \"<br>\" +'CÓDIGO:' + SC7->C7_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RXX0022.PDF')\r\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Não Liberado! Código:' + SC7->C7_NUM , 'Pedido Não Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'')\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tEndIf\r\n\t\t\t\r\n\t\t\t\tEndIf\t\r\n\t\t\t\r\n\t\t\tEndIf\r\n\t\t\t\r\n\t\tEndIf\r\n\t\r\n\t\r\n\tElse\r\n\t\t/*\r\n\t\tProcessamento dos retornos Pedido de Venda PV \r\n\t\t*/\r\n\t\tIf oJson:GetJSonObject('quoted') == \"true\"\r\n\t\t\r\n\t\t\tcMessage := oJson:GetJSonObject('quote_message')\r\n\t\t\t\r\n\t\t\t//ENVIO DO PROTOCOLO \r\n\t\t\tlEnvProt := .T.\r\n\t\t\t\r\n\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \r\n\t\t\t\tdbSelectArea(\"SC5\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\r\n\t\t\t\t\t\r\n\t\t\t\t\tRecLock(\"SC5\",.F.)\r\n\t\t\t\t\t\tSC5->C5_BLQ  := ''\r\n\t\t\t\t\tMsUnlock()\t\r\n\t\t\t\t\t\r\n\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\r\n\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\r\n\t\t\t\t\tIf SC5->C5_YTIPO == \"ME\"\r\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\tElse\r\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t\t\t\t\tEndIf\r\n\t\t\t\t\t\r\n\t\t\t\t\tConOut(\"Gerando relatório! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\r\n\t\t\t\t\tsleep(300)\r\n\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\r\n\t\t\t\t\t\r\n\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"logistica.es@qualitagroup.com;bruno.lage@grupoqualita.com.br\",'Pedido Liberado! Código:' + SC5->C5_NUM ,'PEDIDO LIBERADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\r\n\t\t\t\t\t\r\n\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda:\" + TRBRA->WAM_INDEX )\t\r\n\t\t\t\tEndIf\r\n\t\t\tElse\r\n\t\t\t\t\tcQuery := \" UPDATE WAM010 \r\n\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\r\n\t\t\t\t\tcQuery += \"  FROM WAM010 \r\n\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\r\n\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\r\n\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\r\n\t\t\t\r\n\t\t\t\t\tTcSQLExec(cQuery)\r\n\t\t\t\t\t\r\n\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"logistica.es@qualitagroup.com;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'PEDIDO NÃO LIBERADO!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\r\n\t\t\t\t\t\r\n\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda (NÃO liberado):\" + TRBRA->WAM_INDEX )\t\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf\r\n\t\r\n\t// Descarta o objeto \r\n\tFreeObj(oJson)\r\n\r\n\tdbSelectArea(\"TRBRA\")\r\n\tdbSkip()\r\nEndDo\r\n\r\ndbSelectArea(\"TRBRA\") \r\ndbCloseArea()\r\n\r\n\r\n/*\r\n******************************************************************************************\r\nchamada do Modulo AutoStart\r\nTODOS OS COMANDOS VIA PROCEDUTE\r\n*/\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************         INICIANDO AUTOSTART          **********************\")\r\nConOut(\"*********************************************************************************\")\r\nConOut(\"*********************************************************************************\")\r\n\r\nTCSPEXEC(\"WHATSAPP_AUTOSTART\")\r\n   \r\n\r\n/*\r\n******************************************************************************************\r\nResposta do Modulo MNT\r\nABERTURA E DISTRIBUIÇÃO\r\n*/\r\ncQuery   := \" SELECT  ISNULL((SELECT USR_ID     FROM DADOSADV_Q..SYS_USR WHERE USR_MSBLQL <> 1 AND USR_CARGO = WAM_TELL),'') ID_USUARIO,\r\ncQuery   += \" \t  \t  ISNULL((SELECT USR_CODIGO FROM DADOSADV_Q..SYS_USR WHERE USR_MSBLQL <> 1 AND USR_CARGO = WAM_TELL),'') USUARIO,\r\ncQuery   += \" \t  \t  R_E_C_N_O_ RECNO,\r\ncQuery   += \" \t\t  UPPER(RTRIM(LTRIM(SUBSTRING(RETORNO,IIF(CHARINDEX(',',UPPER(RETORNO))=0,0,CHARINDEX(',',UPPER(RETORNO))+1),LEN(RETORNO)  ))) ) \t  MSG,*\r\ncQuery   += \"   FROM DADOSADV_Q..WAM010\r\ncQuery   += \"\tCROSS APPLY\r\ncQuery   += \"\t(\r\ncQuery   += \"\tSELECT RETORNO = dbo.FnWhatRetMSG(WAM_ID)\r\ncQuery   += \"\t) x\r\ncQuery   += \"  WHERE D_E_L_E_T_ = ''\r\ncQuery   += \"    AND WAM_EXEC = 'MNT'\r\ncQuery   += \"    AND WAM_PERG = 'N'\r\ncQuery   += \"    AND WAM_NIVEL = 0\r\n//cQuery   += \"  --AND dbo.FnWhatRetMSG(WAM_ID) <> ''\r\n\r\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBMNT\", .F., .T.)\r\ndbSelectArea(\"TRBMNT\")\r\ndbgotop()\r\nDo While !EOF()\r\n\r\n\t\t\t\r\n\t\t\tPrivate\taSolic          :={}\t\r\n\t\t\tPrivate lMSHelpAuto     := .T. // Nao apresenta erro em tela\r\n\t\t\tPrivate lMSErroAuto     := .F. //   Caso a variavel torne-se .T. apos MsExecAuto, apresenta erro em tela\r\n\t\t\tPrivate lAutoErrNoFile\t:= .T.\r\n\t\t\tPrivate cErroTemp       := \"\"\r\n\t\t\tPrivate cArquivo        := \"\"\r\n\t\t\tPrivate cProt           := \"\"\r\n\t\r\n\t\t\taSolic := {\t{\"TQB_CODBEM\" , TRBMNT->WAM_RESPOS    \t,Nil},;             \t// Codigo do Bem a  ser  relacionado na Solicitacao de Servico\r\n\t\t\t\t\t\t{\"TQB_DTABER\" , dDataBase     \t\t\t,Nil},; \t\t\r\n\t\t\t\t\t\t{\"TQB_HOABER\" , LEFT(TIME(), 5 )        ,Nil},; \t\r\n\t\t\t\t\t\t{\"TQB_USUARI\" , TRBMNT->USUARIO   \t\t,Nil},; \t\t\r\n\t\t\t\t\t\t{\"TQB_CDSOLI\" , TRBMNT->ID_USUARIO\t\t,Nil},; \t\t\r\n\t\t\t\t\t\t{\"TQB_DESCSS\" , TRBMNT->MSG \t\t\t,Nil}} \t\t\t\t\t//  Descricao da  Solicitacao\r\n\r\n\t\t\tMSExecAuto( {|x,z,y,w| MNTA280(x,z,y,w)}, , , aSolic )\t\t\r\n\r\n\t\t\tIf lMsErroAuto\r\n\t\t\t\t//U_SWENV(\"5533984022125\" , Mostraerro()  , \"ERRO MNT\" )\r\n\t\t\t\tConOut(\"************* ERRO MNT INICIO *************\")\r\n\t\t\t\t//U_SWENV(TRBMNT->WAM_TELL, \"Erro no cadastro da S. Serviço!\"  , \"ERRO MNT\" )\r\n\r\n\t\t\t\t//Pegando log do ExecAuto\r\n\t\t\t\taLogAuto := GetAutoGRLog()\r\n\r\n\t\t\t\t/*\r\n\t\t\t\t//Percorrendo o Log e incrementando o texto (para usar o CRLF você deve usar a include \"Protheus.ch\")\r\n\t\t\t\t//nAux \t\t:= 0\r\n\t\t\t\t//aLogAuto    :={}\r\n\t\t\t\t*/\t\r\n\t\t\t\tFor nAux := 1 To Len(aLogAuto) \r\n\t\t\t\t\tcErroTemp += aLogAuto[nAux] + CHR(13)+CHR(10)\r\n\t\t\t\tNext nAux\r\n\r\n\t\t\t\tIf cErroTemp == \"\"\r\n\t\t\t\t\tcErroTemp := \"Sem informações de erro.\"\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tcArquivo := \"\\_LOGWHATSMNT\\\" + \"MNT_ERRO\" + dToS(dDataBase) +'_'+ Replace(time(),':','_') + \".txt\"\r\n\t\t\t\t\r\n\t\t\t\tConOut(cArquivo)\r\n\t\t\t\tConOut(cErroTemp)\r\n\r\n\t\t\t\tSleep(3000)\r\n\r\n\t\t\t\t//Criando o arquivo txt\r\n\t\t\t\tMemoWrite(cArquivo, cErroTemp )\r\n\r\n\t\t\t\t//cErroTemp := Mostraerro(\"\\_LOGWHATSMNT\\\", cArquivo)\r\n\t\t\t\t\r\n\t\t\t\tConOut(cErroTemp)\r\n\t\t\t\tSleep(3000)\r\n\r\n\t\t\t\tU_SWENARWAP(AllTrim(TRBMNT->WAM_TELL),\"Erro no cadastro da S. Serviço!\",\"Erro no cadastro da S. Serviço!\",\"MNT_ERRO\",\"TXT\",cArquivo)\r\n\r\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\r\n\t\t\t\tcQuery   += \"    SET WAM_NIVEL = 3\r\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010  \r\n\t\t\t\tcQuery   += \"  WHERE D_E_L_E_T_ = ''\r\n\t\t\t\tcQuery   += \"    AND WAM_EXEC = 'MNT'\r\n\t\t\t\tcQuery   += \"    AND WAM_PERG = 'N'\r\n\t\t\t\tcQuery   += \"    AND WAM_NIVEL = 0\r\n\r\n\t\t\t\tTcSQLExec(cQuery)   \r\n\r\n\t\t\t\tConOut(\"************* ERRO MNT FIM*************\")\r\n\t\t\tElse\r\n\t\t\t\r\n\t\t\t\tdbSelectArea(\"TQB\")\r\n\t\t\t\tcCodigoSS := TQB->TQB_SOLICI\r\n\t\t\t\tConOut(\"************* CONFIRMAÇÃO DA SS MNT INICIO *************\")\r\n\t\t\t\tConOut(\"****Codigo..:\"+cCodigoSS)\r\n\t\t\t\tConOut(\"********************************************************\")\r\n\r\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"Solicitação cadastrada com sucesso! Código:\" +cCodigoSS, \"SOLICITAÇÃO DE SERVIÇO\" )\r\n\r\n\t\t\t\tSleep(3000)\r\n\r\n\t\t\t\t/*\r\n\t\t\t\tDistriburir \r\n\t\t\t\tResponsável pela Manutenção\r\n\t\t\t\t*/\r\n\t\t\t\tdbSelectArea(\"ST9\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tdbSeek(xFilial(\"ST9\") + TRBMNT->WAM_RESPOS)\r\n\r\n\t\t\t\tcErroTemp := \"NOVA SOLICITAÇÃO DE SERVIÇO PARA DISTRIBUIÇÃO\" + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"CÓDIGO........:\" + cCodigoSS                   + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"DATA..........:\" + dToC(dDataBase)             + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"HORA..........:\" + Replace(time(),':',':')     + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"EQUIPAMENTO ID:\" + TRBMNT->WAM_RESPOS          + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"EQUIPAMENTO...:\" + AllTrim(ST9->T9_NOME)       + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"PROBLEMA......:\" + AllTrim(TRBMNT->MSG)        + CHR(13)+CHR(10)\r\n\t\t\t\tcErroTemp += \"COMO APROVAR..:\" + \"CIV/MEC/ELE/ , 1/2/3, COMPLEMENTO DA DESCRIÇÃO DO PROBLEMA\" \r\n\r\n\t\t\t\tcArquivo := \"\\_LOGWHATSMNT\\\" + \"MNT_DIST\" + cCodigoSS + dToS(dDataBase) +'_'+ Replace(time(),':','_') + \".txt\"\r\n\t\t\t\tMemoWrite(cArquivo, cErroTemp )\r\n\r\n\t\t\t\t/*\r\n\t\t\t\tTelefone fixo com a pessoa que vai distibuir \r\n\t\t\t\t*/ \r\n\t\t\t\tcNumDist := \"27997857938\"\r\n\t\t\t\t                \r\n\r\n\t\t\t\tcProt := U_SWENARWAP(AllTrim(cNumDist),\"Distribuir:\" + cCodigoSS,\"SS_\"+cCodigoSS,\"SS_\"+cCodigoSS,\"TXT\",cArquivo)\r\n\r\n\t\t\t\tIf  RecLock(\"WAM\",.T.) \r\n\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \r\n\t\t\t\t\t\tReplace WAM_DATA    With Date()\r\n\t\t\t\t\t\tReplace WAM_HORA    With Time()\r\n\t\t\t\t\t\tReplace WAM_ID      With cProt\r\n\t\t\t\t\t\tReplace WAM_MSG     With cErroTemp\r\n\t\t\t\t\t\tReplace WAM_INDEX   With cCodigoSS\r\n\t\t\t\t\t\tReplace WAM_TELL    With cNumDist\r\n\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\r\n\t\t\t\t\t\tReplace WAM_NIVEL   With \"0\"\r\n\t\t\t\t\t\tReplace WAM_EXEC    With 'MNT-DIST'\r\n\t\t\t\t\tMsUnLock()\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\r\n\t\t\t\tcQuery   += \"    SET WAM_NIVEL = 1 , WAM_HORAR  = Left(Cast(GETDATE() as Time ),5), WAM_DATAR  = Replace(Cast(GETDATE() as date ),'-',''),WAM_INDEX = '\"+AllTrim(cCodigoSS)+\"'\r\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010  \r\n\t\t\t\tcQuery   += \"  WHERE D_E_L_E_T_ = ''\r\n\t\t\t\tcQuery   += \"    AND WAM_EXEC = 'MNT'\r\n\t\t\t\tcQuery   += \"    AND WAM_PERG = 'N'\r\n\t\t\t\tcQuery   += \"    AND WAM_NIVEL = 0\r\n\r\n\t\t\t\tTcSQLExec(cQuery)   \r\n\r\n\r\n\t\t\t\tConOut(\"************* CONFIRMAÇÃO DA SS MNT FIM *************\")\r\n\t\t\t\tConOut(\"****Codigo..:\"+cCodigoSS)\r\n\t\t\t\tConOut(\"********************************************************\")\r\n\t\t\tEndif\t\r\n\r\n\tdbSelectArea(\"TRBMNT\")\r\n\tdbSkip()\r\nEndDo\r\n\r\n\r\n\r\ndbSelectArea(\"TRBMNT\") \r\ndbCloseArea()\r\n\r\n/**\r\n*********************************************************************************\r\nRetorno da DISTRIBUIÇÃO\r\nMNT\r\n*/\r\nPrivate aRespDist := {}\r\n\r\ncQuery   := \" SELECT UPPER(RETORNO) DIST,\r\ncQuery   += \"        CAST(GETDATE() AS DATE)         DATA,\r\ncQuery   += \" \t     FORMAT(GETDATE(),'hh:mm')       HORA,\r\ncQuery   += \" \t     R_E_C_N_O_         \t\t\t RECNO,\r\ncQuery   += \" \t\t *\r\ncQuery   += \"   FROM DADOSADV_Q..WAM010\r\ncQuery   += \"\tCROSS APPLY\r\ncQuery   += \"\t(\r\ncQuery   += \"\tSELECT RETORNO = dbo.FnWhatRetMSG(WAM_ID)\r\ncQuery   += \"\t) x\r\ncQuery   += \"  WHERE D_E_L_E_T_ = ''\r\ncQuery   += \"    AND WAM_EXEC = 'MNT-DIST'\r\ncQuery   += \"    AND WAM_PERG = 'S'\r\ncQuery   += \"    AND UPPER(RETORNO) <> ''\r\ncQuery   += \"    AND CAST(GETDATE()-3 AS DATE) <= CAST(WAM_DATA AS DATE)\r\n\r\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBMNT\", .F., .T.)\r\ndbSelectArea(\"TRBMNT\")\r\ndbgotop()\r\nDo While !EOF()\r\n\t\r\n\taRespDist := strtokarr (AllTrim(TRBMNT->DIST), \",\")\r\n\t\r\n\tIf Len(aRespDist) < 2\r\n\t\tU_SWENV(TRBMNT->WAM_TELL, \"Ditribuição errada tente novamente! Quantidade de parâmetros não atende.\", \"DIST-ERRO1\" )\r\n\t\tSleep(10000)\r\n\tElse\r\n\t\tIf !aRespDist[1] $ \"CIV/MEC/ELE\"\r\n\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"O primeiro parâmetro deve ser [CIV/MEC/ELE]. \", \"DIST-ERRO2\" )\r\n\t\t\tSleep(10000)\r\n\t\tElse\r\n\t\t\tIf !aRespDist[2] $ \"1/2/3\"\r\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"O Segundo parâmetro deve ser [1/2/3]. \", \"DIST-ERRO3\" )\r\n\t\t\t\tSleep(10000)\r\n\t\t\tElse\r\n\t\t\t\t//U_SWENV(TRBMNT->WAM_TELL, \"ok\", \"DIST-OK\" )\r\n\t\t\t\tdbSelectArea(\"TQB\")\r\n\t\t\t\tdbSetOrder(1)\r\n\t\t\t\tdbSeek(xFilial(\"TQB\") + AllTrim(TRBMNT->WAM_INDEX) )\r\n\t\t\t\tIf  RecLock(\"TQB\",.F.)\r\n\t\t\t\t\tReplace TQB_CDSERV  With aRespDist[1]\r\n\t\t\t\t\tReplace TQB_CDEXEC  With \"LUAN SANTOS\"\r\n\t\t\t\t\tReplace TQB_PRIORI  With aRespDist[2]\r\n\t\t\t\t\tMsUnLock()\r\n\t\t\t\tEndIf\r\n\r\n\t\t\t\t//CONOUT(MSMM(TQB->TQB_CODMSS,80) + CHR(13)+CHR(10) + \"DATA.:\" + dToC(dDataBase)  + CHR(13)+CHR(10) + \"HORA..:\" + Replace(time(),':',':') + AllTrim(TRBMNT->DIST),80)\r\n\t\t\t\tMSMM(,,, MSMM(TQB->TQB_CODMSS,80) + CHR(13)+CHR(10) + \"DATA.:\" + dToC(dDataBase)  + CHR(13)+CHR(10) + \"HORA..:\" + Replace(time(),':',':') + CHR(13)+CHR(10) + AllTrim(TRBMNT->DIST),1,,,\"TQB\",\"TQB_CODMSS\")\r\n\t\t\t\t\r\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\r\n\t\t\t\tcQuery   += \"    SET WAM_PERG = 'N',WAM_HORAR  = Left(Cast(GETDATE() as Time ),5), WAM_DATAR  = Replace(Cast(GETDATE() as date ),'-','')\r\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010\r\n\t\t\t\tcQuery   += \"  WHERE R_E_C_N_O_ = \"+ AllTrim(Str(TRBMNT->RECNO))\r\n\r\n\t\t\t\tCONOUT(cQuery)\r\n\r\n\t\t\t\tTcSQLExec(cQuery) \r\n\r\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"SS classificada com sucesso! Código:\"+AllTrim(TRBMNT->WAM_INDEX) , \"DIST-SUCESSO\" )\r\n\t\t\t\tU_SWENV(\"27998282193\"   , \"SS classificada com sucesso! Código:\"+AllTrim(TRBMNT->WAM_INDEX) , \"DIST-SUCESSO\" )\r\n\t\t\t\t//Sleep(10000)\r\n\t\t\tEndIf\r\n\t\tEndIf\r\n\tEndIf \r\n\r\n\tdbSelectArea(\"TRBMNT\")\r\n\tdbSkip()\r\nEndDo\r\n\r\ndbSelectArea(\"TRBMNT\") \r\ndbCloseArea()\r\n\r\n/*\r\nVerificação de erro \r\nCAVALETES DIFRENTE DO PEDIDO DE VENDA\r\n*/\r\ncQuery   := \" SELECT \t'P' TIPO,\r\ncQuery   += \" \t\t\tC6_NUM,\r\ncQuery   += \" \t\t\tB8_YCAVALE\r\ncQuery   += \"   FROM (\r\ncQuery   += \"          SELECT C6_NUM ,C6_ITEM,B8_PRODUTO,B8_LOTECTL,C6_NUMLOTE,C6_YCAVALE,B8_YCAVALE,ROUND(C6_QTDVEN,4,0) C6_QTDVEN , ROUND(B8_SALDO,4,0) B8_SALDO,\r\ncQuery   += \"                         ( SELECT \r\ncQuery   += \"                             ROUND(SUM(SB.B8_YTOTLIQ),4,0) \r\ncQuery   += \"                                 FROM SB8010 SB \r\ncQuery   += \"                             WHERE   SB.D_E_L_E_T_='' \r\ncQuery   += \"                                 AND SB.B8_PRODUTO = SC6.C6_PRODUTO \r\ncQuery   += \"                                 AND SC6.C6_LOTECTL = RTRIM(LTRIM(SB.B8_LOTECTL))+RTRIM(LTRIM(SB.B8_YCLASSI)) \r\ncQuery   += \"                                 AND SC6.C6_NUMLOTE<>SB.B8_NUMLOTE \r\ncQuery   += \"                                 AND SC6.C6_NUMLOTE=SB.B8_YCAVALE\r\ncQuery   += \"                          ) SALDO_CHAPA\r\ncQuery   += \"                FROM SC6010 SC6 INNER JOIN SB8010 SB8\r\ncQuery   += \"                  ON (B8_PRODUTO = C6_PRODUTO AND B8_LOTECTL = C6_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE)\r\ncQuery   += \"              WHERE SC6.D_E_L_E_T_ = ''\r\ncQuery   += \"                AND SB8.D_E_L_E_T_ = ''\r\ncQuery   += \"                AND SC6.C6_NOTA = ''\r\ncQuery   += \"                AND SB8.B8_ORIGLAN = 'BD'\r\ncQuery   += \"                AND B8_LOCAL = C6_LOCAL\r\ncQuery   += \"          ) TB\r\ncQuery   += \" WHERE\r\ncQuery   += \"      (TB.C6_QTDVEN <> TB.B8_SALDO \r\ncQuery   += \"      OR \r\ncQuery   += \"      TB.SALDO_CHAPA<>TB.C6_QTDVEN)\r\n\r\ncQuery   += \"  UNION ALL\r\n\r\ncQuery   += \" SELECT \t'E' TIPO,\r\ncQuery   += \" \t\t\t'' C6_NUM,\r\ncQuery   += \" \t\t\tIIF(B8_YCAVALE='', B8_NUMLOTE,B8_YCAVALE) B8_YCAVALE \r\ncQuery   += \"     FROM (\r\ncQuery   += \"             SELECT \r\ncQuery   += \"                 ISNULL(( SELECT \r\ncQuery   += \"                     ROUND(SUM(SB.B8_YTOTLIQ),4,0) \r\ncQuery   += \"                         FROM SB8010 SB \r\ncQuery   += \"                     WHERE   SB.D_E_L_E_T_='' \r\ncQuery   += \"                         AND SB.B8_PRODUTO = SB8.B8_PRODUTO \r\ncQuery   += \"                         AND SB8.B8_LOTECTL = RTRIM(LTRIM(SB.B8_LOTECTL))+RTRIM(LTRIM(SB.B8_YCLASSI)) \r\ncQuery   += \"                         AND SB8.B8_NUMLOTE<>SB.B8_NUMLOTE \r\ncQuery   += \"                         AND SB8.B8_NUMLOTE=SB.B8_YCAVALE\r\ncQuery   += \"                  ),0) SALDO_CHAPA,\r\ncQuery   += \"                  ROUND(SB8.B8_SALDO,4,0) SALDO_BUNDLE,\r\ncQuery   += \"                  * \r\ncQuery   += \"             FROM SB8010 SB8 \r\ncQuery   += \"                     WHERE SB8.B8_FILIAL='010101' \r\n//cQuery   += \"                     AND CAST(SB8.B8_NUMLOTE AS INT) BETWEEN 100 AND 999999 \r\ncQuery   += \"                       AND SB8.B8_NUMLOTE = SB8.B8_YCAVALE\r\ncQuery   += \"  \t\t\t\t\t    AND SB8.B8_YCAVALE <> ''\r\ncQuery   += \"                       AND SB8.B8_SALDO>0 \r\ncQuery   += \"                       AND SB8.D_E_L_E_T_=''\r\ncQuery   += \"         )TB\r\ncQuery   += \"     WHERE SALDO_BUNDLE<>SALDO_CHAPA\r\n\r\ncQuery   += \"  UNION ALL \r\n\r\ncQuery   += \"  SELECT 'F' TIPO,\r\ncQuery   += \"  \t   D2_NUMLOTE B8_YCAVALE,\r\ncQuery   += \"  \t   CHAVE_DOC C6_NUM\r\ncQuery   += \"    FROM (\r\ncQuery   += \"  \t\tSELECT *,\r\ncQuery   += \"  \t\t\t   (SELECT ROUND(SUM(B8_YQTDBD),5,0) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI\r\ncQuery   += \"  \t\t  FROM (\r\ncQuery   += \"  \t\t\t\tSELECT  D2_FILIAL+D2_DOC+D2_SERIE CHAVE_DOC,\r\ncQuery   += \"  \t\t\t\t\t\tCAST(D2_EMISSAO AS DATE) EMISSAO,\r\ncQuery   += \"  \t\t\t\t\t\tD2_COD,\r\ncQuery   += \"  \t\t\t\t\t\tD2_NUMLOTE ,\r\ncQuery   += \"  \t\t\t\t\t\tD2_LOTECTL,\t\t\t\t\t\t\r\ncQuery   += \"  \t\t\t\t\t\tD2_FILIAL,\r\ncQuery   += \"  \t\t\t\t\t\tROUND(SUM(D2_QUANT),5,0) QTD_FAT\r\ncQuery   += \"  \t\t\t\t\tFROM SD2010 \r\ncQuery   += \"  \t\t\t\t\tWHERE D_E_L_E_T_ = '' \r\ncQuery   += \"  \t\t\t\t\t  AND D2_COD LIKE 'CH%'\r\ncQuery   += \"  \t\t\t\t\t  AND D2_QTDEDEV = 0\r\ncQuery   += \"  \t\t\t\tGROUP BY D2_FILIAL+D2_DOC+D2_SERIE,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_NUMLOTE,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_LOTECTL,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_PEDIDO,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_ITEMPV,\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_FILIAL,\r\ncQuery   += \"  \t\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE),\r\ncQuery   += \"  \t\t\t\t\t\t\tD2_COD\r\ncQuery   += \"  \t\t\t\t)TAB_BASE\r\ncQuery   += \"  \t\t)TAB_2\r\ncQuery   += \"  WHERE  ROUND(QTD_FAT,0,0) <> ROUND(QTD_SB8_ORI,0,0)\r\ncQuery   += \"    AND CHAVE_DOC NOT IN (\r\ncQuery   += \"  \t\t\t\t\t\t'0101010000064491',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000067471',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000070511',\r\ncQuery   += \"  \t\t\t\t\t\t'0101010000071041',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000072551',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000077821',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000077821',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000083191',  \r\ncQuery   += \"  \t\t\t\t\t\t'0101010000085411'  \r\ncQuery   += \"  \t\t\t\t\t\t)\r\n\r\ncQuery   += \"  ORDER BY B8_YCAVALE,C6_NUM\r\n\r\n\r\n/*\r\nQUERY USADA PARA ACHAR OS VALORES SB8 <> DO FATURADO\r\n\r\nSELECT 'F' TIPO,\r\n\t   D2_NUMLOTE B8_YCAVALE,\r\n\t   CHAVE_DOC C6_NUM\r\n\t   , *\r\n\t   ,'http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+D2_FILIAL+'&NUMPED='+D2_PEDIDO+'&rs:Format=pdf' as LINK\r\n  FROM (\r\n\t\tSELECT *,\r\n\t\t\t   (SELECT RTRIM(LTRIM(B1_DESC))  FROM SB1010 WHERE D_E_L_E_T_ = ''  AND B1_COD = D2_COD) DESCRICAO,\r\n\t\t\t   (SELECT C6_PRCVEN  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) PRC_VEN,\r\n\t\t\t   (SELECT C6_QTDVEN  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) QTD_PV_NOR,\r\n\t\t\t   (SELECT ROUND(C6_QTDVEN,0,0)  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) QTD_PV,\r\n\t\t\t   (SELECT C6_YCLASSI  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) CLASSIF,\r\n\t\t\t   (SELECT C6_YCAVALE FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) CAVALETE,\r\n\t\t\t   (SELECT SUM(B8_YQTDBD) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI_NOR,\r\n\t\t\t   (SELECT ROUND(SUM(B8_YQTDBD),0,0) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI\r\n\t\t  FROM (\r\n\t\t\t\tSELECT  D2_FILIAL+D2_DOC+D2_SERIE CHAVE_DOC,\r\n\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE) EMISSAO,\r\n\t\t\t\t\t\tD2_COD,\r\n\t\t\t\t\t\tD2_NUMLOTE ,\r\n\t\t\t\t\t\tD2_LOTECTL,\t\t\t\t\t\t\r\n\t\t\t\t\t\tD2_PEDIDO,\r\n\t\t\t\t\t\tD2_ITEMPV,\r\n\t\t\t\t\t\tD2_FILIAL,\r\n\t\t\t\t\t\tROUND(SUM(D2_QUANT),0,0) QTD_FAT\r\n\t\t\t\t\tFROM SD2010 \r\n\t\t\t\t\tWHERE D_E_L_E_T_ = '' \r\n\t\t\t\t\t -- AND D2_DOC = '000009057' \r\n\t\t\t\t\t  AND D2_COD LIKE 'CH%'\r\n\t\t\t\tGROUP BY D2_FILIAL+D2_DOC+D2_SERIE,\r\n\t\t\t\t\t\t\tD2_NUMLOTE,\r\n\t\t\t\t\t\t\tD2_LOTECTL,\r\n\t\t\t\t\t\t\tD2_PEDIDO,\r\n\t\t\t\t\t\t\tD2_ITEMPV,\r\n\t\t\t\t\t\t\tD2_FILIAL,\r\n\t\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE),\r\n\t\t\t\t\t\t\tD2_COD\r\n\t\t\t\t)TAB_BASE\r\n\t\t)TAB_2\r\nWHERE  ROUND(QTD_FAT,0,0) <> ROUND(QTD_SB8_ORI,0,0)\r\n  AND CHAVE_DOC NOT IN (\r\n\t\t\t\t\t\t'0101010000064491',  \r\n\t\t\t\t\t\t'0101010000067471',  \r\n\t\t\t\t\t\t'0101010000070511',\r\n\t\t\t\t\t\t'0101010000071041',  \r\n\t\t\t\t\t\t'0101010000072551',  \r\n\t\t\t\t\t\t'0101010000077821',  \r\n\t\t\t\t\t\t'0101010000077821',  \r\n\t\t\t\t\t\t'0101010000083191',  \r\n\t\t\t\t\t\t'0101010000085411'  \r\n\t\t\t\t\t\t)\r\nORDER BY EMISSAO, CHAVE_DOC\r\n\r\n*/\r\n\r\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBERRO\", .F., .T.)\r\ndbSelectArea(\"TRBERRO\")\r\ndbgotop()\r\nDo While !EOF()\r\n\r\n\tIF TRBERRO->TIPO == 'P'\r\n\t\t/*\r\n\t\tAVISO PARA BRUNO\r\n\t\t*/\r\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE  , \"ERRO:\" +AllTrim(TRBERRO->B8_YCAVALE)  )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tAVISO PARA ARLINDO\r\n\t\t*/\r\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE  , \"ERRO:\" +AllTrim(TRBERRO->B8_YCAVALE)  )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tEMAIL\r\n\t\t*/\r\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",'ERRO URGENTE ! PV:' + TRBERRO->C6_NUM , \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE ,'')\r\n\tENDIF\r\n\r\n\tIF TRBERRO->TIPO == 'E'\r\n\t\t/*\r\n\t\tAVISO PARA BRUNO\r\n\t\t*/\r\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) CAVALETE -  BUNDLE:\" + AllTrim(TRBERRO->B8_YCAVALE)    )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tAVISO PARA ARLINDO\r\n\t\t*/\r\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) CAVALETE - BUNDLE:\" + AllTrim(TRBERRO->B8_YCAVALE)     )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tEMAIL\r\n\t\t*/\r\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",\"ERRO URGENTE ! CAVALETE:\" + TRBERRO->B8_YCAVALE ,'')\r\n\tENDIF\r\n\r\n\t\r\n\tIF TRBERRO->TIPO == 'F'\r\n\t\t/*\r\n\t\tAVISO PARA BRUNO\r\n\t\t*/\r\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + AllTrim(TRBERRO->C6_NUM)    )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tAVISO PARA ARLINDO\r\n\t\t*/\r\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + AllTrim(TRBERRO->C6_NUM)     )\r\n\t\t\r\n\t\tsleep(300)\r\n\t\t\r\n\t\t/*\r\n\t\tEMAIL\r\n\t\t*/\r\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",\"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + TRBERRO->C6_NUM ,'')\r\n\tENDIF\r\n\r\n\tdbSelectArea(\"TRBERRO\")\r\n\tdbSkip()\r\nEndDo\r\n\r\ndbSelectArea(\"TRBERRO\") \r\ndbCloseArea()\r\n\r\n/*\r\nCaso exista alguma aprovação ou reprovação \r\no sistema envia o protocolo por e-mail\r\n*/\r\nIF lEnvProt\r\n\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0060&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0060.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\r\n\t  \r\n\t//ConOut(\"Gerando protocolo...\" )\r\n\t//Sleep(3000)\r\n\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"diego.sirtori@grupoqualita.com.br\",'Relaório de Protocolo','Anexo relatório de protocolos!','D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0060.PDF')\r\nEndIf\r\n\r\nIf lAutoZAP\r\n\tRpcClearEnv()\r\n\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" FIM do JOB liberação de Retornos pelo WHATSAPP.\")\r\nElse\r\n\t// Caso não seja job, informa na a atualização\r\n\tAlert(\"Fim da liberação de Retorno pelo WHATSAPP. (Chamada Manual)\")\r\nEndif\r\n\r\nReturn\r\n"}}}
Content-Length: 51332
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"git:/d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/10_LIB/LIBWHATSAPP.PRW?%7B%22path%22%3A%22d%3A%5C%5CTOTVS%2012%5C%5CMicrosiga%5C%5CProtheus%5C%5CProjetoVSCode%5C%5C10_LIB%5C%5CLIBWHATSAPP.PRW%22%2C%22ref%22%3A%22~%22%7D","languageId":"advpl","version":1,"text":"#include \"protheus.ch\"\n#include \"rwmake.ch\"\n#include \"tbiconn.ch\"  \n#INCLUDE \"TOTVS.CH\"\n#INCLUDE \"topconn.ch\"\n\n/*\nPrograma ...: LIBWHATSAPP.Prw\nUso ........: Programa verifica a provação do pedido automaticamente pelo WhatsApp\nData .......: 23/03/2020\nFeito por ..: Bruno Lage Ferreira\nCopyright @1998-2001,2021\n\nQ-Liberação Faturamento\n5527995295180-1587589430@g.us\nlogistica.es@qualitagroup.com;comercial.es@grupoqualita.com.br\n\nQ-N2 - Liberação Compras\n5527995295180-1594316108@g.us\npedido.compra@grupoqualita.com.br\n\nQ-N1 - Liberação Compras\n5527995295180-1587589523@g.us\npedido.compra@grupoqualita.com.br\n*/ \n\nUser Function LIBWHATSAPP()  \n************************************************************************************************************\n*\n*\n*\n***\nLocal cQuery   := \"\"\nLocal lAutoZAP := .F.\n\nLocal aLogAuto := {}\n\nLocal oJson\nLocal cErr     := \"\"\n/*\nLocal lMsg     := \"\"\n*/\nLocal cMessage := \"\"\nLocal lEnvProt := .F.\nLocal nAux\n\nConOut( \">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>   WHATSAPP APROVAÇÃO   <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\" )\n\nIf Select(\"SX2\")==0  \n\tPREPARE ENVIRONMENT EMPRESA \"01\" FILIAL \"01\" TABLES \"WAM\",\"SC5\"\n\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" Iniciando JOB de liberação de Retorno pelo WHATSAPP.\")\n\tlAutoZAP := .T.\nEndIf\n\n\n/*\n******************************************************************************************\nchamada do Modulo AutoStart\nTODOS OS COMANDOS VIA PROCEDUTE\n*/\nConOut(\"*********************************************************************************\")\nConOut(\"*********************************************************************************\")\nConOut(\"*********************         INICIANDO AUTOSTART          **********************\")\nConOut(\"*********************************************************************************\")\nConOut(\"*********************************************************************************\")\n\nTCSPEXEC(\"WHATSAPP_AUTOSTART\")\n   \n/*\n*\n******************************************************************************************\n*/\ncQuery :=  \" SELECT  \ncQuery +=  \" \t\tWAM_FILIAL,\ncQuery +=  \" \t\tWAM_DATA,\ncQuery +=  \" \t\tWAM_HORA,\ncQuery +=  \" \t\tWAM_ID,\ncQuery +=  \" \t\tRTRIM(LTRIM(ISNULL(CONVERT(VARCHAR(2047), CONVERT(VARBINARY(2047), WAM_MSG)),''))) WAM_MSG,\ncQuery +=  \" \t\tWAM_TELL,\ncQuery +=  \" \t\tWAM_INDEX,\ncQuery +=  \" \t\tWAM_PERG,\ncQuery +=  \" \t\tWAM_DATAR,\ncQuery +=  \" \t\tWAM_HORAR,\ncQuery +=  \" \t\tWAM_RESPOS,\ncQuery +=  \" \t\tWAM_EXEC,\ncQuery +=  \" \t\tWAM_NIVEL\ncQuery +=  \" \t\tFROM WAM010 WHERE D_E_L_E_T_ = '' AND CAST(WAM_DATA AS DATE) > CAST(GETDATE()-4 AS DATE) AND WAM_PERG = 'S' AND WAM_EXEC LIKE '%QUALITA%'\n\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBRA\", .F., .T.)\ndbSelectArea(\"TRBRA\")\ndbgotop()\nDo While !EOF()\n\n\tIf !Empty(TRBRA->WAM_ID)\t\n\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\"Protocolo: [\"+ AllTrim(TRBRA->WAM_ID) + \"] INDEX:\" + TRBRA->WAM_INDEX )\n\t\t\n\t\t// Cria o objeto JSON e popula ele a partir da string\n\t\t\n\t\toJson := JSonObject():New()\n\t\tcErr  := oJSon:fromJson(U_SWREMGWAP(AllTrim(TRBRA->WAM_ID)))\n\t\t\n\t\tsleep(400)\n\t\t\n\t\tConOut(oJson:GetJSonObject('quote_message'))\n\t\t\n\t\tIf !Empty(cErr)\n\t\t  \tConout(cErr + \"Protocolo:\" + AllTrim(TRBRA->WAM_ID))\n\t\t  \t\n\t\t  \t// Descarta o objeto \n\t\t  \tFreeObj(oJson)\n\t\t  \n\t\t  \tdbSelectArea(\"TRBRA\")\n\t\t  \tdbSkip()\n\t\tEndif\n\t\t\n\t\t// Agora vamos ler as propriedades com GetJSonObject()\n\t\t aRetMsg :=\tstrTokArr(U_SWREMGWAP(TRBRA->WAM_ID), ',' )\n\tEndIf\n\t\n\t\n\t/*\n\t**********************************************************************************************************************\n\tTratamento das liberação \n\t - Mapa de Cotação\n\t - Pedido de Compra\n\t - Pedido de Vendas\n\t**********************************************************************************************************************\n\t*/\n\tIF AllTrim(TRBRA->WAM_EXEC) == \"QUALITA-MC\"\n\t\t\n\t\t/*\n\t\t***************************************************\n\t\tNIVEL 1\n\t\t***************************************************\n\t\t*/\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"1\"\n\t\t\t\n\t\t\t/*\n\t\t\tProcessamento dos retorno Mapa de cotação-MC\n\t\t\t*/\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\t\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\t\n\t\t\t\t//ENVIO DO PROTOCOLO \n\t\t\t\tlEnvProt := .T.\n\t\t\t\t\n\t\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \n\t\t\t\t\tdbSelectArea(\"SC8\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0025_V&cCotacao=' + SC8->C8_NUM +'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tConOut(\"Gerando relatório! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\tcProt := U_SWENARWAP(\"5527995295180-1594316108@g.us\", \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"                                                                     ,\"MC\"+ SC8->C8_NUM             ,\"MC-\" + SC7->C7_NUM  ,\"PDF\",\"\\RELINWEB\\MC-\"+ SC8->C8_NUM +\".PDF\")\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t30 segundos\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\t\n\t\t\t\t\t\tIF cProt = \"\" .or. cProt = nil \n\t\t\t\t\t\t\tConOut(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde! MC-\"+ SC8->C8_NUM +\".PDF\")\n\t\t\t\t\t\t\tReturn()\n\t\t\t\t\t\tEndIf\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tIf  RecLock(\"WAM\",.T.) \n\t\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \n\t\t\t\t\t\t\tReplace WAM_DATA    With Date()\n\t\t\t\t\t\t\tReplace WAM_HORA    With Time()\n\t\t\t\t\t\t\tReplace WAM_ID      With cProt\n\t\t\t\t\t\t\tReplace WAM_MSG     With \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"\n\t\t\t\t\t\t\tReplace WAM_INDEX   With SC8->C8_FILIAL + SC8->C8_NUM\n\t\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\n\t\t\t\t\t\t\tReplace WAM_NIVEL   With \"2\"\n\t\t\t\t\t\t\tIF SubString(CNUMEMP,1,2) == \"05\"\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'ITINGA-MC'\n\t\t\t\t\t\t\tElse\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'QUALITA-MC'\n\t\t\t\t\t\t\tEndIf\n\t\t\t\t\t\t   MsUnLock()\n\t\t\t\t\t\tEndIf\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como já lido. \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\tElse\n\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como já lido\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tColoca a MSg mais não mostra data nem hora de liberação\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \n\t\t\t\t\t\tcQuery += \"    SET C8_MSGLIB='\"+ \"NÃO LIBERADO: \" + Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"   FROM \" + RetSqlName(\"SC8\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'COTAÇÃO NÃO LIBERADA!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado (Mapa de Cotação NÃO liberado):\" + TRBRA->WAM_INDEX )\t\n\t\t\t\t\t\n\t\t\t\tEndIf\n\t\t\t\t\n\t\t\tEndIf\n\t\t\n\t\tEndIf\n\t\t\n\t\t/*\n\t\t***************************************************\n\t\tNIVEL 2\n\t\t***************************************************\n\t\t*/\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"2\"\n\t\t\t\n\t\t\t/*\n\t\t\tProcessamento dos retorno Mapa de cotação-MC\n\t\t\t*/\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\t\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\t\n\t\t\t\t//ENVIO DO PROTOCOLO \n\t\t\t\tlEnvProt := .T.\n\t\t\t\t\n\t\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \n\t\t\t\t\tdbSelectArea(\"SC8\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGravando aprovação na SC8\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \n\t\t\t\t\t\tcQuery += \"    SET C8_DATALIB='\"+ DToS(dDataBase) +\"',C8_HORALIB='\"+ LEFT(AllTrim(TIME()),5) +\"',C8_MSGLIB='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC8\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\n\t\t\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0025_V&cCotacao=' + SC8->C8_NUM +'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\tConOut(\"Gerando relatório! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação Liberado!     Código:' + SC8->C8_NUM       ,'COTAÇÃO LIBERADA! Código:'              + SC8->C8_NUM + ', liberado!'+ \"<br>\" +'CÓDIGO:' + SC8->C8_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda:\" + AllTrim(SC8->C8_NUM) )\t\n\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\tElse\n\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tColoca a MSg mais não mostra data nem hora de liberação\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \n\t\t\t\t\t\tcQuery += \"    SET C8_MSGLIB='\"+ \"NÃO LIBERADO: \" + Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"   FROM \" + RetSqlName(\"SC8\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\n\t\t\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'COTAÇÃO NÃO LIBERADA!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado (Mapa de Cotação NÃO liberado):\" + TRBRA->WAM_INDEX )\t\n\t\t\t\t\t\n\t\t\t\tEndIf\n\t\t\t\t\n\t\t\tEndIf\n\t\t\n\t\tEndIf\n\n\tElseIf AllTrim(TRBRA->WAM_EXEC) == \"QUALITA-PC\"\n\t\n\t\t/*\n\t\t***************************************************\n\t\tNIVEL 1\n\t\t***************************************************\n\t\t*/\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"1\"\n\t\n\t\t\t/*\n\t\t\tProcessamento dos retorno Pedido de Compra-PC\n\t\t\t*/\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\t\n\t\t\t\t//ENVIO DO PROTOCOLO \n\t\t\t\tlEnvProt := .T.\n\t\t\t\t\n\t\t\t\tIf \"APROVADO\" $ Upper(cMessage) \n\t\t\t\t\tdbSelectArea(\"SC7\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGera dados do pedido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tu_ImpPc(2)\n\t\t\t\t\t\tWaitRunSrv('\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tcProt := U_SWENARWAP(\"5527995295180-1594316108@g.us\", \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"                                                                     ,\"PC-2-\" + SC7->C7_NUM         ,\"PC-2-\" + SC7->C7_NUM   ,\"PDF\",\"\\RELINWEB\\PC-\" + SC7->C7_NUM + \".PDF\")\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t30 segundos\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\t        \t\t\t\t\t\t                  \n\t\t\t\t\t\tIF cProt = \"\" .or. cProt = nil \n\t\t\t\t\t\t\tConOut(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde! PC-\"+SC7->C7_NUM+\".PDF\")\n\t\t\t\t\t\t\tReturn()\n\t\t\t\t\t\tEndIf                 \n\t\t\t\t\t\t                      \n\t\t\t\t\t\tIf  RecLock(\"WAM\",.T.) \n\t\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \n\t\t\t\t\t\t\tReplace WAM_DATA    With Date()\n\t\t\t\t\t\t\tReplace WAM_HORA    With Time()\n\t\t\t\t\t\t\tReplace WAM_ID      With cProt\n\t\t\t\t\t\t\tReplace WAM_MSG     With \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\" \n\t\t\t\t\t\t\tReplace WAM_INDEX   With SC7->C7_FILIAL + SC7->C7_NUM\n\t\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\n\t\t\t\t\t\t\tReplace WAM_NIVEL   With \"2\"\n\t\t\t\t\t\t\tIF SubString(CNUMEMP,1,2) == \"05\"\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'ITINGA-PC'\n\t\t\t\t\t\t\tElse\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'QUALITA-PC'\n\t\t\t\t\t\t\tEndIf\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t   MsUnLock()\n\t\t\t\t\t\tEndIf\n\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\tElse\n\t\t\t\t\tdbSelectArea(\"SC7\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGravando aprovação na SC7\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \n\t\t\t\t\t\tcQuery += \"    SET C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGera dados do pedido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\t//u_ImpPc(2)\n\t\t\t\t\t\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\t//ConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"almoxarifado@grupoqualita.com.br;emelly.couto@grupoqualita.com.br;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + SC7->C7_NUM + ', não liberado!'+ \"<br>\" +'CÓDIGO:' + SC7->C7_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RXX0022.PDF')\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Não Liberado! Código:' + SC7->C7_NUM , 'Pedido Não Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\t\n\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\n\t\t\t\tEndIf\t\n\t\t\t\n\t\t\tEndIf\n\t\t\t\n\t\tEndIf\n\t\n\t\n\t\t/*\n\t\t***************************************************\n\t\tNIVEL 2\n\t\t***************************************************\n\t\t*/\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"2\"\n\t\n\t\t\t/*\n\t\t\tProcessamento dos retorno Pedido de Compra-PC\n\t\t\t*/\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\t\n\t\t\t\t//ENVIO DO PROTOCOLO \n\t\t\t\tlEnvProt := .T.\n\t\t\t\t\n\t\t\t\tIf \"APROVADO\" $ Upper(cMessage) \n\t\t\t\t\tdbSelectArea(\"SC7\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGravando aprovação na SC7\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \n\t\t\t\t\t\tcQuery += \"    SET C7_DATALIB='\"+ DToS(dDataBase) +\"',C7_HORALIB='\"+ LEFT(AllTrim(TIME()),5) +\"',C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\n\t\t\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGera dados do pedido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tu_ImpPc(2)\n\t\t\t\t\t\tWaitRunSrv('\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\tConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Liberado! Código:' + SC7->C7_NUM , 'Pedido Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF')\n\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\tElse\n\t\t\t\t\tdbSelectArea(\"SC7\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGravando aprovação na SC7\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \n\t\t\t\t\t\tcQuery += \"    SET C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGera dados do pedido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\t//u_ImpPc(2)\n\t\t\t\t\t\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\t//ConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"almoxarifado@grupoqualita.com.br;emelly.couto@grupoqualita.com.br;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + SC7->C7_NUM + ', não liberado!'+ \"<br>\" +'CÓDIGO:' + SC7->C7_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RXX0022.PDF')\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Não Liberado! Código:' + SC7->C7_NUM , 'Pedido Não Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\t\n\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\n\t\t\t\tEndIf\t\n\t\t\t\n\t\t\tEndIf\n\t\t\t\n\t\tEndIf\n\t\n\t\n\tElse\n\t\t/*\n\t\tProcessamento dos retornos Pedido de Venda PV \n\t\t*/\n\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\n\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\n\t\t\t//ENVIO DO PROTOCOLO \n\t\t\tlEnvProt := .T.\n\t\t\t\n\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \n\t\t\t\tdbSelectArea(\"SC5\")\n\t\t\t\tdbSetOrder(1)\n\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\tRecLock(\"SC5\",.F.)\n\t\t\t\t\t\tSC5->C5_BLQ  := ''\n\t\t\t\t\tMsUnlock()\t\n\t\t\t\t\t\n\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\n\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\n\t\t\t\t\tIf SC5->C5_YTIPO == \"ME\"\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\tElse\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\tEndIf\n\t\t\t\t\t\n\t\t\t\t\tConOut(\"Gerando relatório! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\n\t\t\t\t\tsleep(300)\n\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\n\t\t\t\t\t\n\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"logistica.es@qualitagroup.com;bruno.lage@grupoqualita.com.br\",'Pedido Liberado! Código:' + SC5->C5_NUM ,'PEDIDO LIBERADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\n\t\t\t\t\t\n\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda:\" + TRBRA->WAM_INDEX )\t\n\t\t\t\tEndIf\n\t\t\tElse\n\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\n\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"logistica.es@qualitagroup.com;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'PEDIDO NÃO LIBERADO!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\n\t\t\t\t\t\n\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda (NÃO liberado):\" + TRBRA->WAM_INDEX )\t\n\t\t\tEndIf\n\t\tEndIf\n\tEndIf\n\t\n\t// Descarta o objeto \n\tFreeObj(oJson)\n\n\tdbSelectArea(\"TRBRA\")\n\tdbSkip()\nEndDo\n\ndbSelectArea(\"TRBRA\") \ndbCloseArea()\n\n\n/*\n******************************************************************************************\nchamada do Modulo AutoStart\nTODOS OS COMANDOS VIA PROCEDUTE\n*/\nConOut(\"*********************************************************************************\")\nConOut(\"*********************************************************************************\")\nConOut(\"*********************         INICIANDO AUTOSTART          **********************\")\nConOut(\"*********************************************************************************\")\nConOut(\"*********************************************************************************\")\n\nTCSPEXEC(\"WHATSAPP_AUTOSTART\")\n   \n\n/*\n******************************************************************************************\nResposta do Modulo MNT\nABERTURA E DISTRIBUIÇÃO\n*/\ncQuery   := \" SELECT  ISNULL((SELECT USR_ID     FROM DADOSADV_Q..SYS_USR WHERE USR_MSBLQL <> 1 AND USR_CARGO = WAM_TELL),'') ID_USUARIO,\ncQuery   += \" \t  \t  ISNULL((SELECT USR_CODIGO FROM DADOSADV_Q..SYS_USR WHERE USR_MSBLQL <> 1 AND USR_CARGO = WAM_TELL),'') USUARIO,\ncQuery   += \" \t  \t  R_E_C_N_O_ RECNO,\ncQuery   += \" \t\t  UPPER(RTRIM(LTRIM(SUBSTRING(RETORNO,IIF(CHARINDEX(',',UPPER(RETORNO))=0,0,CHARINDEX(',',UPPER(RETORNO))+1),LEN(RETORNO)  ))) ) \t  MSG,*\ncQuery   += \"   FROM DADOSADV_Q..WAM010\ncQuery   += \"\tCROSS APPLY\ncQuery   += \"\t(\ncQuery   += \"\tSELECT RETORNO = dbo.FnWhatRetMSG(WAM_ID)\ncQuery   += \"\t) x\ncQuery   += \"  WHERE D_E_L_E_T_ = ''\ncQuery   += \"    AND WAM_EXEC = 'MNT'\ncQuery   += \"    AND WAM_PERG = 'N'\ncQuery   += \"    AND WAM_NIVEL = 0\n//cQuery   += \"  --AND dbo.FnWhatRetMSG(WAM_ID) <> ''\n\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBMNT\", .F., .T.)\ndbSelectArea(\"TRBMNT\")\ndbgotop()\nDo While !EOF()\n\n\t\t\t\n\t\t\tPrivate\taSolic          :={}\t\n\t\t\tPrivate lMSHelpAuto     := .T. // Nao apresenta erro em tela\n\t\t\tPrivate lMSErroAuto     := .F. //   Caso a variavel torne-se .T. apos MsExecAuto, apresenta erro em tela\n\t\t\tPrivate lAutoErrNoFile\t:= .T.\n\t\t\tPrivate cErroTemp       := \"\"\n\t\t\tPrivate cArquivo        := \"\"\n\t\t\tPrivate cProt           := \"\"\n\t\n\t\t\taSolic := {\t{\"TQB_CODBEM\" , TRBMNT->WAM_RESPOS    \t,Nil},;             \t// Codigo do Bem a  ser  relacionado na Solicitacao de Servico\n\t\t\t\t\t\t{\"TQB_DTABER\" , dDataBase     \t\t\t,Nil},; \t\t\n\t\t\t\t\t\t{\"TQB_HOABER\" , LEFT(TIME(), 5 )        ,Nil},; \t\n\t\t\t\t\t\t{\"TQB_USUARI\" , TRBMNT->USUARIO   \t\t,Nil},; \t\t\n\t\t\t\t\t\t{\"TQB_CDSOLI\" , TRBMNT->ID_USUARIO\t\t,Nil},; \t\t\n\t\t\t\t\t\t{\"TQB_DESCSS\" , TRBMNT->MSG \t\t\t,Nil}} \t\t\t\t\t//  Descricao da  Solicitacao\n\n\t\t\tMSExecAuto( {|x,z,y,w| MNTA280(x,z,y,w)}, , , aSolic )\t\t\n\n\t\t\tIf lMsErroAuto\n\t\t\t\t//U_SWENV(\"5533984022125\" , Mostraerro()  , \"ERRO MNT\" )\n\t\t\t\tConOut(\"************* ERRO MNT INICIO *************\")\n\t\t\t\t//U_SWENV(TRBMNT->WAM_TELL, \"Erro no cadastro da S. Serviço!\"  , \"ERRO MNT\" )\n\n\t\t\t\t//Pegando log do ExecAuto\n\t\t\t\taLogAuto := GetAutoGRLog()\n\n\t\t\t\t/*\n\t\t\t\t//Percorrendo o Log e incrementando o texto (para usar o CRLF você deve usar a include \"Protheus.ch\")\n\t\t\t\t//nAux \t\t:= 0\n\t\t\t\t//aLogAuto    :={}\n\t\t\t\t*/\t\n\t\t\t\tFor nAux := 1 To Len(aLogAuto) \n\t\t\t\t\tcErroTemp += aLogAuto[nAux] + CHR(13)+CHR(10)\n\t\t\t\tNext nAux\n\n\t\t\t\tIf cErroTemp == \"\"\n\t\t\t\t\tcErroTemp := \"Sem informações de erro.\"\n\t\t\t\tEndIf\n\n\t\t\t\tcArquivo := \"\\_LOGWHATSMNT\\\" + \"MNT_ERRO\" + dToS(dDataBase) +'_'+ Replace(time(),':','_') + \".txt\"\n\t\t\t\t\n\t\t\t\tConOut(cArquivo)\n\t\t\t\tConOut(cErroTemp)\n\n\t\t\t\tSleep(3000)\n\n\t\t\t\t//Criando o arquivo txt\n\t\t\t\tMemoWrite(cArquivo, cErroTemp )\n\n\t\t\t\t//cErroTemp := Mostraerro(\"\\_LOGWHATSMNT\\\", cArquivo)\n\t\t\t\t\n\t\t\t\tConOut(cErroTemp)\n\t\t\t\tSleep(3000)\n\n\t\t\t\tU_SWENARWAP(AllTrim(TRBMNT->WAM_TELL),\"Erro no cadastro da S. Serviço!\",\"Erro no cadastro da S. Serviço!\",\"MNT_ERRO\",\"TXT\",cArquivo)\n\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\n\t\t\t\tcQuery   += \"    SET WAM_NIVEL = 3\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010  \n\t\t\t\tcQuery   += \"  WHERE D_E_L_E_T_ = ''\n\t\t\t\tcQuery   += \"    AND WAM_EXEC = 'MNT'\n\t\t\t\tcQuery   += \"    AND WAM_PERG = 'N'\n\t\t\t\tcQuery   += \"    AND WAM_NIVEL = 0\n\n\t\t\t\tTcSQLExec(cQuery)   \n\n\t\t\t\tConOut(\"************* ERRO MNT FIM*************\")\n\t\t\tElse\n\t\t\t\n\t\t\t\tdbSelectArea(\"TQB\")\n\t\t\t\tcCodigoSS := TQB->TQB_SOLICI\n\t\t\t\tConOut(\"************* CONFIRMAÇÃO DA SS MNT INICIO *************\")\n\t\t\t\tConOut(\"****Codigo..:\"+cCodigoSS)\n\t\t\t\tConOut(\"********************************************************\")\n\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"Solicitação cadastrada com sucesso! Código:\" +cCodigoSS, \"SOLICITAÇÃO DE SERVIÇO\" )\n\n\t\t\t\tSleep(3000)\n\n\t\t\t\t/*\n\t\t\t\tDistriburir \n\t\t\t\tResponsável pela Manutenção\n\t\t\t\t*/\n\t\t\t\tdbSelectArea(\"ST9\")\n\t\t\t\tdbSetOrder(1)\n\t\t\t\tdbSeek(xFilial(\"ST9\") + TRBMNT->WAM_RESPOS)\n\n\t\t\t\tcErroTemp := \"NOVA SOLICITAÇÃO DE SERVIÇO PARA DISTRIBUIÇÃO\" + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"CÓDIGO........:\" + cCodigoSS                   + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"DATA..........:\" + dToC(dDataBase)             + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"HORA..........:\" + Replace(time(),':',':')     + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"EQUIPAMENTO ID:\" + TRBMNT->WAM_RESPOS          + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"EQUIPAMENTO...:\" + AllTrim(ST9->T9_NOME)       + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"PROBLEMA......:\" + AllTrim(TRBMNT->MSG)        + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"COMO APROVAR..:\" + \"CIV/MEC/ELE/ , 1/2/3, COMPLEMENTO DA DESCRIÇÃO DO PROBLEMA\" \n\n\t\t\t\tcArquivo := \"\\_LOGWHATSMNT\\\" + \"MNT_DIST\" + cCodigoSS + dToS(dDataBase) +'_'+ Replace(time(),':','_') + \".txt\"\n\t\t\t\tMemoWrite(cArquivo, cErroTemp )\n\n\t\t\t\t/*\n\t\t\t\tTelefone fixo com a pessoa que vai distibuir \n\t\t\t\t*/ \n\t\t\t\tcNumDist := \"27997857938\"\n\t\t\t\t                \n\n\t\t\t\tcProt := U_SWENARWAP(AllTrim(cNumDist),\"Distribuir:\" + cCodigoSS,\"SS_\"+cCodigoSS,\"SS_\"+cCodigoSS,\"TXT\",cArquivo)\n\n\t\t\t\tIf  RecLock(\"WAM\",.T.) \n\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \n\t\t\t\t\t\tReplace WAM_DATA    With Date()\n\t\t\t\t\t\tReplace WAM_HORA    With Time()\n\t\t\t\t\t\tReplace WAM_ID      With cProt\n\t\t\t\t\t\tReplace WAM_MSG     With cErroTemp\n\t\t\t\t\t\tReplace WAM_INDEX   With cCodigoSS\n\t\t\t\t\t\tReplace WAM_TELL    With cNumDist\n\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\n\t\t\t\t\t\tReplace WAM_NIVEL   With \"0\"\n\t\t\t\t\t\tReplace WAM_EXEC    With 'MNT-DIST'\n\t\t\t\t\tMsUnLock()\n\t\t\t\tEndIf\n\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\n\t\t\t\tcQuery   += \"    SET WAM_NIVEL = 1 , WAM_HORAR  = Left(Cast(GETDATE() as Time ),5), WAM_DATAR  = Replace(Cast(GETDATE() as date ),'-',''),WAM_INDEX = '\"+AllTrim(cCodigoSS)+\"'\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010  \n\t\t\t\tcQuery   += \"  WHERE D_E_L_E_T_ = ''\n\t\t\t\tcQuery   += \"    AND WAM_EXEC = 'MNT'\n\t\t\t\tcQuery   += \"    AND WAM_PERG = 'N'\n\t\t\t\tcQuery   += \"    AND WAM_NIVEL = 0\n\n\t\t\t\tTcSQLExec(cQuery)   \n\n\n\t\t\t\tConOut(\"************* CONFIRMAÇÃO DA SS MNT FIM *************\")\n\t\t\t\tConOut(\"****Codigo..:\"+cCodigoSS)\n\t\t\t\tConOut(\"********************************************************\")\n\t\t\tEndif\t\n\n\tdbSelectArea(\"TRBMNT\")\n\tdbSkip()\nEndDo\n\n\n\ndbSelectArea(\"TRBMNT\") \ndbCloseArea()\n\n/**\n*********************************************************************************\nRetorno da DISTRIBUIÇÃO\nMNT\n*/\nPrivate aRespDist := {}\n\ncQuery   := \" SELECT UPPER(RETORNO) DIST,\ncQuery   += \"        CAST(GETDATE() AS DATE)         DATA,\ncQuery   += \" \t     FORMAT(GETDATE(),'hh:mm')       HORA,\ncQuery   += \" \t     R_E_C_N_O_         \t\t\t RECNO,\ncQuery   += \" \t\t *\ncQuery   += \"   FROM DADOSADV_Q..WAM010\ncQuery   += \"\tCROSS APPLY\ncQuery   += \"\t(\ncQuery   += \"\tSELECT RETORNO = dbo.FnWhatRetMSG(WAM_ID)\ncQuery   += \"\t) x\ncQuery   += \"  WHERE D_E_L_E_T_ = ''\ncQuery   += \"    AND WAM_EXEC = 'MNT-DIST'\ncQuery   += \"    AND WAM_PERG = 'S'\ncQuery   += \"    AND UPPER(RETORNO) <> ''\ncQuery   += \"    AND CAST(GETDATE()-3 AS DATE) <= CAST(WAM_DATA AS DATE)\n\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBMNT\", .F., .T.)\ndbSelectArea(\"TRBMNT\")\ndbgotop()\nDo While !EOF()\n\t\n\taRespDist := strtokarr (AllTrim(TRBMNT->DIST), \",\")\n\t\n\tIf Len(aRespDist) < 2\n\t\tU_SWENV(TRBMNT->WAM_TELL, \"Ditribuição errada tente novamente! Quantidade de parâmetros não atende.\", \"DIST-ERRO1\" )\n\t\tSleep(10000)\n\tElse\n\t\tIf !aRespDist[1] $ \"CIV/MEC/ELE\"\n\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"O primeiro parâmetro deve ser [CIV/MEC/ELE]. \", \"DIST-ERRO2\" )\n\t\t\tSleep(10000)\n\t\tElse\n\t\t\tIf !aRespDist[2] $ \"1/2/3\"\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"O Segundo parâmetro deve ser [1/2/3]. \", \"DIST-ERRO3\" )\n\t\t\t\tSleep(10000)\n\t\t\tElse\n\t\t\t\t//U_SWENV(TRBMNT->WAM_TELL, \"ok\", \"DIST-OK\" )\n\t\t\t\tdbSelectArea(\"TQB\")\n\t\t\t\tdbSetOrder(1)\n\t\t\t\tdbSeek(xFilial(\"TQB\") + AllTrim(TRBMNT->WAM_INDEX) )\n\t\t\t\tIf  RecLock(\"TQB\",.F.)\n\t\t\t\t\tReplace TQB_CDSERV  With aRespDist[1]\n\t\t\t\t\tReplace TQB_CDEXEC  With \"LUAN SANTOS\"\n\t\t\t\t\tReplace TQB_PRIORI  With aRespDist[2]\n\t\t\t\t\tMsUnLock()\n\t\t\t\tEndIf\n\n\t\t\t\t//CONOUT(MSMM(TQB->TQB_CODMSS,80) + CHR(13)+CHR(10) + \"DATA.:\" + dToC(dDataBase)  + CHR(13)+CHR(10) + \"HORA..:\" + Replace(time(),':',':') + AllTrim(TRBMNT->DIST),80)\n\t\t\t\tMSMM(,,, MSMM(TQB->TQB_CODMSS,80) + CHR(13)+CHR(10) + \"DATA.:\" + dToC(dDataBase)  + CHR(13)+CHR(10) + \"HORA..:\" + Replace(time(),':',':') + CHR(13)+CHR(10) + AllTrim(TRBMNT->DIST),1,,,\"TQB\",\"TQB_CODMSS\")\n\t\t\t\t\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\n\t\t\t\tcQuery   += \"    SET WAM_PERG = 'N',WAM_HORAR  = Left(Cast(GETDATE() as Time ),5), WAM_DATAR  = Replace(Cast(GETDATE() as date ),'-','')\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010\n\t\t\t\tcQuery   += \"  WHERE R_E_C_N_O_ = \"+ AllTrim(Str(TRBMNT->RECNO))\n\n\t\t\t\tCONOUT(cQuery)\n\n\t\t\t\tTcSQLExec(cQuery) \n\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"SS classificada com sucesso! Código:\"+AllTrim(TRBMNT->WAM_INDEX) , \"DIST-SUCESSO\" )\n\t\t\t\tU_SWENV(\"27998282193\"   , \"SS classificada com sucesso! Código:\"+AllTrim(TRBMNT->WAM_INDEX) , \"DIST-SUCESSO\" )\n\t\t\t\t//Sleep(10000)\n\t\t\tEndIf\n\t\tEndIf\n\tEndIf \n\n\tdbSelectArea(\"TRBMNT\")\n\tdbSkip()\nEndDo\n\ndbSelectArea(\"TRBMNT\") \ndbCloseArea()\n\n\n\n/*\nVerificação de erro \nCAVALETES DIFRENTE DO PEDIDO DE VENDA\n*/\ncQuery   := \" SELECT \t'P' TIPO,\ncQuery   += \" \t\t\tC6_NUM,\ncQuery   += \" \t\t\tB8_YCAVALE\ncQuery   += \"   FROM (\ncQuery   += \"          SELECT C6_NUM ,C6_ITEM,B8_PRODUTO,B8_LOTECTL,C6_NUMLOTE,C6_YCAVALE,B8_YCAVALE,ROUND(C6_QTDVEN,4,0) C6_QTDVEN , ROUND(B8_SALDO,4,0) B8_SALDO,\ncQuery   += \"                         ( SELECT \ncQuery   += \"                             ROUND(SUM(SB.B8_YTOTLIQ),4,0) \ncQuery   += \"                                 FROM SB8010 SB \ncQuery   += \"                             WHERE   SB.D_E_L_E_T_='' \ncQuery   += \"                                 AND SB.B8_PRODUTO = SC6.C6_PRODUTO \ncQuery   += \"                                 AND SC6.C6_LOTECTL = RTRIM(LTRIM(SB.B8_LOTECTL))+RTRIM(LTRIM(SB.B8_YCLASSI)) \ncQuery   += \"                                 AND SC6.C6_NUMLOTE<>SB.B8_NUMLOTE \ncQuery   += \"                                 AND SC6.C6_NUMLOTE=SB.B8_YCAVALE\ncQuery   += \"                          ) SALDO_CHAPA\ncQuery   += \"                FROM SC6010 SC6 INNER JOIN SB8010 SB8\ncQuery   += \"                  ON (B8_PRODUTO = C6_PRODUTO AND B8_LOTECTL = C6_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE)\ncQuery   += \"              WHERE SC6.D_E_L_E_T_ = ''\ncQuery   += \"                AND SB8.D_E_L_E_T_ = ''\ncQuery   += \"                AND SC6.C6_NOTA = ''\ncQuery   += \"                AND SB8.B8_ORIGLAN = 'BD'\ncQuery   += \"                AND B8_LOCAL = C6_LOCAL\ncQuery   += \"          ) TB\ncQuery   += \" WHERE\ncQuery   += \"      (TB.C6_QTDVEN <> TB.B8_SALDO \ncQuery   += \"      OR \ncQuery   += \"      TB.SALDO_CHAPA<>TB.C6_QTDVEN)\n\ncQuery   += \"  UNION ALL\n\ncQuery   += \" SELECT \t'E' TIPO,\ncQuery   += \" \t\t\t'' C6_NUM,\ncQuery   += \" \t\t\tIIF(B8_YCAVALE='', B8_NUMLOTE,B8_YCAVALE) B8_YCAVALE \ncQuery   += \"     FROM (\ncQuery   += \"             SELECT \ncQuery   += \"                 ISNULL(( SELECT \ncQuery   += \"                     ROUND(SUM(SB.B8_YTOTLIQ),4,0) \ncQuery   += \"                         FROM SB8010 SB \ncQuery   += \"                     WHERE   SB.D_E_L_E_T_='' \ncQuery   += \"                         AND SB.B8_PRODUTO = SB8.B8_PRODUTO \ncQuery   += \"                         AND SB8.B8_LOTECTL = RTRIM(LTRIM(SB.B8_LOTECTL))+RTRIM(LTRIM(SB.B8_YCLASSI)) \ncQuery   += \"                         AND SB8.B8_NUMLOTE<>SB.B8_NUMLOTE \ncQuery   += \"                         AND SB8.B8_NUMLOTE=SB.B8_YCAVALE\ncQuery   += \"                  ),0) SALDO_CHAPA,\ncQuery   += \"                  ROUND(SB8.B8_SALDO,4,0) SALDO_BUNDLE,\ncQuery   += \"                  * \ncQuery   += \"             FROM SB8010 SB8 \ncQuery   += \"                     WHERE SB8.B8_FILIAL='010101' \ncQuery   += \"                       AND CAST(SB8.B8_NUMLOTE AS INT) BETWEEN 100 AND 999999 \ncQuery   += \"                       AND SB8.B8_SALDO>0 \ncQuery   += \"                       AND SB8.D_E_L_E_T_=''\ncQuery   += \"         )TB\ncQuery   += \"     WHERE SALDO_BUNDLE<>SALDO_CHAPA\n\ncQuery   += \"  UNION ALL \n\ncQuery   += \"  SELECT 'F' TIPO,\ncQuery   += \"  \t   D2_NUMLOTE B8_YCAVALE,\ncQuery   += \"  \t   CHAVE_DOC C6_NUM\ncQuery   += \"    FROM (\ncQuery   += \"  \t\tSELECT *,\ncQuery   += \"  \t\t\t   (SELECT ROUND(SUM(B8_YQTDBD),5,0) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI\ncQuery   += \"  \t\t  FROM (\ncQuery   += \"  \t\t\t\tSELECT  D2_FILIAL+D2_DOC+D2_SERIE CHAVE_DOC,\ncQuery   += \"  \t\t\t\t\t\tCAST(D2_EMISSAO AS DATE) EMISSAO,\ncQuery   += \"  \t\t\t\t\t\tD2_COD,\ncQuery   += \"  \t\t\t\t\t\tD2_NUMLOTE ,\ncQuery   += \"  \t\t\t\t\t\tD2_LOTECTL,\t\t\t\t\t\t\ncQuery   += \"  \t\t\t\t\t\tD2_FILIAL,\ncQuery   += \"  \t\t\t\t\t\tROUND(SUM(D2_QUANT),5,0) QTD_FAT\ncQuery   += \"  \t\t\t\t\tFROM SD2010 \ncQuery   += \"  \t\t\t\t\tWHERE D_E_L_E_T_ = '' \ncQuery   += \"  \t\t\t\t\t  AND D2_COD LIKE 'CH%'\ncQuery   += \"  \t\t\t\t\t  AND D2_QTDEDEV = 0\ncQuery   += \"  \t\t\t\tGROUP BY D2_FILIAL+D2_DOC+D2_SERIE,\ncQuery   += \"  \t\t\t\t\t\t\tD2_NUMLOTE,\ncQuery   += \"  \t\t\t\t\t\t\tD2_LOTECTL,\ncQuery   += \"  \t\t\t\t\t\t\tD2_PEDIDO,\ncQuery   += \"  \t\t\t\t\t\t\tD2_ITEMPV,\ncQuery   += \"  \t\t\t\t\t\t\tD2_FILIAL,\ncQuery   += \"  \t\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE),\ncQuery   += \"  \t\t\t\t\t\t\tD2_COD\ncQuery   += \"  \t\t\t\t)TAB_BASE\ncQuery   += \"  \t\t)TAB_2\ncQuery   += \"  WHERE  ROUND(QTD_FAT,0,0) <> ROUND(QTD_SB8_ORI,0,0)\ncQuery   += \"    AND CHAVE_DOC NOT IN (\ncQuery   += \"  \t\t\t\t\t\t'0101010000064491',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000067471',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000070511',\ncQuery   += \"  \t\t\t\t\t\t'0101010000071041',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000072551',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000077821',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000077821',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000083191',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000085411'  \ncQuery   += \"  \t\t\t\t\t\t)\n\ncQuery   += \"  ORDER BY B8_YCAVALE,C6_NUM\n\n\n/*\nQUERY USADA PARA ACHAR OS VALORES SB8 <> DO FATURADO\n\nSELECT 'F' TIPO,\n\t   D2_NUMLOTE B8_YCAVALE,\n\t   CHAVE_DOC C6_NUM\n\t   , *\n\t   ,'http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+D2_FILIAL+'&NUMPED='+D2_PEDIDO+'&rs:Format=pdf' as LINK\n  FROM (\n\t\tSELECT *,\n\t\t\t   (SELECT RTRIM(LTRIM(B1_DESC))  FROM SB1010 WHERE D_E_L_E_T_ = ''  AND B1_COD = D2_COD) DESCRICAO,\n\t\t\t   (SELECT C6_PRCVEN  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) PRC_VEN,\n\t\t\t   (SELECT C6_QTDVEN  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) QTD_PV_NOR,\n\t\t\t   (SELECT ROUND(C6_QTDVEN,0,0)  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) QTD_PV,\n\t\t\t   (SELECT C6_YCLASSI  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) CLASSIF,\n\t\t\t   (SELECT C6_YCAVALE FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) CAVALETE,\n\t\t\t   (SELECT SUM(B8_YQTDBD) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI_NOR,\n\t\t\t   (SELECT ROUND(SUM(B8_YQTDBD),0,0) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI\n\t\t  FROM (\n\t\t\t\tSELECT  D2_FILIAL+D2_DOC+D2_SERIE CHAVE_DOC,\n\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE) EMISSAO,\n\t\t\t\t\t\tD2_COD,\n\t\t\t\t\t\tD2_NUMLOTE ,\n\t\t\t\t\t\tD2_LOTECTL,\t\t\t\t\t\t\n\t\t\t\t\t\tD2_PEDIDO,\n\t\t\t\t\t\tD2_ITEMPV,\n\t\t\t\t\t\tD2_FILIAL,\n\t\t\t\t\t\tROUND(SUM(D2_QUANT),0,0) QTD_FAT\n\t\t\t\t\tFROM SD2010 \n\t\t\t\t\tWHERE D_E_L_E_T_ = '' \n\t\t\t\t\t -- AND D2_DOC = '000009057' \n\t\t\t\t\t  AND D2_COD LIKE 'CH%'\n\t\t\t\tGROUP BY D2_FILIAL+D2_DOC+D2_SERIE,\n\t\t\t\t\t\t\tD2_NUMLOTE,\n\t\t\t\t\t\t\tD2_LOTECTL,\n\t\t\t\t\t\t\tD2_PEDIDO,\n\t\t\t\t\t\t\tD2_ITEMPV,\n\t\t\t\t\t\t\tD2_FILIAL,\n\t\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE),\n\t\t\t\t\t\t\tD2_COD\n\t\t\t\t)TAB_BASE\n\t\t)TAB_2\nWHERE  ROUND(QTD_FAT,0,0) <> ROUND(QTD_SB8_ORI,0,0)\n  AND CHAVE_DOC NOT IN (\n\t\t\t\t\t\t'0101010000064491',  \n\t\t\t\t\t\t'0101010000067471',  \n\t\t\t\t\t\t'0101010000070511',\n\t\t\t\t\t\t'0101010000071041',  \n\t\t\t\t\t\t'0101010000072551',  \n\t\t\t\t\t\t'0101010000077821',  \n\t\t\t\t\t\t'0101010000077821',  \n\t\t\t\t\t\t'0101010000083191',  \n\t\t\t\t\t\t'0101010000085411'  \n\t\t\t\t\t\t)\nORDER BY EMISSAO, CHAVE_DOC\n\n*/\n\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBERRO\", .F., .T.)\ndbSelectArea(\"TRBERRO\")\ndbgotop()\nDo While !EOF()\n\n\tIF TRBERRO->TIPO == 'P'\n\t\t/*\n\t\tAVISO PARA BRUNO\n\t\t*/\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE  , \"ERRO:\" +AllTrim(TRBERRO->B8_YCAVALE)  )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tAVISO PARA ARLINDO\n\t\t*/\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE  , \"ERRO:\" +AllTrim(TRBERRO->B8_YCAVALE)  )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tEMAIL\n\t\t*/\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",'ERRO URGENTE ! PV:' + TRBERRO->C6_NUM , \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE ,'')\n\tENDIF\n\n\tIF TRBERRO->TIPO == 'E'\n\t\t/*\n\t\tAVISO PARA BRUNO\n\t\t*/\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) CAVALETE -  BUNDLE:\" + AllTrim(TRBERRO->B8_YCAVALE)    )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tAVISO PARA ARLINDO\n\t\t*/\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) CAVALETE - BUNDLE:\" + AllTrim(TRBERRO->B8_YCAVALE)     )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tEMAIL\n\t\t*/\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",\"ERRO URGENTE ! CAVALETE:\" + TRBERRO->B8_YCAVALE ,'')\n\tENDIF\n\n\t\n\tIF TRBERRO->TIPO == 'F'\n\t\t/*\n\t\tAVISO PARA BRUNO\n\t\t*/\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + AllTrim(TRBERRO->C6_NUM)    )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tAVISO PARA ARLINDO\n\t\t*/\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + AllTrim(TRBERRO->C6_NUM)     )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tEMAIL\n\t\t*/\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",\"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + TRBERRO->C6_NUM ,'')\n\tENDIF\n\n\tdbSelectArea(\"TRBERRO\")\n\tdbSkip()\nEndDo\n\ndbSelectArea(\"TRBERRO\") \ndbCloseArea()\n\n/*\nCaso exista alguma aprovação ou reprovação \no sistema envia o protocolo por e-mail\n*/\nIF lEnvProt\n\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0060&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0060.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t  \n\t//ConOut(\"Gerando protocolo...\" )\n\t//Sleep(3000)\n\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"diego.sirtori@grupoqualita.com.br\",'Relaório de Protocolo','Anexo relatório de protocolos!','D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0060.PDF')\nEndIf\n\nIf lAutoZAP\n\tRpcClearEnv()\n\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" FIM do JOB liberação de Retornos pelo WHATSAPP.\")\nElse\n\t// Caso não seja job, informa na a atualização\n\tAlert(\"Fim da liberação de Retorno pelo WHATSAPP. (Chamada Manual)\")\nEndif\n\nReturn\n"}}}
Content-Length: 356
{"jsonrpc":"2.0","method":"textDocument/didOpen","params":{"textDocument":{"uri":"git:/d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw?%7B%22path%22%3A%22d%3A%5C%5CTOTVS%2012%5C%5CMicrosiga%5C%5CProtheus%5C%5CProjetoVSCode%5C%5C02_COMPRAS%5C%5CMT103VCC.prw%22%2C%22ref%22%3A%22~%22%7D","languageId":"advpl","version":1,"text":""}}}
Content-Length: 314
{"jsonrpc":"2.0","method":"textDocument/didClose","params":{"textDocument":{"uri":"git:/d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw?%7B%22path%22%3A%22d%3A%5C%5CTOTVS%2012%5C%5CMicrosiga%5C%5CProtheus%5C%5CProjetoVSCode%5C%5C02_COMPRAS%5C%5CMT103VCC.prw%22%2C%22ref%22%3A%22~%22%7D"}}}
Content-Length: 961
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":451},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que solucionou o problema.\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n\r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 1091
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":452},"contentChanges":[{"text":"#INCLUDE \"Protheus.ch\"\r\n#INCLUDE \"RwMake.ch\"\r\n#INCLUDE \"topconn.ch\" \r\n#INCLUDE \"Colors.ch\" \r\n#INCLUDE \"JPEG.CH\"\r\n\r\n/*\r\nPrograma        : Programa MT103VCC.prw\r\nObjetivo        : P.Entrada compilado para remover msg de aviso e eventual erro na entrada da NF-e pelo conexção nfe\r\nAutor           : Bruno Lage Ferreira\t\r\nData/Hora       : 03/02/2022 17:30\r\nObs.            :\r\nFoi feito uma reunião com o com Felipe do conexaonfe e raquel da Qualita para exemplificar o erro\r\nFelipe testou o comportamento do ponto de entrada retornando .F. nas msg. que solucionou o problema.\r\n\r\n*/\r\n\r\nUser Function MT103VCC()\r\n/*****************************************************************************************\r\n* Programa principal \r\n*\r\n***/  \r\n\r\n//AVISO(\"MT103VCC\",\"MT103VCC\",{\"OK\"},2)\r\n\r\nReturn({.F.,.F.,.F.,.F.})\r\n"}]}}
Content-Length: 1239
{"jsonrpc":"2.0","id":49,"method":"$totvsserver/compilation","params":{"compilationInfo":{"connectionToken":"djM6djF5aTBwNzQ4bm1ranViaXNrbGl4aW93NXFneDQ6MToxOTIuMTY4LjEuMTAxOjEyMzY6MDo3LjAwLjE5MTIwNVA6Mw==:djE6Y29tcGlsYV9xOkFkbWluOnNLdUEwZS94ODgwNWxRMUpiaFNJbzllMDhZTXBwS2JqSnlIOXpOZkFYQ1k9|djI6MTY0MzkxOTQ5ODowOjE6MQ==.BvWu12u7PwyYySMnBPiFz4FGLRqZKu0HNmG7ryZDWFONkV0a4sI1IVt/lU7/oUJmr6Uko45aVn0W4cpgjSXaZIBVtKeb8uUmf/o/AVAyAKDMQNYZjAOQsHImTE4htuRQSccB0mwnvYmi2i4JF6rSiiClX7cwVbml9hhEHjvHnQ0lISb17nkZwYFO39/BO62w6BsqPL3dhV8HNgxo8EaHS52J6tOjRaPx4ZGFlMLkjOHxChrnXyN93+LO0LJkuTeMPdMadVyITSOVdj+R1iKGiHYmH6pRk3bVBTCQk/99qj9jTNa4pcSaWxjyHogbAB1M/u7sURUgn882zwVHDQqIyw==","environment":"compila_q","includeUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/include"],"fileUris":["file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw"],"compileOptions":{"recompile":true,"debugAphInfo":true,"gradualSending":true,"generatePpoFile":false,"showPreCompiler":false,"priorVelocity":true,"returnPpo":false,"commitWithErrorOrWarning":false},"extensionsAllowed":[".PRW",".PRX",".PRG",".PPX",".PPP",".TLPP",".APW",".APH",".APL",".AHU",".TRES",".PNG",".BMP",".RES",".4GL",".PER",".JS",".RPTDESIGN"],"includeUrisRequired":true}}}
Content-Length: 180
{"jsonrpc":"2.0","method":"textDocument/didSave","params":{"textDocument":{"uri":"file:///d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/02_COMPRAS/MT103VCC.prw","version":452}}}
Content-Length: 51460
{"jsonrpc":"2.0","method":"textDocument/didChange","params":{"textDocument":{"uri":"git:/d%3A/TOTVS%2012/Microsiga/Protheus/ProjetoVSCode/10_LIB/LIBWHATSAPP.PRW?%7B%22path%22%3A%22d%3A%5C%5CTOTVS%2012%5C%5CMicrosiga%5C%5CProtheus%5C%5CProjetoVSCode%5C%5C10_LIB%5C%5CLIBWHATSAPP.PRW%22%2C%22ref%22%3A%22~%22%7D","version":2},"contentChanges":[{"text":"#include \"protheus.ch\"\n#include \"rwmake.ch\"\n#include \"tbiconn.ch\"  \n#INCLUDE \"TOTVS.CH\"\n#INCLUDE \"topconn.ch\"\n\n/*\nPrograma ...: LIBWHATSAPP.Prw\nUso ........: Programa verifica a provação do pedido automaticamente pelo WhatsApp\nData .......: 23/03/2020\nFeito por ..: Bruno Lage Ferreira\nCopyright @1998-2001,2021\n\nQ-Liberação Faturamento\n5527995295180-1587589430@g.us\nlogistica.es@qualitagroup.com;comercial.es@grupoqualita.com.br\n\nQ-N2 - Liberação Compras\n5527995295180-1594316108@g.us\npedido.compra@grupoqualita.com.br\n\nQ-N1 - Liberação Compras\n5527995295180-1587589523@g.us\npedido.compra@grupoqualita.com.br\n*/ \n\nUser Function LIBWHATSAPP()  \n************************************************************************************************************\n*\n*\n*\n***\nLocal cQuery   := \"\"\nLocal lAutoZAP := .F.\n\nLocal aLogAuto := {}\n\nLocal oJson\nLocal cErr     := \"\"\n/*\nLocal lMsg     := \"\"\n*/\nLocal cMessage := \"\"\nLocal lEnvProt := .F.\nLocal nAux\n\nConOut( \">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>   WHATSAPP APROVAÇÃO   <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<\" )\n\nIf Select(\"SX2\")==0  \n\tPREPARE ENVIRONMENT EMPRESA \"01\" FILIAL \"01\" TABLES \"WAM\",\"SC5\"\n\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" Iniciando JOB de liberação de Retorno pelo WHATSAPP.\")\n\tlAutoZAP := .T.\nEndIf\n\n\n/*\n******************************************************************************************\nchamada do Modulo AutoStart\nTODOS OS COMANDOS VIA PROCEDUTE\n*/\nConOut(\"*********************************************************************************\")\nConOut(\"*********************************************************************************\")\nConOut(\"*********************         INICIANDO AUTOSTART          **********************\")\nConOut(\"*********************************************************************************\")\nConOut(\"*********************************************************************************\")\n\nTCSPEXEC(\"WHATSAPP_AUTOSTART\")\n   \n/*\n*\n******************************************************************************************\n*/\ncQuery :=  \" SELECT  \ncQuery +=  \" \t\tWAM_FILIAL,\ncQuery +=  \" \t\tWAM_DATA,\ncQuery +=  \" \t\tWAM_HORA,\ncQuery +=  \" \t\tWAM_ID,\ncQuery +=  \" \t\tRTRIM(LTRIM(ISNULL(CONVERT(VARCHAR(2047), CONVERT(VARBINARY(2047), WAM_MSG)),''))) WAM_MSG,\ncQuery +=  \" \t\tWAM_TELL,\ncQuery +=  \" \t\tWAM_INDEX,\ncQuery +=  \" \t\tWAM_PERG,\ncQuery +=  \" \t\tWAM_DATAR,\ncQuery +=  \" \t\tWAM_HORAR,\ncQuery +=  \" \t\tWAM_RESPOS,\ncQuery +=  \" \t\tWAM_EXEC,\ncQuery +=  \" \t\tWAM_NIVEL\ncQuery +=  \" \t\tFROM WAM010 WHERE D_E_L_E_T_ = '' AND CAST(WAM_DATA AS DATE) > CAST(GETDATE()-4 AS DATE) AND WAM_PERG = 'S' AND WAM_EXEC LIKE '%QUALITA%'\n\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBRA\", .F., .T.)\ndbSelectArea(\"TRBRA\")\ndbgotop()\nDo While !EOF()\n\n\tIf !Empty(TRBRA->WAM_ID)\t\n\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\"Protocolo: [\"+ AllTrim(TRBRA->WAM_ID) + \"] INDEX:\" + TRBRA->WAM_INDEX )\n\t\t\n\t\t// Cria o objeto JSON e popula ele a partir da string\n\t\t\n\t\toJson := JSonObject():New()\n\t\tcErr  := oJSon:fromJson(U_SWREMGWAP(AllTrim(TRBRA->WAM_ID)))\n\t\t\n\t\tsleep(400)\n\t\t\n\t\tConOut(oJson:GetJSonObject('quote_message'))\n\t\t\n\t\tIf !Empty(cErr)\n\t\t  \tConout(cErr + \"Protocolo:\" + AllTrim(TRBRA->WAM_ID))\n\t\t  \t\n\t\t  \t// Descarta o objeto \n\t\t  \tFreeObj(oJson)\n\t\t  \n\t\t  \tdbSelectArea(\"TRBRA\")\n\t\t  \tdbSkip()\n\t\tEndif\n\t\t\n\t\t// Agora vamos ler as propriedades com GetJSonObject()\n\t\t aRetMsg :=\tstrTokArr(U_SWREMGWAP(TRBRA->WAM_ID), ',' )\n\tEndIf\n\t\n\t\n\t/*\n\t**********************************************************************************************************************\n\tTratamento das liberação \n\t - Mapa de Cotação\n\t - Pedido de Compra\n\t - Pedido de Vendas\n\t**********************************************************************************************************************\n\t*/\n\tIF AllTrim(TRBRA->WAM_EXEC) == \"QUALITA-MC\"\n\t\t\n\t\t/*\n\t\t***************************************************\n\t\tNIVEL 1\n\t\t***************************************************\n\t\t*/\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"1\"\n\t\t\t\n\t\t\t/*\n\t\t\tProcessamento dos retorno Mapa de cotação-MC\n\t\t\t*/\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\t\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\t\n\t\t\t\t//ENVIO DO PROTOCOLO \n\t\t\t\tlEnvProt := .T.\n\t\t\t\t\n\t\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \n\t\t\t\t\tdbSelectArea(\"SC8\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0025_V&cCotacao=' + SC8->C8_NUM +'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tConOut(\"Gerando relatório! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\tcProt := U_SWENARWAP(\"5527995295180-1594316108@g.us\", \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"                                                                     ,\"MC\"+ SC8->C8_NUM             ,\"MC-\" + SC7->C7_NUM  ,\"PDF\",\"\\RELINWEB\\MC-\"+ SC8->C8_NUM +\".PDF\")\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t30 segundos\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\t\n\t\t\t\t\t\tIF cProt = \"\" .or. cProt = nil \n\t\t\t\t\t\t\tConOut(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde! MC-\"+ SC8->C8_NUM +\".PDF\")\n\t\t\t\t\t\t\tReturn()\n\t\t\t\t\t\tEndIf\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tIf  RecLock(\"WAM\",.T.) \n\t\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \n\t\t\t\t\t\t\tReplace WAM_DATA    With Date()\n\t\t\t\t\t\t\tReplace WAM_HORA    With Time()\n\t\t\t\t\t\t\tReplace WAM_ID      With cProt\n\t\t\t\t\t\t\tReplace WAM_MSG     With \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"\n\t\t\t\t\t\t\tReplace WAM_INDEX   With SC8->C8_FILIAL + SC8->C8_NUM\n\t\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\n\t\t\t\t\t\t\tReplace WAM_NIVEL   With \"2\"\n\t\t\t\t\t\t\tIF SubString(CNUMEMP,1,2) == \"05\"\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'ITINGA-MC'\n\t\t\t\t\t\t\tElse\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'QUALITA-MC'\n\t\t\t\t\t\t\tEndIf\n\t\t\t\t\t\t   MsUnLock()\n\t\t\t\t\t\tEndIf\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como já lido. \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\tElse\n\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como já lido\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tColoca a MSg mais não mostra data nem hora de liberação\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \n\t\t\t\t\t\tcQuery += \"    SET C8_MSGLIB='\"+ \"NÃO LIBERADO: \" + Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"   FROM \" + RetSqlName(\"SC8\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'COTAÇÃO NÃO LIBERADA!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado (Mapa de Cotação NÃO liberado):\" + TRBRA->WAM_INDEX )\t\n\t\t\t\t\t\n\t\t\t\tEndIf\n\t\t\t\t\n\t\t\tEndIf\n\t\t\n\t\tEndIf\n\t\t\n\t\t/*\n\t\t***************************************************\n\t\tNIVEL 2\n\t\t***************************************************\n\t\t*/\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"2\"\n\t\t\t\n\t\t\t/*\n\t\t\tProcessamento dos retorno Mapa de cotação-MC\n\t\t\t*/\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\t\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\t\n\t\t\t\t//ENVIO DO PROTOCOLO \n\t\t\t\tlEnvProt := .T.\n\t\t\t\t\n\t\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \n\t\t\t\t\tdbSelectArea(\"SC8\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGravando aprovação na SC8\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \n\t\t\t\t\t\tcQuery += \"    SET C8_DATALIB='\"+ DToS(dDataBase) +\"',C8_HORALIB='\"+ LEFT(AllTrim(TIME()),5) +\"',C8_MSGLIB='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC8\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\n\t\t\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0025_V&cCotacao=' + SC8->C8_NUM +'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\tConOut(\"Gerando relatório! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Mapa de Cotação:\" + AllTrim(SC8->C8_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação Liberado!     Código:' + SC8->C8_NUM       ,'COTAÇÃO LIBERADA! Código:'              + SC8->C8_NUM + ', liberado!'+ \"<br>\" +'CÓDIGO:' + SC8->C8_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\MC-'+ SC8->C8_NUM +'.PDF')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda:\" + AllTrim(SC8->C8_NUM) )\t\n\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\tElse\n\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tColoca a MSg mais não mostra data nem hora de liberação\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC8\")  \n\t\t\t\t\t\tcQuery += \"    SET C8_MSGLIB='\"+ \"NÃO LIBERADO: \" + Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"   FROM \" + RetSqlName(\"SC8\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C8_NUM = '\"+SC8->C8_NUM+\"'\n\t\t\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"pedido.compra@grupoqualita.com.br\",'Mapa de Cotação NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'COTAÇÃO NÃO LIBERADA!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado (Mapa de Cotação NÃO liberado):\" + TRBRA->WAM_INDEX )\t\n\t\t\t\t\t\n\t\t\t\tEndIf\n\t\t\t\t\n\t\t\tEndIf\n\t\t\n\t\tEndIf\n\n\tElseIf AllTrim(TRBRA->WAM_EXEC) == \"QUALITA-PC\"\n\t\n\t\t/*\n\t\t***************************************************\n\t\tNIVEL 1\n\t\t***************************************************\n\t\t*/\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"1\"\n\t\n\t\t\t/*\n\t\t\tProcessamento dos retorno Pedido de Compra-PC\n\t\t\t*/\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\t\n\t\t\t\t//ENVIO DO PROTOCOLO \n\t\t\t\tlEnvProt := .T.\n\t\t\t\t\n\t\t\t\tIf \"APROVADO\" $ Upper(cMessage) \n\t\t\t\t\tdbSelectArea(\"SC7\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGera dados do pedido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tu_ImpPc(2)\n\t\t\t\t\t\tWaitRunSrv('\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\tcProt := U_SWENARWAP(\"5527995295180-1594316108@g.us\", \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\"                                                                     ,\"PC-2-\" + SC7->C7_NUM         ,\"PC-2-\" + SC7->C7_NUM   ,\"PDF\",\"\\RELINWEB\\PC-\" + SC7->C7_NUM + \".PDF\")\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\t30 segundos\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\t        \t\t\t\t\t\t                  \n\t\t\t\t\t\tIF cProt = \"\" .or. cProt = nil \n\t\t\t\t\t\t\tConOut(\"ERRO!!! O WhatsApp pode estar passando por alguma instabilidade no momento. Aguarde alguns instantes de tente novamente mais tarde! PC-\"+SC7->C7_NUM+\".PDF\")\n\t\t\t\t\t\t\tReturn()\n\t\t\t\t\t\tEndIf                 \n\t\t\t\t\t\t                      \n\t\t\t\t\t\tIf  RecLock(\"WAM\",.T.) \n\t\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \n\t\t\t\t\t\t\tReplace WAM_DATA    With Date()\n\t\t\t\t\t\t\tReplace WAM_HORA    With Time()\n\t\t\t\t\t\t\tReplace WAM_ID      With cProt\n\t\t\t\t\t\t\tReplace WAM_MSG     With \"APROVADO NO NIVEL 1.  MSG(\" + AllTrim(TRBRA->WAM_MSG) + \")\" \n\t\t\t\t\t\t\tReplace WAM_INDEX   With SC7->C7_FILIAL + SC7->C7_NUM\n\t\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\n\t\t\t\t\t\t\tReplace WAM_NIVEL   With \"2\"\n\t\t\t\t\t\t\tIF SubString(CNUMEMP,1,2) == \"05\"\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'ITINGA-PC'\n\t\t\t\t\t\t\tElse\n\t\t\t\t\t\t\t\tReplace WAM_EXEC    With 'QUALITA-PC'\n\t\t\t\t\t\t\tEndIf\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t   MsUnLock()\n\t\t\t\t\t\tEndIf\n\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '1'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\tElse\n\t\t\t\t\tdbSelectArea(\"SC7\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGravando aprovação na SC7\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \n\t\t\t\t\t\tcQuery += \"    SET C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGera dados do pedido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\t//u_ImpPc(2)\n\t\t\t\t\t\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\t//ConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"almoxarifado@grupoqualita.com.br;emelly.couto@grupoqualita.com.br;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + SC7->C7_NUM + ', não liberado!'+ \"<br>\" +'CÓDIGO:' + SC7->C7_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RXX0022.PDF')\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Não Liberado! Código:' + SC7->C7_NUM , 'Pedido Não Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\t\n\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\n\t\t\t\tEndIf\t\n\t\t\t\n\t\t\tEndIf\n\t\t\t\n\t\tEndIf\n\t\n\t\n\t\t/*\n\t\t***************************************************\n\t\tNIVEL 2\n\t\t***************************************************\n\t\t*/\n\t\tIf AllTrim(TRBRA->WAM_NIVEL) == \"2\"\n\t\n\t\t\t/*\n\t\t\tProcessamento dos retorno Pedido de Compra-PC\n\t\t\t*/\n\t\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\t\n\t\t\t\t//ENVIO DO PROTOCOLO \n\t\t\t\tlEnvProt := .T.\n\t\t\t\t\n\t\t\t\tIf \"APROVADO\" $ Upper(cMessage) \n\t\t\t\t\tdbSelectArea(\"SC7\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\tcQuery += \"    AND WAM_NIVEL = '2'\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGravando aprovação na SC7\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \n\t\t\t\t\t\tcQuery += \"    SET C7_DATALIB='\"+ DToS(dDataBase) +\"',C7_HORALIB='\"+ LEFT(AllTrim(TIME()),5) +\"',C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\n\t\t\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGera dados do pedido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tu_ImpPc(2)\n\t\t\t\t\t\tWaitRunSrv('\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\tConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Liberado! Código:' + SC7->C7_NUM , 'Pedido Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF')\n\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\tElse\n\t\t\t\t\tdbSelectArea(\"SC7\")\n\t\t\t\t\tdbSetOrder(1)\n\t\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tMarcando o protocolo como ja lido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\t\n\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGravando aprovação na SC7\n\t\t\t\t\t\t*/\n\t\t\t\t\t\tcQuery := \" UPDATE \" + RetSqlName(\"SC7\")  \n\t\t\t\t\t\tcQuery += \"    SET C7_MSGLIB='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\t\tcQuery += \"  FROM \" + RetSqlName(\"SC7\")\n\t\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\t\tcQuery += \"    AND C7_NUM = '\"+SC7->C7_NUM+\"'\n\t\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\t\n\t\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\t\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tGera dados do pedido \n\t\t\t\t\t\t*/\n\t\t\t\t\t\t//u_ImpPc(2)\n\t\t\t\t\t\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRXX0022&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\PC-'+SC7->C7_NUM+'.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\t\t\n\t\t\t\t\t\t//ConOut(\"Gerando relatório! Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\tsleep(300)\n\t\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Compras:\" + AllTrim(SC7->C7_NUM) )\n\t\t\t\t\t\t\n\t\t\t\t\t\t\n\t\t\t\t\t\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"almoxarifado@grupoqualita.com.br;emelly.couto@grupoqualita.com.br;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + SC7->C7_NUM + ', não liberado!'+ \"<br>\" +'CÓDIGO:' + SC7->C7_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RXX0022.PDF')\n\t\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA','pedido.compra@grupoqualita.com.br', 'Pedido Não Liberado! Código:' + SC7->C7_NUM , 'Pedido Não Liberado' + '<br>' +'CÓDIGO:' + SC7->C7_NUM +  \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage)     ,'')\n\t\t\t\t\t\t\n\t\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado Pedido de Compras:\" + AllTrim(SC7->C7_NUM) )\t\n\t\t\t\t\t\n\t\t\t\t\tEndIf\n\t\t\t\n\t\t\t\tEndIf\t\n\t\t\t\n\t\t\tEndIf\n\t\t\t\n\t\tEndIf\n\t\n\t\n\tElse\n\t\t/*\n\t\tProcessamento dos retornos Pedido de Venda PV \n\t\t*/\n\t\tIf oJson:GetJSonObject('quoted') == \"true\"\n\t\t\n\t\t\tcMessage := oJson:GetJSonObject('quote_message')\n\t\t\t\n\t\t\t//ENVIO DO PROTOCOLO \n\t\t\tlEnvProt := .T.\n\t\t\t\n\t\t\tIf  \"APROVADO\" $ Upper(cMessage) \n\t\t\t\tdbSelectArea(\"SC5\")\n\t\t\t\tdbSetOrder(1)\n\t\t\t\tIf dbSeek(AllTrim(TRBRA->WAM_INDEX))\n\t\t\t\t\t\n\t\t\t\t\tRecLock(\"SC5\",.F.)\n\t\t\t\t\t\tSC5->C5_BLQ  := ''\n\t\t\t\t\tMsUnlock()\t\n\t\t\t\t\t\n\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\n\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\n\t\t\t\t\tIf SC5->C5_YTIPO == \"ME\"\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\tElse\n\t\t\t\t\t\tWaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003_P&FILIAL='+AllTrim(SC5->C5_FILIAL)+'&NUMPED='+AllTrim(SC5->C5_NUM)+'&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t\t\t\t\tEndIf\n\t\t\t\t\t\n\t\t\t\t\tConOut(\"Gerando relatório! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\n\t\t\t\t\tsleep(300)\n\t\t\t\t\tConOut(\"Gerando e-mail! Ped. Venda:\" + AllTrim(SC5->C5_NUM) )\n\t\t\t\t\t\n\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"logistica.es@qualitagroup.com;bruno.lage@grupoqualita.com.br\",'Pedido Liberado! Código:' + SC5->C5_NUM ,'PEDIDO LIBERADO!'+ \"<br>\" +'CÓDIGO:' + SC5->C5_NUM + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0003a.PDF')\n\t\t\t\t\t\n\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda:\" + TRBRA->WAM_INDEX )\t\n\t\t\t\tEndIf\n\t\t\tElse\n\t\t\t\t\tcQuery := \" UPDATE WAM010 \n\t\t\t\t\tcQuery += \"    SET WAM_PERG = 'N',WAM_DATAR='\"+ DToS(dDataBase) +\"', WAM_HORAR='\"+ LEFT(AllTrim(TIME()),5) +\"', WAM_RESPOS='\"+ Upper(cMessage) +\"'\"\n\t\t\t\t\tcQuery += \"  FROM WAM010 \n\t\t\t\t\tcQuery += \"  WHERE D_E_L_E_T_ <> '*'\n\t\t\t\t\tcQuery += \"    AND WAM_ID = '\"+TRBRA->WAM_ID+\"'\n\t\t\t\t\t//cQuery += \"    AND WAM_TELL = ''\n\t\t\t\n\t\t\t\t\tTcSQLExec(cQuery)\n\t\t\t\t\t\n\t\t\t\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"logistica.es@qualitagroup.com;bruno.lage@grupoqualita.com.br\",'Pedido NÃO Liberado! Código:' + TRBRA->WAM_INDEX , 'PEDIDO NÃO LIBERADO!'+ \"<br>\" + 'CÓDIGO:' + TRBRA->WAM_INDEX + \"<br>\" + \"MENSAGEM WHATSAPP:\"+ Upper(cMessage),'')\n\t\t\t\t\t\n\t\t\t\t\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" E-mail enviado P.Venda (NÃO liberado):\" + TRBRA->WAM_INDEX )\t\n\t\t\tEndIf\n\t\tEndIf\n\tEndIf\n\t\n\t// Descarta o objeto \n\tFreeObj(oJson)\n\n\tdbSelectArea(\"TRBRA\")\n\tdbSkip()\nEndDo\n\ndbSelectArea(\"TRBRA\") \ndbCloseArea()\n\n\n/*\n******************************************************************************************\nchamada do Modulo AutoStart\nTODOS OS COMANDOS VIA PROCEDUTE\n*/\nConOut(\"*********************************************************************************\")\nConOut(\"*********************************************************************************\")\nConOut(\"*********************         INICIANDO AUTOSTART          **********************\")\nConOut(\"*********************************************************************************\")\nConOut(\"*********************************************************************************\")\n\nTCSPEXEC(\"WHATSAPP_AUTOSTART\")\n   \n\n/*\n******************************************************************************************\nResposta do Modulo MNT\nABERTURA E DISTRIBUIÇÃO\n*/\ncQuery   := \" SELECT  ISNULL((SELECT USR_ID     FROM DADOSADV_Q..SYS_USR WHERE USR_MSBLQL <> 1 AND USR_CARGO = WAM_TELL),'') ID_USUARIO,\ncQuery   += \" \t  \t  ISNULL((SELECT USR_CODIGO FROM DADOSADV_Q..SYS_USR WHERE USR_MSBLQL <> 1 AND USR_CARGO = WAM_TELL),'') USUARIO,\ncQuery   += \" \t  \t  R_E_C_N_O_ RECNO,\ncQuery   += \" \t\t  UPPER(RTRIM(LTRIM(SUBSTRING(RETORNO,IIF(CHARINDEX(',',UPPER(RETORNO))=0,0,CHARINDEX(',',UPPER(RETORNO))+1),LEN(RETORNO)  ))) ) \t  MSG,*\ncQuery   += \"   FROM DADOSADV_Q..WAM010\ncQuery   += \"\tCROSS APPLY\ncQuery   += \"\t(\ncQuery   += \"\tSELECT RETORNO = dbo.FnWhatRetMSG(WAM_ID)\ncQuery   += \"\t) x\ncQuery   += \"  WHERE D_E_L_E_T_ = ''\ncQuery   += \"    AND WAM_EXEC = 'MNT'\ncQuery   += \"    AND WAM_PERG = 'N'\ncQuery   += \"    AND WAM_NIVEL = 0\n//cQuery   += \"  --AND dbo.FnWhatRetMSG(WAM_ID) <> ''\n\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBMNT\", .F., .T.)\ndbSelectArea(\"TRBMNT\")\ndbgotop()\nDo While !EOF()\n\n\t\t\t\n\t\t\tPrivate\taSolic          :={}\t\n\t\t\tPrivate lMSHelpAuto     := .T. // Nao apresenta erro em tela\n\t\t\tPrivate lMSErroAuto     := .F. //   Caso a variavel torne-se .T. apos MsExecAuto, apresenta erro em tela\n\t\t\tPrivate lAutoErrNoFile\t:= .T.\n\t\t\tPrivate cErroTemp       := \"\"\n\t\t\tPrivate cArquivo        := \"\"\n\t\t\tPrivate cProt           := \"\"\n\t\n\t\t\taSolic := {\t{\"TQB_CODBEM\" , TRBMNT->WAM_RESPOS    \t,Nil},;             \t// Codigo do Bem a  ser  relacionado na Solicitacao de Servico\n\t\t\t\t\t\t{\"TQB_DTABER\" , dDataBase     \t\t\t,Nil},; \t\t\n\t\t\t\t\t\t{\"TQB_HOABER\" , LEFT(TIME(), 5 )        ,Nil},; \t\n\t\t\t\t\t\t{\"TQB_USUARI\" , TRBMNT->USUARIO   \t\t,Nil},; \t\t\n\t\t\t\t\t\t{\"TQB_CDSOLI\" , TRBMNT->ID_USUARIO\t\t,Nil},; \t\t\n\t\t\t\t\t\t{\"TQB_DESCSS\" , TRBMNT->MSG \t\t\t,Nil}} \t\t\t\t\t//  Descricao da  Solicitacao\n\n\t\t\tMSExecAuto( {|x,z,y,w| MNTA280(x,z,y,w)}, , , aSolic )\t\t\n\n\t\t\tIf lMsErroAuto\n\t\t\t\t//U_SWENV(\"5533984022125\" , Mostraerro()  , \"ERRO MNT\" )\n\t\t\t\tConOut(\"************* ERRO MNT INICIO *************\")\n\t\t\t\t//U_SWENV(TRBMNT->WAM_TELL, \"Erro no cadastro da S. Serviço!\"  , \"ERRO MNT\" )\n\n\t\t\t\t//Pegando log do ExecAuto\n\t\t\t\taLogAuto := GetAutoGRLog()\n\n\t\t\t\t/*\n\t\t\t\t//Percorrendo o Log e incrementando o texto (para usar o CRLF você deve usar a include \"Protheus.ch\")\n\t\t\t\t//nAux \t\t:= 0\n\t\t\t\t//aLogAuto    :={}\n\t\t\t\t*/\t\n\t\t\t\tFor nAux := 1 To Len(aLogAuto) \n\t\t\t\t\tcErroTemp += aLogAuto[nAux] + CHR(13)+CHR(10)\n\t\t\t\tNext nAux\n\n\t\t\t\tIf cErroTemp == \"\"\n\t\t\t\t\tcErroTemp := \"Sem informações de erro.\"\n\t\t\t\tEndIf\n\n\t\t\t\tcArquivo := \"\\_LOGWHATSMNT\\\" + \"MNT_ERRO\" + dToS(dDataBase) +'_'+ Replace(time(),':','_') + \".txt\"\n\t\t\t\t\n\t\t\t\tConOut(cArquivo)\n\t\t\t\tConOut(cErroTemp)\n\n\t\t\t\tSleep(3000)\n\n\t\t\t\t//Criando o arquivo txt\n\t\t\t\tMemoWrite(cArquivo, cErroTemp )\n\n\t\t\t\t//cErroTemp := Mostraerro(\"\\_LOGWHATSMNT\\\", cArquivo)\n\t\t\t\t\n\t\t\t\tConOut(cErroTemp)\n\t\t\t\tSleep(3000)\n\n\t\t\t\tU_SWENARWAP(AllTrim(TRBMNT->WAM_TELL),\"Erro no cadastro da S. Serviço!\",\"Erro no cadastro da S. Serviço!\",\"MNT_ERRO\",\"TXT\",cArquivo)\n\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\n\t\t\t\tcQuery   += \"    SET WAM_NIVEL = 3\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010  \n\t\t\t\tcQuery   += \"  WHERE D_E_L_E_T_ = ''\n\t\t\t\tcQuery   += \"    AND WAM_EXEC = 'MNT'\n\t\t\t\tcQuery   += \"    AND WAM_PERG = 'N'\n\t\t\t\tcQuery   += \"    AND WAM_NIVEL = 0\n\n\t\t\t\tTcSQLExec(cQuery)   \n\n\t\t\t\tConOut(\"************* ERRO MNT FIM*************\")\n\t\t\tElse\n\t\t\t\n\t\t\t\tdbSelectArea(\"TQB\")\n\t\t\t\tcCodigoSS := TQB->TQB_SOLICI\n\t\t\t\tConOut(\"************* CONFIRMAÇÃO DA SS MNT INICIO *************\")\n\t\t\t\tConOut(\"****Codigo..:\"+cCodigoSS)\n\t\t\t\tConOut(\"********************************************************\")\n\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"Solicitação cadastrada com sucesso! Código:\" +cCodigoSS, \"SOLICITAÇÃO DE SERVIÇO\" )\n\n\t\t\t\tSleep(3000)\n\n\t\t\t\t/*\n\t\t\t\tDistriburir \n\t\t\t\tResponsável pela Manutenção\n\t\t\t\t*/\n\t\t\t\tdbSelectArea(\"ST9\")\n\t\t\t\tdbSetOrder(1)\n\t\t\t\tdbSeek(xFilial(\"ST9\") + TRBMNT->WAM_RESPOS)\n\n\t\t\t\tcErroTemp := \"NOVA SOLICITAÇÃO DE SERVIÇO PARA DISTRIBUIÇÃO\" + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"CÓDIGO........:\" + cCodigoSS                   + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"DATA..........:\" + dToC(dDataBase)             + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"HORA..........:\" + Replace(time(),':',':')     + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"EQUIPAMENTO ID:\" + TRBMNT->WAM_RESPOS          + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"EQUIPAMENTO...:\" + AllTrim(ST9->T9_NOME)       + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"PROBLEMA......:\" + AllTrim(TRBMNT->MSG)        + CHR(13)+CHR(10)\n\t\t\t\tcErroTemp += \"COMO APROVAR..:\" + \"CIV/MEC/ELE/ , 1/2/3, COMPLEMENTO DA DESCRIÇÃO DO PROBLEMA\" \n\n\t\t\t\tcArquivo := \"\\_LOGWHATSMNT\\\" + \"MNT_DIST\" + cCodigoSS + dToS(dDataBase) +'_'+ Replace(time(),':','_') + \".txt\"\n\t\t\t\tMemoWrite(cArquivo, cErroTemp )\n\n\t\t\t\t/*\n\t\t\t\tTelefone fixo com a pessoa que vai distibuir \n\t\t\t\t*/ \n\t\t\t\tcNumDist := \"27997857938\"\n\t\t\t\t                \n\n\t\t\t\tcProt := U_SWENARWAP(AllTrim(cNumDist),\"Distribuir:\" + cCodigoSS,\"SS_\"+cCodigoSS,\"SS_\"+cCodigoSS,\"TXT\",cArquivo)\n\n\t\t\t\tIf  RecLock(\"WAM\",.T.) \n\t\t\t\t\t\tReplace WAM_FILIAL  With \"\" \n\t\t\t\t\t\tReplace WAM_DATA    With Date()\n\t\t\t\t\t\tReplace WAM_HORA    With Time()\n\t\t\t\t\t\tReplace WAM_ID      With cProt\n\t\t\t\t\t\tReplace WAM_MSG     With cErroTemp\n\t\t\t\t\t\tReplace WAM_INDEX   With cCodigoSS\n\t\t\t\t\t\tReplace WAM_TELL    With cNumDist\n\t\t\t\t\t\tReplace WAM_PERG    With \"S\"\n\t\t\t\t\t\tReplace WAM_NIVEL   With \"0\"\n\t\t\t\t\t\tReplace WAM_EXEC    With 'MNT-DIST'\n\t\t\t\t\tMsUnLock()\n\t\t\t\tEndIf\n\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\n\t\t\t\tcQuery   += \"    SET WAM_NIVEL = 1 , WAM_HORAR  = Left(Cast(GETDATE() as Time ),5), WAM_DATAR  = Replace(Cast(GETDATE() as date ),'-',''),WAM_INDEX = '\"+AllTrim(cCodigoSS)+\"'\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010  \n\t\t\t\tcQuery   += \"  WHERE D_E_L_E_T_ = ''\n\t\t\t\tcQuery   += \"    AND WAM_EXEC = 'MNT'\n\t\t\t\tcQuery   += \"    AND WAM_PERG = 'N'\n\t\t\t\tcQuery   += \"    AND WAM_NIVEL = 0\n\n\t\t\t\tTcSQLExec(cQuery)   \n\n\n\t\t\t\tConOut(\"************* CONFIRMAÇÃO DA SS MNT FIM *************\")\n\t\t\t\tConOut(\"****Codigo..:\"+cCodigoSS)\n\t\t\t\tConOut(\"********************************************************\")\n\t\t\tEndif\t\n\n\tdbSelectArea(\"TRBMNT\")\n\tdbSkip()\nEndDo\n\n\n\ndbSelectArea(\"TRBMNT\") \ndbCloseArea()\n\n/**\n*********************************************************************************\nRetorno da DISTRIBUIÇÃO\nMNT\n*/\nPrivate aRespDist := {}\n\ncQuery   := \" SELECT UPPER(RETORNO) DIST,\ncQuery   += \"        CAST(GETDATE() AS DATE)         DATA,\ncQuery   += \" \t     FORMAT(GETDATE(),'hh:mm')       HORA,\ncQuery   += \" \t     R_E_C_N_O_         \t\t\t RECNO,\ncQuery   += \" \t\t *\ncQuery   += \"   FROM DADOSADV_Q..WAM010\ncQuery   += \"\tCROSS APPLY\ncQuery   += \"\t(\ncQuery   += \"\tSELECT RETORNO = dbo.FnWhatRetMSG(WAM_ID)\ncQuery   += \"\t) x\ncQuery   += \"  WHERE D_E_L_E_T_ = ''\ncQuery   += \"    AND WAM_EXEC = 'MNT-DIST'\ncQuery   += \"    AND WAM_PERG = 'S'\ncQuery   += \"    AND UPPER(RETORNO) <> ''\ncQuery   += \"    AND CAST(GETDATE()-3 AS DATE) <= CAST(WAM_DATA AS DATE)\n\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBMNT\", .F., .T.)\ndbSelectArea(\"TRBMNT\")\ndbgotop()\nDo While !EOF()\n\t\n\taRespDist := strtokarr (AllTrim(TRBMNT->DIST), \",\")\n\t\n\tIf Len(aRespDist) < 2\n\t\tU_SWENV(TRBMNT->WAM_TELL, \"Ditribuição errada tente novamente! Quantidade de parâmetros não atende.\", \"DIST-ERRO1\" )\n\t\tSleep(10000)\n\tElse\n\t\tIf !aRespDist[1] $ \"CIV/MEC/ELE\"\n\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"O primeiro parâmetro deve ser [CIV/MEC/ELE]. \", \"DIST-ERRO2\" )\n\t\t\tSleep(10000)\n\t\tElse\n\t\t\tIf !aRespDist[2] $ \"1/2/3\"\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"O Segundo parâmetro deve ser [1/2/3]. \", \"DIST-ERRO3\" )\n\t\t\t\tSleep(10000)\n\t\t\tElse\n\t\t\t\t//U_SWENV(TRBMNT->WAM_TELL, \"ok\", \"DIST-OK\" )\n\t\t\t\tdbSelectArea(\"TQB\")\n\t\t\t\tdbSetOrder(1)\n\t\t\t\tdbSeek(xFilial(\"TQB\") + AllTrim(TRBMNT->WAM_INDEX) )\n\t\t\t\tIf  RecLock(\"TQB\",.F.)\n\t\t\t\t\tReplace TQB_CDSERV  With aRespDist[1]\n\t\t\t\t\tReplace TQB_CDEXEC  With \"LUAN SANTOS\"\n\t\t\t\t\tReplace TQB_PRIORI  With aRespDist[2]\n\t\t\t\t\tMsUnLock()\n\t\t\t\tEndIf\n\n\t\t\t\t//CONOUT(MSMM(TQB->TQB_CODMSS,80) + CHR(13)+CHR(10) + \"DATA.:\" + dToC(dDataBase)  + CHR(13)+CHR(10) + \"HORA..:\" + Replace(time(),':',':') + AllTrim(TRBMNT->DIST),80)\n\t\t\t\tMSMM(,,, MSMM(TQB->TQB_CODMSS,80) + CHR(13)+CHR(10) + \"DATA.:\" + dToC(dDataBase)  + CHR(13)+CHR(10) + \"HORA..:\" + Replace(time(),':',':') + CHR(13)+CHR(10) + AllTrim(TRBMNT->DIST),1,,,\"TQB\",\"TQB_CODMSS\")\n\t\t\t\t\n\t\t\t\tcQuery   := \" UPDATE DADOSADV_Q..WAM010\n\t\t\t\tcQuery   += \"    SET WAM_PERG = 'N',WAM_HORAR  = Left(Cast(GETDATE() as Time ),5), WAM_DATAR  = Replace(Cast(GETDATE() as date ),'-','')\n\t\t\t\tcQuery   += \"   FROM DADOSADV_Q..WAM010\n\t\t\t\tcQuery   += \"  WHERE R_E_C_N_O_ = \"+ AllTrim(Str(TRBMNT->RECNO))\n\n\t\t\t\tCONOUT(cQuery)\n\n\t\t\t\tTcSQLExec(cQuery) \n\n\t\t\t\tU_SWENV(TRBMNT->WAM_TELL, \"SS classificada com sucesso! Código:\"+AllTrim(TRBMNT->WAM_INDEX) , \"DIST-SUCESSO\" )\n\t\t\t\tU_SWENV(\"27998282193\"   , \"SS classificada com sucesso! Código:\"+AllTrim(TRBMNT->WAM_INDEX) , \"DIST-SUCESSO\" )\n\t\t\t\t//Sleep(10000)\n\t\t\tEndIf\n\t\tEndIf\n\tEndIf \n\n\tdbSelectArea(\"TRBMNT\")\n\tdbSkip()\nEndDo\n\ndbSelectArea(\"TRBMNT\") \ndbCloseArea()\n\n/*\nVerificação de erro \nCAVALETES DIFRENTE DO PEDIDO DE VENDA\n*/\ncQuery   := \" SELECT \t'P' TIPO,\ncQuery   += \" \t\t\tC6_NUM,\ncQuery   += \" \t\t\tB8_YCAVALE\ncQuery   += \"   FROM (\ncQuery   += \"          SELECT C6_NUM ,C6_ITEM,B8_PRODUTO,B8_LOTECTL,C6_NUMLOTE,C6_YCAVALE,B8_YCAVALE,ROUND(C6_QTDVEN,4,0) C6_QTDVEN , ROUND(B8_SALDO,4,0) B8_SALDO,\ncQuery   += \"                         ( SELECT \ncQuery   += \"                             ROUND(SUM(SB.B8_YTOTLIQ),4,0) \ncQuery   += \"                                 FROM SB8010 SB \ncQuery   += \"                             WHERE   SB.D_E_L_E_T_='' \ncQuery   += \"                                 AND SB.B8_PRODUTO = SC6.C6_PRODUTO \ncQuery   += \"                                 AND SC6.C6_LOTECTL = RTRIM(LTRIM(SB.B8_LOTECTL))+RTRIM(LTRIM(SB.B8_YCLASSI)) \ncQuery   += \"                                 AND SC6.C6_NUMLOTE<>SB.B8_NUMLOTE \ncQuery   += \"                                 AND SC6.C6_NUMLOTE=SB.B8_YCAVALE\ncQuery   += \"                          ) SALDO_CHAPA\ncQuery   += \"                FROM SC6010 SC6 INNER JOIN SB8010 SB8\ncQuery   += \"                  ON (B8_PRODUTO = C6_PRODUTO AND B8_LOTECTL = C6_LOTECTL AND C6_NUMLOTE = B8_NUMLOTE)\ncQuery   += \"              WHERE SC6.D_E_L_E_T_ = ''\ncQuery   += \"                AND SB8.D_E_L_E_T_ = ''\ncQuery   += \"                AND SC6.C6_NOTA = ''\ncQuery   += \"                AND SB8.B8_ORIGLAN = 'BD'\ncQuery   += \"                AND B8_LOCAL = C6_LOCAL\ncQuery   += \"          ) TB\ncQuery   += \" WHERE\ncQuery   += \"      (TB.C6_QTDVEN <> TB.B8_SALDO \ncQuery   += \"      OR \ncQuery   += \"      TB.SALDO_CHAPA<>TB.C6_QTDVEN)\n\ncQuery   += \"  UNION ALL\n\ncQuery   += \" SELECT \t'E' TIPO,\ncQuery   += \" \t\t\t'' C6_NUM,\ncQuery   += \" \t\t\tIIF(B8_YCAVALE='', B8_NUMLOTE,B8_YCAVALE) B8_YCAVALE \ncQuery   += \"     FROM (\ncQuery   += \"             SELECT \ncQuery   += \"                 ISNULL(( SELECT \ncQuery   += \"                     ROUND(SUM(SB.B8_YTOTLIQ),4,0) \ncQuery   += \"                         FROM SB8010 SB \ncQuery   += \"                     WHERE   SB.D_E_L_E_T_='' \ncQuery   += \"                         AND SB.B8_PRODUTO = SB8.B8_PRODUTO \ncQuery   += \"                         AND SB8.B8_LOTECTL = RTRIM(LTRIM(SB.B8_LOTECTL))+RTRIM(LTRIM(SB.B8_YCLASSI)) \ncQuery   += \"                         AND SB8.B8_NUMLOTE<>SB.B8_NUMLOTE \ncQuery   += \"                         AND SB8.B8_NUMLOTE=SB.B8_YCAVALE\ncQuery   += \"                  ),0) SALDO_CHAPA,\ncQuery   += \"                  ROUND(SB8.B8_SALDO,4,0) SALDO_BUNDLE,\ncQuery   += \"                  * \ncQuery   += \"             FROM SB8010 SB8 \ncQuery   += \"                     WHERE SB8.B8_FILIAL='010101' \n//cQuery   += \"                     AND CAST(SB8.B8_NUMLOTE AS INT) BETWEEN 100 AND 999999 \ncQuery   += \"                       AND SB8.B8_NUMLOTE = SB8.B8_YCAVALE\ncQuery   += \"  \t\t\t\t\t    AND SB8.B8_YCAVALE <> ''\ncQuery   += \"                       AND SB8.B8_SALDO>0 \ncQuery   += \"                       AND SB8.D_E_L_E_T_=''\ncQuery   += \"         )TB\ncQuery   += \"     WHERE SALDO_BUNDLE<>SALDO_CHAPA\n\ncQuery   += \"  UNION ALL \n\ncQuery   += \"  SELECT 'F' TIPO,\ncQuery   += \"  \t   D2_NUMLOTE B8_YCAVALE,\ncQuery   += \"  \t   CHAVE_DOC C6_NUM\ncQuery   += \"    FROM (\ncQuery   += \"  \t\tSELECT *,\ncQuery   += \"  \t\t\t   (SELECT ROUND(SUM(B8_YQTDBD),5,0) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI\ncQuery   += \"  \t\t  FROM (\ncQuery   += \"  \t\t\t\tSELECT  D2_FILIAL+D2_DOC+D2_SERIE CHAVE_DOC,\ncQuery   += \"  \t\t\t\t\t\tCAST(D2_EMISSAO AS DATE) EMISSAO,\ncQuery   += \"  \t\t\t\t\t\tD2_COD,\ncQuery   += \"  \t\t\t\t\t\tD2_NUMLOTE ,\ncQuery   += \"  \t\t\t\t\t\tD2_LOTECTL,\t\t\t\t\t\t\ncQuery   += \"  \t\t\t\t\t\tD2_FILIAL,\ncQuery   += \"  \t\t\t\t\t\tROUND(SUM(D2_QUANT),5,0) QTD_FAT\ncQuery   += \"  \t\t\t\t\tFROM SD2010 \ncQuery   += \"  \t\t\t\t\tWHERE D_E_L_E_T_ = '' \ncQuery   += \"  \t\t\t\t\t  AND D2_COD LIKE 'CH%'\ncQuery   += \"  \t\t\t\t\t  AND D2_QTDEDEV = 0\ncQuery   += \"  \t\t\t\tGROUP BY D2_FILIAL+D2_DOC+D2_SERIE,\ncQuery   += \"  \t\t\t\t\t\t\tD2_NUMLOTE,\ncQuery   += \"  \t\t\t\t\t\t\tD2_LOTECTL,\ncQuery   += \"  \t\t\t\t\t\t\tD2_PEDIDO,\ncQuery   += \"  \t\t\t\t\t\t\tD2_ITEMPV,\ncQuery   += \"  \t\t\t\t\t\t\tD2_FILIAL,\ncQuery   += \"  \t\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE),\ncQuery   += \"  \t\t\t\t\t\t\tD2_COD\ncQuery   += \"  \t\t\t\t)TAB_BASE\ncQuery   += \"  \t\t)TAB_2\ncQuery   += \"  WHERE  ROUND(QTD_FAT,0,0) <> ROUND(QTD_SB8_ORI,0,0)\ncQuery   += \"    AND CHAVE_DOC NOT IN (\ncQuery   += \"  \t\t\t\t\t\t'0101010000064491',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000067471',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000070511',\ncQuery   += \"  \t\t\t\t\t\t'0101010000071041',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000072551',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000077821',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000077821',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000083191',  \ncQuery   += \"  \t\t\t\t\t\t'0101010000085411'  \ncQuery   += \"  \t\t\t\t\t\t)\n\ncQuery   += \"  ORDER BY B8_YCAVALE,C6_NUM\n\n\n/*\nQUERY USADA PARA ACHAR OS VALORES SB8 <> DO FATURADO\n\nSELECT 'F' TIPO,\n\t   D2_NUMLOTE B8_YCAVALE,\n\t   CHAVE_DOC C6_NUM\n\t   , *\n\t   ,'http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0003&FILIAL='+D2_FILIAL+'&NUMPED='+D2_PEDIDO+'&rs:Format=pdf' as LINK\n  FROM (\n\t\tSELECT *,\n\t\t\t   (SELECT RTRIM(LTRIM(B1_DESC))  FROM SB1010 WHERE D_E_L_E_T_ = ''  AND B1_COD = D2_COD) DESCRICAO,\n\t\t\t   (SELECT C6_PRCVEN  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) PRC_VEN,\n\t\t\t   (SELECT C6_QTDVEN  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) QTD_PV_NOR,\n\t\t\t   (SELECT ROUND(C6_QTDVEN,0,0)  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) QTD_PV,\n\t\t\t   (SELECT C6_YCLASSI  FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) CLASSIF,\n\t\t\t   (SELECT C6_YCAVALE FROM SC6010 WHERE D_E_L_E_T_ = '' AND C6_NUM = D2_PEDIDO AND C6_ITEM = D2_ITEMPV AND D2_FILIAL = C6_FILIAL AND C6_LOTECTL = D2_LOTECTL) CAVALETE,\n\t\t\t   (SELECT SUM(B8_YQTDBD) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI_NOR,\n\t\t\t   (SELECT ROUND(SUM(B8_YQTDBD),0,0) FROM SB8010  WHERE D_E_L_E_T_ = '' AND D2_COD = B8_PRODUTO AND (RTRIM(LTRIM(B8_LOTECTL))+LTRIM(RTRIM(B8_YCLASSI)))=D2_LOTECTL  AND D2_NUMLOTE = B8_YCAVALE AND D2_FILIAL = B8_FILIAL  AND D2_NUMLOTE <> B8_NUMLOTE) QTD_SB8_ORI\n\t\t  FROM (\n\t\t\t\tSELECT  D2_FILIAL+D2_DOC+D2_SERIE CHAVE_DOC,\n\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE) EMISSAO,\n\t\t\t\t\t\tD2_COD,\n\t\t\t\t\t\tD2_NUMLOTE ,\n\t\t\t\t\t\tD2_LOTECTL,\t\t\t\t\t\t\n\t\t\t\t\t\tD2_PEDIDO,\n\t\t\t\t\t\tD2_ITEMPV,\n\t\t\t\t\t\tD2_FILIAL,\n\t\t\t\t\t\tROUND(SUM(D2_QUANT),0,0) QTD_FAT\n\t\t\t\t\tFROM SD2010 \n\t\t\t\t\tWHERE D_E_L_E_T_ = '' \n\t\t\t\t\t -- AND D2_DOC = '000009057' \n\t\t\t\t\t  AND D2_COD LIKE 'CH%'\n\t\t\t\tGROUP BY D2_FILIAL+D2_DOC+D2_SERIE,\n\t\t\t\t\t\t\tD2_NUMLOTE,\n\t\t\t\t\t\t\tD2_LOTECTL,\n\t\t\t\t\t\t\tD2_PEDIDO,\n\t\t\t\t\t\t\tD2_ITEMPV,\n\t\t\t\t\t\t\tD2_FILIAL,\n\t\t\t\t\t\t\tCAST(D2_EMISSAO AS DATE),\n\t\t\t\t\t\t\tD2_COD\n\t\t\t\t)TAB_BASE\n\t\t)TAB_2\nWHERE  ROUND(QTD_FAT,0,0) <> ROUND(QTD_SB8_ORI,0,0)\n  AND CHAVE_DOC NOT IN (\n\t\t\t\t\t\t'0101010000064491',  \n\t\t\t\t\t\t'0101010000067471',  \n\t\t\t\t\t\t'0101010000070511',\n\t\t\t\t\t\t'0101010000071041',  \n\t\t\t\t\t\t'0101010000072551',  \n\t\t\t\t\t\t'0101010000077821',  \n\t\t\t\t\t\t'0101010000077821',  \n\t\t\t\t\t\t'0101010000083191',  \n\t\t\t\t\t\t'0101010000085411'  \n\t\t\t\t\t\t)\nORDER BY EMISSAO, CHAVE_DOC\n\n*/\n\ndbUseArea(.T., \"TOPCONN\", TCGenQry(,,cQuery), \"TRBERRO\", .F., .T.)\ndbSelectArea(\"TRBERRO\")\ndbgotop()\nDo While !EOF()\n\n\tIF TRBERRO->TIPO == 'P'\n\t\t/*\n\t\tAVISO PARA BRUNO\n\t\t*/\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE  , \"ERRO:\" +AllTrim(TRBERRO->B8_YCAVALE)  )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tAVISO PARA ARLINDO\n\t\t*/\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE  , \"ERRO:\" +AllTrim(TRBERRO->B8_YCAVALE)  )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tEMAIL\n\t\t*/\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",'ERRO URGENTE ! PV:' + TRBERRO->C6_NUM , \"ERRO URGENTE (DIF. DE SALDO) PEDIDO:\" + AllTrim(TRBERRO->C6_NUM)   + \" CAVALETE:\" + TRBERRO->B8_YCAVALE ,'')\n\tENDIF\n\n\tIF TRBERRO->TIPO == 'E'\n\t\t/*\n\t\tAVISO PARA BRUNO\n\t\t*/\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) CAVALETE -  BUNDLE:\" + AllTrim(TRBERRO->B8_YCAVALE)    )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tAVISO PARA ARLINDO\n\t\t*/\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) CAVALETE - BUNDLE:\" + AllTrim(TRBERRO->B8_YCAVALE)     )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tEMAIL\n\t\t*/\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",\"ERRO URGENTE ! CAVALETE:\" + TRBERRO->B8_YCAVALE ,'')\n\tENDIF\n\n\t\n\tIF TRBERRO->TIPO == 'F'\n\t\t/*\n\t\tAVISO PARA BRUNO\n\t\t*/\n\t\tU_SWENV(\"5533984022125\", \"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + AllTrim(TRBERRO->C6_NUM)    )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tAVISO PARA ARLINDO\n\t\t*/\n\t\tU_SWENV(\"5527981187553\", \"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + AllTrim(TRBERRO->C6_NUM)     )\n\t\t\n\t\tsleep(300)\n\t\t\n\t\t/*\n\t\tEMAIL\n\t\t*/\n\t\tTCSPExec(\"SP_SENDMAIL\",'ITINGA',\"ti.vix@grupoqualita.com.br;logistica.es@qualitagroup.com;sales.es@qualitagroup.com\",\"ERRO URGENTE (DIF. DE SALDO) NOTA FISCAL - :\" + TRBERRO->C6_NUM ,'')\n\tENDIF\n\n\tdbSelectArea(\"TRBERRO\")\n\tdbSkip()\nEndDo\n\ndbSelectArea(\"TRBERRO\") \ndbCloseArea()\n\n/*\nCaso exista alguma aprovação ou reprovação \no sistema envia o protocolo por e-mail\n*/\nIF lEnvProt\n\t//WaitRunSrv( '\"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\wget.exe\" -t 1 \"http://192.168.1.101:10530/ReportServer/Pages/ReportViewer.aspx?%2fItinga_reports%2fRQ0060&rs:Format=pdf\" -O \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0060.PDF\"' , .t. , \"D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\wget\\\" )\n\t  \n\t//ConOut(\"Gerando protocolo...\" )\n\t//Sleep(3000)\n\t//TCSPExec(\"SP_SENDMAIL\",'ITINGA',\"diego.sirtori@grupoqualita.com.br\",'Relaório de Protocolo','Anexo relatório de protocolos!','D:\\TOTVS 12\\Microsiga\\protheus_data\\RELINWEB\\RQ0060.PDF')\nEndIf\n\nIf lAutoZAP\n\tRpcClearEnv()\n\tConout(DtoC(dDatabase)+\" - \"+TIME()+\" FIM do JOB liberação de Retornos pelo WHATSAPP.\")\nElse\n\t// Caso não seja job, informa na a atualização\n\tAlert(\"Fim da liberação de Retorno pelo WHATSAPP. (Chamada Manual)\")\nEndif\n\nReturn\n"}]}}
